{"file_contents":{"client/src/components/email/email-list-item.tsx":{"content":"import { EmailThread } from \"@shared/schema\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Paperclip, Star } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface EmailListItemProps {\n  thread: EmailThread;\n  isSelected: boolean;\n  isActive: boolean;\n  onSelect: (id: string, checked: boolean) => void;\n  onClick: (id: string) => void;\n  onStarToggle: (id: string, starred: boolean) => void;\n}\n\nexport function EmailListItem({\n  thread,\n  isSelected,\n  isActive,\n  onSelect,\n  onClick,\n  onStarToggle,\n}: EmailListItemProps) {\n  const getInitials = (email: string) => {\n    if (!email) return \"?\";\n    const name = email.split(\"@\")[0];\n    return name.substring(0, 2).toUpperCase();\n  };\n\n  const getAvatarColor = (email: string) => {\n    const colors = [\n      \"bg-blue-500\",\n      \"bg-green-500\",\n      \"bg-purple-500\",\n      \"bg-pink-500\",\n      \"bg-indigo-500\",\n      \"bg-teal-500\",\n    ];\n    const hash = email.split(\"\").reduce((acc, char) => acc + char.charCodeAt(0), 0);\n    return colors[hash % colors.length];\n  };\n\n  const formatLastActivity = (date: string | Date) => {\n    const activityDate = typeof date === 'string' ? new Date(date) : date;\n    const now = new Date();\n    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    const yesterday = new Date(today);\n    yesterday.setDate(yesterday.getDate() - 1);\n    \n    if (activityDate >= today) {\n      return activityDate.toLocaleTimeString('nl-NL', {\n        hour: '2-digit',\n        minute: '2-digit',\n        hour12: false\n      });\n    } else if (activityDate >= yesterday) {\n      return 'Yesterday';\n    } else if (activityDate.getFullYear() === now.getFullYear()) {\n      return activityDate.toLocaleDateString('nl-NL', {\n        day: 'numeric',\n        month: 'short'\n      });\n    } else {\n      return activityDate.toLocaleDateString('nl-NL', {\n        day: 'numeric',\n        month: 'short',\n        year: 'numeric'\n      });\n    }\n  };\n\n  return (\n    <div\n      className={cn(\n        \"group cursor-pointer transition-all border-b border-border hover:shadow-sm relative\",\n        isActive\n          ? \"bg-blue-50 dark:bg-blue-950/20 border-l-4 border-l-blue-600\"\n          : \"hover:bg-accent border-l-4 border-l-transparent\",\n        thread.isUnread ? \"bg-background\" : \"bg-muted/30\"\n      )}\n      onClick={() => onClick(thread.id)}\n      data-testid={`email-list-item-${thread.id}`}\n    >\n      <div className=\"p-3 flex items-start gap-3\">\n        {/* Checkbox */}\n        <div className=\"flex items-center pt-1\" onClick={(e) => e.stopPropagation()}>\n          <Checkbox\n            checked={isSelected}\n            onCheckedChange={(checked) => onSelect(thread.id, checked as boolean)}\n            data-testid={`checkbox-${thread.id}`}\n          />\n        </div>\n\n        {/* Star */}\n        <button\n          className=\"flex items-center pt-1 hover:scale-110 transition-transform\"\n          onClick={(e) => {\n            e.stopPropagation();\n            onStarToggle(thread.id, !thread.starred);\n          }}\n          data-testid={`star-${thread.id}`}\n        >\n          <Star\n            className={cn(\n              \"h-5 w-5 transition-colors\",\n              thread.starred\n                ? \"fill-yellow-400 text-yellow-400\"\n                : \"text-muted-foreground hover:text-foreground\"\n            )}\n          />\n        </button>\n\n        {/* Avatar */}\n        <div\n          className={cn(\n            \"flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center text-white font-medium text-sm\",\n            getAvatarColor(thread.customerEmail || '')\n          )}\n        >\n          {getInitials(thread.customerEmail || '')}\n        </div>\n\n        {/* Content */}\n        <div className=\"flex-1 min-w-0\">\n          {/* Header row */}\n          <div className=\"flex items-start justify-between mb-1\">\n            <div className=\"flex items-center gap-2 min-w-0 flex-1\">\n              <span\n                className={cn(\n                  \"text-sm truncate\",\n                  thread.isUnread ? \"font-bold text-foreground\" : \"font-normal text-foreground\"\n                )}\n                data-testid={`sender-${thread.id}`}\n              >\n                {thread.customerEmail || \"Unknown\"}\n              </span>\n              {thread.hasAttachment && (\n                <Paperclip className=\"h-3.5 w-3.5 text-muted-foreground flex-shrink-0\" />\n              )}\n              {thread.orderId && (\n                <Badge \n                  variant=\"outline\" \n                  className=\"text-xs px-1 py-0 bg-green-50 dark:bg-green-950 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800\"\n                  data-testid={`order-badge-${thread.id}`}\n                >\n                  Order\n                </Badge>\n              )}\n            </div>\n            <span className=\"text-xs text-muted-foreground ml-2 flex-shrink-0\" data-testid={`time-${thread.id}`}>\n              {formatLastActivity(thread.lastActivity || new Date().toISOString())}\n            </span>\n          </div>\n\n          {/* Subject */}\n          <div\n            className={cn(\n              \"text-sm mb-1 truncate\",\n              thread.isUnread ? \"font-semibold text-foreground\" : \"font-normal text-muted-foreground\"\n            )}\n            data-testid={`subject-${thread.id}`}\n          >\n            {thread.subject || \"No Subject\"}\n          </div>\n\n          {/* Status badges */}\n          <div className=\"flex items-center gap-2\">\n            {thread.priority !== \"medium\" && (\n              <Badge\n                variant={thread.priority === \"urgent\" ? \"destructive\" : \"default\"}\n                className=\"text-xs px-1.5 py-0\"\n                data-testid={`priority-${thread.id}`}\n              >\n                {thread.priority}\n              </Badge>\n            )}\n            {thread.status === \"closed\" && (\n              <Badge variant=\"secondary\" className=\"text-xs px-1.5 py-0\" data-testid={`status-closed-${thread.id}`}>\n                Closed\n              </Badge>\n            )}\n            {thread.isUnread && (\n              <div className=\"w-2 h-2 bg-blue-600 rounded-full\" data-testid={`unread-indicator-${thread.id}`}></div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":6345},"client/src/providers/theme-provider.tsx":{"content":"import { createContext, useContext, useEffect, useState } from \"react\";\n\ntype Theme = \"dark\" | \"light\" | \"system\";\n\ntype ThemeProviderProps = {\n  children: React.ReactNode;\n  defaultTheme?: Theme;\n  storageKey?: string;\n};\n\ntype ThemeProviderState = {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n};\n\nconst initialState: ThemeProviderState = {\n  theme: \"system\",\n  setTheme: () => null,\n};\n\nconst ThemeProviderContext = createContext<ThemeProviderState>(initialState);\n\nexport function ThemeProvider({\n  children,\n  defaultTheme = \"system\",\n  storageKey = \"vite-ui-theme\",\n  ...props\n}: ThemeProviderProps) {\n  const [theme, setTheme] = useState<Theme>(\n    () => (localStorage.getItem(storageKey) as Theme) || defaultTheme\n  );\n\n  useEffect(() => {\n    const root = window.document.documentElement;\n\n    root.classList.remove(\"light\", \"dark\");\n\n    if (theme === \"system\") {\n      const systemTheme = window.matchMedia(\"(prefers-color-scheme: dark)\")\n        .matches\n        ? \"dark\"\n        : \"light\";\n\n      root.classList.add(systemTheme);\n      return;\n    }\n\n    root.classList.add(theme);\n  }, [theme]);\n\n  const value = {\n    theme,\n    setTheme: (theme: Theme) => {\n      localStorage.setItem(storageKey, theme);\n      setTheme(theme);\n    },\n  };\n\n  return (\n    <ThemeProviderContext.Provider {...props} value={value}>\n      {children}\n    </ThemeProviderContext.Provider>\n  );\n}\n\nexport const useTheme = () => {\n  const context = useContext(ThemeProviderContext);\n\n  if (context === undefined)\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n\n  return context;\n};\n","size_bytes":1605},"server/services/orderMatchingService.ts":{"content":"import type { Order } from \"@shared/schema\";\nimport type { IStorage } from \"../storage\";\n\nexport class OrderMatchingService {\n  private storage: IStorage;\n\n  constructor(storage: IStorage) {\n    this.storage = storage;\n  }\n\n  /**\n   * Extract potential order numbers from email content\n   * Looks for patterns like: #8001, #8001, Order 8001, etc.\n   */\n  private extractOrderNumbers(text: string): string[] {\n    if (!text) return [];\n\n    // Patterns to match order numbers:\n    // - #1234, #8001 (hash prefix)\n    // - Order 1234, order 8001 (word prefix)\n    // - Order #1234 (word + hash)\n    // - DutchThrift Return Request #8001 (specific pattern from screenshot)\n    const patterns = [\n      /#(\\d{3,6})\\b/gi,                           // #8001, #1234\n      /\\border\\s*#?(\\d{3,6})\\b/gi,                // Order 8001, Order #8001\n      /return\\s+request\\s*#?(\\d{3,6})\\b/gi,       // Return Request #8001\n      /\\b(\\d{4,6})\\b(?=\\s|$|[^\\d])/g              // Standalone 4-6 digit numbers\n    ];\n\n    const orderNumbers = new Set<string>();\n\n    for (const pattern of patterns) {\n      let match;\n      while ((match = pattern.exec(text)) !== null) {\n        const orderNumber = match[1];\n        if (orderNumber && orderNumber.length >= 3) {\n          orderNumbers.add(orderNumber);\n        }\n      }\n    }\n\n    return Array.from(orderNumbers);\n  }\n\n  /**\n   * Try to match orders by order number patterns found in email content\n   */\n  private async matchByOrderNumber(text: string): Promise<Order[]> {\n    const orderNumbers = this.extractOrderNumbers(text);\n    const matchedOrders: Order[] = [];\n\n    console.log(`üîç Extracted potential order numbers from email: [${orderNumbers.join(', ')}]`);\n\n    for (const orderNumber of orderNumbers) {\n      try {\n        // Try exact match first\n        let order = await this.storage.getOrderByOrderNumber(orderNumber);\n        \n        if (!order) {\n          // Try with leading zeros padding for shorter numbers\n          const paddedOrderNumber = orderNumber.padStart(4, '0');\n          order = await this.storage.getOrderByOrderNumber(paddedOrderNumber);\n        }\n\n        if (order) {\n          console.log(`‚úÖ Found order match by order number: ${orderNumber} -> Order ID: ${order.id}`);\n          matchedOrders.push(order);\n        } else {\n          console.log(`‚ùå No order found for order number: ${orderNumber}`);\n        }\n      } catch (error) {\n        console.error(`Error searching for order number ${orderNumber}:`, error);\n      }\n    }\n\n    return matchedOrders;\n  }\n\n  /**\n   * Try to match orders by customer email address\n   */\n  private async matchByEmail(customerEmail: string): Promise<Order[]> {\n    if (!customerEmail) return [];\n\n    try {\n      const orders = await this.storage.getOrdersByCustomerEmail(customerEmail);\n      console.log(`üìß Found ${orders.length} orders for email: ${customerEmail}`);\n      return orders;\n    } catch (error) {\n      console.error(`Error searching orders by email ${customerEmail}:`, error);\n      return [];\n    }\n  }\n\n  /**\n   * Main function to automatically match orders from email content\n   * 1. First tries to match by order numbers found in email content\n   * 2. Falls back to matching by customer email address\n   * 3. Returns the most likely order match(es)\n   */\n  async matchOrders(emailContent: string, customerEmail: string, emailSubject?: string): Promise<{\n    primaryMatch: Order | null;\n    allMatches: Order[];\n    matchMethod: 'order_number' | 'email_fallback' | 'none';\n  }> {\n    console.log(`\\nüéØ Starting automatic order matching...`);\n    console.log(`Email: ${customerEmail}`);\n    console.log(`Subject: ${emailSubject || 'N/A'}`);\n    \n    // Combine subject and content for order number extraction\n    const fullText = `${emailSubject || ''} ${emailContent || ''}`;\n\n    // Step 1: Try matching by order number\n    const orderNumberMatches = await this.matchByOrderNumber(fullText);\n    if (orderNumberMatches.length > 0) {\n      console.log(`‚úÖ Order matching successful via order number: ${orderNumberMatches.length} match(es) found`);\n      return {\n        primaryMatch: orderNumberMatches[0], // Return the first/most relevant match\n        allMatches: orderNumberMatches,\n        matchMethod: 'order_number'\n      };\n    }\n\n    // Step 2: Fallback to email matching\n    console.log(`‚ö° No order number matches found, falling back to email matching...`);\n    const emailMatches = await this.matchByEmail(customerEmail);\n    if (emailMatches.length > 0) {\n      console.log(`‚úÖ Order matching successful via email fallback: ${emailMatches.length} match(es) found`);\n      \n      // Sort by most recent order as primary match\n      const sortedEmailMatches = emailMatches.sort((a, b) => \n        new Date(b.createdAt!).getTime() - new Date(a.createdAt!).getTime()\n      );\n      \n      return {\n        primaryMatch: sortedEmailMatches[0], // Most recent order\n        allMatches: emailMatches,\n        matchMethod: 'email_fallback'\n      };\n    }\n\n    console.log(`‚ùå No order matches found for email: ${customerEmail}`);\n    return {\n      primaryMatch: null,\n      allMatches: [],\n      matchMethod: 'none'\n    };\n  }\n\n  /**\n   * Utility function to get a simple match result for immediate linking\n   */\n  async getOrderForAutoLink(emailContent: string, customerEmail: string, emailSubject?: string): Promise<Order | null> {\n    const result = await this.matchOrders(emailContent, customerEmail, emailSubject);\n    return result.primaryMatch;\n  }\n}","size_bytes":5510},"client/src/components/email/email-sidebar.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { \n  Mail, \n  Inbox, \n  Send, \n  Archive, \n  Star, \n  Circle,\n  Search,\n  Package,\n  PackageX\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface EmailSidebarProps {\n  selectedFolder: string;\n  selectedFilter?: 'with-order' | 'without-order' | null;\n  onFolderChange: (folder: string) => void;\n  onFilterChange: (filter: 'with-order' | 'without-order' | null) => void;\n  onCompose: () => void;\n  searchQuery: string;\n  onSearchChange: (query: string) => void;\n  counts?: {\n    inbox?: number;\n    sent?: number;\n    archived?: number;\n    starred?: number;\n    unread?: number;\n    withOrder?: number;\n    withoutOrder?: number;\n  };\n}\n\nexport function EmailSidebar({\n  selectedFolder,\n  selectedFilter,\n  onFolderChange,\n  onFilterChange,\n  onCompose,\n  searchQuery,\n  onSearchChange,\n  counts = {},\n}: EmailSidebarProps) {\n  const folders = [\n    { id: 'inbox', label: 'Inbox', icon: Inbox, count: counts.inbox },\n    { id: 'starred', label: 'Starred', icon: Star, count: counts.starred },\n    { id: 'sent', label: 'Sent', icon: Send, count: counts.sent },\n    { id: 'archived', label: 'Archived', icon: Archive, count: counts.archived },\n    { id: 'unread', label: 'Unread', icon: Circle, count: counts.unread },\n  ];\n\n  const filters = [\n    { id: 'with-order', label: 'With Order', icon: Package, count: counts.withOrder },\n    { id: 'without-order', label: 'Without Order', icon: PackageX, count: counts.withoutOrder },\n  ];\n\n  return (\n    <div className=\"flex flex-col h-full bg-background border-r\" data-testid=\"email-sidebar\">\n      {/* Compose Button */}\n      <div className=\"p-4 border-b\">\n        <Button\n          onClick={onCompose}\n          className=\"w-full bg-blue-600 hover:bg-blue-700\"\n          data-testid=\"sidebar-compose-button\"\n        >\n          <Mail className=\"mr-2 h-4 w-4\" />\n          Compose\n        </Button>\n      </div>\n\n      {/* Search */}\n      <div className=\"p-4 border-b\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search emails...\"\n            className=\"pl-10\"\n            value={searchQuery}\n            onChange={(e) => onSearchChange(e.target.value)}\n            data-testid=\"sidebar-search-input\"\n          />\n        </div>\n      </div>\n\n      {/* Folders */}\n      <div className=\"flex-1 overflow-y-auto\">\n        <div className=\"p-2\">\n          <div className=\"mb-4\">\n            {folders.map((folder) => (\n              <button\n                key={folder.id}\n                onClick={() => onFolderChange(folder.id)}\n                className={cn(\n                  \"w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition-colors\",\n                  selectedFolder === folder.id\n                    ? \"bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 font-medium\"\n                    : \"hover:bg-accent text-foreground\"\n                )}\n                data-testid={`folder-${folder.id}`}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <folder.icon className=\"h-5 w-5\" />\n                  <span>{folder.label}</span>\n                </div>\n                {folder.count !== undefined && folder.count > 0 && (\n                  <span\n                    className={cn(\n                      \"text-xs px-2 py-0.5 rounded-full\",\n                      selectedFolder === folder.id\n                        ? \"bg-blue-200 dark:bg-blue-900 text-blue-800 dark:text-blue-200\"\n                        : \"bg-muted text-muted-foreground\"\n                    )}\n                    data-testid={`count-${folder.id}`}\n                  >\n                    {folder.count}\n                  </span>\n                )}\n              </button>\n            ))}\n          </div>\n\n          {/* Filters Section */}\n          <div className=\"border-t pt-4\">\n            <div className=\"px-3 mb-2 text-xs font-semibold text-muted-foreground uppercase\">\n              Filters\n            </div>\n            {filters.map((filter) => (\n              <button\n                key={filter.id}\n                onClick={() => onFilterChange(filter.id as 'with-order' | 'without-order')}\n                className={cn(\n                  \"w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition-colors\",\n                  selectedFilter === filter.id\n                    ? \"bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-300 font-medium\"\n                    : \"hover:bg-accent text-foreground\"\n                )}\n                data-testid={`filter-${filter.id}`}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <filter.icon className=\"h-5 w-5\" />\n                  <span>{filter.label}</span>\n                </div>\n                {filter.count !== undefined && filter.count > 0 && (\n                  <span\n                    className={cn(\n                      \"text-xs px-2 py-0.5 rounded-full\",\n                      selectedFilter === filter.id\n                        ? \"bg-blue-200 dark:bg-blue-900 text-blue-800 dark:text-blue-200\"\n                        : \"bg-muted text-muted-foreground\"\n                    )}\n                    data-testid={`count-${filter.id}`}\n                  >\n                    {filter.count}\n                  </span>\n                )}\n              </button>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":5633},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/components/forms/todo-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { CalendarIcon } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth\";\nimport type { InsertTodo, User } from \"@shared/schema\";\n\ninterface TodoFormProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  todo?: any; // For editing existing todos\n}\n\ninterface TodoFormData {\n  title: string;\n  description: string;\n  category: \"orders\" | \"purchasing\" | \"marketing\" | \"admin\" | \"other\";\n  priority: \"low\" | \"medium\" | \"high\" | \"urgent\";\n  dueDate: Date | null;\n  assignedUserId: string;\n  orderId: string;\n  caseId: string;\n  customerId: string;\n  repairId: string;\n}\n\nexport function TodoForm({ open, onOpenChange, todo }: TodoFormProps) {\n  const [dueDate, setDueDate] = useState<Date | null>(null);\n  const { toast } = useToast();\n  const { user } = useAuth();\n\n  // Fetch users for assignment dropdown\n  const { data: users = [], isLoading: usersLoading } = useQuery<User[]>({\n    queryKey: [\"/api/users/list\"],\n  });\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    watch,\n    formState: { errors },\n  } = useForm<TodoFormData>({\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      category: \"other\",\n      priority: \"medium\",\n      dueDate: null,\n      assignedUserId: user?.id || \"\",\n      orderId: \"\",\n      caseId: \"\",\n      customerId: \"\",\n      repairId: \"\",\n    },\n  });\n\n  // Pre-populate form when editing\n  useEffect(() => {\n    if (todo) {\n      setValue(\"title\", todo.title || \"\");\n      setValue(\"description\", todo.description || \"\");\n      setValue(\"category\", todo.category || \"other\");\n      setValue(\"priority\", todo.priority || \"medium\");\n      setValue(\"assignedUserId\", todo.assignedUserId || user?.id || \"\");\n      setValue(\"orderId\", todo.orderId || \"\");\n      setValue(\"caseId\", todo.caseId || \"\");\n      setValue(\"customerId\", todo.customerId || \"\");\n      setValue(\"repairId\", todo.repairId || \"\");\n      \n      // Set due date\n      if (todo.dueDate) {\n        const date = typeof todo.dueDate === 'string' ? new Date(todo.dueDate) : todo.dueDate;\n        setDueDate(date);\n      } else {\n        setDueDate(null);\n      }\n    } else {\n      // Reset form for new todo\n      reset({\n        title: \"\",\n        description: \"\",\n        category: \"other\",\n        priority: \"medium\",\n        assignedUserId: user?.id || \"\",\n        orderId: \"\",\n        caseId: \"\",\n        customerId: \"\",\n        repairId: \"\",\n      });\n      setDueDate(null);\n    }\n  }, [todo, setValue, reset, user]);\n\n  const createTodoMutation = useMutation({\n    mutationFn: async (data: InsertTodo) => {\n      const response = await fetch(\"/api/todos\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to create todo\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/todos\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/activities\"] });\n      toast({\n        title: \"Todo created\",\n        description: \"Your todo has been created successfully\",\n      });\n      handleClose();\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to create todo\",\n        description: \"There was an error creating your todo\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const updateTodoMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertTodo> }) => {\n      const response = await fetch(`/api/todos/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update todo\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/todos\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/activities\"] });\n      toast({\n        title: \"Todo updated\",\n        description: \"Your todo has been updated successfully\",\n      });\n      handleClose();\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to update todo\",\n        description: \"There was an error updating your todo\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const onSubmit = (data: TodoFormData) => {\n    if (!user) {\n      toast({\n        title: \"Authentication required\",\n        description: \"You must be logged in to create a todo\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const todoData: InsertTodo = {\n      title: data.title,\n      description: data.description || undefined,\n      category: data.category,\n      priority: data.priority,\n      assignedUserId: data.assignedUserId,\n      createdBy: user.id,\n      dueDate: dueDate?.toISOString(),\n      orderId: data.orderId || undefined,\n      caseId: data.caseId || undefined,\n      customerId: data.customerId || undefined,\n      repairId: data.repairId || undefined,\n    };\n\n    if (todo) {\n      // Update existing todo\n      updateTodoMutation.mutate({ id: todo.id, data: todoData });\n    } else {\n      // Create new todo\n      createTodoMutation.mutate(todoData);\n    }\n  };\n\n  const handleClose = () => {\n    reset();\n    setDueDate(null);\n    onOpenChange(false);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[600px] max-h-[90vh] overflow-y-auto\" data-testid=\"todo-form-dialog\">\n        <DialogHeader>\n          <DialogTitle>{todo ? \"Edit Todo\" : \"Create New Todo\"}</DialogTitle>\n          <DialogDescription>\n            {todo ? \"Update your todo details below.\" : \"Add a new task to your todo list.\"}\n          </DialogDescription>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n          {/* Title */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"title\">Title *</Label>\n            <Input\n              id=\"title\"\n              placeholder=\"Enter todo title...\"\n              {...register(\"title\", { required: \"Title is required\" })}\n              data-testid=\"todo-title-input\"\n            />\n            {errors.title && (\n              <p className=\"text-sm text-destructive\">{errors.title.message}</p>\n            )}\n          </div>\n\n          {/* Description */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"Add a description...\"\n              {...register(\"description\")}\n              data-testid=\"todo-description-input\"\n            />\n          </div>\n\n          {/* Category and Priority */}\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Category</Label>\n              <Select \n                onValueChange={(value) => setValue(\"category\", value as any)}\n                value={watch(\"category\")}\n              >\n                <SelectTrigger data-testid=\"todo-category-select\">\n                  <SelectValue placeholder=\"Select category\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"orders\">Orders</SelectItem>\n                  <SelectItem value=\"purchasing\">Purchasing</SelectItem>\n                  <SelectItem value=\"marketing\">Marketing</SelectItem>\n                  <SelectItem value=\"admin\">Admin</SelectItem>\n                  <SelectItem value=\"other\">Other</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Priority</Label>\n              <Select \n                onValueChange={(value) => setValue(\"priority\", value as any)}\n                value={watch(\"priority\")}\n              >\n                <SelectTrigger data-testid=\"todo-priority-select\">\n                  <SelectValue placeholder=\"Select priority\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"low\">Low</SelectItem>\n                  <SelectItem value=\"medium\">Medium</SelectItem>\n                  <SelectItem value=\"high\">High</SelectItem>\n                  <SelectItem value=\"urgent\">Urgent</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n\n          {/* Assigned User and Due Date */}\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Assigned To *</Label>\n              <Select \n                onValueChange={(value) => setValue(\"assignedUserId\", value)}\n                value={watch(\"assignedUserId\")}\n                disabled={usersLoading}\n              >\n                <SelectTrigger data-testid=\"todo-assigned-user-select\">\n                  <SelectValue placeholder=\"Select user\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {users.map((user) => (\n                    <SelectItem key={user.id} value={user.id}>\n                      {user.firstName && user.lastName \n                        ? `${user.firstName} ${user.lastName}` \n                        : user.email}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Due Date</Label>\n              <Popover>\n                <PopoverTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    className=\"w-full justify-start text-left font-normal\"\n                    data-testid=\"todo-due-date-trigger\"\n                  >\n                    <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                    {dueDate ? format(dueDate, \"PPP\") : \"Pick a date\"}\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                  <Calendar\n                    mode=\"single\"\n                    selected={dueDate || undefined}\n                    onSelect={(date) => setDueDate(date || null)}\n                    initialFocus\n                    data-testid=\"todo-due-date-calendar\"\n                  />\n                </PopoverContent>\n              </Popover>\n            </div>\n          </div>\n\n          {/* Entity Linking Section */}\n          <div className=\"space-y-4 border-t pt-4\">\n            <Label className=\"text-base font-semibold\">Entity Linking (Optional)</Label>\n            \n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"orderId\">Order ID</Label>\n                <Input\n                  id=\"orderId\"\n                  placeholder=\"Enter order ID...\"\n                  {...register(\"orderId\")}\n                  data-testid=\"todo-order-id-input\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"caseId\">Case ID</Label>\n                <Input\n                  id=\"caseId\"\n                  placeholder=\"Enter case ID...\"\n                  {...register(\"caseId\")}\n                  data-testid=\"todo-case-id-input\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"customerId\">Customer ID</Label>\n                <Input\n                  id=\"customerId\"\n                  placeholder=\"Enter customer ID...\"\n                  {...register(\"customerId\")}\n                  data-testid=\"todo-customer-id-input\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"repairId\">Repair ID</Label>\n                <Input\n                  id=\"repairId\"\n                  placeholder=\"Enter repair ID...\"\n                  {...register(\"repairId\")}\n                  data-testid=\"todo-repair-id-input\"\n                />\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={handleClose}\n              data-testid=\"todo-cancel-button\"\n            >\n              Cancel\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={createTodoMutation.isPending || updateTodoMutation.isPending}\n              data-testid=\"todo-submit-button\"\n            >\n              {(createTodoMutation.isPending || updateTodoMutation.isPending) \n                ? (todo ? \"Updating...\" : \"Creating...\") \n                : (todo ? \"Save Changes\" : \"Create Todo\")}\n            </Button>\n          </DialogFooter>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":13615},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-lg border border-border bg-input px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#FF6600] focus-visible:border-[#FF6600] transition-all duration-200 disabled:cursor-not-allowed disabled:opacity-50 resize-y\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":694},"client/src/pages/orders.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  Search, \n  Filter, \n  Download, \n  RefreshCw,\n  Package,\n  CreditCard,\n  Truck,\n  Eye,\n  MoreHorizontal,\n  MessageSquare,\n  ChevronDown,\n  ChevronUp,\n  ChevronsUpDown,\n  ChevronLeft,\n  ChevronRight,\n  Upload\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { Order } from \"@/lib/types\";\nimport type { User } from \"@shared/schema\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  Table, \n  TableBody, \n  TableCell, \n  TableHead, \n  TableHeader, \n  TableRow \n} from \"@/components/ui/table\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { NotesPanel } from \"@/components/notes/NotesPanel\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\n\ntype SortField = 'orderNumber' | 'customer' | 'totalAmount' | 'status' | 'paymentStatus' | 'createdAt' | 'orderDate';\ntype SortDirection = 'asc' | 'desc';\n\nexport default function Orders() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [sortField, setSortField] = useState<SortField>('orderDate');\n  const [sortDirection, setSortDirection] = useState<SortDirection>('desc');\n  const [currentPage, setCurrentPage] = useState(1);\n  const [pageSize, setPageSize] = useState(20);\n  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null);\n  const [showOrderDetails, setShowOrderDetails] = useState(false);\n  const [showImportDialog, setShowImportDialog] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const { toast } = useToast();\n  const [location, setLocation] = useLocation();\n\n  const { data: ordersData, isLoading } = useQuery<{ orders: Order[], total: number } | Order[]>({\n    queryKey: [\"/api/orders\", currentPage, pageSize, searchQuery],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        page: currentPage.toString(),\n        limit: pageSize.toString(),\n      });\n      if (searchQuery) {\n        params.append('search', searchQuery);\n      }\n      const response = await fetch(`/api/orders?${params}`);\n      if (!response.ok) {\n        throw new Error('Failed to fetch orders');\n      }\n      return response.json();\n    },\n  });\n\n  const { data: orderStats } = useQuery<{\n    total: number;\n    totalAmount: number;\n    pending: number;\n    processing: number;\n    shipped: number;\n    delivered: number;\n  }>({\n    queryKey: [\"/api/orders/stats\"],\n  });\n\n  const { data: currentUser } = useQuery<User>({\n    queryKey: [\"/api/auth/session\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/session\");\n      if (!response.ok) throw new Error(\"Not authenticated\");\n      const data = await response.json();\n      return data.user;\n    },\n  });\n\n  // Handle both paginated and non-paginated data structures\n  const orders = Array.isArray(ordersData) ? ordersData : ordersData?.orders || [];\n  const totalOrders = Array.isArray(ordersData) ? ordersData.length : ordersData?.total || 0;\n  const totalPages = Math.ceil(totalOrders / pageSize);\n\n  // Check for orderId in URL and fetch/open order details\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const orderId = params.get('orderId');\n    \n    if (orderId) {\n      // First check if the order is already in the loaded orders\n      const existingOrder = orders.find(o => o.id === orderId);\n      if (existingOrder) {\n        setSelectedOrder(existingOrder);\n        setShowOrderDetails(true);\n        setLocation('/orders');\n      } else {\n        // Fetch the specific order by ID\n        fetch(`/api/orders/${orderId}`)\n          .then(response => {\n            if (!response.ok) throw new Error('Order not found');\n            return response.json();\n          })\n          .then(order => {\n            setSelectedOrder(order);\n            setShowOrderDetails(true);\n            setLocation('/orders');\n          })\n          .catch(error => {\n            console.error('Failed to fetch order:', error);\n            toast({\n              title: \"Order not found\",\n              description: \"The requested order could not be found.\",\n              variant: \"destructive\",\n            });\n            setLocation('/orders');\n          });\n      }\n    }\n  }, [location, orders, setLocation, toast]);\n\n  const syncAllMutation = useMutation({\n    mutationFn: async () => {\n      // Test connection first\n      const testResponse = await fetch('/api/shopify/test');\n      const testResult = await testResponse.json();\n      if (!testResult.success) {\n        throw new Error(testResult.message || 'Shopify connection failed');\n      }\n\n      // Sync both customers and orders (incremental)\n      const [customersResponse, ordersResponse] = await Promise.all([\n        fetch(\"/api/customers/sync\", { method: \"POST\" }),\n        fetch(\"/api/orders/sync\", { method: \"POST\" })\n      ]);\n      \n      if (!customersResponse.ok) throw new Error(\"Failed to sync customers\");\n      if (!ordersResponse.ok) throw new Error(\"Failed to sync orders\");\n      \n      const customersData = await customersResponse.json();\n      const ordersData = await ordersResponse.json();\n      \n      return { customersData, ordersData };\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/customers\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      toast({\n        title: \"Shopify sync voltooid\",\n        description: `Gesynchroniseerd: ${data.customersData.synced || 0} klanten en ${data.ordersData.synced || 0} orders`,\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Sync mislukt\",\n        description: error instanceof Error ? error.message : \"Failed to sync from Shopify\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const importCSVMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append('file', file);\n      \n      const response = await fetch('/api/orders/import-csv', {\n        method: 'POST',\n        body: formData\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || 'CSV import failed');\n      }\n      \n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders/stats\"] });\n      setShowImportDialog(false);\n      setSelectedFile(null);\n      toast({\n        title: \"CSV Import Successful\",\n        description: `Imported: ${data.created} created, ${data.updated} updated, ${data.skipped} skipped`,\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"CSV Import Failed\",\n        description: error instanceof Error ? error.message : \"Failed to import CSV\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSort = (field: SortField) => {\n    if (sortField === field) {\n      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');\n    } else {\n      setSortField(field);\n      setSortDirection('asc');\n    }\n  };\n\n  const handlePageChange = (page: number) => {\n    setCurrentPage(page);\n  };\n\n  const handlePageSizeChange = (size: string) => {\n    setPageSize(parseInt(size));\n    setCurrentPage(1); // Reset to first page when changing page size\n  };\n\n  const handleViewDetails = (order: Order) => {\n    setSelectedOrder(order);\n    setShowOrderDetails(true);\n  };\n\n  const handleTrackShipment = (order: Order) => {\n    // Check if there's tracking information in the order data\n    const trackingNumber = (order.orderData as any)?.fulfillments?.[0]?.tracking_number;\n    const trackingUrl = (order.orderData as any)?.fulfillments?.[0]?.tracking_url;\n    \n    if (trackingUrl) {\n      window.open(trackingUrl, '_blank', 'noopener,noreferrer');\n    } else if (trackingNumber) {\n      toast({\n        title: \"Tracking Number\",\n        description: `Tracking number: ${trackingNumber}`,\n      });\n    } else {\n      toast({\n        title: \"No tracking information\",\n        description: \"This order doesn't have tracking information yet.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleDownloadInvoice = (order: Order) => {\n    // For now, open the Shopify order page or show a message\n    const shopifyOrderId = order.shopifyOrderId;\n    if (shopifyOrderId) {\n      toast({\n        title: \"Invoice Download\",\n        description: \"Invoice download functionality will be implemented soon.\",\n      });\n    } else {\n      toast({\n        title: \"No invoice available\",\n        description: \"This order doesn't have an associated invoice.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleTeamNotes = (order: Order) => {\n    // Set the order for notes display\n    setSelectedOrder(order);\n    setShowOrderDetails(true);\n    // Future: Could scroll to notes section or open a separate dialog\n  };\n\n  const getSortIcon = (field: SortField) => {\n    if (sortField !== field) {\n      return <ChevronsUpDown className=\"ml-2 h-4 w-4\" />;\n    }\n    return sortDirection === 'asc' ? \n      <ChevronUp className=\"ml-2 h-4 w-4\" /> : \n      <ChevronDown className=\"ml-2 h-4 w-4\" />;\n  };\n\n  const filteredAndSortedOrders = orders?.filter(order => {\n    if (statusFilter !== \"all\" && order.status !== statusFilter) return false;\n    if (searchQuery && \n        !order.orderNumber.toLowerCase().includes(searchQuery.toLowerCase()) &&\n        !order.customerEmail?.toLowerCase().includes(searchQuery.toLowerCase())) return false;\n    return true;\n  }).sort((a, b) => {\n    let aVal: any, bVal: any;\n    \n    switch (sortField) {\n      case 'orderNumber':\n        aVal = parseInt(a.orderNumber.replace(/[^0-9]/g, '')) || 0;\n        bVal = parseInt(b.orderNumber.replace(/[^0-9]/g, '')) || 0;\n        break;\n      case 'customer':\n        const aCustomer = (a.orderData as any)?.customer ? \n          `${(a.orderData as any).customer.first_name} ${(a.orderData as any).customer.last_name}` : \n          'Guest';\n        const bCustomer = (b.orderData as any)?.customer ? \n          `${(b.orderData as any).customer.first_name} ${(b.orderData as any).customer.last_name}` : \n          'Guest';\n        aVal = aCustomer.toLowerCase();\n        bVal = bCustomer.toLowerCase();\n        break;\n      case 'totalAmount':\n        aVal = a.totalAmount || 0;\n        bVal = b.totalAmount || 0;\n        break;\n      case 'status':\n        aVal = a.status?.toLowerCase() || '';\n        bVal = b.status?.toLowerCase() || '';\n        break;\n      case 'paymentStatus':\n        aVal = a.paymentStatus?.toLowerCase() || '';\n        bVal = b.paymentStatus?.toLowerCase() || '';\n        break;\n      case 'createdAt':\n        aVal = new Date(a.createdAt || '').getTime();\n        bVal = new Date(b.createdAt || '').getTime();\n        break;\n      case 'orderDate':\n        aVal = new Date(a.orderDate || a.createdAt || '').getTime();\n        bVal = new Date(b.orderDate || b.createdAt || '').getTime();\n        break;\n      default:\n        return 0;\n    }\n    \n    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;\n    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;\n    return 0;\n  }) || [];\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"paid\":\n      case \"delivered\":\n        return \"default\";\n      case \"processing\":\n      case \"shipped\":\n        return \"secondary\";\n      case \"pending\":\n        return \"outline\";\n      case \"cancelled\":\n      case \"refunded\":\n        return \"destructive\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  const getPaymentStatusIcon = (status: string) => {\n    switch (status) {\n      case \"paid\":\n        return <CreditCard className=\"h-4 w-4 text-chart-2\" />;\n      case \"pending\":\n        return <CreditCard className=\"h-4 w-4 text-chart-4\" />;\n      case \"refunded\":\n        return <CreditCard className=\"h-4 w-4 text-destructive\" />;\n      default:\n        return <CreditCard className=\"h-4 w-4 text-muted-foreground\" />;\n    }\n  };\n\n  const statusCounts = {\n    all: orderStats?.total || 0,\n    pending: orderStats?.pending || 0,\n    processing: orderStats?.processing || 0,\n    shipped: orderStats?.shipped || 0,\n    delivered: orderStats?.delivered || 0,\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"orders-page\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        <div className=\"bg-card rounded-lg p-6 mb-6 border\" data-testid=\"orders-header\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">Orders</h1>\n              <p className=\"text-muted-foreground\">View and manage customer orders from Shopify</p>\n            </div>\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <Button variant=\"outline\" data-testid=\"export-orders-button\">\n                <Download className=\"mr-2 h-4 w-4\" />\n                Export CSV\n              </Button>\n              \n              <Button \n                variant=\"outline\"\n                onClick={() => setShowImportDialog(true)}\n                data-testid=\"import-csv-button\"\n              >\n                <Upload className=\"mr-2 h-4 w-4\" />\n                Import CSV\n              </Button>\n              \n              <Button \n                onClick={() => syncAllMutation.mutate()}\n                disabled={syncAllMutation.isPending}\n                data-testid=\"sync-shopify-button\"\n              >\n                <RefreshCw className={`mr-2 h-4 w-4 ${syncAllMutation.isPending ? 'animate-spin' : ''}`} />\n                {syncAllMutation.isPending ? \"Syncing...\" : \"Sync Shopify\"}\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-5 mb-6\">\n          <Card data-testid=\"orders-stats-all\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Orders</CardTitle>\n              <Package className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                {orderStats?.total || 0}\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                orders\n              </p>\n            </CardContent>\n          </Card>\n          \n          <Card data-testid=\"orders-stats-pending\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Pending</CardTitle>\n              <Package className=\"h-4 w-4 text-chart-4\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{statusCounts.pending}</div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"orders-stats-processing\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Processing</CardTitle>\n              <Package className=\"h-4 w-4 text-primary\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{statusCounts.processing}</div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"orders-stats-shipped\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Shipped</CardTitle>\n              <Truck className=\"h-4 w-4 text-chart-2\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{statusCounts.shipped}</div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"orders-stats-delivered\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Delivered</CardTitle>\n              <Package className=\"h-4 w-4 text-chart-2\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{statusCounts.delivered}</div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Filters and Search */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"p-4\">\n            <div className=\"space-y-4\">\n              {/* Search Bar */}\n              <div className=\"relative w-full\">\n                <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Search orders, customers...\"\n                  className=\"pl-10\"\n                  value={searchQuery}\n                  onChange={(e) => {\n                    setSearchQuery(e.target.value);\n                    setCurrentPage(1); // Reset to first page when searching\n                  }}\n                  data-testid=\"orders-search-input\"\n                />\n              </div>\n\n              {/* Status Tabs */}\n              <Tabs value={statusFilter} onValueChange={setStatusFilter}>\n                <TabsList className=\"w-full grid grid-cols-5 h-auto\">\n                  <TabsTrigger value=\"all\" data-testid=\"filter-all-orders\" className=\"text-xs sm:text-sm\">All</TabsTrigger>\n                  <TabsTrigger value=\"pending\" data-testid=\"filter-pending-orders\" className=\"text-xs sm:text-sm\">Pending</TabsTrigger>\n                  <TabsTrigger value=\"processing\" data-testid=\"filter-processing-orders\" className=\"text-xs sm:text-sm\">Processing</TabsTrigger>\n                  <TabsTrigger value=\"shipped\" data-testid=\"filter-shipped-orders\" className=\"text-xs sm:text-sm\">Shipped</TabsTrigger>\n                  <TabsTrigger value=\"delivered\" data-testid=\"filter-delivered-orders\" className=\"text-xs sm:text-sm\">Delivered</TabsTrigger>\n                </TabsList>\n              </Tabs>\n              \n              {/* Page Size and Filters */}\n              <div className=\"flex items-center justify-between gap-2\">\n                <Select value={pageSize.toString()} onValueChange={handlePageSizeChange}>\n                  <SelectTrigger className=\"w-full sm:w-40\" data-testid=\"page-size-selector\">\n                    <SelectValue placeholder=\"Page size\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"20\">20 per page</SelectItem>\n                    <SelectItem value=\"50\">50 per page</SelectItem>\n                    <SelectItem value=\"100\">100 per page</SelectItem>\n                  </SelectContent>\n                </Select>\n                \n                <Button variant=\"outline\" size=\"icon\" data-testid=\"advanced-filters-button\">\n                  <Filter className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Orders Table - Desktop */}\n        <Card data-testid=\"orders-table\" className=\"hidden md:block\">\n          <CardContent className=\"p-0\">\n            {isLoading ? (\n              <div className=\"p-8 space-y-4\">\n                {[...Array(5)].map((_, i) => (\n                  <div key={i} className=\"flex items-center space-x-4 animate-pulse\">\n                    <div className=\"h-4 bg-muted rounded w-20\"></div>\n                    <div className=\"h-4 bg-muted rounded w-32\"></div>\n                    <div className=\"h-4 bg-muted rounded w-24\"></div>\n                    <div className=\"h-4 bg-muted rounded w-16\"></div>\n                    <div className=\"h-4 bg-muted rounded w-20\"></div>\n                  </div>\n                ))}\n              </div>\n            ) : filteredAndSortedOrders.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                No orders found\n              </div>\n            ) : (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead \n                      className=\"cursor-pointer hover:bg-muted/50 select-none\"\n                      onClick={() => handleSort('orderNumber')}\n                      data-testid=\"sort-order-header\"\n                    >\n                      <div className=\"flex items-center\">\n                        Order\n                        {getSortIcon('orderNumber')}\n                      </div>\n                    </TableHead>\n                    <TableHead \n                      className=\"cursor-pointer hover:bg-muted/50 select-none\"\n                      onClick={() => handleSort('customer')}\n                      data-testid=\"sort-customer-header\"\n                    >\n                      <div className=\"flex items-center\">\n                        Customer\n                        {getSortIcon('customer')}\n                      </div>\n                    </TableHead>\n                    <TableHead \n                      className=\"cursor-pointer hover:bg-muted/50 select-none\"\n                      onClick={() => handleSort('totalAmount')}\n                      data-testid=\"sort-total-header\"\n                    >\n                      <div className=\"flex items-center\">\n                        Total\n                        {getSortIcon('totalAmount')}\n                      </div>\n                    </TableHead>\n                    <TableHead \n                      className=\"cursor-pointer hover:bg-muted/50 select-none\"\n                      onClick={() => handleSort('status')}\n                      data-testid=\"sort-status-header\"\n                    >\n                      <div className=\"flex items-center\">\n                        Status\n                        {getSortIcon('status')}\n                      </div>\n                    </TableHead>\n                    <TableHead \n                      className=\"cursor-pointer hover:bg-muted/50 select-none\"\n                      onClick={() => handleSort('paymentStatus')}\n                      data-testid=\"sort-payment-header\"\n                    >\n                      <div className=\"flex items-center\">\n                        Payment\n                        {getSortIcon('paymentStatus')}\n                      </div>\n                    </TableHead>\n                    <TableHead \n                      className=\"cursor-pointer hover:bg-muted/50 select-none\"\n                      onClick={() => handleSort('orderDate')}\n                      data-testid=\"sort-date-header\"\n                    >\n                      <div className=\"flex items-center\">\n                        Date\n                        {getSortIcon('orderDate')}\n                      </div>\n                    </TableHead>\n                    <TableHead className=\"w-[50px]\"></TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredAndSortedOrders.map((order) => (\n                    <TableRow \n                      key={order.id} \n                      data-testid={`order-row-${order.id}`}\n                      className=\"cursor-pointer hover:bg-muted/50\"\n                      onClick={() => handleViewDetails(order)}\n                    >\n                      <TableCell className=\"font-medium\">\n                        <div className=\"flex items-center space-x-2\">\n                          <span\n                            className=\"text-primary font-medium\"\n                            data-testid={`order-number-${order.id}`}\n                          >\n                            {order.orderNumber}\n                          </span>\n                          {(order.orderData as any)?.line_items?.length > 0 && (\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {(order.orderData as any).line_items.length} {(order.orderData as any).line_items.length === 1 ? 'item' : 'items'}\n                            </Badge>\n                          )}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <div>\n                          <div className=\"font-medium text-sm\">\n                            {(order.orderData as any)?.customer ? \n                              `${(order.orderData as any).customer.first_name} ${(order.orderData as any).customer.last_name}` :\n                              'Guest'\n                            }\n                          </div>\n                          <div className=\"text-xs text-muted-foreground\">{order.customerEmail}</div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"font-medium\">\n                          ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                        </span>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={getStatusVariant(order.status)}>\n                          {order.status?.charAt(0).toUpperCase() + order.status?.slice(1)}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center space-x-1\">\n                          {getPaymentStatusIcon(order.paymentStatus || 'pending')}\n                          <span className=\"text-sm\">\n                            {order.paymentStatus ? order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1) : 'Pending'}\n                          </span>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <span className=\"text-sm text-muted-foreground\">\n                          {new Date(order.orderDate || order.createdAt || '').toLocaleString('nl-NL', {\n                            day: '2-digit',\n                            month: '2-digit',\n                            year: 'numeric',\n                            hour: '2-digit',\n                            minute: '2-digit',\n                            hour12: false\n                          })}\n                        </span>\n                      </TableCell>\n                      <TableCell onClick={(e) => e.stopPropagation()}>\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild>\n                            <Button variant=\"ghost\" size=\"icon\" data-testid={`order-actions-${order.id}`}>\n                              <MoreHorizontal className=\"h-4 w-4\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem onClick={() => handleViewDetails(order)} data-testid={`view-details-${order.id}`}>\n                              <Eye className=\"mr-2 h-4 w-4\" />\n                              View Details\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={() => handleTrackShipment(order)} data-testid={`track-shipment-${order.id}`}>\n                              <Truck className=\"mr-2 h-4 w-4\" />\n                              Track Shipment\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={() => handleDownloadInvoice(order)} data-testid={`download-invoice-${order.id}`}>\n                              <Download className=\"mr-2 h-4 w-4\" />\n                              Download Invoice\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={() => handleTeamNotes(order)} data-testid={`team-notes-${order.id}`}>\n                              <MessageSquare className=\"mr-2 h-4 w-4\" />\n                              Team Notes\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Orders Cards - Mobile */}\n        <div className=\"md:hidden space-y-3\">\n          {isLoading ? (\n            [...Array(5)].map((_, i) => (\n              <Card key={i}>\n                <CardContent className=\"p-4 space-y-3 animate-pulse\">\n                  <div className=\"h-4 bg-muted rounded w-24\"></div>\n                  <div className=\"h-3 bg-muted rounded w-32\"></div>\n                  <div className=\"h-3 bg-muted rounded w-20\"></div>\n                </CardContent>\n              </Card>\n            ))\n          ) : filteredAndSortedOrders.length === 0 ? (\n            <Card>\n              <CardContent className=\"p-8 text-center text-muted-foreground\">\n                No orders found\n              </CardContent>\n            </Card>\n          ) : (\n            filteredAndSortedOrders.map((order) => (\n              <Card \n                key={order.id} \n                className=\"cursor-pointer hover:bg-muted/50 transition-colors\"\n                onClick={() => handleViewDetails(order)}\n                data-testid={`order-card-${order.id}`}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-start justify-between mb-3\">\n                    <div className=\"flex-1\">\n                      <div className=\"font-semibold text-primary mb-1\" data-testid={`order-number-${order.id}`}>\n                        {order.orderNumber}\n                      </div>\n                      <div className=\"text-sm font-medium\">\n                        {(order.orderData as any)?.customer ? \n                          `${(order.orderData as any).customer.first_name} ${(order.orderData as any).customer.last_name}` :\n                          'Guest'\n                        }\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">{order.customerEmail}</div>\n                    </div>\n                    <div className=\"text-right\">\n                      <div className=\"font-semibold\">‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}</div>\n                      {(order.orderData as any)?.line_items?.length > 0 && (\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          {(order.orderData as any).line_items.length} {(order.orderData as any).line_items.length === 1 ? 'item' : 'items'}\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"flex items-center justify-between gap-2\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <Badge variant={getStatusVariant(order.status)}>\n                        {order.status?.charAt(0).toUpperCase() + order.status?.slice(1)}\n                      </Badge>\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {order.paymentStatus ? order.paymentStatus.charAt(0).toUpperCase() + order.paymentStatus.slice(1) : 'Pending'}\n                      </Badge>\n                    </div>\n                    <div className=\"text-xs text-muted-foreground whitespace-nowrap\">\n                      {new Date(order.orderDate || order.createdAt || '').toLocaleDateString('nl-NL')}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </div>\n\n        {/* Pagination Controls */}\n        {totalPages > 1 && (\n          <div className=\"flex items-center justify-between mt-6\">\n            <div className=\"text-sm text-muted-foreground\">\n              Showing {((currentPage - 1) * pageSize) + 1} to {Math.min(currentPage * pageSize, totalOrders)} of {totalOrders} orders\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handlePageChange(currentPage - 1)}\n                disabled={currentPage === 1}\n                data-testid=\"prev-page-button\"\n              >\n                <ChevronLeft className=\"h-4 w-4\" />\n                Previous\n              </Button>\n              \n              <div className=\"flex items-center space-x-1\">\n                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {\n                  const page = i + 1;\n                  return (\n                    <Button\n                      key={page}\n                      variant={currentPage === page ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => handlePageChange(page)}\n                      data-testid={`page-${page}-button`}\n                    >\n                      {page}\n                    </Button>\n                  );\n                })}\n                {totalPages > 5 && (\n                  <>\n                    {currentPage < totalPages - 2 && <span className=\"px-2\">...</span>}\n                    <Button\n                      variant={currentPage === totalPages ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => handlePageChange(totalPages)}\n                      data-testid={`page-${totalPages}-button`}\n                    >\n                      {totalPages}\n                    </Button>\n                  </>\n                )}\n              </div>\n              \n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => handlePageChange(currentPage + 1)}\n                disabled={currentPage === totalPages}\n                data-testid=\"next-page-button\"\n              >\n                Next\n                <ChevronRight className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {/* Order Details Dialog */}\n        <Dialog open={showOrderDetails} onOpenChange={setShowOrderDetails}>\n          <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Order Details {selectedOrder?.orderNumber}</DialogTitle>\n              <DialogDescription>\n                Complete order information and history\n              </DialogDescription>\n            </DialogHeader>\n            \n            {selectedOrder && (\n              <div className=\"space-y-6\">\n                {/* Order Summary */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Order Information</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Order Number:</span>\n                        <span className=\"font-medium\">{selectedOrder.orderNumber}</span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Total Amount:</span>\n                        <span className=\"font-medium\">‚Ç¨{((selectedOrder.totalAmount || 0) / 100).toFixed(2)}</span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Status:</span>\n                        <Badge variant={getStatusVariant(selectedOrder.status)}>\n                          {selectedOrder.status?.charAt(0).toUpperCase() + selectedOrder.status?.slice(1)}\n                        </Badge>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Payment Status:</span>\n                        <span className=\"font-medium\">\n                          {selectedOrder.paymentStatus ? selectedOrder.paymentStatus.charAt(0).toUpperCase() + selectedOrder.paymentStatus.slice(1) : 'Pending'}\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Order Date:</span>\n                        <span className=\"font-medium\">\n                          {new Date(selectedOrder.orderDate || selectedOrder.createdAt || '').toLocaleString('nl-NL', {\n                            day: '2-digit',\n                            month: '2-digit',\n                            year: 'numeric',\n                            hour: '2-digit',\n                            minute: '2-digit',\n                            hour12: false\n                          })}\n                        </span>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Customer Information</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Name:</span>\n                        <span className=\"font-medium\">\n                          {(selectedOrder.orderData as any)?.customer ? \n                            `${(selectedOrder.orderData as any).customer.first_name} ${(selectedOrder.orderData as any).customer.last_name}` :\n                            'Guest'\n                          }\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Email:</span>\n                        <span className=\"font-medium\">{selectedOrder.customerEmail}</span>\n                      </div>\n                      {(selectedOrder.orderData as any)?.customer?.phone && (\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-muted-foreground\">Phone:</span>\n                          <span className=\"font-medium\">{(selectedOrder.orderData as any).customer.phone}</span>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                </div>\n\n                {/* Line Items */}\n                {(selectedOrder.orderData as any)?.line_items && (\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Order Items</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-3\">\n                        {(selectedOrder.orderData as any).line_items.map((item: any, index: number) => (\n                          <div key={index} className=\"flex justify-between items-center p-3 border rounded-lg\">\n                            <div className=\"flex-1\">\n                              <div className=\"font-medium\">{item.title}</div>\n                              {item.variant_title && (\n                                <div className=\"text-sm text-muted-foreground\">{item.variant_title}</div>\n                              )}\n                              <div className=\"text-sm text-muted-foreground\">Quantity: {item.quantity}</div>\n                            </div>\n                            <div className=\"text-right\">\n                              <div className=\"font-medium\">‚Ç¨{parseFloat(item.price).toFixed(2)}</div>\n                              <div className=\"text-sm text-muted-foreground\">\n                                Total: ‚Ç¨{(parseFloat(item.price) * item.quantity).toFixed(2)}\n                              </div>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n\n                {/* Shipping Address */}\n                {(selectedOrder.orderData as any)?.shipping_address && (\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-lg\">Shipping Address</CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"space-y-1\">\n                        <div>{(selectedOrder.orderData as any).shipping_address.name}</div>\n                        <div>{(selectedOrder.orderData as any).shipping_address.address1}</div>\n                        {(selectedOrder.orderData as any).shipping_address.address2 && (\n                          <div>{(selectedOrder.orderData as any).shipping_address.address2}</div>\n                        )}\n                        <div>\n                          {(selectedOrder.orderData as any).shipping_address.city}, {(selectedOrder.orderData as any).shipping_address.zip}\n                        </div>\n                        <div>{(selectedOrder.orderData as any).shipping_address.country}</div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n\n                {/* Team Notes */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-lg\">Team Notes</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {currentUser && (\n                      <NotesPanel \n                        entityType=\"order\" \n                        entityId={selectedOrder.id}\n                        currentUser={currentUser}\n                      />\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n\n        {/* CSV Import Dialog */}\n        <Dialog open={showImportDialog} onOpenChange={setShowImportDialog}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Import Orders from CSV</DialogTitle>\n              <DialogDescription>\n                Upload a Shopify order export CSV file to import orders into the system. The system will automatically create or update orders and customers.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Input\n                  type=\"file\"\n                  accept=\".csv\"\n                  onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}\n                  disabled={importCSVMutation.isPending}\n                  data-testid=\"csv-file-input\"\n                />\n                {selectedFile && (\n                  <p className=\"text-sm text-muted-foreground\">\n                    Selected: {selectedFile.name} ({(selectedFile.size / 1024).toFixed(2)} KB)\n                  </p>\n                )}\n              </div>\n              <div className=\"flex justify-end space-x-2\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    setShowImportDialog(false);\n                    setSelectedFile(null);\n                  }}\n                  disabled={importCSVMutation.isPending}\n                  data-testid=\"cancel-import-button\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  onClick={() => selectedFile && importCSVMutation.mutate(selectedFile)}\n                  disabled={!selectedFile || importCSVMutation.isPending}\n                  data-testid=\"confirm-import-button\"\n                >\n                  {importCSVMutation.isPending ? (\n                    <>\n                      <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />\n                      Importing...\n                    </>\n                  ) : (\n                    <>\n                      <Upload className=\"mr-2 h-4 w-4\" />\n                      Import Orders\n                    </>\n                  )}\n                </Button>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n      </main>\n    </div>\n  );\n}\n","size_bytes":45231},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/pages/repairs.tsx":{"content":"import { useState } from \"react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Search, CalendarIcon, Plus, X } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Repair, User } from \"@shared/schema\";\nimport { RepairForm } from \"@/components/forms/repair-form\";\nimport { RepairsTable } from \"@/components/repairs/repairs-table\";\nimport { RepairDetailModal } from \"@/components/repairs/repair-detail-modal\";\nimport { RepairAnalytics } from \"@/components/repairs/repair-analytics\";\nimport { format } from \"date-fns\";\nimport { useAuth } from \"@/lib/auth\";\n\nexport default function Repairs() {\n  const { user } = useAuth();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [technicianFilter, setTechnicianFilter] = useState<string>(\"all\");\n  const [dateFrom, setDateFrom] = useState<Date | null>(null);\n  const [dateTo, setDateTo] = useState<Date | null>(null);\n  const [showNewRepair, setShowNewRepair] = useState(false);\n  const [selectedRepair, setSelectedRepair] = useState<Repair | null>(null);\n\n  const { data: repairs = [], isLoading } = useQuery<Repair[]>({\n    queryKey: [\"/api/repairs\"],\n  });\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const filteredRepairs = repairs.filter(repair => {\n    if (statusFilter && statusFilter !== \"all\" && repair.status !== statusFilter) return false;\n    if (technicianFilter && technicianFilter !== \"all\" && repair.assignedUserId !== technicianFilter) return false;\n    if (searchQuery && \n        !repair.title.toLowerCase().includes(searchQuery.toLowerCase()) &&\n        !repair.description?.toLowerCase().includes(searchQuery.toLowerCase()) &&\n        !repair.productSku?.toLowerCase().includes(searchQuery.toLowerCase()) &&\n        !repair.productName?.toLowerCase().includes(searchQuery.toLowerCase())) return false;\n    if (dateFrom && repair.createdAt && new Date(repair.createdAt) < dateFrom) return false;\n    if (dateTo && repair.createdAt && new Date(repair.createdAt) > dateTo) return false;\n    return true;\n  });\n\n  const clearFilters = () => {\n    setSearchQuery(\"\");\n    setStatusFilter(\"all\");\n    setTechnicianFilter(\"all\");\n    setDateFrom(null);\n    setDateTo(null);\n  };\n\n  const hasActiveFilters = searchQuery || (statusFilter && statusFilter !== \"all\") || (technicianFilter && technicianFilter !== \"all\") || dateFrom || dateTo;\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"repairs-page\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        <div className=\"bg-card rounded-lg p-6 mb-6 border\" data-testid=\"repairs-header\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">Reparaties</h1>\n              <p className=\"text-muted-foreground\">Beheer reparatieverzoeken en volg de voortgang</p>\n            </div>\n            <Button onClick={() => setShowNewRepair(true)} data-testid=\"button-new-repair\" className=\"sm:flex-shrink-0\">\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Nieuwe Reparatie\n            </Button>\n          </div>\n        </div>\n\n        {/* Analytics Dashboard */}\n        <div className=\"mb-6\">\n          {isLoading ? (\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n              {[...Array(6)].map((_, i) => (\n                <Card key={i}>\n                  <CardContent className=\"p-6\">\n                    <div className=\"h-4 bg-muted rounded mb-2 animate-pulse\"></div>\n                    <div className=\"h-8 bg-muted rounded animate-pulse\"></div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : (\n            <RepairAnalytics repairs={filteredRepairs} users={users} />\n          )}\n        </div>\n\n        {/* Filters */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex flex-col space-y-4\">\n              <div className=\"flex items-center gap-4 flex-wrap\">\n                <div className=\"relative flex-1 min-w-[200px]\">\n                  <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Zoek reparaties...\"\n                    className=\"pl-10\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    data-testid=\"input-search\"\n                  />\n                </div>\n\n                <Select value={statusFilter} onValueChange={setStatusFilter}>\n                  <SelectTrigger className=\"w-[180px]\" data-testid=\"select-status-filter\">\n                    <SelectValue placeholder=\"Alle statussen\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Alle statussen</SelectItem>\n                    <SelectItem value=\"new\">Nieuw</SelectItem>\n                    <SelectItem value=\"diagnosing\">Diagnose</SelectItem>\n                    <SelectItem value=\"waiting_parts\">Wacht op onderdelen</SelectItem>\n                    <SelectItem value=\"repair_in_progress\">In reparatie</SelectItem>\n                    <SelectItem value=\"quality_check\">Kwaliteitscontrole</SelectItem>\n                    <SelectItem value=\"completed\">Voltooid</SelectItem>\n                    <SelectItem value=\"returned\">Geretourneerd</SelectItem>\n                    <SelectItem value=\"canceled\">Geannuleerd</SelectItem>\n                  </SelectContent>\n                </Select>\n\n                {user?.role !== 'TECHNICUS' && (\n                  <Select value={technicianFilter} onValueChange={setTechnicianFilter}>\n                    <SelectTrigger className=\"w-[180px]\" data-testid=\"select-technician-filter\">\n                      <SelectValue placeholder=\"Alle technici\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">Alle technici</SelectItem>\n                      {users.filter(u => u.role === 'TECHNICUS' || u.role === 'ADMIN').map((user) => (\n                        <SelectItem key={user.id} value={user.id}>\n                          {user.firstName || ''} {user.lastName || ''} ({user.username})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                )}\n\n                <Popover>\n                  <PopoverTrigger asChild>\n                    <Button variant=\"outline\" data-testid=\"button-date-from\">\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                      {dateFrom ? format(dateFrom, \"PP\") : \"Van datum\"}\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                    <Calendar\n                      mode=\"single\"\n                      selected={dateFrom || undefined}\n                      onSelect={(date) => setDateFrom(date || null)}\n                      initialFocus\n                      data-testid=\"calendar-date-from\"\n                    />\n                  </PopoverContent>\n                </Popover>\n\n                <Popover>\n                  <PopoverTrigger asChild>\n                    <Button variant=\"outline\" data-testid=\"button-date-to\">\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                      {dateTo ? format(dateTo, \"PP\") : \"Tot datum\"}\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                    <Calendar\n                      mode=\"single\"\n                      selected={dateTo || undefined}\n                      onSelect={(date) => setDateTo(date || null)}\n                      initialFocus\n                      data-testid=\"calendar-date-to\"\n                    />\n                  </PopoverContent>\n                </Popover>\n\n                {hasActiveFilters && (\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\" \n                    onClick={clearFilters}\n                    data-testid=\"button-clear-filters\"\n                  >\n                    <X className=\"mr-2 h-4 w-4\" />\n                    Filters wissen\n                  </Button>\n                )}\n              </div>\n\n              <div className=\"text-sm text-muted-foreground\">\n                {filteredRepairs.length} van {repairs.length} reparaties\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Repairs Table */}\n        {isLoading ? (\n          <Card>\n            <CardContent className=\"p-6\">\n              <div className=\"space-y-4\">\n                {[...Array(5)].map((_, i) => (\n                  <div key={i} className=\"p-4 border rounded-lg animate-pulse\">\n                    <div className=\"h-4 bg-muted rounded mb-2\"></div>\n                    <div className=\"h-3 bg-muted rounded w-3/4 mb-1\"></div>\n                    <div className=\"h-3 bg-muted rounded w-1/2\"></div>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <RepairsTable\n            repairs={filteredRepairs}\n            users={users}\n            onRepairClick={(repair) => setSelectedRepair(repair)}\n          />\n        )}\n      </main>\n\n      <RepairForm \n        open={showNewRepair} \n        onOpenChange={setShowNewRepair}\n        users={users}\n      />\n\n      <RepairDetailModal\n        repair={selectedRepair}\n        open={!!selectedRepair}\n        onOpenChange={(open) => !open && setSelectedRepair(null)}\n        users={users}\n      />\n    </div>\n  );\n}\n","size_bytes":10315},"client/src/components/purchase-orders/purchase-order-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { useAuth } from \"@/lib/auth\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertPurchaseOrderSchema, type Supplier } from \"@shared/schema\";\nimport type { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, X, Upload, FileText } from \"lucide-react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ntype PurchaseOrderFormData = z.infer<typeof insertPurchaseOrderSchema>;\n\ninterface PurchaseOrderFormProps {\n  open: boolean;\n  onClose: () => void;\n  suppliers: Supplier[];\n  purchaseOrders: any[];\n  editPurchaseOrder?: any;\n}\n\ninterface LineItem {\n  id: string;\n  sku: string;\n  productName: string;\n  quantity: number;\n  unitPrice: number;\n}\n\nexport function PurchaseOrderForm({ open, onClose, suppliers, purchaseOrders, editPurchaseOrder }: PurchaseOrderFormProps) {\n  const { toast } = useToast();\n  const [lineItems, setLineItems] = useState<LineItem[]>([]);\n  const [supplierSearch, setSupplierSearch] = useState(\"\");\n  const [isSupplierDropdownOpen, setIsSupplierDropdownOpen] = useState(false);\n  const [uploadedFiles, setUploadedFiles] = useState<File[]>([]);\n  const [amountInput, setAmountInput] = useState(\"\");\n  const [showNewSupplierDialog, setShowNewSupplierDialog] = useState(false);\n  const [newSupplierCode, setNewSupplierCode] = useState(\"\");\n  const [newSupplierName, setNewSupplierName] = useState(\"\");\n  const { user } = useAuth();\n\n  // Calculate status counts\n  const statusCounts = {\n    aangekocht: purchaseOrders.filter(po => po.status === 'aangekocht').length,\n    ontvangen: purchaseOrders.filter(po => po.status === 'ontvangen').length,\n    verwerkt: purchaseOrders.filter(po => po.status === 'verwerkt').length,\n  };\n\n  // Sort all suppliers by supplier code descending (highest number first)\n  const sortedSuppliers = [...suppliers]\n    .sort((a, b) => b.supplierCode.localeCompare(a.supplierCode, undefined, { numeric: true }));\n\n  // Filter suppliers based on search\n  const filteredSuppliers = supplierSearch.trim() === \"\"\n    ? sortedSuppliers\n    : suppliers\n        .filter(s => \n          s.supplierCode.toLowerCase().includes(supplierSearch.toLowerCase()) ||\n          s.name.toLowerCase().includes(supplierSearch.toLowerCase())\n        )\n        .sort((a, b) => b.supplierCode.localeCompare(a.supplierCode, undefined, { numeric: true }));\n\n  const form = useForm({\n    resolver: zodResolver(insertPurchaseOrderSchema.omit({ poNumber: true })),\n    defaultValues: {\n      title: \"\",\n      supplierNumber: \"\",\n      supplierId: \"\",\n      orderDate: new Date(),\n      expectedDeliveryDate: undefined,\n      totalAmount: 0,\n      currency: \"EUR\",\n      status: \"aangekocht\" as const,\n      isPaid: false,\n      notes: \"\",\n      createdBy: user?.id || \"\",\n    },\n  });\n\n  // Fetch line items when editing\n  const { data: existingLineItems } = useQuery<any[]>({\n    queryKey: [\"/api/purchase-order-items\", editPurchaseOrder?.id],\n    queryFn: async () => {\n      const response = await fetch(`/api/purchase-order-items/${editPurchaseOrder.id}`, {\n        credentials: \"include\"\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch items\");\n      return response.json();\n    },\n    enabled: !!editPurchaseOrder?.id,\n  });\n\n  // Populate form when editing\n  useEffect(() => {\n    if (editPurchaseOrder && open) {\n      form.reset({\n        title: editPurchaseOrder.title || \"\",\n        supplierNumber: editPurchaseOrder.supplierNumber || \"\",\n        supplierId: editPurchaseOrder.supplierId || \"\",\n        orderDate: editPurchaseOrder.orderDate ? new Date(editPurchaseOrder.orderDate) : new Date(),\n        expectedDeliveryDate: editPurchaseOrder.expectedDeliveryDate ? new Date(editPurchaseOrder.expectedDeliveryDate) : undefined,\n        totalAmount: editPurchaseOrder.totalAmount || 0,\n        currency: editPurchaseOrder.currency || \"EUR\",\n        status: editPurchaseOrder.status || \"aangekocht\",\n        isPaid: editPurchaseOrder.isPaid || false,\n        notes: editPurchaseOrder.notes || \"\",\n        createdBy: editPurchaseOrder.createdBy || user?.id || \"\",\n      });\n      \n      // Set supplier search text\n      const supplier = suppliers.find(s => s.id === editPurchaseOrder.supplierId);\n      if (supplier) {\n        setSupplierSearch(`${supplier.supplierCode} - ${supplier.name}`);\n      }\n      \n      // Set amount input\n      if (editPurchaseOrder.totalAmount) {\n        setAmountInput((editPurchaseOrder.totalAmount / 100).toString());\n      }\n    }\n  }, [editPurchaseOrder, open, form, suppliers, user?.id]);\n\n  // Populate line items when editing\n  useEffect(() => {\n    if (existingLineItems && existingLineItems.length > 0) {\n      setLineItems(existingLineItems.map(item => ({\n        id: item.id,\n        sku: item.sku || \"\",\n        productName: item.productName || \"\",\n        quantity: item.quantity || 0,\n        unitPrice: (item.unitPrice || 0) / 100,\n      })));\n    }\n  }, [existingLineItems]);\n\n  const createSupplierMutation = useMutation({\n    mutationFn: async (data: { supplierCode: string; name: string }) => {\n      const response = await apiRequest(\"POST\", \"/api/suppliers\", data);\n      return await response.json();\n    },\n    onSuccess: (newSupplier) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/suppliers\"] });\n      toast({ \n        title: \"Leverancier aangemaakt\", \n        description: \"De leverancier is succesvol aangemaakt.\" \n      });\n      // Select the newly created supplier\n      form.setValue(\"supplierId\", newSupplier.id);\n      setSupplierSearch(`${newSupplier.supplierCode} - ${newSupplier.name}`);\n      // Close dialog and reset\n      setShowNewSupplierDialog(false);\n      setNewSupplierCode(\"\");\n      setNewSupplierName(\"\");\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Fout bij aanmaken leverancier\", \n        description: error.message || \"Er is een fout opgetreden.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: any) => {\n      // Send PO with line items in a single request (backend handles atomically)\n      const poResponse = await apiRequest(\"POST\", \"/api/purchase-orders\", data);\n      const purchaseOrder = await poResponse.json();\n      return purchaseOrder;\n    },\n    onSuccess: async (purchaseOrder) => {\n      // Upload files if any were selected\n      if (uploadedFiles.length > 0) {\n        try {\n          const formData = new FormData();\n          uploadedFiles.forEach(file => {\n            formData.append('files', file);\n          });\n\n          const response = await fetch(`/api/purchase-orders/${purchaseOrder.id}/upload`, {\n            method: 'POST',\n            credentials: 'include',\n            body: formData,\n          });\n\n          if (!response.ok) {\n            const data = await response.json();\n            throw new Error(data.message || \"Upload failed\");\n          }\n          \n          console.log(`Uploaded ${uploadedFiles.length} files to purchase order ${purchaseOrder.id}`);\n        } catch (error) {\n          console.error(\"Error uploading files:\", error);\n          const message = error instanceof Error ? error.message : \"Bestanden konden niet worden ge√ºpload\";\n          toast({\n            title: \"Bestanden niet ge√ºpload\",\n            description: `De inkoop order is aangemaakt, maar: ${message}`,\n            variant: \"destructive\"\n          });\n          return; // Don't close form, let user retry\n        }\n      }\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      toast({ \n        title: \"Inkoop order aangemaakt\", \n        description: \"De inkoop order is succesvol aangemaakt.\" \n      });\n      onClose();\n      form.reset();\n      setLineItems([]);\n      setAmountInput(\"\");\n      setUploadedFiles([]);\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Fout bij aanmaken\", \n        description: error.message || \"Er is een fout opgetreden.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (data: any) => {\n      // Update the PO with line items - backend handles atomically\n      const poResponse = await apiRequest(\"PATCH\", `/api/purchase-orders/${editPurchaseOrder.id}`, data);\n      return await poResponse.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-order-items\", editPurchaseOrder.id] });\n      toast({ \n        title: \"Inkoop order bijgewerkt\", \n        description: \"De inkoop order is succesvol bijgewerkt.\" \n      });\n      onClose();\n      form.reset();\n      setLineItems([]);\n      setAmountInput(\"\");\n      setUploadedFiles([]);\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Fout bij bijwerken\", \n        description: error.message || \"Er is een fout opgetreden.\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handleSubmit = (data: any) => {\n    // Calculate total amount from line items in cents\n    const total = Math.round(lineItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0) * 100);\n    \n    if (editPurchaseOrder) {\n      updateMutation.mutate({ ...data, totalAmount: total, lineItems });\n    } else {\n      createMutation.mutate({ ...data, totalAmount: total, createdBy: user?.id, lineItems });\n    }\n  };\n\n  const addLineItem = () => {\n    setLineItems([...lineItems, {\n      id: Math.random().toString(),\n      sku: \"\",\n      productName: \"\",\n      quantity: 1,\n      unitPrice: 0,\n    }]);\n  };\n\n  const removeLineItem = (id: string) => {\n    setLineItems(lineItems.filter(item => item.id !== id));\n  };\n\n  const updateLineItem = (id: string, field: keyof LineItem, value: any) => {\n    setLineItems(lineItems.map(item => \n      item.id === id ? { ...item, [field]: value } : item\n    ));\n  };\n\n  const totalAmount = lineItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);\n\n  return (\n    <>\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>{editPurchaseOrder ? \"Bewerk Inkoop Order\" : \"Nieuwe Inkoop Order\"}</DialogTitle>\n        </DialogHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-6\">\n            <div className=\"grid grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Titel</FormLabel>\n                    <FormControl>\n                      <Input {...field} data-testid=\"input-po-title\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"supplierId\"\n                render={({ field }) => (\n                  <FormItem>\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <FormLabel>Leverancier</FormLabel>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => setShowNewSupplierDialog(true)}\n                        className=\"h-7 text-xs\"\n                        data-testid=\"button-new-supplier\"\n                      >\n                        <Plus className=\"h-3 w-3 mr-1\" />\n                        Nieuwe Leverancier\n                      </Button>\n                    </div>\n                    <div className=\"relative\">\n                      <FormControl>\n                        <Input\n                          placeholder=\"Zoek leverancier op code of naam...\"\n                          value={supplierSearch}\n                          onChange={(e) => {\n                            setSupplierSearch(e.target.value);\n                            setIsSupplierDropdownOpen(true);\n                          }}\n                          onFocus={() => {\n                            setIsSupplierDropdownOpen(true);\n                            if (field.value) {\n                              setSupplierSearch(\"\");\n                            }\n                          }}\n                          onBlur={() => {\n                            setTimeout(() => setIsSupplierDropdownOpen(false), 200);\n                          }}\n                          data-testid=\"input-supplier-search\"\n                        />\n                      </FormControl>\n                      {isSupplierDropdownOpen && (\n                        <div className=\"absolute z-50 w-full mt-1 bg-white dark:bg-gray-800 border rounded-md shadow-lg max-h-60 overflow-auto\">\n                          {supplierSearch ? (\n                            filteredSuppliers.length > 0 ? (\n                              filteredSuppliers.map((supplier) => (\n                                <div\n                                  key={supplier.id}\n                                  className=\"px-3 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700\"\n                                  onClick={() => {\n                                    field.onChange(supplier.id);\n                                    setSupplierSearch(`${supplier.supplierCode} - ${supplier.name}`);\n                                    setIsSupplierDropdownOpen(false);\n                                  }}\n                                  data-testid={`supplier-option-${supplier.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">{supplier.supplierCode}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{supplier.name}</div>\n                                </div>\n                              ))\n                            ) : (\n                              <div className=\"px-3 py-2 text-sm text-muted-foreground\">\n                                Geen leveranciers gevonden\n                              </div>\n                            )\n                          ) : (\n                            <>\n                              <div className=\"px-3 py-2 text-xs text-muted-foreground border-b\">\n                                Alle leveranciers (hoogste nummer eerst)\n                              </div>\n                              {sortedSuppliers.map((supplier) => (\n                                <div\n                                  key={supplier.id}\n                                  className=\"px-3 py-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700\"\n                                  onClick={() => {\n                                    field.onChange(supplier.id);\n                                    setSupplierSearch(`${supplier.supplierCode} - ${supplier.name}`);\n                                    setIsSupplierDropdownOpen(false);\n                                  }}\n                                  data-testid={`supplier-option-${supplier.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">{supplier.supplierCode}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{supplier.name}</div>\n                                </div>\n                              ))}\n                            </>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"orderDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Order Datum</FormLabel>\n                    <FormControl>\n                      <Input type=\"date\" {...field} data-testid=\"input-order-date\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"expectedDeliveryDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Verwachte Levering</FormLabel>\n                    <FormControl>\n                      <Input type=\"date\" {...field} value={field.value || \"\"} data-testid=\"input-delivery-date\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"status\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Status</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-status\">\n                          <SelectValue />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"aangekocht\">Aangekocht ({statusCounts.aangekocht})</SelectItem>\n                        <SelectItem value=\"ontvangen\">Ontvangen ({statusCounts.ontvangen})</SelectItem>\n                        <SelectItem value=\"verwerkt\">Verwerkt ({statusCounts.verwerkt})</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"totalAmount\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Bedrag (‚Ç¨)</FormLabel>\n                    <div className=\"flex items-center gap-3\">\n                      <FormControl>\n                        <Input\n                          type=\"text\"\n                          inputMode=\"decimal\"\n                          placeholder=\"250,00\"\n                          value={lineItems.length > 0 \n                            ? totalAmount.toFixed(2).replace('.', ',') \n                            : amountInput}\n                          onFocus={(e) => {\n                            if (lineItems.length === 0 && (amountInput === \"0,00\" || amountInput === \"\")) {\n                              setAmountInput(\"\");\n                            }\n                          }}\n                          onChange={(e) => {\n                            if (lineItems.length === 0) {\n                              setAmountInput(e.target.value);\n                            }\n                          }}\n                          onBlur={(e) => {\n                            if (lineItems.length === 0) {\n                              const normalized = e.target.value.replace(',', '.');\n                              const amount = parseFloat(normalized) || 0;\n                              field.onChange(Math.round(amount * 100));\n                              setAmountInput(amount.toFixed(2).replace('.', ','));\n                            }\n                          }}\n                          disabled={lineItems.length > 0}\n                          data-testid=\"input-amount\"\n                          className=\"flex-1\"\n                        />\n                      </FormControl>\n                      <FormField\n                        control={form.control}\n                        name=\"isPaid\"\n                        render={({ field: checkField }) => (\n                          <FormItem className=\"flex items-center gap-2 space-y-0\">\n                            <FormLabel className=\"text-sm font-normal whitespace-nowrap\">Betaald:</FormLabel>\n                            <FormControl>\n                              <Checkbox\n                                checked={checkField.value}\n                                onCheckedChange={checkField.onChange}\n                                data-testid=\"checkbox-is-paid\"\n                                className=\"data-[state=checked]:bg-green-600 data-[state=checked]:text-white data-[state=checked]:border-green-600\"\n                              />\n                            </FormControl>\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n                    {lineItems.length > 0 && (\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Berekend uit regel items\n                      </p>\n                    )}\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <FormLabel>Regel Items</FormLabel>\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={addLineItem}\n                  data-testid=\"button-add-line-item\"\n                >\n                  <Plus className=\"h-4 w-4 mr-1\" />\n                  Item Toevoegen\n                </Button>\n              </div>\n\n              {lineItems.map((item, index) => (\n                <Card key={item.id}>\n                  <CardContent className=\"pt-4\">\n                    <div className=\"grid grid-cols-12 gap-2 items-start\">\n                      <div className=\"col-span-2\">\n                        <Input\n                          placeholder=\"SKU\"\n                          value={item.sku}\n                          onChange={(e) => updateLineItem(item.id, 'sku', e.target.value)}\n                          data-testid={`input-sku-${index}`}\n                        />\n                      </div>\n                      <div className=\"col-span-4\">\n                        <Input\n                          placeholder=\"Productnaam\"\n                          value={item.productName}\n                          onChange={(e) => updateLineItem(item.id, 'productName', e.target.value)}\n                          data-testid={`input-productname-${index}`}\n                        />\n                      </div>\n                      <div className=\"col-span-2\">\n                        <Input\n                          type=\"number\"\n                          placeholder=\"Aantal\"\n                          value={item.quantity}\n                          onChange={(e) => updateLineItem(item.id, 'quantity', parseFloat(e.target.value) || 0)}\n                          data-testid={`input-quantity-${index}`}\n                        />\n                      </div>\n                      <div className=\"col-span-2\">\n                        <Input\n                          type=\"number\"\n                          step=\"0.01\"\n                          placeholder=\"Prijs\"\n                          value={item.unitPrice}\n                          onChange={(e) => updateLineItem(item.id, 'unitPrice', parseFloat(e.target.value) || 0)}\n                          data-testid={`input-price-${index}`}\n                        />\n                      </div>\n                      <div className=\"col-span-1 text-sm pt-2\">\n                        ‚Ç¨{(item.quantity * item.unitPrice).toFixed(2)}\n                      </div>\n                      <div className=\"col-span-1\">\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => removeLineItem(item.id)}\n                          data-testid={`button-remove-${index}`}\n                        >\n                          <X className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n\n              {lineItems.length > 0 && (\n                <div className=\"flex justify-end font-medium text-lg\">\n                  Totaal: ‚Ç¨{totalAmount.toFixed(2)}\n                </div>\n              )}\n            </div>\n\n            <FormField\n              control={form.control}\n              name=\"notes\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Notities</FormLabel>\n                  <FormControl>\n                    <Textarea {...field} value={field.value || \"\"} data-testid=\"textarea-notes\" />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"space-y-3\">\n              <FormLabel>Bijlagen (optioneel)</FormLabel>\n              <div className=\"border-2 border-dashed rounded-lg p-4\">\n                <input\n                  type=\"file\"\n                  multiple\n                  accept=\"image/*,.pdf,.doc,.docx,.xlsx,.xls\"\n                  onChange={(e) => {\n                    const files = Array.from(e.target.files || []);\n                    setUploadedFiles([...uploadedFiles, ...files]);\n                  }}\n                  className=\"hidden\"\n                  id=\"file-upload\"\n                  data-testid=\"input-file-upload\"\n                />\n                <label\n                  htmlFor=\"file-upload\"\n                  className=\"flex flex-col items-center justify-center cursor-pointer\"\n                >\n                  <Upload className=\"h-8 w-8 text-muted-foreground mb-2\" />\n                  <span className=\"text-sm text-muted-foreground\">\n                    Klik om bestanden te uploaden\n                  </span>\n                  <span className=\"text-xs text-muted-foreground mt-1\">\n                    Afbeeldingen, PDF, Excel documenten\n                  </span>\n                </label>\n              </div>\n              {uploadedFiles.length > 0 && (\n                <div className=\"space-y-2\">\n                  {uploadedFiles.map((file, index) => (\n                    <div\n                      key={index}\n                      className=\"flex items-center justify-between p-2 bg-muted rounded-md\"\n                    >\n                      <div className=\"flex items-center gap-2\">\n                        <FileText className=\"h-4 w-4\" />\n                        <span className=\"text-sm\">{file.name}</span>\n                        <span className=\"text-xs text-muted-foreground\">\n                          ({(file.size / 1024).toFixed(1)} KB)\n                        </span>\n                      </div>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setUploadedFiles(uploadedFiles.filter((_, i) => i !== index));\n                        }}\n                        data-testid={`button-remove-file-${index}`}\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n\n            <div className=\"flex gap-2 justify-end\">\n              <Button type=\"button\" variant=\"outline\" onClick={onClose} data-testid=\"button-cancel\">\n                Annuleer\n              </Button>\n              <Button type=\"submit\" disabled={createMutation.isPending} data-testid=\"button-create-po\">\n                {createMutation.isPending ? \"Aanmaken...\" : \"Aanmaken\"}\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n\n    <Dialog open={showNewSupplierDialog} onOpenChange={setShowNewSupplierDialog}>\n      <DialogContent className=\"max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Nieuwe Leverancier</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4\">\n          <div>\n            <label className=\"text-sm font-medium mb-2 block\">Leverancier Code</label>\n            <Input\n              placeholder=\"Bijv. SUP001\"\n              value={newSupplierCode}\n              onChange={(e) => setNewSupplierCode(e.target.value)}\n              data-testid=\"input-new-supplier-code\"\n            />\n          </div>\n          <div>\n            <label className=\"text-sm font-medium mb-2 block\">Naam</label>\n            <Input\n              placeholder=\"Bijv. Acme Supplies B.V.\"\n              value={newSupplierName}\n              onChange={(e) => setNewSupplierName(e.target.value)}\n              data-testid=\"input-new-supplier-name\"\n            />\n          </div>\n          <div className=\"flex gap-2 justify-end\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => {\n                setShowNewSupplierDialog(false);\n                setNewSupplierCode(\"\");\n                setNewSupplierName(\"\");\n              }}\n              data-testid=\"button-cancel-supplier\"\n            >\n              Annuleer\n            </Button>\n            <Button\n              onClick={() => {\n                if (newSupplierCode && newSupplierName) {\n                  createSupplierMutation.mutate({\n                    supplierCode: newSupplierCode,\n                    name: newSupplierName,\n                  });\n                }\n              }}\n              disabled={!newSupplierCode || !newSupplierName || createSupplierMutation.isPending}\n              data-testid=\"button-create-supplier\"\n            >\n              {createSupplierMutation.isPending ? \"Aanmaken...\" : \"Aanmaken\"}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n    </>\n  );\n}","size_bytes":30804},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/email/email-list.tsx":{"content":"import { EmailThread } from \"@shared/schema\";\nimport { EmailListItem } from \"./email-list-item\";\nimport { EmailListSkeleton } from \"./email-list-skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { Loader2 } from \"lucide-react\";\n\ninterface EmailListProps {\n  threads: EmailThread[];\n  selectedThread: string | null;\n  selectedThreadIds: Set<string>;\n  isLoading: boolean;\n  onThreadSelect: (id: string) => void;\n  onThreadCheck: (id: string, checked: boolean) => void;\n  onStarToggle: (id: string, starred: boolean) => void;\n  onLoadMore?: () => void;\n  hasMore?: boolean;\n}\n\nexport function EmailList({\n  threads,\n  selectedThread,\n  selectedThreadIds,\n  isLoading,\n  onThreadSelect,\n  onThreadCheck,\n  onStarToggle,\n  onLoadMore,\n  hasMore,\n}: EmailListProps) {\n  if (isLoading && threads.length === 0) {\n    return <EmailListSkeleton />;\n  }\n\n  if (!isLoading && threads.length === 0) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\" data-testid=\"email-list-empty\">\n        <div className=\"text-center\">\n          <p className=\"text-muted-foreground\">No email threads found</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\" data-testid=\"email-list\">\n      {threads.map((thread) => (\n        <EmailListItem\n          key={thread.id}\n          thread={thread}\n          isSelected={selectedThreadIds.has(thread.id)}\n          isActive={selectedThread === thread.id}\n          onSelect={onThreadCheck}\n          onClick={onThreadSelect}\n          onStarToggle={onStarToggle}\n        />\n      ))}\n      \n      {hasMore && (\n        <div className=\"p-4 text-center\">\n          <Button\n            variant=\"outline\"\n            onClick={onLoadMore}\n            disabled={isLoading}\n            data-testid=\"load-more-button\"\n          >\n            {isLoading ? (\n              <>\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                Loading...\n              </>\n            ) : (\n              \"Load More\"\n            )}\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":2104},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/providers/auth-provider.tsx":{"content":"import { useState, useEffect, ReactNode } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { AuthContext, AuthUser, authApi } from \"@/lib/auth\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface AuthProviderProps {\n  children: ReactNode;\n}\n\nexport function AuthProvider({ children }: AuthProviderProps) {\n  const [user, setUser] = useState<AuthUser | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  useEffect(() => {\n    checkSession();\n  }, []);\n\n  const checkSession = async () => {\n    setLoading(true);\n    try {\n      const { user, error } = await authApi.getSession();\n      if (error) {\n        console.error(\"Session check error:\", error);\n        setUser(null);\n      } else {\n        setUser(user || null);\n      }\n    } catch (error) {\n      console.error(\"Session check failed:\", error);\n      setUser(null);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const signIn = async (email: string, password: string) => {\n    const { user, error } = await authApi.signIn(email, password);\n    \n    if (error) {\n      toast({\n        title: \"Sign in failed\",\n        description: error,\n        variant: \"destructive\",\n      });\n      return { error };\n    }\n\n    if (user) {\n      setUser(user);\n      toast({\n        title: \"Welcome back!\",\n        description: `Signed in as ${user.firstName || user.email}`,\n      });\n      \n      // Redirect based on role\n      if (user.role === \"TECHNICUS\") {\n        setLocation(\"/repairs\");\n      } else {\n        setLocation(\"/\");\n      }\n    }\n\n    return {};\n  };\n\n  const signOut = async () => {\n    const { error } = await authApi.signOut();\n    \n    if (error) {\n      toast({\n        title: \"Sign out failed\",\n        description: error,\n        variant: \"destructive\",\n      });\n    } else {\n      setUser(null);\n      toast({\n        title: \"Signed out\",\n        description: \"You have been signed out successfully\",\n      });\n    }\n  };\n\n  const refreshSession = async () => {\n    await checkSession();\n  };\n\n  const value = {\n    user,\n    loading,\n    signIn,\n    signOut,\n    refreshSession,\n  };\n\n  return (\n    <AuthContext.Provider value={value}>\n      {children}\n    </AuthContext.Provider>\n  );\n}","size_bytes":2275},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/components/widgets/orders-today-widget.tsx":{"content":"import { ShoppingBag } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { DashboardStats } from \"@/lib/types\";\n\nexport function OrdersTodayWidget() {\n  const { data: stats, isLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"orders-today-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse\">\n            <div className=\"h-4 bg-muted rounded mb-2\"></div>\n            <div className=\"h-8 bg-muted rounded mb-1\"></div>\n            <div className=\"h-3 bg-muted rounded\"></div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const todaysTotal = stats?.todaysOrders?.total || 1247;\n  const todaysCount = stats?.todaysOrders?.count || 12;\n\n  return (\n    <Card className=\"hover:shadow-card-hover\" data-testid=\"orders-today-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-semibold text-muted-foreground\">Orders Today</CardTitle>\n        <div className=\"h-10 w-10 rounded-full bg-gradient-orders flex items-center justify-center\">\n          <ShoppingBag className=\"h-5 w-5 text-white\" />\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-2\">\n          <div className=\"text-3xl font-bold text-orders\" data-testid=\"orders-total\">\n            ‚Ç¨{(todaysTotal / 100).toLocaleString()}\n          </div>\n          <p className=\"text-sm font-medium text-muted-foreground\" data-testid=\"orders-count\">\n            {todaysCount} new orders\n          </p>\n          <div className=\"flex items-center text-sm\">\n            <span className=\"text-success font-semibold\" data-testid=\"orders-change\">\n              +18% from yesterday\n            </span>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1997},"server/outlookClient.ts":{"content":"import { Client } from '@microsoft/microsoft-graph-client';\n\nlet connectionSettings: any;\n\nasync function getAccessToken() {\n  if (connectionSettings && connectionSettings.settings.expires_at && new Date(connectionSettings.settings.expires_at).getTime() > Date.now()) {\n    return connectionSettings.settings.access_token;\n  }\n  \n  const hostname = process.env.CONNECTORS_HOSTNAME\n  const xReplitToken = process.env.REPL_IDENTITY \n    ? 'repl ' + process.env.REPL_IDENTITY \n    : process.env.WEB_REPL_RENEWAL \n    ? 'depl ' + process.env.WEB_REPL_RENEWAL \n    : null;\n\n  if (!xReplitToken) {\n    throw new Error('X_REPLIT_TOKEN not found for repl/depl');\n  }\n\n  connectionSettings = await fetch(\n    'https://' + hostname + '/api/v2/connection?include_secrets=true&connector_names=outlook',\n    {\n      headers: {\n        'Accept': 'application/json',\n        'X_REPLIT_TOKEN': xReplitToken\n      }\n    }\n  ).then(res => res.json()).then(data => data.items?.[0]);\n\n  const accessToken = connectionSettings?.settings?.access_token || connectionSettings.settings?.oauth?.credentials?.access_token;\n\n  if (!connectionSettings || !accessToken) {\n    throw new Error('Outlook not connected');\n  }\n  return accessToken;\n}\n\n// WARNING: Never cache this client.\n// Access tokens expire, so a new client must be created each time.\n// Always call this function again to get a fresh client.\nexport async function getUncachableOutlookClient() {\n  const accessToken = await getAccessToken();\n\n  return Client.initWithMiddleware({\n    authProvider: {\n      getAccessToken: async () => accessToken\n    }\n  });\n}\n\nexport async function syncEmails() {\n  try {\n    const client = await getUncachableOutlookClient();\n    \n    // Get recent emails\n    const emails = await client\n      .api('/me/messages')\n      .top(50)\n      .orderby('receivedDateTime desc')\n      .get();\n\n    return emails.value;\n  } catch (error) {\n    console.error('Error syncing emails:', error);\n    throw error;\n  }\n}\n\nexport async function getEmailThreads() {\n  try {\n    const client = await getUncachableOutlookClient();\n    \n    // Get email conversations (threads)\n    const conversations = await client\n      .api('/me/mailFolders/inbox/childFolders')\n      .get();\n\n    return conversations.value;\n  } catch (error) {\n    console.error('Error getting email threads:', error);\n    throw error;\n  }\n}\n\nexport async function sendEmail(to: string, subject: string, body: string) {\n  try {\n    const client = await getUncachableOutlookClient();\n    \n    const message = {\n      message: {\n        subject: subject,\n        body: {\n          contentType: 'HTML',\n          content: body\n        },\n        toRecipients: [\n          {\n            emailAddress: {\n              address: to\n            }\n          }\n        ]\n      }\n    };\n\n    await client.api('/me/sendMail').post(message);\n    \n    return { success: true };\n  } catch (error) {\n    console.error('Error sending email:', error);\n    throw error;\n  }\n}\n","size_bytes":2979},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { startScheduledSync } from \"./scheduledSync\";\n\nconst app = express();\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: false, limit: '10mb' }));\n\n// Configure session middleware\napp.use(session({\n  secret: process.env.SESSION_SECRET || 'dutch-thrift-secret-key-change-in-production',\n  name: 'dutch.thrift.session',\n  resave: false,\n  saveUninitialized: false,\n  cookie: {\n    secure: false, // Set to true in production with HTTPS\n    httpOnly: true,\n    maxAge: 24 * 60 * 60 * 1000 // 24 hours\n  }\n}));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"‚Ä¶\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n    \n    // Start the scheduled Shopify sync\n    startScheduledSync();\n  });\n})();\n","size_bytes":2622},"server/services/emailService.ts":{"content":"import type { EmailProvider } from './emailProvider';\nimport { ImapSmtpProvider } from './imapSmtpProvider';\nimport { OutlookProvider } from './outlookProvider';\n\n// Factory function to get the appropriate email provider\nexport function getEmailProvider(): EmailProvider {\n  const provider = process.env.EMAIL_PROVIDER || 'outlook';\n  \n  console.log(`Email provider configured as: ${provider}`);\n  \n  switch (provider.toLowerCase()) {\n    case 'imap':\n      return new ImapSmtpProvider();\n    case 'outlook':\n      return new OutlookProvider();\n    default:\n      console.warn(`Unknown email provider: ${provider}, defaulting to Outlook`);\n      return new OutlookProvider();\n  }\n}\n\n// Convenience functions\nexport async function syncEmails() {\n  const provider = getEmailProvider();\n  return provider.syncEmails();\n}\n\nexport async function sendEmail(to: string, subject: string, body: string, replyToMessageId?: string) {\n  const provider = getEmailProvider();\n  return provider.sendEmail(to, subject, body, replyToMessageId);\n}","size_bytes":1029},"client/src/pages/todos.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { \n  Search, \n  Filter, \n  Plus,\n  CheckSquare,\n  Calendar,\n  User,\n  ExternalLink,\n  MoreHorizontal,\n  Clock,\n  AlertCircle,\n  FolderKanban,\n  UserCheck,\n  Zap\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { Todo } from \"@/lib/types\";\nimport { TodoForm } from \"@/components/forms/todo-form\";\nimport { KanbanView } from \"@/components/todos/kanban-view\";\nimport { CalendarView } from \"@/components/todos/calendar-view\";\nimport { TaskDetailModal } from \"@/components/todos/task-detail-modal\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nexport default function Todos() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [priorityFilter, setPriorityFilter] = useState(\"all\");\n  const [taskScope, setTaskScope] = useState<\"all\" | \"my\">(\"all\");\n  const [showNewTodo, setShowNewTodo] = useState(false);\n  const [editingTodo, setEditingTodo] = useState<Todo | null>(null);\n  const [selectedTask, setSelectedTask] = useState<Todo | null>(null);\n  const [showDetailModal, setShowDetailModal] = useState(false);\n  const [viewMode, setViewMode] = useState<\"list\" | \"kanban\" | \"calendar\">(\"list\");\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const searchInputRef = useRef<HTMLInputElement>(null);\n\n  const canSeeAllTasks = user?.role === \"ADMIN\" || user?.role === \"SUPPORT\";\n  const isTechnicus = user?.role === \"TECHNICUS\";\n\n  const { data: todos, isLoading } = useQuery<Todo[]>({\n    queryKey: [\"/api/todos\", { userId: (isTechnicus || (canSeeAllTasks && taskScope === \"my\")) && user?.id ? user.id : undefined }],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      // TECHNICUS always sees only their tasks, ADMIN/SUPPORT see all unless \"My Tasks\" is selected\n      if ((isTechnicus || (canSeeAllTasks && taskScope === \"my\")) && user?.id) {\n        params.append(\"userId\", user.id);\n      }\n      const url = `/api/todos${params.toString() ? `?${params.toString()}` : ''}`;\n      const response = await fetch(url, { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch todos\");\n      return response.json();\n    },\n  });\n\n  const updateTodoMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Todo> }) => {\n      const response = await fetch(`/api/todos/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update todo\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/todos\"] });\n      toast({\n        title: \"Todo updated\",\n        description: \"Todo status has been updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update todo\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const deleteTodoMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/todos/${id}`, { method: \"DELETE\" });\n      if (!response.ok) throw new Error(\"Failed to delete todo\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/todos\"] });\n      toast({\n        title: \"Todo deleted\",\n        description: \"Todo has been deleted successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Delete failed\",\n        description: \"Failed to delete todo\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const filteredTodos = todos?.filter(todo => {\n    if (statusFilter !== \"all\" && todo.status !== statusFilter) return false;\n    if (priorityFilter !== \"all\" && todo.priority !== priorityFilter) return false;\n    if (searchQuery && \n        !todo.title.toLowerCase().includes(searchQuery.toLowerCase()) &&\n        !todo.description?.toLowerCase().includes(searchQuery.toLowerCase())) return false;\n    return true;\n  }) || [];\n\n  const todoStatusCount = {\n    all: todos?.length || 0,\n    todo: todos?.filter(t => t.status === 'todo').length || 0,\n    in_progress: todos?.filter(t => t.status === 'in_progress').length || 0,\n    done: todos?.filter(t => t.status === 'done').length || 0,\n  };\n\n  // Additional analytics metrics\n  const overdueTasks = todos?.filter(t => {\n    if (!t.dueDate || t.status === 'done') return false;\n    return new Date(t.dueDate) < new Date();\n  }).length || 0;\n\n  const myTasks = todos?.filter(t => t.assignedUserId === user?.id).length || 0;\n\n  const highPriorityTasks = todos?.filter(t => \n    t.priority === 'urgent' || t.priority === 'high'\n  ).length || 0;\n\n  // Get category breakdown - find top category\n  const categoryCount = todos?.reduce((acc, todo) => {\n    const category = todo.category || 'other';\n    acc[category] = (acc[category] || 0) + 1;\n    return acc;\n  }, {} as Record<string, number>) || {};\n  \n  const topCategory = Object.entries(categoryCount).sort((a, b) => b[1] - a[1])[0];\n  const topCategoryName = topCategory ? topCategory[0].charAt(0).toUpperCase() + topCategory[0].slice(1) : 'Other';\n  const topCategoryCount = topCategory ? topCategory[1] : 0;\n\n  const handleToggleTodo = (todo: Todo) => {\n    const newStatus = todo.status === 'done' ? 'todo' : 'done';\n    const updateData: Partial<Todo> = {\n      status: newStatus as any,\n      completedAt: newStatus === 'done' ? new Date().toISOString() : null,\n    };\n    updateTodoMutation.mutate({ id: todo.id, data: updateData });\n  };\n\n  const getPriorityVariant = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"destructive\";\n      case \"high\":\n        return \"destructive\";\n      case \"medium\":\n        return \"secondary\";\n      case \"low\":\n        return \"outline\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"text-destructive\";\n      case \"high\":\n        return \"text-destructive\";\n      case \"medium\":\n        return \"text-chart-4\";\n      case \"low\":\n        return \"text-chart-2\";\n      default:\n        return \"text-muted-foreground\";\n    }\n  };\n\n  const formatDueDate = (dueDate: string | null) => {\n    if (!dueDate) return \"No due date\";\n    const date = new Date(dueDate);\n    const now = new Date();\n    const diffInDays = Math.ceil((date.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    \n    if (diffInDays < 0) return \"Overdue\";\n    if (diffInDays === 0) return \"Due today\";\n    if (diffInDays === 1) return \"Due tomorrow\";\n    return `Due in ${diffInDays} days`;\n  };\n\n  const isOverdue = (dueDate: string | null) => {\n    if (!dueDate) return false;\n    return new Date(dueDate) < new Date();\n  };\n\n  // Keyboard shortcuts\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Check if user is typing in an input/textarea\n      const target = e.target as HTMLElement;\n      const isTyping = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;\n\n      // \"n\" or \"N\" key opens new task form (when not typing)\n      if ((e.key === 'n' || e.key === 'N') && !isTyping) {\n        e.preventDefault();\n        setShowNewTodo(true);\n      }\n\n      // \"/\" key focuses the search input\n      if (e.key === '/' && !isTyping) {\n        e.preventDefault();\n        searchInputRef.current?.focus();\n      }\n\n      // \"Escape\" key closes modals/forms\n      if (e.key === 'Escape') {\n        if (showNewTodo) {\n          setShowNewTodo(false);\n        } else if (editingTodo) {\n          setEditingTodo(null);\n        } else if (showDetailModal) {\n          setShowDetailModal(false);\n        }\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [showNewTodo, editingTodo, showDetailModal]);\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"todos-page\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        <div className=\"bg-card rounded-lg p-6 mb-6 border\" data-testid=\"todos-header\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">To-do's</h1>\n              <p className=\"text-muted-foreground\">Manage personal and team tasks</p>\n            </div>\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <Button \n                variant=\"outline\"\n                onClick={() => setViewMode(viewMode === \"list\" ? \"kanban\" : viewMode === \"kanban\" ? \"calendar\" : \"list\")}\n                data-testid=\"toggle-view-mode\"\n              >\n                {viewMode === \"list\" && <CheckSquare className=\"mr-2 h-4 w-4\" />}\n                {viewMode === \"kanban\" && <Calendar className=\"mr-2 h-4 w-4\" />}\n                {viewMode === \"calendar\" && <CheckSquare className=\"mr-2 h-4 w-4\" />}\n                {viewMode === \"list\" ? \"Kanban View\" : viewMode === \"kanban\" ? \"Calendar View\" : \"List View\"}\n              </Button>\n              <Button onClick={() => setShowNewTodo(true)} data-testid=\"new-todo-button\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                New To-do\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6\">\n          <Card data-testid=\"todos-stats-total\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Tasks</CardTitle>\n              <CheckSquare className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{todoStatusCount.all}</div>\n            </CardContent>\n          </Card>\n          \n          <Card data-testid=\"todos-stats-pending\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">To Do</CardTitle>\n              <Clock className=\"h-4 w-4 text-chart-4\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{todoStatusCount.todo}</div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"todos-stats-progress\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">In Progress</CardTitle>\n              <Clock className=\"h-4 w-4 text-primary\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{todoStatusCount.in_progress}</div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"todos-stats-done\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Completed</CardTitle>\n              <CheckSquare className=\"h-4 w-4 text-chart-2\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{todoStatusCount.done}</div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Additional Analytics Cards */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6\">\n          <Card data-testid=\"todos-stats-overdue\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Overdue Tasks</CardTitle>\n              <AlertCircle className=\"h-4 w-4 text-destructive\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{overdueTasks}</div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"todos-stats-category\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Top Category</CardTitle>\n              <FolderKanban className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{topCategoryCount}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">{topCategoryName}</p>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"todos-stats-mine\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">My Tasks</CardTitle>\n              <UserCheck className=\"h-4 w-4 text-primary\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{myTasks}</div>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"todos-stats-high-priority\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">High Priority</CardTitle>\n              <Zap className=\"h-4 w-4 text-chart-1\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{highPriorityTasks}</div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Filters */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between space-x-4\">\n              <div className=\"flex items-center space-x-4 flex-1\">\n                <div className=\"relative flex-1 max-w-sm\">\n                  <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                  <Input\n                    ref={searchInputRef}\n                    placeholder=\"Search todos... (Press / to focus)\"\n                    className=\"pl-10\"\n                    value={searchQuery}\n                    onChange={(e) => setSearchQuery(e.target.value)}\n                    data-testid=\"todos-search-input\"\n                  />\n                </div>\n                \n                {canSeeAllTasks && (\n                  <Tabs value={taskScope} onValueChange={(value) => setTaskScope(value as \"all\" | \"my\")}>\n                    <TabsList>\n                      <TabsTrigger value=\"all\" data-testid=\"filter-all-tasks\">All Tasks</TabsTrigger>\n                      <TabsTrigger value=\"my\" data-testid=\"filter-my-tasks\">My Tasks</TabsTrigger>\n                    </TabsList>\n                  </Tabs>\n                )}\n                \n                <Tabs value={statusFilter} onValueChange={setStatusFilter}>\n                  <TabsList>\n                    <TabsTrigger value=\"all\" data-testid=\"filter-all-status\">All</TabsTrigger>\n                    <TabsTrigger value=\"todo\" data-testid=\"filter-todo-status\">To Do</TabsTrigger>\n                    <TabsTrigger value=\"in_progress\" data-testid=\"filter-progress-status\">In Progress</TabsTrigger>\n                    <TabsTrigger value=\"done\" data-testid=\"filter-done-status\">Done</TabsTrigger>\n                  </TabsList>\n                </Tabs>\n\n                <Tabs value={priorityFilter} onValueChange={setPriorityFilter}>\n                  <TabsList>\n                    <TabsTrigger value=\"all\" data-testid=\"filter-all-priority\">All Priority</TabsTrigger>\n                    <TabsTrigger value=\"urgent\" data-testid=\"filter-urgent-priority\">Urgent</TabsTrigger>\n                    <TabsTrigger value=\"high\" data-testid=\"filter-high-priority\">High</TabsTrigger>\n                    <TabsTrigger value=\"medium\" data-testid=\"filter-medium-priority\">Medium</TabsTrigger>\n                    <TabsTrigger value=\"low\" data-testid=\"filter-low-priority\">Low</TabsTrigger>\n                  </TabsList>\n                </Tabs>\n              </div>\n              \n              <Button variant=\"outline\" size=\"icon\" data-testid=\"advanced-filters-button\">\n                <Filter className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* View Modes */}\n        {viewMode === \"calendar\" ? (\n          <CalendarView \n            todos={filteredTodos}\n            onTaskClick={(todo) => {\n              setSelectedTask(todo);\n              setShowDetailModal(true);\n            }}\n            isLoading={isLoading}\n          />\n        ) : viewMode === \"kanban\" ? (\n          <KanbanView\n            todos={filteredTodos}\n            onUpdateStatus={(todoId, newStatus) => {\n              updateTodoMutation.mutate({\n                id: todoId,\n                data: {\n                  status: newStatus,\n                  completedAt: newStatus === 'done' ? new Date().toISOString() : null,\n                },\n              });\n            }}\n            onTaskClick={(todo) => {\n              setSelectedTask(todo);\n              setShowDetailModal(true);\n            }}\n            isLoading={isLoading}\n          />\n        ) : (\n          <Card data-testid=\"todos-list\">\n            <CardContent className=\"p-6\">\n              {isLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(5)].map((_, i) => (\n                    <div key={i} className=\"flex items-center space-x-3 p-3 animate-pulse\">\n                      <div className=\"h-4 w-4 bg-muted rounded\"></div>\n                      <div className=\"flex-1 space-y-1\">\n                        <div className=\"h-4 bg-muted rounded\"></div>\n                        <div className=\"h-3 bg-muted rounded w-3/4\"></div>\n                      </div>\n                      <div className=\"h-4 w-4 bg-muted rounded\"></div>\n                    </div>\n                  ))}\n                </div>\n              ) : filteredTodos.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No todos found. Create one to get started!\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {filteredTodos.map((todo) => (\n                    <Card\n                      key={todo.id}\n                      className={`transition-all hover:shadow-md cursor-pointer ${\n                        todo.status === 'done' ? 'opacity-60' : ''\n                      } ${isOverdue(todo.dueDate) && todo.status !== 'done' ? 'border-destructive' : ''}`}\n                      data-testid={`todo-item-${todo.id}`}\n                      onClick={() => {\n                        setSelectedTask(todo);\n                        setShowDetailModal(true);\n                      }}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-start space-x-3\">\n                          <Checkbox \n                            checked={todo.status === 'done'}\n                            onCheckedChange={(e) => {\n                              e.stopPropagation?.();\n                              handleToggleTodo(todo);\n                            }}\n                            onClick={(e) => e.stopPropagation()}\n                            disabled={updateTodoMutation.isPending}\n                            data-testid={`todo-checkbox-${todo.id}`}\n                          />\n                          \n                          <div className=\"flex-1 space-y-2\">\n                            <div className=\"flex items-start justify-between\">\n                              <h3 className={`font-medium ${todo.status === 'done' ? 'line-through' : ''}`}>\n                                {todo.title}\n                              </h3>\n                              <DropdownMenu>\n                                <DropdownMenuTrigger asChild>\n                                  <Button \n                                    variant=\"ghost\" \n                                    size=\"icon\" \n                                    data-testid={`todo-actions-${todo.id}`}\n                                    onClick={(e) => e.stopPropagation()}\n                                  >\n                                    <MoreHorizontal className=\"h-4 w-4\" />\n                                  </Button>\n                                </DropdownMenuTrigger>\n                                <DropdownMenuContent align=\"end\">\n                                  <DropdownMenuItem onClick={(e) => {\n                                    e.stopPropagation();\n                                    setEditingTodo(todo);\n                                  }}>\n                                    Edit\n                                  </DropdownMenuItem>\n                                  <DropdownMenuItem onClick={(e) => e.stopPropagation()}>\n                                    <ExternalLink className=\"mr-2 h-4 w-4\" />\n                                    View Links\n                                  </DropdownMenuItem>\n                                  <DropdownMenuItem \n                                    className=\"text-destructive\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      deleteTodoMutation.mutate(todo.id);\n                                    }}\n                                    disabled={deleteTodoMutation.isPending}\n                                  >\n                                    Delete\n                                  </DropdownMenuItem>\n                                </DropdownMenuContent>\n                              </DropdownMenu>\n                            </div>\n                            \n                            {todo.description && (\n                              <p className=\"text-sm text-muted-foreground\">{todo.description}</p>\n                            )}\n                            \n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"flex items-center space-x-2\">\n                                <Badge variant={getPriorityVariant(todo.priority || 'medium')}>\n                                  {todo.priority ? todo.priority.charAt(0).toUpperCase() + todo.priority.slice(1) : 'Medium'}\n                                </Badge>\n                                \n                                {todo.status === 'in_progress' && (\n                                  <Badge variant=\"outline\" className=\"bg-primary/10 text-primary\">\n                                    In Progress\n                                  </Badge>\n                                )}\n                              </div>\n                              \n                              <div className=\"flex items-center space-x-2 text-xs text-muted-foreground\">\n                                {todo.dueDate && (\n                                  <div className={`flex items-center space-x-1 ${\n                                    isOverdue(todo.dueDate) && todo.status !== 'done' ? 'text-destructive' : ''\n                                  }`}>\n                                    <Calendar className=\"h-3 w-3\" />\n                                    <span data-testid={`todo-due-date-${todo.id}`}>\n                                      {formatDueDate(todo.dueDate)}\n                                    </span>\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </main>\n\n      <TodoForm \n        open={showNewTodo} \n        onOpenChange={setShowNewTodo}\n      />\n      \n      <TodoForm \n        open={!!editingTodo} \n        onOpenChange={(open) => !open && setEditingTodo(null)}\n        todo={editingTodo}\n      />\n\n      <TaskDetailModal\n        todo={selectedTask}\n        open={showDetailModal}\n        onOpenChange={setShowDetailModal}\n        onUpdate={() => {\n          queryClient.invalidateQueries({ queryKey: [\"/api/todos\"] });\n        }}\n      />\n    </div>\n  );\n}\n","size_bytes":25169},"client/src/components/ui/image-upload.tsx":{"content":"import { useState, useRef, useId } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Upload, X, Image as ImageIcon } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface ImageUploadProps {\n  images: string[];\n  onChange: (images: string[]) => void;\n  maxImages?: number;\n  maxSizeMB?: number;\n  className?: string;\n}\n\nexport function ImageUpload({ \n  images, \n  onChange, \n  maxImages = 3, \n  maxSizeMB = 2,\n  className \n}: ImageUploadProps) {\n  const [isDragging, setIsDragging] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const inputId = useId();\n  const { toast } = useToast();\n\n  const handleFiles = async (files: FileList | null) => {\n    if (!files) return;\n\n    const newImages: string[] = [];\n    const maxSizeBytes = maxSizeMB * 1024 * 1024;\n\n    for (let i = 0; i < files.length && images.length + newImages.length < maxImages; i++) {\n      const file = files[i];\n      \n      // Check file type\n      if (!file.type.startsWith('image/')) {\n        toast({\n          title: \"Ongeldig bestand\",\n          description: `${file.name} is geen geldig afbeelding bestand.`,\n          variant: \"destructive\"\n        });\n        continue;\n      }\n\n      // Check file size\n      if (file.size > maxSizeBytes) {\n        toast({\n          title: \"Bestand te groot\",\n          description: `${file.name} is te groot. Maximum grootte is ${maxSizeMB}MB.`,\n          variant: \"destructive\"\n        });\n        continue;\n      }\n\n      try {\n        // Convert to base64\n        const reader = new FileReader();\n        const result = await new Promise<string>((resolve, reject) => {\n          reader.onload = () => resolve(reader.result as string);\n          reader.onerror = reject;\n          reader.readAsDataURL(file);\n        });\n        \n        newImages.push(result);\n      } catch (error) {\n        console.error('Error reading file:', error);\n        toast({\n          title: \"Upload fout\",\n          description: `Kon ${file.name} niet laden.`,\n          variant: \"destructive\"\n        });\n      }\n    }\n\n    if (newImages.length > 0) {\n      onChange([...images, ...newImages]);\n    }\n  };\n\n  const handleFileInput = (event: React.ChangeEvent<HTMLInputElement>) => {\n    handleFiles(event.target.files);\n    event.target.value = ''; // Reset input\n  };\n\n  const handleDrop = (event: React.DragEvent) => {\n    event.preventDefault();\n    setIsDragging(false);\n    handleFiles(event.dataTransfer.files);\n  };\n\n  const handleDragOver = (event: React.DragEvent) => {\n    event.preventDefault();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (event: React.DragEvent) => {\n    event.preventDefault();\n    setIsDragging(false);\n  };\n\n  const removeImage = (index: number) => {\n    const newImages = [...images];\n    newImages.splice(index, 1);\n    onChange(newImages);\n  };\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Upload Area */}\n      <div\n        className={cn(\n          \"border-2 border-dashed rounded-lg p-6 text-center transition-colors\",\n          isDragging ? \"border-primary bg-primary/10\" : \"border-gray-300 dark:border-gray-600\",\n          images.length >= maxImages ? \"opacity-50 cursor-not-allowed\" : \"cursor-pointer hover:border-primary\"\n        )}\n        onDrop={handleDrop}\n        onDragOver={handleDragOver}\n        onDragLeave={handleDragLeave}\n        onClick={() => {\n          if (images.length < maxImages) {\n            fileInputRef.current?.click();\n          }\n        }}\n        data-testid=\"image-upload-drop-zone\"\n      >\n        <input\n          ref={fileInputRef}\n          id={inputId}\n          type=\"file\"\n          accept=\"image/*\"\n          multiple\n          className=\"hidden\"\n          onChange={handleFileInput}\n          disabled={images.length >= maxImages}\n          data-testid=\"input-image-upload\"\n        />\n        \n        <div className=\"space-y-2\">\n          <Upload className=\"h-8 w-8 mx-auto text-gray-400\" />\n          <div>\n            <p className=\"text-sm font-medium\">\n              {images.length >= maxImages \n                ? `Maximum ${maxImages} afbeeldingen bereikt`\n                : \"Klik om afbeeldingen te uploaden\"\n              }\n            </p>\n            <p className=\"text-xs text-gray-500 mt-1\">\n              Sleep en laat los, of klik om bestanden te selecteren\n            </p>\n            <p className=\"text-xs text-gray-400 mt-1\">\n              PNG, JPG, GIF tot {maxSizeMB}MB\n            </p>\n          </div>\n        </div>\n      </div>\n\n      {/* Image Previews */}\n      {images.length > 0 && (\n        <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4\">\n          {images.map((image, index) => (\n            <Card key={index} className=\"relative group overflow-hidden\">\n              <CardContent className=\"p-2\">\n                <div className=\"aspect-square relative\">\n                  <img\n                    src={image}\n                    alt={`Upload ${index + 1}`}\n                    className=\"w-full h-full object-cover rounded\"\n                    data-testid={`image-preview-${index}`}\n                  />\n                  <Button\n                    variant=\"destructive\"\n                    size=\"sm\"\n                    className=\"absolute top-1 right-1 h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      removeImage(index);\n                    }}\n                    data-testid={`button-remove-image-${index}`}\n                  >\n                    <X className=\"h-3 w-3\" />\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n\n      {images.length > 0 && (\n        <div className=\"flex items-center gap-2 text-sm text-gray-500\">\n          <ImageIcon className=\"h-4 w-4\" />\n          <span>{images.length} van {maxImages} afbeeldingen</span>\n        </div>\n      )}\n    </div>\n  );\n}","size_bytes":6129},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/40 dark:bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border p-6 duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        \"bg-white border-border shadow-[0_8px_32px_rgba(0,0,0,0.08)]\",\n        \"dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4582},"client/src/components/search/command-palette.tsx":{"content":"import { useState } from \"react\";\nimport {\n  CommandDialog,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { \n  Home, \n  Inbox, \n  ShoppingCart, \n  Wrench, \n  CheckSquare, \n  BarChart3,\n  Plus,\n  Search,\n  Mail\n} from \"lucide-react\";\nimport { useLocation } from \"wouter\";\n\ninterface CommandPaletteProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\nexport function CommandPalette({ open, onOpenChange }: CommandPaletteProps) {\n  const [, setLocation] = useLocation();\n\n  const handleCommand = (command: string) => {\n    switch (command) {\n      case \"home\":\n        setLocation(\"/\");\n        break;\n      case \"inbox\":\n        setLocation(\"/inbox\");\n        break;\n      case \"orders\":\n        setLocation(\"/orders\");\n        break;\n      case \"repairs\":\n        setLocation(\"/repairs\");\n        break;\n      case \"todos\":\n        setLocation(\"/todos\");\n        break;\n      case \"dashboard\":\n        setLocation(\"/dashboard\");\n        break;\n      case \"new-todo\":\n        // Open new todo dialog\n        break;\n      case \"new-repair\":\n        // Open new repair dialog\n        break;\n      case \"search-orders\":\n        setLocation(\"/orders\");\n        break;\n      case \"compose-email\":\n        // Open email composer\n        break;\n    }\n    onOpenChange(false);\n  };\n\n  return (\n    <CommandDialog open={open} onOpenChange={onOpenChange}>\n      <CommandInput placeholder=\"Type a command or search...\" data-testid=\"command-palette-input\" />\n      <CommandList>\n        <CommandEmpty>No results found.</CommandEmpty>\n        \n        <CommandGroup heading=\"Navigation\">\n          <CommandItem onSelect={() => handleCommand(\"home\")} data-testid=\"command-home\">\n            <Home className=\"mr-2 h-4 w-4\" />\n            <span>Go to Home</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"inbox\")} data-testid=\"command-inbox\">\n            <Inbox className=\"mr-2 h-4 w-4\" />\n            <span>Go to Inbox</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"orders\")} data-testid=\"command-orders\">\n            <ShoppingCart className=\"mr-2 h-4 w-4\" />\n            <span>Go to Orders</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"repairs\")} data-testid=\"command-repairs\">\n            <Wrench className=\"mr-2 h-4 w-4\" />\n            <span>Go to Repairs</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"todos\")} data-testid=\"command-todos\">\n            <CheckSquare className=\"mr-2 h-4 w-4\" />\n            <span>Go to To-do's</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"dashboard\")} data-testid=\"command-dashboard\">\n            <BarChart3 className=\"mr-2 h-4 w-4\" />\n            <span>Go to Dashboard</span>\n          </CommandItem>\n        </CommandGroup>\n\n        <CommandGroup heading=\"Quick Actions\">\n          <CommandItem onSelect={() => handleCommand(\"new-todo\")} data-testid=\"command-new-todo\">\n            <Plus className=\"mr-2 h-4 w-4\" />\n            <span>Create New To-do</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"new-repair\")} data-testid=\"command-new-repair\">\n            <Plus className=\"mr-2 h-4 w-4\" />\n            <span>Start New Repair</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"search-orders\")} data-testid=\"command-search-orders\">\n            <Search className=\"mr-2 h-4 w-4\" />\n            <span>Search Orders</span>\n          </CommandItem>\n          <CommandItem onSelect={() => handleCommand(\"compose-email\")} data-testid=\"command-compose-email\">\n            <Mail className=\"mr-2 h-4 w-4\" />\n            <span>Compose Email</span>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </CommandDialog>\n  );\n}\n","size_bytes":3914},"server/services/imapSmtpProvider.ts":{"content":"import { ImapFlow } from 'imapflow';\nimport nodemailer from 'nodemailer';\nimport * as mimeTypes from 'mime-types';\nimport type { EmailProvider, RawEmail } from './emailProvider';\nimport { ObjectStorageService } from '../objectStorage';\nimport { storage } from '../storage';\n\nexport class ImapSmtpProvider implements EmailProvider {\n  private imapConfig = {\n    host: (process.env.IMAP_HOST || '').trim(),\n    port: parseInt(process.env.IMAP_PORT || '993'),\n    secure: true,\n    auth: {\n      user: (process.env.IMAP_USER || '').trim(),\n      pass: (process.env.IMAP_PASS || '').trim()\n    }\n  };\n\n  private smtpTransporter = nodemailer.createTransport({\n    host: (process.env.SMTP_HOST || '').trim(),\n    port: parseInt(process.env.SMTP_PORT || '465'),\n    secure: true,\n    auth: {\n      user: (process.env.SMTP_USER || '').trim(),\n      pass: (process.env.SMTP_PASS || '').trim()\n    }\n  });\n\n  async syncEmails(): Promise<RawEmail[]> {\n    console.log('IMAP Config:', {\n      host: this.imapConfig.host,\n      port: this.imapConfig.port,\n      user: this.imapConfig.auth.user\n    });\n    \n    const client = new ImapFlow(this.imapConfig);\n    \n    // Add error handler to prevent crashes\n    client.on('error', (err) => {\n      console.error('IMAP client error:', err);\n    });\n    \n    try {\n      console.log('Attempting IMAP connection...');\n      await client.connect();\n      \n      // Select INBOX\n      let lock = await client.getMailboxLock('INBOX');\n      \n      try {\n        // Get total message count from selected mailbox\n        const totalMessages = client.mailbox && typeof client.mailbox === 'object' ? client.mailbox.exists : 10;\n        \n        // Calculate range for last 10 messages (faster sync)\n        const startSeq = Math.max(1, totalMessages - 9); // Get last 10 messages\n        const endSeq = totalMessages;\n        \n        console.log(`IMAP total messages: ${totalMessages}, fetching range: ${startSeq}:${endSeq}`);\n        \n        // Get recent emails (last 10)\n        const messages = [];\n        let attachmentQueue: Array<{\n          messageIndex: number;\n          uid: number;\n          seq: number;\n          partId: string;\n          filename: string;\n          contentType: string;\n          contentId?: string;\n          isInline: boolean;\n          size: number;\n        }> = [];\n        for await (let message of client.fetch(`${startSeq}:${endSeq}`, {\n          envelope: true,\n          flags: true,\n          bodyStructure: true,\n          internalDate: true,\n          uid: true\n        })) {\n          \n          // Check if message has attachments\n          const hasAttachment = this.checkForAttachments(message.bodyStructure);\n          \n          // Build conversation ID from subject and participants\n          const envelope = message.envelope;\n          const conversationId = envelope ? this.buildConversationId(\n            envelope.subject || '',\n            envelope.from?.[0]?.address || '',\n            envelope.to?.[0]?.address || ''\n          ) : `${message.uid}@${this.imapConfig.host}`;\n\n          // Extract actual email body content by walking bodyStructure\n          let bodyText = '';\n          let isHtml = false;\n          \n          try {\n            // Find text parts in the body structure\n            const textParts = this.findTextParts(message.bodyStructure);\n            console.log(`Found ${textParts.length} text parts for UID ${message.uid}`);\n            \n            // Prefer HTML, fallback to plain text\n            let htmlPart = textParts.find(p => p.type === 'text/html');\n            let plainPart = textParts.find(p => p.type === 'text/plain');\n            \n            const partToUse = htmlPart || plainPart;\n            \n            if (partToUse) {\n              console.log(`Downloading ${partToUse.type} part ${partToUse.partId} for UID ${message.uid}`);\n              \n              // Add timeout to prevent hanging on large emails\n              const downloadWithTimeout = async () => {\n                const timeoutMs = 10000; // 10 second timeout\n                const timeoutPromise = new Promise<never>((_, reject) => {\n                  setTimeout(() => reject(new Error(`Download timeout after ${timeoutMs}ms`)), timeoutMs);\n                });\n                \n                const downloadPromise = async () => {\n                  const { content: stream } = await client.download(message.uid, partToUse.partId);\n                  const chunks: Buffer[] = [];\n                  for await (const chunk of stream) {\n                    chunks.push(chunk);\n                  }\n                  return Buffer.concat(chunks);\n                };\n                \n                return Promise.race([downloadPromise(), timeoutPromise]);\n              };\n              \n              const contentBuffer = await downloadWithTimeout();\n              \n              // Decode based on encoding\n              bodyText = this.decodeContent(contentBuffer, partToUse.encoding);\n              isHtml = partToUse.type === 'text/html';\n              \n              console.log(`Successfully extracted body (${partToUse.type}), length: ${bodyText.length}`);\n            }\n          } catch (error) {\n            console.error('Error extracting body from message:', error);\n          }\n          \n          // Final fallback if no body extracted\n          if (!bodyText || bodyText.trim().length === 0) {\n            const subject = envelope?.subject || 'No subject';\n            const fromAddr = envelope?.from?.[0]?.address || 'unknown';\n            bodyText = `[Content not available] Message from ${fromAddr} with subject: \"${subject}\"`;\n            console.log('Using fallback placeholder for message:', message.uid);\n          }\n          \n          const rawEmail: RawEmail = {\n            messageId: envelope?.messageId || `${message.uid}@${this.imapConfig.host}`,\n            conversationId,\n            subject: envelope?.subject || '',\n            from: envelope?.from?.[0]?.address || '',\n            to: envelope?.to?.[0]?.address || '',\n            body: bodyText,\n            isHtml: isHtml,\n            receivedDateTime: message.internalDate instanceof Date ? message.internalDate.toISOString() : new Date().toISOString(),\n            isRead: message.flags?.has('\\\\Seen') || false,\n            hasAttachment,\n            inReplyTo: envelope?.inReplyTo,\n            references: ''\n          };\n\n          // Collect attachment descriptors if email has them (don't download yet to avoid IMAP deadlock)\n          const attachmentDescriptors: Array<{\n            messageIndex: number;\n            uid: number;\n            seq: number;\n            partId: string;\n            filename: string;\n            contentType: string;\n            contentId?: string;\n            isInline: boolean;\n            size: number;\n          }> = [];\n\n          if (hasAttachment) {\n            console.log(`üìé Collecting attachment descriptors for Message UID ${message.uid}, Seq ${message.seq}, Subject: ${envelope?.subject || 'No subject'}`);\n            const descriptors = this.collectAttachmentDescriptors(message, messages.length, message.seq);\n            attachmentDescriptors.push(...descriptors);\n            console.log(`üìé Found ${descriptors.length} attachment descriptors`);\n          }\n\n          // Store descriptors for later processing (after fetch loop completes)\n          if (!attachmentQueue) {\n            attachmentQueue = [];\n          }\n          attachmentQueue.push(...attachmentDescriptors);\n\n          // Initialize extractedAttachments as empty for now\n          (rawEmail as any).extractedAttachments = [];\n\n          messages.push(rawEmail);\n        }\n        \n        // Phase 2: Download attachments after fetch loop completes (avoids IMAP deadlock)\n        console.log(`üìé Processing ${attachmentQueue.length} attachments in phase 2`);\n        if (attachmentQueue.length > 0) {\n          const { ObjectStorageService } = await import('../objectStorage.js');\n          const objectStorageService = new ObjectStorageService();\n          \n          let processedCount = 0;\n          for (const descriptor of attachmentQueue) {\n            processedCount++;\n            console.log(`üìé Processing attachment ${processedCount}/${attachmentQueue.length}: ${descriptor.filename}`);\n            \n            try {\n              // Skip attachments over 10MB to prevent memory issues\n              if (descriptor.size > 10 * 1024 * 1024) {\n                console.log(`‚ö†Ô∏è Skipping large attachment ${descriptor.filename} (${descriptor.size} bytes)`);\n                continue;\n              }\n              \n              let attachmentBuffer: Buffer | undefined;\n              \n              // Helper function to add timeout to fetchOne operations\n              const fetchWithTimeout = async (fetchPromise: Promise<any>, timeoutMs: number = 15000) => {\n                const timeoutPromise = new Promise((_, reject) => {\n                  setTimeout(() => reject(new Error(`Fetch timeout after ${timeoutMs}ms`)), timeoutMs);\n                });\n                return Promise.race([fetchPromise, timeoutPromise]);\n              };\n              \n              // Try sequence number first (more reliable within same session)\n              try {\n                console.log(`üì• Attempting sequence fetch: ${descriptor.filename} (Seq ${descriptor.seq}, part ${descriptor.partId})`);\n                const result = await fetchWithTimeout(\n                  client.fetchOne(descriptor.seq, {\n                    uid: false, // Use sequence number\n                    bodyParts: [descriptor.partId]\n                  })\n                );\n                \n                if (result && result.bodyParts) {\n                  attachmentBuffer = result.bodyParts.get(descriptor.partId) as Buffer;\n                  if (attachmentBuffer && attachmentBuffer.length > 0) {\n                    console.log(`‚úÖ Downloaded via sequence: ${descriptor.filename} (${attachmentBuffer.length} bytes)`);\n                  }\n                }\n              } catch (seqError: any) {\n                console.log(`‚ö†Ô∏è Sequence fetch failed for ${descriptor.filename}: ${seqError.message || seqError}`);\n              }\n              \n              // Fallback to UID if sequence fetch failed or returned no data\n              if (!attachmentBuffer || attachmentBuffer.length === 0) {\n                try {\n                  console.log(`üîÑ Attempting UID fetch: ${descriptor.filename} (UID ${descriptor.uid}, part ${descriptor.partId})`);\n                  const result = await fetchWithTimeout(\n                    client.fetchOne(descriptor.uid, {\n                      uid: true, // Use UID\n                      bodyParts: [descriptor.partId]\n                    })\n                  );\n                  \n                  if (result && result.bodyParts) {\n                    attachmentBuffer = result.bodyParts.get(descriptor.partId) as Buffer;\n                    if (attachmentBuffer && attachmentBuffer.length > 0) {\n                      console.log(`‚úÖ Downloaded via UID: ${descriptor.filename} (${attachmentBuffer.length} bytes)`);\n                    }\n                  }\n                } catch (uidError: any) {\n                  console.log(`‚ùå UID fetch also failed for ${descriptor.filename}: ${uidError.message || uidError}`);\n                }\n              }\n              \n              if (attachmentBuffer && attachmentBuffer.length > 0) {\n                try {\n                  console.log(`üíæ Saving attachment to object storage: ${descriptor.filename}`);\n                  // Save to object storage with timeout\n                  const storagePromise = objectStorageService.saveAttachment(\n                    descriptor.filename,\n                    attachmentBuffer,\n                    descriptor.contentType\n                  );\n                  const storageUrl = await fetchWithTimeout(storagePromise, 20000); // 20 second timeout for storage\n                  \n                  // Add to the corresponding message's extractedAttachments\n                  if (messages[descriptor.messageIndex]) {\n                    const extractedAttachments = (messages[descriptor.messageIndex] as any).extractedAttachments || [];\n                    extractedAttachments.push(storageUrl);\n                    (messages[descriptor.messageIndex] as any).extractedAttachments = extractedAttachments;\n                    \n                    console.log(`üìé Added attachment to message[${descriptor.messageIndex}]: ${storageUrl}`);\n                    console.log(`üìé Message[${descriptor.messageIndex}] now has ${extractedAttachments.length} attachments total`);\n                  } else {\n                    console.error(`‚ùå Could not find message at index ${descriptor.messageIndex} (total messages: ${messages.length})`);\n                  }\n                  \n                  console.log(`‚úÖ Saved attachment: ${descriptor.filename} to ${storageUrl}`);\n                } catch (storageError: any) {\n                  console.error(`‚ùå Failed to save attachment ${descriptor.filename} to storage: ${storageError.message || storageError}`);\n                }\n              } else {\n                console.log(`‚ö†Ô∏è No attachment data could be downloaded for ${descriptor.filename}`);\n              }\n              \n            } catch (attachmentError: any) {\n              console.error(`‚ùå Error processing attachment ${descriptor.filename}:`, attachmentError.message || attachmentError);\n              // Continue to next attachment even if this one fails\n            }\n            \n            // Add a small delay to prevent overwhelming the IMAP server\n            if (processedCount % 5 === 0) {\n              console.log(`üìä Progress: ${processedCount}/${attachmentQueue.length} attachments processed`);\n              await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay every 5 attachments\n            }\n          }\n          \n          console.log(`‚úÖ Attachment processing completed: ${processedCount}/${attachmentQueue.length} attachments processed`);\n        }\n        \n        return messages; // Already in chronological order (oldest to newest)\n        \n      } finally {\n        lock.release();\n      }\n      \n    } finally {\n      await client.logout();\n    }\n  }\n\n  async sendEmail(to: string, subject: string, body: string, replyToMessageId?: string): Promise<{ success: boolean }> {\n    try {\n      const mailOptions: any = {\n        from: process.env.SMTP_USER,\n        to,\n        subject,\n        html: body,\n        text: body.replace(/<[^>]*>/g, '') // Strip HTML for text version\n      };\n\n      // Add reply headers if this is a reply\n      if (replyToMessageId) {\n        mailOptions.inReplyTo = replyToMessageId;\n        mailOptions.references = replyToMessageId;\n      }\n\n      await this.smtpTransporter.sendMail(mailOptions);\n      return { success: true };\n      \n    } catch (error) {\n      console.error('SMTP send error:', error);\n      throw error;\n    }\n  }\n\n  private checkForAttachments(bodyStructure: any): boolean {\n    if (!bodyStructure) return false;\n    \n    // Function to recursively check for attachments\n    const hasAttachmentRecursive = (structure: any): boolean => {\n      if (!structure) return false;\n      \n      // Check if this part itself is an attachment\n      if (structure.disposition === 'attachment') {\n        return true;\n      }\n      \n      // Check for images or files with names (inline attachments)\n      if (structure.type && structure.type !== 'text' && structure.parameters?.name) {\n        return true;\n      }\n      \n      // Check if this is an image type (common inline attachments)\n      if (structure.type === 'image') {\n        return true;\n      }\n      \n      // Recursively check child nodes for multipart messages\n      if (structure.childNodes && Array.isArray(structure.childNodes)) {\n        return structure.childNodes.some((child: any) => hasAttachmentRecursive(child));\n      }\n      \n      return false;\n    };\n    \n    return hasAttachmentRecursive(bodyStructure);\n  }\n\n  // Helper function to detect content type from filename using mime-types library\n  private detectContentTypeFromFilename(filename: string): string {\n    // Use mime-types library for comprehensive MIME type detection\n    const detectedType = mimeTypes.lookup(filename);\n    \n    if (detectedType) {\n      console.log(`üîç Detected MIME type for ${filename}: ${detectedType}`);\n      return detectedType;\n    }\n    \n    // Fallback to manual detection for any edge cases\n    const ext = filename.toLowerCase().split('.').pop();\n    switch (ext) {\n      case 'jpg':\n      case 'jpeg':\n        return 'image/jpeg';\n      case 'png':\n        return 'image/png';\n      case 'gif':\n        return 'image/gif';\n      case 'webp':\n        return 'image/webp';\n      case 'pdf':\n        return 'application/pdf';\n      case 'doc':\n        return 'application/msword';\n      case 'docx':\n        return 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';\n      case 'xls':\n        return 'application/vnd.ms-excel';\n      case 'xlsx':\n        return 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';\n      case 'txt':\n        return 'text/plain';\n      default:\n        console.log(`‚ö†Ô∏è Could not detect MIME type for ${filename}, using application/octet-stream`);\n        return 'application/octet-stream';\n    }\n  }\n\n  // Find text parts (text/plain or text/html) in body structure\n  private findTextParts(bodyStructure: any): Array<{ partId: string; type: string; encoding: string }> {\n    const textParts: Array<{ partId: string; type: string; encoding: string }> = [];\n    \n    const walkParts = (part: any) => {\n      if (!part) return;\n      \n      // Check if this is a text part\n      if (part.type === 'text/plain' || part.type === 'text/html') {\n        const partId = part.part || '1';\n        const encoding = part.encoding?.toLowerCase() || 'utf-8';\n        textParts.push({ partId, type: part.type, encoding });\n      }\n      \n      // Recursively process child nodes\n      if (part.childNodes && Array.isArray(part.childNodes)) {\n        for (const childPart of part.childNodes) {\n          walkParts(childPart);\n        }\n      }\n    };\n    \n    // Start walking from root\n    if (bodyStructure.childNodes) {\n      for (const childPart of bodyStructure.childNodes) {\n        walkParts(childPart);\n      }\n    } else {\n      walkParts(bodyStructure);\n    }\n    \n    return textParts;\n  }\n\n  // Decode content based on encoding\n  private decodeContent(content: Buffer, encoding: string): string {\n    try {\n      let textContent = content.toString('utf-8');\n      \n      // Strip MIME headers if present (headers end with double newline)\n      const headerEndIndex = textContent.indexOf('\\r\\n\\r\\n');\n      if (headerEndIndex > -1 && headerEndIndex < 500) { // Headers should be in first 500 chars\n        textContent = textContent.substring(headerEndIndex + 4);\n      } else {\n        const altHeaderEndIndex = textContent.indexOf('\\n\\n');\n        if (altHeaderEndIndex > -1 && altHeaderEndIndex < 500) {\n          textContent = textContent.substring(altHeaderEndIndex + 2);\n        }\n      }\n      \n      const encodingLower = encoding.toLowerCase();\n      \n      if (encodingLower === 'base64') {\n        // Remove whitespace and decode\n        const cleanBase64 = textContent.replace(/\\s/g, '');\n        return Buffer.from(cleanBase64, 'base64').toString('utf-8');\n      } else if (encodingLower === 'quoted-printable') {\n        // Decode quoted-printable\n        let decoded = textContent;\n        decoded = decoded.replace(/=\\r?\\n/g, ''); // Remove soft line breaks\n        decoded = decoded.replace(/=([0-9A-F]{2})/gi, (_, hex) => \n          String.fromCharCode(parseInt(hex, 16))\n        );\n        return decoded;\n      } else {\n        // 7bit, 8bit, or binary - already converted to string\n        return textContent;\n      }\n    } catch (error) {\n      console.error('Error decoding content:', error);\n      return content.toString('utf-8');\n    }\n  }\n\n  // Collect attachment descriptors without downloading (avoids IMAP deadlock)\n  private collectAttachmentDescriptors(message: any, messageIndex: number, sequenceNumber: number): Array<{\n    messageIndex: number;\n    uid: number;\n    seq: number;\n    partId: string;\n    filename: string;\n    contentType: string;\n    contentId?: string;\n    isInline: boolean;\n    size: number;\n  }> {\n    const descriptors: Array<{\n      messageIndex: number;\n      uid: number;\n      seq: number;\n      partId: string;\n      filename: string;\n      contentType: string;\n      contentId?: string;\n      isInline: boolean;\n      size: number;\n    }> = [];\n    \n    if (!message.bodyStructure) {\n      return descriptors;\n    }\n    \n    const collectFromPart = (part: any) => {\n      if (!part) return;\n      \n      // Check if this part is an attachment - use broader criteria\n      const isAttachment = part.disposition === 'attachment' || \n                          part.disposition === 'inline' ||\n                          (part.type && part.type.startsWith('image/')) ||\n                          (part.type && !part.type.startsWith('text/'));\n      \n      // Use broader filename detection\n      const hasFilename = part.parameters?.name || part.dispositionParameters?.filename;\n      \n      if (isAttachment && hasFilename) {\n        const partId = part.part || '1';\n        const filename = part.parameters?.name || part.dispositionParameters?.filename || `part-${partId}`;\n        \n        // Use proper content type detection\n        const rawContentType = part.type || 'application/octet-stream';\n        const contentType = rawContentType === 'application/octet-stream' \n          ? this.detectContentTypeFromFilename(filename) \n          : rawContentType;\n        \n        const contentId = part.id;\n        const isInline = part.disposition === 'inline';\n        const size = part.size || 0;\n        \n        console.log(`üìé Found attachment descriptor: ${filename} (part ${partId}, ${contentType}, ${size} bytes)`);\n        \n        descriptors.push({\n          messageIndex,\n          uid: message.uid,\n          seq: sequenceNumber,\n          partId,\n          filename,\n          contentType,\n          contentId,\n          isInline,\n          size\n        });\n      }\n      \n      // Recursively process child nodes\n      if (part.childNodes && Array.isArray(part.childNodes)) {\n        for (const childPart of part.childNodes) {\n          collectFromPart(childPart);\n        }\n      }\n    };\n    \n    // Start processing from the root\n    const bodyStructure = message.bodyStructure;\n    if (bodyStructure.childNodes) {\n      for (const childPart of bodyStructure.childNodes) {\n        collectFromPart(childPart);\n      }\n    } else {\n      // Single part message\n      collectFromPart(bodyStructure);\n    }\n    \n    return descriptors;\n  }\n\n  // Extract attachments from email message\n  private async extractAttachments(client: any, message: any): Promise<Array<{ filename: string; data: Buffer; contentType?: string; contentId?: string; isInline: boolean }>> {\n    console.log(`üîç Starting attachment extraction for UID ${message.uid}`);\n    const attachments: Array<{ filename: string; data: Buffer; contentType?: string; contentId?: string; isInline: boolean }> = [];\n    \n    if (!message.bodyStructure) {\n      console.log(`‚ùå No bodyStructure found for UID ${message.uid}`);\n      return attachments;\n    }\n    \n    console.log(`üîç bodyStructure found, processing...`);\n    console.log(`üîç bodyStructure has ${message.bodyStructure.childNodes?.length || 0} child nodes`);\n    \n    try {\n      // Get the body structure to find attachments\n      const bodyStructure = message.bodyStructure;\n      \n      // Recursive function to find all attachments in nested structures\n      const processBodyPart = async (part: any) => {\n        if (!part) return;\n        \n        const partId = part.part || '1';\n        console.log(`Processing part ${partId}: type=${part.type}, disposition=${part.disposition}, name=${part.parameters?.name}, dispFilename=${part.dispositionParameters?.filename}`);\n        \n        // Check if this part is an attachment - use broader criteria\n        const isAttachment = part.disposition === 'attachment' || \n                            part.disposition === 'inline' ||\n                            (part.type && part.type.startsWith('image/')) ||\n                            (part.type && !part.type.startsWith('text/'));\n        \n        // Use broader filename detection\n        const hasFilename = part.parameters?.name || part.dispositionParameters?.filename;\n        \n        if (isAttachment && hasFilename) {\n          try {\n            console.log(`Downloading attachment part ${partId}...`);\n            \n            // Add timeout protection for IMAP downloads\n            const downloadPromise = client.download(`${message.uid}`, partId, {\n              uid: true\n            });\n            \n            const timeoutPromise = new Promise((_, reject) => {\n              setTimeout(() => reject(new Error(`Download timeout for part ${partId}`)), 30000); // 30 second timeout\n            });\n            \n            // Race between download and timeout\n            const attachmentData = await Promise.race([downloadPromise, timeoutPromise]);\n            \n            if (attachmentData && attachmentData.length > 0) {\n              const filename = part.parameters?.name || part.dispositionParameters?.filename || `part-${partId}`;\n              \n              // Use proper content type detection\n              const rawContentType = part.type || 'application/octet-stream';\n              const contentType = rawContentType === 'application/octet-stream' \n                ? this.detectContentTypeFromFilename(filename) \n                : rawContentType;\n              \n              const contentId = part.id;\n              const isInline = part.disposition === 'inline';\n              \n              attachments.push({\n                filename,\n                data: attachmentData,\n                contentType,\n                contentId,\n                isInline\n              });\n              \n              console.log(`‚úÖ Extracted attachment: ${filename} (${contentType}, ${attachmentData.length} bytes)`);\n            } else {\n              console.log(`‚ö†Ô∏è No data received for attachment part ${partId}`);\n            }\n          } catch (downloadError: any) {\n            console.error(`‚ùå Error downloading attachment part ${partId}:`, downloadError.message || downloadError);\n            // Continue processing other parts even if one fails\n          }\n        }\n        \n        // Recursively process child nodes\n        if (part.childNodes && Array.isArray(part.childNodes)) {\n          for (const childPart of part.childNodes) {\n            await processBodyPart(childPart);\n          }\n        }\n      };\n      \n      // Start processing from the root\n      if (bodyStructure.childNodes) {\n        for (const childPart of bodyStructure.childNodes) {\n          await processBodyPart(childPart);\n        }\n      } else {\n        // Single part message\n        await processBodyPart(bodyStructure);\n      }\n      \n    } catch (error) {\n      console.error('Error extracting attachments:', error);\n    }\n    \n    return attachments;\n  }\n\n  private buildConversationId(subject: string, from: string, to: string): string {\n    // Remove common reply prefixes and normalize\n    const cleanSubject = subject\n      .replace(/^(re:|fwd?:|fw:)\\s*/i, '')\n      .trim()\n      .toLowerCase();\n    \n    // Create consistent conversation ID\n    const participants = [from, to].sort().join('|');\n    return `${cleanSubject}|${participants}`.replace(/\\s+/g, '_');\n  }\n}","size_bytes":27900},"client/src/pages/purchase-orders.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  Search, \n  Plus,\n  Filter, \n  Download, \n  Package2,\n  Building2,\n  Euro,\n  TrendingUp,\n  ShoppingCart,\n  Clock,\n  CheckCircle,\n  Truck,\n  List,\n  LayoutGrid,\n  X,\n  Archive\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { PurchaseOrder, Supplier } from \"@shared/schema\";\nimport { PurchaseOrderForm } from \"@/components/purchase-orders/purchase-order-form\";\nimport { PurchaseOrderDetailModal } from \"@/components/purchase-orders/purchase-order-detail-modal\";\nimport { PurchaseOrdersTable } from \"@/components/purchase-orders/purchase-orders-table\";\nimport { PurchaseOrdersCards } from \"@/components/purchase-orders/purchase-orders-cards\";\nimport { SupplierImportDialog } from \"@/components/purchase-orders/supplier-import-dialog\";\nimport { useAuth } from \"@/lib/auth\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\n\nexport default function PurchaseOrders() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"all\");\n  const [supplierFilter, setSupplierFilter] = useState(\"\");\n  const [viewMode, setViewMode] = useState<\"table\" | \"cards\">(\"table\");\n  const [showNewPO, setShowNewPO] = useState(false);\n  const [selectedPO, setSelectedPO] = useState<PurchaseOrder | null>(null);\n  const [showDetailModal, setShowDetailModal] = useState(false);\n  const [showArchived, setShowArchived] = useState(false);\n  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false);\n  const [poToDelete, setPoToDelete] = useState<string | null>(null);\n  const searchInputRef = useRef<HTMLInputElement>(null);\n  const { user } = useAuth();\n  const { toast } = useToast();\n\n  const canCreate = user?.role === \"ADMIN\" || user?.role === \"SUPPORT\";\n\n  const { data: purchaseOrders, isLoading: isLoadingPOs } = useQuery<PurchaseOrder[]>({\n    queryKey: [\"/api/purchase-orders\"],\n  });\n\n  const { data: suppliers, isLoading: isLoadingSuppliers } = useQuery<Supplier[]>({\n    queryKey: [\"/api/suppliers\"],\n  });\n\n  const filteredPOs = purchaseOrders?.filter(po => {\n    // Filter by archived status\n    if (showArchived && !po.archived) return false;\n    if (!showArchived && po.archived) return false;\n    \n    // Filter by status\n    if (statusFilter !== \"all\" && po.status !== statusFilter) {\n      return false;\n    }\n    if (supplierFilter) {\n      const supplier = suppliers?.find(s => s.id === po.supplierId);\n      const supplierName = supplier?.name?.toLowerCase() || \"\";\n      const supplierCode = supplier?.supplierCode?.toLowerCase() || \"\";\n      const query = supplierFilter.toLowerCase();\n      if (!supplierName.includes(query) && !supplierCode.includes(query)) return false;\n    }\n    if (searchQuery) {\n      const query = searchQuery.toLowerCase();\n      return (\n        po.title?.toLowerCase().includes(query) ||\n        po.poNumber?.toLowerCase().includes(query) ||\n        suppliers?.find(s => s.id === po.supplierId)?.name?.toLowerCase().includes(query)\n      );\n    }\n    return true;\n  }) || [];\n\n  // Analytics calculations (exclude archived orders)\n  const activePOs = purchaseOrders?.filter(po => !po.archived) || [];\n  \n  const statusCounts = {\n    all: activePOs.length,\n    aangekocht: activePOs.filter(po => po.status === 'aangekocht').length,\n    ontvangen: activePOs.filter(po => po.status === 'ontvangen').length,\n    verwerkt: activePOs.filter(po => po.status === 'verwerkt').length,\n  };\n\n  const totalAmount = activePOs.reduce((sum, po) => sum + ((po.totalAmount || 0) / 100), 0);\n  \n  const pendingDeliveries = activePOs.filter(po => \n    po.status === 'aangekocht' && po.expectedDeliveryDate\n  ).length;\n\n  const overdueDeliveries = activePOs.filter(po => {\n    if (po.status !== 'aangekocht' || !po.expectedDeliveryDate) return false;\n    return new Date(po.expectedDeliveryDate) < new Date();\n  }).length;\n\n  // Top supplier by spending (exclude archived orders)\n  const supplierSpending = activePOs.reduce((acc, po) => {\n    if (po.supplierId) {\n      acc[po.supplierId] = (acc[po.supplierId] || 0) + ((po.totalAmount || 0) / 100);\n    }\n    return acc;\n  }, {} as Record<string, number>);\n\n  const topSupplier = Object.entries(supplierSpending).sort((a, b) => b[1] - a[1])[0];\n  const topSupplierName = topSupplier \n    ? suppliers?.find(s => s.id === topSupplier[0])?.name || 'Onbekend'\n    : 'Geen';\n  const topSupplierAmount = topSupplier ? topSupplier[1] : 0;\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"aangekocht\": return \"default\";\n      case \"ontvangen\": return \"default\";\n      case \"verwerkt\": return \"secondary\";\n      default: return \"secondary\";\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"aangekocht\": return \"text-blue-600 bg-blue-100 dark:bg-blue-900\";\n      case \"ontvangen\": return \"text-green-600 bg-green-100 dark:bg-green-900\";\n      case \"verwerkt\": return \"text-gray-600 bg-gray-100 dark:bg-gray-800\";\n      default: return \"text-gray-600 bg-gray-100\";\n    }\n  };\n\n  const handlePOClick = (po: PurchaseOrder) => {\n    setSelectedPO(po);\n    setShowDetailModal(true);\n  };\n\n  // Archive mutation\n  const archiveMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"PATCH\", `/api/purchase-orders/${id}`, { archived: true });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      toast({\n        title: \"Gearchiveerd\",\n        description: \"Inkoop order is gearchiveerd\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Fout\",\n        description: \"Kon order niet archiveren\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Unarchive mutation\n  const unarchiveMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"PATCH\", `/api/purchase-orders/${id}`, { archived: false });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      toast({\n        title: \"Hersteld\",\n        description: \"Inkoop order is hersteld uit archief\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Fout\",\n        description: \"Kon order niet herstellen\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/purchase-orders/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      toast({\n        title: \"Verwijderd\",\n        description: \"Inkoop order is verwijderd\",\n      });\n      if (selectedPO?.id === deleteMutation.variables) {\n        setShowDetailModal(false);\n        setSelectedPO(null);\n      }\n    },\n    onError: () => {\n      toast({\n        title: \"Fout\",\n        description: \"Kon order niet verwijderen\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handlePOOpen = (id: string) => {\n    const po = purchaseOrders?.find(p => p.id === id);\n    if (po) {\n      handlePOClick(po);\n    }\n  };\n\n  const handlePOArchive = (id: string) => {\n    archiveMutation.mutate(id);\n  };\n\n  const handlePOUnarchive = (id: string) => {\n    unarchiveMutation.mutate(id);\n  };\n\n  const handlePODelete = (id: string) => {\n    setPoToDelete(id);\n    setDeleteConfirmOpen(true);\n  };\n\n  const confirmDelete = () => {\n    if (poToDelete) {\n      deleteMutation.mutate(poToDelete);\n      setDeleteConfirmOpen(false);\n      setPoToDelete(null);\n    }\n  };\n\n  // Status change mutation\n  const statusChangeMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: string; status: string }) => {\n      return apiRequest(\"PATCH\", `/api/purchase-orders/${id}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      toast({\n        title: \"Status bijgewerkt\",\n        description: \"Inkoop order status is gewijzigd\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Fout\",\n        description: \"Kon status niet wijzigen\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handlePOStatusChange = (id: string, newStatus: string) => {\n    statusChangeMutation.mutate({ id, status: newStatus });\n  };\n\n  const isLoading = isLoadingPOs || isLoadingSuppliers;\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        {/* Header */}\n        <div className=\"bg-card rounded-lg p-6 mb-6 border\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n            <div>\n              <h1 className=\"text-3xl font-bold flex items-center gap-2\" data-testid=\"text-page-title\">\n                <Package2 className=\"h-8 w-8\" />\n                Inkoop Orders\n              </h1>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Beheer inkoop orders en leveranciers\n              </p>\n            </div>\n            <div className=\"flex gap-2 flex-wrap\">\n              {canCreate && <SupplierImportDialog />}\n              {canCreate && (\n                <Button onClick={() => setShowNewPO(true)} data-testid=\"button-new-po\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Nieuwe Order\n                </Button>\n              )}\n            </div>\n          </div>\n        </div>\n\n        {/* Analytics Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                <ShoppingCart className=\"h-4 w-4 text-muted-foreground\" />\n                Totaal Orders\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"stat-total-orders\">{statusCounts.all}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {statusCounts.aangekocht} aangekocht, {statusCounts.ontvangen} ontvangen\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                <Euro className=\"h-4 w-4 text-muted-foreground\" />\n                Totale Waarde\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"stat-total-value\">\n                ‚Ç¨{totalAmount.toLocaleString('nl-NL', { minimumFractionDigits: 2 })}\n              </div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Alle orders gecombineerd\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                <Truck className=\"h-4 w-4 text-muted-foreground\" />\n                Leveringen\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\" data-testid=\"stat-pending-deliveries\">{pendingDeliveries}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {overdueDeliveries > 0 && (\n                  <span className=\"text-red-600\">{overdueDeliveries} te laat</span>\n                )}\n                {overdueDeliveries === 0 && \"Alles op schema\"}\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                Top Leverancier\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-sm font-bold truncate\" data-testid=\"stat-top-supplier\">{topSupplierName}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                ‚Ç¨{topSupplierAmount.toLocaleString('nl-NL', { minimumFractionDigits: 2 })}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Filters and View Toggle */}\n        <div className=\"flex flex-col sm:flex-row gap-3 mb-4\">\n          <div className=\"relative flex-1\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              ref={searchInputRef}\n              placeholder=\"Zoek op titel, PO nummer, leverancier...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-10\"\n              data-testid=\"input-search-po\"\n            />\n          </div>\n\n          <Select value={statusFilter} onValueChange={setStatusFilter}>\n            <SelectTrigger className=\"w-full sm:w-[180px]\" data-testid=\"select-status-filter\">\n              <SelectValue placeholder=\"Status\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">Alle statussen</SelectItem>\n              <SelectItem value=\"aangekocht\">Aangekocht</SelectItem>\n              <SelectItem value=\"ontvangen\">Ontvangen</SelectItem>\n              <SelectItem value=\"verwerkt\">Verwerkt</SelectItem>\n            </SelectContent>\n          </Select>\n\n          <div className=\"relative w-full sm:w-[200px]\">\n            <Input\n              placeholder=\"Filter leverancier...\"\n              value={supplierFilter}\n              onChange={(e) => setSupplierFilter(e.target.value)}\n              className=\"w-full\"\n              data-testid=\"input-supplier-filter\"\n            />\n            {supplierFilter && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7 p-0\"\n                onClick={() => setSupplierFilter(\"\")}\n              >\n                <X className=\"h-4 w-4\" />\n              </Button>\n            )}\n          </div>\n\n          <div className=\"flex gap-1 border rounded-md p-1\">\n            <Button\n              variant={viewMode === \"table\" ? \"secondary\" : \"ghost\"}\n              size=\"sm\"\n              onClick={() => setViewMode(\"table\")}\n              data-testid=\"button-view-table\"\n            >\n              <List className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant={viewMode === \"cards\" ? \"secondary\" : \"ghost\"}\n              size=\"sm\"\n              onClick={() => setViewMode(\"cards\")}\n              data-testid=\"button-view-cards\"\n            >\n              <LayoutGrid className=\"h-4 w-4\" />\n            </Button>\n            <Button\n              variant={showArchived ? \"secondary\" : \"ghost\"}\n              size=\"sm\"\n              onClick={() => setShowArchived(!showArchived)}\n              data-testid=\"button-toggle-archived\"\n              className=\"ml-2\"\n            >\n              <Archive className=\"h-4 w-4 mr-2\" />\n              {showArchived ? \"Toon Actief\" : \"Toon Archief\"}\n            </Button>\n          </div>\n        </div>\n\n        {/* Status Tabs */}\n        <Tabs value={statusFilter} onValueChange={setStatusFilter}>\n          <TabsList>\n            <TabsTrigger value=\"all\" data-testid=\"tab-all-pos\">\n              Alle ({statusCounts.all})\n            </TabsTrigger>\n            <TabsTrigger value=\"aangekocht\" data-testid=\"tab-aangekocht\">\n              Aangekocht ({statusCounts.aangekocht})\n            </TabsTrigger>\n            <TabsTrigger value=\"ontvangen\" data-testid=\"tab-ontvangen\">\n              Ontvangen ({statusCounts.ontvangen})\n            </TabsTrigger>\n            <TabsTrigger value=\"verwerkt\" data-testid=\"tab-verwerkt\">\n              Verwerkt ({statusCounts.verwerkt})\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value={statusFilter} className=\"mt-6\">\n            {isLoading ? (\n              <div className=\"text-center py-12\">\n                <div className=\"text-muted-foreground\">Laden...</div>\n              </div>\n            ) : filteredPOs.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <Package2 className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                <h3 className=\"text-lg font-medium\">Geen orders gevonden</h3>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {searchQuery ? \"Probeer een andere zoekopdracht\" : \"Maak je eerste inkoop order aan\"}\n                </p>\n              </div>\n            ) : viewMode === \"table\" ? (\n              <PurchaseOrdersTable\n                purchaseOrders={filteredPOs}\n                suppliers={suppliers || []}\n                onPOClick={handlePOClick}\n                getStatusColor={getStatusColor}\n                onPOOpen={handlePOOpen}\n                onPOArchive={handlePOArchive}\n                onPOUnarchive={handlePOUnarchive}\n                onPODelete={handlePODelete}\n                onPOStatusChange={handlePOStatusChange}\n              />\n            ) : (\n              <PurchaseOrdersCards\n                purchaseOrders={filteredPOs}\n                suppliers={suppliers || []}\n                onPOClick={handlePOClick}\n                getStatusColor={getStatusColor}\n                onPOOpen={handlePOOpen}\n                onPOArchive={handlePOArchive}\n                onPOUnarchive={handlePOUnarchive}\n                onPODelete={handlePODelete}\n                onPOStatusChange={handlePOStatusChange}\n              />\n            )}\n          </TabsContent>\n        </Tabs>\n      </main>\n\n      {/* Create/Edit Dialog */}\n      {showNewPO && (\n        <PurchaseOrderForm\n          open={showNewPO}\n          onClose={() => setShowNewPO(false)}\n          suppliers={suppliers || []}\n          purchaseOrders={purchaseOrders || []}\n        />\n      )}\n\n      {/* Detail Modal */}\n      {showDetailModal && selectedPO && (\n        <PurchaseOrderDetailModal\n          purchaseOrder={selectedPO}\n          open={showDetailModal}\n          onClose={() => {\n            setShowDetailModal(false);\n            setSelectedPO(null);\n          }}\n          suppliers={suppliers || []}\n          purchaseOrders={purchaseOrders || []}\n        />\n      )}\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={deleteConfirmOpen} onOpenChange={setDeleteConfirmOpen}>\n        <AlertDialogContent data-testid=\"dialog-delete-confirm\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Inkoop order verwijderen</AlertDialogTitle>\n            <AlertDialogDescription>\n              Weet je zeker dat je deze inkoop order wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Annuleren</AlertDialogCancel>\n            <AlertDialogAction \n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              Verwijderen\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":20259},"client/src/pages/dashboard.tsx":{"content":"import { Navigation } from \"@/components/layout/navigation\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  BarChart3, \n  TrendingUp, \n  Users, \n  Clock, \n  Download,\n  Filter,\n  Calendar\n} from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { DashboardStats, Activity } from \"@/lib/types\";\n\nexport default function Dashboard() {\n  const { data: stats, isLoading: statsLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  const { data: activities, isLoading: activitiesLoading } = useQuery<Activity[]>({\n    queryKey: [\"/api/activities\"],\n  });\n\n  const kpiCards = [\n    {\n      title: \"Open Threads\",\n      value: stats?.unreadEmails || 0,\n      change: \"+12%\",\n      changeType: \"increase\" as const,\n      icon: BarChart3,\n    },\n    {\n      title: \"First Response Time\", \n      value: \"2.4h\",\n      change: \"-8%\",\n      changeType: \"decrease\" as const,\n      icon: Clock,\n    },\n    {\n      title: \"Avg. Resolution\",\n      value: \"1.2 days\",\n      change: \"+5%\", \n      changeType: \"increase\" as const,\n      icon: TrendingUp,\n    },\n    {\n      title: \"SLA Hits\",\n      value: \"94%\",\n      change: \"+2%\",\n      changeType: \"increase\" as const,\n      icon: Users,\n    },\n  ];\n\n  const repairStatusData = [\n    { status: \"New\", count: 7, color: \"bg-chart-4\" },\n    { status: \"In Progress\", count: 12, color: \"bg-primary\" },\n    { status: \"Waiting\", count: 5, color: \"bg-chart-1\" },\n    { status: \"Ready\", count: 3, color: \"bg-chart-2\" },\n    { status: \"Closed\", count: 28, color: \"bg-muted-foreground\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"dashboard-page\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        <div className=\"bg-card rounded-lg p-6 mb-6 border\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\" data-testid=\"dashboard-header\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">Dashboard</h1>\n              <p className=\"text-muted-foreground\">Analytics and team performance insights</p>\n            </div>\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <Button variant=\"outline\" data-testid=\"filter-dashboard\">\n                <Filter className=\"mr-2 h-4 w-4\" />\n                Filters\n              </Button>\n              <Button variant=\"outline\" data-testid=\"date-range-picker\">\n                <Calendar className=\"mr-2 h-4 w-4\" />\n                Last 30 days\n              </Button>\n              <Button data-testid=\"export-report\">\n                <Download className=\"mr-2 h-4 w-4\" />\n                Export Report\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* KPI Cards */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6\">\n          {kpiCards.map((kpi, index) => (\n            <Card key={index} data-testid={`kpi-card-${index}`}>\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                <CardTitle className=\"text-sm font-medium\">{kpi.title}</CardTitle>\n                <kpi.icon className=\"h-4 w-4 text-muted-foreground\" />\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-2xl font-bold\">{kpi.value}</div>\n                <p className={`text-xs ${\n                  kpi.changeType === 'increase' ? 'text-chart-2' : 'text-chart-1'\n                }`}>\n                  {kpi.change} from last month\n                </p>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n\n        <div className=\"grid gap-6 lg:grid-cols-7\">\n          {/* Performance Chart */}\n          <div className=\"col-span-4\">\n            <Card data-testid=\"performance-chart\">\n              <CardHeader>\n                <CardTitle>Team Performance</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-80 flex items-center justify-center text-muted-foreground\">\n                  {/* Placeholder for chart component */}\n                  <div className=\"text-center\">\n                    <BarChart3 className=\"h-12 w-12 mx-auto mb-4\" />\n                    <p>Performance chart will be displayed here</p>\n                    <p className=\"text-sm\">Integration with chart library needed</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Repair Status Breakdown */}\n          <div className=\"col-span-3\">\n            <Card data-testid=\"repair-status-breakdown\">\n              <CardHeader>\n                <CardTitle>Repairs by Status</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {repairStatusData.map((item, index) => (\n                    <div key={index} className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center space-x-2\">\n                        <div className={`h-3 w-3 rounded-full ${item.color}`}></div>\n                        <span className=\"text-sm font-medium\">{item.status}</span>\n                      </div>\n                      <span className=\"text-sm font-bold\">{item.count}</span>\n                    </div>\n                  ))}\n                </div>\n\n                <div className=\"mt-6 pt-4 border-t\">\n                  <div className=\"flex justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">Total Active</span>\n                    <span className=\"font-medium\">\n                      {repairStatusData.slice(0, -1).reduce((sum, item) => sum + item.count, 0)}\n                    </span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n\n        {/* Team Activity and Response Times */}\n        <div className=\"grid gap-6 lg:grid-cols-2 mt-6\">\n          <Card data-testid=\"team-activity-detailed\">\n            <CardHeader>\n              <CardTitle>Recent Team Activity</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {activitiesLoading ? (\n                <div className=\"space-y-4\">\n                  {[...Array(5)].map((_, i) => (\n                    <div key={i} className=\"flex items-center space-x-3 animate-pulse\">\n                      <div className=\"h-8 w-8 bg-muted rounded-full\"></div>\n                      <div className=\"flex-1 space-y-1\">\n                        <div className=\"h-4 bg-muted rounded\"></div>\n                        <div className=\"h-3 bg-muted rounded w-1/2\"></div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : activities && activities.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {activities.slice(0, 8).map((activity) => (\n                    <div key={activity.id} className=\"flex items-start space-x-3 text-sm\">\n                      <div className=\"h-2 w-2 rounded-full bg-primary mt-2\"></div>\n                      <div className=\"flex-1\">\n                        <p>{activity.description}</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {new Date(activity.createdAt || '').toLocaleString()}\n                        </p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  No recent activity\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"response-times\">\n            <CardHeader>\n              <CardTitle>Response Time Trends</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm font-medium\">First Response</span>\n                  <div className=\"text-right\">\n                    <div className=\"text-lg font-bold\">2.4h</div>\n                    <div className=\"text-xs text-chart-2\">‚Üì 8% improvement</div>\n                  </div>\n                </div>\n                \n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm font-medium\">Resolution Time</span>\n                  <div className=\"text-right\">\n                    <div className=\"text-lg font-bold\">1.2 days</div>\n                    <div className=\"text-xs text-chart-1\">‚Üë 5% slower</div>\n                  </div>\n                </div>\n\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm font-medium\">SLA Compliance</span>\n                  <div className=\"text-right\">\n                    <div className=\"text-lg font-bold\">94%</div>\n                    <div className=\"text-xs text-chart-2\">‚Üë 2% improvement</div>\n                  </div>\n                </div>\n\n                <div className=\"pt-4 border-t\">\n                  <Tabs defaultValue=\"daily\" className=\"w-full\">\n                    <TabsList className=\"grid w-full grid-cols-3\">\n                      <TabsTrigger value=\"daily\">Daily</TabsTrigger>\n                      <TabsTrigger value=\"weekly\">Weekly</TabsTrigger>\n                      <TabsTrigger value=\"monthly\">Monthly</TabsTrigger>\n                    </TabsList>\n                    <TabsContent value=\"daily\" className=\"mt-4\">\n                      <div className=\"h-32 flex items-center justify-center text-muted-foreground text-sm\">\n                        Daily response time chart\n                      </div>\n                    </TabsContent>\n                    <TabsContent value=\"weekly\" className=\"mt-4\">\n                      <div className=\"h-32 flex items-center justify-center text-muted-foreground text-sm\">\n                        Weekly response time chart\n                      </div>\n                    </TabsContent>\n                    <TabsContent value=\"monthly\" className=\"mt-4\">\n                      <div className=\"h-32 flex items-center justify-center text-muted-foreground text-sm\">\n                        Monthly response time chart\n                      </div>\n                    </TabsContent>\n                  </Tabs>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* SLA Performance */}\n        <Card className=\"mt-6\" data-testid=\"sla-performance\">\n          <CardHeader>\n            <CardTitle>SLA Performance</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-6 md:grid-cols-3\">\n              <div className=\"text-center\">\n                <div className=\"text-3xl font-bold text-chart-2\">94%</div>\n                <div className=\"text-sm text-muted-foreground\">On-time Resolution</div>\n              </div>\n              <div className=\"text-center\">\n                <div className=\"text-3xl font-bold text-destructive\">4</div>\n                <div className=\"text-sm text-muted-foreground\">Breached SLAs</div>\n              </div>\n              <div className=\"text-center\">\n                <div className=\"text-3xl font-bold text-chart-4\">12</div>\n                <div className=\"text-sm text-muted-foreground\">At Risk</div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </main>\n    </div>\n  );\n}\n","size_bytes":11756},"client/src/components/layout/navigation.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Camera, Home, Inbox, ShoppingCart, Package2, Wrench, CheckSquare, BarChart3, Briefcase, Package, Search, Bell, ChevronDown, Settings, Users, Menu, X, Sun, Moon, Monitor } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n  SheetClose,\n} from \"@/components/ui/sheet\";\nimport { useTheme } from \"@/hooks/use-theme\";\nimport { GlobalSearch } from \"@/components/search/global-search\";\nimport { CommandPalette } from \"@/components/search/command-palette\";\nimport { useState } from \"react\";\nimport { useAuth } from \"@/lib/auth\";\n\nconst navigationItems = [\n  { href: \"/\", label: \"Home\", icon: Home, roles: [\"ADMIN\", \"SUPPORT\"] },\n  { href: \"/inbox\", label: \"Inbox\", icon: Inbox, badge: 3, roles: [\"ADMIN\", \"SUPPORT\"] },\n  { href: \"/cases\", label: \"Cases\", icon: Briefcase, roles: [\"ADMIN\", \"SUPPORT\"] },\n  { href: \"/returns\", label: \"Retouren\", icon: Package, roles: [\"ADMIN\", \"SUPPORT\"] },\n  { href: \"/orders\", label: \"Orders\", icon: ShoppingCart, roles: [\"ADMIN\", \"SUPPORT\"] },\n  { href: \"/purchase-orders\", label: \"Inkoop Orders\", icon: Package2, roles: [\"ADMIN\", \"SUPPORT\"] },\n  { href: \"/repairs\", label: \"Repairs\", icon: Wrench, roles: [\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"] },\n  { href: \"/todos\", label: \"To-do's\", icon: CheckSquare, roles: [\"ADMIN\", \"SUPPORT\"] },\n];\n\nexport function Navigation() {\n  const [location] = useLocation();\n  const { theme, setTheme } = useTheme();\n  const [showCommandPalette, setShowCommandPalette] = useState(false);\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n  const { signOut, user } = useAuth();\n  const smallLogoUrl = `${import.meta.env.VITE_SUPABASE_URL}/storage/v1/object/public/extra-files/dutchthrift-logo-small.jpg`;\n\n  const handleLogout = async () => {\n    await signOut();\n  };\n\n  const getUserInitials = () => {\n    if (!user) return \"??\";\n    if (user.firstName && user.lastName) {\n      return `${user.firstName[0]}${user.lastName[0]}`.toUpperCase();\n    }\n    if (user.firstName) {\n      return user.firstName[0].toUpperCase();\n    }\n    if (user.email) {\n      return user.email[0].toUpperCase();\n    }\n    return \"??\";\n  };\n\n  return (\n    <>\n      <nav className=\"sticky top-0 z-50 border-b border-border bg-card shadow-soft\" data-testid=\"main-navigation\">\n        <div className=\"flex h-16 items-center px-4 gap-4\">\n          {/* Mobile Menu Button */}\n          <Sheet open={mobileMenuOpen} onOpenChange={setMobileMenuOpen}>\n            <SheetTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"lg:hidden\"\n                data-testid=\"mobile-menu-button\"\n              >\n                <Menu className=\"h-5 w-5\" />\n              </Button>\n            </SheetTrigger>\n            <SheetContent side=\"left\" className=\"w-72 p-0 sidebar-glass border-r border-border\">\n              <div className=\"flex flex-col h-full\">\n                {/* Header */}\n                <div className=\"p-4 border-b border-border/50\">\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"h-8 w-8 rounded-lg overflow-hidden\">\n                      <img \n                        src={smallLogoUrl} \n                        alt=\"DutchThrift\" \n                        className=\"h-full w-full object-cover\"\n                      />\n                    </div>\n                    <span className=\"text-lg font-semibold\">DutchThrift</span>\n                  </div>\n                </div>\n\n                {/* Navigation Items */}\n                <nav className=\"flex-1 p-3 space-y-1 overflow-y-auto scrollbar-thin\">\n                  {navigationItems\n                    .filter((item) => !user?.role || item.roles.includes(user.role))\n                    .map((item) => {\n                      const isActive = location === item.href;\n                      return (\n                        <Link\n                          key={item.href}\n                          href={item.href}\n                          onClick={() => setMobileMenuOpen(false)}\n                          className={cn(\n                            \"flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all duration-200 font-medium text-sm\",\n                            isActive\n                              ? \"bg-[#FF6600] text-white shadow-orange\"\n                              : \"text-gray-700 dark:text-gray-300 hover:bg-accent hover:text-foreground\"\n                          )}\n                          data-testid={`mobile-nav-link-${item.label.toLowerCase().replace(/[''\\s]/g, '-')}`}\n                        >\n                          <item.icon className=\"h-5 w-5 flex-shrink-0\" />\n                          <span className=\"flex-1\">{item.label}</span>\n                          {item.badge && (\n                            <Badge variant={isActive ? \"secondary\" : \"default\"} className=\"h-5 px-2 text-xs\">\n                              {item.badge}\n                            </Badge>\n                          )}\n                        </Link>\n                      );\n                    })}\n                  \n                  {/* Admin Links */}\n                  {user?.role === \"ADMIN\" && (\n                    <>\n                      <div className=\"my-3 border-t border-border/50\" />\n                      <p className=\"px-3 py-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\n                        Admin\n                      </p>\n                      <Link\n                        href=\"/users\"\n                        onClick={() => setMobileMenuOpen(false)}\n                        className=\"flex items-center space-x-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-accent hover:text-foreground transition-all\"\n                        data-testid=\"mobile-nav-users\"\n                      >\n                        <Users className=\"h-5 w-5\" />\n                        <span>User Management</span>\n                      </Link>\n                      <Link\n                        href=\"/settings\"\n                        onClick={() => setMobileMenuOpen(false)}\n                        className=\"flex items-center space-x-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-accent hover:text-foreground transition-all\"\n                        data-testid=\"mobile-nav-settings\"\n                      >\n                        <Settings className=\"h-5 w-5\" />\n                        <span>Settings</span>\n                      </Link>\n                    </>\n                  )}\n                </nav>\n\n                {/* Footer with Theme Selector */}\n                <div className=\"border-t border-border/50 p-3 space-y-2\">\n                  <p className=\"px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\n                    Theme\n                  </p>\n                  <div className=\"flex gap-2\">\n                    <Button\n                      variant={theme === \"light\" ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => setTheme(\"light\")}\n                      className=\"flex-1\"\n                      data-testid=\"mobile-theme-light\"\n                    >\n                      <Sun className=\"h-4 w-4 mr-2\" />\n                      Light\n                    </Button>\n                    <Button\n                      variant={theme === \"dark\" ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => setTheme(\"dark\")}\n                      className=\"flex-1\"\n                      data-testid=\"mobile-theme-dark\"\n                    >\n                      <Moon className=\"h-4 w-4 mr-2\" />\n                      Dark\n                    </Button>\n                  </div>\n                  <Button\n                    variant={theme === \"system\" ? \"default\" : \"outline\"}\n                    size=\"sm\"\n                    onClick={() => setTheme(\"system\")}\n                    className=\"w-full\"\n                    data-testid=\"mobile-theme-system\"\n                  >\n                    <Monitor className=\"h-4 w-4 mr-2\" />\n                    System\n                  </Button>\n                  \n                  <div className=\"pt-2\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => {\n                        handleLogout();\n                        setMobileMenuOpen(false);\n                      }}\n                      className=\"w-full text-destructive hover:bg-destructive/10\"\n                      data-testid=\"mobile-logout\"\n                    >\n                      Logout\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            </SheetContent>\n          </Sheet>\n\n          {/* Logo */}\n          <div className=\"flex items-center\">\n            <Link href=\"/\" className=\"flex items-center space-x-2\" data-testid=\"logo-link\">\n              <div className=\"flex h-8 w-8 items-center justify-center rounded-lg overflow-hidden\">\n                <img \n                  src={smallLogoUrl} \n                  alt=\"DutchThrift\" \n                  className=\"h-full w-full object-cover\"\n                />\n              </div>\n              <span className=\"text-lg font-semibold text-foreground hidden sm:inline\">DutchThrift</span>\n            </Link>\n          </div>\n\n          {/* Desktop Navigation Items */}\n          <div className=\"ml-4 hidden lg:flex items-center gap-1 flex-1\">\n            {navigationItems\n              .filter((item) => !user?.role || item.roles.includes(user.role))\n              .map((item) => {\n                const isActive = location === item.href;\n                return (\n                  <Link\n                    key={item.href}\n                    href={item.href}\n                    className={cn(\n                      \"flex items-center space-x-2 px-3 py-2 rounded-lg text-sm font-semibold transition-all duration-200\",\n                      isActive\n                        ? \"bg-[#FF6600] text-white shadow-orange\"\n                        : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                    )}\n                    data-testid={`nav-link-${item.label.toLowerCase().replace(/[''\\s]/g, '-')}`}\n                  >\n                    <item.icon className=\"h-4 w-4\" />\n                    <span>{item.label}</span>\n                    {item.badge && (\n                      <Badge variant={isActive ? \"secondary\" : \"default\"} className=\"h-5 px-2 text-xs\">\n                        {item.badge}\n                      </Badge>\n                    )}\n                  </Link>\n                );\n              })}\n          </div>\n\n          {/* Right Section */}\n          <div className=\"ml-auto flex items-center gap-2\">\n            {/* Search Button */}\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={() => setShowCommandPalette(true)}\n              className=\"hidden sm:inline-flex\"\n              data-testid=\"search-button\"\n            >\n              <Search className=\"h-4 w-4\" />\n            </Button>\n\n            {/* Notifications */}\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"relative hidden sm:inline-flex\"\n              data-testid=\"notifications-button\"\n            >\n              <Bell className=\"h-4 w-4\" />\n              <span className=\"absolute top-2 right-2 h-2 w-2 rounded-full bg-[#FF6600]\" />\n            </Button>\n\n            {/* User Menu */}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className=\"flex items-center space-x-2 h-10\"\n                  data-testid=\"user-menu-button\"\n                >\n                  <Avatar className=\"h-7 w-7\">\n                    <AvatarFallback className=\"text-xs font-semibold\">\n                      {getUserInitials()}\n                    </AvatarFallback>\n                  </Avatar>\n                  <span className=\"hidden md:inline text-sm font-medium\">{user?.firstName || 'User'}</span>\n                  <ChevronDown className=\"h-4 w-4 hidden md:inline\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\" className=\"w-56\">\n                {user?.role === \"ADMIN\" && (\n                  <>\n                    <DropdownMenuItem asChild>\n                      <Link href=\"/users\" className=\"flex items-center cursor-pointer\" data-testid=\"dropdown-users\">\n                        <Users className=\"mr-2 h-4 w-4\" />\n                        <span>User Management</span>\n                      </Link>\n                    </DropdownMenuItem>\n                    <DropdownMenuItem asChild>\n                      <Link href=\"/settings\" className=\"flex items-center cursor-pointer\" data-testid=\"dropdown-settings\">\n                        <Settings className=\"mr-2 h-4 w-4\" />\n                        <span>Settings</span>\n                      </Link>\n                    </DropdownMenuItem>\n                    <DropdownMenuSeparator />\n                  </>\n                )}\n                \n                {/* Theme Selector */}\n                <div className=\"px-2 py-2\">\n                  <p className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2 px-2\">\n                    Theme\n                  </p>\n                  <div className=\"flex flex-col gap-1\">\n                    <Button\n                      variant={theme === \"light\" ? \"default\" : \"ghost\"}\n                      size=\"sm\"\n                      onClick={() => setTheme(\"light\")}\n                      className=\"w-full justify-start\"\n                      data-testid=\"dropdown-theme-light\"\n                    >\n                      <Sun className=\"h-4 w-4 mr-2\" />\n                      Light\n                    </Button>\n                    <Button\n                      variant={theme === \"dark\" ? \"default\" : \"ghost\"}\n                      size=\"sm\"\n                      onClick={() => setTheme(\"dark\")}\n                      className=\"w-full justify-start\"\n                      data-testid=\"dropdown-theme-dark\"\n                    >\n                      <Moon className=\"h-4 w-4 mr-2\" />\n                      Dark\n                    </Button>\n                    <Button\n                      variant={theme === \"system\" ? \"default\" : \"ghost\"}\n                      size=\"sm\"\n                      onClick={() => setTheme(\"system\")}\n                      className=\"w-full justify-start\"\n                      data-testid=\"dropdown-theme-system\"\n                    >\n                      <Monitor className=\"h-4 w-4 mr-2\" />\n                      System\n                    </Button>\n                  </div>\n                </div>\n                \n                <DropdownMenuSeparator />\n                <DropdownMenuItem\n                  onClick={handleLogout}\n                  className=\"text-destructive cursor-pointer\"\n                  data-testid=\"dropdown-logout\"\n                >\n                  Logout\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </div>\n      </nav>\n\n      {/* Command Palette */}\n      <CommandPalette open={showCommandPalette} onOpenChange={setShowCommandPalette} />\n    </>\n  );\n}\n","size_bytes":15979},"client/src/components/purchase-orders/purchase-orders-table.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport type { PurchaseOrder, Supplier } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { nl } from \"date-fns/locale\";\nimport { CheckCircle } from \"lucide-react\";\nimport { PurchaseOrderContextMenu } from \"./purchase-order-context-menu\";\n\ninterface PurchaseOrdersTableProps {\n  purchaseOrders: PurchaseOrder[];\n  suppliers: Supplier[];\n  onPOClick: (po: PurchaseOrder) => void;\n  getStatusColor: (status: string) => string;\n  onPOOpen: (id: string) => void;\n  onPOArchive: (id: string) => void;\n  onPOUnarchive: (id: string) => void;\n  onPODelete: (id: string) => void;\n  onPOStatusChange: (id: string, newStatus: string) => void;\n}\n\nexport function PurchaseOrdersTable({\n  purchaseOrders,\n  suppliers,\n  onPOClick,\n  getStatusColor,\n  onPOOpen,\n  onPOArchive,\n  onPOUnarchive,\n  onPODelete,\n  onPOStatusChange,\n}: PurchaseOrdersTableProps) {\n  const getSupplierName = (supplierId: string | null) => {\n    if (!supplierId) return \"-\";\n    return suppliers.find(s => s.id === supplierId)?.name || \"Onbekend\";\n  };\n\n  const getStatusLabel = (status: string) => {\n    switch (status) {\n      case \"draft\": return \"Concept\";\n      case \"sent\": return \"Verzonden\";\n      case \"awaiting_delivery\": return \"Onderweg\";\n      case \"partially_received\": return \"Deels Ontvangen\";\n      case \"fully_received\": return \"Volledig Ontvangen\";\n      case \"cancelled\": return \"Geannuleerd\";\n      default: return status;\n    }\n  };\n\n  return (\n    <div className=\"border rounded-lg\">\n      <Table>\n        <TableHeader>\n          <TableRow>\n            <TableHead>PO Nummer</TableHead>\n            <TableHead>Titel</TableHead>\n            <TableHead>Leverancier</TableHead>\n            <TableHead>Datum</TableHead>\n            <TableHead>Verwachte Levering</TableHead>\n            <TableHead>Bedrag</TableHead>\n            <TableHead>Status</TableHead>\n          </TableRow>\n        </TableHeader>\n        <TableBody>\n          {purchaseOrders.map((po) => (\n            <PurchaseOrderContextMenu\n              key={po.id}\n              purchaseOrderId={po.id}\n              currentStatus={po.status}\n              isArchived={po.archived || false}\n              onOpen={onPOOpen}\n              onArchive={onPOArchive}\n              onUnarchive={onPOUnarchive}\n              onDelete={onPODelete}\n              onStatusChange={onPOStatusChange}\n            >\n              <TableRow\n                className=\"cursor-pointer hover:bg-muted/50\"\n                onClick={() => onPOClick(po)}\n                data-testid={`row-po-${po.id}`}\n              >\n                <TableCell className=\"font-medium\" data-testid={`text-po-number-${po.id}`}>\n                  {po.poNumber || \"-\"}\n                </TableCell>\n                <TableCell>{po.title || \"-\"}</TableCell>\n                <TableCell>{getSupplierName(po.supplierId)}</TableCell>\n                <TableCell>\n                  {po.orderDate \n                    ? format(new Date(po.orderDate), \"d MMM yyyy\", { locale: nl })\n                    : \"-\"\n                  }\n                </TableCell>\n                <TableCell>\n                  {po.expectedDeliveryDate ? (\n                    <span className={\n                      new Date(po.expectedDeliveryDate) < new Date() && po.status !== 'verwerkt'\n                        ? \"text-red-600 font-medium\"\n                        : \"\"\n                    }>\n                      {format(new Date(po.expectedDeliveryDate), \"d MMM yyyy\", { locale: nl })}\n                    </span>\n                  ) : \"-\"}\n                </TableCell>\n                <TableCell>\n                  <div className=\"flex items-center gap-2\">\n                    ‚Ç¨{((po.totalAmount || 0) / 100).toLocaleString('nl-NL', { minimumFractionDigits: 2 })}\n                    {po.isPaid && (\n                      <svg className=\"h-4 w-4 text-green-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                      </svg>\n                    )}\n                  </div>\n                </TableCell>\n                <TableCell>\n                  <Badge \n                    variant=\"secondary\" \n                    className={getStatusColor(po.status)}\n                    data-testid={`badge-status-${po.id}`}\n                  >\n                    {getStatusLabel(po.status)}\n                  </Badge>\n                </TableCell>\n              </TableRow>\n            </PurchaseOrderContextMenu>\n          ))}\n        </TableBody>\n      </Table>\n    </div>\n  );\n}\n","size_bytes":4838},"client/src/components/repairs/repair-status-timeline.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { Check, Circle, X } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface TimelineStep {\n  id: string;\n  label: string;\n  color: string;\n}\n\nconst WORKFLOW_STEPS: TimelineStep[] = [\n  { id: \"new\", label: \"Nieuw\", color: \"bg-blue-500\" },\n  { id: \"diagnosing\", label: \"Diagnose\", color: \"bg-yellow-500\" },\n  { id: \"waiting_parts\", label: \"Wacht op onderdelen\", color: \"bg-purple-500\" },\n  { id: \"repair_in_progress\", label: \"In reparatie\", color: \"bg-orange-500\" },\n  { id: \"quality_check\", label: \"Kwaliteitscontrole\", color: \"bg-indigo-500\" },\n  { id: \"completed\", label: \"Voltooid\", color: \"bg-green-500\" },\n  { id: \"returned\", label: \"Geretourneerd\", color: \"bg-teal-500\" },\n];\n\nconst CANCELED_STEP: TimelineStep = { id: \"canceled\", label: \"Geannuleerd\", color: \"bg-red-500\" };\n\ninterface RepairStatusTimelineProps {\n  currentStatus: string;\n}\n\nexport function RepairStatusTimeline({ currentStatus }: RepairStatusTimelineProps) {\n  const isCanceled = currentStatus === \"canceled\";\n  const steps = isCanceled ? [CANCELED_STEP] : WORKFLOW_STEPS;\n  const currentStepIndex = steps.findIndex(step => step.id === currentStatus);\n\n  if (isCanceled) {\n    return (\n      <div className=\"py-4\" data-testid=\"repair-timeline-canceled\">\n        <div className=\"flex items-center gap-3\">\n          <div className={cn(\"rounded-full p-2\", CANCELED_STEP.color)}>\n            <X className=\"h-4 w-4 text-white\" />\n          </div>\n          <div className=\"flex-1\">\n            <div className=\"font-medium\">{CANCELED_STEP.label}</div>\n            <div className=\"text-sm text-muted-foreground\">Reparatie geannuleerd</div>\n          </div>\n        </div>\n\n        {/* Progress Percentage */}\n        <div className=\"mt-6 pt-4 border-t\">\n          <div className=\"flex items-center justify-between text-sm\">\n            <span className=\"text-muted-foreground\">Voortgang</span>\n            <span className=\"font-medium\" data-testid=\"timeline-percentage\">0%</span>\n          </div>\n          <div className=\"mt-2 h-2 bg-muted rounded-full overflow-hidden\">\n            <div \n              className=\"h-full bg-destructive transition-all duration-500\"\n              style={{ width: \"0%\" }}\n              data-testid=\"timeline-progress-bar\"\n            />\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const progressPercentage = Math.round(((currentStepIndex + 1) / steps.length) * 100);\n\n  return (\n    <div className=\"py-4\" data-testid=\"repair-timeline\">\n      <div className=\"relative\">\n        {/* Progress Line */}\n        <div className=\"absolute left-4 top-8 bottom-8 w-0.5 bg-muted\" data-testid=\"timeline-background\" />\n        <div \n          className=\"absolute left-4 top-8 w-0.5 bg-primary transition-all duration-500\"\n          style={{ height: `${progressPercentage}%` }}\n          data-testid=\"timeline-progress\"\n        />\n\n        {/* Steps */}\n        <div className=\"space-y-6\">\n          {steps.map((step, index) => {\n            const isCompleted = index < currentStepIndex;\n            const isCurrent = index === currentStepIndex;\n            const isPending = index > currentStepIndex;\n\n            return (\n              <div\n                key={step.id}\n                className=\"relative flex items-center gap-4\"\n                data-testid={`timeline-step-${step.id}`}\n              >\n                {/* Step Icon */}\n                <div className=\"relative z-10\">\n                  {isCompleted ? (\n                    <div className={cn(\"rounded-full p-1.5\", step.color)}>\n                      <Check className=\"h-3 w-3 text-white\" data-testid={`step-icon-completed-${step.id}`} />\n                    </div>\n                  ) : isCurrent ? (\n                    <div className={cn(\"rounded-full p-1.5 ring-4 ring-background\", step.color)}>\n                      <div className=\"h-3 w-3 rounded-full bg-white\" data-testid={`step-icon-current-${step.id}`} />\n                    </div>\n                  ) : (\n                    <div className=\"rounded-full p-1.5 bg-muted\">\n                      <Circle className=\"h-3 w-3 text-muted-foreground\" data-testid={`step-icon-pending-${step.id}`} />\n                    </div>\n                  )}\n                </div>\n\n                {/* Step Content */}\n                <div className=\"flex-1\">\n                  <div className={cn(\n                    \"font-medium transition-colors\",\n                    isCurrent && \"text-foreground\",\n                    isCompleted && \"text-foreground\",\n                    isPending && \"text-muted-foreground\"\n                  )} data-testid={`step-label-${step.id}`}>\n                    {step.label}\n                  </div>\n                  {isCurrent && (\n                    <div className=\"text-sm text-muted-foreground mt-1\">\n                      Huidige status\n                    </div>\n                  )}\n                </div>\n\n                {/* Status Badge */}\n                {isCurrent && (\n                  <Badge className={step.color} data-testid={`badge-current-${step.id}`}>\n                    Actief\n                  </Badge>\n                )}\n                {isCompleted && (\n                  <Badge variant=\"outline\" data-testid={`badge-completed-${step.id}`}>\n                    Voltooid\n                  </Badge>\n                )}\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* Progress Percentage */}\n      <div className=\"mt-6 pt-4 border-t\">\n        <div className=\"flex items-center justify-between text-sm\">\n          <span className=\"text-muted-foreground\">Voortgang</span>\n          <span className=\"font-medium\" data-testid=\"timeline-percentage\">\n            {progressPercentage}%\n          </span>\n        </div>\n        <div className=\"mt-2 h-2 bg-muted rounded-full overflow-hidden\">\n          <div \n            className=\"h-full bg-primary transition-all duration-500\"\n            style={{ width: `${progressPercentage}%` }}\n            data-testid=\"timeline-progress-bar\"\n          />\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":6110},"client/src/components/purchase-orders/purchase-orders-cards.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport type { PurchaseOrder, Supplier } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { nl } from \"date-fns/locale\";\nimport { Building2, Calendar, Euro, Truck, CheckCircle } from \"lucide-react\";\nimport { PurchaseOrderContextMenu } from \"./purchase-order-context-menu\";\n\ninterface PurchaseOrdersCardsProps {\n  purchaseOrders: PurchaseOrder[];\n  suppliers: Supplier[];\n  onPOClick: (po: PurchaseOrder) => void;\n  getStatusColor: (status: string) => string;\n  onPOOpen: (id: string) => void;\n  onPOArchive: (id: string) => void;\n  onPOUnarchive: (id: string) => void;\n  onPODelete: (id: string) => void;\n  onPOStatusChange: (id: string, newStatus: string) => void;\n}\n\nexport function PurchaseOrdersCards({\n  purchaseOrders,\n  suppliers,\n  onPOClick,\n  getStatusColor,\n  onPOOpen,\n  onPOArchive,\n  onPOUnarchive,\n  onPODelete,\n  onPOStatusChange,\n}: PurchaseOrdersCardsProps) {\n  const getSupplierName = (supplierId: string | null) => {\n    if (!supplierId) return \"-\";\n    return suppliers.find(s => s.id === supplierId)?.name || \"Onbekend\";\n  };\n\n  const getStatusLabel = (status: string) => {\n    switch (status) {\n      case \"draft\": return \"Concept\";\n      case \"sent\": return \"Verzonden\";\n      case \"awaiting_delivery\": return \"Onderweg\";\n      case \"partially_received\": return \"Deels Ontvangen\";\n      case \"fully_received\": return \"Volledig Ontvangen\";\n      case \"cancelled\": return \"Geannuleerd\";\n      default: return status;\n    }\n  };\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n      {purchaseOrders.map((po) => (\n        <PurchaseOrderContextMenu\n          key={po.id}\n          purchaseOrderId={po.id}\n          currentStatus={po.status}\n          isArchived={po.archived || false}\n          onOpen={onPOOpen}\n          onArchive={onPOArchive}\n          onUnarchive={onPOUnarchive}\n          onDelete={onPODelete}\n          onStatusChange={onPOStatusChange}\n        >\n          <Card\n            className=\"cursor-pointer hover:shadow-md transition-shadow\"\n            onClick={() => onPOClick(po)}\n            data-testid={`card-po-${po.id}`}\n          >\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex-1\">\n                  <CardTitle className=\"text-base\">{po.title || \"Geen titel\"}</CardTitle>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {po.poNumber || \"Geen PO nummer\"}\n                  </p>\n                </div>\n                <Badge\n                  variant=\"secondary\"\n                  className={getStatusColor(po.status)}\n                >\n                  {getStatusLabel(po.status)}\n                </Badge>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Building2 className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"truncate\">{getSupplierName(po.supplierId)}</span>\n              </div>\n\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                <span>\n                  {po.orderDate\n                    ? format(new Date(po.orderDate), \"d MMM yyyy\", { locale: nl })\n                    : \"-\"\n                  }\n                </span>\n              </div>\n\n              {po.expectedDeliveryDate && (\n                <div className=\"flex items-center gap-2 text-sm\">\n                  <Truck className=\"h-4 w-4 text-muted-foreground\" />\n                  <span className={\n                    new Date(po.expectedDeliveryDate) < new Date() && po.status !== 'verwerkt'\n                      ? \"text-red-600 font-medium\"\n                      : \"\"\n                  }>\n                    {format(new Date(po.expectedDeliveryDate), \"d MMM yyyy\", { locale: nl })}\n                  </span>\n                </div>\n              )}\n\n              <div className=\"flex items-center justify-between mt-3 pt-3 border-t\">\n                <div className=\"text-sm font-medium\">\n                  ‚Ç¨{((po.totalAmount || 0) / 100).toLocaleString('nl-NL', { minimumFractionDigits: 2 })}\n                </div>\n                {po.isPaid && (\n                  <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </PurchaseOrderContextMenu>\n      ))}\n    </div>\n  );\n}","size_bytes":4663},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/purchase-orders/purchase-order-detail-modal.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport type { PurchaseOrder, Supplier, PurchaseOrderItem } from \"@shared/schema\";\nimport { format } from \"date-fns\";\nimport { nl } from \"date-fns/locale\";\nimport { \n  Building2, \n  Calendar, \n  Euro, \n  Truck, \n  FileText, \n  Activity,\n  Package,\n  Edit,\n  Trash2,\n  Download,\n  Upload,\n  Clock,\n  ChevronDown,\n  ChevronRight\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { PurchaseOrderForm } from \"./purchase-order-form\";\n\ninterface PurchaseOrderDetailModalProps {\n  purchaseOrder: PurchaseOrder;\n  open: boolean;\n  onClose: () => void;\n  suppliers: Supplier[];\n  purchaseOrders: PurchaseOrder[];\n}\n\nexport function PurchaseOrderDetailModal({\n  purchaseOrder,\n  open,\n  onClose,\n  suppliers,\n  purchaseOrders,\n}: PurchaseOrderDetailModalProps) {\n  const { toast } = useToast();\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [isEditing, setIsEditing] = useState(false);\n  const [showFiles, setShowFiles] = useState(false);\n  const [showActivity, setShowActivity] = useState(false);\n\n  const supplier = suppliers.find(s => s.id === purchaseOrder.supplierId);\n\n  const { data: lineItems } = useQuery<PurchaseOrderItem[]>({\n    queryKey: [\"/api/purchase-order-items\", purchaseOrder.id],\n    queryFn: async () => {\n      const response = await fetch(`/api/purchase-order-items/${purchaseOrder.id}`, {\n        credentials: \"include\"\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch items\");\n      return response.json();\n    },\n    enabled: open,\n  });\n\n  const { data: files } = useQuery<any[]>({\n    queryKey: [\"/api/purchase-orders\", purchaseOrder.id, \"files\"],\n    queryFn: async () => {\n      const response = await fetch(`/api/purchase-orders/${purchaseOrder.id}/files`, {\n        credentials: \"include\"\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch files\");\n      return response.json();\n    },\n    enabled: open,\n  });\n\n  const { data: activities } = useQuery<any[]>({\n    queryKey: [\"/api/activities\", \"purchase_order\", purchaseOrder.id],\n    queryFn: async () => {\n      const response = await fetch(`/api/activities?purchaseOrderId=${purchaseOrder.id}`, {\n        credentials: \"include\"\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch activities\");\n      return response.json();\n    },\n    enabled: open,\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async (newStatus: string) => {\n      const response = await apiRequest(\"PATCH\", `/api/purchase-orders/${purchaseOrder.id}`, {\n        status: newStatus,\n        ...(newStatus === 'fully_received' && { receivedDate: new Date().toISOString() }),\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      toast({ title: \"Status bijgewerkt\" });\n    },\n    onError: () => {\n      toast({ title: \"Fout bij bijwerken\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"DELETE\", `/api/purchase-orders/${purchaseOrder.id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\"] });\n      toast({ \n        title: \"Inkoop order verwijderd\", \n        description: \"De inkoop order is succesvol verwijderd.\" \n      });\n      onClose();\n    },\n    onError: () => {\n      toast({ \n        title: \"Verwijderen mislukt\", \n        description: \"Er is een fout opgetreden bij het verwijderen van de inkoop order.\",\n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const getStatusLabel = (status: string) => {\n    switch (status) {\n      case \"draft\": return \"Concept\";\n      case \"sent\": return \"Verzonden\";\n      case \"awaiting_delivery\": return \"Onderweg\";\n      case \"partially_received\": return \"Deels Ontvangen\";\n      case \"fully_received\": return \"Volledig Ontvangen\";\n      case \"cancelled\": return \"Geannuleerd\";\n      default: return status;\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"draft\": return \"text-gray-600 bg-gray-100 dark:bg-gray-800\";\n      case \"sent\": return \"text-blue-600 bg-blue-100 dark:bg-blue-900\";\n      case \"awaiting_delivery\": return \"text-orange-600 bg-orange-100 dark:bg-orange-900\";\n      case \"partially_received\": return \"text-yellow-600 bg-yellow-100 dark:bg-yellow-900\";\n      case \"fully_received\": return \"text-green-600 bg-green-100 dark:bg-green-900\";\n      case \"cancelled\": return \"text-red-600 bg-red-100 dark:bg-red-900\";\n      default: return \"text-gray-600 bg-gray-100\";\n    }\n  };\n\n  const totalItems = lineItems?.reduce((sum, item) => sum + (item.quantity || 0), 0) || 0;\n  const totalAmount = lineItems?.reduce((sum, item) => sum + ((item.subtotal || 0) / 100), 0) || (purchaseOrder.totalAmount || 0) / 100;\n\n  // Auto-expand collapsible sections when data is available\n  useEffect(() => {\n    if (files && files.length > 0) {\n      setShowFiles(true);\n    }\n  }, [files]);\n\n  useEffect(() => {\n    if (activities && activities.length > 0) {\n      setShowActivity(true);\n    }\n  }, [activities]);\n\n  return (\n    <>\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-hidden flex flex-col\">\n        <DialogHeader className=\"flex-shrink-0\">\n          <div className=\"flex items-start justify-between\">\n            <div>\n              <DialogTitle className=\"text-2xl\">{purchaseOrder.title}</DialogTitle>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                {purchaseOrder.poNumber || \"Geen PO nummer\"}\n              </p>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => setIsEditing(true)}\n                data-testid=\"button-edit-purchase-order\"\n              >\n                <Edit className=\"h-4 w-4 mr-2\" />\n                Bewerken\n              </Button>\n              <Badge variant=\"secondary\" className={getStatusColor(purchaseOrder.status)}>\n                {getStatusLabel(purchaseOrder.status)}\n              </Badge>\n            </div>\n          </div>\n        </DialogHeader>\n\n        <ScrollArea className=\"flex-1 px-6\">\n          <div className=\"grid lg:grid-cols-[1.75fr_1fr] gap-6 pb-6\">\n            {/* Left Column */}\n            <div className=\"space-y-6\">\n              {/* Supplier & Order Details */}\n              <Card>\n                <CardHeader className=\"bg-muted/50 border-b\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <Building2 className=\"h-4 w-4\" />\n                    Leverancier & Order Informatie\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-4 pt-4\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <div className=\"text-sm font-medium\">Leverancier</div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {supplier?.name || \"Onbekend\"}\n                      </div>\n                    </div>\n                    <div>\n                      <div className=\"text-sm font-medium\">Order Datum</div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {purchaseOrder.orderDate \n                          ? format(new Date(purchaseOrder.orderDate), \"d MMMM yyyy\", { locale: nl })\n                          : \"-\"\n                        }\n                      </div>\n                    </div>\n                    {supplier?.email && (\n                      <div>\n                        <div className=\"text-sm font-medium\">Email</div>\n                        <div className=\"text-sm text-muted-foreground\">{supplier.email}</div>\n                      </div>\n                    )}\n                    {supplier?.phone && (\n                      <div>\n                        <div className=\"text-sm font-medium\">Telefoon</div>\n                        <div className=\"text-sm text-muted-foreground\">{supplier.phone}</div>\n                      </div>\n                    )}\n                  </div>\n                  \n                  {purchaseOrder.notes && (\n                    <div>\n                      <div className=\"text-sm font-medium\">Notities</div>\n                      <div className=\"text-sm text-muted-foreground whitespace-pre-wrap\">\n                        {purchaseOrder.notes}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Status Actions */}\n                  <div className=\"flex gap-2 pt-2 border-t\">\n                    {purchaseOrder.status === 'draft' && (\n                      <Button \n                        onClick={() => updateStatusMutation.mutate('sent')}\n                        disabled={updateStatusMutation.isPending}\n                        data-testid=\"button-mark-sent\"\n                        size=\"sm\"\n                      >\n                        Markeer als Verzonden\n                      </Button>\n                    )}\n                    {purchaseOrder.status === 'sent' && (\n                      <Button \n                        onClick={() => updateStatusMutation.mutate('awaiting_delivery')}\n                        disabled={updateStatusMutation.isPending}\n                        data-testid=\"button-mark-awaiting\"\n                        size=\"sm\"\n                      >\n                        Markeer als Onderweg\n                      </Button>\n                    )}\n                    {purchaseOrder.status === 'awaiting_delivery' && (\n                      <Button \n                        onClick={() => updateStatusMutation.mutate('fully_received')}\n                        disabled={updateStatusMutation.isPending}\n                        data-testid=\"button-mark-received\"\n                        size=\"sm\"\n                      >\n                        Markeer als Ontvangen\n                      </Button>\n                    )}\n                    <Button \n                      variant=\"destructive\"\n                      size=\"sm\"\n                      onClick={() => setShowDeleteDialog(true)}\n                      disabled={deleteMutation.isPending}\n                      data-testid=\"button-delete-po\"\n                      className=\"ml-auto\"\n                    >\n                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                      Verwijderen\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n\n              {/* Line Items */}\n              <Card>\n                <CardHeader className=\"bg-muted/50 border-b\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <Package className=\"h-4 w-4\" />\n                    Order Items ({lineItems?.length || 0})\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"p-0\">\n                  {lineItems && lineItems.length > 0 ? (\n                    <div className=\"max-h-[300px] overflow-y-auto\">\n                      <Table>\n                        <TableHeader className=\"sticky top-0 bg-background\">\n                          <TableRow>\n                            <TableHead>SKU</TableHead>\n                            <TableHead>Omschrijving</TableHead>\n                            <TableHead className=\"text-right\">Aantal</TableHead>\n                            <TableHead className=\"text-right\">Prijs</TableHead>\n                            <TableHead className=\"text-right\">Subtotaal</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {lineItems.map((item) => (\n                            <TableRow key={item.id}>\n                              <TableCell className=\"font-medium\">{item.sku}</TableCell>\n                              <TableCell>{item.productName}</TableCell>\n                              <TableCell className=\"text-right\">{item.quantity}</TableCell>\n                              <TableCell className=\"text-right\">\n                                ‚Ç¨{((item.unitPrice || 0) / 100).toFixed(2)}\n                              </TableCell>\n                              <TableCell className=\"text-right font-medium\">\n                                ‚Ç¨{((item.subtotal || 0) / 100).toFixed(2)}\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8\">\n                      <Package className=\"h-12 w-12 mx-auto text-muted-foreground mb-2\" />\n                      <p className=\"text-sm text-muted-foreground\">Geen items toegevoegd</p>\n                    </div>\n                  )}\n                  {lineItems && lineItems.length > 0 && (\n                    <div className=\"border-t bg-muted/30 px-6 py-3\">\n                      <div className=\"flex justify-between items-center font-medium\">\n                        <span>Totaal ({totalItems} items):</span>\n                        <span className=\"text-lg\">‚Ç¨{totalAmount.toFixed(2)}</span>\n                      </div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Right Column */}\n            <div className=\"space-y-6\">\n              {/* Delivery Information */}\n              <Card>\n                <CardHeader className=\"bg-muted/50 border-b\">\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <Truck className=\"h-4 w-4\" />\n                    Levering\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3 pt-4\">\n                  <div>\n                    <div className=\"text-sm font-medium\">Verwachte Leverdatum</div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      {purchaseOrder.expectedDeliveryDate \n                        ? format(new Date(purchaseOrder.expectedDeliveryDate), \"d MMMM yyyy\", { locale: nl })\n                        : \"Niet ingesteld\"\n                      }\n                    </div>\n                  </div>\n                  {purchaseOrder.receivedDate && (\n                    <div>\n                      <div className=\"text-sm font-medium\">Ontvangen Datum</div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {format(new Date(purchaseOrder.receivedDate), \"d MMMM yyyy 'om' HH:mm\", { locale: nl })}\n                      </div>\n                    </div>\n                  )}\n                  {purchaseOrder.receivedBy && (\n                    <div>\n                      <div className=\"text-sm font-medium\">Ontvangen Door</div>\n                      <div className=\"text-sm text-muted-foreground\">{purchaseOrder.receivedBy}</div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n\n              {/* Files Section - Collapsible */}\n              <Collapsible open={showFiles} onOpenChange={setShowFiles}>\n                <Card>\n                  <CollapsibleTrigger asChild>\n                    <CardHeader className=\"bg-muted/50 border-b cursor-pointer hover:bg-muted/70\">\n                      <div className=\"flex items-center justify-between\">\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                          <FileText className=\"h-4 w-4\" />\n                          Bestanden ({files?.length || 0})\n                        </CardTitle>\n                        {showFiles ? (\n                          <ChevronDown className=\"h-4 w-4\" />\n                        ) : (\n                          <ChevronRight className=\"h-4 w-4\" />\n                        )}\n                      </div>\n                    </CardHeader>\n                  </CollapsibleTrigger>\n                  <CollapsibleContent>\n                    <CardContent className=\"pt-4\">\n                      <PurchaseOrderFiles purchaseOrderId={purchaseOrder.id} />\n                    </CardContent>\n                  </CollapsibleContent>\n                </Card>\n              </Collapsible>\n\n              {/* Activity Section - Collapsible */}\n              <Collapsible open={showActivity} onOpenChange={setShowActivity}>\n                <Card>\n                  <CollapsibleTrigger asChild>\n                    <CardHeader className=\"bg-muted/50 border-b cursor-pointer hover:bg-muted/70\">\n                      <div className=\"flex items-center justify-between\">\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                          <Activity className=\"h-4 w-4\" />\n                          Activiteit ({activities?.length || 0})\n                        </CardTitle>\n                        {showActivity ? (\n                          <ChevronDown className=\"h-4 w-4\" />\n                        ) : (\n                          <ChevronRight className=\"h-4 w-4\" />\n                        )}\n                      </div>\n                    </CardHeader>\n                  </CollapsibleTrigger>\n                  <CollapsibleContent>\n                    <CardContent className=\"pt-4\">\n                      <PurchaseOrderActivities purchaseOrderId={purchaseOrder.id} />\n                    </CardContent>\n                  </CollapsibleContent>\n                </Card>\n              </Collapsible>\n            </div>\n          </div>\n        </ScrollArea>\n      </DialogContent>\n\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Weet je het zeker?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Deze actie kan niet ongedaan worden gemaakt. Dit zal de inkoop order permanent verwijderen.\n              <br /><br />\n              <strong>PO Nummer:</strong> {purchaseOrder.poNumber}\n              <br />\n              <strong>Titel:</strong> {purchaseOrder.title}\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel disabled={deleteMutation.isPending}>\n              Annuleren\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => {\n                deleteMutation.mutate();\n                setShowDeleteDialog(false);\n              }}\n              disabled={deleteMutation.isPending}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              {deleteMutation.isPending ? \"Verwijderen...\" : \"Verwijderen\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </Dialog>\n    \n    <PurchaseOrderForm\n      open={isEditing}\n      onClose={() => setIsEditing(false)}\n      suppliers={suppliers}\n      purchaseOrders={purchaseOrders}\n      editPurchaseOrder={purchaseOrder}\n    />\n    </>\n  );\n}\n\n// Files component for purchase order\nfunction PurchaseOrderFiles({ purchaseOrderId }: { purchaseOrderId: string }) {\n  const { toast } = useToast();\n  const [isUploading, setIsUploading] = useState(false);\n\n  const { data: files, isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/purchase-orders\", purchaseOrderId, \"files\"],\n    queryFn: async () => {\n      const response = await fetch(`/api/purchase-orders/${purchaseOrderId}/files`, {\n        credentials: \"include\"\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch files\");\n      return response.json();\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (fileId: string) => {\n      await apiRequest(\"DELETE\", `/api/purchase-order-files/${fileId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\", purchaseOrderId, \"files\"] });\n      toast({ title: \"Bestand verwijderd\" });\n    },\n    onError: () => {\n      toast({ title: \"Fout bij verwijderen\", variant: \"destructive\" });\n    },\n  });\n\n  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFiles = e.target.files;\n    if (!selectedFiles || selectedFiles.length === 0) return;\n\n    setIsUploading(true);\n    try {\n      const formData = new FormData();\n      Array.from(selectedFiles).forEach(file => {\n        formData.append('files', file);\n      });\n\n      const response = await fetch(`/api/purchase-orders/${purchaseOrderId}/upload`, {\n        method: 'POST',\n        credentials: 'include',\n        body: formData,\n      });\n\n      if (!response.ok) throw new Error(\"Upload failed\");\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-orders\", purchaseOrderId, \"files\"] });\n      toast({ title: \"Bestanden ge√ºpload\" });\n    } catch (error) {\n      toast({ title: \"Upload mislukt\", variant: \"destructive\" });\n    } finally {\n      setIsUploading(false);\n      e.target.value = '';\n    }\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Laden...</div>;\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex justify-end\">\n        <label htmlFor=\"file-upload-po\" className=\"cursor-pointer\">\n          <Button\n            type=\"button\"\n            size=\"sm\"\n            variant=\"outline\"\n            disabled={isUploading}\n            onClick={() => document.getElementById('file-upload-po')?.click()}\n            data-testid=\"button-upload-files\"\n          >\n            <Upload className=\"h-4 w-4 mr-2\" />\n            {isUploading ? \"Uploaden...\" : \"Upload\"}\n          </Button>\n          <input\n            type=\"file\"\n            id=\"file-upload-po\"\n            multiple\n            onChange={handleFileUpload}\n            className=\"hidden\"\n            accept=\".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx\"\n          />\n        </label>\n      </div>\n\n      {!files || files.length === 0 ? (\n        <div className=\"text-center py-8 border-2 border-dashed rounded-lg\">\n          <FileText className=\"h-8 w-8 mx-auto text-muted-foreground mb-2\" />\n          <p className=\"text-sm text-muted-foreground\">Geen bestanden</p>\n          <p className=\"text-xs text-muted-foreground mt-1\">Upload facturen, pakbonnen of andere documenten</p>\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          {files.map((file) => (\n            <div\n              key={file.id}\n              className=\"flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800\"\n              data-testid={`file-item-${file.id}`}\n            >\n              <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                <FileText className=\"h-5 w-5 text-muted-foreground flex-shrink-0\" />\n                <div className=\"min-w-0 flex-1\">\n                  <div className=\"font-medium text-sm truncate\">{file.fileName}</div>\n                  <div className=\"text-xs text-muted-foreground\">\n                    {(file.fileSize / 1024).toFixed(1)} KB ‚Ä¢ {file.uploadedAt && format(new Date(file.uploadedAt), \"d MMM yyyy HH:mm\", { locale: nl })}\n                  </div>\n                </div>\n              </div>\n              <div className=\"flex gap-2 flex-shrink-0\">\n                <a\n                  href={`/api/purchase-order-files/${file.id}/download`}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                >\n                  <Button size=\"sm\" variant=\"ghost\" data-testid={`button-download-${file.id}`}>\n                    <Download className=\"h-4 w-4\" />\n                  </Button>\n                </a>\n                <Button\n                  size=\"sm\"\n                  variant=\"ghost\"\n                  onClick={() => deleteMutation.mutate(file.id)}\n                  disabled={deleteMutation.isPending}\n                  data-testid={`button-delete-${file.id}`}\n                >\n                  <Trash2 className=\"h-4 w-4 text-destructive\" />\n                </Button>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// Activities component for purchase order\nfunction PurchaseOrderActivities({ purchaseOrderId }: { purchaseOrderId: string }) {\n  const { data: activities, isLoading } = useQuery<any[]>({\n    queryKey: [\"/api/activities\", \"purchase_order\", purchaseOrderId],\n    queryFn: async () => {\n      const response = await fetch(`/api/activities`, {\n        credentials: \"include\"\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch activities\");\n      const allActivities = await response.json();\n      // Filter activities related to this purchase order\n      return allActivities.filter((activity: any) => \n        activity.metadata?.purchaseOrderId === purchaseOrderId\n      );\n    },\n  });\n\n  if (isLoading) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Laden...</div>;\n  }\n\n  if (!activities || activities.length === 0) {\n    return (\n      <div className=\"text-center py-8 border-2 border-dashed rounded-lg\">\n        <Activity className=\"h-8 w-8 mx-auto text-muted-foreground mb-2\" />\n        <p className=\"text-sm text-muted-foreground\">Geen activiteiten</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-3\">\n      {activities.map((activity) => (\n        <div\n          key={activity.id}\n          className=\"flex gap-3 pb-3 border-b last:border-b-0 last:pb-0\"\n        >\n          <div className=\"flex-shrink-0 mt-1\">\n            <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center\">\n              <Activity className=\"h-4 w-4 text-primary\" />\n            </div>\n          </div>\n          <div className=\"flex-1\">\n            <p className=\"text-sm font-medium\">{activity.description}</p>\n            <p className=\"text-xs text-muted-foreground\">\n              {activity.createdAt && format(new Date(activity.createdAt), \"d MMMM yyyy 'om' HH:mm\", { locale: nl })}\n            </p>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n","size_bytes":27247},"client/src/components/widgets/repair-status-widget.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Repair } from \"@/lib/types\";\nimport { Link } from \"wouter\";\n\nexport function RepairStatusWidget() {\n  const { data: repairs, isLoading } = useQuery<Repair[]>({\n    queryKey: [\"/api/repairs\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"repair-status-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse space-y-4\">\n            {[...Array(5)].map((_, i) => (\n              <div key={i} className=\"flex items-center justify-between\">\n                <div className=\"flex items-center space-x-2\">\n                  <div className=\"h-3 w-3 bg-muted rounded-full\"></div>\n                  <div className=\"h-4 bg-muted rounded w-16\"></div>\n                </div>\n                <div className=\"h-4 bg-muted rounded w-4\"></div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const repairStatusCount = {\n    new: repairs?.filter(r => r.status === 'new').length || 0,\n    in_progress: repairs?.filter(r => r.status === 'in_progress').length || 0,\n    waiting_customer: repairs?.filter(r => r.status === 'waiting_customer').length || 0,\n    waiting_part: repairs?.filter(r => r.status === 'waiting_part').length || 0,\n    ready: repairs?.filter(r => r.status === 'ready').length || 0,\n    closed: repairs?.filter(r => r.status === 'closed').length || 0,\n  };\n\n  const waitingCount = repairStatusCount.waiting_customer + repairStatusCount.waiting_part;\n\n  const statusConfig = [\n    { status: 'new', label: 'New', color: 'bg-chart-4', count: repairStatusCount.new },\n    { status: 'in_progress', label: 'In Progress', color: 'bg-primary', count: repairStatusCount.in_progress },\n    { status: 'waiting', label: 'Waiting', color: 'bg-chart-1', count: waitingCount },\n    { status: 'ready', label: 'Ready', color: 'bg-chart-2', count: repairStatusCount.ready },\n    { status: 'closed', label: 'Closed', color: 'bg-muted-foreground', count: repairStatusCount.closed },\n  ];\n\n  const urgentRepairs = repairs?.filter(r => \n    r.status === 'in_progress' && r.priority === 'high'\n  ).slice(0, 2) || [];\n\n  return (\n    <Card data-testid=\"repair-status-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <CardTitle className=\"text-lg font-medium\">Repair Status Overview</CardTitle>\n        <Link href=\"/repairs\">\n          <Button variant=\"link\" className=\"text-sm text-primary hover:text-primary/80\" data-testid=\"view-repair-board\">\n            View repair board\n          </Button>\n        </Link>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {statusConfig.map((config) => (\n            <div \n              key={config.status}\n              className=\"flex items-center justify-between\"\n              data-testid={`repair-status-${config.status}`}\n            >\n              <div className=\"flex items-center space-x-2\">\n                <div className={`h-3 w-3 rounded-full ${config.color}`}></div>\n                <span className=\"text-sm font-medium\">{config.label}</span>\n              </div>\n              <span className=\"text-sm font-bold\" data-testid={`repair-count-${config.status}`}>\n                {config.count}\n              </span>\n            </div>\n          ))}\n        </div>\n\n        {urgentRepairs.length > 0 && (\n          <div className=\"mt-6 space-y-3\">\n            <h4 className=\"text-sm font-medium text-muted-foreground\">Urgent Repairs</h4>\n            {urgentRepairs.map((repair) => (\n              <div \n                key={repair.id}\n                className=\"p-3 rounded-md bg-muted\"\n                data-testid={`urgent-repair-${repair.id}`}\n              >\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"text-sm font-medium\">{repair.title}</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {repair.slaDeadline ? \n                      new Date(repair.slaDeadline) > new Date() ? \n                        `${Math.ceil((new Date(repair.slaDeadline).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24))} days left` :\n                        'Overdue'\n                      : 'No deadline'\n                    }\n                  </span>\n                </div>\n                <p className=\"text-xs text-muted-foreground mt-1\">\n                  Assigned to {repair.assignedUserId ? 'Team Member' : 'Unassigned'}\n                </p>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":4749},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  /* ========== FOUNDATION - WARM & CLEAN ========== */\n  --background: hsl(0 0% 97.25%);          /* #F8F8F8 */\n  --foreground: hsl(0 0% 11%);             /* #1C1C1C */\n  --card: hsl(0 0% 100%);                  /* Pure white */\n  --card-foreground: hsl(0 0% 11%);\n  --popover: hsl(0 0% 100%);\n  --popover-foreground: hsl(0 0% 11%);\n  \n  /* ========== PRIMARY - VIBRANT ORANGE ========== */\n  --primary: 24 100% 50%;                  /* #FF6600 */\n  --primary-foreground: hsl(0 0% 100%);\n  \n  /* ========== BRAND ORANGE (Shopify-style) ========== */\n  --brand-orange-100: #FEF3C7;             /* Light background */\n  --brand-orange-600: #F59E0B;             /* Primary accent */\n  --brand-orange-700: #D97706;             /* Hover/active */\n  \n  /* ========== NEUTRALS - CLEAN GRAYS ========== */\n  --secondary: hsl(0 0% 94%);\n  --secondary-foreground: hsl(0 0% 11%);\n  --muted: hsl(0 0% 96%);\n  --muted-foreground: hsl(0 0% 45%);       /* Medium gray */\n  --accent: hsl(0 0% 94%);\n  --accent-foreground: hsl(0 0% 11%);\n  \n  /* ========== TEXT COLORS ========== */\n  --text-primary: hsl(0 0% 11%);           /* #1C1C1C */\n  --text-secondary: hsl(0 0% 70%);         /* #B3B3B3 */\n  \n  /* ========== STATUS COLORS - NO BLUE/PURPLE ========== */\n  --destructive: hsl(0 84% 60%);           /* Red */\n  --destructive-foreground: hsl(0 0% 100%);\n  --success: hsl(142 71% 45%);             /* Green */\n  --success-foreground: hsl(0 0% 100%);\n  --warning: hsl(38 92% 50%);              /* Amber */\n  --warning-foreground: hsl(0 0% 11%);\n  \n  /* ========== BORDERS & INPUTS ========== */\n  --border: hsl(0 0% 89%);\n  --input: hsl(0 0% 100%);\n  --ring: 24 100% 50%;                     /* Orange focus ring */\n  \n  /* ========== SIDEBAR COLORS ========== */\n  --sidebar-bg: hsla(0 0% 100% / 0.95);\n  --sidebar-foreground: hsl(0 0% 20%);     /* Dark gray text */\n  --sidebar-accent: hsl(24 100% 50%);      /* Orange active */\n  --sidebar-accent-foreground: hsl(0 0% 100%);\n  --sidebar-border: hsl(0 0% 89%);\n  \n  /* ========== DESIGN TOKENS ========== */\n  --radius: 0.75rem;\n  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;\n}\n\n.dark {\n  /* ========== FOUNDATION - DEEP NEUTRAL ========== */\n  --background: hsl(0 0% 5.5%);            /* #0E0E0E */\n  --foreground: hsl(0 0% 93%);             /* #EDEDED */\n  --card: hsl(0 0% 10%);\n  --card-foreground: hsl(0 0% 93%);\n  --popover: hsl(0 0% 10%);\n  --popover-foreground: hsl(0 0% 93%);\n  \n  /* ========== PRIMARY - VIBRANT ORANGE ========== */\n  --primary: 24 100% 55%;                  /* Slightly brighter for dark */\n  --primary-foreground: hsl(0 0% 100%);\n  \n  /* ========== BRAND ORANGE (Shopify-style) ========== */\n  --brand-orange-100: #451A03;             /* Dark background */\n  --brand-orange-600: #F59E0B;             /* Primary accent */\n  --brand-orange-700: #FBBF24;             /* Hover/active (lighter for dark mode) */\n  \n  /* ========== NEUTRALS - DARK GRAYS ========== */\n  --secondary: hsl(0 0% 14%);\n  --secondary-foreground: hsl(0 0% 93%);\n  --muted: hsl(0 0% 14%);\n  --muted-foreground: hsl(0 0% 60%);\n  --accent: hsl(0 0% 14%);\n  --accent-foreground: hsl(0 0% 93%);\n  \n  /* ========== TEXT COLORS ========== */\n  --text-primary: hsl(0 0% 93%);           /* #EDEDED */\n  --text-secondary: hsl(0 0% 70%);         /* #B3B3B3 */\n  \n  /* ========== STATUS COLORS ========== */\n  --destructive: hsl(0 84% 65%);\n  --destructive-foreground: hsl(0 0% 100%);\n  --success: hsl(142 71% 50%);\n  --success-foreground: hsl(0 0% 100%);\n  --warning: hsl(38 92% 55%);\n  --warning-foreground: hsl(0 0% 5.5%);\n  \n  /* ========== BORDERS & INPUTS ========== */\n  --border: hsl(0 0% 18%);\n  --input: hsl(0 0% 12%);\n  --ring: 24 100% 55%;\n  \n  /* ========== SIDEBAR COLORS - HIGH CONTRAST ========== */\n  --sidebar-bg: hsla(0 0% 8% / 0.55);      /* Translucent dark with blur */\n  --sidebar-foreground: hsl(0 0% 80%);     /* Light gray for readability */\n  --sidebar-accent: hsl(24 100% 55%);\n  --sidebar-accent-foreground: hsl(0 0% 100%);\n  --sidebar-border: hsl(0 0% 18%);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    letter-spacing: -0.011em;\n  }\n  \n  h1, h2, h3, h4, h5, h6 {\n    @apply font-semibold tracking-tight;\n  }\n  \n  /* Fix SelectItem visibility - prevent white text on white background */\n  [data-radix-select-viewport] [data-state=\"checked\"] {\n    @apply text-foreground bg-accent;\n  }\n  \n  h1 {\n    @apply text-3xl md:text-4xl lg:text-5xl;\n  }\n  \n  h2 {\n    @apply text-2xl md:text-3xl lg:text-4xl;\n  }\n  \n  h3 {\n    @apply text-xl md:text-2xl;\n  }\n  \n  h4 {\n    @apply text-lg md:text-xl;\n  }\n}\n\n@layer components {\n  /* ========== SHADOW SYSTEM ========== */\n  .shadow-soft {\n    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);\n  }\n  \n  .shadow-card {\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06);\n  }\n  \n  .shadow-card-hover {\n    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12), 0 3px 6px rgba(0, 0, 0, 0.08);\n  }\n  \n  .shadow-modal {\n    box-shadow: 0 24px 48px rgba(0, 0, 0, 0.18), 0 12px 24px rgba(0, 0, 0, 0.12);\n  }\n  \n  .shadow-orange {\n    box-shadow: 0 8px 24px rgba(255, 102, 0, 0.25);\n  }\n  \n  .dark .shadow-orange {\n    box-shadow: 0 8px 24px rgba(255, 102, 0, 0.35);\n  }\n  \n  /* ========== GLASSMORPHISM ========== */\n  .glass {\n    background: rgba(255, 255, 255, 0.7);\n    backdrop-filter: blur(14px);\n    -webkit-backdrop-filter: blur(14px);\n    border: 1px solid rgba(255, 255, 255, 0.2);\n  }\n  \n  .dark .glass {\n    background: rgba(20, 20, 20, 0.55);\n    backdrop-filter: blur(14px);\n    -webkit-backdrop-filter: blur(14px);\n    border: 1px solid rgba(255, 255, 255, 0.08);\n  }\n  \n  .glass-strong {\n    background: rgba(255, 255, 255, 0.85);\n    backdrop-filter: blur(20px);\n    -webkit-backdrop-filter: blur(20px);\n  }\n  \n  .dark .glass-strong {\n    background: rgba(20, 20, 20, 0.75);\n    backdrop-filter: blur(20px);\n    -webkit-backdrop-filter: blur(20px);\n  }\n  \n  /* ========== SIDEBAR SPECIFIC ========== */\n  .sidebar-glass {\n    background: var(--sidebar-bg);\n    backdrop-filter: blur(14px);\n    -webkit-backdrop-filter: blur(14px);\n  }\n  \n  /* ========== ANIMATIONS ========== */\n  .animate-fade-in {\n    animation: fadeIn 0.2s ease-out;\n  }\n  \n  .animate-slide-in {\n    animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n  }\n  \n  .animate-scale-in {\n    animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);\n  }\n  \n  @keyframes fadeIn {\n    from { opacity: 0; }\n    to { opacity: 1; }\n  }\n  \n  @keyframes slideIn {\n    from {\n      opacity: 0;\n      transform: translateX(-10px);\n    }\n    to {\n      opacity: 1;\n      transform: translateX(0);\n    }\n  }\n  \n  @keyframes scaleIn {\n    from {\n      opacity: 0;\n      transform: scale(0.96);\n    }\n    to {\n      opacity: 1;\n      transform: scale(1);\n    }\n  }\n  \n  /* ========== INTERACTIVE ELEMENTS ========== */\n  .card-interactive {\n    @apply transition-all duration-300 hover:shadow-card-hover hover:-translate-y-0.5;\n  }\n  \n  .btn-primary {\n    @apply bg-[#FF6600] text-white hover:bg-[#FF6600]/90 shadow-soft hover:shadow-orange transition-all duration-300;\n  }\n  \n  .btn-secondary {\n    @apply bg-secondary text-secondary-foreground hover:bg-secondary/80 transition-all duration-300;\n  }\n  \n  .btn-ghost {\n    @apply hover:bg-accent hover:text-accent-foreground transition-all duration-300;\n  }\n  \n  .btn-danger {\n    @apply bg-destructive text-destructive-foreground hover:bg-destructive/90 transition-all duration-300;\n  }\n  \n  /* ========== FOCUS STATES ========== */\n  .focus-ring {\n    @apply focus:outline-none focus:ring-2 focus:ring-[#FF6600] focus:ring-offset-2 focus:ring-offset-background;\n  }\n  \n  .focus-ring-inset {\n    @apply focus:outline-none focus:ring-2 focus:ring-[#FF6600] focus:ring-inset;\n  }\n  \n  /* ========== MOBILE OPTIMIZATIONS ========== */\n  @media (max-width: 768px) {\n    .mobile-overlay {\n      @apply fixed inset-0 bg-black/60 backdrop-blur-sm z-40 animate-fade-in;\n    }\n    \n    .mobile-drawer {\n      @apply fixed inset-y-0 left-0 w-64 z-50 animate-slide-in;\n    }\n  }\n}\n\n/* ========== SCROLLBAR STYLING ========== */\n.scrollbar-thin {\n  scrollbar-width: thin;\n  scrollbar-color: rgba(0, 0, 0, 0.2) transparent;\n}\n\n.scrollbar-thin::-webkit-scrollbar {\n  width: 6px;\n  height: 6px;\n}\n\n.scrollbar-thin::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.scrollbar-thin::-webkit-scrollbar-thumb {\n  background: rgba(0, 0, 0, 0.2);\n  border-radius: 9999px;\n}\n\n.scrollbar-thin::-webkit-scrollbar-thumb:hover {\n  background: rgba(0, 0, 0, 0.3);\n}\n\n.dark .scrollbar-thin {\n  scrollbar-color: rgba(255, 255, 255, 0.2) transparent;\n}\n\n.dark .scrollbar-thin::-webkit-scrollbar-thumb {\n  background: rgba(255, 255, 255, 0.2);\n}\n\n.dark .scrollbar-thin::-webkit-scrollbar-thumb:hover {\n  background: rgba(255, 255, 255, 0.3);\n}\n\n.scrollbar-hide {\n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n\n.scrollbar-hide::-webkit-scrollbar {\n  display: none;\n}\n","size_bytes":9114},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-lg border border-border bg-input px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#FF6600] focus-visible:border-[#FF6600] transition-all duration-200 disabled:cursor-not-allowed disabled:opacity-50\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":702},"client/src/components/widgets/inbox-status-widget.tsx":{"content":"import { Mail } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { DashboardStats } from \"@/lib/types\";\n\nexport function InboxStatusWidget() {\n  const { data: stats, isLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"inbox-status-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse\">\n            <div className=\"h-4 bg-muted rounded mb-2\"></div>\n            <div className=\"h-8 bg-muted rounded mb-1\"></div>\n            <div className=\"h-3 bg-muted rounded\"></div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"hover:shadow-card-hover\" data-testid=\"inbox-status-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-semibold text-muted-foreground\">Inbox Status</CardTitle>\n        <div className=\"h-10 w-10 rounded-full bg-gradient-inbox flex items-center justify-center\">\n          <Mail className=\"h-5 w-5 text-white\" />\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-2\">\n          <div className=\"text-3xl font-bold text-inbox\" data-testid=\"unread-emails-count\">\n            {stats?.unreadEmails || 0}\n          </div>\n          <p className=\"text-sm font-medium text-muted-foreground\">Unread emails</p>\n          <div className=\"flex items-center text-sm\">\n            <span className=\"text-destructive font-semibold\" data-testid=\"require-reply-count\">\n              {Math.floor((stats?.unreadEmails || 0) / 3)} require reply\n            </span>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1845},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/components/widgets/personal-todos-widget.tsx":{"content":"import { ExternalLink } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Button } from \"@/components/ui/button\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Todo } from \"@/lib/types\";\nimport { Link } from \"wouter\";\n\nexport function PersonalTodosWidget() {\n  const { data: todos, isLoading } = useQuery<Todo[]>({\n    queryKey: [\"/api/todos\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"personal-todos-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse space-y-3\">\n            {[...Array(3)].map((_, i) => (\n              <div key={i} className=\"flex items-center space-x-3 p-3\">\n                <div className=\"h-4 w-4 bg-muted rounded\"></div>\n                <div className=\"flex-1 space-y-1\">\n                  <div className=\"h-4 bg-muted rounded\"></div>\n                  <div className=\"h-3 bg-muted rounded w-3/4\"></div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const topTodos = todos?.slice(0, 5) || [];\n\n  const getPriorityVariant = (priority: string) => {\n    switch (priority) {\n      case \"high\":\n      case \"urgent\":\n        return \"destructive\";\n      case \"medium\":\n        return \"secondary\";\n      case \"low\":\n        return \"outline\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  const getPriorityLabel = (priority: string) => {\n    switch (priority) {\n      case \"high\":\n        return \"High Priority\";\n      case \"urgent\":\n        return \"Urgent\";\n      case \"medium\":\n        return \"Medium\";\n      case \"low\":\n        return \"Low\";\n      default:\n        return \"Medium\";\n    }\n  };\n\n  return (\n    <Card data-testid=\"personal-todos-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <CardTitle className=\"text-lg font-medium\">Personal To-do's</CardTitle>\n        <Link href=\"/todos\">\n          <Button variant=\"link\" className=\"text-sm text-primary hover:text-primary/80\" data-testid=\"view-all-todos\">\n            View all\n          </Button>\n        </Link>\n      </CardHeader>\n      <CardContent>\n        {topTodos.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No todos found. Create one to get started!\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {topTodos.map((todo) => (\n              <div\n                key={todo.id}\n                className=\"flex items-center space-x-3 p-3 rounded-md border border-border hover:bg-accent transition-colors\"\n                data-testid={`todo-item-${todo.id}`}\n              >\n                <Checkbox \n                  checked={todo.status === 'done'}\n                  data-testid={`todo-checkbox-${todo.id}`}\n                />\n                <div className=\"flex-1 space-y-1\">\n                  <p className=\"text-sm font-medium\">{todo.title}</p>\n                  <div className=\"flex items-center space-x-2 text-xs text-muted-foreground\">\n                    <span data-testid={`todo-due-date-${todo.id}`}>\n                      Due: {todo.dueDate ? new Date(todo.dueDate).toLocaleDateString() : 'No due date'}\n                    </span>\n                    <Badge \n                      variant={getPriorityVariant(todo.priority || 'medium')}\n                      className=\"text-xs\"\n                      data-testid={`todo-priority-${todo.id}`}\n                    >\n                      {getPriorityLabel(todo.priority || 'medium')}\n                    </Badge>\n                  </div>\n                </div>\n                <Button variant=\"ghost\" size=\"icon\" data-testid={`todo-link-${todo.id}`}>\n                  <ExternalLink className=\"h-4 w-4 text-muted-foreground\" />\n                </Button>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":4053},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-md px-2.5 py-0.5 text-xs font-semibold transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border border-primary/20 bg-primary/10 text-primary hover:bg-primary/20\",\n        secondary:\n          \"border border-secondary/20 bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border border-destructive/20 bg-destructive/10 text-destructive hover:bg-destructive/20\",\n        success:\n          \"border border-success/20 bg-success/10 text-success hover:bg-success/20\",\n        warning:\n          \"border border-warning/20 bg-warning/10 text-warning-foreground hover:bg-warning/20\",\n        info:\n          \"border border-info/20 bg-info/10 text-info hover:bg-info/20\",\n        outline: \"border border-border text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1460},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/40 dark:bg-black/60 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 border p-6 transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500 bg-white border-border shadow-[0_8px_32px_rgba(0,0,0,0.08)] dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-2xl\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-md opacity-70 ring-offset-background transition-all hover:opacity-100 hover:bg-accent/50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none p-1\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 gap-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-xl font-semibold text-foreground tracking-tight\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground leading-relaxed\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4470},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/pages/inbox.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { EmailSidebar } from \"@/components/email/email-sidebar\";\nimport { EmailList } from \"@/components/email/email-list\";\nimport { EmailThreadView } from \"@/components/email/email-thread-view\";\nimport { EmailCompose } from \"@/components/email/email-compose\";\nimport { \n  MailOpen,\n  Mail,\n  Star,\n  Archive as ArchiveIcon,\n  RefreshCw,\n  ChevronLeft,\n  ChevronRight,\n  Download\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { EmailThread } from \"@shared/schema\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { cn } from \"@/lib/utils\";\n\ntype FolderType = \"inbox\" | \"sent\" | \"archived\" | \"starred\" | \"unread\";\ntype FilterType = 'with-order' | 'without-order' | null;\n\nexport default function Inbox() {\n  const [selectedThread, setSelectedThread] = useState<string | null>(null);\n  const [showCompose, setShowCompose] = useState(false);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [currentFolder, setCurrentFolder] = useState<FolderType>(\"inbox\");\n  const [currentFilter, setCurrentFilter] = useState<FilterType>(null);\n  const [selectedThreadIds, setSelectedThreadIds] = useState<Set<string>>(new Set());\n  const [leftSidebarCollapsed, setLeftSidebarCollapsed] = useState(false);\n  const [rightPanelCollapsed, setRightPanelCollapsed] = useState(false);\n  const { toast } = useToast();\n\n  const buildQueryParams = () => {\n    const params = new URLSearchParams();\n    \n    if (currentFolder === 'inbox') {\n      params.append('folder', 'inbox');\n      params.append('archived', 'false');\n    } else if (currentFolder === 'sent') {\n      params.append('folder', 'sent');\n    } else if (currentFolder === 'archived') {\n      params.append('archived', 'true');\n    } else if (currentFolder === 'starred') {\n      params.append('starred', 'true');\n    } else if (currentFolder === 'unread') {\n      params.append('isUnread', 'true');\n    }\n    \n    if (currentFilter === 'with-order') {\n      params.append('hasOrder', 'true');\n    } else if (currentFilter === 'without-order') {\n      params.append('hasOrder', 'false');\n    }\n    \n    return params.toString();\n  };\n\n  const { data: emailThreads = [], isLoading } = useQuery<EmailThread[]>({\n    queryKey: [\"/api/email-threads\", currentFolder, currentFilter],\n    queryFn: async () => {\n      const queryString = buildQueryParams();\n      const response = await fetch(`/api/email-threads?${queryString}`);\n      if (!response.ok) throw new Error(\"Failed to fetch email threads\");\n      return response.json();\n    },\n  });\n\n  const filteredThreads = emailThreads.filter(thread => {\n    if (searchQuery && \n        !thread.subject?.toLowerCase().includes(searchQuery.toLowerCase()) &&\n        !thread.customerEmail?.toLowerCase().includes(searchQuery.toLowerCase())) {\n      return false;\n    }\n    return true;\n  });\n\n  const syncEmailsMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(\"/api/emails/sync\", { method: \"POST\" });\n      if (!response.ok) throw new Error(\"Failed to sync emails\");\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"], exact: false });\n      toast({\n        title: \"Emails synced\",\n        description: `Synced ${data.synced} new emails`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Sync failed\",\n        description: \"Failed to sync emails from server\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const importAllEmailsMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(\"/api/emails/import-all\", { method: \"POST\" });\n      if (!response.ok) throw new Error(\"Failed to import emails\");\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"], exact: false });\n      toast({\n        title: \"Import complete\",\n        description: data.message,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Import failed\",\n        description: error.message || \"Failed to import emails from server\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const updateThreadMutation = useMutation({\n    mutationFn: async ({ threadId, updates }: { threadId: string; updates: Partial<EmailThread> }) => {\n      return apiRequest(\"PATCH\", `/api/email-threads/${threadId}`, updates);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"], exact: false });\n    },\n  });\n\n  const bulkActionMutation = useMutation({\n    mutationFn: async ({ action, threadIds }: { action: string; threadIds: string[] }) => {\n      return apiRequest(\"POST\", `/api/email-threads/bulk/${action}`, { threadIds });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"], exact: false });\n      setSelectedThreadIds(new Set());\n      toast({ title: \"Action completed successfully\" });\n    },\n    onError: () => {\n      toast({\n        title: \"Action failed\",\n        description: \"Failed to perform bulk action\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleFolderChange = (folder: string) => {\n    setCurrentFolder(folder as FolderType);\n    setSelectedThread(null);\n    setSelectedThreadIds(new Set());\n  };\n\n  const handleFilterChange = (filter: FilterType) => {\n    if (currentFilter === filter) {\n      setCurrentFilter(null);\n    } else {\n      setCurrentFilter(filter);\n    }\n    setSelectedThreadIds(new Set());\n  };\n\n  const handleThreadSelect = (id: string) => {\n    setSelectedThread(id);\n    const thread = filteredThreads.find(t => t.id === id);\n    if (thread?.isUnread) {\n      updateThreadMutation.mutate({ threadId: id, updates: { isUnread: false } });\n    }\n  };\n\n  const handleThreadCheck = (id: string, checked: boolean) => {\n    const newSelected = new Set(selectedThreadIds);\n    if (checked) {\n      newSelected.add(id);\n    } else {\n      newSelected.delete(id);\n    }\n    setSelectedThreadIds(newSelected);\n  };\n\n  const handleStarToggle = (id: string, starred: boolean) => {\n    updateThreadMutation.mutate({ threadId: id, updates: { starred } });\n  };\n\n  const handleBulkAction = (action: \"read\" | \"unread\" | \"star\" | \"unstar\" | \"archive\") => {\n    const threadIds = Array.from(selectedThreadIds);\n    bulkActionMutation.mutate({ action, threadIds });\n  };\n\n  const handleSelectAll = () => {\n    if (selectedThreadIds.size === filteredThreads.length && filteredThreads.length > 0) {\n      setSelectedThreadIds(new Set());\n    } else {\n      setSelectedThreadIds(new Set(filteredThreads.map(t => t.id)));\n    }\n  };\n\n  const navigateThread = useCallback((direction: \"up\" | \"down\") => {\n    if (!selectedThread || filteredThreads.length === 0) {\n      if (filteredThreads.length > 0) {\n        setSelectedThread(filteredThreads[0].id);\n      }\n      return;\n    }\n\n    const currentIndex = filteredThreads.findIndex(t => t.id === selectedThread);\n    if (currentIndex === -1) return;\n\n    if (direction === \"up\" && currentIndex > 0) {\n      setSelectedThread(filteredThreads[currentIndex - 1].id);\n    } else if (direction === \"down\" && currentIndex < filteredThreads.length - 1) {\n      setSelectedThread(filteredThreads[currentIndex + 1].id);\n    }\n  }, [selectedThread, filteredThreads]);\n\n  useEffect(() => {\n    const handleKeyPress = (e: KeyboardEvent) => {\n      if ((e.target as HTMLElement).tagName === \"INPUT\" || \n          (e.target as HTMLElement).tagName === \"TEXTAREA\") {\n        return;\n      }\n\n      switch (e.key.toLowerCase()) {\n        case \"arrowup\":\n        case \"k\":\n          e.preventDefault();\n          navigateThread(\"up\");\n          break;\n        case \"arrowdown\":\n        case \"j\":\n          e.preventDefault();\n          navigateThread(\"down\");\n          break;\n        case \"r\":\n          if (selectedThread) {\n            setShowCompose(true);\n          }\n          break;\n        case \"a\":\n          if (selectedThread) {\n            updateThreadMutation.mutate({ \n              threadId: selectedThread, \n              updates: { archived: true } \n            });\n            setSelectedThread(null);\n          }\n          break;\n        case \"s\":\n          if (selectedThread) {\n            const thread = filteredThreads.find(t => t.id === selectedThread);\n            if (thread) {\n              updateThreadMutation.mutate({ \n                threadId: selectedThread, \n                updates: { starred: !thread.starred } \n              });\n            }\n          }\n          break;\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyPress);\n    return () => window.removeEventListener(\"keydown\", handleKeyPress);\n  }, [selectedThread, filteredThreads, navigateThread, updateThreadMutation]);\n\n  useEffect(() => {\n    const interval = setInterval(() => {\n      syncEmailsMutation.mutate();\n    }, 60000);\n\n    return () => clearInterval(interval);\n  }, []);\n\n  const selectedThreadData = filteredThreads.find(t => t.id === selectedThread);\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"inbox-page\">\n      <Navigation />\n      \n      <main className=\"flex h-[calc(100vh-64px)]\">\n        {/* Left Sidebar */}\n        <div className={cn(\n          \"border-r transition-all duration-300 flex-shrink-0\",\n          leftSidebarCollapsed ? \"w-0 overflow-hidden\" : \"w-64\"\n        )}>\n          {!leftSidebarCollapsed && (\n            <EmailSidebar\n              selectedFolder={currentFolder}\n              selectedFilter={currentFilter}\n              onFolderChange={handleFolderChange}\n              onFilterChange={handleFilterChange}\n              onCompose={() => setShowCompose(true)}\n              searchQuery={searchQuery}\n              onSearchChange={setSearchQuery}\n            />\n          )}\n        </div>\n\n        {/* Middle Column - Email List */}\n        <div className=\"w-80 flex flex-col border-r flex-shrink-0\">\n          {/* Header */}\n          <div className=\"border-b bg-inbox p-3\">\n            <div className=\"flex items-center justify-between mb-3\">\n              <div className=\"flex items-center gap-2\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setLeftSidebarCollapsed(!leftSidebarCollapsed)}\n                  data-testid=\"toggle-left-sidebar\"\n                >\n                  {leftSidebarCollapsed ? <ChevronRight className=\"h-4 w-4\" /> : <ChevronLeft className=\"h-4 w-4\" />}\n                </Button>\n                \n                {filteredThreads.length > 0 && (\n                  <Checkbox\n                    checked={selectedThreadIds.size === filteredThreads.length && filteredThreads.length > 0}\n                    onCheckedChange={handleSelectAll}\n                    data-testid=\"select-all-checkbox\"\n                  />\n                )}\n                \n                {selectedThreadIds.size > 0 && (\n                  <span className=\"text-sm text-muted-foreground ml-2\">\n                    {selectedThreadIds.size} selected\n                  </span>\n                )}\n              </div>\n\n              <div className=\"flex gap-1\">\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\"\n                  onClick={() => importAllEmailsMutation.mutate()}\n                  disabled={importAllEmailsMutation.isPending}\n                  data-testid=\"import-all-emails-button\"\n                  title=\"Import all emails from 2025-01-01\"\n                >\n                  <Download className={cn(\"h-4 w-4\", importAllEmailsMutation.isPending && \"animate-spin\")} />\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\"\n                  onClick={() => syncEmailsMutation.mutate()}\n                  disabled={syncEmailsMutation.isPending}\n                  data-testid=\"sync-emails-button\"\n                >\n                  <RefreshCw className={cn(\"h-4 w-4\", syncEmailsMutation.isPending && \"animate-spin\")} />\n                </Button>\n              </div>\n            </div>\n\n            {/* Bulk Actions */}\n            {selectedThreadIds.size > 0 && (\n              <div className=\"flex items-center gap-2\">\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => handleBulkAction(\"read\")}\n                  data-testid=\"bulk-mark-read\"\n                >\n                  <MailOpen className=\"h-3 w-3 mr-1\" />\n                  Mark Read\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => handleBulkAction(\"unread\")}\n                  data-testid=\"bulk-mark-unread\"\n                >\n                  <Mail className=\"h-3 w-3 mr-1\" />\n                  Mark Unread\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => handleBulkAction(\"star\")}\n                  data-testid=\"bulk-star\"\n                >\n                  <Star className=\"h-3 w-3 mr-1\" />\n                  Star\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => handleBulkAction(\"archive\")}\n                  data-testid=\"bulk-archive\"\n                >\n                  <ArchiveIcon className=\"h-3 w-3 mr-1\" />\n                  Archive\n                </Button>\n              </div>\n            )}\n          </div>\n\n          {/* Email List */}\n          <EmailList\n            threads={filteredThreads}\n            selectedThread={selectedThread}\n            selectedThreadIds={selectedThreadIds}\n            isLoading={isLoading}\n            onThreadSelect={handleThreadSelect}\n            onThreadCheck={handleThreadCheck}\n            onStarToggle={handleStarToggle}\n          />\n        </div>\n\n        {/* Right Panel - Thread View */}\n        <div className={cn(\n          \"transition-all duration-300 flex flex-col\",\n          rightPanelCollapsed ? \"w-0 overflow-hidden\" : \"flex-1\"\n        )}>\n          {!rightPanelCollapsed && (\n            <>\n              <div className=\"border-b p-4 flex items-center justify-between\">\n                <h2 className=\"font-semibold\">\n                  {selectedThreadData ? \"Email Thread\" : \"Select an email\"}\n                </h2>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={() => setRightPanelCollapsed(true)}\n                  data-testid=\"toggle-right-panel\"\n                >\n                  <ChevronRight className=\"h-4 w-4\" />\n                </Button>\n              </div>\n              \n              <div className=\"flex-1 overflow-y-auto\">\n                {selectedThreadData ? (\n                  <EmailThreadView \n                    threadId={selectedThreadData.id}\n                  />\n                ) : (\n                  <div className=\"flex items-center justify-center h-full text-muted-foreground\">\n                    <div className=\"text-center\">\n                      <Mail className=\"h-12 w-12 mx-auto mb-4 opacity-20\" />\n                      <p>Select an email to view</p>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </>\n          )}\n          \n          {rightPanelCollapsed && (\n            <div className=\"p-2\">\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={() => setRightPanelCollapsed(false)}\n                data-testid=\"expand-right-panel\"\n              >\n                <ChevronLeft className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          )}\n        </div>\n      </main>\n\n      <EmailCompose \n        open={showCompose}\n        onOpenChange={setShowCompose}\n      />\n    </div>\n  );\n}\n","size_bytes":16269},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/components/kanban/kanban-board.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { \n  Clock,\n  AlertTriangle,\n  User,\n  Calendar,\n  MoreHorizontal,\n  Plus\n} from \"lucide-react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport type { Repair } from \"@/lib/types\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\ninterface KanbanBoardProps {\n  repairs: Repair[];\n  isLoading: boolean;\n}\n\nexport function KanbanBoard({ repairs, isLoading }: KanbanBoardProps) {\n  const { toast } = useToast();\n\n  const updateRepairMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Repair> }) => {\n      const response = await fetch(`/api/repairs/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update repair\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/repairs\"] });\n      toast({\n        title: \"Repair updated\",\n        description: \"Repair status has been updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update repair\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const columns = [\n    {\n      id: 'new',\n      title: 'New',\n      color: 'bg-chart-4',\n      repairs: repairs.filter(r => r.status === 'new')\n    },\n    {\n      id: 'in_progress',\n      title: 'In Progress',\n      color: 'bg-primary',\n      repairs: repairs.filter(r => r.status === 'in_progress')\n    },\n    {\n      id: 'waiting',\n      title: 'Waiting',\n      color: 'bg-chart-1',\n      repairs: repairs.filter(r => r.status === 'waiting_customer' || r.status === 'waiting_part')\n    },\n    {\n      id: 'ready',\n      title: 'Ready',\n      color: 'bg-chart-2',\n      repairs: repairs.filter(r => r.status === 'ready')\n    },\n    {\n      id: 'closed',\n      title: 'Closed',\n      color: 'bg-muted-foreground',\n      repairs: repairs.filter(r => r.status === 'closed')\n    },\n  ];\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"border-destructive bg-destructive/10\";\n      case \"high\":\n        return \"border-chart-1 bg-chart-1/10\";\n      case \"medium\":\n        return \"border-chart-4 bg-chart-4/10\";\n      case \"low\":\n        return \"border-chart-2 bg-chart-2/10\";\n      default:\n        return \"border-border\";\n    }\n  };\n\n  const getPriorityVariant = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"destructive\";\n      case \"high\":\n        return \"destructive\";\n      case \"medium\":\n        return \"secondary\";\n      case \"low\":\n        return \"outline\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  const handleStatusChange = (repair: Repair, newStatus: string) => {\n    updateRepairMutation.mutate({\n      id: repair.id,\n      data: { status: newStatus as any }\n    });\n  };\n\n  const formatDate = (date: string | Date | null) => {\n    if (!date) return null;\n    const dateObj = typeof date === 'string' ? new Date(date) : date;\n    return dateObj.toLocaleDateString();\n  };\n\n  const isOverdue = (deadline: string | Date | null) => {\n    if (!deadline) return false;\n    const deadlineDate = typeof deadline === 'string' ? new Date(deadline) : deadline;\n    return deadlineDate < new Date();\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4\" data-testid=\"kanban-loading\">\n        {[...Array(5)].map((_, i) => (\n          <Card key={i} className=\"h-96\">\n            <CardHeader>\n              <div className=\"h-4 bg-muted rounded animate-pulse\"></div>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {[...Array(3)].map((_, j) => (\n                <div key={j} className=\"h-20 bg-muted rounded animate-pulse\"></div>\n              ))}\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4\" data-testid=\"kanban-board\">\n      {columns.map((column) => (\n        <Card key={column.id} className=\"flex flex-col h-[calc(100vh-300px)]\" data-testid={`kanban-column-${column.id}`}>\n          <CardHeader className=\"pb-3\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center space-x-2\">\n                <div className={`w-3 h-3 rounded-full ${column.color}`}></div>\n                <CardTitle className=\"text-sm font-medium\">{column.title}</CardTitle>\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  {column.repairs.length}\n                </Badge>\n              </div>\n              <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\">\n                <Plus className=\"h-3 w-3\" />\n              </Button>\n            </div>\n          </CardHeader>\n          \n          <CardContent className=\"flex-1 overflow-y-auto space-y-3 pb-3\">\n            {column.repairs.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                No repairs\n              </div>\n            ) : (\n              column.repairs.map((repair) => (\n                <Card\n                  key={repair.id}\n                  className={`cursor-pointer hover:shadow-md transition-all ${getPriorityColor(repair.priority || 'medium')}`}\n                  data-testid={`repair-card-${repair.id}`}\n                >\n                  <CardContent className=\"p-3\">\n                    <div className=\"flex items-start justify-between mb-2\">\n                      <h4 className=\"text-sm font-medium truncate flex-1 mr-2\">\n                        {repair.title}\n                      </h4>\n                      <DropdownMenu>\n                        <DropdownMenuTrigger asChild>\n                          <Button variant=\"ghost\" size=\"icon\" className=\"h-6 w-6\" data-testid={`repair-actions-${repair.id}`}>\n                            <MoreHorizontal className=\"h-3 w-3\" />\n                          </Button>\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent align=\"end\">\n                          <DropdownMenuItem onClick={() => handleStatusChange(repair, 'new')}>\n                            Move to New\n                          </DropdownMenuItem>\n                          <DropdownMenuItem onClick={() => handleStatusChange(repair, 'in_progress')}>\n                            Move to In Progress\n                          </DropdownMenuItem>\n                          <DropdownMenuItem onClick={() => handleStatusChange(repair, 'waiting_customer')}>\n                            Waiting for Customer\n                          </DropdownMenuItem>\n                          <DropdownMenuItem onClick={() => handleStatusChange(repair, 'ready')}>\n                            Mark as Ready\n                          </DropdownMenuItem>\n                          <DropdownMenuItem onClick={() => handleStatusChange(repair, 'closed')}>\n                            Close Repair\n                          </DropdownMenuItem>\n                        </DropdownMenuContent>\n                      </DropdownMenu>\n                    </div>\n                    \n                    {repair.description && (\n                      <p className=\"text-xs text-muted-foreground mb-3 line-clamp-2\">\n                        {repair.description}\n                      </p>\n                    )}\n                    \n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <Badge variant={getPriorityVariant(repair.priority || 'medium')} className=\"text-xs\">\n                          {(repair.priority || 'medium').charAt(0).toUpperCase() + (repair.priority || 'medium').slice(1)}\n                        </Badge>\n                        \n                        {repair.estimatedCost && (\n                          <span className=\"text-xs font-medium text-muted-foreground\">\n                            ‚Ç¨{((repair.estimatedCost || 0) / 100).toFixed(2)}\n                          </span>\n                        )}\n                      </div>\n                      \n                      {repair.slaDeadline && (\n                        <div className={`flex items-center space-x-1 text-xs ${\n                          isOverdue(repair.slaDeadline) ? 'text-destructive' : 'text-muted-foreground'\n                        }`}>\n                          <Calendar className=\"h-3 w-3\" />\n                          <span>Due: {formatDate(repair.slaDeadline)}</span>\n                          {isOverdue(repair.slaDeadline) && (\n                            <AlertTriangle className=\"h-3 w-3 ml-1\" />\n                          )}\n                        </div>\n                      )}\n                      \n                      {repair.assignedUserId && (\n                        <div className=\"flex items-center space-x-1\">\n                          <Avatar className=\"h-4 w-4\">\n                            <AvatarFallback className=\"text-xs\">\n                              {repair.assignedUserId.substring(0, 2).toUpperCase()}\n                            </AvatarFallback>\n                          </Avatar>\n                          <span className=\"text-xs text-muted-foreground\">Assigned</span>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))\n            )}\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}\n","size_bytes":10096},"server/services/shopifyClient.ts":{"content":"export interface ShopifyOrder {\n  id: number;\n  order_number: string;\n  name: string;\n  email: string;\n  total_price: string;\n  currency: string;\n  financial_status: string;\n  fulfillment_status: string | null;\n  created_at: string;\n  updated_at: string;\n  customer: {\n    id: number;\n    email: string;\n    first_name: string;\n    last_name: string;\n  } | null;\n  line_items: Array<{\n    id: number;\n    title: string;\n    quantity: number;\n    price: string;\n  }>;\n}\n\nclass ShopifyClient {\n  private accessToken: string;\n  private shopDomain: string;\n  private baseUrl: string;\n\n  constructor() {\n    // Support both old and new credential formats\n    this.accessToken = process.env.SHOPIFY_ACCESS_TOKEN || process.env.SHOPIFY_PASSWORD || '';\n    this.shopDomain = process.env.SHOPIFY_SHOP_DOMAIN || '';\n    \n    console.log('Shopify Client initialized with:', {\n      hasAccessToken: !!this.accessToken,\n      shopDomain: this.shopDomain,\n      tokenLength: this.accessToken.length\n    });\n    \n    // Ensure proper domain format\n    let domain = this.shopDomain;\n    if (!domain.includes('.myshopify.com')) {\n      domain = `${domain}.myshopify.com`;\n    }\n    \n    this.baseUrl = `https://${domain}/admin/api/2024-01`;\n  }\n\n  private async makeRequest(endpoint: string, options: RequestInit = {}) {\n    const url = `${this.baseUrl}${endpoint}`;\n    \n    if (!this.accessToken || !this.shopDomain) {\n      throw new Error('Shopify credentials not configured. Please set SHOPIFY_ACCESS_TOKEN and SHOPIFY_SHOP_DOMAIN environment variables.');\n    }\n    \n    console.log('Making Shopify API request:', {\n      url,\n      hasToken: !!this.accessToken,\n      tokenPrefix: this.accessToken.substring(0, 8) + '...',\n    });\n    \n    const response = await fetch(url, {\n      ...options,\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Shopify-Access-Token': this.accessToken,\n        ...options.headers,\n      },\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      console.error('Shopify API Error:', {\n        status: response.status,\n        statusText: response.statusText,\n        url,\n        errorText\n      });\n      throw new Error(`Shopify API error: ${response.status} ${response.statusText} - ${errorText}`);\n    }\n\n    const result = await response.json();\n    console.log('Shopify API response received for:', endpoint);\n    return result;\n  }\n\n  async getOrders(params: {\n    limit?: number;\n    since_id?: string;\n    created_at_min?: string;\n    status?: string;\n  } = {}) {\n    const searchParams = new URLSearchParams();\n    \n    Object.entries(params).forEach(([key, value]) => {\n      if (value) {\n        searchParams.append(key, value.toString());\n      }\n    });\n\n    const endpoint = `/orders.json${searchParams.toString() ? `?${searchParams.toString()}` : ''}`;\n    const response = await this.makeRequest(endpoint);\n    \n    return response.orders as ShopifyOrder[];\n  }\n\n  async getAllOrders(onProgress?: (processed: number, total?: number) => void) {\n    const allOrders: ShopifyOrder[] = [];\n    let sinceId: string | undefined = undefined;\n    const batchSize = 250; // Shopify's max limit per request\n    let hasMore = true;\n    let batchCount = 0;\n\n    console.log('Starting to fetch all orders from Shopify...');\n\n    while (hasMore) {\n      batchCount++;\n      console.log(`Fetching batch ${batchCount} (limit: ${batchSize}${sinceId ? `, since_id: ${sinceId}` : ''})`);\n\n      const params: any = {\n        limit: batchSize,\n        status: 'any' // Include all order statuses\n      };\n\n      if (sinceId) {\n        params.since_id = sinceId;\n      }\n\n      const batchOrders = await this.getOrders(params);\n      \n      if (batchOrders.length === 0) {\n        hasMore = false;\n        break;\n      }\n\n      allOrders.push(...batchOrders);\n      \n      // Update progress callback\n      if (onProgress) {\n        onProgress(allOrders.length);\n      }\n\n      console.log(`Batch ${batchCount}: Retrieved ${batchOrders.length} orders (total: ${allOrders.length})`);\n\n      // If we got fewer orders than the limit, we've reached the end\n      if (batchOrders.length < batchSize) {\n        hasMore = false;\n      } else {\n        // Set since_id to the last order's ID for pagination\n        sinceId = batchOrders[batchOrders.length - 1].id.toString();\n      }\n\n      // Add a small delay to be respectful to Shopify's API\n      await new Promise(resolve => setTimeout(resolve, 250));\n    }\n\n    console.log(`‚úÖ Completed fetching all orders: ${allOrders.length} total orders retrieved`);\n    return allOrders;\n  }\n\n  async getOrdersSinceDate(sinceDate: Date, onProgress?: (processed: number) => void) {\n    const allOrders: ShopifyOrder[] = [];\n    const batchSize = 250;\n    let hasMore = true;\n    let batchCount = 0;\n    let sinceId: string | undefined = undefined;\n    \n    const createdAtMin = sinceDate.toISOString();\n    console.log(`üìÖ Starting to fetch orders created since: ${createdAtMin}`);\n\n    while (hasMore) {\n      batchCount++;\n      console.log(`Fetching batch ${batchCount} (limit: ${batchSize}, created_at_min: ${createdAtMin}${sinceId ? `, since_id: ${sinceId}` : ''})`);\n\n      const params: any = {\n        limit: batchSize,\n        status: 'any',\n        created_at_min: createdAtMin\n      };\n\n      // Use since_id for pagination within the date range\n      if (sinceId) {\n        params.since_id = sinceId;\n      }\n\n      const batchOrders = await this.getOrders(params);\n      \n      if (batchOrders.length === 0) {\n        hasMore = false;\n        break;\n      }\n\n      allOrders.push(...batchOrders);\n      \n      if (onProgress) {\n        onProgress(allOrders.length);\n      }\n\n      console.log(`Batch ${batchCount}: Retrieved ${batchOrders.length} orders (total: ${allOrders.length})`);\n\n      if (batchOrders.length < batchSize) {\n        hasMore = false;\n      } else {\n        sinceId = batchOrders[batchOrders.length - 1].id.toString();\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 250));\n    }\n\n    console.log(`‚úÖ Completed date-based sync: ${allOrders.length} orders retrieved since ${createdAtMin}`);\n    return allOrders;\n  }\n\n  async getAllCustomers(onProgress?: (processed: number, total?: number) => void) {\n    const allCustomers: any[] = [];\n    let sinceId: string | undefined = undefined;\n    const batchSize = 250;\n    let hasMore = true;\n    let batchCount = 0;\n\n    console.log('Starting to fetch all customers from Shopify...');\n\n    while (hasMore) {\n      batchCount++;\n      console.log(`Fetching customer batch ${batchCount} (limit: ${batchSize}${sinceId ? `, since_id: ${sinceId}` : ''})`);\n\n      const params: any = {\n        limit: batchSize\n      };\n\n      if (sinceId) {\n        params.since_id = sinceId;\n      }\n\n      const batchCustomers = await this.getCustomers(params);\n      \n      if (batchCustomers.length === 0) {\n        hasMore = false;\n        break;\n      }\n\n      allCustomers.push(...batchCustomers);\n      \n      if (onProgress) {\n        onProgress(allCustomers.length);\n      }\n\n      console.log(`Customer batch ${batchCount}: Retrieved ${batchCustomers.length} customers (total: ${allCustomers.length})`);\n\n      if (batchCustomers.length < batchSize) {\n        hasMore = false;\n      } else {\n        sinceId = batchCustomers[batchCustomers.length - 1].id.toString();\n      }\n\n      await new Promise(resolve => setTimeout(resolve, 250));\n    }\n\n    console.log(`‚úÖ Completed fetching all customers: ${allCustomers.length} total customers retrieved`);\n    return allCustomers;\n  }\n\n  async getOrder(orderId: string) {\n    const response = await this.makeRequest(`/orders/${orderId}.json`);\n    return response.order as ShopifyOrder;\n  }\n\n  async getCustomers(params: {\n    limit?: number;\n    since_id?: string;\n  } = {}) {\n    const searchParams = new URLSearchParams();\n    \n    Object.entries(params).forEach(([key, value]) => {\n      if (value) {\n        searchParams.append(key, value.toString());\n      }\n    });\n\n    const endpoint = `/customers.json${searchParams.toString() ? `?${searchParams.toString()}` : ''}`;\n    const response = await this.makeRequest(endpoint);\n    \n    return response.customers;\n  }\n\n  async updateOrderStatus(orderId: string, status: string) {\n    const response = await this.makeRequest(`/orders/${orderId}.json`, {\n      method: 'PUT',\n      body: JSON.stringify({\n        order: {\n          id: orderId,\n          financial_status: status\n        }\n      })\n    });\n\n    return response.order;\n  }\n}\n\nexport const shopifyClient = new ShopifyClient();\n","size_bytes":8586},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/search/global-search.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Search } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport type { SearchResults } from \"@/lib/types\";\n\nexport function GlobalSearch() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [showResults, setShowResults] = useState(false);\n  const [, setLocation] = useLocation();\n  const searchRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  const { data: searchResults, isLoading } = useQuery<SearchResults>({\n    queryKey: [`/api/search?q=${searchQuery}`],\n    enabled: searchQuery.length > 2,\n  });\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if ((e.metaKey || e.ctrlKey) && e.key === \"k\") {\n        e.preventDefault();\n        inputRef.current?.focus();\n      }\n      if (e.key === \"Escape\") {\n        setShowResults(false);\n        inputRef.current?.blur();\n      }\n    };\n\n    const handleClickOutside = (e: MouseEvent) => {\n      if (searchRef.current && !searchRef.current.contains(e.target as Node)) {\n        setShowResults(false);\n      }\n    };\n\n    document.addEventListener(\"keydown\", handleKeyDown);\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => {\n      document.removeEventListener(\"keydown\", handleKeyDown);\n      document.removeEventListener(\"mousedown\", handleClickOutside);\n    };\n  }, []);\n\n  const handleNavigate = (type: string, id: string, orderNumber?: string) => {\n    switch (type) {\n      case 'customer':\n        setLocation(`/customers/${id}`);\n        break;\n      case 'order':\n        setLocation(`/orders?orderId=${id}`);\n        break;\n      case 'thread':\n        setLocation('/inbox');\n        break;\n      case 'repair':\n        setLocation('/repairs');\n        break;\n    }\n    setShowResults(false);\n    setSearchQuery(\"\");\n  };\n\n  return (\n    <div className=\"relative\" ref={searchRef}>\n      <div className=\"relative\">\n        <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n        <Input\n          ref={inputRef}\n          type=\"text\"\n          placeholder=\"Search customers, orders, threads...\"\n          className=\"h-9 w-64 pl-10 pr-12\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          onFocus={() => setShowResults(true)}\n          data-testid=\"global-search-input\"\n        />\n        <div className=\"absolute right-3 top-1/2 -translate-y-1/2 text-xs text-muted-foreground\">\n          ‚åòK\n        </div>\n      </div>\n\n      {showResults && searchQuery.length > 2 && (\n        <div className=\"absolute top-full left-0 right-0 mt-1 bg-popover border border-border rounded-md shadow-lg z-50\" data-testid=\"search-results\">\n          {isLoading ? (\n            <div className=\"p-4 text-sm text-muted-foreground\">Searching...</div>\n          ) : searchResults ? (\n            <div className=\"max-h-80 overflow-y-auto\">\n              {searchResults.customers.length > 0 && (\n                <div className=\"p-2\">\n                  <h4 className=\"text-xs font-medium text-muted-foreground mb-1\">Customers</h4>\n                  {searchResults.customers.map((customer) => (\n                    <div\n                      key={customer.id}\n                      className=\"p-2 hover:bg-accent rounded cursor-pointer\"\n                      onClick={() => handleNavigate('customer', customer.id)}\n                      data-testid={`search-result-customer-${customer.id}`}\n                    >\n                      <div className=\"font-medium\">{customer.firstName} {customer.lastName}</div>\n                      <div className=\"text-sm text-muted-foreground\">{customer.email}</div>\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              {searchResults.orders.length > 0 && (\n                <div className=\"p-2\">\n                  <h4 className=\"text-xs font-medium text-muted-foreground mb-1\">Orders</h4>\n                  {searchResults.orders.map((order) => (\n                    <div\n                      key={order.id}\n                      className=\"p-2 hover:bg-accent rounded cursor-pointer\"\n                      onClick={() => handleNavigate('order', order.id, order.orderNumber)}\n                      data-testid={`search-result-order-${order.id}`}\n                    >\n                      <div className=\"font-medium\">Order #{order.orderNumber}</div>\n                      <div className=\"text-sm text-muted-foreground\">{order.customerEmail}</div>\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              {searchResults.emailThreads.length > 0 && (\n                <div className=\"p-2\">\n                  <h4 className=\"text-xs font-medium text-muted-foreground mb-1\">Email Threads</h4>\n                  {searchResults.emailThreads.map((thread) => (\n                    <div\n                      key={thread.id}\n                      className=\"p-2 hover:bg-accent rounded cursor-pointer\"\n                      onClick={() => handleNavigate('thread', thread.id)}\n                      data-testid={`search-result-thread-${thread.id}`}\n                    >\n                      <div className=\"font-medium\">{thread.subject}</div>\n                      <div className=\"text-sm text-muted-foreground\">{thread.customerEmail}</div>\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              {searchResults.repairs.length > 0 && (\n                <div className=\"p-2\">\n                  <h4 className=\"text-xs font-medium text-muted-foreground mb-1\">Repairs</h4>\n                  {searchResults.repairs.map((repair) => (\n                    <div\n                      key={repair.id}\n                      className=\"p-2 hover:bg-accent rounded cursor-pointer\"\n                      onClick={() => handleNavigate('repair', repair.id)}\n                      data-testid={`search-result-repair-${repair.id}`}\n                    >\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <div className=\"text-sm font-medium\">{repair.title}</div>\n                          <div className=\"text-xs text-muted-foreground\">\n                            Status: {repair.status} ‚Ä¢ Priority: {repair.priority}\n                          </div>\n                        </div>\n                        {repair.estimatedCost && (\n                          <div className=\"text-xs font-medium\">\n                            ‚Ç¨{((repair.estimatedCost || 0) / 100).toFixed(2)}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n\n              {searchResults.customers.length === 0 && \n               searchResults.orders.length === 0 && \n               searchResults.emailThreads.length === 0 && \n               searchResults.repairs.length === 0 && (\n                <div className=\"p-4 text-sm text-muted-foreground\">No results found</div>\n              )}\n            </div>\n          ) : null}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":7310},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":971},"client/src/components/email/email-list-skeleton.tsx":{"content":"import { Skeleton } from \"@/components/ui/skeleton\";\n\nexport function EmailListSkeleton() {\n  return (\n    <div className=\"space-y-0\" data-testid=\"email-list-skeleton\">\n      {Array.from({ length: 5 }).map((_, i) => (\n        <div\n          key={i}\n          className=\"border-b border-border p-4 hover:bg-accent/50 transition-colors\"\n        >\n          <div className=\"flex items-start gap-3\">\n            <Skeleton className=\"h-4 w-4 mt-1\" />\n            <div className=\"flex-1 space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <Skeleton className=\"h-4 w-32\" />\n                <Skeleton className=\"h-3 w-16\" />\n              </div>\n              <Skeleton className=\"h-4 w-3/4\" />\n              <Skeleton className=\"h-3 w-full\" />\n            </div>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n","size_bytes":858},"client/src/components/auth/login-form.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { useAuth } from \"@/lib/auth\";\nimport { Eye, EyeOff, LogIn } from \"lucide-react\";\n\nconst loginSchema = z.object({\n  email: z.string().email(\"Please enter a valid email address\"),\n  password: z.string().min(1, \"Password is required\"),\n});\n\ntype LoginForm = z.infer<typeof loginSchema>;\n\nexport function LoginForm() {\n  const [showPassword, setShowPassword] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const { signIn } = useAuth();\n\n  const form = useForm<LoginForm>({\n    resolver: zodResolver(loginSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n    },\n  });\n\n  const onSubmit = async (data: LoginForm) => {\n    setIsLoading(true);\n    try {\n      await signIn(data.email, data.password);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const logoUrl = `${import.meta.env.VITE_SUPABASE_URL}/storage/v1/object/public/extra-files/dutchthrift-logo-small.jpg`;\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <img \n              src={logoUrl} \n              alt=\"DutchThrift Logo\" \n              className=\"h-16 w-16 object-cover rounded-lg\"\n              data-testid=\"login-logo\"\n            />\n          </div>\n          <CardDescription>\n            Sign in to access the admin panel\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Email</FormLabel>\n                    <FormControl>\n                      <Input\n                        {...field}\n                        type=\"email\"\n                        placeholder=\"Enter your email\"\n                        disabled={isLoading}\n                        data-testid=\"login-email-input\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"password\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Password</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Input\n                          {...field}\n                          type={showPassword ? \"text\" : \"password\"}\n                          placeholder=\"Enter your password\"\n                          disabled={isLoading}\n                          data-testid=\"login-password-input\"\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          className=\"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\n                          onClick={() => setShowPassword(!showPassword)}\n                          disabled={isLoading}\n                          data-testid=\"toggle-password-visibility\"\n                        >\n                          {showPassword ? (\n                            <EyeOff className=\"h-4 w-4\" />\n                          ) : (\n                            <Eye className=\"h-4 w-4\" />\n                          )}\n                          <span className=\"sr-only\">\n                            {showPassword ? \"Hide\" : \"Show\"} password\n                          </span>\n                        </Button>\n                      </div>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={isLoading}\n                data-testid=\"login-submit-button\"\n              >\n                {isLoading ? (\n                  <>\n                    <div className=\"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-background border-t-current\" />\n                    Signing in...\n                  </>\n                ) : (\n                  <>\n                    <LogIn className=\"mr-2 h-4 w-4\" />\n                    Sign In\n                  </>\n                )}\n              </Button>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}","size_bytes":5125},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"server/services/outlookProvider.ts":{"content":"import { getUncachableOutlookClient } from '../outlookClient';\nimport type { EmailProvider, RawEmail } from './emailProvider';\n\nexport class OutlookProvider implements EmailProvider {\n  async syncEmails(): Promise<RawEmail[]> {\n    try {\n      const client = await getUncachableOutlookClient();\n      \n      // Get recent emails\n      const emails = await client\n        .api('/me/messages')\n        .top(50)\n        .orderby('receivedDateTime desc')\n        .get();\n\n      return emails.value.map((email: any): RawEmail => ({\n        messageId: email.id,\n        conversationId: email.conversationId,\n        subject: email.subject || '',\n        from: email.sender?.emailAddress?.address || '',\n        to: email.toRecipients?.[0]?.emailAddress?.address || '',\n        body: email.body?.content || '',\n        isHtml: email.body?.contentType === 'HTML',\n        receivedDateTime: email.receivedDateTime,\n        isRead: email.isRead || false,\n        hasAttachment: email.hasAttachments || false,\n        inReplyTo: email.internetMessageHeaders?.find((h: any) => h.name === 'In-Reply-To')?.value,\n        references: email.internetMessageHeaders?.find((h: any) => h.name === 'References')?.value\n      }));\n    } catch (error) {\n      console.error('Error syncing emails via Outlook:', error);\n      throw error;\n    }\n  }\n\n  async sendEmail(to: string, subject: string, body: string, replyToMessageId?: string): Promise<{ success: boolean }> {\n    try {\n      const client = await getUncachableOutlookClient();\n      \n      const message: any = {\n        message: {\n          subject: subject,\n          body: {\n            contentType: 'HTML',\n            content: body\n          },\n          toRecipients: [\n            {\n              emailAddress: {\n                address: to\n              }\n            }\n          ]\n        }\n      };\n\n      // Add reply headers if this is a reply\n      if (replyToMessageId) {\n        message.message.internetMessageHeaders = [\n          { name: 'In-Reply-To', value: replyToMessageId },\n          { name: 'References', value: replyToMessageId }\n        ];\n      }\n\n      await client.api('/me/sendMail').post(message);\n      \n      return { success: true };\n    } catch (error) {\n      console.error('Error sending email via Outlook:', error);\n      throw error;\n    }\n  }\n}","size_bytes":2321},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-xl border border-border bg-card text-card-foreground shadow-card transition-all duration-300 hover:shadow-card-hover\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-2 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground leading-relaxed\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","size_bytes":1939},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-lg border p-4 text-popover-foreground outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        \"bg-white border-border shadow-[0_4px_16px_rgba(0,0,0,0.08)]\",\n        \"dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-lg\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1429},"client/src/components/widgets/business-metrics-widget.tsx":{"content":"import { TrendingUp, TrendingDown, DollarSign, Users, Calendar, Target } from \"lucide-react\";\nimport { createElement } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Order, Repair, Customer } from \"@/lib/types\";\n\ninterface BusinessMetrics {\n  weeklyRevenue: number;\n  weeklyRevenueChange: number;\n  monthlyCustomers: number;\n  monthlyCustomersChange: number;\n  avgRepairTime: number;\n  repairTimeChange: number;\n  customerSatisfaction: number;\n  satisfactionChange: number;\n}\n\nexport function BusinessMetricsWidget() {\n  const { data: orders, isLoading: ordersLoading } = useQuery<Order[]>({\n    queryKey: [\"/api/orders\"],\n  });\n\n  const { data: repairs, isLoading: repairsLoading } = useQuery<Repair[]>({\n    queryKey: [\"/api/repairs\"],\n  });\n\n  const { data: customers, isLoading: customersLoading } = useQuery<Customer[]>({\n    queryKey: [\"/api/customers\"],\n  });\n\n  const isLoading = ordersLoading || repairsLoading || customersLoading;\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"business-metrics-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse grid grid-cols-2 md:grid-cols-4 gap-4\">\n            {[1, 2, 3, 4].map((i) => (\n              <div key={i} className=\"space-y-2\">\n                <div className=\"h-4 bg-muted rounded\"></div>\n                <div className=\"h-8 bg-muted rounded\"></div>\n                <div className=\"h-3 bg-muted rounded w-3/4\"></div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  // Calculate business metrics\n  const now = new Date();\n  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n  const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n  const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);\n\n  // Weekly revenue\n  const thisWeekOrders = orders?.filter(order => \n    order.createdAt && new Date(order.createdAt) >= weekAgo\n  ) || [];\n  const lastWeekOrders = orders?.filter(order => \n    order.createdAt && \n    new Date(order.createdAt) >= twoWeeksAgo && \n    new Date(order.createdAt) < weekAgo\n  ) || [];\n\n  const thisWeekRevenue = thisWeekOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0) / 100;\n  const lastWeekRevenue = lastWeekOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0) / 100;\n  const revenueChange = lastWeekRevenue > 0 ? ((thisWeekRevenue - lastWeekRevenue) / lastWeekRevenue) * 100 : 0;\n\n  // Monthly new customers\n  const newCustomersThisMonth = customers?.filter(customer => \n    customer.createdAt && new Date(customer.createdAt) >= monthAgo\n  ).length || 0;\n  \n  const newCustomersLastMonth = customers?.filter(customer => \n    customer.createdAt && \n    new Date(customer.createdAt) >= new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000) && // 60 days ago\n    new Date(customer.createdAt) < monthAgo\n  ).length || 0;\n  \n  const customersChange = newCustomersLastMonth > 0 ? \n    ((newCustomersThisMonth - newCustomersLastMonth) / newCustomersLastMonth) * 100 : 0;\n\n  // Real average repair time calculation\n  const closedRepairs = repairs?.filter(repair => \n    repair.status === 'closed' && repair.createdAt && repair.completedAt\n  ) || [];\n  \n  let avgRepairDays = 0;\n  let lastMonthAvgRepairDays = 0;\n  \n  if (closedRepairs.length > 0) {\n    const recentClosedRepairs = closedRepairs.filter(repair => \n      repair.completedAt && new Date(repair.completedAt) >= monthAgo\n    );\n    \n    const oldClosedRepairs = closedRepairs.filter(repair => \n      repair.completedAt && \n      new Date(repair.completedAt) >= new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000) &&\n      new Date(repair.completedAt) < monthAgo\n    );\n    \n    if (recentClosedRepairs.length > 0) {\n      const totalDays = recentClosedRepairs.reduce((sum, repair) => {\n        const created = new Date(repair.createdAt!);\n        const completed = new Date(repair.completedAt!);\n        return sum + Math.ceil((completed.getTime() - created.getTime()) / (1000 * 60 * 60 * 24));\n      }, 0);\n      avgRepairDays = totalDays / recentClosedRepairs.length;\n    }\n    \n    if (oldClosedRepairs.length > 0) {\n      const totalOldDays = oldClosedRepairs.reduce((sum, repair) => {\n        const created = new Date(repair.createdAt!);\n        const completed = new Date(repair.completedAt!);\n        return sum + Math.ceil((completed.getTime() - created.getTime()) / (1000 * 60 * 60 * 24));\n      }, 0);\n      lastMonthAvgRepairDays = totalOldDays / oldClosedRepairs.length;\n    }\n  }\n  \n  const repairTimeChange = lastMonthAvgRepairDays > 0 ? \n    ((avgRepairDays - lastMonthAvgRepairDays) / lastMonthAvgRepairDays) * 100 : 0;\n  \n  // Real customer satisfaction based on repair SLA performance\n  const totalRepairs = repairs?.length || 0;\n  const recentRepairs = repairs?.filter(repair => \n    repair.createdAt && new Date(repair.createdAt) >= monthAgo\n  ) || [];\n  \n  const oldRepairs = repairs?.filter(repair => \n    repair.createdAt && \n    new Date(repair.createdAt) >= new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000) &&\n    new Date(repair.createdAt) < monthAgo\n  ) || [];\n  \n  // Calculate satisfaction based on repairs closed within reasonable time (< 7 days)\n  const satisfiedRecentRepairs = recentRepairs.filter(repair => {\n    if (repair.status !== 'closed' || !repair.createdAt || !repair.completedAt) return false;\n    const repairDays = Math.ceil((new Date(repair.completedAt).getTime() - new Date(repair.createdAt).getTime()) / (1000 * 60 * 60 * 24));\n    return repairDays <= 7; // Satisfied if completed within a week\n  }).length;\n  \n  const satisfiedOldRepairs = oldRepairs.filter(repair => {\n    if (repair.status !== 'closed' || !repair.createdAt || !repair.completedAt) return false;\n    const repairDays = Math.ceil((new Date(repair.completedAt).getTime() - new Date(repair.createdAt).getTime()) / (1000 * 60 * 60 * 24));\n    return repairDays <= 7;\n  }).length;\n  \n  const satisfactionRate = recentRepairs.length > 0 ? (satisfiedRecentRepairs / recentRepairs.length) * 100 : 0;\n  const oldSatisfactionRate = oldRepairs.length > 0 ? (satisfiedOldRepairs / oldRepairs.length) * 100 : 0;\n  \n  const satisfactionChange = oldSatisfactionRate > 0 ? satisfactionRate - oldSatisfactionRate : 0;\n\n  const metrics: BusinessMetrics = {\n    weeklyRevenue: thisWeekRevenue / 100, // Convert from cents to euros\n    weeklyRevenueChange: revenueChange,\n    monthlyCustomers: newCustomersThisMonth,\n    monthlyCustomersChange: customersChange,\n    avgRepairTime: avgRepairDays,\n    repairTimeChange: repairTimeChange,\n    customerSatisfaction: satisfactionRate,\n    satisfactionChange: satisfactionChange,\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat('nl-NL', {\n      style: 'currency',\n      currency: 'EUR',\n    }).format(amount);\n  };\n\n  const formatPercentage = (value: number) => {\n    return `${value > 0 ? '+' : ''}${value.toFixed(1)}%`;\n  };\n\n  const getTrendIcon = (change: number) => {\n    return change > 0 ? TrendingUp : TrendingDown;\n  };\n\n  const getTrendColor = (change: number, inverse = false) => {\n    const positive = inverse ? change < 0 : change > 0;\n    return positive ? \"text-chart-2\" : \"text-destructive\";\n  };\n\n  return (\n    <Card data-testid=\"business-metrics-widget\">\n      <CardHeader>\n        <CardTitle className=\"flex items-center gap-2\">\n          <Target className=\"h-5 w-5\" />\n          Business Performance\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n          {/* Weekly Revenue */}\n          <div className=\"space-y-2\" data-testid=\"weekly-revenue-metric\">\n            <div className=\"flex items-center gap-1\">\n              <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground\">Weekly Revenue</span>\n            </div>\n            <div className=\"text-xl font-bold\">\n              {formatCurrency(metrics.weeklyRevenue)}\n            </div>\n            <div className=\"flex items-center gap-1 text-xs\">\n              {createElement(getTrendIcon(metrics.weeklyRevenueChange), {\n                className: `h-3 w-3 ${getTrendColor(metrics.weeklyRevenueChange)}`\n              })}\n              <span className={getTrendColor(metrics.weeklyRevenueChange)}>\n                {formatPercentage(metrics.weeklyRevenueChange)}\n              </span>\n              <span className=\"text-muted-foreground\">vs last week</span>\n            </div>\n          </div>\n\n          {/* Monthly Customers */}\n          <div className=\"space-y-2\" data-testid=\"monthly-customers-metric\">\n            <div className=\"flex items-center gap-1\">\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground\">New Customers</span>\n            </div>\n            <div className=\"text-xl font-bold\">\n              {metrics.monthlyCustomers}\n            </div>\n            <div className=\"flex items-center gap-1 text-xs\">\n              {createElement(getTrendIcon(metrics.monthlyCustomersChange), {\n                className: `h-3 w-3 ${getTrendColor(metrics.monthlyCustomersChange)}`\n              })}\n              <span className={getTrendColor(metrics.monthlyCustomersChange)}>\n                {formatPercentage(metrics.monthlyCustomersChange)}\n              </span>\n              <span className=\"text-muted-foreground\">this month</span>\n            </div>\n          </div>\n\n          {/* Average Repair Time */}\n          <div className=\"space-y-2\" data-testid=\"repair-time-metric\">\n            <div className=\"flex items-center gap-1\">\n              <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground\">Avg Repair Time</span>\n            </div>\n            <div className=\"text-xl font-bold\">\n              {metrics.avgRepairTime.toFixed(1)} days\n            </div>\n            <div className=\"flex items-center gap-1 text-xs\">\n              {createElement(getTrendIcon(metrics.repairTimeChange), {\n                className: `h-3 w-3 ${getTrendColor(metrics.repairTimeChange, true)}`\n              })}\n              <span className={getTrendColor(metrics.repairTimeChange, true)}>\n                {formatPercentage(metrics.repairTimeChange)}\n              </span>\n              <span className=\"text-muted-foreground\">improvement</span>\n            </div>\n          </div>\n\n          {/* Customer Satisfaction */}\n          <div className=\"space-y-2\" data-testid=\"satisfaction-metric\">\n            <div className=\"flex items-center gap-1\">\n              <Target className=\"h-4 w-4 text-muted-foreground\" />\n              <span className=\"text-xs text-muted-foreground\">Satisfaction</span>\n            </div>\n            <div className=\"text-xl font-bold\">\n              {metrics.customerSatisfaction.toFixed(0)}%\n            </div>\n            <div className=\"flex items-center gap-1 text-xs\">\n              {createElement(getTrendIcon(metrics.satisfactionChange), {\n                className: `h-3 w-3 ${getTrendColor(metrics.satisfactionChange)}`\n              })}\n              <span className={getTrendColor(metrics.satisfactionChange)}>\n                {formatPercentage(metrics.satisfactionChange)}\n              </span>\n              <span className=\"text-muted-foreground\">rating</span>\n            </div>\n          </div>\n        </div>\n\n        {/* Performance Badges */}\n        <div className=\"flex flex-wrap gap-2 mt-4 pt-4 border-t border-border\">\n          {metrics.weeklyRevenueChange > 0 && (\n            <Badge variant=\"default\" className=\"text-xs\">\n              Revenue Growing\n            </Badge>\n          )}\n          {metrics.monthlyCustomers > 5 && (\n            <Badge variant=\"secondary\" className=\"text-xs\">\n              Strong Acquisition\n            </Badge>\n          )}\n          {metrics.avgRepairTime < 5 && (\n            <Badge variant=\"outline\" className=\"text-xs\">\n              Fast Turnaround\n            </Badge>\n          )}\n          {metrics.customerSatisfaction > 90 && (\n            <Badge variant=\"default\" className=\"text-xs\">\n              High Satisfaction\n            </Badge>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","size_bytes":12411},"client/src/components/email/email-thread-view.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { RichTextEditor } from \"@/components/ui/rich-text-editor\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Reply,\n  Forward,\n  Archive,\n  Tag,\n  User,\n  Paperclip,\n  Clock,\n  ExternalLink,\n  Send,\n  Briefcase,\n  ShoppingCart,\n  Mail,\n  UserCircle,\n  Link as LinkIcon,\n  Package\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { EmailThread, EmailMessage, Case, OrderWithShopifyData } from \"@/lib/types\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CreateCaseModal } from \"@/components/forms/create-case-modal\";\nimport { EmailAttachments } from \"./email-attachments\";\nimport { SanitizedEmailContent } from \"./sanitized-email-content\";\nimport { EmailThreadSkeleton } from \"./email-thread-skeleton\";\nimport { cn } from \"@/lib/utils\";\n\ninterface EmailThreadViewProps {\n  threadId: string;\n}\n\ninterface ThreadWithMessages extends EmailThread {\n  messages: EmailMessage[];\n}\n\nexport function EmailThreadView({ threadId }: EmailThreadViewProps) {\n  const [replyText, setReplyText] = useState(\"\");\n  const [showReply, setShowReply] = useState(false);\n  const [showCreateCase, setShowCreateCase] = useState(false);\n  const [selectedCaseId, setSelectedCaseId] = useState<string>(\"\");\n  const [selectedOrderId, setSelectedOrderId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const { data: thread, isLoading } = useQuery<ThreadWithMessages>({\n    queryKey: [\"/api/email-threads\", threadId],\n  });\n\n  // Get all available cases for linking  \n  const { data: allCases } = useQuery<Case[]>({\n    queryKey: [\"/api/cases\"],\n    enabled: true,\n  });\n\n  // Get linked cases for this thread\n  const { data: linkedCases } = useQuery<Case[]>({\n    queryKey: [\"/api/cases\", \"linked\", threadId],\n    enabled: true,\n  });\n\n  // Get all available orders for linking  \n  const { data: allOrders } = useQuery<OrderWithShopifyData[]>({\n    queryKey: [\"/api/orders\"],\n    enabled: true,\n  });\n\n  // Get the linked order details when thread has an orderId\n  const { data: linkedOrder } = useQuery<OrderWithShopifyData>({\n    queryKey: [\"/api/orders\", thread?.orderId],\n    enabled: !!thread?.orderId,\n  });\n\n  const sendReplyMutation = useMutation({\n    mutationFn: async (data: { to: string; subject: string; body: string }) => {\n      const response = await fetch(\"/api/emails/send\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to send email\");\n      return response.json();\n    },\n    onSuccess: () => {\n      setReplyText(\"\");\n      setShowReply(false);\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      toast({\n        title: \"Reply sent\",\n        description: \"Your reply has been sent successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to send reply\",\n        description: \"There was an error sending your reply\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const markAsReadMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(`/api/email-threads/${threadId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ isUnread: false }),\n      });\n      if (!response.ok) throw new Error(\"Failed to mark as read\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"] });\n    }\n  });\n\n  const updateThreadMutation = useMutation({\n    mutationFn: async (data: Partial<EmailThread>) => {\n      const response = await fetch(`/api/email-threads/${threadId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update thread\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", \"linked\", threadId] });\n    }\n  });\n\n  const linkToCaseMutation = useMutation({\n    mutationFn: async (caseId: string) => {\n      const response = await fetch(`/api/email-threads/${threadId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ caseId }),\n      });\n      if (!response.ok) throw new Error(\"Failed to link to case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", \"linked\", threadId] });\n      setSelectedCaseId(\"\");\n      toast({\n        title: \"Email gekoppeld\",\n        description: \"Email thread is succesvol gekoppeld aan de case\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Koppeling mislukt\",\n        description: \"Er is een fout opgetreden bij het koppelen aan de case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const linkToOrderMutation = useMutation({\n    mutationFn: async (orderId: string) => {\n      const response = await fetch(`/api/email-threads/${threadId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ orderId }),\n      });\n      if (!response.ok) throw new Error(\"Failed to link to order\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      setSelectedOrderId(\"\");\n      toast({\n        title: \"Order gekoppeld\",\n        description: \"Email thread is succesvol gekoppeld aan de order\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Koppeling mislukt\",\n        description: \"Er is een fout opgetreden bij het koppelen aan de order\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSendReply = () => {\n    if (!thread || !replyText.trim()) return;\n    \n    sendReplyMutation.mutate({\n      to: thread.customerEmail || '',\n      subject: `Re: ${thread.subject}`,\n      body: replyText,\n    });\n  };\n\n  const markAsRead = () => {\n    markAsReadMutation.mutate();\n  };\n\n  const closeThread = () => {\n    updateThreadMutation.mutate({ status: 'closed' });\n  };\n\n  const handleLinkToCase = () => {\n    if (selectedCaseId) {\n      linkToCaseMutation.mutate(selectedCaseId);\n    }\n  };\n\n  const handleLinkToOrder = () => {\n    if (selectedOrderId) {\n      linkToOrderMutation.mutate(selectedOrderId);\n    }\n  };\n\n  const formatMessageTime = (date: string | Date | null) => {\n    if (!date) return \"Unknown time\";\n    const msgDate = typeof date === 'string' ? new Date(date) : date;\n    const now = new Date();\n    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    \n    if (msgDate >= today) {\n      return msgDate.toLocaleTimeString('nl-NL', {\n        hour: '2-digit',\n        minute: '2-digit',\n        hour12: false\n      });\n    } else {\n      return msgDate.toLocaleDateString('nl-NL', {\n        day: 'numeric',\n        month: 'short',\n        year: msgDate.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,\n        hour: '2-digit',\n        minute: '2-digit'\n      });\n    }\n  };\n\n  const getInitials = (email: string) => {\n    if (!email) return \"?\";\n    const name = email.split(\"@\")[0];\n    return name.substring(0, 2).toUpperCase();\n  };\n\n  const getAvatarColor = (email: string) => {\n    const colors = [\n      \"bg-blue-500\",\n      \"bg-green-500\",\n      \"bg-purple-500\",\n      \"bg-pink-500\",\n      \"bg-indigo-500\",\n      \"bg-teal-500\",\n    ];\n    const hash = email.split(\"\").reduce((acc, char) => acc + char.charCodeAt(0), 0);\n    return colors[hash % colors.length];\n  };\n\n  if (isLoading) {\n    return <EmailThreadSkeleton />;\n  }\n\n  if (!thread) {\n    return (\n      <Card className=\"h-full\" data-testid=\"email-thread-not-found\">\n        <CardContent className=\"flex items-center justify-center h-full\">\n          <div className=\"text-center\">\n            <Mail className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium mb-2\">Thread not found</h3>\n            <p className=\"text-muted-foreground\">The requested email thread could not be found.</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"h-full flex gap-3\" data-testid=\"email-thread-view\">\n      <div className=\"flex-1 flex flex-col\">\n        {/* Thread Header */}\n        <div className=\"bg-background border-b border-border pb-2 mb-3 px-4 pt-3\" data-testid=\"email-thread-header\">\n          <div className=\"flex items-start justify-between mb-2\">\n            <div className=\"flex-1\">\n              <h2 className=\"text-base font-semibold text-foreground mb-1.5\">\n                {thread.subject || \"No Subject\"}\n              </h2>\n              <div className=\"flex items-center gap-1.5 flex-wrap mb-1.5\">\n                <Badge \n                  variant={thread.status === 'open' ? 'default' : 'secondary'}\n                  className={cn(\"text-xs py-0 h-5\", thread.status === 'open' ? 'bg-green-600 hover:bg-green-700' : '')}\n                >\n                  {thread.status}\n                </Badge>\n                {thread.priority !== 'medium' && (\n                  <Badge \n                    variant={thread.priority === 'urgent' ? 'destructive' : 'default'}\n                    className={cn(\"text-xs py-0 h-5\", thread.priority === 'high' ? 'bg-orange-500 hover:bg-orange-600' : '')}\n                  >\n                    {thread.priority}\n                  </Badge>\n                )}\n                {thread.hasAttachment && (\n                  <Badge variant=\"outline\" className=\"border-blue-300 dark:border-blue-700 text-xs py-0 h-5\">\n                    <Paperclip className=\"h-3 w-3 mr-1\" />\n                    Attachments\n                  </Badge>\n                )}\n                {linkedCases && linkedCases.length > 0 && (\n                  <Badge variant=\"outline\" className=\"border-purple-300 dark:border-purple-700 text-xs py-0 h-5\">\n                    Case #{linkedCases[0].caseNumber}\n                  </Badge>\n                )}\n                {thread.orderId && (\n                  <Badge variant=\"outline\" className=\"border-indigo-300 dark:border-indigo-700 text-xs py-0 h-5\">\n                    <ShoppingCart className=\"h-3 w-3 mr-1\" />\n                    Order\n                  </Badge>\n                )}\n              </div>\n              <div className=\"flex items-center gap-1 text-xs text-muted-foreground\">\n                <User className=\"h-3 w-3\" />\n                <span>{thread.customerEmail}</span>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center gap-2\">\n              {thread.isUnread && (\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={markAsRead}\n                  className=\"border-blue-300 dark:border-blue-700 hover:bg-blue-50 dark:hover:bg-blue-950\"\n                >\n                  Mark as Read\n                </Button>\n              )}\n              <Button \n                variant=\"default\" \n                size=\"sm\" \n                onClick={() => setShowReply(true)}\n                className=\"bg-blue-600 hover:bg-blue-700\"\n              >\n                <Reply className=\"h-4 w-4 mr-1\" />\n                Reply\n              </Button>\n              <Button variant=\"outline\" size=\"sm\">\n                <Forward className=\"h-4 w-4 mr-1\" />\n                Forward\n              </Button>\n              <Button variant=\"outline\" size=\"sm\" onClick={closeThread}>\n                <Archive className=\"h-4 w-4 mr-1\" />\n                Close\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 overflow-y-auto space-y-3 mb-4\">\n          {thread.messages && thread.messages.length > 0 ? (\n            thread.messages.map((message, index) => (\n              <div \n                key={message.id} \n                className={`bg-background border border-border rounded-lg hover:shadow-sm transition-shadow ${\n                  message.isOutbound ? 'bg-blue-50/50 dark:bg-blue-950/10' : ''\n                }`}\n                data-testid={`email-message-${message.id}`}\n              >\n                <div className=\"p-4\">\n                  <div className=\"flex items-start justify-between mb-3\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className={`flex-shrink-0 w-9 h-9 rounded-full ${getAvatarColor(message.fromEmail)} flex items-center justify-center text-white font-medium text-xs`}>\n                        {getInitials(message.fromEmail)}\n                      </div>\n                      <div>\n                        <div className=\"font-medium text-sm text-foreground\">{message.fromEmail}</div>\n                        <div className=\"text-xs text-muted-foreground\">\n                          to {message.toEmail}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">{formatMessageTime(message.sentAt)}</span>\n                      {message.isOutbound && (\n                        <Badge variant=\"outline\" className=\"text-xs bg-blue-100 dark:bg-blue-950 border-blue-300 dark:border-blue-800\">\n                          Sent\n                        </Badge>\n                      )}\n                    </div>\n                  </div>\n                  \n                  <div className=\"mt-3 bg-white dark:bg-gray-950 rounded-md p-3 border border-gray-200 dark:border-gray-800\">\n                    <SanitizedEmailContent \n                      body={message.body || \"\"} \n                      isHtml={message.isHtml || false} \n                    />\n                  </div>\n                  \n                  <EmailAttachments messageId={message.id} />\n                </div>\n              </div>\n            ))\n          ) : (\n            <div className=\"bg-muted/50 rounded-lg p-8 text-center text-muted-foreground\">\n              No messages in this thread\n            </div>\n          )}\n        </div>\n\n        {/* Reply Area */}\n        {showReply && (\n          <Card data-testid=\"email-reply-area\">\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Reply to {thread.customerEmail}</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <RichTextEditor\n                content={replyText}\n                onChange={setReplyText}\n                placeholder=\"Type your reply...\"\n                className=\"min-h-[100px]\"\n              />\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center space-x-2\">\n                  <Button variant=\"outline\" size=\"sm\">\n                    <Paperclip className=\"h-4 w-4 mr-1\" />\n                    Attach\n                  </Button>\n                  <Button variant=\"outline\" size=\"sm\">\n                    <Tag className=\"h-4 w-4 mr-1\" />\n                    Template\n                  </Button>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <Button \n                    variant=\"outline\" \n                    onClick={() => setShowReply(false)}\n                    data-testid=\"cancel-reply-button\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button \n                    onClick={handleSendReply}\n                    disabled={!replyText.trim() || sendReplyMutation.isPending}\n                    data-testid=\"send-reply-button\"\n                  >\n                    <Send className=\"h-4 w-4 mr-1\" />\n                    Send\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Customer Context Sidebar */}\n      <div className=\"w-64 space-y-3\" data-testid=\"customer-context-sidebar\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base flex items-center\">\n              <UserCircle className=\"h-5 w-5 mr-2\" />\n              Klantcontext\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Case Actions */}\n            <div className=\"space-y-3\">\n              {linkedCases && linkedCases.length > 0 ? (\n                <div>\n                  <div className=\"text-sm font-medium text-muted-foreground mb-2\">Gekoppelde Cases</div>\n                  {linkedCases.map((caseItem) => (\n                    <div key={caseItem.id} className=\"flex items-center justify-between p-2 bg-muted rounded\">\n                      <div>\n                        <div className=\"text-sm font-medium\">Case #{caseItem.caseNumber}</div>\n                        <div className=\"text-xs text-muted-foreground\">{caseItem.title}</div>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <Button size=\"sm\" variant=\"outline\" asChild>\n                          <a href={`/cases/${caseItem.id}`} data-testid={`view-case-${caseItem.id}`}>\n                            Bekijken\n                          </a>\n                        </Button>\n                        <Button \n                          size=\"sm\" \n                          variant=\"danger\"\n                          onClick={() => linkToCaseMutation.mutate('')}\n                          disabled={linkToCaseMutation.isPending}\n                          data-testid={`unlink-case-${caseItem.id}`}\n                        >\n                          Ontkoppel\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  <div className=\"text-sm font-medium text-muted-foreground mb-2\">Case Beheer</div>\n                  \n                  {/* Create new case */}\n                  <Button \n                    className=\"w-full\" \n                    onClick={() => setShowCreateCase(true)}\n                    data-testid=\"create-case-button\"\n                  >\n                    <Briefcase className=\"h-4 w-4 mr-2\" />\n                    Maak Case\n                  </Button>\n                  \n                  {/* Link to existing case */}\n                  {allCases && allCases.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"text-xs font-medium text-muted-foreground\">Of koppel aan bestaande case:</div>\n                      <div className=\"flex gap-2\">\n                        <Select value={selectedCaseId} onValueChange={setSelectedCaseId}>\n                          <SelectTrigger className=\"flex-1\" data-testid=\"case-select-trigger\">\n                            <SelectValue placeholder=\"Selecteer case...\" />\n                          </SelectTrigger>\n                          <SelectContent data-testid=\"case-select-content\">\n                            {allCases.map((caseItem) => (\n                              <SelectItem key={caseItem.id} value={caseItem.id} data-testid={`case-option-${caseItem.id}`}>\n                                Case #{caseItem.caseNumber} - {caseItem.title}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <Button \n                          size=\"sm\" \n                          onClick={handleLinkToCase}\n                          disabled={!selectedCaseId || linkToCaseMutation.isPending}\n                          data-testid=\"link-case-button\"\n                        >\n                          <LinkIcon className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                  \n                  <p className=\"text-xs text-muted-foreground\">\n                    Maak een case aan of koppel aan een bestaande case om dit verzoek te beheren.\n                  </p>\n                </div>\n              )}\n            </div>\n\n            <Separator />\n\n            {/* Order Linking - Simplified working version */}\n            <div className=\"space-y-3\">\n              <div className=\"text-sm font-medium text-muted-foreground mb-2\">Order Koppeling</div>\n              \n              {thread.orderId ? (\n                <div className=\"p-4 bg-muted rounded-lg space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"text-sm font-medium\">Gekoppelde Order</div>\n                    <Button \n                      size=\"sm\" \n                      variant=\"danger\"\n                      onClick={() => linkToOrderMutation.mutate('')}\n                      disabled={linkToOrderMutation.isPending}\n                      data-testid=\"unlink-order-button\"\n                    >\n                      Ontkoppel\n                    </Button>\n                  </div>\n                  \n                  {linkedOrder ? (\n                    <div className=\"space-y-3\">\n                      {/* Order Header */}\n                      <div className=\"flex items-center gap-2 pb-2 border-b\">\n                        <ShoppingCart className=\"h-4 w-4 text-primary\" />\n                        <span className=\"font-semibold text-sm\">Order #{linkedOrder.orderNumber}</span>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {linkedOrder.status}\n                        </Badge>\n                      </div>\n\n                      {/* Customer Info */}\n                      {linkedOrder.orderData?.customer && (\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div>\n                            <div className=\"text-xs font-medium text-muted-foreground mb-1\">Klantnaam</div>\n                            <div className=\"text-sm\">\n                              {linkedOrder.orderData.customer.first_name} {linkedOrder.orderData.customer.last_name}\n                            </div>\n                          </div>\n                          <div>\n                            <div className=\"text-xs font-medium text-muted-foreground mb-1\">Totaal uitgegeven</div>\n                            <div className=\"text-sm font-medium\">\n                              ‚Ç¨{((linkedOrder.totalAmount || 0) / 100).toFixed(2)}\n                            </div>\n                          </div>\n                        </div>\n                      )}\n\n                      {/* Address */}\n                      {linkedOrder.orderData?.customer?.default_address && (\n                        <div>\n                          <div className=\"text-xs font-medium text-muted-foreground mb-1\">Adres</div>\n                          <div className=\"text-sm\">\n                            {linkedOrder.orderData.customer.default_address.address1}\n                            {linkedOrder.orderData.customer.default_address.address2 && \n                              `, ${linkedOrder.orderData.customer.default_address.address2}`\n                            }<br/>\n                            {linkedOrder.orderData.customer.default_address.zip} {linkedOrder.orderData.customer.default_address.city}<br/>\n                            {linkedOrder.orderData.customer.default_address.country}\n                          </div>\n                        </div>\n                      )}\n\n                      {/* Order Items */}\n                      {linkedOrder.orderData?.line_items && linkedOrder.orderData.line_items.length > 0 && (\n                        <div>\n                          <div className=\"text-xs font-medium text-muted-foreground mb-2\">Aangekochte artikelen</div>\n                          <div className=\"space-y-2\">\n                            {linkedOrder.orderData.line_items.map((item: any, index: number) => (\n                              <div key={index} className=\"flex justify-between items-start p-2 bg-background rounded border\">\n                                <div className=\"flex-1\">\n                                  <div className=\"text-sm font-medium\">{item.title}</div>\n                                  <div className=\"text-xs text-muted-foreground\">\n                                    SKU: {item.sku} ‚Ä¢ Qty: {item.quantity}\n                                  </div>\n                                </div>\n                                <div className=\"text-sm font-medium ml-2\">\n                                  ‚Ç¨{parseFloat(item.price).toFixed(2)}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n\n                      {/* Tracking Information */}\n                      <div>\n                        <div className=\"text-xs font-medium text-muted-foreground mb-2\">Tracking gegevens</div>\n                        {linkedOrder.orderData?.fulfillments && linkedOrder.orderData.fulfillments.length > 0 ? (\n                          <div className=\"space-y-2\">\n                            {linkedOrder.orderData.fulfillments.map((fulfillment: any, index: number) => (\n                              <div key={index} className=\"p-2 bg-background rounded border\">\n                                <div className=\"flex items-start justify-between\">\n                                  <div className=\"flex-1\">\n                                    <div className=\"text-sm font-medium\">\n                                      {fulfillment.tracking_company || 'Vervoerder onbekend'}\n                                    </div>\n                                    {fulfillment.tracking_number && (\n                                      <div className=\"text-xs text-muted-foreground mt-1\">\n                                        Tracking: {fulfillment.tracking_number}\n                                      </div>\n                                    )}\n                                    <div className=\"text-xs text-muted-foreground\">\n                                      Status: {fulfillment.status || 'Onbekend'}\n                                    </div>\n                                  </div>\n                                  {fulfillment.tracking_url && (\n                                    <Button \n                                      size=\"sm\" \n                                      variant=\"outline\"\n                                      onClick={() => window.open(fulfillment.tracking_url, '_blank', 'noopener,noreferrer')}\n                                      data-testid=\"track-shipment-button\"\n                                    >\n                                      <ExternalLink className=\"h-3 w-3 mr-1\" />\n                                      Track\n                                    </Button>\n                                  )}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        ) : (\n                          <div className=\"p-2 bg-background rounded border text-center\">\n                            <div className=\"text-sm text-muted-foreground\">\n                              Geen tracking informatie beschikbaar\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  ) : (\n                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                      <ShoppingCart className=\"h-3 w-3\" />\n                      Order ID: {thread.orderId} (laden...)\n                    </div>\n                  )}\n                </div>\n              ) : (\n                allOrders && allOrders.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <div className=\"flex gap-2\">\n                      <Select value={selectedOrderId} onValueChange={setSelectedOrderId}>\n                        <SelectTrigger className=\"flex-1\" data-testid=\"order-select-trigger\">\n                          <SelectValue placeholder=\"Selecteer order...\" />\n                        </SelectTrigger>\n                        <SelectContent data-testid=\"order-select-content\" className=\"max-h-60 overflow-y-auto\">\n                          {(allOrders || [])\n                            .slice()\n                            .sort((a, b) => new Date(b.createdAt || 0).getTime() - new Date(a.createdAt || 0).getTime())\n                            .slice(0, 20)\n                            .map((order) => (\n                              <SelectItem key={order.id} value={order.id} data-testid={`order-option-${order.id}`}>\n                                #{order.orderNumber} - ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                              </SelectItem>\n                            ))}\n                        </SelectContent>\n                      </Select>\n                      <Button \n                        size=\"sm\" \n                        onClick={handleLinkToOrder}\n                        disabled={!selectedOrderId || linkToOrderMutation.isPending}\n                        data-testid=\"link-order-button\"\n                      >\n                        <Package className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Koppel een order aan deze email thread voor betere organisatie.\n                    </p>\n                  </div>\n                )\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Quick Stats */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">Thread Informatie</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <div className=\"flex justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Berichten:</span>\n              <span>{thread.messages?.length || 0}</span>\n            </div>\n            <div className=\"flex justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Laatste activiteit:</span>\n              <span>{formatMessageTime(thread.lastActivity)}</span>\n            </div>\n            {thread.hasAttachment && (\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Bijlagen:</span>\n                <span className=\"flex items-center gap-1\">\n                  <Paperclip className=\"h-3 w-3\" />\n                  Ja\n                </span>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Create Case Modal */}\n      <CreateCaseModal \n        open={showCreateCase} \n        onOpenChange={setShowCreateCase}\n        emailThread={thread}\n      />\n    </div>\n  );\n}","size_bytes":31971},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/widgets/quick-actions-widget.tsx":{"content":"import { Wrench, Plus, Search, Mail } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface QuickActionsWidgetProps {\n  onOpenTodo?: () => void;\n  onOpenRepair?: () => void;\n}\n\nexport function QuickActionsWidget({ onOpenTodo, onOpenRepair }: QuickActionsWidgetProps) {\n  const quickActions = [\n    {\n      id: \"new-repair\",\n      title: \"Start New Repair\",\n      description: \"Create repair request\",\n      icon: Wrench,\n      color: \"bg-primary/10 text-primary\",\n      action: () => {\n        onOpenRepair?.();\n      }\n    },\n    {\n      id: \"new-todo\",\n      title: \"Create To-do\",\n      description: \"Add new task\",\n      icon: Plus,\n      color: \"bg-chart-2/10 text-chart-2\",\n      action: () => {\n        onOpenTodo?.();\n      }\n    },\n    {\n      id: \"search-orders\",\n      title: \"Search Orders\",\n      description: \"Find customer orders\",\n      icon: Search,\n      color: \"bg-chart-4/10 text-chart-4\",\n      action: () => {\n        // TODO: Navigate to orders with search focus\n        console.log(\"Navigating to orders search\");\n      }\n    },\n    {\n      id: \"compose-email\",\n      title: \"Compose Email\",\n      description: \"Send customer email\",\n      icon: Mail,\n      color: \"bg-chart-1/10 text-chart-1\",\n      action: () => {\n        // TODO: Open email composer\n        console.log(\"Opening email composer\");\n      }\n    }\n  ];\n\n  return (\n    <Card data-testid=\"quick-actions-widget\">\n      <CardHeader>\n        <CardTitle className=\"text-lg font-medium\">Quick Actions</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid gap-3 md:grid-cols-2 lg:grid-cols-4\">\n          {quickActions.map((action) => (\n            <Button\n              key={action.id}\n              variant=\"outline\"\n              className=\"h-auto p-4 justify-start text-left\"\n              onClick={action.action}\n              data-testid={`quick-action-${action.id}`}\n            >\n              <div className=\"flex items-center space-x-3 w-full\">\n                <div className={`h-10 w-10 rounded-lg flex items-center justify-center ${action.color}`}>\n                  <action.icon className=\"h-5 w-5\" />\n                </div>\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium truncate\">{action.title}</p>\n                  <p className=\"text-xs text-muted-foreground truncate\">{action.description}</p>\n                </div>\n              </div>\n            </Button>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":2618},"client/src/components/forms/repair-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { CalendarIcon, Upload, X, Search, Check, ChevronsUpDown } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { User, Customer, Order } from \"@shared/schema\";\n\ninterface RepairFormProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  repair?: any;\n  users: User[];\n}\n\ninterface FormData {\n  title: string;\n  description: string;\n  priority: \"low\" | \"medium\" | \"high\" | \"urgent\";\n  estimatedCost: number;\n  productSku: string;\n  productName: string;\n  issueCategory: string;\n  assignedUserId: string;\n  customerId: string;\n  orderId: string;\n}\n\nconst ISSUE_CATEGORIES = [\n  \"Lensdefect - autofocus werkt niet\",\n  \"Lensdefect - beeldstabilisatie defect\",\n  \"Lensdefect - diafragma vastgelopen\",\n  \"Lensdefect - schade aan lenselement\",\n  \"Camera - sluiter defect\",\n  \"Camera - sensor vervuiling\",\n  \"Camera - schade aan behuizing\",\n  \"Camera - batterij/oplaad probleem\",\n  \"Camera - display defect\",\n  \"Camera - knoppen/draaiknoppen defect\",\n  \"Mechanische schade\",\n  \"Water/vochtschade\",\n  \"Overig\",\n];\n\nexport function RepairForm({ open, onOpenChange, repair, users }: RepairFormProps) {\n  const [slaDeadline, setSlaDeadline] = useState<Date | null>(null);\n  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);\n  const [orderSearchQuery, setOrderSearchQuery] = useState(\"\");\n  const [showOrderResults, setShowOrderResults] = useState(false);\n  const [selectedOrderDisplay, setSelectedOrderDisplay] = useState<string>(\"\");\n  const [selectedOrderData, setSelectedOrderData] = useState<any>(null);\n  const [otherCategoryDetails, setOtherCategoryDetails] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: customers = [], isError: customersError } = useQuery<Customer[]>({\n    queryKey: ['/api/customers'],\n    enabled: open,\n  });\n\n  const { data: orders = [], isError: ordersError } = useQuery<Order[]>({\n    queryKey: ['/api/orders'],\n    enabled: open,\n  });\n\n  // Search orders API\n  const { data: orderSearchResults } = useQuery<any>({\n    queryKey: [`/api/search?q=${orderSearchQuery}`],\n    enabled: orderSearchQuery.length > 2,\n  });\n\n  useEffect(() => {\n    if (customersError) {\n      toast({\n        title: \"Fout bij laden klanten\",\n        description: \"Kon klanten niet laden. Probeer opnieuw.\",\n        variant: \"destructive\",\n      });\n    }\n  }, [customersError, toast]);\n\n  useEffect(() => {\n    if (ordersError) {\n      toast({\n        title: \"Fout bij laden orders\",\n        description: \"Kon orders niet laden. Probeer opnieuw.\",\n        variant: \"destructive\",\n      });\n    }\n  }, [ordersError, toast]);\n\n  const {\n    register,\n    handleSubmit,\n    reset,\n    setValue,\n    watch,\n    formState: { errors },\n  } = useForm<FormData>({\n    defaultValues: {\n      title: \"\",\n      description: \"\",\n      priority: \"medium\",\n      estimatedCost: 0,\n      productSku: \"\",\n      productName: \"\",\n      issueCategory: \"\",\n      assignedUserId: \"none\",\n      customerId: \"none\",\n      orderId: \"none\",\n    },\n  });\n\n  const createRepairMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const res = await apiRequest(\"POST\", \"/api/repairs\", data);\n      return await res.json();\n    },\n    onSuccess: async (newRepair: any) => {\n      if (selectedFiles.length > 0) {\n        const formData = new FormData();\n        selectedFiles.forEach((file) => {\n          formData.append('files', file);\n        });\n        // Use fetch directly for FormData to avoid JSON.stringify\n        const uploadRes = await fetch(`/api/repairs/${newRepair.id}/upload`, {\n          method: 'POST',\n          body: formData,\n          credentials: 'include',\n        });\n        if (!uploadRes.ok) {\n          throw new Error('Failed to upload files');\n        }\n      }\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/repairs\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/activities\"] });\n      toast({\n        title: \"Reparatie aangemaakt\",\n        description: \"De reparatie is succesvol aangemaakt.\",\n      });\n      handleClose();\n    },\n    onError: (error: any) => {\n      console.error(\"Create repair error:\", error);\n      toast({\n        title: \"Fout\",\n        description: error?.message || \"Er is een fout opgetreden bij het aanmaken van de reparatie.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const onSubmit = (data: FormData) => {\n    if (selectedFiles.length > 10) {\n      toast({\n        title: \"Te veel bestanden\",\n        description: \"Je kunt maximaal 10 bestanden uploaden.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    // Use stored order data if available (from search), otherwise try to find in orders array\n    const selectedOrder = selectedOrderData?.order || orders.find(o => o.id === data.orderId);\n    const selectedCustomer = selectedOrderData?.customer || (selectedOrder ? customers.find(c => c.id === selectedOrder.customerId) : null);\n    \n    const repairData = {\n      title: data.title,\n      description: data.description || undefined,\n      priority: data.priority,\n      estimatedCost: data.estimatedCost ? Math.round(data.estimatedCost * 100) : undefined,\n      assignedUserId: (data.assignedUserId && data.assignedUserId !== \"none\") ? data.assignedUserId : undefined,\n      slaDeadline: slaDeadline ? slaDeadline.toISOString() : undefined,\n      productSku: data.productSku || undefined,\n      productName: data.productName || undefined,\n      issueCategory: data.issueCategory === \"Overig\" && otherCategoryDetails \n        ? `Overig: ${otherCategoryDetails}` \n        : data.issueCategory || undefined,\n      customerId: (data.customerId && data.customerId !== \"none\") ? data.customerId : undefined,\n      orderId: (data.orderId && data.orderId !== \"none\") ? data.orderId : undefined,\n      customerName: selectedCustomer ? `${selectedCustomer.firstName} ${selectedCustomer.lastName}`.trim() : undefined,\n      customerEmail: selectedCustomer?.email || selectedOrder?.customerEmail || undefined,\n      orderNumber: selectedOrder?.orderNumber || undefined,\n      status: \"new\",\n    };\n\n    createRepairMutation.mutate(repairData);\n  };\n\n  const handleClose = () => {\n    reset();\n    setSlaDeadline(null);\n    setSelectedFiles([]);\n    setOrderSearchQuery(\"\");\n    setShowOrderResults(false);\n    setSelectedOrderDisplay(\"\");\n    setSelectedOrderData(null);\n    setOtherCategoryDetails(\"\");\n    onOpenChange(false);\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = Array.from(e.target.files || []);\n    if (files.length + selectedFiles.length > 10) {\n      toast({\n        title: \"Te veel bestanden\",\n        description: \"Je kunt maximaal 10 bestanden uploaden.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setSelectedFiles([...selectedFiles, ...files]);\n  };\n\n  const removeFile = (index: number) => {\n    setSelectedFiles(selectedFiles.filter((_, i) => i !== index));\n  };\n\n  const technicians = users.filter(u => u.role === 'TECHNICUS' || u.role === 'ADMIN');\n\n  // Get selected order and its customer for display\n  const selectedOrder = orders.find(o => o.id === watch(\"orderId\"));\n  const selectedOrderCustomer = selectedOrder ? customers.find(c => c.id === selectedOrder.customerId) : null;\n\n  // Get search results or latest 10 orders\n  const displayOrders = orderSearchQuery.length > 2 && orderSearchResults?.orders \n    ? orderSearchResults.orders \n    : orders.slice(0, 10);\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[600px] max-h-[90vh] overflow-y-auto\" data-testid=\"repair-form-dialog\">\n        <DialogHeader>\n          <DialogTitle>{repair ? \"Reparatie Bewerken\" : \"Nieuwe Reparatie\"}</DialogTitle>\n          <DialogDescription>\n            {repair ? \"Bewerk de reparatiegegevens hieronder.\" : \"Maak een nieuwe reparatie aan.\"}\n          </DialogDescription>\n        </DialogHeader>\n        \n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"title\">Titel *</Label>\n            <Input\n              id=\"title\"\n              placeholder=\"bijv. iPhone 12 scherm reparatie\"\n              {...register(\"title\", { required: \"Titel is verplicht\" })}\n              data-testid=\"input-title\"\n            />\n            {errors.title && (\n              <p className=\"text-sm text-destructive\">{errors.title.message}</p>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"productSku\">Artikelnummer</Label>\n            <Input\n              id=\"productSku\"\n              placeholder=\"Artikelnummer\"\n              {...register(\"productSku\")}\n              data-testid=\"input-product-sku\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"productName\">Product Naam</Label>\n            <Input\n              id=\"productName\"\n              placeholder=\"Product naam\"\n              {...register(\"productName\")}\n              data-testid=\"input-product-name\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"description\">Beschrijving</Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"Beschrijf het probleem en de vereisten...\"\n              {...register(\"description\")}\n              data-testid=\"input-description\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Probleem Categorie</Label>\n            <Select\n              onValueChange={(value) => {\n                setValue(\"issueCategory\", value);\n                if (value !== \"Overig\") {\n                  setOtherCategoryDetails(\"\");\n                }\n              }}\n              value={watch(\"issueCategory\") || \"\"}\n            >\n              <SelectTrigger data-testid=\"select-issue-category\">\n                <SelectValue placeholder=\"Selecteer categorie\" />\n              </SelectTrigger>\n              <SelectContent>\n                {ISSUE_CATEGORIES.map((category) => (\n                  <SelectItem key={category} value={category}>\n                    {category}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {watch(\"issueCategory\") === \"Overig\" && (\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"otherDetails\">Specificeer het probleem</Label>\n              <Input\n                id=\"otherDetails\"\n                placeholder=\"Beschrijf het probleem...\"\n                value={otherCategoryDetails}\n                onChange={(e) => setOtherCategoryDetails(e.target.value)}\n                data-testid=\"input-other-category-details\"\n              />\n            </div>\n          )}\n\n          <div className=\"space-y-2\">\n            <Label>Order / Klant</Label>\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground z-10\" />\n              <Input\n                type=\"text\"\n                placeholder=\"Zoek order of klant...\"\n                className=\"pl-10 pr-8\"\n                value={selectedOrderDisplay || orderSearchQuery}\n                onChange={(e) => {\n                  setOrderSearchQuery(e.target.value);\n                  setShowOrderResults(true);\n                  if (selectedOrderDisplay) {\n                    // Clear selection when user starts typing again\n                    setSelectedOrderDisplay(\"\");\n                    setSelectedOrderData(null);\n                    setValue(\"orderId\", \"none\");\n                    setValue(\"customerId\", \"none\");\n                  }\n                }}\n                onFocus={() => {\n                  setShowOrderResults(true);\n                }}\n                onBlur={() => setTimeout(() => setShowOrderResults(false), 200)}\n                data-testid=\"input-order-search\"\n              />\n              {selectedOrderDisplay && (\n                <button\n                  type=\"button\"\n                  className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                  onClick={() => {\n                    setSelectedOrderDisplay(\"\");\n                    setOrderSearchQuery(\"\");\n                    setSelectedOrderData(null);\n                    setValue(\"orderId\", \"none\");\n                    setValue(\"customerId\", \"none\");\n                  }}\n                >\n                  √ó\n                </button>\n              )}\n              \n              {showOrderResults && (\n                <div className=\"absolute top-full left-0 right-0 mt-1 bg-popover border border-border rounded-md shadow-lg z-50 max-h-60 overflow-y-auto\">\n                  {displayOrders.length > 0 ? (\n                    <div className=\"p-1\">\n                      {displayOrders.map((order: any) => {\n                        const customer = customers.find(c => c.id === order.customerId);\n                        const customerName = customer \n                          ? `${customer.firstName} ${customer.lastName}`\n                          : order.customerEmail || 'Onbekende klant';\n                        return (\n                          <div\n                            key={order.id}\n                            className=\"p-2 hover:bg-accent rounded cursor-pointer\"\n                            onClick={() => {\n                              setValue(\"orderId\", order.id);\n                              setValue(\"customerId\", order.customerId || \"none\");\n                              setSelectedOrderDisplay(`Order #${order.orderNumber} - ${customerName}`);\n                              setSelectedOrderData({ order, customer });\n                              setOrderSearchQuery(\"\");\n                              setShowOrderResults(false);\n                            }}\n                            data-testid={`order-result-${order.id}`}\n                          >\n                            <div className=\"font-medium\">Order #{order.orderNumber}</div>\n                            <div className=\"text-sm text-muted-foreground\">{customerName}</div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  ) : (\n                    <div className=\"p-4 text-sm text-muted-foreground\">\n                      {orderSearchQuery.length > 0 ? 'Geen order gevonden' : 'Geen recente orders'}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Prioriteit</Label>\n              <Select\n                onValueChange={(value) => setValue(\"priority\", value as any)}\n                value={watch(\"priority\") || \"medium\"}\n              >\n                <SelectTrigger data-testid=\"select-priority\">\n                  <SelectValue placeholder=\"Selecteer prioriteit\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"low\">Laag</SelectItem>\n                  <SelectItem value=\"medium\">Gemiddeld</SelectItem>\n                  <SelectItem value=\"high\">Hoog</SelectItem>\n                  <SelectItem value=\"urgent\">Urgent</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"estimatedCost\">Geschatte Kosten (‚Ç¨)</Label>\n              <Input\n                id=\"estimatedCost\"\n                type=\"number\"\n                step=\"0.01\"\n                placeholder=\"0.00\"\n                {...register(\"estimatedCost\", { \n                  valueAsNumber: true,\n                  min: { value: 0, message: \"Kosten moeten positief zijn\" }\n                })}\n                data-testid=\"input-estimated-cost\"\n              />\n              {errors.estimatedCost && (\n                <p className=\"text-sm text-destructive\">{errors.estimatedCost.message}</p>\n              )}\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Technicus</Label>\n            <Select\n              onValueChange={(value) => setValue(\"assignedUserId\", value)}\n              value={watch(\"assignedUserId\") || \"none\"}\n            >\n              <SelectTrigger data-testid=\"select-technician\">\n                <SelectValue placeholder=\"Selecteer technicus\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"none\">Niet toegewezen</SelectItem>\n                {technicians.map((tech) => (\n                  <SelectItem key={tech.id} value={tech.id}>\n                    {tech.firstName || ''} {tech.lastName || ''} ({tech.username})\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>SLA Deadline</Label>\n            <Popover>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"outline\"\n                  type=\"button\"\n                  className=\"w-full justify-start text-left font-normal\"\n                  data-testid=\"button-deadline-trigger\"\n                >\n                  <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                  {slaDeadline ? format(slaDeadline, \"PPP\") : \"Deadline instellen\"}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                <Calendar\n                  mode=\"single\"\n                  selected={slaDeadline || undefined}\n                  onSelect={(date) => setSlaDeadline(date || null)}\n                  initialFocus\n                  data-testid=\"calendar-deadline\"\n                />\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label>Foto's/Bijlagen ({selectedFiles.length}/10)</Label>\n            <div className=\"border-2 border-dashed border-muted-foreground/25 rounded-lg p-6 text-center\">\n              <Upload className=\"h-8 w-8 mx-auto mb-2 text-muted-foreground\" />\n              <p className=\"text-sm text-muted-foreground\">\n                Sleep bestanden hierheen of klik om te uploaden\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                JPG, PNG, PDF tot 10MB per bestand (max 10 bestanden)\n              </p>\n              <Input\n                type=\"file\"\n                multiple\n                onChange={handleFileSelect}\n                className=\"mt-2\"\n                accept=\"image/*,.pdf\"\n                data-testid=\"input-file-upload\"\n              />\n            </div>\n\n            {selectedFiles.length > 0 && (\n              <div className=\"space-y-2 mt-2\">\n                {selectedFiles.map((file, index) => (\n                  <div key={index} className=\"flex items-center justify-between border p-2 rounded\">\n                    <span className=\"text-sm truncate\">{file.name}</span>\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => removeFile(index)}\n                      data-testid={`button-remove-file-${index}`}\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          <DialogFooter>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={handleClose}\n              data-testid=\"button-cancel\"\n            >\n              Annuleren\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={createRepairMutation.isPending}\n              data-testid=\"button-submit\"\n            >\n              {createRepairMutation.isPending ? \"Opslaan...\" : \"Reparatie Aanmaken\"}\n            </Button>\n          </DialogFooter>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":21157},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-lg border border-border bg-input px-3 py-2 text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-[#FF6600] focus:border-[#FF6600] transition-all duration-200 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-lg border border-border bg-popover text-popover-foreground shadow-modal data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-pointer select-none items-center rounded-md py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 transition-colors\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4 text-[#FF6600]\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5689},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/lib/types.ts":{"content":"import type {\n  User, Customer, Order, EmailThread, EmailMessage, \n  Repair, Todo, InternalNote, Activity, Case,\n  InsertUser, InsertCustomer, InsertOrder, InsertEmailThread, InsertEmailMessage,\n  InsertRepair, InsertTodo, InsertInternalNote, InsertActivity, InsertCase\n} from \"@shared/schema\";\n\nexport type {\n  User, Customer, Order, EmailThread, EmailMessage, \n  Repair, Todo, InternalNote, Activity, Case,\n  InsertUser, InsertCustomer, InsertOrder, InsertEmailThread, InsertEmailMessage,\n  InsertRepair, InsertTodo, InsertInternalNote, InsertActivity, InsertCase\n};\n\n// Shopify Order Data Structure\nexport interface ShopifyCustomer {\n  id?: number;\n  email?: string;\n  first_name?: string;\n  last_name?: string;\n  phone?: string;\n  default_address?: {\n    address1?: string;\n    address2?: string;\n    city?: string;\n    province?: string;\n    zip?: string;\n    country?: string;\n  };\n}\n\nexport interface ShopifyLineItem {\n  id?: number;\n  title?: string;\n  quantity?: number;\n  price?: string;\n  sku?: string;\n  variant_title?: string;\n  product_id?: number;\n  variant_id?: number;\n}\n\nexport interface ShopifyFulfillment {\n  id?: number;\n  status?: string;\n  tracking_company?: string;\n  tracking_number?: string;\n  tracking_url?: string;\n  created_at?: string;\n  updated_at?: string;\n}\n\nexport interface ShopifyOrderData {\n  customer?: ShopifyCustomer;\n  line_items?: ShopifyLineItem[];\n  fulfillments?: ShopifyFulfillment[];\n  [key: string]: any; // Allow other Shopify fields\n}\n\n// Extended Order type with typed orderData\nexport interface OrderWithShopifyData extends Omit<Order, 'orderData'> {\n  orderData: ShopifyOrderData | null;\n}\n\nexport interface DashboardStats {\n  unreadEmails: number;\n  newRepairs: number;\n  slaAlerts: number;\n  todaysOrders: {\n    count: number;\n    total: number;\n  };\n}\n\nexport interface SearchResults {\n  customers: Customer[];\n  orders: Order[];\n  emailThreads: EmailThread[];\n  repairs: Repair[];\n}\n\nexport interface RepairWithDetails extends Repair {\n  customer?: Customer;\n  order?: Order;\n  assignedUser?: User;\n}\n\nexport interface TodoWithDetails extends Todo {\n  customer?: Customer;\n  order?: Order;\n  repair?: Repair;\n  assignedUser?: User;\n}\n\nexport interface ActivityWithUser extends Activity {\n  user?: User;\n}\n\nexport interface CaseWithDetails extends Case {\n  customer?: Customer;\n  assignedUser?: User;\n  notesCount?: number;\n}\n","size_bytes":2382},"client/src/components/todos/calendar-view.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { format, isSameDay, startOfMonth, endOfMonth, isWithinInterval } from \"date-fns\";\nimport { Calendar as CalendarIcon, AlertTriangle, Clock } from \"lucide-react\";\nimport type { Todo } from \"@/lib/types\";\nimport { DayContentProps } from \"react-day-picker\";\n\ninterface CalendarViewProps {\n  todos: Todo[];\n  onTaskClick: (todo: Todo) => void;\n  isLoading: boolean;\n}\n\nexport function CalendarView({ todos, onTaskClick, isLoading }: CalendarViewProps) {\n  const [selectedDate, setSelectedDate] = useState<Date | undefined>(undefined);\n\n  // Group todos by date\n  const todosByDate = useMemo(() => {\n    const grouped = new Map<string, Todo[]>();\n    \n    todos.forEach((todo) => {\n      if (todo.dueDate) {\n        const dateKey = format(new Date(todo.dueDate), \"yyyy-MM-dd\");\n        if (!grouped.has(dateKey)) {\n          grouped.set(dateKey, []);\n        }\n        grouped.get(dateKey)!.push(todo);\n      }\n    });\n    \n    return grouped;\n  }, [todos]);\n\n  // Get todos for selected date or current month\n  const displayedTodos = useMemo(() => {\n    if (selectedDate) {\n      const dateKey = format(selectedDate, \"yyyy-MM-dd\");\n      return todosByDate.get(dateKey) || [];\n    } else {\n      // Show current month's todos\n      const now = new Date();\n      const monthStart = startOfMonth(now);\n      const monthEnd = endOfMonth(now);\n      \n      return todos.filter((todo) => {\n        if (!todo.dueDate) return false;\n        const dueDate = new Date(todo.dueDate);\n        return isWithinInterval(dueDate, { start: monthStart, end: monthEnd });\n      });\n    }\n  }, [selectedDate, todos, todosByDate]);\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"bg-destructive\";\n      case \"high\":\n        return \"bg-destructive\";\n      case \"medium\":\n        return \"bg-chart-4\";\n      case \"low\":\n        return \"bg-chart-2\";\n      default:\n        return \"bg-muted-foreground\";\n    }\n  };\n\n  const getPriorityVariant = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"destructive\" as const;\n      case \"high\":\n        return \"destructive\" as const;\n      case \"medium\":\n        return \"secondary\" as const;\n      case \"low\":\n        return \"outline\" as const;\n      default:\n        return \"secondary\" as const;\n    }\n  };\n\n  const formatDueDate = (dueDate: string | Date | null) => {\n    if (!dueDate) return null;\n    const date = typeof dueDate === 'string' ? new Date(dueDate) : dueDate;\n    const now = new Date();\n    const diffInDays = Math.ceil((date.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    \n    if (diffInDays < 0) return \"Overdue\";\n    if (diffInDays === 0) return \"Due today\";\n    if (diffInDays === 1) return \"Due tomorrow\";\n    return `Due in ${diffInDays} days`;\n  };\n\n  const isOverdue = (dueDate: string | Date | null) => {\n    if (!dueDate) return false;\n    const date = typeof dueDate === 'string' ? new Date(dueDate) : dueDate;\n    return date < new Date();\n  };\n\n  // Custom day content to show task indicators\n  const renderDayContent = (date: Date) => {\n    const dateKey = format(date, \"yyyy-MM-dd\");\n    const dateTodos = todosByDate.get(dateKey) || [];\n    \n    if (dateTodos.length === 0) {\n      return null;\n    }\n\n    // Get priority distribution\n    const priorityCounts = {\n      urgent: dateTodos.filter(t => t.priority === \"urgent\").length,\n      high: dateTodos.filter(t => t.priority === \"high\").length,\n      medium: dateTodos.filter(t => t.priority === \"medium\").length,\n      low: dateTodos.filter(t => t.priority === \"low\").length,\n    };\n\n    // Show highest priority dot\n    let dotColor = \"bg-muted-foreground\";\n    if (priorityCounts.urgent > 0) dotColor = \"bg-destructive\";\n    else if (priorityCounts.high > 0) dotColor = \"bg-chart-1\";\n    else if (priorityCounts.medium > 0) dotColor = \"bg-chart-4\";\n    else if (priorityCounts.low > 0) dotColor = \"bg-chart-2\";\n\n    return (\n      <div className=\"relative w-full h-full flex items-center justify-center\">\n        <div className=\"absolute top-0.5 right-0.5 flex items-center gap-0.5\">\n          <div className={`w-1.5 h-1.5 rounded-full ${dotColor}`}></div>\n          {dateTodos.length > 1 && (\n            <span className=\"text-[9px] font-semibold\">{dateTodos.length}</span>\n          )}\n        </div>\n      </div>\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"space-y-4\" data-testid=\"calendar-loading\">\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"h-80 bg-muted rounded animate-pulse\"></div>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-6\">\n            <div className=\"space-y-3\">\n              {[...Array(3)].map((_, i) => (\n                <div key={i} className=\"h-24 bg-muted rounded animate-pulse\"></div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\" data-testid=\"calendar-view\">\n      {/* Calendar */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg font-medium\">Task Calendar</CardTitle>\n        </CardHeader>\n        <CardContent className=\"flex justify-center\">\n          <div className=\"relative\">\n            <Calendar\n              mode=\"single\"\n              selected={selectedDate}\n              onSelect={setSelectedDate}\n              className=\"rounded-md border\"\n              modifiers={{\n                hasTasks: (date) => {\n                  const dateKey = format(date, \"yyyy-MM-dd\");\n                  return todosByDate.has(dateKey);\n                }\n              }}\n              modifiersStyles={{\n                hasTasks: {\n                  fontWeight: \"bold\"\n                }\n              }}\n              components={{\n                DayContent: ({ date }: DayContentProps) => (\n                  <div className=\"relative w-full h-full\">\n                    <div>{format(date, \"d\")}</div>\n                    {renderDayContent(date)}\n                  </div>\n                )\n              }}\n              data-testid=\"calendar-picker\"\n            />\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Selected Date Tasks */}\n      <Card data-testid=\"calendar-tasks-list\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <CardTitle className=\"text-lg font-medium\">\n              {selectedDate ? (\n                <span data-testid=\"calendar-selected-date\">\n                  Tasks for {format(selectedDate, \"MMMM d, yyyy\")}\n                </span>\n              ) : (\n                <span data-testid=\"calendar-current-month\">\n                  Tasks this Month\n                </span>\n              )}\n            </CardTitle>\n            <Badge variant=\"secondary\" data-testid=\"calendar-tasks-count\">\n              {displayedTodos.length} {displayedTodos.length === 1 ? \"task\" : \"tasks\"}\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {displayedTodos.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"calendar-no-tasks\">\n              <CalendarIcon className=\"h-12 w-12 mx-auto mb-2 opacity-20\" />\n              <p>No tasks {selectedDate ? \"on this date\" : \"this month\"}</p>\n            </div>\n          ) : (\n            displayedTodos.map((todo) => (\n              <Card\n                key={todo.id}\n                className={`cursor-pointer hover:shadow-md transition-all ${\n                  todo.status === \"done\" ? \"opacity-60\" : \"\"\n                } ${\n                  isOverdue(todo.dueDate) && todo.status !== \"done\"\n                    ? \"border-destructive\"\n                    : \"\"\n                }`}\n                onClick={() => onTaskClick(todo)}\n                data-testid={`calendar-task-card-${todo.id}`}\n              >\n                <CardContent className=\"p-4\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-start justify-between gap-3\">\n                      <div className=\"flex-1 min-w-0\">\n                        <h4\n                          className={`text-sm font-medium ${\n                            todo.status === \"done\" ? \"line-through\" : \"\"\n                          }`}\n                          data-testid={`calendar-task-title-${todo.id}`}\n                        >\n                          {todo.title}\n                        </h4>\n                        {todo.description && (\n                          <p\n                            className=\"text-xs text-muted-foreground line-clamp-2 mt-1\"\n                            data-testid={`calendar-task-description-${todo.id}`}\n                          >\n                            {todo.description}\n                          </p>\n                        )}\n                      </div>\n                      <Badge\n                        variant={getPriorityVariant(todo.priority || \"medium\")}\n                        className=\"shrink-0\"\n                        data-testid={`calendar-task-priority-${todo.id}`}\n                      >\n                        <div className={`w-2 h-2 rounded-full ${getPriorityColor(todo.priority || \"medium\")} mr-1`}></div>\n                        {(todo.priority || \"medium\").charAt(0).toUpperCase() +\n                          (todo.priority || \"medium\").slice(1)}\n                      </Badge>\n                    </div>\n\n                    <div className=\"flex items-center justify-between text-xs\">\n                      <div className=\"flex items-center gap-3\">\n                        {/* Status */}\n                        <div className=\"flex items-center gap-1\" data-testid={`calendar-task-status-${todo.id}`}>\n                          <Clock className=\"h-3 w-3 text-muted-foreground\" />\n                          <span className=\"text-muted-foreground\">\n                            {todo.status === \"todo\" && \"To Do\"}\n                            {todo.status === \"in_progress\" && \"In Progress\"}\n                            {todo.status === \"done\" && \"Completed\"}\n                          </span>\n                        </div>\n\n                        {/* Due Date Status */}\n                        {todo.dueDate && (\n                          <div\n                            className={`flex items-center gap-1 ${\n                              isOverdue(todo.dueDate) && todo.status !== \"done\"\n                                ? \"text-destructive font-medium\"\n                                : \"text-muted-foreground\"\n                            }`}\n                            data-testid={`calendar-task-due-status-${todo.id}`}\n                          >\n                            <CalendarIcon className=\"h-3 w-3\" />\n                            <span>{formatDueDate(todo.dueDate)}</span>\n                            {isOverdue(todo.dueDate) && todo.status !== \"done\" && (\n                              <AlertTriangle className=\"h-3 w-3 ml-0.5\" />\n                            )}\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Time */}\n                      {todo.dueDate && (\n                        <span className=\"text-muted-foreground\" data-testid={`calendar-task-time-${todo.id}`}>\n                          {format(new Date(todo.dueDate), \"h:mm a\")}\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":11875},"client/src/components/email/email-thread-view-simple.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Reply,\n  Forward,\n  Archive,\n  Tag,\n  User,\n  Paperclip,\n  Clock,\n  ExternalLink,\n  Send,\n  Briefcase,\n  ShoppingCart,\n  Mail,\n  UserCircle,\n  Link as LinkIcon,\n  Package\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { EmailThread, EmailMessage, Case, Order } from \"@/lib/types\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CreateCaseModal } from \"@/components/forms/create-case-modal\";\n\ninterface EmailThreadViewProps {\n  threadId: string;\n}\n\ninterface ThreadWithMessages extends EmailThread {\n  messages: EmailMessage[];\n}\n\n// Simple test version without complex order dropdown\nexport function EmailThreadView({ threadId }: EmailThreadViewProps) {\n  const [replyText, setReplyText] = useState(\"\");\n  const [showReply, setShowReply] = useState(false);\n  const [showCreateCase, setShowCreateCase] = useState(false);\n  const [selectedCaseId, setSelectedCaseId] = useState<string>(\"\");\n  const [selectedOrderId, setSelectedOrderId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const { data: thread, isLoading } = useQuery<ThreadWithMessages>({\n    queryKey: [\"/api/email-threads\", threadId],\n  });\n\n  if (isLoading) {\n    return <div>Loading...</div>;\n  }\n\n  if (!thread) {\n    return <div>Thread not found</div>;\n  }\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      <h1>Simple Email Thread View - Test</h1>\n      <p>Thread: {thread.subject}</p>\n      <p>From: {thread.customerEmail}</p>\n    </div>\n  );\n}","size_bytes":2051},"client/src/components/email/email-thread-view-broken.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Reply,\n  Forward,\n  Archive,\n  Tag,\n  User,\n  Paperclip,\n  Clock,\n  ExternalLink,\n  Send,\n  Briefcase,\n  ShoppingCart,\n  Mail,\n  UserCircle,\n  Link as LinkIcon,\n  Package\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { EmailThread, EmailMessage, Case, Order } from \"@/lib/types\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CreateCaseModal } from \"@/components/forms/create-case-modal\";\n\ninterface EmailThreadViewProps {\n  threadId: string;\n}\n\ninterface ThreadWithMessages extends EmailThread {\n  messages: EmailMessage[];\n}\n\nexport function EmailThreadView({ threadId }: EmailThreadViewProps) {\n  const [replyText, setReplyText] = useState(\"\");\n  const [showReply, setShowReply] = useState(false);\n  const [showCreateCase, setShowCreateCase] = useState(false);\n  const [selectedCaseId, setSelectedCaseId] = useState<string>(\"\");\n  const [selectedOrderId, setSelectedOrderId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const { data: thread, isLoading } = useQuery<ThreadWithMessages>({\n    queryKey: [\"/api/email-threads\", threadId],\n  });\n\n  // Check if this thread is linked to any case\n  const { data: linkedCases } = useQuery<Case[]>({\n    queryKey: [\"/api/cases\", \"linked\", threadId],\n    queryFn: async () => {\n      const response = await fetch(`/api/cases?emailThreadId=${threadId}`);\n      if (!response.ok) {\n        if (response.status === 404) return [];\n        throw new Error('Failed to fetch linked cases');\n      }\n      return response.json();\n    },\n    enabled: !!threadId,\n  });\n\n  // Get all available cases for linking\n  const { data: allCases } = useQuery<Case[]>({\n    queryKey: [\"/api/cases\"],\n    enabled: true,\n  });\n\n  // Get all available orders for linking  \n  const { data: allOrders } = useQuery<Order[]>({\n    queryKey: [\"/api/orders\"],\n    enabled: true,\n  });\n\n\n  const sendReplyMutation = useMutation({\n    mutationFn: async (data: { to: string; subject: string; body: string }) => {\n      const response = await fetch(\"/api/emails/send\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to send email\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"] });\n      setReplyText(\"\");\n      setShowReply(false);\n      toast({\n        title: \"Reply sent\",\n        description: \"Your reply has been sent successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to send reply\",\n        description: \"There was an error sending your reply\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const updateThreadMutation = useMutation({\n    mutationFn: async (data: Partial<EmailThread>) => {\n      const response = await fetch(`/api/email-threads/${threadId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update thread\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", \"linked\", threadId] });\n    }\n  });\n\n  const linkToCaseMutation = useMutation({\n    mutationFn: async (caseId: string) => {\n      const response = await fetch(`/api/email-threads/${threadId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ caseId }),\n      });\n      if (!response.ok) throw new Error(\"Failed to link to case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", \"linked\", threadId] });\n      setSelectedCaseId(\"\");\n      toast({\n        title: \"Email gekoppeld\",\n        description: \"Email thread is succesvol gekoppeld aan de case\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Koppeling mislukt\",\n        description: \"Er is een fout opgetreden bij het koppelen aan de case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const linkToOrderMutation = useMutation({\n    mutationFn: async (orderId: string) => {\n      const response = await fetch(`/api/email-threads/${threadId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ orderId }),\n      });\n      if (!response.ok) throw new Error(\"Failed to link to order\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", threadId] });\n      setSelectedOrderId(\"\");\n      toast({\n        title: \"Order gekoppeld\",\n        description: \"Email thread is succesvol gekoppeld aan de order\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Koppeling mislukt\",\n        description: \"Er is een fout opgetreden bij het koppelen aan de order\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSendReply = () => {\n    if (!thread || !replyText.trim()) return;\n\n    sendReplyMutation.mutate({\n      to: thread.customerEmail || \"\",\n      subject: `Re: ${thread.subject || \"No Subject\"}`,\n      body: replyText,\n    });\n  };\n\n  const markAsRead = () => {\n    if (thread?.isUnread) {\n      updateThreadMutation.mutate({ isUnread: false });\n    }\n  };\n\n  const closeThread = () => {\n    updateThreadMutation.mutate({ status: 'closed' });\n  };\n\n  const handleLinkToCase = () => {\n    if (selectedCaseId) {\n      linkToCaseMutation.mutate(selectedCaseId);\n    }\n  };\n\n  const handleLinkToOrder = () => {\n    if (selectedOrderId) {\n      linkToOrderMutation.mutate(selectedOrderId);\n    }\n  };\n\n  const formatMessageTime = (date: string | Date | null) => {\n    if (!date) return \"Unknown time\";\n    const messageDate = typeof date === 'string' ? new Date(date) : date;\n    \n    // Format as \"HH:MM DD-MM-YYYY\"\n    const time = messageDate.toLocaleTimeString('nl-NL', {\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: false\n    });\n    \n    const dateStr = messageDate.toLocaleDateString('nl-NL', {\n      day: '2-digit',\n      month: '2-digit',\n      year: 'numeric'\n    });\n    \n    return `${time} ${dateStr}`;\n  };\n\n  if (isLoading) {\n    return (\n      <Card className=\"h-full\" data-testid=\"email-thread-loading\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse space-y-4\">\n            <div className=\"h-6 bg-muted rounded\"></div>\n            <div className=\"h-4 bg-muted rounded w-3/4\"></div>\n            <div className=\"space-y-3\">\n              {[...Array(3)].map((_, i) => (\n                <div key={i} className=\"p-4 border rounded\">\n                  <div className=\"h-4 bg-muted rounded mb-2\"></div>\n                  <div className=\"h-16 bg-muted rounded\"></div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!thread) {\n    return (\n      <Card className=\"h-full flex items-center justify-center\">\n        <CardContent className=\"text-center\">\n          <p className=\"text-muted-foreground\">Thread not found</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className=\"flex h-full gap-6\" data-testid=\"email-thread-detail\">\n      {/* Main Email Thread View */}\n      <div className=\"flex-1 flex flex-col\">\n        {/* Thread Header */}\n        <Card className=\"mb-4\">\n          <CardHeader>\n            <div className=\"flex items-start justify-between\">\n              <div className=\"flex-1\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  {thread.subject || \"No Subject\"}\n                  {linkedCases && linkedCases.length > 0 && (\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      <Briefcase className=\"h-3 w-3 mr-1\" />\n                      Gekoppeld aan Case #{linkedCases[0].caseNumber}\n                    </Badge>\n                  )}\n                </CardTitle>\n                <div className=\"flex items-center space-x-2 mt-2\">\n                  <Badge variant={thread.status === 'open' ? 'default' : 'secondary'}>\n                    {thread.status}\n                  </Badge>\n                  <Badge variant={thread.priority === 'high' ? 'destructive' : 'outline'}>\n                    {thread.priority}\n                  </Badge>\n                  {thread.hasAttachment && (\n                    <Badge variant=\"outline\">\n                      <Paperclip className=\"h-3 w-3 mr-1\" />\n                      Attachment\n                    </Badge>\n                  )}\n                  {thread.isUnread && (\n                    <Badge variant=\"secondary\">Unread</Badge>\n                  )}\n                </div>\n                <div className=\"flex items-center space-x-4 mt-2 text-sm text-muted-foreground\">\n                  <div className=\"flex items-center space-x-1\">\n                    <User className=\"h-4 w-4\" />\n                    <span>{thread.customerEmail}</span>\n                  </div>\n                  {thread.orderId && (\n                    <div className=\"flex items-center space-x-1\">\n                      <ExternalLink className=\"h-4 w-4\" />\n                      <span>Linked to Order</span>\n                    </div>\n                  )}\n                </div>\n              </div>\n              \n              <div className=\"flex items-center space-x-2\">\n                {thread.isUnread && (\n                  <Button variant=\"outline\" size=\"sm\" onClick={markAsRead}>\n                    Mark as Read\n                  </Button>\n                )}\n                <Button variant=\"outline\" size=\"sm\" onClick={() => setShowReply(true)}>\n                  <Reply className=\"h-4 w-4 mr-1\" />\n                  Reply\n                </Button>\n                <Button variant=\"outline\" size=\"sm\">\n                  <Forward className=\"h-4 w-4 mr-1\" />\n                  Forward\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" onClick={closeThread}>\n                  <Archive className=\"h-4 w-4 mr-1\" />\n                  Close\n                </Button>\n              </div>\n            </div>\n          </CardHeader>\n        </Card>\n\n        {/* Messages */}\n        <div className=\"flex-1 overflow-y-auto space-y-4 mb-4\">\n          {thread.messages && thread.messages.length > 0 ? (\n            thread.messages.map((message, index) => (\n              <Card key={message.id} data-testid={`email-message-${message.id}`}>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-start justify-between mb-3\">\n                    <div className=\"flex items-center space-x-3\">\n                      <Avatar className=\"h-8 w-8\">\n                        <AvatarFallback>\n                          {message.fromEmail.charAt(0).toUpperCase()}\n                        </AvatarFallback>\n                      </Avatar>\n                      <div>\n                        <div className=\"font-medium text-sm\">{message.fromEmail}</div>\n                        <div className=\"text-xs text-muted-foreground\">\n                          to {message.toEmail}\n                        </div>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center space-x-2 text-xs text-muted-foreground\">\n                      <Clock className=\"h-3 w-3\" />\n                      <span>{formatMessageTime(message.sentAt)}</span>\n                      {message.isOutbound && (\n                        <Badge variant=\"outline\" className=\"text-xs\">Sent</Badge>\n                      )}\n                    </div>\n                  </div>\n                  \n                  <div className=\"prose prose-sm max-w-none\">\n                    {message.isHtml ? (\n                      <div dangerouslySetInnerHTML={{ __html: message.body || \"\" }} />\n                    ) : (\n                      <div className=\"whitespace-pre-wrap\">{message.body}</div>\n                    )}\n                  </div>\n                  \n                  {message.attachments && (message.attachments as any[]).length > 0 && (\n                    <div className=\"mt-3 pt-3 border-t\">\n                      <div className=\"flex items-center space-x-2 text-sm text-muted-foreground\">\n                        <Paperclip className=\"h-4 w-4\" />\n                        <span>{(message.attachments as any[]).length} attachment(s)</span>\n                      </div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            ))\n          ) : (\n            <Card>\n              <CardContent className=\"p-8 text-center text-muted-foreground\">\n                No messages in this thread\n              </CardContent>\n            </Card>\n          )}\n        </div>\n\n        {/* Reply Area */}\n        {showReply && (\n          <Card data-testid=\"email-reply-area\">\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Reply to {thread.customerEmail}</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <Textarea\n                placeholder=\"Type your reply...\"\n                value={replyText}\n                onChange={(e) => setReplyText(e.target.value)}\n                className=\"min-h-[100px]\"\n                data-testid=\"reply-textarea\"\n              />\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center space-x-2\">\n                  <Button variant=\"outline\" size=\"sm\">\n                    <Paperclip className=\"h-4 w-4 mr-1\" />\n                    Attach\n                  </Button>\n                  <Button variant=\"outline\" size=\"sm\">\n                    <Tag className=\"h-4 w-4 mr-1\" />\n                    Template\n                  </Button>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <Button \n                    variant=\"outline\" \n                    onClick={() => setShowReply(false)}\n                    data-testid=\"cancel-reply-button\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button \n                    onClick={handleSendReply}\n                    disabled={!replyText.trim() || sendReplyMutation.isPending}\n                    data-testid=\"send-reply-button\"\n                  >\n                    <Send className=\"h-4 w-4 mr-1\" />\n                    {sendReplyMutation.isPending ? \"Sending...\" : \"Send Reply\"}\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Customer Context Sidebar */}\n      <div className=\"w-80 space-y-4\" data-testid=\"customer-context-sidebar\">\n        {/* Customer Information */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base flex items-center gap-2\">\n              <UserCircle className=\"h-5 w-5\" />\n              Klantcontext\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <div className=\"text-sm font-medium text-muted-foreground\">Email</div>\n              <div className=\"text-sm\">{thread.customerEmail}</div>\n            </div>\n            \n            {thread.orderId && (\n              <div>\n                <div className=\"text-sm font-medium text-muted-foreground\">Gekoppelde Order</div>\n                <div className=\"flex items-center gap-2\">\n                  <ShoppingCart className=\"h-4 w-4 text-muted-foreground\" />\n                  <span className=\"text-sm\">{thread.orderId}</span>\n                </div>\n              </div>\n            )}\n\n            <div>\n              <div className=\"text-sm font-medium text-muted-foreground\">Thread Status</div>\n              <div className=\"flex items-center gap-2 mt-1\">\n                <Badge variant={thread.status === 'open' ? 'default' : 'secondary'}>\n                  {thread.status}\n                </Badge>\n                <Badge variant={thread.priority === 'high' ? 'destructive' : 'outline'}>\n                  {thread.priority}\n                </Badge>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Case Actions */}\n            <div className=\"space-y-3\">\n              {linkedCases && linkedCases.length > 0 ? (\n                <div>\n                  <div className=\"text-sm font-medium text-muted-foreground mb-2\">Gekoppelde Cases</div>\n                  {linkedCases.map((caseItem) => (\n                    <div key={caseItem.id} className=\"flex items-center justify-between p-2 bg-muted rounded\">\n                      <div>\n                        <div className=\"text-sm font-medium\">Case #{caseItem.caseNumber}</div>\n                        <div className=\"text-xs text-muted-foreground\">{caseItem.title}</div>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <Button size=\"sm\" variant=\"outline\" asChild>\n                          <a href={`/cases/${caseItem.id}`} data-testid={`view-case-${caseItem.id}`}>\n                            Bekijken\n                          </a>\n                        </Button>\n                        <Button \n                          size=\"sm\" \n                          variant=\"destructive\"\n                          onClick={() => linkToCaseMutation.mutate('')}\n                          disabled={linkToCaseMutation.isPending}\n                          data-testid={`unlink-case-${caseItem.id}`}\n                        >\n                          Ontkoppel\n                        </Button>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  <div className=\"text-sm font-medium text-muted-foreground mb-2\">Case Beheer</div>\n                  \n                  {/* Create new case */}\n                  <Button \n                    className=\"w-full\" \n                    onClick={() => setShowCreateCase(true)}\n                    data-testid=\"create-case-button\"\n                  >\n                    <Briefcase className=\"h-4 w-4 mr-2\" />\n                    Maak Case\n                  </Button>\n                  \n                  {/* Link to existing case */}\n                  {allCases && allCases.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <div className=\"text-xs font-medium text-muted-foreground\">Of koppel aan bestaande case:</div>\n                      <div className=\"flex gap-2\">\n                        <Select value={selectedCaseId} onValueChange={setSelectedCaseId}>\n                          <SelectTrigger className=\"flex-1\" data-testid=\"case-select-trigger\">\n                            <SelectValue placeholder=\"Selecteer case...\" />\n                          </SelectTrigger>\n                          <SelectContent data-testid=\"case-select-content\">\n                            {allCases.map((caseItem) => (\n                              <SelectItem key={caseItem.id} value={caseItem.id} data-testid={`case-option-${caseItem.id}`}>\n                                Case #{caseItem.caseNumber} - {caseItem.title}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                        <Button \n                          size=\"sm\" \n                          onClick={handleLinkToCase}\n                          disabled={!selectedCaseId || linkToCaseMutation.isPending}\n                          data-testid=\"link-case-button\"\n                        >\n                          <LinkIcon className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                  \n                  <p className=\"text-xs text-muted-foreground\">\n                    Maak een case aan of koppel aan een bestaande case om dit verzoek te beheren.\n                  </p>\n                </div>\n              )}\n            </div>\n\n            <Separator />\n\n            {/* Order Linking */}\n            <div className=\"space-y-3\">\n              <div className=\"text-sm font-medium text-muted-foreground mb-2\">Order Koppeling</div>\n              \n              {thread.orderId ? (\n                <div className=\"p-2 bg-muted rounded\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <div className=\"text-sm font-medium\">Gekoppelde Order</div>\n                      <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                        <ShoppingCart className=\"h-3 w-3\" />\n                        Order ID: {thread.orderId}\n                      </div>\n                    </div>\n                    <Button \n                      size=\"sm\" \n                      variant=\"destructive\"\n                      onClick={() => linkToOrderMutation.mutate('')}\n                      disabled={linkToOrderMutation.isPending}\n                      data-testid=\"unlink-order-button\"\n                    >\n                      Ontkoppel\n                    </Button>\n                  </div>\n                </div>\n              ) : (\n                allOrders && allOrders.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <div className=\"space-y-2\">\n                      <Input\n                        placeholder=\"Zoek op ordernummer...\"\n                        value={orderSearchQuery}\n                        onChange={(e) => setOrderSearchQuery(e.target.value)}\n                        className=\"text-sm\"\n                        data-testid=\"order-search-input\"\n                      />\n                      <div className=\"flex gap-2\">\n                        <Select value={selectedOrderId} onValueChange={setSelectedOrderId}>\n                          <SelectTrigger className=\"flex-1\" data-testid=\"order-select-trigger\">\n                            <SelectValue placeholder=\"Selecteer order...\" />\n                          </SelectTrigger>\n                          <SelectContent data-testid=\"order-select-content\" className=\"max-h-60 overflow-y-auto\">\n                            {filteredOrders.length > 0 ? (\n                              <>\n                                {filteredOrders.map((order) => (\n                                  <SelectItem key={order.id} value={order.id} data-testid={`order-option-${order.id}`}>\n                                    #{order.orderNumber} - ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                                  </SelectItem>\n                                ))}\n                                {!showAllOrders && allOrders && allOrders.length > 20 && filteredOrders.length >= 20 && (\n                                  <div className=\"px-2 py-1\">\n                                    <Button\n                                      variant=\"ghost\"\n                                      size=\"sm\"\n                                      onClick={() => setShowAllOrders(true)}\n                                      className=\"w-full text-xs\"\n                                      data-testid=\"show-more-orders\"\n                                    >\n                                      Toon meer orders... ({allOrders.length - 20} meer)\n                                    </Button>\n                                  </div>\n                                )}\n                              </>\n                            ) : (\n                              <div className=\"px-2 py-1 text-sm text-muted-foreground\">\n                                Geen orders gevonden\n                              </div>\n                            )}\n                          </SelectContent>\n                        </Select>\n                        <Button \n                          size=\"sm\" \n                          onClick={handleLinkToOrder}\n                          disabled={!selectedOrderId || linkToOrderMutation.isPending}\n                          data-testid=\"link-order-button\"\n                        >\n                          <Package className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Koppel een order aan deze email thread voor betere organisatie.\n                    </p>\n                  </div>\n                )\n              )}\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Quick Stats */}\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-base\">Thread Informatie</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <div className=\"flex justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Berichten:</span>\n              <span>{thread.messages?.length || 0}</span>\n            </div>\n            <div className=\"flex justify-between text-sm\">\n              <span className=\"text-muted-foreground\">Laatste activiteit:</span>\n              <span>{formatMessageTime(thread.lastActivity)}</span>\n            </div>\n            {thread.hasAttachment && (\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Bijlagen:</span>\n                <span className=\"flex items-center gap-1\">\n                  <Paperclip className=\"h-3 w-3\" />\n                  Ja\n                </span>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Create Case Modal */}\n      <CreateCaseModal \n        open={showCreateCase} \n        onOpenChange={setShowCreateCase}\n        emailThread={thread}\n      />\n    </div>\n  );\n}\n","size_bytes":26884},"server/services/emailProvider.ts":{"content":"export interface RawEmail {\n  messageId: string;\n  conversationId?: string;\n  subject: string;\n  from: string;\n  to: string;\n  body: string;\n  isHtml: boolean;\n  receivedDateTime: string;\n  isRead: boolean;\n  hasAttachment: boolean;\n  inReplyTo?: string;\n  references?: string;\n}\n\nexport interface EmailProvider {\n  syncEmails(): Promise<RawEmail[]>;\n  sendEmail(to: string, subject: string, body: string, replyToMessageId?: string): Promise<{ success: boolean }>;\n}","size_bytes":466},"client/src/pages/cases.tsx":{"content":"import { useState, useMemo, useCallback } from \"react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { \n  Search, \n  Filter, \n  Plus,\n  Briefcase,\n  Clock,\n  AlertTriangle,\n  CheckCircle,\n  Archive,\n  Users,\n  FileText\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { DragDropContext, Droppable, Draggable } from \"@hello-pangea/dnd\";\nimport type { Case, CaseWithDetails } from \"@/lib/types\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CreateCaseModal } from \"../components/forms/create-case-modal\";\nimport { CaseContextMenu } from \"../components/cases/case-context-menu\";\nimport { CaseDetailModal } from \"../components/cases/case-detail-modal\";\n\nconst CASE_STATUS_CONFIG = {\n  new: { label: \"Nieuw\", color: \"bg-chart-4\", icon: FileText },\n  in_progress: { label: \"In Behandeling\", color: \"bg-primary\", icon: Clock },\n  waiting_customer: { label: \"Wachtend op Klant\", color: \"bg-chart-1\", icon: Users },\n  resolved: { label: \"Opgelost\", color: \"bg-chart-2\", icon: CheckCircle },\n};\n\nexport default function Cases() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [priorityFilter, setPriorityFilter] = useState(\"all\");\n  const [showNewCase, setShowNewCase] = useState(false);\n  const [showArchived, setShowArchived] = useState(false);\n  const [columns, setColumns] = useState(Object.keys(CASE_STATUS_CONFIG));\n  const [selectedCase, setSelectedCase] = useState<CaseWithDetails | null>(null);\n  const { toast } = useToast();\n\n  const { data: cases, isLoading } = useQuery<CaseWithDetails[]>({\n    queryKey: [\"/api/cases\"],\n  });\n\n  const updateCaseMutation = useMutation({\n    mutationFn: async ({ id, data, previousData }: { id: string; data: Partial<Case>; previousData?: CaseWithDetails[] }) => {\n      const response = await fetch(`/api/cases/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update case\");\n      return response.json();\n    },\n    onSuccess: (updatedCase, { id }) => {\n      // Update the query data with the server response instead of invalidating\n      queryClient.setQueryData([\"/api/cases\"], (oldData: CaseWithDetails[] | undefined) => {\n        if (!oldData) return oldData;\n        return oldData.map(caseItem => \n          caseItem.id === id \n            ? { ...caseItem, ...updatedCase }\n            : caseItem\n        );\n      });\n      \n      toast({\n        title: \"Case updated\",\n        description: \"Case status has been updated successfully\",\n      });\n    },\n    onError: (error, { id, previousData }) => {\n      // Revert to the previous state on error\n      if (previousData) {\n        queryClient.setQueryData([\"/api/cases\"], previousData);\n      } else {\n        // Fallback: invalidate queries to refetch correct state\n        queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      }\n      \n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update case status\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const filteredCases = useMemo(() => {\n    if (!cases) return [];\n    \n    return cases.filter(caseItem => {\n      // Filter by archived status\n      if (showArchived) {\n        if (!caseItem.archived) return false;\n      } else {\n        if (caseItem.archived) return false;\n      }\n      \n      if (priorityFilter !== \"all\" && caseItem.priority !== priorityFilter) return false;\n      if (searchQuery && \n          !caseItem.title.toLowerCase().includes(searchQuery.toLowerCase()) &&\n          !caseItem.description?.toLowerCase().includes(searchQuery.toLowerCase()) &&\n          !caseItem.caseNumber.toLowerCase().includes(searchQuery.toLowerCase())) return false;\n      return true;\n    });\n  }, [cases, priorityFilter, searchQuery, showArchived]);\n\n  const caseStatusCount = useMemo(() => {\n    const counts = {\n      all: filteredCases.length,\n      new: 0,\n      in_progress: 0,\n      waiting_customer: 0,\n      resolved: 0,\n    };\n\n    filteredCases.forEach(c => {\n      if (c.status in counts) {\n        counts[c.status as keyof typeof counts]++;\n      }\n    });\n\n    return counts;\n  }, [filteredCases]);\n\n  const totalActive = caseStatusCount.new + caseStatusCount.in_progress + caseStatusCount.waiting_customer;\n  \n  // Calculate \"New Today\" - cases created today\n  const newToday = useMemo(() => {\n    if (!cases) return 0;\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    return cases.filter(c => {\n      if (!c.createdAt) return false;\n      const createdDate = new Date(c.createdAt);\n      createdDate.setHours(0, 0, 0, 0);\n      return createdDate.getTime() === today.getTime() && c.status === 'new';\n    }).length;\n  }, [cases]);\n\n  // Calculate \"Resolved Today\" - cases resolved today\n  const resolvedToday = useMemo(() => {\n    if (!cases) return 0;\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    return cases.filter(c => {\n      if (!c.updatedAt || c.status !== 'resolved') return false;\n      const updatedDate = new Date(c.updatedAt);\n      updatedDate.setHours(0, 0, 0, 0);\n      return updatedDate.getTime() === today.getTime();\n    }).length;\n  }, [cases]);\n\n  // Calculate \"Overdue SLA\" - cases past their SLA deadline\n  const overdueSLA = useMemo(() => {\n    if (!cases) return 0;\n    const now = new Date();\n    \n    return cases.filter(c => {\n      if (!c.slaDeadline || c.status === 'resolved') return false;\n      const deadline = new Date(c.slaDeadline);\n      return deadline < now;\n    }).length;\n  }, [cases]);\n\n  const onDragEnd = useCallback((result: any) => {\n    if (!result.destination) return;\n\n    const { draggableId, destination, source } = result;\n    const newStatus = destination.droppableId;\n    const caseId = draggableId;\n\n    // Don't update if dropped in the same position\n    if (source.droppableId === destination.droppableId && source.index === destination.index) {\n      return;\n    }\n\n    // Store the previous state for potential rollback\n    const previousData = queryClient.getQueryData([\"/api/cases\"]) as CaseWithDetails[] | undefined;\n    \n    // Optimistic update\n    queryClient.setQueryData([\"/api/cases\"], (oldData: CaseWithDetails[] | undefined) => {\n      if (!oldData) return oldData;\n      return oldData.map(caseItem => \n        caseItem.id === caseId \n          ? { ...caseItem, status: newStatus as any }\n          : caseItem\n      );\n    });\n\n    // Update case status\n    updateCaseMutation.mutate({ \n      id: caseId, \n      data: { status: newStatus as any },\n      previousData // Pass previous data for potential rollback\n    });\n  }, [updateCaseMutation, queryClient]);\n\n  // Archive mutation\n  const archiveCaseMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/cases/${id}/archive`, {\n        method: \"PATCH\",\n      });\n      if (!response.ok) throw new Error(\"Failed to archive case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      toast({\n        title: \"Case archived\",\n        description: \"Case has been archived successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Archive failed\",\n        description: \"Failed to archive case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Unarchive mutation\n  const unarchiveCaseMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/cases/${id}/unarchive`, {\n        method: \"PATCH\",\n      });\n      if (!response.ok) throw new Error(\"Failed to unarchive case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      toast({\n        title: \"Case unarchived\",\n        description: \"Case has been unarchived successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Unarchive failed\",\n        description: \"Failed to unarchive case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Delete mutation\n  const deleteCaseMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/cases/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!response.ok) throw new Error(\"Failed to delete case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      toast({\n        title: \"Case deleted\",\n        description: \"Case has been deleted successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Delete failed\",\n        description: \"Failed to delete case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Context menu handlers\n  const handleCaseOpen = (caseId: string) => {\n    const caseItem = cases?.find(c => c.id === caseId);\n    if (caseItem) setSelectedCase(caseItem);\n  };\n\n  const handleCaseArchive = (caseId: string) => {\n    archiveCaseMutation.mutate(caseId);\n  };\n\n  const handleCaseUnarchive = (caseId: string) => {\n    unarchiveCaseMutation.mutate(caseId);\n  };\n\n  const handleCaseDelete = (caseId: string) => {\n    deleteCaseMutation.mutate(caseId);\n  };\n\n  const handleCaseStatusChange = (caseId: string, newStatus: string) => {\n    const previousData = cases;\n    updateCaseMutation.mutate({ \n      id: caseId, \n      data: { status: newStatus as any }, \n      previousData \n    });\n  };\n\n  const getPriorityVariant = (priority: string | null) => {\n    switch (priority) {\n      case \"urgent\": return \"destructive\";\n      case \"high\": return \"destructive\";\n      case \"medium\": return \"secondary\";\n      case \"low\": return \"outline\";\n      default: return \"secondary\";\n    }\n  };\n\n  const formatDate = (date: Date | string | null) => {\n    if (!date) return \"No date set\";\n    const dateObj = typeof date === 'string' ? new Date(date) : date;\n    return dateObj.toLocaleDateString();\n  };\n\n  const isOverdue = (slaDeadline: Date | string | null) => {\n    if (!slaDeadline) return false;\n    const deadlineDate = typeof slaDeadline === 'string' ? new Date(slaDeadline) : slaDeadline;\n    return deadlineDate < new Date();\n  };\n\n  const CaseCard = useCallback(({ caseItem, index }: { caseItem: CaseWithDetails; index: number }) => (\n    <Draggable draggableId={caseItem.id} index={index}>\n      {(provided, snapshot) => (\n        <CaseContextMenu\n          caseId={caseItem.id}\n          currentStatus={caseItem.status}\n          isArchived={caseItem.archived || false}\n          onOpen={handleCaseOpen}\n          onArchive={handleCaseArchive}\n          onUnarchive={handleCaseUnarchive}\n          onDelete={handleCaseDelete}\n          onStatusChange={handleCaseStatusChange}\n        >\n          <Card\n            ref={provided.innerRef}\n            {...provided.draggableProps}\n            {...provided.dragHandleProps}\n            className={`mb-3 cursor-pointer hover:shadow-md transition-shadow ${\n              snapshot.isDragging ? \"rotate-3 shadow-lg\" : \"\"\n            } ${caseItem.archived ? \"opacity-60\" : \"\"}`}\n            onClick={() => setSelectedCase(caseItem)}\n            data-testid={`case-card-${caseItem.id}`}\n          >\n            <CardContent className=\"p-4\">\n              <div className=\"flex justify-between items-start mb-2\">\n                <h3 className=\"font-medium text-sm line-clamp-2\" data-testid={`case-title-${caseItem.id}`}>\n                  {caseItem.title}\n                  {caseItem.archived && (\n                    <Badge variant=\"outline\" className=\"ml-2 text-xs\">\n                      Archived\n                    </Badge>\n                  )}\n                </h3>\n                <Badge variant={getPriorityVariant(caseItem.priority)} className=\"ml-2 text-xs\">\n                  {caseItem.priority}\n                </Badge>\n              </div>\n              \n              <p className=\"text-xs text-muted-foreground mb-3 line-clamp-2\">\n                {caseItem.description}\n              </p>\n\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between text-xs\">\n                  <span className=\"font-mono text-muted-foreground\" data-testid={`case-number-${caseItem.id}`}>\n                    #{caseItem.caseNumber}\n                  </span>\n                  {caseItem.slaDeadline && (\n                    <span className={`font-medium ${isOverdue(caseItem.slaDeadline) ? 'text-destructive' : 'text-muted-foreground'}`}>\n                      {isOverdue(caseItem.slaDeadline) ? 'Overdue' : formatDate(caseItem.slaDeadline)}\n                    </span>\n                  )}\n                </div>\n\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"text-xs text-muted-foreground\">\n                    {caseItem.customer ? (\n                      <span data-testid={`case-customer-${caseItem.id}`}>\n                        {caseItem.customer.firstName} {caseItem.customer.lastName}\n                      </span>\n                    ) : (\n                      <span>{caseItem.customerEmail}</span>\n                    )}\n                  </div>\n                  \n                  <div className=\"flex items-center gap-2\">\n                    {caseItem.notesCount !== undefined && caseItem.notesCount > 0 && (\n                      <Badge variant=\"outline\" className=\"text-xs\" data-testid={`case-notes-count-${caseItem.id}`}>\n                        üìù {caseItem.notesCount}\n                      </Badge>\n                    )}\n                    {caseItem.assignedUser && (\n                      <Avatar className=\"h-6 w-6\">\n                        <AvatarFallback className=\"text-xs\" data-testid={`case-assignee-${caseItem.id}`}>\n                          {(caseItem.assignedUser.firstName?.[0] || '') + (caseItem.assignedUser.lastName?.[0] || '')}\n                        </AvatarFallback>\n                      </Avatar>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </CaseContextMenu>\n      )}\n    </Draggable>\n  ), [handleCaseOpen, handleCaseArchive, handleCaseUnarchive, handleCaseDelete]);\n\n  const Column = useCallback(({ status, cases: columnCases }: { status: string; cases: CaseWithDetails[] }) => {\n    const config = CASE_STATUS_CONFIG[status as keyof typeof CASE_STATUS_CONFIG];\n    const Icon = config.icon;\n    \n    return (\n      <Card className=\"h-full\" data-testid={`column-${status}`}>\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"flex items-center justify-between text-sm\">\n            <div className=\"flex items-center space-x-2\">\n              <div className={`h-3 w-3 rounded-full ${config.color}`}></div>\n              <span>{config.label}</span>\n              <Badge variant=\"secondary\" className=\"text-xs\">\n                {columnCases.length}\n              </Badge>\n            </div>\n            <Icon className=\"h-4 w-4 text-muted-foreground\" />\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"pt-0\">\n          <Droppable droppableId={status}>\n            {(provided, snapshot) => (\n              <div\n                ref={provided.innerRef}\n                {...provided.droppableProps}\n                className={`min-h-[200px] rounded-lg transition-colors ${\n                  snapshot.isDraggingOver ? \"bg-muted/50\" : \"\"\n                }`}\n              >\n                {columnCases.map((caseItem, index) => (\n                  <CaseCard key={caseItem.id} caseItem={caseItem} index={index} />\n                ))}\n                {provided.placeholder}\n              </div>\n            )}\n          </Droppable>\n        </CardContent>\n      </Card>\n    );\n  }, [CaseCard]);\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"cases-page\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        <div className=\"bg-card rounded-lg p-6 mb-6 border\" data-testid=\"cases-header\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n            <div>\n              <h1 className=\"text-3xl font-bold tracking-tight\">Cases</h1>\n              <p className=\"text-muted-foreground\">Manage customer cases and track progress</p>\n            </div>\n            <div>\n              <Button \n                data-testid=\"new-case-button\" \n                className=\"sm:flex-shrink-0\"\n                onClick={() => setShowNewCase(true)}\n              >\n                <Plus className=\"mr-2 h-4 w-4\" />\n                New Case\n              </Button>\n              <CreateCaseModal \n                open={showNewCase} \n                onOpenChange={setShowNewCase}\n              />\n            </div>\n          </div>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-6\">\n          <Card data-testid=\"cases-stats-total\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Total Active</CardTitle>\n              <Briefcase className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{totalActive}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Open cases\n              </p>\n            </CardContent>\n          </Card>\n          \n          <Card data-testid=\"cases-stats-new-today\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">New Today</CardTitle>\n              <Plus className=\"h-4 w-4 text-chart-4\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{newToday}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Created today\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"cases-stats-resolved-today\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Resolved Today</CardTitle>\n              <CheckCircle className=\"h-4 w-4 text-chart-2\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{resolvedToday}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Closed today\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card data-testid=\"cases-stats-overdue\">\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">Overdue SLA</CardTitle>\n              <AlertTriangle className=\"h-4 w-4 text-destructive\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold text-destructive\">{overdueSLA}</div>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Past deadline\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Filters */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between space-x-4\">\n              <div className=\"flex items-center space-x-4 flex-1\">\n                <div className=\"relative flex-1 max-w-sm\">\n                  <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search cases...\"\n                    className=\"pl-10\"\n                    value={searchQuery}\n                    onChange={(e) => {\n                      const value = e.target.value;\n                      setSearchQuery(value);\n                    }}\n                    data-testid=\"cases-search-input\"\n                  />\n                </div>\n                \n                <Tabs value={priorityFilter} onValueChange={setPriorityFilter}>\n                  <TabsList>\n                    <TabsTrigger value=\"all\" data-testid=\"filter-all-priority\">All</TabsTrigger>\n                    <TabsTrigger value=\"urgent\" data-testid=\"filter-urgent-priority\">Urgent</TabsTrigger>\n                    <TabsTrigger value=\"high\" data-testid=\"filter-high-priority\">High</TabsTrigger>\n                    <TabsTrigger value=\"medium\" data-testid=\"filter-medium-priority\">Medium</TabsTrigger>\n                    <TabsTrigger value=\"low\" data-testid=\"filter-low-priority\">Low</TabsTrigger>\n                  </TabsList>\n                </Tabs>\n                \n                <Button\n                  variant={showArchived ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => setShowArchived(!showArchived)}\n                  data-testid=\"archive-toggle-button\"\n                >\n                  <Archive className=\"mr-2 h-4 w-4\" />\n                  {showArchived ? \"Show Active\" : \"Show Archive\"}\n                </Button>\n              </div>\n              \n              <Button variant=\"outline\" size=\"icon\" data-testid=\"advanced-filters-button\">\n                <Filter className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Kanban Board */}\n        <div className=\"min-h-[600px]\" data-testid=\"cases-kanban-board\">\n          {isLoading ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n              {Array.from({ length: 4 }).map((_, i) => (\n                <Card key={i} className=\"h-[400px] animate-pulse\">\n                  <CardHeader>\n                    <div className=\"h-4 bg-muted rounded\"></div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-3\">\n                      {Array.from({ length: 3 }).map((_, j) => (\n                        <div key={j} className=\"h-24 bg-muted rounded\"></div>\n                      ))}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : (\n            <DragDropContext onDragEnd={onDragEnd}>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                {columns.map(status => {\n                  const columnCases = filteredCases.filter(caseItem => caseItem.status === status);\n                  return (\n                    <Column key={status} status={status} cases={columnCases} />\n                  );\n                })}\n              </div>\n            </DragDropContext>\n          )}\n        </div>\n      </main>\n\n      {/* Case Detail Modal */}\n      {selectedCase && (\n        <CaseDetailModal\n          caseId={selectedCase.id}\n          initialData={selectedCase}\n          open={!!selectedCase}\n          onClose={() => setSelectedCase(null)}\n        />\n      )}\n    </div>\n  );\n}","size_bytes":23568},"client/src/components/layout/sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { \n  Home, \n  Inbox, \n  ShoppingCart, \n  Wrench, \n  CheckSquare, \n  BarChart3,\n  Camera,\n  Settings,\n  LogOut,\n  User,\n  Bell,\n  Search,\n  Package\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\nconst navigationItems = [\n  { href: \"/\", label: \"Home\", icon: Home },\n  { href: \"/inbox\", label: \"Inbox\", icon: Inbox, badge: 3 },\n  { href: \"/orders\", label: \"Orders\", icon: ShoppingCart },\n  { href: \"/repairs\", label: \"Repairs\", icon: Wrench },\n  { href: \"/returns\", label: \"Retouren\", icon: Package },\n  { href: \"/todos\", label: \"To-do's\", icon: CheckSquare },\n  { href: \"/dashboard\", label: \"Dashboard\", icon: BarChart3 },\n];\n\ninterface SidebarProps {\n  collapsed?: boolean;\n  onToggle?: () => void;\n}\n\nexport function Sidebar({ collapsed = false, onToggle }: SidebarProps) {\n  const [location] = useLocation();\n  const smallLogoUrl = `${import.meta.env.VITE_SUPABASE_URL}/storage/v1/object/public/extra-files/dutchthrift-logo-small.jpg`;\n\n  return (\n    <div \n      className={cn(\n        \"flex flex-col bg-sidebar border-r border-sidebar-border transition-all duration-300\",\n        collapsed ? \"w-16\" : \"w-64\"\n      )}\n      data-testid=\"sidebar\"\n    >\n      {/* Logo */}\n      <div className=\"p-4\">\n        <Link href=\"/\" className=\"flex items-center space-x-2\" data-testid=\"sidebar-logo\">\n          <div className=\"flex h-8 w-8 items-center justify-center rounded-lg overflow-hidden\">\n            <img \n              src={smallLogoUrl} \n              alt=\"DutchThrift\" \n              className=\"h-full w-full object-cover\"\n            />\n          </div>\n          {!collapsed && (\n            <span className=\"text-lg font-semibold text-sidebar-foreground\">DutchThrift</span>\n          )}\n        </Link>\n      </div>\n\n      <Separator />\n\n      {/* Navigation Items */}\n      <nav className=\"flex-1 p-2\">\n        <div className=\"space-y-1\">\n          {navigationItems.map((item) => {\n            const isActive = location === item.href;\n            \n            const content = (\n              <Link\n                key={item.href}\n                href={item.href}\n                className={cn(\n                  \"flex items-center space-x-3 rounded-md px-3 py-2 text-sm font-medium transition-colors\",\n                  isActive\n                    ? \"bg-sidebar-accent text-sidebar-accent-foreground\"\n                    : \"text-sidebar-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\"\n                )}\n                data-testid={`sidebar-link-${item.label.toLowerCase().replace(/[''\\s]/g, '-')}`}\n              >\n                <item.icon className=\"h-4 w-4 flex-shrink-0\" />\n                {!collapsed && (\n                  <>\n                    <span className=\"flex-1\">{item.label}</span>\n                    {item.badge && (\n                      <Badge \n                        variant=\"default\" \n                        className=\"ml-auto h-5 w-5 justify-center p-0 text-xs\"\n                      >\n                        {item.badge}\n                      </Badge>\n                    )}\n                  </>\n                )}\n              </Link>\n            );\n\n            if (collapsed) {\n              return (\n                <Tooltip key={item.href}>\n                  <TooltipTrigger asChild>\n                    {content}\n                  </TooltipTrigger>\n                  <TooltipContent side=\"right\">\n                    <div className=\"flex items-center space-x-2\">\n                      <span>{item.label}</span>\n                      {item.badge && (\n                        <Badge variant=\"default\" className=\"h-4 w-4 justify-center p-0 text-xs\">\n                          {item.badge}\n                        </Badge>\n                      )}\n                    </div>\n                  </TooltipContent>\n                </Tooltip>\n              );\n            }\n\n            return content;\n          })}\n        </div>\n      </nav>\n\n      <Separator />\n\n      {/* User Section */}\n      <div className=\"p-2\">\n        {collapsed ? (\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                className=\"w-full justify-center p-2\"\n                data-testid=\"sidebar-user-collapsed\"\n              >\n                <Avatar className=\"h-6 w-6\">\n                  <AvatarFallback className=\"text-xs\">JD</AvatarFallback>\n                </Avatar>\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              <span>John Doe</span>\n            </TooltipContent>\n          </Tooltip>\n        ) : (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center space-x-3 rounded-md px-3 py-2\">\n              <Avatar className=\"h-8 w-8\">\n                <AvatarFallback>JD</AvatarFallback>\n              </Avatar>\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-sm font-medium text-sidebar-foreground truncate\">\n                  John Doe\n                </p>\n                <p className=\"text-xs text-sidebar-foreground/60 truncate\">\n                  Admin\n                </p>\n              </div>\n            </div>\n            \n            <div className=\"space-y-1\">\n              <Button\n                variant=\"ghost\"\n                className=\"w-full justify-start text-sidebar-foreground hover:bg-sidebar-accent\"\n                data-testid=\"sidebar-settings\"\n              >\n                <Settings className=\"mr-3 h-4 w-4\" />\n                Settings\n              </Button>\n              \n              <Button\n                variant=\"ghost\"\n                className=\"w-full justify-start text-sidebar-foreground hover:bg-sidebar-accent\"\n                data-testid=\"sidebar-logout\"\n              >\n                <LogOut className=\"mr-3 h-4 w-4\" />\n                Logout\n              </Button>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":6301},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { ThemeProvider } from \"@/providers/theme-provider\";\nimport { AuthProvider } from \"@/providers/auth-provider\";\nimport ProtectedRoute from \"@/components/auth/protected-route\";\nimport NotFound from \"@/pages/not-found\";\nimport Dashboard from \"@/pages/dashboard\";\nimport Inbox from \"@/pages/inbox\";\nimport Cases from \"@/pages/cases\";\nimport Orders from \"@/pages/orders\";\nimport PurchaseOrders from \"@/pages/purchase-orders\";\nimport Repairs from \"@/pages/repairs\";\nimport Todos from \"@/pages/todos\";\nimport Returns from \"@/pages/returns\";\nimport ReturnDetail from \"@/pages/return-detail\";\nimport CustomerDetail from \"@/pages/customer-detail\";\nimport CaseDetail from \"@/pages/case-detail\";\nimport UserManagement from \"@/pages/user-management\";\nimport Settings from \"@/pages/settings\";\n\nfunction Router() {\n  return (\n    <Switch>\n      {/* Dashboard - accessible by ADMIN and SUPPORT only */}\n      <Route \n        path=\"/\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Dashboard}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      {/* User Management - ADMIN only */}\n      <Route \n        path=\"/users\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={UserManagement}\n            roles={[\"ADMIN\"]}\n            {...props} \n          />\n        )}\n      />\n\n      {/* Settings - ADMIN only */}\n      <Route \n        path=\"/settings\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Settings}\n            roles={[\"ADMIN\"]}\n            {...props} \n          />\n        )}\n      />\n\n      {/* Repairs - ADMIN and TECHNICUS only */}\n      <Route \n        path=\"/repairs\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Repairs}\n            roles={[\"ADMIN\", \"TECHNICUS\"]}\n            {...props} \n          />\n        )} \n      />\n\n      {/* Cases - ADMIN and SUPPORT only */}\n      <Route \n        path=\"/cases\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Cases}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      <Route \n        path=\"/cases/:id\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={CaseDetail}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      {/* Inbox - ADMIN and SUPPORT only */}\n      <Route \n        path=\"/inbox\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Inbox}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      {/* Other protected routes */}\n      <Route \n        path=\"/orders\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Orders}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      <Route \n        path=\"/purchase-orders\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={PurchaseOrders}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      <Route \n        path=\"/todos\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Todos}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      {/* Returns - ADMIN and SUPPORT only */}\n      <Route \n        path=\"/returns\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={Returns}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      <Route \n        path=\"/returns/:id\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={ReturnDetail}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      <Route \n        path=\"/customers/:id\" \n        component={(props: any) => (\n          <ProtectedRoute \n            component={CustomerDetail}\n            roles={[\"ADMIN\", \"SUPPORT\"]}\n            {...props} \n          />\n        )} \n      />\n\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <ThemeProvider defaultTheme=\"light\" storageKey=\"dutchthrift-theme\">\n        <AuthProvider>\n          <TooltipProvider>\n            <Toaster />\n            <Router />\n          </TooltipProvider>\n        </AuthProvider>\n      </ThemeProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":4956},"server/objectAcl.ts":{"content":"import { File } from \"@google-cloud/storage\";\n\nconst ACL_POLICY_METADATA_KEY = \"custom:aclPolicy\";\n\n// The type of the access group.\nexport enum ObjectAccessGroupType {}\n\n// The logic user group that can access the object.\nexport interface ObjectAccessGroup {\n  type: ObjectAccessGroupType;\n  id: string;\n}\n\nexport enum ObjectPermission {\n  READ = \"read\",\n  WRITE = \"write\",\n}\n\nexport interface ObjectAclRule {\n  group: ObjectAccessGroup;\n  permission: ObjectPermission;\n}\n\n// The ACL policy of the object.\nexport interface ObjectAclPolicy {\n  owner: string;\n  visibility: \"public\" | \"private\";\n  aclRules?: Array<ObjectAclRule>;\n}\n\n// Check if the requested permission is allowed based on the granted permission.\nfunction isPermissionAllowed(\n  requested: ObjectPermission,\n  granted: ObjectPermission,\n): boolean {\n  // Users granted with read or write permissions can read the object.\n  if (requested === ObjectPermission.READ) {\n    return [ObjectPermission.READ, ObjectPermission.WRITE].includes(granted);\n  }\n\n  // Only users granted with write permissions can write the object.\n  return granted === ObjectPermission.WRITE;\n}\n\n// Sets the ACL policy to the object metadata.\nexport async function setObjectAclPolicy(\n  objectFile: File,\n  aclPolicy: ObjectAclPolicy,\n): Promise<void> {\n  const [exists] = await objectFile.exists();\n  if (!exists) {\n    throw new Error(`Object not found: ${objectFile.name}`);\n  }\n\n  await objectFile.setMetadata({\n    metadata: {\n      [ACL_POLICY_METADATA_KEY]: JSON.stringify(aclPolicy),\n    },\n  });\n}\n\n// Gets the ACL policy from the object metadata.\nexport async function getObjectAclPolicy(\n  objectFile: File,\n): Promise<ObjectAclPolicy | null> {\n  const [metadata] = await objectFile.getMetadata();\n  const aclPolicy = metadata?.metadata?.[ACL_POLICY_METADATA_KEY];\n  if (!aclPolicy) {\n    return null;\n  }\n  return JSON.parse(aclPolicy as string);\n}\n\n// Checks if the user can access the object.\nexport async function canAccessObject({\n  userId,\n  objectFile,\n  requestedPermission,\n}: {\n  userId?: string;\n  objectFile: File;\n  requestedPermission: ObjectPermission;\n}): Promise<boolean> {\n  // When this function is called, the acl policy is required.\n  const aclPolicy = await getObjectAclPolicy(objectFile);\n  if (!aclPolicy) {\n    return false;\n  }\n\n  // Public objects are always accessible for read.\n  if (\n    aclPolicy.visibility === \"public\" &&\n    requestedPermission === ObjectPermission.READ\n  ) {\n    return true;\n  }\n\n  // Access control requires the user id.\n  if (!userId) {\n    return false;\n  }\n\n  // The owner of the object can always access it.\n  if (aclPolicy.owner === userId) {\n    return true;\n  }\n\n  // For now, we only support public/private visibility\n  // ACL rules can be extended later if needed\n  return false;\n}","size_bytes":2792},"client/src/components/purchase-orders/supplier-import-dialog.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Upload, FileSpreadsheet, CheckCircle } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { queryClient } from \"@/lib/queryClient\";\n\nexport function SupplierImportDialog() {\n  const [isOpen, setIsOpen] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const { toast } = useToast();\n\n  const importMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      \n      const response = await fetch(\"/api/suppliers/import-excel\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Import failed\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/suppliers\"] });\n      toast({\n        title: \"Leveranciers ge√Ømporteerd\",\n        description: data.message || \"Leveranciers zijn succesvol ge√Ømporteerd\",\n      });\n      setIsOpen(false);\n      setSelectedFile(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Import mislukt\",\n        description: error.message || \"Er is een fout opgetreden tijdens het importeren\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {\n        toast({\n          title: \"Ongeldig bestand\",\n          description: \"Upload alleen Excel bestanden (.xlsx of .xls)\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      setSelectedFile(file);\n    }\n  };\n\n  const handleImport = () => {\n    if (selectedFile) {\n      importMutation.mutate(selectedFile);\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\" size=\"sm\" data-testid=\"button-import-suppliers\">\n          <Upload className=\"h-4 w-4 mr-2\" />\n          Importeer Leveranciers\n        </Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle>Excel Import</DialogTitle>\n          <DialogDescription>\n            Importeer leveranciers vanuit een Excel bestand\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <div className=\"border-2 border-dashed rounded-lg p-8 text-center\">\n            {!selectedFile ? (\n              <div className=\"space-y-2\">\n                <FileSpreadsheet className=\"h-12 w-12 mx-auto text-muted-foreground\" />\n                <div>\n                  <label htmlFor=\"excel-upload\" className=\"cursor-pointer\">\n                    <div className=\"text-sm font-medium\">Klik om bestand te selecteren</div>\n                    <div className=\"text-xs text-muted-foreground mt-1\">Excel (.xlsx, .xls)</div>\n                  </label>\n                  <input\n                    id=\"excel-upload\"\n                    type=\"file\"\n                    accept=\".xlsx,.xls\"\n                    className=\"hidden\"\n                    onChange={handleFileChange}\n                    data-testid=\"input-excel-file\"\n                  />\n                </div>\n              </div>\n            ) : (\n              <div className=\"space-y-2\">\n                <CheckCircle className=\"h-12 w-12 mx-auto text-green-600\" />\n                <div className=\"text-sm font-medium\">{selectedFile.name}</div>\n                <div className=\"text-xs text-muted-foreground\">\n                  {(selectedFile.size / 1024).toFixed(1)} KB\n                </div>\n              </div>\n            )}\n          </div>\n\n          <div className=\"bg-muted p-3 rounded-md text-xs\">\n            <div className=\"font-medium mb-1\">Verwachte kolommen:</div>\n            <div className=\"text-muted-foreground\">\n              Relatiecode, Naam, Contactpersoon, Email, Telefoon, Adres, IBAN, BTW nummer, etc.\n            </div>\n          </div>\n\n          <div className=\"flex gap-2\">\n            <Button\n              variant=\"outline\"\n              className=\"flex-1\"\n              onClick={() => {\n                setSelectedFile(null);\n                setIsOpen(false);\n              }}\n              data-testid=\"button-cancel-import\"\n            >\n              Annuleer\n            </Button>\n            <Button\n              className=\"flex-1\"\n              onClick={handleImport}\n              disabled={!selectedFile || importMutation.isPending}\n              data-testid=\"button-confirm-import\"\n            >\n              {importMutation.isPending ? \"Importeren...\" : \"Importeer\"}\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":5197},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/ui/rich-text-editor.tsx":{"content":"import { useEditor, EditorContent } from '@tiptap/react';\nimport { useEffect } from 'react';\nimport StarterKit from '@tiptap/starter-kit';\nimport Link from '@tiptap/extension-link';\nimport Underline from '@tiptap/extension-underline';\nimport { \n  Bold, \n  Italic, \n  Underline as UnderlineIcon, \n  List, \n  ListOrdered, \n  Link as LinkIcon,\n  Heading2,\n  RemoveFormatting\n} from 'lucide-react';\nimport { Button } from './button';\nimport { cn } from '@/lib/utils';\n\ninterface RichTextEditorProps {\n  content: string;\n  onChange: (html: string) => void;\n  placeholder?: string;\n  className?: string;\n  editable?: boolean;\n}\n\nexport function RichTextEditor({ \n  content, \n  onChange, \n  placeholder = \"Start typing...\",\n  className,\n  editable = true\n}: RichTextEditorProps) {\n  const editor = useEditor({\n    extensions: [\n      StarterKit.configure({\n        heading: {\n          levels: [2, 3],\n        },\n      }),\n      Link.configure({\n        openOnClick: false,\n        HTMLAttributes: {\n          class: 'text-primary underline',\n        },\n      }),\n      Underline,\n    ],\n    content,\n    editable,\n    onUpdate: ({ editor }) => {\n      onChange(editor.getHTML());\n    },\n    editorProps: {\n      attributes: {\n        class: cn(\n          'prose prose-sm dark:prose-invert max-w-none focus:outline-none min-h-[100px] px-3 py-2',\n          className\n        ),\n      },\n    },\n  });\n\n  useEffect(() => {\n    if (editor && editor.getHTML() !== content) {\n      editor.commands.setContent(content);\n    }\n  }, [content, editor]);\n\n  const setLink = () => {\n    if (!editor) return;\n    \n    const previousUrl = editor.getAttributes('link').href;\n    const url = window.prompt('Enter URL:', previousUrl);\n\n    if (url === null) {\n      return;\n    }\n\n    if (url === '') {\n      editor.chain().focus().extendMarkRange('link').unsetLink().run();\n      return;\n    }\n\n    editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();\n  };\n\n  if (!editor) {\n    return null;\n  }\n\n  return (\n    <div className=\"border rounded-md bg-background\">\n      {editable && (\n        <div className=\"border-b bg-muted/50 p-2 flex flex-wrap gap-1\">\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => editor.chain().focus().toggleBold().run()}\n            className={cn(\n              'h-8 px-2',\n              editor.isActive('bold') && 'bg-accent'\n            )}\n            data-testid=\"editor-bold\"\n          >\n            <Bold className=\"h-4 w-4\" />\n          </Button>\n          \n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => editor.chain().focus().toggleItalic().run()}\n            className={cn(\n              'h-8 px-2',\n              editor.isActive('italic') && 'bg-accent'\n            )}\n            data-testid=\"editor-italic\"\n          >\n            <Italic className=\"h-4 w-4\" />\n          </Button>\n\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => editor.chain().focus().toggleUnderline().run()}\n            className={cn(\n              'h-8 px-2',\n              editor.isActive('underline') && 'bg-accent'\n            )}\n            data-testid=\"editor-underline\"\n          >\n            <UnderlineIcon className=\"h-4 w-4\" />\n          </Button>\n\n          <div className=\"w-px h-8 bg-border mx-1\" />\n\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => editor.chain().focus().toggleHeading({ level: 2 }).run()}\n            className={cn(\n              'h-8 px-2',\n              editor.isActive('heading', { level: 2 }) && 'bg-accent'\n            )}\n            data-testid=\"editor-heading\"\n          >\n            <Heading2 className=\"h-4 w-4\" />\n          </Button>\n\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => editor.chain().focus().toggleBulletList().run()}\n            className={cn(\n              'h-8 px-2',\n              editor.isActive('bulletList') && 'bg-accent'\n            )}\n            data-testid=\"editor-bullet-list\"\n          >\n            <List className=\"h-4 w-4\" />\n          </Button>\n\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => editor.chain().focus().toggleOrderedList().run()}\n            className={cn(\n              'h-8 px-2',\n              editor.isActive('orderedList') && 'bg-accent'\n            )}\n            data-testid=\"editor-ordered-list\"\n          >\n            <ListOrdered className=\"h-4 w-4\" />\n          </Button>\n\n          <div className=\"w-px h-8 bg-border mx-1\" />\n\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={setLink}\n            className={cn(\n              'h-8 px-2',\n              editor.isActive('link') && 'bg-accent'\n            )}\n            data-testid=\"editor-link\"\n          >\n            <LinkIcon className=\"h-4 w-4\" />\n          </Button>\n\n          <Button\n            type=\"button\"\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => editor.chain().focus().clearNodes().unsetAllMarks().run()}\n            className=\"h-8 px-2\"\n            data-testid=\"editor-clear-formatting\"\n          >\n            <RemoveFormatting className=\"h-4 w-4\" />\n          </Button>\n        </div>\n      )}\n      \n      <div className={cn(!editable && 'p-3')}>\n        <EditorContent editor={editor} placeholder={placeholder} />\n      </div>\n    </div>\n  );\n}\n","size_bytes":5663},"client/src/components/widgets/new-repairs-widget.tsx":{"content":"import { Wrench } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { DashboardStats } from \"@/lib/types\";\n\nexport function NewRepairsWidget() {\n  const { data: stats, isLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"new-repairs-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse\">\n            <div className=\"h-4 bg-muted rounded mb-2\"></div>\n            <div className=\"h-8 bg-muted rounded mb-1\"></div>\n            <div className=\"h-3 bg-muted rounded\"></div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"hover:shadow-card-hover\" data-testid=\"new-repairs-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-semibold text-muted-foreground\">New Repairs</CardTitle>\n        <div className=\"h-10 w-10 rounded-full bg-gradient-repairs flex items-center justify-center\">\n          <Wrench className=\"h-5 w-5 text-white\" />\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-2\">\n          <div className=\"text-3xl font-bold text-repairs\" data-testid=\"new-repairs-count\">\n            {stats?.newRepairs || 0}\n          </div>\n          <p className=\"text-sm font-medium text-muted-foreground\">Unassigned requests</p>\n          <div className=\"flex items-center text-sm\">\n            <span className=\"text-secondary font-semibold\" data-testid=\"repairs-change\">\n              +{Math.floor((stats?.newRepairs || 0) / 3)} from yesterday\n            </span>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1844},"client/src/components/widgets/recent-orders-widget.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Order } from \"@/lib/types\";\nimport { Link } from \"wouter\";\n\nexport function RecentOrdersWidget() {\n  const { data: orders, isLoading } = useQuery<Order[]>({\n    queryKey: [\"/api/orders\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"recent-orders-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse space-y-3\">\n            {[...Array(3)].map((_, i) => (\n              <div key={i} className=\"flex items-center justify-between p-3\">\n                <div className=\"flex items-center space-x-3\">\n                  <div className=\"w-12 h-12 bg-muted rounded-md\"></div>\n                  <div className=\"space-y-1\">\n                    <div className=\"h-4 bg-muted rounded w-32\"></div>\n                    <div className=\"h-3 bg-muted rounded w-24\"></div>\n                  </div>\n                </div>\n                <div className=\"text-right space-y-1\">\n                  <div className=\"h-4 bg-muted rounded w-16\"></div>\n                  <div className=\"h-3 bg-muted rounded w-12\"></div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const recentOrders = orders?.slice(0, 3) || [];\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"paid\":\n      case \"delivered\":\n        return \"default\";\n      case \"processing\":\n      case \"shipped\":\n        return \"secondary\";\n      case \"pending\":\n        return \"outline\";\n      case \"cancelled\":\n      case \"refunded\":\n        return \"destructive\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  const getProductImage = (orderData: any) => {\n    // Fallback camera image from Unsplash\n    return \"https://images.unsplash.com/photo-1502920917128-1aa500764cbd?ixlib=rb-4.0.3&auto=format&fit=crop&w=48&h=48\";\n  };\n\n  const getProductName = (orderData: any) => {\n    if (orderData?.line_items?.[0]) {\n      return orderData.line_items[0].title;\n    }\n    return \"Camera Equipment\";\n  };\n\n  return (\n    <Card data-testid=\"recent-orders-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <CardTitle className=\"text-lg font-medium\">Recent Orders</CardTitle>\n        <Link href=\"/orders\">\n          <Button variant=\"link\" className=\"text-sm text-primary hover:text-primary/80\" data-testid=\"view-all-orders\">\n            View all orders\n          </Button>\n        </Link>\n      </CardHeader>\n      <CardContent>\n        {recentOrders.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No recent orders found\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {recentOrders.map((order) => (\n              <div\n                key={order.id}\n                className=\"flex items-center justify-between p-3 rounded-md border border-border hover:bg-accent transition-colors\"\n                data-testid={`order-item-${order.id}`}\n              >\n                <div className=\"flex items-center space-x-3\">\n                  <img \n                    src={getProductImage(order.orderData)} \n                    alt={getProductName(order.orderData)}\n                    className=\"w-12 h-12 rounded-md object-cover\"\n                    data-testid={`order-image-${order.id}`}\n                  />\n                  <div>\n                    <p className=\"text-sm font-medium\" data-testid={`order-product-${order.id}`}>\n                      {getProductName(order.orderData)}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\" data-testid={`order-customer-${order.id}`}>\n                      {order.customerEmail}\n                    </p>\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-medium\" data-testid={`order-amount-${order.id}`}>\n                    ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                  </p>\n                  <Badge \n                    variant={getStatusVariant(order.status)} \n                    className=\"text-xs\"\n                    data-testid={`order-status-${order.id}`}\n                  >\n                    {order.status?.charAt(0).toUpperCase() + order.status?.slice(1) || 'Pending'}\n                  </Badge>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":4689},"client/src/components/widgets/team-activity-widget.tsx":{"content":"import { Check, Mail, ShoppingCart, AlertTriangle, Wrench } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Activity } from \"@/lib/types\";\nimport { Link } from \"wouter\";\n\nexport function TeamActivityWidget() {\n  const { data: activities, isLoading } = useQuery<Activity[]>({\n    queryKey: [\"/api/activities\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"team-activity-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse space-y-4\">\n            {[...Array(5)].map((_, i) => (\n              <div key={i} className=\"flex items-start space-x-3\">\n                <div className=\"h-8 w-8 bg-muted rounded-full\"></div>\n                <div className=\"flex-1 space-y-1\">\n                  <div className=\"h-4 bg-muted rounded\"></div>\n                  <div className=\"h-3 bg-muted rounded w-1/2\"></div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const getActivityIcon = (type: string) => {\n    switch (type) {\n      case \"repair_completed\":\n      case \"todo_completed\":\n        return <Check className=\"h-4 w-4 text-white\" />;\n      case \"email_replied\":\n      case \"email_sent\":\n        return <Mail className=\"h-4 w-4 text-white\" />;\n      case \"order_created\":\n      case \"order_updated\":\n        return <ShoppingCart className=\"h-4 w-4 text-white\" />;\n      case \"repair_created\":\n      case \"repair_status_updated\":\n        return <Wrench className=\"h-4 w-4 text-white\" />;\n      default:\n        return <AlertTriangle className=\"h-4 w-4 text-white\" />;\n    }\n  };\n\n  const getActivityColor = (type: string) => {\n    switch (type) {\n      case \"repair_completed\":\n      case \"todo_completed\":\n        return \"bg-chart-2\";\n      case \"email_replied\":\n      case \"email_sent\":\n        return \"bg-primary\";\n      case \"order_created\":\n      case \"order_updated\":\n        return \"bg-chart-4\";\n      case \"repair_created\":\n      case \"repair_status_updated\":\n        return \"bg-chart-2\";\n      default:\n        return \"bg-destructive\";\n    }\n  };\n\n  const formatTimeAgo = (date: string) => {\n    const now = new Date();\n    const activityDate = new Date(date);\n    const diffInMinutes = Math.floor((now.getTime() - activityDate.getTime()) / (1000 * 60));\n    \n    if (diffInMinutes < 1) return \"Just now\";\n    if (diffInMinutes < 60) return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;\n    \n    const diffInHours = Math.floor(diffInMinutes / 60);\n    if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;\n    \n    const diffInDays = Math.floor(diffInHours / 24);\n    return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;\n  };\n\n  return (\n    <Card data-testid=\"team-activity-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <CardTitle className=\"text-lg font-medium\">Team Activity</CardTitle>\n        <Link href=\"/dashboard\">\n          <Button variant=\"link\" className=\"text-sm text-primary hover:text-primary/80\" data-testid=\"view-all-activities\">\n            View all\n          </Button>\n        </Link>\n      </CardHeader>\n      <CardContent>\n        {!activities || activities.length === 0 ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            No recent activity\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            {activities.slice(0, 5).map((activity) => (\n              <div\n                key={activity.id}\n                className=\"flex items-start space-x-3\"\n                data-testid={`activity-item-${activity.id}`}\n              >\n                <div className={`h-8 w-8 rounded-full flex items-center justify-center ${getActivityColor(activity.type)}`}>\n                  {getActivityIcon(activity.type)}\n                </div>\n                <div className=\"flex-1 space-y-1\">\n                  <p className=\"text-sm\" data-testid={`activity-description-${activity.id}`}>\n                    {activity.description}\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\" data-testid={`activity-timestamp-${activity.id}`}>\n                    {formatTimeAgo(typeof activity.createdAt === 'string' ? activity.createdAt : new Date().toISOString())}\n                  </p>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":4600},"client/src/components/email/email-attachments.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Paperclip, Download, FileIcon, Eye, ExternalLink } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\ninterface EmailAttachment {\n  id: string;\n  filename: string;\n  contentType: string | null;\n  size: number | null;\n  storageUrl: string;\n  isInline: boolean;\n}\n\ninterface EmailAttachmentsProps {\n  messageId: string;\n}\n\nexport function EmailAttachments({ messageId }: EmailAttachmentsProps) {\n  const [isPreviewOpen, setIsPreviewOpen] = useState(false);\n  const [selectedAttachment, setSelectedAttachment] = useState<EmailAttachment | null>(null);\n\n  const { data: attachments, isLoading } = useQuery({\n    queryKey: ['email-attachments', messageId],\n    queryFn: async (): Promise<EmailAttachment[]> => {\n      const response = await fetch(`/api/emails/${messageId}/attachments`);\n      if (!response.ok) {\n        throw new Error('Failed to fetch attachments');\n      }\n      return response.json();\n    },\n  });\n\n  const handlePreview = (attachment: EmailAttachment) => {\n    setSelectedAttachment(attachment);\n    setIsPreviewOpen(true);\n  };\n\n  const handleDownload = async (attachment: EmailAttachment) => {\n    try {\n      // Remove the leading /attachments from storageUrl since the API endpoint expects /api/attachments/:path\n      const attachmentPath = attachment.storageUrl.startsWith('/attachments/') \n        ? attachment.storageUrl.substring('/attachments/'.length)\n        : attachment.storageUrl;\n      const response = await fetch(`/api/attachments/${attachmentPath}`);\n      if (!response.ok) {\n        throw new Error('Failed to download attachment');\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = attachment.filename;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      window.URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Error downloading attachment:', error);\n      // Could add toast notification here\n    }\n  };\n\n  const formatFileSize = (size: number | null) => {\n    if (!size) return 'Unknown size';\n    if (size < 1024) return `${size} B`;\n    if (size < 1024 * 1024) return `${(size / 1024).toFixed(1)} KB`;\n    return `${(size / 1024 / 1024).toFixed(1)} MB`;\n  };\n\n  const getFileIcon = (contentType: string | null, filename: string) => {\n    if (!contentType) return FileIcon;\n    \n    if (contentType.startsWith('image/')) return FileIcon;\n    if (contentType.includes('pdf')) return FileIcon;\n    if (contentType.includes('word') || contentType.includes('document')) return FileIcon;\n    if (contentType.includes('excel') || contentType.includes('spreadsheet')) return FileIcon;\n    if (contentType.includes('powerpoint') || contentType.includes('presentation')) return FileIcon;\n    \n    return FileIcon;\n  };\n\n  const canPreview = (contentType: string | null, filename: string) => {\n    // Check both contentType and filename extension for better file type detection\n    const isImage = contentType?.startsWith('image/') || /\\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(filename);\n    const isPdf = contentType?.includes('pdf') || filename.toLowerCase().endsWith('.pdf');\n    return isImage || isPdf;\n  };\n\n  const renderPreviewContent = () => {\n    if (!selectedAttachment) return null;\n\n    const { contentType, storageUrl, filename, id } = selectedAttachment;\n    // Remove the leading /attachments from storageUrl since the API endpoint expects /api/attachments/:path\n    const attachmentPath = storageUrl.startsWith('/attachments/') \n      ? storageUrl.substring('/attachments/'.length)\n      : storageUrl;\n    const attachmentUrl = `/api/attachments/${attachmentPath}`;\n\n    // Check both contentType and filename extension for better file type detection\n    const isImage = contentType?.startsWith('image/') || /\\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(filename);\n    const isPdf = contentType?.includes('pdf') || filename.toLowerCase().endsWith('.pdf');\n\n    if (isImage) {\n      return (\n        <div className=\"flex justify-center\">\n          <img\n            src={attachmentUrl}\n            alt={filename}\n            className=\"max-w-full max-h-[500px] object-contain rounded\"\n            data-testid={`img-preview-${id}`}\n          />\n        </div>\n      );\n    }\n\n    if (isPdf) {\n      return (\n        <iframe\n          src={attachmentUrl}\n          title={filename}\n          className=\"w-full h-[500px] border rounded\"\n          data-testid={`pdf-preview-${id}`}\n        />\n      );\n    }\n\n    return (\n      <div className=\"text-center py-8\">\n        <FileIcon className=\"h-16 w-16 mx-auto mb-4 text-muted-foreground\" />\n        <p className=\"text-lg font-medium\">{filename}</p>\n        <p className=\"text-muted-foreground\">Preview not available for this file type</p>\n        <p className=\"text-sm text-muted-foreground mt-2\">Use the buttons below to download or open in a new tab</p>\n      </div>\n    );\n  };\n\n  if (isLoading) {\n    return null; // Don't show loading state to keep it clean\n  }\n\n  if (!attachments || attachments.length === 0) {\n    return null; // No attachments, don't render anything\n  }\n\n  return (\n    <div className=\"mt-3 pt-3 border-t\" data-testid=\"email-attachments\">\n      <div className=\"space-y-2\">\n        <div className=\"flex items-center space-x-2 text-sm text-muted-foreground mb-2\">\n          <Paperclip className=\"h-4 w-4\" />\n          <span>{attachments.length} attachment(s)</span>\n        </div>\n        \n        <div className=\"space-y-2\">\n          {attachments.map((attachment) => {\n            const FileIconComponent = getFileIcon(attachment.contentType, attachment.filename);\n            \n            return (\n              <div\n                key={attachment.id}\n                className=\"flex items-center justify-between p-2 bg-muted/30 rounded-md hover:bg-muted/50 transition-colors\"\n                data-testid={`attachment-${attachment.filename}`}\n              >\n                <div className=\"flex items-center space-x-3 flex-1 min-w-0\">\n                  <FileIconComponent className=\"h-4 w-4 text-muted-foreground flex-shrink-0\" />\n                  <div className=\"flex-1 min-w-0\">\n                    <button\n                      onClick={() => handlePreview(attachment)}\n                      className=\"font-medium text-sm truncate hover:text-primary transition-colors text-left w-full\"\n                      title={attachment.filename}\n                      data-testid={`link-preview-${attachment.filename}`}\n                    >\n                      {attachment.filename}\n                    </button>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {formatFileSize(attachment.size)}\n                      {attachment.contentType && (\n                        <span className=\"ml-2\">‚Ä¢ {attachment.contentType}</span>\n                      )}\n                      {attachment.isInline && (\n                        <Badge variant=\"outline\" className=\"ml-2 text-xs\">Inline</Badge>\n                      )}\n                    </div>\n                  </div>\n                </div>\n                \n                <div className=\"flex items-center space-x-1\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handlePreview(attachment)}\n                    className=\"flex-shrink-0\"\n                    data-testid={`button-preview-${attachment.filename}`}\n                    disabled={!canPreview(attachment.contentType, attachment.filename)}\n                  >\n                    <Eye className=\"h-4 w-4\" />\n                  </Button>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleDownload(attachment)}\n                    className=\"flex-shrink-0\"\n                    data-testid={`download-${attachment.filename}`}\n                  >\n                    <Download className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n\n      {/* Preview Modal */}\n      <Dialog open={isPreviewOpen} onOpenChange={setIsPreviewOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-auto\" data-testid=\"modal-attachment-preview\">\n          <DialogHeader>\n            <DialogTitle>\n              {selectedAttachment?.filename}\n            </DialogTitle>\n            <DialogDescription>\n              {selectedAttachment?.contentType && (\n                <span className=\"mr-4\">Type: {selectedAttachment.contentType}</span>\n              )}\n              {selectedAttachment?.size && (\n                <span>Size: {formatFileSize(selectedAttachment.size)}</span>\n              )}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"mt-4\">\n            {renderPreviewContent()}\n          </div>\n          \n          <DialogFooter className=\"gap-2\">\n            <Button\n              variant=\"outline\"\n              asChild\n              data-testid=\"button-open-new-tab\"\n            >\n              <a\n                href={selectedAttachment ? \n                  `/api/attachments/${selectedAttachment.storageUrl.startsWith('/attachments/') \n                    ? selectedAttachment.storageUrl.substring('/attachments/'.length)\n                    : selectedAttachment.storageUrl}` : '#'}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                <ExternalLink className=\"h-4 w-4 mr-2\" />\n                Open in New Tab\n              </a>\n            </Button>\n            <Button\n              onClick={() => selectedAttachment && handleDownload(selectedAttachment)}\n              data-testid=\"button-download-from-modal\"\n            >\n              <Download className=\"h-4 w-4 mr-2\" />\n              Download\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":10356},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1419},"client/src/pages/case-detail.tsx":{"content":"import { useState } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport type { User } from \"@shared/schema\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { \n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { \n  ArrowLeft, \n  Edit,\n  Save,\n  X,\n  Mail,\n  Package,\n  Wrench,\n  CheckSquare,\n  StickyNote,\n  Calendar,\n  User as UserIcon,\n  AlertTriangle,\n  Clock,\n  Link as LinkIcon,\n  Unlink,\n  Plus,\n  MessageSquare,\n  Activity,\n  FileText\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { Case, CaseWithDetails, EmailThread, Order, Repair, Todo, InternalNote } from \"@/lib/types\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { NotesPanel } from \"@/components/notes/NotesPanel\";\nimport { EmailCompose } from \"@/components/email/email-compose\";\n\nconst CASE_STATUS_OPTIONS = [\n  { value: \"new\", label: \"New\" },\n  { value: \"in_progress\", label: \"In Progress\" },\n  { value: \"waiting_customer\", label: \"Waiting Customer\" },\n  { value: \"waiting_part\", label: \"Waiting Part\" },\n  { value: \"resolved\", label: \"Resolved\" },\n  { value: \"closed\", label: \"Closed\" },\n];\n\nconst PRIORITY_OPTIONS = [\n  { value: \"low\", label: \"Low\" },\n  { value: \"medium\", label: \"Medium\" },\n  { value: \"high\", label: \"High\" },\n  { value: \"urgent\", label: \"Urgent\" },\n];\n\nexport default function CaseDetail() {\n  const params = useParams();\n  const caseId = params.id;\n  const [isEditing, setIsEditing] = useState(false);\n  const [editTitle, setEditTitle] = useState(\"\");\n  const [editDescription, setEditDescription] = useState(\"\");\n  const [showEmailDialog, setShowEmailDialog] = useState(false);\n  const [showLinkDialog, setShowLinkDialog] = useState(false);\n  const [showAddNoteDialog, setShowAddNoteDialog] = useState(false);\n  const [newNoteContent, setNewNoteContent] = useState(\"\");\n  const [showAssignDialog, setShowAssignDialog] = useState(false);\n  const [selectedUserId, setSelectedUserId] = useState(\"\");\n  const [showSlaDialog, setShowSlaDialog] = useState(false);\n  const [slaDeadline, setSlaDeadline] = useState(\"\");\n  const [linkType, setLinkType] = useState<\"email\" | \"order\" | \"repair\" | \"todo\" | \"\">(\"\");\n  const [linkedId, setLinkedId] = useState(\"\");\n  const [showConvertDialog, setShowConvertDialog] = useState(false);\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n\n  const { data: caseData, isLoading } = useQuery<CaseWithDetails>({\n    queryKey: [\"/api/cases\", caseId],\n    enabled: !!caseId,\n  });\n\n  const { data: relatedEmails } = useQuery<EmailThread[]>({\n    queryKey: [\"/api/email-threads\", \"caseId\", caseId],\n    queryFn: async () => {\n      const response = await fetch(`/api/email-threads?caseId=${caseId}`);\n      if (!response.ok) throw new Error('Failed to fetch related emails');\n      return response.json();\n    },\n    enabled: !!caseId,\n  });\n\n  const { data: relatedOrders } = useQuery<Order[]>({\n    queryKey: [\"/api/orders\", \"caseId\", caseId],\n    queryFn: async () => {\n      const response = await fetch(`/api/orders?caseId=${caseId}`);\n      if (!response.ok) throw new Error('Failed to fetch related orders');\n      return response.json();\n    },\n    enabled: !!caseId,\n  });\n\n  const { data: relatedRepairs } = useQuery<Repair[]>({\n    queryKey: [\"/api/repairs\", \"caseId\", caseId],\n    queryFn: async () => {\n      const response = await fetch(`/api/repairs?caseId=${caseId}`);\n      if (!response.ok) throw new Error('Failed to fetch related repairs');\n      return response.json();\n    },\n    enabled: !!caseId,\n  });\n\n  const { data: relatedTodos } = useQuery<Todo[]>({\n    queryKey: [\"/api/todos\", \"caseId\", caseId],\n    queryFn: async () => {\n      const response = await fetch(`/api/todos?caseId=${caseId}`);\n      if (!response.ok) throw new Error('Failed to fetch related todos');\n      return response.json();\n    },\n    enabled: !!caseId,\n  });\n\n  const { data: currentUser } = useQuery<User>({\n    queryKey: [\"/api/auth/session\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/session\");\n      if (!response.ok) throw new Error(\"Not authenticated\");\n      const data = await response.json();\n      return data.user;\n    },\n  });\n\n  const { data: internalNotes } = useQuery<InternalNote[]>({\n    queryKey: [\"/api/internal-notes\", \"caseId\", caseId],\n    queryFn: async () => {\n      const response = await fetch(`/api/internal-notes?caseId=${caseId}`);\n      if (!response.ok) throw new Error('Failed to fetch internal notes');\n      return response.json();\n    },\n    enabled: !!caseId,\n  });\n\n  const { data: caseNotes = [] } = useQuery<any[]>({\n    queryKey: [\"/api/cases\", caseId, \"notes\"],\n    enabled: !!caseId,\n  });\n\n  const { data: caseEvents = [] } = useQuery<any[]>({\n    queryKey: [\"/api/cases\", caseId, \"events\"],\n    enabled: !!caseId,\n  });\n\n  const { data: users = [] } = useQuery<any[]>({\n    queryKey: [\"/api/users/list\"],\n  });\n\n  const { data: caseLinks = [] } = useQuery<any[]>({\n    queryKey: [\"/api/cases\", caseId, \"links\"],\n    enabled: !!caseId && showLinkDialog,\n  });\n\n  const { data: allEmails = [] } = useQuery<any[]>({\n    queryKey: [\"/api/email-threads\"],\n    enabled: showLinkDialog && linkType === \"email\",\n  });\n\n  const { data: allOrdersResponse } = useQuery<any>({\n    queryKey: [\"/api/orders\", { page: 1, limit: 1000 }],\n    queryFn: async () => {\n      const response = await fetch(\"/api/orders?page=1&limit=1000\");\n      if (!response.ok) throw new Error(\"Failed to fetch orders\");\n      return response.json();\n    },\n    enabled: showLinkDialog && linkType === \"order\",\n  });\n\n  const allOrders = allOrdersResponse?.orders || [];\n\n  const { data: allRepairsResponse } = useQuery<any>({\n    queryKey: [\"/api/repairs\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/repairs\");\n      if (!response.ok) throw new Error(\"Failed to fetch repairs\");\n      const data = await response.json();\n      return Array.isArray(data) ? data : (data.repairs || []);\n    },\n    enabled: showLinkDialog && linkType === \"repair\",\n  });\n\n  const allRepairs = Array.isArray(allRepairsResponse) ? allRepairsResponse : (allRepairsResponse?.repairs || allRepairsResponse || []);\n\n  const { data: allTodosResponse } = useQuery<any>({\n    queryKey: [\"/api/todos\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/todos\");\n      if (!response.ok) throw new Error(\"Failed to fetch todos\");\n      const data = await response.json();\n      return Array.isArray(data) ? data : (data.todos || []);\n    },\n    enabled: showLinkDialog && linkType === \"todo\",\n  });\n\n  const allTodos = Array.isArray(allTodosResponse) ? allTodosResponse : (allTodosResponse?.todos || allTodosResponse || []);\n\n  const updateCaseMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Case> }) => {\n      const response = await fetch(`/api/cases/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId] });\n      toast({\n        title: \"Case updated\",\n        description: \"Case has been updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const addNoteMutation = useMutation({\n    mutationFn: async (content: string) => {\n      const response = await fetch(`/api/cases/${caseId}/notes`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ content }),\n      });\n      if (!response.ok) throw new Error(\"Failed to add note\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"notes\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"events\"] });\n      setNewNoteContent(\"\");\n      setShowAddNoteDialog(false);\n      toast({\n        title: \"Note added\",\n        description: \"Note has been added successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to add note\",\n        description: \"Could not add note to case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const assignCaseMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      const response = await fetch(`/api/cases/${caseId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ assignedTo: userId }),\n      });\n      if (!response.ok) throw new Error(\"Failed to assign case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"events\"] });\n      setShowAssignDialog(false);\n      setSelectedUserId(\"\");\n      toast({\n        title: \"Case assigned\",\n        description: \"Case has been assigned successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to assign case\",\n        description: \"Could not assign case to user\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const setSlaMutation = useMutation({\n    mutationFn: async (deadline: string) => {\n      const response = await fetch(`/api/cases/${caseId}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ slaDeadline: deadline }),\n      });\n      if (!response.ok) throw new Error(\"Failed to set SLA deadline\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"events\"] });\n      setShowSlaDialog(false);\n      setSlaDeadline(\"\");\n      toast({\n        title: \"SLA deadline set\",\n        description: \"SLA deadline has been set successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to set SLA\",\n        description: \"Could not set SLA deadline\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const linkItemMutation = useMutation({\n    mutationFn: async ({ type, id }: { type: string; id: string }) => {\n      const response = await fetch(`/api/cases/${caseId}/links`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ linkType: type, linkedId: id }),\n      });\n      if (!response.ok) throw new Error(\"Failed to link item\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"links\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"events\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\", \"caseId\", caseId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/orders\", \"caseId\", caseId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/repairs\", \"caseId\", caseId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/todos\", \"caseId\", caseId] });\n      setShowLinkDialog(false);\n      setLinkType(\"\");\n      setLinkedId(\"\");\n      toast({\n        title: \"Item linked\",\n        description: \"Item has been linked to case successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to link item\",\n        description: \"Could not link item to case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const convertToReturnMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(`/api/returns/from-case/${caseId}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n      });\n      if (!response.ok) throw new Error(\"Failed to convert case to return\");\n      return response.json();\n    },\n    onSuccess: (returnData) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"events\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n      setShowConvertDialog(false);\n      toast({\n        title: \"Return created\",\n        description: `Return ${returnData.returnNumber} created successfully from this case`,\n      });\n      // Navigate to the new return\n      setLocation(`/returns/${returnData.id}`);\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to convert\",\n        description: \"Could not convert case to return\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleStartEdit = () => {\n    if (caseData) {\n      setEditTitle(caseData.title);\n      setEditDescription(caseData.description || \"\");\n      setIsEditing(true);\n    }\n  };\n\n  const handleSaveEdit = () => {\n    if (caseData && caseId) {\n      updateCaseMutation.mutate({\n        id: caseId,\n        data: { \n          title: editTitle, \n          description: editDescription || null \n        }\n      });\n      setIsEditing(false);\n    }\n  };\n\n  const handleCancelEdit = () => {\n    setIsEditing(false);\n    setEditTitle(\"\");\n    setEditDescription(\"\");\n  };\n\n  const handleStatusChange = (newStatus: string) => {\n    if (caseData && caseId) {\n      updateCaseMutation.mutate({\n        id: caseId,\n        data: { status: newStatus as any }\n      });\n    }\n  };\n\n  const handlePriorityChange = (newPriority: string) => {\n    if (caseData && caseId) {\n      updateCaseMutation.mutate({\n        id: caseId,\n        data: { priority: newPriority as any }\n      });\n    }\n  };\n\n  const getPriorityVariant = (priority: string | null) => {\n    switch (priority) {\n      case \"urgent\": return \"destructive\";\n      case \"high\": return \"destructive\";\n      case \"medium\": return \"secondary\";\n      case \"low\": return \"outline\";\n      default: return \"secondary\";\n    }\n  };\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"new\": return \"outline\";\n      case \"in_progress\": return \"default\";\n      case \"waiting_customer\": return \"secondary\";\n      case \"waiting_part\": return \"secondary\";\n      case \"resolved\": return \"default\";\n      case \"closed\": return \"outline\";\n      default: return \"secondary\";\n    }\n  };\n\n  const formatDate = (date: Date | string | null) => {\n    if (!date) return \"Not set\";\n    const dateObj = typeof date === 'string' ? new Date(date) : date;\n    return dateObj.toLocaleDateString();\n  };\n\n  const formatDateTime = (date: Date | string | null) => {\n    if (!date) return 'Not available';\n    const dateObj = typeof date === 'string' ? new Date(date) : date;\n    return dateObj.toLocaleString();\n  };\n\n  const getAvailableItems = () => {\n    const linkedIds = caseLinks.map((link: any) => link.linkedId);\n    \n    switch (linkType) {\n      case \"email\":\n        return allEmails.filter((item: any) => !linkedIds.includes(item.id));\n      case \"order\":\n        return allOrders.filter((item: any) => !linkedIds.includes(item.id));\n      case \"repair\":\n        return allRepairs.filter((item: any) => !linkedIds.includes(item.id));\n      case \"todo\":\n        return allTodos.filter((item: any) => !linkedIds.includes(item.id));\n      default:\n        return [];\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Navigation />\n        <main className=\"container mx-auto px-4 py-6\">\n          <div className=\"animate-pulse\">\n            <div className=\"h-8 bg-muted rounded mb-4\"></div>\n            <div className=\"grid gap-6\">\n              <div className=\"h-32 bg-muted rounded\"></div>\n              <div className=\"h-64 bg-muted rounded\"></div>\n            </div>\n          </div>\n        </main>\n      </div>\n    );\n  }\n\n  if (!caseData) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Navigation />\n        <main className=\"container mx-auto px-4 py-6\">\n          <div className=\"text-center py-8\">\n            <h2 className=\"text-2xl font-semibold mb-2\">Case not found</h2>\n            <p className=\"text-muted-foreground mb-4\">The case you're looking for doesn't exist.</p>\n            <Button onClick={() => window.history.back()}>\n              <ArrowLeft className=\"mr-2 h-4 w-4\" />\n              Go Back\n            </Button>\n          </div>\n        </main>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"case-detail-page\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between mb-6\" data-testid=\"case-header\">\n          <div className=\"flex items-center space-x-4\">\n            <Button variant=\"ghost\" size=\"sm\" onClick={() => window.history.back()} data-testid=\"back-button\">\n              <ArrowLeft className=\"h-4 w-4\" />\n            </Button>\n            <div>\n              <div className=\"flex items-center space-x-2\">\n                <h1 className=\"text-2xl font-bold\">Case #{caseData.caseNumber}</h1>\n                <Badge variant={getStatusVariant(caseData.status)} data-testid=\"case-status-badge\">\n                  {CASE_STATUS_OPTIONS.find(s => s.value === caseData.status)?.label}\n                </Badge>\n                <Badge variant={getPriorityVariant(caseData.priority)} data-testid=\"case-priority-badge\">\n                  {caseData.priority}\n                </Badge>\n              </div>\n              <p className=\"text-sm text-muted-foreground\">\n                Created {formatDateTime(caseData.createdAt)}\n              </p>\n            </div>\n          </div>\n\n          <div className=\"flex items-center space-x-2\">\n            <Select value={caseData.status} onValueChange={handleStatusChange}>\n              <SelectTrigger className=\"w-40\" data-testid=\"status-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {CASE_STATUS_OPTIONS.map(option => (\n                  <SelectItem key={option.value} value={option.value}>\n                    {option.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            <Select value={caseData.priority || undefined} onValueChange={handlePriorityChange}>\n              <SelectTrigger className=\"w-32\" data-testid=\"priority-select\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {PRIORITY_OPTIONS.map(option => (\n                  <SelectItem key={option.value} value={option.value}>\n                    {option.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            <Button onClick={() => setShowEmailDialog(true)} data-testid=\"send-email-button\">\n              <Mail className=\"mr-2 h-4 w-4\" />\n              Send Email\n            </Button>\n\n            <Button variant=\"outline\" onClick={() => setShowConvertDialog(true)} data-testid=\"convert-to-return-button\">\n              <Package className=\"mr-2 h-4 w-4\" />\n              Convert to Return\n            </Button>\n          </div>\n        </div>\n\n        {/* Case Details */}\n        <div className=\"grid gap-6 md:grid-cols-3\">\n          {/* Main Content */}\n          <div className=\"md:col-span-2 space-y-6\">\n            {/* Case Information */}\n            <Card data-testid=\"case-information\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <CardTitle>Case Information</CardTitle>\n                  {isEditing ? (\n                    <div className=\"flex items-center space-x-2\">\n                      <Button size=\"sm\" onClick={handleSaveEdit} data-testid=\"save-edit-button\">\n                        <Save className=\"mr-2 h-4 w-4\" />\n                        Save\n                      </Button>\n                      <Button size=\"sm\" variant=\"outline\" onClick={handleCancelEdit} data-testid=\"cancel-edit-button\">\n                        <X className=\"mr-2 h-4 w-4\" />\n                        Cancel\n                      </Button>\n                    </div>\n                  ) : (\n                    <Button size=\"sm\" variant=\"outline\" onClick={handleStartEdit} data-testid=\"edit-case-button\">\n                      <Edit className=\"mr-2 h-4 w-4\" />\n                      Edit\n                    </Button>\n                  )}\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm font-medium\">Title</label>\n                  {isEditing ? (\n                    <Input \n                      value={editTitle} \n                      onChange={(e) => setEditTitle(e.target.value)}\n                      data-testid=\"edit-title-input\"\n                    />\n                  ) : (\n                    <p className=\"mt-1\" data-testid=\"case-title\">{caseData.title}</p>\n                  )}\n                </div>\n                \n                <div>\n                  <label className=\"text-sm font-medium\">Description</label>\n                  {isEditing ? (\n                    <Textarea \n                      value={editDescription} \n                      onChange={(e) => setEditDescription(e.target.value)}\n                      rows={4}\n                      data-testid=\"edit-description-input\"\n                    />\n                  ) : (\n                    <p className=\"mt-1 whitespace-pre-wrap\" data-testid=\"case-description\">\n                      {caseData.description || \"No description provided\"}\n                    </p>\n                  )}\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"text-sm font-medium\">Customer</label>\n                    <p className=\"mt-1\" data-testid=\"case-customer\">\n                      {caseData.customer ? (\n                        `${caseData.customer.firstName} ${caseData.customer.lastName}`\n                      ) : (\n                        caseData.customerEmail\n                      )}\n                    </p>\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Assigned To</label>\n                    <p className=\"mt-1\" data-testid=\"case-assignee\">\n                      {caseData.assignedUser ? (\n                        `${caseData.assignedUser.firstName} ${caseData.assignedUser.lastName}`\n                      ) : (\n                        \"Unassigned\"\n                      )}\n                    </p>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"text-sm font-medium\">SLA Deadline</label>\n                    <p className=\"mt-1\" data-testid=\"case-sla-deadline\">{formatDate(caseData.slaDeadline)}</p>\n                  </div>\n                  <div>\n                    <label className=\"text-sm font-medium\">Last Updated</label>\n                    <p className=\"mt-1\" data-testid=\"case-updated\">{formatDateTime(caseData.updatedAt)}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Timeline */}\n            <Card data-testid=\"case-timeline\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center\">\n                  <Activity className=\"mr-2 h-4 w-4\" />\n                  Timeline\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {caseEvents && caseEvents.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {caseEvents.map((event: any) => (\n                      <div key={event.id} className=\"flex items-start space-x-3 border-l-2 border-muted pl-4\" data-testid={`timeline-event-${event.id}`}>\n                        <div className=\"flex-1\">\n                          <p className=\"text-sm font-medium\">{event.message}</p>\n                          {event.metadata && (\n                            <p className=\"text-xs text-muted-foreground mt-1\">\n                              {JSON.stringify(event.metadata)}\n                            </p>\n                          )}\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            {formatDateTime(event.createdAt)} ‚Ä¢ {event.createdByUser?.username || 'System'}\n                          </p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <p className=\"text-muted-foreground\">No timeline events yet</p>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Related Items Tabs */}\n            <Card data-testid=\"related-items\">\n              <Tabs defaultValue=\"emails\" className=\"w-full\">\n                <CardHeader>\n                  <CardTitle>Related Items</CardTitle>\n                  <TabsList className=\"grid w-full grid-cols-5\">\n                    <TabsTrigger value=\"emails\" data-testid=\"emails-tab\">\n                      <Mail className=\"mr-2 h-4 w-4\" />\n                      Emails ({relatedEmails?.length || 0})\n                    </TabsTrigger>\n                    <TabsTrigger value=\"orders\" data-testid=\"orders-tab\">\n                      <Package className=\"mr-2 h-4 w-4\" />\n                      Orders ({relatedOrders?.length || 0})\n                    </TabsTrigger>\n                    <TabsTrigger value=\"repairs\" data-testid=\"repairs-tab\">\n                      <Wrench className=\"mr-2 h-4 w-4\" />\n                      Repairs ({relatedRepairs?.length || 0})\n                    </TabsTrigger>\n                    <TabsTrigger value=\"todos\" data-testid=\"todos-tab\">\n                      <CheckSquare className=\"mr-2 h-4 w-4\" />\n                      To-dos ({relatedTodos?.length || 0})\n                    </TabsTrigger>\n                    <TabsTrigger value=\"notes\" data-testid=\"notes-tab\">\n                      <StickyNote className=\"mr-2 h-4 w-4\" />\n                      Notes ({internalNotes?.length || 0})\n                    </TabsTrigger>\n                  </TabsList>\n                </CardHeader>\n                \n                <CardContent>\n                  <TabsContent value=\"emails\" className=\"space-y-4\" data-testid=\"emails-content\">\n                    {relatedEmails?.length ? (\n                      relatedEmails.map(email => (\n                        <div key={email.id} className=\"border rounded p-4\">\n                          <div className=\"flex items-center justify-between mb-2\">\n                            <h4 className=\"font-medium\">{email.subject}</h4>\n                            <Badge variant={email.isUnread ? \"default\" : \"secondary\"}>\n                              {email.isUnread ? \"Unread\" : \"Read\"}\n                            </Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-2\">\n                            From: {email.customerEmail}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {formatDateTime(email.createdAt)}\n                          </p>\n                        </div>\n                      ))\n                    ) : (\n                      <p className=\"text-muted-foreground\">No emails linked to this case</p>\n                    )}\n                  </TabsContent>\n\n                  <TabsContent value=\"orders\" className=\"space-y-4\" data-testid=\"orders-content\">\n                    {relatedOrders?.length ? (\n                      relatedOrders.map(order => (\n                        <div key={order.id} className=\"border rounded p-4\">\n                          <div className=\"flex items-center justify-between mb-2\">\n                            <h4 className=\"font-medium\">Order #{order.orderNumber}</h4>\n                            <Badge>{order.status}</Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {order.customerEmail} ‚Ä¢ ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {formatDateTime(order.createdAt)}\n                          </p>\n                        </div>\n                      ))\n                    ) : (\n                      <p className=\"text-muted-foreground\">No orders linked to this case</p>\n                    )}\n                  </TabsContent>\n\n                  <TabsContent value=\"repairs\" className=\"space-y-4\" data-testid=\"repairs-content\">\n                    {relatedRepairs?.length ? (\n                      relatedRepairs.map(repair => (\n                        <div key={repair.id} className=\"border rounded p-4\">\n                          <div className=\"flex items-center justify-between mb-2\">\n                            <h4 className=\"font-medium\">{repair.title}</h4>\n                            <Badge>{repair.status}</Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-2\">\n                            {repair.description}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            Priority: {repair.priority} ‚Ä¢ {formatDateTime(repair.createdAt)}\n                          </p>\n                        </div>\n                      ))\n                    ) : (\n                      <p className=\"text-muted-foreground\">No repairs linked to this case</p>\n                    )}\n                  </TabsContent>\n\n                  <TabsContent value=\"todos\" className=\"space-y-4\" data-testid=\"todos-content\">\n                    {relatedTodos?.length ? (\n                      relatedTodos.map(todo => (\n                        <div key={todo.id} className=\"border rounded p-4\">\n                          <div className=\"flex items-center justify-between mb-2\">\n                            <h4 className=\"font-medium\">{todo.title}</h4>\n                            <Badge>{todo.status}</Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground mb-2\">\n                            {todo.description}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            Priority: {todo.priority} ‚Ä¢ Due: {formatDate(todo.dueDate)}\n                          </p>\n                        </div>\n                      ))\n                    ) : (\n                      <p className=\"text-muted-foreground\">No todos linked to this case</p>\n                    )}\n                  </TabsContent>\n\n                  <TabsContent value=\"notes\" className=\"space-y-4\" data-testid=\"notes-content\">\n                    {/* Case Notes */}\n                    {caseNotes && caseNotes.length > 0 && (\n                      <div className=\"space-y-3 mb-6\">\n                        <h4 className=\"font-medium text-sm\">Case Notes</h4>\n                        {caseNotes.map((note: any) => (\n                          <div key={note.id} className=\"border rounded p-4\" data-testid={`case-note-${note.id}`}>\n                            <p className=\"text-sm whitespace-pre-wrap\">{note.content}</p>\n                            <p className=\"text-xs text-muted-foreground mt-2\">\n                              {formatDateTime(note.createdAt)} ‚Ä¢ {note.createdByUser?.username || 'Unknown'}\n                            </p>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                    \n                    {/* Internal Notes */}\n                    <div>\n                      <h4 className=\"font-medium text-sm mb-3\">Internal Notes</h4>\n                      {currentUser && (\n                        <NotesPanel entityType=\"case\" entityId={caseId!} currentUser={currentUser} />\n                      )}\n                    </div>\n                  </TabsContent>\n                </CardContent>\n              </Tabs>\n            </Card>\n          </div>\n\n          {/* Sidebar */}\n          <div className=\"space-y-6\">\n            {/* Quick Actions */}\n            <Card data-testid=\"quick-actions\">\n              <CardHeader>\n                <CardTitle>Quick Actions</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-2\">\n                <Button className=\"w-full justify-start\" variant=\"outline\" onClick={() => setShowEmailDialog(true)} data-testid=\"button-send-email-quick-action\">\n                  <Mail className=\"mr-2 h-4 w-4\" />\n                  Send Email\n                </Button>\n                <Button className=\"w-full justify-start\" variant=\"outline\" onClick={() => setShowAssignDialog(true)} data-testid=\"assign-case-button\">\n                  <UserIcon className=\"mr-2 h-4 w-4\" />\n                  Assign Case\n                </Button>\n                <Button className=\"w-full justify-start\" variant=\"outline\" onClick={() => setShowLinkDialog(true)} data-testid=\"link-items-button\">\n                  <LinkIcon className=\"mr-2 h-4 w-4\" />\n                  Link Items\n                </Button>\n                <Button className=\"w-full justify-start\" variant=\"outline\" onClick={() => setShowAddNoteDialog(true)} data-testid=\"add-note-button\">\n                  <MessageSquare className=\"mr-2 h-4 w-4\" />\n                  Add Note\n                </Button>\n                <Button className=\"w-full justify-start\" variant=\"outline\" onClick={() => setShowSlaDialog(true)} data-testid=\"set-sla-button\">\n                  <Clock className=\"mr-2 h-4 w-4\" />\n                  Set SLA\n                </Button>\n              </CardContent>\n            </Card>\n\n            {/* Case Statistics */}\n            <Card data-testid=\"case-stats\">\n              <CardHeader>\n                <CardTitle>Case Statistics</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm\">Emails</span>\n                  <span className=\"text-sm font-medium\">{relatedEmails?.length || 0}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm\">Orders</span>\n                  <span className=\"text-sm font-medium\">{relatedOrders?.length || 0}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm\">Repairs</span>\n                  <span className=\"text-sm font-medium\">{relatedRepairs?.length || 0}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm\">To-dos</span>\n                  <span className=\"text-sm font-medium\">{relatedTodos?.length || 0}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-sm\">Notes</span>\n                  <span className=\"text-sm font-medium\">{(caseNotes?.length || 0) + (internalNotes?.length || 0)}</span>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </main>\n\n      {/* Add Note Dialog */}\n      <Dialog open={showAddNoteDialog} onOpenChange={setShowAddNoteDialog}>\n        <DialogContent data-testid=\"add-note-dialog\">\n          <DialogHeader>\n            <DialogTitle>Add Note to Case</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <Textarea\n              placeholder=\"Enter your note here...\"\n              value={newNoteContent}\n              onChange={(e) => setNewNoteContent(e.target.value)}\n              rows={6}\n              data-testid=\"note-content-input\"\n            />\n            <div className=\"flex justify-end space-x-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setShowAddNoteDialog(false);\n                  setNewNoteContent(\"\");\n                }}\n                data-testid=\"cancel-note-button\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => addNoteMutation.mutate(newNoteContent)}\n                disabled={!newNoteContent.trim() || addNoteMutation.isPending}\n                data-testid=\"save-note-button\"\n              >\n                {addNoteMutation.isPending ? \"Saving...\" : \"Save Note\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Assign Case Dialog */}\n      <Dialog open={showAssignDialog} onOpenChange={setShowAssignDialog}>\n        <DialogContent data-testid=\"assign-case-dialog\">\n          <DialogHeader>\n            <DialogTitle>Assign Case</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Select User</label>\n              <Select value={selectedUserId} onValueChange={setSelectedUserId}>\n                <SelectTrigger data-testid=\"user-select\">\n                  <SelectValue placeholder=\"Choose a user to assign...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {users.map((user: any) => (\n                    <SelectItem key={user.id} value={user.id} data-testid={`user-option-${user.id}`}>\n                      {user.firstName} {user.lastName} ({user.username})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"flex justify-end space-x-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setShowAssignDialog(false);\n                  setSelectedUserId(\"\");\n                }}\n                data-testid=\"cancel-assign-button\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => assignCaseMutation.mutate(selectedUserId)}\n                disabled={!selectedUserId || assignCaseMutation.isPending}\n                data-testid=\"save-assign-button\"\n              >\n                {assignCaseMutation.isPending ? \"Assigning...\" : \"Assign Case\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Set SLA Dialog */}\n      <Dialog open={showSlaDialog} onOpenChange={setShowSlaDialog}>\n        <DialogContent data-testid=\"set-sla-dialog\">\n          <DialogHeader>\n            <DialogTitle>Set SLA Deadline</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Deadline Date</label>\n              <Input\n                type=\"datetime-local\"\n                value={slaDeadline}\n                onChange={(e) => setSlaDeadline(e.target.value)}\n                data-testid=\"sla-deadline-input\"\n              />\n            </div>\n            <div className=\"flex justify-end space-x-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setShowSlaDialog(false);\n                  setSlaDeadline(\"\");\n                }}\n                data-testid=\"cancel-sla-button\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => setSlaMutation.mutate(slaDeadline)}\n                disabled={!slaDeadline || setSlaMutation.isPending}\n                data-testid=\"save-sla-button\"\n              >\n                {setSlaMutation.isPending ? \"Setting...\" : \"Set Deadline\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Link Items Dialog */}\n      <Dialog open={showLinkDialog} onOpenChange={setShowLinkDialog}>\n        <DialogContent data-testid=\"link-items-dialog\">\n          <DialogHeader>\n            <DialogTitle>Link Item to Case</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Item Type</label>\n              <Select value={linkType} onValueChange={(value: any) => {\n                setLinkType(value);\n                setLinkedId(\"\");\n              }}>\n                <SelectTrigger data-testid=\"link-type-select\">\n                  <SelectValue placeholder=\"Select item type...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"email\" data-testid=\"link-type-email\">Email</SelectItem>\n                  <SelectItem value=\"order\" data-testid=\"link-type-order\">Order</SelectItem>\n                  <SelectItem value=\"repair\" data-testid=\"link-type-repair\">Repair</SelectItem>\n                  <SelectItem value=\"todo\" data-testid=\"link-type-todo\">Todo</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {linkType && (\n              <div className=\"space-y-2\">\n                <label className=\"text-sm font-medium\">Select Item</label>\n                <Select value={linkedId} onValueChange={setLinkedId}>\n                  <SelectTrigger data-testid=\"linked-item-select\">\n                    <SelectValue placeholder={`Select ${linkType}...`} />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {getAvailableItems().length === 0 ? (\n                      <div className=\"p-2 text-sm text-muted-foreground\">\n                        No available {linkType}s to link\n                      </div>\n                    ) : (\n                      <>\n                        {linkType === \"email\" && getAvailableItems().map((email: any) => (\n                          <SelectItem key={email.id} value={email.id} data-testid={`link-email-${email.id}`}>\n                            {email.subject}\n                          </SelectItem>\n                        ))}\n                        {linkType === \"order\" && getAvailableItems().map((order: any) => (\n                          <SelectItem key={order.id} value={order.id} data-testid={`link-order-${order.id}`}>\n                            Order #{order.orderNumber}\n                          </SelectItem>\n                        ))}\n                        {linkType === \"repair\" && getAvailableItems().map((repair: any) => (\n                          <SelectItem key={repair.id} value={repair.id} data-testid={`link-repair-${repair.id}`}>\n                            {repair.title}\n                          </SelectItem>\n                        ))}\n                        {linkType === \"todo\" && getAvailableItems().map((todo: any) => (\n                          <SelectItem key={todo.id} value={todo.id} data-testid={`link-todo-${todo.id}`}>\n                            {todo.title}\n                          </SelectItem>\n                        ))}\n                      </>\n                    )}\n                  </SelectContent>\n                </Select>\n              </div>\n            )}\n\n            <div className=\"flex justify-end space-x-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setShowLinkDialog(false);\n                  setLinkType(\"\");\n                  setLinkedId(\"\");\n                }}\n                data-testid=\"cancel-link-button\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => linkItemMutation.mutate({ type: linkType, id: linkedId })}\n                disabled={!linkType || !linkedId || linkItemMutation.isPending}\n                data-testid=\"save-link-button\"\n              >\n                {linkItemMutation.isPending ? \"Linking...\" : \"Link Item\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Send Email Dialog */}\n      <EmailCompose\n        open={showEmailDialog}\n        onOpenChange={setShowEmailDialog}\n        to={caseData?.customerEmail || \"\"}\n        subject={`Re: Case #${caseData?.caseNumber || caseId}`}\n      />\n\n      {/* Convert to Return Dialog */}\n      <Dialog open={showConvertDialog} onOpenChange={setShowConvertDialog}>\n        <DialogContent data-testid=\"convert-to-return-dialog\">\n          <DialogHeader>\n            <DialogTitle>Convert Case to Return</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <p className=\"text-sm text-muted-foreground\">\n              This will create a new return linked to this case. The return will inherit the case's customer and priority.\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              You can add return items and details on the return page after creation.\n            </p>\n            <div className=\"flex justify-end space-x-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowConvertDialog(false)}\n                data-testid=\"cancel-convert-button\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => convertToReturnMutation.mutate()}\n                disabled={convertToReturnMutation.isPending}\n                data-testid=\"confirm-convert-button\"\n              >\n                {convertToReturnMutation.isPending ? \"Converting...\" : \"Convert to Return\"}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","size_bytes":46812},"client/src/components/cases/case-context-menu.tsx":{"content":"import { ReactNode, MouseEvent } from \"react\";\nimport { Archive, Eye, Trash2, ListChecks } from \"lucide-react\";\nimport {\n  ContextMenu,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuSeparator,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuTrigger,\n} from \"@/components/ui/context-menu\";\n\ninterface CaseContextMenuProps {\n  children: ReactNode;\n  caseId: string;\n  currentStatus: string;\n  isArchived?: boolean;\n  onOpen: (caseId: string) => void;\n  onArchive: (caseId: string) => void;\n  onUnarchive: (caseId: string) => void;\n  onDelete: (caseId: string) => void;\n  onStatusChange: (caseId: string, newStatus: string) => void;\n}\n\nexport function CaseContextMenu({ \n  children, \n  caseId, \n  currentStatus,\n  isArchived = false,\n  onOpen, \n  onArchive, \n  onUnarchive,\n  onDelete,\n  onStatusChange\n}: CaseContextMenuProps) {\n  const handleOpen = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    onOpen(caseId);\n  };\n\n  const handleArchive = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (isArchived) {\n      onUnarchive(caseId);\n    } else {\n      onArchive(caseId);\n    }\n  };\n\n  const handleDelete = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    onDelete(caseId);\n  };\n\n  const handleStatusChange = (newStatus: string) => (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    onStatusChange(caseId, newStatus);\n  };\n\n  return (\n    <ContextMenu>\n      <ContextMenuTrigger asChild>{children}</ContextMenuTrigger>\n      <ContextMenuContent className=\"w-56\" data-testid={`context-menu-${caseId}`}>\n        <ContextMenuItem onClick={handleOpen} data-testid={`context-menu-open-${caseId}`}>\n          <Eye className=\"mr-2 h-4 w-4\" />\n          Open\n        </ContextMenuItem>\n        \n        <ContextMenuSeparator />\n        \n        <ContextMenuSub>\n          <ContextMenuSubTrigger data-testid={`context-menu-status-${caseId}`}>\n            <ListChecks className=\"mr-2 h-4 w-4\" />\n            Wijzig Status\n          </ContextMenuSubTrigger>\n          <ContextMenuSubContent>\n            <ContextMenuItem \n              onClick={handleStatusChange(\"new\")}\n              disabled={currentStatus === \"new\"}\n              data-testid={`context-menu-status-new-${caseId}`}\n            >\n              Nieuw\n            </ContextMenuItem>\n            <ContextMenuItem \n              onClick={handleStatusChange(\"in_progress\")}\n              disabled={currentStatus === \"in_progress\"}\n              data-testid={`context-menu-status-in_progress-${caseId}`}\n            >\n              In Behandeling\n            </ContextMenuItem>\n            <ContextMenuItem \n              onClick={handleStatusChange(\"waiting_customer\")}\n              disabled={currentStatus === \"waiting_customer\"}\n              data-testid={`context-menu-status-waiting_customer-${caseId}`}\n            >\n              Wachtend op Klant\n            </ContextMenuItem>\n            <ContextMenuItem \n              onClick={handleStatusChange(\"resolved\")}\n              disabled={currentStatus === \"resolved\"}\n              data-testid={`context-menu-status-resolved-${caseId}`}\n            >\n              Opgelost\n            </ContextMenuItem>\n          </ContextMenuSubContent>\n        </ContextMenuSub>\n        \n        <ContextMenuSeparator />\n        \n        <ContextMenuItem onClick={handleArchive} data-testid={`context-menu-archive-${caseId}`}>\n          <Archive className=\"mr-2 h-4 w-4\" />\n          {isArchived ? \"Unarchive\" : \"Archive\"}\n        </ContextMenuItem>\n        \n        <ContextMenuSeparator />\n        \n        <ContextMenuItem \n          onClick={handleDelete} \n          className=\"text-destructive focus:text-destructive\"\n          data-testid={`context-menu-delete-${caseId}`}\n        >\n          <Trash2 className=\"mr-2 h-4 w-4\" />\n          Delete\n        </ContextMenuItem>\n      </ContextMenuContent>\n    </ContextMenu>\n  );\n}","size_bytes":3971},"server/storage.ts":{"content":"import {\n  type User, type InsertUser,\n  type Customer, type InsertCustomer,\n  type Order, type InsertOrder,\n  type EmailThread, type InsertEmailThread,\n  type EmailMessage, type InsertEmailMessage,\n  type EmailAttachment, type InsertEmailAttachment,\n  type Repair, type InsertRepair,\n  type Todo, type InsertTodo,\n  type InternalNote, type InsertInternalNote,\n  type PurchaseOrder, type InsertPurchaseOrder,\n  type Supplier, type InsertSupplier,\n  type PurchaseOrderItem, type InsertPurchaseOrderItem,\n  type PurchaseOrderFile, type InsertPurchaseOrderFile,\n  type Return, type InsertReturn,\n  type ReturnItem, type InsertReturnItem,\n  type Case, type InsertCase,\n  type CaseItem, type InsertCaseItem,\n  type CaseLink, type InsertCaseLink,\n  type CaseNote, type InsertCaseNote,\n  type CaseEvent, type InsertCaseEvent,\n  type Activity, type InsertActivity,\n  type AuditLog, type InsertAuditLog,\n  type Note, type InsertNote,\n  type NoteTag, type InsertNoteTag,\n  type NoteTagAssignment, type InsertNoteTagAssignment,\n  type NoteMention, type InsertNoteMention,\n  type NoteReaction, type InsertNoteReaction,\n  type NoteAttachment, type InsertNoteAttachment,\n  type NoteFollowup, type InsertNoteFollowup,\n  type NoteRevision, type InsertNoteRevision,\n  type NoteTemplate, type InsertNoteTemplate,\n  type NoteLink, type InsertNoteLink,\n  users, customers, orders, emailThreads, emailMessages, emailAttachments, repairs, todos, internalNotes, purchaseOrders, suppliers, purchaseOrderItems, purchaseOrderFiles, returns, returnItems, cases, caseItems, caseLinks, caseNotes, caseEvents, activities, auditLogs, systemSettings, notes, noteTags, noteTagAssignments, noteMentions, noteReactions, noteAttachments, noteFollowups, noteRevisions, noteTemplates, noteLinks\n} from \"@shared/schema\";\nimport { db } from \"./services/supabaseClient\";\nimport { eq, desc, and, or, ilike, count, inArray, isNotNull, sql, getTableColumns } from \"drizzle-orm\";\nimport { ObjectStorageService } from \"./objectStorage\";\nimport type { Response } from \"express\";\n\nexport interface IStorage {\n  // Users\n  getUsers(): Promise<User[]>;\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, updates: Partial<InsertUser>): Promise<User>;\n  deleteUser(id: string): Promise<void>;\n\n  // Customers\n  getCustomer(id: string): Promise<Customer | undefined>;\n  getCustomerByEmail(email: string): Promise<Customer | undefined>;\n  createCustomer(customer: InsertCustomer): Promise<Customer>;\n  updateCustomer(id: string, customer: Partial<InsertCustomer>): Promise<Customer>;\n\n  // Orders\n  getOrders(limit?: number): Promise<Order[]>;\n  getOrdersPaginated(page?: number, limit?: number): Promise<{ orders: Order[], total: number }>;\n  getOrder(id: string): Promise<Order | undefined>;\n  getOrderByShopifyId(shopifyId: string): Promise<Order | undefined>;\n  getOrderByOrderNumber(orderNumber: string): Promise<Order | undefined>;\n  getOrdersByCustomerEmail(customerEmail: string): Promise<Order[]>;\n  createOrder(order: InsertOrder): Promise<Order>;\n  updateOrder(id: string, order: Partial<InsertOrder>): Promise<Order>;\n\n  // Email Threads\n  getEmailThreads(filters?: {\n    limit?: number;\n    folder?: string;\n    starred?: boolean;\n    archived?: boolean;\n    isUnread?: boolean;\n    hasOrder?: boolean;\n  }): Promise<EmailThread[]>;\n  getEmailThread(id: string): Promise<EmailThread | undefined>;\n  getEmailThreadByThreadId(threadId: string): Promise<EmailThread | undefined>;\n  createEmailThread(thread: InsertEmailThread): Promise<EmailThread>;\n  updateEmailThread(id: string, thread: Partial<InsertEmailThread>): Promise<EmailThread>;\n  deleteEmailThread(id: string): Promise<void>;\n\n  // Email Messages\n  getEmailMessages(threadId: string): Promise<EmailMessage[]>;\n  getEmailMessage(messageId: string): Promise<EmailMessage | undefined>;\n  createEmailMessage(message: InsertEmailMessage): Promise<EmailMessage>;\n\n  // Email Attachments\n  getEmailAttachment(attachmentPath: string): Promise<EmailAttachment | undefined>;\n  getEmailMessageAttachments(messageId: string): Promise<EmailAttachment[]>;\n  createEmailAttachment(attachment: InsertEmailAttachment): Promise<EmailAttachment>;\n  downloadAttachment(attachmentPath: string, res: any, forceDownload?: boolean): Promise<void>;\n\n  // Repairs\n  getRepairs(): Promise<Repair[]>;\n  getRepair(id: string): Promise<Repair | undefined>;\n  createRepair(repair: InsertRepair): Promise<Repair>;\n  updateRepair(id: string, repair: Partial<InsertRepair>): Promise<Repair>;\n  deleteRepair(id: string): Promise<void>;\n  getRepairsByStatus(status: string): Promise<Repair[]>;\n  getRepairsByTechnician(technicianId: string): Promise<Repair[]>;\n  getRepairsByDateRange(startDate: Date, endDate: Date): Promise<Repair[]>;\n  getRepairsWithFilters(filters: {\n    status?: string;\n    technicianId?: string;\n    startDate?: Date;\n    endDate?: Date;\n    priority?: string;\n  }): Promise<Repair[]>;\n\n  // Suppliers\n  getSuppliers(): Promise<Supplier[]>;\n  getSupplier(id: string): Promise<Supplier | undefined>;\n  getSupplierByCode(code: string): Promise<Supplier | undefined>;\n  createSupplier(supplier: InsertSupplier): Promise<Supplier>;\n  updateSupplier(id: string, supplier: Partial<InsertSupplier>): Promise<Supplier>;\n  deleteSupplier(id: string): Promise<void>;\n  importSuppliers(suppliers: InsertSupplier[]): Promise<void>;\n\n  // Purchase Orders\n  getPurchaseOrders(): Promise<PurchaseOrder[]>;\n  getPurchaseOrder(id: string): Promise<PurchaseOrder | undefined>;\n  createPurchaseOrder(purchaseOrder: InsertPurchaseOrder): Promise<PurchaseOrder>;\n  createPurchaseOrderWithItems(purchaseOrder: InsertPurchaseOrder, items: Omit<InsertPurchaseOrderItem, 'purchaseOrderId'>[]): Promise<PurchaseOrder>;\n  updatePurchaseOrder(id: string, purchaseOrder: Partial<InsertPurchaseOrder>): Promise<PurchaseOrder>;\n  deletePurchaseOrder(id: string): Promise<void>;\n  generatePONumber(): Promise<string>;\n\n  // Purchase Order Items\n  getPurchaseOrderItems(purchaseOrderId: string): Promise<PurchaseOrderItem[]>;\n  createPurchaseOrderItem(item: InsertPurchaseOrderItem): Promise<PurchaseOrderItem>;\n  updatePurchaseOrderItem(id: string, item: Partial<InsertPurchaseOrderItem>): Promise<PurchaseOrderItem>;\n  deletePurchaseOrderItem(id: string): Promise<void>;\n\n  // Purchase Order Files\n  getPurchaseOrderFiles(purchaseOrderId: string): Promise<PurchaseOrderFile[]>;\n  getPurchaseOrderFile(id: string): Promise<PurchaseOrderFile | undefined>;\n  createPurchaseOrderFile(file: InsertPurchaseOrderFile): Promise<PurchaseOrderFile>;\n  deletePurchaseOrderFile(id: string): Promise<void>;\n\n  // Returns\n  getReturns(filters?: { status?: string; customerId?: string; orderId?: string; assignedUserId?: string }): Promise<Return[]>;\n  getReturn(id: string): Promise<Return | undefined>;\n  getReturnByReturnNumber(returnNumber: string): Promise<Return | undefined>;\n  createReturn(returnData: InsertReturn): Promise<Return>;\n  createReturnWithItems(returnData: InsertReturn, items: Omit<InsertReturnItem, 'returnId'>[]): Promise<Return>;\n  updateReturn(id: string, returnData: Partial<InsertReturn>): Promise<Return>;\n  deleteReturn(id: string): Promise<void>;\n  generateReturnNumber(): Promise<string>;\n  getReturnsByStatus(status: string): Promise<Return[]>;\n  getReturnsByCustomer(customerId: string): Promise<Return[]>;\n  createReturnFromCase(caseId: string): Promise<Return>;\n\n  // Return Items\n  getReturnItems(returnId: string): Promise<ReturnItem[]>;\n  createReturnItem(item: InsertReturnItem): Promise<ReturnItem>;\n  updateReturnItem(id: string, item: Partial<InsertReturnItem>): Promise<ReturnItem>;\n  deleteReturnItem(id: string): Promise<void>;\n\n  // Todos\n  getTodos(userId?: string): Promise<Todo[]>;\n  getTodo(id: string): Promise<Todo | undefined>;\n  createTodo(todo: InsertTodo): Promise<Todo>;\n  updateTodo(id: string, todo: Partial<InsertTodo>): Promise<Todo>;\n  deleteTodo(id: string): Promise<void>;\n\n  // Internal Notes\n  getInternalNotes(entityId: string, entityType: string): Promise<InternalNote[]>;\n  createInternalNote(note: InsertInternalNote): Promise<InternalNote>;\n  deleteInternalNote(noteId: string): Promise<void>;\n\n  // Cases\n  getCases(status?: string, search?: string): Promise<Case[]>;\n  getCase(id: string): Promise<Case | undefined>;\n  createCase(caseData: InsertCase): Promise<Case>;\n  createCaseWithItems(caseData: InsertCase, items: Omit<InsertCaseItem, 'caseId'>[]): Promise<Case>;\n  updateCase(id: string, caseData: Partial<InsertCase>): Promise<Case>;\n  deleteCase(id: string): Promise<void>;\n  getCaseItems(caseId: string): Promise<CaseItem[]>;\n  linkEntityToCase(caseId: string, entityType: 'email' | 'repair' | 'todo' | 'order' | 'note', entityId: string): Promise<void>;\n  unlinkEntityFromCase(entityType: 'email' | 'repair' | 'todo' | 'order' | 'note', entityId: string): Promise<void>;\n  createCaseFromEmailThread(threadId: string): Promise<Case>;\n  getCaseRelatedItems(caseId: string): Promise<{\n    emails: EmailThread[];\n    orders: Order[];\n    repairs: Repair[];\n    todos: Todo[];\n    notes: InternalNote[];\n  }>;\n\n  // Case Links\n  getCaseLinks(caseId: string): Promise<CaseLink[]>;\n  createCaseLink(link: InsertCaseLink): Promise<CaseLink>;\n  deleteCaseLink(linkId: string): Promise<void>;\n\n  // Case Notes\n  getCaseNotes(caseId: string): Promise<CaseNote[]>;\n  createCaseNote(note: InsertCaseNote): Promise<CaseNote>;\n\n  // Case Events\n  getCaseEvents(caseId: string): Promise<CaseEvent[]>;\n  createCaseEvent(event: InsertCaseEvent): Promise<CaseEvent>;\n\n  // Activities\n  getActivities(limit?: number): Promise<Activity[]>;\n  createActivity(activity: InsertActivity): Promise<Activity>;\n  updateActivity(id: string, activity: Partial<InsertActivity>): Promise<Activity>;\n  deleteActivity(id: string): Promise<void>;\n\n  // Audit Logs\n  createAuditLog(auditLog: InsertAuditLog): Promise<AuditLog>;\n  getAuditLogs(limit?: number): Promise<AuditLog[]>;\n\n  // System Settings\n  getSystemSetting(key: string): Promise<string | undefined>;\n  setSystemSetting(key: string, value: string): Promise<void>;\n\n  // Dashboard stats\n  getDashboardStats(): Promise<{\n    unreadEmails: number;\n    newRepairs: number;\n    slaAlerts: number;\n    todaysOrders: { count: number; total: number };\n  }>;\n\n  // Search\n  globalSearch(query: string): Promise<{\n    customers: Customer[];\n    orders: Order[];\n    emailThreads: EmailThread[];\n    repairs: Repair[];\n  }>;\n  \n  // Customer relations\n  getCustomers(): Promise<Customer[]>;\n  getCustomerOrders(customerId: string): Promise<Order[]>;\n  getCustomerEmailThreads(customerId: string): Promise<EmailThread[]>;\n  getCustomerRepairs(customerId: string): Promise<Repair[]>;\n\n  // Notes (Universal)\n  getNotes(entityType: string, entityId: string, filters?: { visibility?: string; tagIds?: string[]; authorId?: string; }): Promise<Note[]>;\n  getNote(id: string): Promise<Note | undefined>;\n  createNote(note: InsertNote): Promise<Note>;\n  updateNote(id: string, updates: Partial<InsertNote>): Promise<Note>;\n  deleteNote(id: string, reason: string, userId: string): Promise<void>;\n  pinNote(noteId: string): Promise<void>;\n  unpinNote(noteId: string): Promise<void>;\n  searchNotes(query: string, filters?: { entityType?: string; visibility?: string; }): Promise<Note[]>;\n\n  // Note Tags\n  getNoteTags(): Promise<NoteTag[]>;\n  createNoteTag(tag: InsertNoteTag): Promise<NoteTag>;\n  assignTagToNote(noteId: string, tagId: string): Promise<void>;\n  removeTagFromNote(noteId: string, tagId: string): Promise<void>;\n\n  // Note Mentions\n  createNoteMention(mention: InsertNoteMention): Promise<NoteMention>;\n  getNoteMentions(noteId: string): Promise<NoteMention[]>;\n  markMentionRead(mentionId: string): Promise<void>;\n\n  // Note Reactions\n  addReaction(reaction: InsertNoteReaction): Promise<NoteReaction>;\n  removeReaction(noteId: string, userId: string, emoji: string): Promise<void>;\n  getNoteReactions(noteId: string): Promise<NoteReaction[]>;\n\n  // Note Attachments\n  createNoteAttachment(attachment: InsertNoteAttachment): Promise<NoteAttachment>;\n  getNoteAttachments(noteId: string): Promise<NoteAttachment[]>;\n  deleteNoteAttachment(id: string): Promise<void>;\n\n  // Note Follow-ups\n  createNoteFollowup(followup: InsertNoteFollowup): Promise<NoteFollowup>;\n  getNoteFollowups(noteId: string): Promise<NoteFollowup[]>;\n\n  // Note Revisions\n  createNoteRevision(revision: InsertNoteRevision): Promise<NoteRevision>;\n  getNoteRevisions(noteId: string): Promise<NoteRevision[]>;\n\n  // Note Templates\n  getNoteTemplates(entityType?: string): Promise<NoteTemplate[]>;\n  createNoteTemplate(template: InsertNoteTemplate): Promise<NoteTemplate>;\n  updateNoteTemplate(id: string, updates: Partial<InsertNoteTemplate>): Promise<NoteTemplate>;\n  deleteNoteTemplate(id: string): Promise<void>;\n\n  // Note Links\n  createNoteLink(link: InsertNoteLink): Promise<NoteLink>;\n  getNoteLinks(noteId: string): Promise<NoteLink[]>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Users\n  async getUsers(): Promise<User[]> {\n    return await db.select().from(users).orderBy(desc(users.createdAt));\n  }\n\n  async getUser(id: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.username, username)).limit(1);\n    return result[0];\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.email, email)).limit(1);\n    return result[0];\n  }\n\n  async createUser(user: InsertUser): Promise<User> {\n    const result = await db.insert(users).values(user).returning();\n    return result[0];\n  }\n\n  async updateUser(id: string, updates: Partial<InsertUser>): Promise<User> {\n    const result = await db.update(users).set({\n      ...updates,\n      updatedAt: new Date(),\n    }).where(eq(users.id, id)).returning();\n    if (result.length === 0) {\n      throw new Error(\"User not found\");\n    }\n    return result[0];\n  }\n\n  async deleteUser(id: string): Promise<void> {\n    const result = await db.delete(users).where(eq(users.id, id)).returning({ id: users.id });\n    if (result.length === 0) {\n      throw new Error(\"User not found\");\n    }\n  }\n\n  // Customers\n  async getCustomer(id: string): Promise<Customer | undefined> {\n    const result = await db.select().from(customers).where(eq(customers.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getCustomerByEmail(email: string): Promise<Customer | undefined> {\n    const result = await db.select().from(customers).where(eq(customers.email, email)).limit(1);\n    return result[0];\n  }\n\n  async createCustomer(customer: InsertCustomer): Promise<Customer> {\n    const result = await db.insert(customers).values(customer).returning();\n    return result[0];\n  }\n\n  async updateCustomer(id: string, customer: Partial<InsertCustomer>): Promise<Customer> {\n    const result = await db.update(customers).set(customer).where(eq(customers.id, id)).returning();\n    return result[0];\n  }\n\n  async getCustomers(): Promise<Customer[]> {\n    return await db.select().from(customers).orderBy(desc(customers.createdAt));\n  }\n\n  async getCustomerOrders(customerId: string): Promise<Order[]> {\n    return await db.select().from(orders).where(eq(orders.customerId, customerId)).orderBy(orders.orderNumber);\n  }\n\n  async getCustomerEmailThreads(customerId: string): Promise<EmailThread[]> {\n    return await db.select().from(emailThreads).where(eq(emailThreads.customerId, customerId)).orderBy(desc(emailThreads.createdAt));\n  }\n\n  async getCustomerRepairs(customerId: string): Promise<Repair[]> {\n    return await db.select().from(repairs).where(eq(repairs.customerId, customerId)).orderBy(desc(repairs.createdAt));\n  }\n\n  // Orders\n  async getOrders(limit: number = 50): Promise<Order[]> {\n    // Sort by order date descending (newest orders first), NULL dates go to end\n    return await db.select().from(orders).orderBy(sql`${orders.orderDate} DESC NULLS LAST`).limit(limit);\n  }\n\n  async getOrdersPaginated(page: number = 1, limit: number = 20, searchQuery?: string): Promise<{ orders: Order[], total: number }> {\n    const offset = (page - 1) * limit;\n    \n    // Build search conditions\n    let whereCondition;\n    if (searchQuery) {\n      const query = `%${searchQuery}%`;\n      whereCondition = or(\n        ilike(orders.orderNumber, query),\n        ilike(orders.customerEmail, query)\n      );\n    }\n    \n    // Get total count with search filter\n    const countQuery = db.select({ count: sql<number>`count(*)` }).from(orders);\n    if (whereCondition) {\n      countQuery.where(whereCondition);\n    }\n    const [countResult] = await countQuery;\n    const total = Number(countResult.count);\n    \n    // Get paginated orders with search filter, sorted by date (newest first)\n    // Use sql`` to add NULLS LAST to prevent NULL dates from appearing in middle of results\n    const ordersQuery = db\n      .select()\n      .from(orders)\n      .orderBy(sql`${orders.orderDate} DESC NULLS LAST`)\n      .limit(limit)\n      .offset(offset);\n    \n    if (whereCondition) {\n      ordersQuery.where(whereCondition);\n    }\n    \n    const ordersResult = await ordersQuery;\n    \n    return {\n      orders: ordersResult,\n      total\n    };\n  }\n\n  async getOrder(id: string): Promise<Order | undefined> {\n    const result = await db.select().from(orders).where(eq(orders.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getOrderByShopifyId(shopifyId: string): Promise<Order | undefined> {\n    const result = await db.select().from(orders).where(eq(orders.shopifyOrderId, shopifyId)).limit(1);\n    return result[0];\n  }\n\n  async getOrderByOrderNumber(orderNumber: string): Promise<Order | undefined> {\n    const result = await db.select().from(orders).where(eq(orders.orderNumber, orderNumber)).limit(1);\n    return result[0];\n  }\n\n  async getOrdersByCustomerEmail(customerEmail: string): Promise<Order[]> {\n    return await db.select().from(orders).where(eq(orders.customerEmail, customerEmail));\n  }\n\n  async createOrder(order: InsertOrder): Promise<Order> {\n    const result = await db.insert(orders).values(order).returning();\n    return result[0];\n  }\n\n  async updateOrder(id: string, order: Partial<InsertOrder>): Promise<Order> {\n    const result = await db.update(orders).set(order).where(eq(orders.id, id)).returning();\n    return result[0];\n  }\n\n  // Email Threads\n  async getEmailThreads(filters?: {\n    limit?: number;\n    folder?: string;\n    starred?: boolean;\n    archived?: boolean;\n    isUnread?: boolean;\n    hasOrder?: boolean;\n  }): Promise<EmailThread[]> {\n    const { limit = 50, folder, starred, archived, isUnread, hasOrder } = filters || {};\n    \n    let query = db.select().from(emailThreads);\n    const conditions = [];\n    \n    // Handle virtual folders that map to combinations of flags\n    if (folder === 'inbox') {\n      conditions.push(eq(emailThreads.folder, 'inbox'));\n      conditions.push(eq(emailThreads.archived, false));\n    } else if (folder === 'sent') {\n      conditions.push(eq(emailThreads.folder, 'sent'));\n    } else if (folder === 'archived') {\n      conditions.push(eq(emailThreads.archived, true));\n    } else if (folder === 'starred') {\n      conditions.push(eq(emailThreads.starred, true));\n    } else if (folder === 'unread') {\n      conditions.push(eq(emailThreads.isUnread, true));\n    } else if (folder && ['inbox', 'sent'].includes(folder)) {\n      conditions.push(eq(emailThreads.folder, folder as any));\n    }\n    \n    // Additional filters\n    if (starred !== undefined) {\n      conditions.push(eq(emailThreads.starred, starred));\n    }\n    if (archived !== undefined) {\n      conditions.push(eq(emailThreads.archived, archived));\n    }\n    if (isUnread !== undefined) {\n      conditions.push(eq(emailThreads.isUnread, isUnread));\n    }\n    if (hasOrder !== undefined) {\n      if (hasOrder) {\n        conditions.push(sql`${emailThreads.orderId} IS NOT NULL`);\n      } else {\n        conditions.push(sql`${emailThreads.orderId} IS NULL`);\n      }\n    }\n    \n    // Apply all conditions\n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as any;\n    }\n    \n    return await query.orderBy(desc(emailThreads.lastActivity)).limit(limit);\n  }\n\n  async getEmailThread(id: string): Promise<EmailThread | undefined> {\n    const result = await db.select().from(emailThreads).where(eq(emailThreads.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getEmailThreadByThreadId(threadId: string): Promise<EmailThread | undefined> {\n    const result = await db.select().from(emailThreads).where(eq(emailThreads.threadId, threadId)).limit(1);\n    return result[0];\n  }\n\n  async createEmailThread(thread: InsertEmailThread): Promise<EmailThread> {\n    const result = await db.insert(emailThreads).values(thread).returning();\n    return result[0];\n  }\n\n  async updateEmailThread(id: string, thread: Partial<InsertEmailThread>): Promise<EmailThread> {\n    // Convert empty strings to null for foreign key fields to avoid constraint violations\n    const updateData = { ...thread };\n    if (updateData.orderId === '') {\n      updateData.orderId = null;\n    }\n    if (updateData.caseId === '') {\n      updateData.caseId = null;\n    }\n    \n    const result = await db.update(emailThreads).set(updateData).where(eq(emailThreads.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteEmailThread(id: string): Promise<void> {\n    await db.delete(emailThreads).where(eq(emailThreads.id, id));\n  }\n\n  // Email Messages\n  async getEmailMessages(threadId: string): Promise<EmailMessage[]> {\n    return await db.select().from(emailMessages).where(eq(emailMessages.threadId, threadId)).orderBy(desc(emailMessages.sentAt));\n  }\n\n  async getEmailMessage(messageId: string): Promise<EmailMessage | undefined> {\n    const result = await db.select().from(emailMessages).where(eq(emailMessages.messageId, messageId)).limit(1);\n    return result[0];\n  }\n\n  async createEmailMessage(message: InsertEmailMessage): Promise<EmailMessage> {\n    const result = await db.insert(emailMessages).values(message).returning();\n    return result[0];\n  }\n\n  // Repairs\n  async getRepairs(): Promise<Repair[]> {\n    return await db.select().from(repairs).orderBy(desc(repairs.createdAt));\n  }\n\n  async getRepair(id: string): Promise<Repair | undefined> {\n    const result = await db.select().from(repairs).where(eq(repairs.id, id)).limit(1);\n    return result[0];\n  }\n\n  async createRepair(repair: InsertRepair): Promise<Repair> {\n    const result = await db.insert(repairs).values(repair).returning();\n    return result[0];\n  }\n\n  async updateRepair(id: string, repair: Partial<InsertRepair>): Promise<Repair> {\n    const result = await db.update(repairs).set(repair).where(eq(repairs.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteRepair(id: string): Promise<void> {\n    await db.delete(repairs).where(eq(repairs.id, id));\n  }\n\n  async getRepairsByStatus(status: string): Promise<Repair[]> {\n    return await db.select().from(repairs).where(eq(repairs.status, status as any));\n  }\n\n  async getRepairsByTechnician(technicianId: string): Promise<Repair[]> {\n    return await db.select().from(repairs).where(eq(repairs.assignedUserId, technicianId)).orderBy(desc(repairs.createdAt));\n  }\n\n  async getRepairsByDateRange(startDate: Date, endDate: Date): Promise<Repair[]> {\n    return await db.select().from(repairs)\n      .where(and(\n        sql`${repairs.createdAt} >= ${startDate}`,\n        sql`${repairs.createdAt} <= ${endDate}`\n      ))\n      .orderBy(desc(repairs.createdAt));\n  }\n\n  async getRepairsWithFilters(filters: {\n    status?: string;\n    technicianId?: string;\n    startDate?: Date;\n    endDate?: Date;\n    priority?: string;\n  }): Promise<Repair[]> {\n    const conditions = [];\n    \n    if (filters.status) {\n      conditions.push(eq(repairs.status, filters.status as any));\n    }\n    if (filters.technicianId) {\n      conditions.push(eq(repairs.assignedUserId, filters.technicianId));\n    }\n    if (filters.startDate) {\n      conditions.push(sql`${repairs.createdAt} >= ${filters.startDate}`);\n    }\n    if (filters.endDate) {\n      conditions.push(sql`${repairs.createdAt} <= ${filters.endDate}`);\n    }\n    if (filters.priority) {\n      conditions.push(eq(repairs.priority, filters.priority as any));\n    }\n\n    if (conditions.length === 0) {\n      return await db.select().from(repairs).orderBy(desc(repairs.createdAt));\n    }\n\n    return await db.select().from(repairs)\n      .where(and(...conditions))\n      .orderBy(desc(repairs.createdAt));\n  }\n\n  // Todos\n  async getTodos(userId?: string): Promise<Todo[]> {\n    if (userId) {\n      return await db.select().from(todos).where(eq(todos.assignedUserId, userId)).orderBy(desc(todos.createdAt));\n    }\n    return await db.select().from(todos).orderBy(desc(todos.createdAt));\n  }\n\n  async getTodo(id: string): Promise<Todo | undefined> {\n    const result = await db.select().from(todos).where(eq(todos.id, id)).limit(1);\n    return result[0];\n  }\n\n  async createTodo(todo: InsertTodo): Promise<Todo> {\n    // Handle dueDate conversion for create\n    const createData = { ...todo };\n    if (createData.dueDate !== undefined && typeof createData.dueDate === 'string') {\n      createData.dueDate = new Date(createData.dueDate);\n    }\n    const result = await db.insert(todos).values(createData as any).returning();\n    return result[0];\n  }\n\n  async updateTodo(id: string, todo: Partial<InsertTodo>): Promise<Todo> {\n    // Handle dueDate conversion\n    const updateData = { ...todo };\n    if (updateData.dueDate !== undefined) {\n      if (typeof updateData.dueDate === 'string') {\n        updateData.dueDate = new Date(updateData.dueDate);\n      }\n      // null and Date values can pass through as-is\n    }\n    const result = await db.update(todos).set(updateData as any).where(eq(todos.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteTodo(id: string): Promise<void> {\n    await db.delete(todos).where(eq(todos.id, id));\n  }\n\n  // Internal Notes\n  async getInternalNotes(entityType: string, entityId: string): Promise<InternalNote[]> {\n    const column = entityType === 'customer' ? internalNotes.customerId :\n                  entityType === 'order' ? internalNotes.orderId :\n                  entityType === 'repair' ? internalNotes.repairId :\n                  entityType === 'case' ? internalNotes.caseId :\n                  entityType === 'return' ? internalNotes.returnId :\n                  internalNotes.emailThreadId;\n    \n    return await db.select().from(internalNotes).where(eq(column, entityId)).orderBy(desc(internalNotes.createdAt));\n  }\n\n  async createInternalNote(note: InsertInternalNote): Promise<InternalNote> {\n    const result = await db.insert(internalNotes).values(note).returning();\n    return result[0];\n  }\n\n  async deleteInternalNote(noteId: string): Promise<void> {\n    await db.delete(internalNotes).where(eq(internalNotes.id, noteId));\n  }\n\n  // Cases\n  async getCases(status?: string, search?: string, emailThreadId?: string): Promise<any[]> {\n    const conditions = [];\n    \n    if (status) {\n      conditions.push(eq(cases.status, status as any));\n    }\n    \n    if (search) {\n      const searchTerm = `%${search}%`;\n      conditions.push(or(\n        ilike(cases.title, searchTerm),\n        ilike(cases.description, searchTerm),\n        ilike(cases.caseNumber, searchTerm),\n        ilike(cases.customerEmail, searchTerm)\n      ));\n    }\n    \n    if (emailThreadId) {\n      // Find cases linked to this email thread via the emailThreads.caseId field\n      const linkedThreads = await db.select({ caseId: emailThreads.caseId })\n        .from(emailThreads)\n        .where(and(\n          eq(emailThreads.id, emailThreadId),\n          isNotNull(emailThreads.caseId)\n        ));\n      \n      const linkedCaseIds = linkedThreads\n        .map(thread => thread.caseId)\n        .filter(id => id !== null) as string[];\n        \n      if (linkedCaseIds.length > 0) {\n        conditions.push(inArray(cases.id, linkedCaseIds));\n      } else {\n        // No linked cases found, return empty result\n        return [];\n      }\n    }\n    \n    // Get cases with notes count and related data\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n    \n    const casesData = await db\n      .select({\n        ...getTableColumns(cases),\n        notesCount: sql<number>`COALESCE((\n          SELECT COUNT(*)::int \n          FROM ${notes} \n          WHERE ${notes.entityType} = 'case' \n          AND ${notes.entityId} = ${cases.id}\n          AND ${notes.deletedAt} IS NULL\n        ), 0)`,\n      })\n      .from(cases)\n      .where(whereClause)\n      .orderBy(desc(cases.createdAt));\n    \n    return casesData;\n  }\n\n  async getCase(id: string): Promise<Case | undefined> {\n    const result = await db.select().from(cases).where(eq(cases.id, id)).limit(1);\n    return result[0];\n  }\n\n  async createCase(caseData: InsertCase): Promise<Case> {\n    // Generate a unique case number\n    const existingCases = await db.select({ caseNumber: cases.caseNumber }).from(cases);\n    const maxNumber = existingCases\n      .map(c => parseInt(c.caseNumber.replace('CASE-', ''), 10))\n      .filter(num => !isNaN(num))\n      .reduce((max, num) => Math.max(max, num), 0);\n    \n    const newCaseNumber = `CASE-${String(maxNumber + 1).padStart(3, '0')}`;\n    \n    const createData = {\n      ...caseData,\n      caseNumber: newCaseNumber\n    };\n\n    // Handle date conversions\n    if (createData.slaDeadline && typeof createData.slaDeadline === 'string') {\n      createData.slaDeadline = new Date(createData.slaDeadline);\n    }\n    if (createData.resolvedAt && typeof createData.resolvedAt === 'string') {\n      createData.resolvedAt = new Date(createData.resolvedAt);\n    }\n    if (createData.closedAt && typeof createData.closedAt === 'string') {\n      createData.closedAt = new Date(createData.closedAt);\n    }\n\n    const result = await db.insert(cases).values(createData as any).returning();\n    return result[0];\n  }\n\n  async updateCase(id: string, caseData: Partial<InsertCase>): Promise<Case> {\n    // Handle date conversions\n    const updateData = { ...caseData };\n    if (updateData.slaDeadline && typeof updateData.slaDeadline === 'string') {\n      updateData.slaDeadline = new Date(updateData.slaDeadline);\n    }\n    if (updateData.resolvedAt && typeof updateData.resolvedAt === 'string') {\n      updateData.resolvedAt = new Date(updateData.resolvedAt);\n    }\n    if (updateData.closedAt && typeof updateData.closedAt === 'string') {\n      updateData.closedAt = new Date(updateData.closedAt);\n    }\n\n    const result = await db.update(cases).set(updateData as any).where(eq(cases.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteCase(id: string): Promise<void> {\n    // First delete all related records that have foreign key constraints\n    \n    // Delete case events\n    await db.delete(caseEvents).where(eq(caseEvents.caseId, id));\n    \n    // Delete case notes\n    await db.delete(caseNotes).where(eq(caseNotes.caseId, id));\n    \n    // Delete case links\n    await db.delete(caseLinks).where(eq(caseLinks.caseId, id));\n    \n    // Unlink email threads\n    await db.update(emailThreads).set({ caseId: null }).where(eq(emailThreads.caseId, id));\n    \n    // Unlink repairs\n    await db.update(repairs).set({ caseId: null }).where(eq(repairs.caseId, id));\n    \n    // Unlink todos\n    await db.update(todos).set({ caseId: null }).where(eq(todos.caseId, id));\n    \n    // Unlink internal notes\n    await db.update(internalNotes).set({ caseId: null }).where(eq(internalNotes.caseId, id));\n    \n    // Now safe to delete the case\n    await db.delete(cases).where(eq(cases.id, id));\n  }\n\n  async createCaseWithItems(caseData: InsertCase, items: Omit<InsertCaseItem, 'caseId'>[]): Promise<Case> {\n    // Retry loop to handle concurrent case creation with unique constraint conflicts\n    const maxRetries = 3;\n    let lastError: Error | null = null;\n\n    for (let attempt = 0; attempt < maxRetries; attempt++) {\n      try {\n        // Use transaction to ensure atomicity\n        const newCase = await db.transaction(async (tx) => {\n          // Generate case number within transaction to prevent duplicates\n          // Fetch all case numbers and find max numerically to handle numbers beyond 3 digits\n          const existingCases = await tx.select({ caseNumber: cases.caseNumber }).from(cases);\n          \n          const maxNumber = existingCases\n            .map(c => {\n              const match = c.caseNumber.match(/^CASE-(\\d+)$/);\n              return match ? parseInt(match[1], 10) : 0;\n            })\n            .reduce((max, num) => Math.max(max, num), 0);\n          \n          const newCaseNumber = `CASE-${String(maxNumber + 1).padStart(3, '0')}`;\n          \n          // Normalize date fields\n          const createData = {\n            ...caseData,\n            caseNumber: newCaseNumber\n          };\n\n          if (createData.slaDeadline && typeof createData.slaDeadline === 'string') {\n            createData.slaDeadline = new Date(createData.slaDeadline);\n          }\n          if (createData.resolvedAt && typeof createData.resolvedAt === 'string') {\n            createData.resolvedAt = new Date(createData.resolvedAt);\n          }\n          if (createData.closedAt && typeof createData.closedAt === 'string') {\n            createData.closedAt = new Date(createData.closedAt);\n          }\n\n          // Create case within transaction\n          const caseResult = await tx.insert(cases).values(createData as any).returning();\n          const createdCase = caseResult[0];\n          \n          // Create case items within transaction if provided\n          if (items && items.length > 0) {\n            const itemsWithCaseId = items.map(item => ({\n              ...item,\n              caseId: createdCase.id,\n            }));\n            \n            await tx.insert(caseItems).values(itemsWithCaseId as any);\n          }\n          \n          return createdCase;\n        });\n        \n        // Success - return the created case\n        return newCase;\n      } catch (error: any) {\n        // Check if this is a unique constraint violation on case_number\n        if (error?.code === '23505' && error?.constraint?.includes('case_number')) {\n          lastError = error;\n          // Retry with a new number\n          continue;\n        }\n        // For other errors, throw immediately\n        throw error;\n      }\n    }\n\n    // If we exhausted all retries, throw a clear error\n    throw new Error(`Failed to create case after ${maxRetries} attempts due to concurrent case number conflicts. Please try again.`, { cause: lastError });\n  }\n\n  async getCaseItems(caseId: string): Promise<CaseItem[]> {\n    return await db.select().from(caseItems).where(eq(caseItems.caseId, caseId)).orderBy(caseItems.createdAt);\n  }\n\n  async linkEntityToCase(caseId: string, entityType: 'email' | 'repair' | 'todo' | 'order' | 'note', entityId: string): Promise<void> {\n    switch (entityType) {\n      case 'email':\n        await db.update(emailThreads).set({ caseId }).where(eq(emailThreads.id, entityId));\n        break;\n      case 'repair':\n        await db.update(repairs).set({ caseId }).where(eq(repairs.id, entityId));\n        break;\n      case 'todo':\n        await db.update(todos).set({ caseId }).where(eq(todos.id, entityId));\n        break;\n      case 'order':\n        // For orders, we link via the email thread that might exist\n        const orderEmailThread = await db.select().from(emailThreads).where(eq(emailThreads.orderId, entityId)).limit(1);\n        if (orderEmailThread.length > 0) {\n          await db.update(emailThreads).set({ caseId }).where(eq(emailThreads.orderId, entityId));\n        }\n        break;\n      case 'note':\n        await db.update(internalNotes).set({ caseId }).where(eq(internalNotes.id, entityId));\n        break;\n    }\n  }\n\n  async unlinkEntityFromCase(entityType: 'email' | 'repair' | 'todo' | 'order' | 'note', entityId: string): Promise<void> {\n    switch (entityType) {\n      case 'email':\n        await db.update(emailThreads).set({ caseId: null }).where(eq(emailThreads.id, entityId));\n        break;\n      case 'repair':\n        await db.update(repairs).set({ caseId: null }).where(eq(repairs.id, entityId));\n        break;\n      case 'todo':\n        await db.update(todos).set({ caseId: null }).where(eq(todos.id, entityId));\n        break;\n      case 'order':\n        await db.update(emailThreads).set({ caseId: null }).where(eq(emailThreads.orderId, entityId));\n        break;\n      case 'note':\n        await db.update(internalNotes).set({ caseId: null }).where(eq(internalNotes.id, entityId));\n        break;\n    }\n  }\n\n  async createCaseFromEmailThread(threadId: string): Promise<Case> {\n    const thread = await this.getEmailThread(threadId);\n    if (!thread) {\n      throw new Error('Email thread not found');\n    }\n\n    const caseData: InsertCase = {\n      title: thread.subject || 'Case from email thread',\n      description: `Case created from email thread: ${thread.subject}`,\n      customerId: thread.customerId || undefined,\n      customerEmail: thread.customerEmail || undefined,\n      assignedUserId: thread.assignedUserId || undefined,\n      priority: thread.priority || 'medium',\n      status: 'new'\n    };\n\n    const newCase = await this.createCase(caseData);\n    \n    // Link the email thread to the case\n    await this.linkEntityToCase(newCase.id, 'email', threadId);\n    \n    return newCase;\n  }\n\n  async getCaseRelatedItems(caseId: string): Promise<{\n    emails: EmailThread[];\n    orders: Order[];\n    repairs: Repair[];\n    todos: Todo[];\n    notes: InternalNote[];\n  }> {\n    const [caseEmails, caseRepairs, caseTodos, caseNotes] = await Promise.all([\n      db.select().from(emailThreads).where(eq(emailThreads.caseId, caseId)),\n      db.select().from(repairs).where(eq(repairs.caseId, caseId)),\n      db.select().from(todos).where(eq(todos.caseId, caseId)),\n      db.select().from(internalNotes).where(eq(internalNotes.caseId, caseId))\n    ]);\n\n    // Get orders that are linked via email threads\n    const orderIds = caseEmails.filter(email => email.orderId).map(email => email.orderId!);\n    const caseOrders: Order[] = orderIds.length > 0 ? \n      await db.select().from(orders).where(or(\n        ...orderIds.map(orderId => eq(orders.id, orderId))\n      )) : [];\n\n    return {\n      emails: caseEmails,\n      orders: caseOrders,\n      repairs: caseRepairs,\n      todos: caseTodos,\n      notes: caseNotes\n    };\n  }\n\n  // Case Links\n  async getCaseLinks(caseId: string): Promise<CaseLink[]> {\n    return await db.select().from(caseLinks).where(eq(caseLinks.caseId, caseId));\n  }\n\n  async createCaseLink(link: InsertCaseLink): Promise<CaseLink> {\n    const result = await db.insert(caseLinks).values(link).returning();\n    return result[0];\n  }\n\n  async deleteCaseLink(linkId: string): Promise<void> {\n    await db.delete(caseLinks).where(eq(caseLinks.id, linkId));\n  }\n\n  // Case Notes\n  async getCaseNotes(caseId: string): Promise<CaseNote[]> {\n    return await db.select().from(caseNotes).where(eq(caseNotes.caseId, caseId)).orderBy(desc(caseNotes.createdAt));\n  }\n\n  async createCaseNote(note: InsertCaseNote): Promise<CaseNote> {\n    const result = await db.insert(caseNotes).values(note).returning();\n    return result[0];\n  }\n\n  // Case Events\n  async getCaseEvents(caseId: string): Promise<CaseEvent[]> {\n    return await db.select().from(caseEvents).where(eq(caseEvents.caseId, caseId)).orderBy(desc(caseEvents.createdAt));\n  }\n\n  async createCaseEvent(event: InsertCaseEvent): Promise<CaseEvent> {\n    const result = await db.insert(caseEvents).values(event).returning();\n    return result[0];\n  }\n\n  // Activities\n  async getActivities(limit: number = 20): Promise<Activity[]> {\n    return await db.select().from(activities).orderBy(desc(activities.createdAt)).limit(limit);\n  }\n\n  async createActivity(activity: InsertActivity): Promise<Activity> {\n    const result = await db.insert(activities).values(activity).returning();\n    return result[0];\n  }\n\n  async updateActivity(id: string, activity: Partial<InsertActivity>): Promise<Activity> {\n    const result = await db.update(activities).set(activity).where(eq(activities.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteActivity(id: string): Promise<void> {\n    await db.delete(activities).where(eq(activities.id, id));\n  }\n\n  // Audit Logs\n  async createAuditLog(auditLog: InsertAuditLog): Promise<AuditLog> {\n    const result = await db.insert(auditLogs).values(auditLog).returning();\n    return result[0];\n  }\n\n  async getAuditLogs(limit: number = 50): Promise<AuditLog[]> {\n    return await db.select().from(auditLogs).orderBy(desc(auditLogs.createdAt)).limit(limit);\n  }\n\n  // System Settings\n  async getSystemSetting(key: string): Promise<string | undefined> {\n    const result = await db.select().from(systemSettings).where(eq(systemSettings.key, key)).limit(1);\n    return result[0]?.value;\n  }\n\n  async setSystemSetting(key: string, value: string): Promise<void> {\n    const existing = await this.getSystemSetting(key);\n    if (existing) {\n      await db.update(systemSettings).set({ value, updatedAt: new Date() }).where(eq(systemSettings.key, key));\n    } else {\n      await db.insert(systemSettings).values({ key, value });\n    }\n  }\n\n  // Dashboard stats\n  async getDashboardStats() {\n    const [unreadEmailsResult] = await db.select({ count: count() }).from(emailThreads).where(eq(emailThreads.isUnread, true));\n    const [newRepairsResult] = await db.select({ count: count() }).from(repairs).where(eq(repairs.status, 'new'));\n    const [slaAlertsResult] = await db.select({ count: count() }).from(emailThreads).where(and(\n      eq(emailThreads.status, 'open'),\n      // SLA alerts for threads older than 24 hours\n    ));\n\n    // Get today's orders - count and total amount\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n\n    // For now, get all orders and calculate totals (can be optimized later with date filtering)\n    const allOrders = await db.select({\n      totalAmount: orders.totalAmount,\n      createdAt: orders.createdAt\n    }).from(orders);\n\n    // Filter orders created today and calculate totals\n    const todaysOrders = allOrders.filter(order => {\n      if (!order.createdAt) return false;\n      const orderDate = new Date(order.createdAt);\n      return orderDate >= today && orderDate < tomorrow;\n    });\n\n\n    const todaysOrdersResult = {\n      count: todaysOrders.length,\n      total: todaysOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0)\n    };\n\n    return {\n      unreadEmails: unreadEmailsResult.count,\n      newRepairs: newRepairsResult.count,\n      slaAlerts: slaAlertsResult.count,\n      todaysOrders: { \n        count: todaysOrdersResult.count || 0, \n        total: todaysOrdersResult.total || 0 \n      }\n    };\n  }\n\n  // Suppliers\n  async getSuppliers(): Promise<Supplier[]> {\n    return await db.select().from(suppliers).where(eq(suppliers.active, true)).orderBy(suppliers.name);\n  }\n\n  async getSupplier(id: string): Promise<Supplier | undefined> {\n    const result = await db.select().from(suppliers).where(eq(suppliers.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getSupplierByCode(code: string): Promise<Supplier | undefined> {\n    const result = await db.select().from(suppliers).where(eq(suppliers.supplierCode, code)).limit(1);\n    return result[0];\n  }\n\n  async createSupplier(supplier: InsertSupplier): Promise<Supplier> {\n    const result = await db.insert(suppliers).values(supplier as any).returning();\n    return result[0];\n  }\n\n  async updateSupplier(id: string, supplier: Partial<InsertSupplier>): Promise<Supplier> {\n    const result = await db.update(suppliers).set({ ...supplier, updatedAt: new Date() } as any).where(eq(suppliers.id, id)).returning();\n    return result[0];\n  }\n\n  async deleteSupplier(id: string): Promise<void> {\n    // Soft delete\n    await db.update(suppliers).set({ active: false, updatedAt: new Date() }).where(eq(suppliers.id, id));\n  }\n\n  async importSuppliers(suppliersData: InsertSupplier[]): Promise<void> {\n    // Batch insert suppliers\n    for (const supplier of suppliersData) {\n      // Check if supplier already exists by code\n      const existing = await this.getSupplierByCode(supplier.supplierCode);\n      if (!existing) {\n        await this.createSupplier(supplier);\n      }\n    }\n  }\n\n  // Purchase Orders\n  async getPurchaseOrders(): Promise<PurchaseOrder[]> {\n    return await db.select().from(purchaseOrders).orderBy(desc(purchaseOrders.createdAt));\n  }\n\n  async generatePONumber(): Promise<string> {\n    const year = new Date().getFullYear();\n    const result = await db.select({ poNumber: purchaseOrders.poNumber }).from(purchaseOrders).where(sql`${purchaseOrders.poNumber} LIKE ${`PO-${year}-%`}`).orderBy(desc(purchaseOrders.poNumber)).limit(1);\n    \n    if (result.length === 0) {\n      return `PO-${year}-001`;\n    }\n    \n    const lastNumber = parseInt(result[0].poNumber!.split('-')[2]) || 0;\n    const nextNumber = (lastNumber + 1).toString().padStart(3, '0');\n    return `PO-${year}-${nextNumber}`;\n  }\n\n  async getPurchaseOrder(id: string): Promise<PurchaseOrder | undefined> {\n    const result = await db.select().from(purchaseOrders).where(eq(purchaseOrders.id, id)).limit(1);\n    return result[0];\n  }\n\n  async createPurchaseOrder(purchaseOrder: InsertPurchaseOrder): Promise<PurchaseOrder> {\n    const result = await db.insert(purchaseOrders).values(purchaseOrder as any).returning();\n    return result[0];\n  }\n\n  async createPurchaseOrderWithItems(purchaseOrder: InsertPurchaseOrder, items: Omit<InsertPurchaseOrderItem, 'purchaseOrderId'>[] = []): Promise<PurchaseOrder> {\n    // Use transaction to ensure atomicity (including PO number generation)\n    const newPurchaseOrder = await db.transaction(async (tx) => {\n      // Generate PO number within transaction to prevent conflicts\n      const existingOrders = await tx.select({ poNumber: purchaseOrders.poNumber }).from(purchaseOrders);\n      const year = new Date().getFullYear();\n      const yearPrefix = `PO-${year}-`;\n      \n      const maxNumber = existingOrders\n        .map(p => {\n          const match = p.poNumber?.match(new RegExp(`^PO-${year}-(\\\\d+)$`));\n          return match ? parseInt(match[1], 10) : 0;\n        })\n        .reduce((max, num) => Math.max(max, num), 0);\n      \n      const poNumber = `${yearPrefix}${String(maxNumber + 1).padStart(4, '0')}`;\n      \n      // Create purchase order within transaction\n      const result = await tx.insert(purchaseOrders).values({ \n        ...purchaseOrder, \n        poNumber \n      } as any).returning();\n      \n      const createdPurchaseOrder = result[0];\n      \n      // Create purchase order items within transaction if provided\n      if (items && items.length > 0) {\n        // Validate and normalize items\n        const normalizedItems = items.map(item => {\n          // Ensure required fields\n          if (!item.productName || item.quantity == null || item.unitPrice == null) {\n            throw new Error(`Invalid purchase order item: missing required fields (productName, quantity, or unitPrice)`);\n          }\n          \n          // Normalize price fields to cents if they're not already\n          const unitPriceCents = typeof item.unitPrice === 'number' && item.unitPrice < 1000\n            ? Math.round(item.unitPrice * 100)\n            : Math.round(item.unitPrice);\n          \n          const subtotalCents = Math.round(item.quantity * unitPriceCents);\n          \n          return {\n            ...item,\n            purchaseOrderId: createdPurchaseOrder.id,\n            unitPrice: unitPriceCents,\n            subtotal: subtotalCents,\n            sku: item.sku || '',\n          };\n        });\n        \n        await tx.insert(purchaseOrderItems).values(normalizedItems as any);\n      }\n      \n      return createdPurchaseOrder;\n    });\n    \n    // Create activity log (outside transaction, non-critical)\n    const itemCount = items?.length || 0;\n    await this.createActivity({\n      type: 'purchase_order_created',\n      description: `Purchase order ${newPurchaseOrder.poNumber} created with ${itemCount} item(s)`,\n      metadata: { purchaseOrderId: newPurchaseOrder.id, itemCount },\n    });\n    \n    return newPurchaseOrder;\n  }\n\n  async updatePurchaseOrder(id: string, purchaseOrder: Partial<InsertPurchaseOrder>): Promise<PurchaseOrder> {\n    const result = await db.update(purchaseOrders).set(purchaseOrder as any).where(eq(purchaseOrders.id, id)).returning();\n    return result[0];\n  }\n\n  async deletePurchaseOrder(id: string): Promise<void> {\n    // Delete all associated items and files first (foreign key constraints)\n    await db.delete(purchaseOrderItems).where(eq(purchaseOrderItems.purchaseOrderId, id));\n    await db.delete(purchaseOrderFiles).where(eq(purchaseOrderFiles.purchaseOrderId, id));\n    // Then delete the purchase order\n    await db.delete(purchaseOrders).where(eq(purchaseOrders.id, id));\n  }\n\n  // Purchase Order Items\n  async getPurchaseOrderItems(purchaseOrderId: string): Promise<PurchaseOrderItem[]> {\n    return await db.select().from(purchaseOrderItems).where(eq(purchaseOrderItems.purchaseOrderId, purchaseOrderId)).orderBy(purchaseOrderItems.createdAt);\n  }\n\n  async createPurchaseOrderItem(item: InsertPurchaseOrderItem): Promise<PurchaseOrderItem> {\n    const result = await db.insert(purchaseOrderItems).values(item as any).returning();\n    return result[0];\n  }\n\n  async updatePurchaseOrderItem(id: string, item: Partial<InsertPurchaseOrderItem>): Promise<PurchaseOrderItem> {\n    const result = await db.update(purchaseOrderItems).set({ ...item, updatedAt: new Date() } as any).where(eq(purchaseOrderItems.id, id)).returning();\n    return result[0];\n  }\n\n  async deletePurchaseOrderItem(id: string): Promise<void> {\n    await db.delete(purchaseOrderItems).where(eq(purchaseOrderItems.id, id));\n  }\n\n  // Purchase Order Files\n  async getPurchaseOrderFiles(purchaseOrderId: string): Promise<PurchaseOrderFile[]> {\n    return await db.select().from(purchaseOrderFiles).where(eq(purchaseOrderFiles.purchaseOrderId, purchaseOrderId)).orderBy(purchaseOrderFiles.uploadedAt);\n  }\n\n  async getPurchaseOrderFile(id: string): Promise<PurchaseOrderFile | undefined> {\n    const result = await db.select().from(purchaseOrderFiles).where(eq(purchaseOrderFiles.id, id)).limit(1);\n    return result[0];\n  }\n\n  async createPurchaseOrderFile(file: InsertPurchaseOrderFile): Promise<PurchaseOrderFile> {\n    const result = await db.insert(purchaseOrderFiles).values(file as any).returning();\n    return result[0];\n  }\n\n  async deletePurchaseOrderFile(id: string): Promise<void> {\n    await db.delete(purchaseOrderFiles).where(eq(purchaseOrderFiles.id, id));\n  }\n\n  // Returns\n  async getReturns(filters?: { status?: string; customerId?: string; orderId?: string; assignedUserId?: string }): Promise<Return[]> {\n    let query = db.select().from(returns);\n    \n    if (filters) {\n      const conditions = [];\n      if (filters.status) conditions.push(eq(returns.status, filters.status as any));\n      if (filters.customerId) conditions.push(eq(returns.customerId, filters.customerId));\n      if (filters.orderId) conditions.push(eq(returns.orderId, filters.orderId));\n      if (filters.assignedUserId) conditions.push(eq(returns.assignedUserId, filters.assignedUserId));\n      \n      if (conditions.length > 0) {\n        query = query.where(and(...conditions)) as any;\n      }\n    }\n    \n    return await query.orderBy(desc(returns.createdAt));\n  }\n\n  async getReturn(id: string): Promise<Return | undefined> {\n    const result = await db.select().from(returns).where(eq(returns.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getReturnByReturnNumber(returnNumber: string): Promise<Return | undefined> {\n    const result = await db.select().from(returns).where(eq(returns.returnNumber, returnNumber)).limit(1);\n    return result[0];\n  }\n\n  async generateReturnNumber(): Promise<string> {\n    const year = new Date().getFullYear();\n    const result = await db.select({ returnNumber: returns.returnNumber })\n      .from(returns)\n      .where(sql`${returns.returnNumber} LIKE ${`RET-${year}-%`}`)\n      .orderBy(desc(returns.returnNumber))\n      .limit(1);\n    \n    if (result.length === 0) {\n      return `RET-${year}-001`;\n    }\n    \n    const lastNumber = parseInt(result[0].returnNumber!.split('-')[2]) || 0;\n    const nextNumber = (lastNumber + 1).toString().padStart(3, '0');\n    return `RET-${year}-${nextNumber}`;\n  }\n\n  async createReturn(returnData: InsertReturn): Promise<Return> {\n    const returnNumber = await this.generateReturnNumber();\n    const result = await db.insert(returns).values({ \n      ...returnData, \n      returnNumber \n    } as any).returning();\n    \n    // Create activity log\n    await this.createActivity({\n      type: 'return_created',\n      description: `Return ${returnNumber} created`,\n      metadata: { returnId: result[0].id },\n    });\n    \n    return result[0];\n  }\n\n  async createReturnWithItems(returnData: InsertReturn, items: Omit<InsertReturnItem, 'returnId'>[]): Promise<Return> {\n    const returnNumber = await this.generateReturnNumber();\n    \n    // Use transaction to ensure atomicity\n    const newReturn = await db.transaction(async (tx) => {\n      // Create return within transaction\n      const result = await tx.insert(returns).values({ \n        ...returnData, \n        returnNumber \n      } as any).returning();\n      \n      const createdReturn = result[0];\n      \n      // Create return items within transaction if provided\n      if (items && items.length > 0) {\n        const itemsWithReturnId = items.map(item => ({\n          ...item,\n          returnId: createdReturn.id,\n        }));\n        \n        await tx.insert(returnItems).values(itemsWithReturnId as any);\n      }\n      \n      return createdReturn;\n    });\n    \n    // Create activity log (outside transaction, non-critical)\n    await this.createActivity({\n      type: 'return_created',\n      description: `Return ${returnNumber} created with ${items.length} item(s)`,\n      metadata: { returnId: newReturn.id, itemCount: items.length },\n    });\n    \n    return newReturn;\n  }\n\n  async updateReturn(id: string, returnData: Partial<InsertReturn>): Promise<Return> {\n    const result = await db.update(returns)\n      .set({ ...returnData, updatedAt: new Date() } as any)\n      .where(eq(returns.id, id))\n      .returning();\n    \n    return result[0];\n  }\n\n  async deleteReturn(id: string): Promise<void> {\n    // Delete return items first\n    await db.delete(returnItems).where(eq(returnItems.returnId, id));\n    // Delete return\n    await db.delete(returns).where(eq(returns.id, id));\n  }\n\n  async getReturnsByStatus(status: string): Promise<Return[]> {\n    return await db.select().from(returns).where(eq(returns.status, status as any)).orderBy(desc(returns.createdAt));\n  }\n\n  async getReturnsByCustomer(customerId: string): Promise<Return[]> {\n    return await db.select().from(returns).where(eq(returns.customerId, customerId)).orderBy(desc(returns.createdAt));\n  }\n\n  async createReturnFromCase(caseId: string): Promise<Return> {\n    // Get case details\n    const caseData = await this.getCase(caseId);\n    if (!caseData) {\n      throw new Error('Case not found');\n    }\n\n    // Create return with case information\n    const returnNumber = await this.generateReturnNumber();\n    const result = await db.insert(returns).values({\n      returnNumber,\n      caseId,\n      customerId: caseData.customerId || undefined,\n      status: 'nieuw_onderweg',\n      priority: caseData.priority || 'medium',\n      requestedAt: new Date(),\n    } as any).returning();\n\n    // Create case link\n    await this.createCaseLink({\n      caseId,\n      linkType: 'return',\n      linkedId: result[0].id,\n    });\n\n    // Create case event\n    await this.createCaseEvent({\n      caseId,\n      eventType: 'link_added',\n      message: `Return ${returnNumber} created from case`,\n      metadata: { returnId: result[0].id },\n    });\n\n    return result[0];\n  }\n\n  // Return Items\n  async getReturnItems(returnId: string): Promise<ReturnItem[]> {\n    return await db.select().from(returnItems).where(eq(returnItems.returnId, returnId)).orderBy(returnItems.createdAt);\n  }\n\n  async createReturnItem(item: InsertReturnItem): Promise<ReturnItem> {\n    const result = await db.insert(returnItems).values(item as any).returning();\n    return result[0];\n  }\n\n  async updateReturnItem(id: string, item: Partial<InsertReturnItem>): Promise<ReturnItem> {\n    const result = await db.update(returnItems)\n      .set({ ...item, updatedAt: new Date() } as any)\n      .where(eq(returnItems.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteReturnItem(id: string): Promise<void> {\n    await db.delete(returnItems).where(eq(returnItems.id, id));\n  }\n\n  // Search\n  async globalSearch(query: string) {\n    const searchTerm = `%${query}%`;\n\n    const [foundCustomers, foundOrders, foundEmailThreads, foundRepairs, foundPurchaseOrders] = await Promise.all([\n      db.select().from(customers).where(or(\n        ilike(customers.email, searchTerm),\n        ilike(customers.firstName, searchTerm),\n        ilike(customers.lastName, searchTerm)\n      )).limit(10),\n\n      db.select().from(orders).where(or(\n        ilike(orders.orderNumber, searchTerm),\n        ilike(orders.customerEmail, searchTerm)\n      )).limit(10),\n\n      db.select().from(emailThreads).where(or(\n        ilike(emailThreads.subject, searchTerm),\n        ilike(emailThreads.customerEmail, searchTerm)\n      )).limit(10),\n\n      db.select().from(repairs).where(or(\n        ilike(repairs.title, searchTerm),\n        ilike(repairs.description, searchTerm)\n      )).limit(10),\n\n      db.select().from(purchaseOrders).where(or(\n        ilike(purchaseOrders.poNumber, searchTerm),\n        ilike(purchaseOrders.notes, searchTerm)\n      )).limit(10)\n    ]);\n\n    return {\n      customers: foundCustomers,\n      orders: foundOrders,\n      emailThreads: foundEmailThreads,\n      repairs: foundRepairs,\n      purchaseOrders: foundPurchaseOrders\n    };\n  }\n\n  // Email Attachments\n  async getEmailAttachment(attachmentPath: string): Promise<EmailAttachment | undefined> {\n    const result = await db.select().from(emailAttachments).where(eq(emailAttachments.storageUrl, attachmentPath)).limit(1);\n    return result[0];\n  }\n\n  async getEmailMessageAttachments(messageId: string): Promise<EmailAttachment[]> {\n    return await db.select().from(emailAttachments).where(eq(emailAttachments.messageId, messageId));\n  }\n\n  async createEmailAttachment(attachment: InsertEmailAttachment): Promise<EmailAttachment> {\n    const result = await db.insert(emailAttachments).values(attachment).returning();\n    return result[0];\n  }\n\n  async downloadAttachment(attachmentPath: string, res: Response, forceDownload: boolean = false): Promise<void> {\n    const objectStorageService = new ObjectStorageService();\n    const file = await objectStorageService.getAttachmentFile(attachmentPath);\n    await objectStorageService.downloadObject(file, res, 3600, forceDownload);\n  }\n\n  // Notes (Universal)\n  async getNotes(entityType: string, entityId: string, filters?: { visibility?: string; tagIds?: string[]; authorId?: string; }): Promise<Note[]> {\n    const conditions = [\n      eq(notes.entityType, entityType as any),\n      eq(notes.entityId, entityId),\n      sql`${notes.deletedAt} IS NULL`\n    ];\n\n    if (filters?.visibility) {\n      conditions.push(eq(notes.visibility, filters.visibility as any));\n    }\n\n    if (filters?.authorId) {\n      conditions.push(eq(notes.authorId, filters.authorId));\n    }\n\n    let query = db.select().from(notes).where(and(...conditions));\n\n    if (filters?.tagIds && filters.tagIds.length > 0) {\n      const notesWithTags = await db\n        .select({ noteId: noteTagAssignments.noteId })\n        .from(noteTagAssignments)\n        .where(inArray(noteTagAssignments.tagId, filters.tagIds));\n      \n      const noteIds = notesWithTags.map(nt => nt.noteId);\n      if (noteIds.length > 0) {\n        conditions.push(inArray(notes.id, noteIds));\n      } else {\n        return [];\n      }\n    }\n\n    return await query.orderBy(desc(notes.isPinned), desc(notes.createdAt));\n  }\n\n  async getNote(id: string): Promise<Note | undefined> {\n    const result = await db.select().from(notes).where(\n      and(\n        eq(notes.id, id),\n        sql`${notes.deletedAt} IS NULL`\n      )\n    ).limit(1);\n    return result[0];\n  }\n\n  async createNote(note: InsertNote): Promise<Note> {\n    const result = await db.insert(notes).values(note as any).returning();\n    return result[0];\n  }\n\n  async updateNote(id: string, updates: Partial<InsertNote>): Promise<Note> {\n    const result = await db.update(notes).set({\n      ...updates,\n      updatedAt: new Date(),\n      editedAt: new Date()\n    } as any).where(eq(notes.id, id)).returning();\n    if (result.length === 0) {\n      throw new Error(\"Note not found\");\n    }\n    return result[0];\n  }\n\n  async deleteNote(id: string, reason: string, userId: string): Promise<void> {\n    const result = await db.update(notes).set({\n      deletedAt: new Date(),\n      deletedBy: userId,\n      deleteReason: reason\n    } as any).where(eq(notes.id, id)).returning();\n    if (result.length === 0) {\n      throw new Error(\"Note not found\");\n    }\n  }\n\n  async pinNote(noteId: string): Promise<void> {\n    const note = await this.getNote(noteId);\n    if (!note) {\n      throw new Error(\"Note not found\");\n    }\n\n    const pinnedNotes = await db.select().from(notes).where(\n      and(\n        eq(notes.entityType, note.entityType),\n        eq(notes.entityId, note.entityId),\n        eq(notes.isPinned, true),\n        sql`${notes.deletedAt} IS NULL`\n      )\n    );\n\n    if (pinnedNotes.length >= 3) {\n      throw new Error(\"Maximum 3 pinned notes per entity reached\");\n    }\n\n    await db.update(notes).set({\n      isPinned: true,\n      pinnedAt: new Date()\n    } as any).where(eq(notes.id, noteId));\n  }\n\n  async unpinNote(noteId: string): Promise<void> {\n    await db.update(notes).set({\n      isPinned: false,\n      pinnedAt: null,\n      pinnedBy: null\n    } as any).where(eq(notes.id, noteId));\n  }\n\n  async searchNotes(query: string, filters?: { entityType?: string; visibility?: string; }): Promise<Note[]> {\n    const searchTerm = `%${query}%`;\n    const conditions = [\n      sql`${notes.deletedAt} IS NULL`,\n      or(\n        ilike(notes.content, searchTerm),\n        ilike(notes.plainText, searchTerm)\n      )\n    ];\n\n    if (filters?.entityType) {\n      conditions.push(eq(notes.entityType, filters.entityType as any));\n    }\n\n    if (filters?.visibility) {\n      conditions.push(eq(notes.visibility, filters.visibility as any));\n    }\n\n    return await db.select().from(notes).where(and(...conditions)).orderBy(desc(notes.createdAt)).limit(50);\n  }\n\n  // Note Tags\n  async getNoteTags(): Promise<NoteTag[]> {\n    return await db.select().from(noteTags).orderBy(noteTags.name);\n  }\n\n  async createNoteTag(tag: InsertNoteTag): Promise<NoteTag> {\n    const result = await db.insert(noteTags).values(tag as any).returning();\n    return result[0];\n  }\n\n  async assignTagToNote(noteId: string, tagId: string): Promise<void> {\n    await db.insert(noteTagAssignments).values({\n      noteId,\n      tagId\n    } as any);\n  }\n\n  async removeTagFromNote(noteId: string, tagId: string): Promise<void> {\n    await db.delete(noteTagAssignments).where(\n      and(\n        eq(noteTagAssignments.noteId, noteId),\n        eq(noteTagAssignments.tagId, tagId)\n      )\n    );\n  }\n\n  // Note Mentions\n  async createNoteMention(mention: InsertNoteMention): Promise<NoteMention> {\n    const result = await db.insert(noteMentions).values(mention as any).returning();\n    return result[0];\n  }\n\n  async getNoteMentions(noteId: string): Promise<NoteMention[]> {\n    return await db.select().from(noteMentions).where(eq(noteMentions.noteId, noteId));\n  }\n\n  async markMentionRead(mentionId: string): Promise<void> {\n    await db.update(noteMentions).set({\n      notified: true,\n      notifiedAt: new Date()\n    } as any).where(eq(noteMentions.id, mentionId));\n  }\n\n  // Note Reactions\n  async addReaction(reaction: InsertNoteReaction): Promise<NoteReaction> {\n    const result = await db.insert(noteReactions).values(reaction as any).returning();\n    return result[0];\n  }\n\n  async removeReaction(noteId: string, userId: string, emoji: string): Promise<void> {\n    await db.delete(noteReactions).where(\n      and(\n        eq(noteReactions.noteId, noteId),\n        eq(noteReactions.userId, userId),\n        eq(noteReactions.emoji, emoji)\n      )\n    );\n  }\n\n  async getNoteReactions(noteId: string): Promise<NoteReaction[]> {\n    return await db.select().from(noteReactions).where(eq(noteReactions.noteId, noteId));\n  }\n\n  // Note Attachments\n  async createNoteAttachment(attachment: InsertNoteAttachment): Promise<NoteAttachment> {\n    const result = await db.insert(noteAttachments).values(attachment as any).returning();\n    return result[0];\n  }\n\n  async getNoteAttachments(noteId: string): Promise<NoteAttachment[]> {\n    return await db.select().from(noteAttachments).where(eq(noteAttachments.noteId, noteId));\n  }\n\n  async deleteNoteAttachment(id: string): Promise<void> {\n    await db.delete(noteAttachments).where(eq(noteAttachments.id, id));\n  }\n\n  // Note Follow-ups\n  async createNoteFollowup(followup: InsertNoteFollowup): Promise<NoteFollowup> {\n    const result = await db.insert(noteFollowups).values(followup as any).returning();\n    return result[0];\n  }\n\n  async getNoteFollowups(noteId: string): Promise<NoteFollowup[]> {\n    return await db.select().from(noteFollowups).where(eq(noteFollowups.noteId, noteId));\n  }\n\n  // Note Revisions\n  async createNoteRevision(revision: InsertNoteRevision): Promise<NoteRevision> {\n    const result = await db.insert(noteRevisions).values(revision as any).returning();\n    return result[0];\n  }\n\n  async getNoteRevisions(noteId: string): Promise<NoteRevision[]> {\n    return await db.select().from(noteRevisions).where(eq(noteRevisions.noteId, noteId)).orderBy(desc(noteRevisions.editedAt));\n  }\n\n  // Note Templates\n  async getNoteTemplates(entityType?: string): Promise<NoteTemplate[]> {\n    if (entityType) {\n      return await db.select().from(noteTemplates).where(\n        and(\n          eq(noteTemplates.isActive, true),\n          or(\n            eq(noteTemplates.entityType, entityType as any),\n            eq(noteTemplates.scope, 'global')\n          )\n        )\n      ).orderBy(noteTemplates.name);\n    }\n    return await db.select().from(noteTemplates).where(eq(noteTemplates.isActive, true)).orderBy(noteTemplates.name);\n  }\n\n  async createNoteTemplate(template: InsertNoteTemplate): Promise<NoteTemplate> {\n    const result = await db.insert(noteTemplates).values(template as any).returning();\n    return result[0];\n  }\n\n  async updateNoteTemplate(id: string, updates: Partial<InsertNoteTemplate>): Promise<NoteTemplate> {\n    const result = await db.update(noteTemplates).set({\n      ...updates,\n      updatedAt: new Date()\n    } as any).where(eq(noteTemplates.id, id)).returning();\n    if (result.length === 0) {\n      throw new Error(\"Note template not found\");\n    }\n    return result[0];\n  }\n\n  async deleteNoteTemplate(id: string): Promise<void> {\n    await db.update(noteTemplates).set({\n      isActive: false,\n      updatedAt: new Date()\n    } as any).where(eq(noteTemplates.id, id));\n  }\n\n  // Note Links\n  async createNoteLink(link: InsertNoteLink): Promise<NoteLink> {\n    const result = await db.insert(noteLinks).values(link as any).returning();\n    return result[0];\n  }\n\n  async getNoteLinks(noteId: string): Promise<NoteLink[]> {\n    return await db.select().from(noteLinks).where(eq(noteLinks.noteId, noteId));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":68103},"client/src/lib/auth.ts":{"content":"import { createContext, useContext } from \"react\";\nimport { User } from \"@shared/schema\";\n\nexport interface AuthUser {\n  id: string;\n  email: string;\n  role: \"ADMIN\" | \"SUPPORT\" | \"TECHNICUS\";\n  firstName?: string;\n  lastName?: string;\n}\n\nexport interface AuthContextType {\n  user: AuthUser | null;\n  loading: boolean;\n  signIn: (email: string, password: string) => Promise<{ error?: string }>;\n  signOut: () => Promise<void>;\n  refreshSession: () => Promise<void>;\n}\n\nexport const AuthContext = createContext<AuthContextType | null>(null);\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n\n// Auth service functions\nexport const authApi = {\n  async signIn(email: string, password: string): Promise<{ user?: AuthUser; error?: string }> {\n    try {\n      const response = await fetch(\"/api/auth/signin\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email, password }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        return { error: data.error || \"Sign in failed\" };\n      }\n\n      return { user: data.user };\n    } catch (error) {\n      return { error: \"Network error. Please try again.\" };\n    }\n  },\n\n  async signOut(): Promise<{ error?: string }> {\n    try {\n      const response = await fetch(\"/api/auth/signout\", {\n        method: \"POST\",\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        return { error: data.error || \"Sign out failed\" };\n      }\n\n      return {};\n    } catch (error) {\n      return { error: \"Network error. Please try again.\" };\n    }\n  },\n\n  async getSession(): Promise<{ user?: AuthUser; error?: string }> {\n    try {\n      const response = await fetch(\"/api/auth/session\");\n\n      if (!response.ok) {\n        if (response.status === 401) {\n          return {}; // No session\n        }\n        const data = await response.json();\n        return { error: data.error || \"Session check failed\" };\n      }\n\n      const data = await response.json();\n      return { user: data.user };\n    } catch (error) {\n      return { error: \"Network error. Please try again.\" };\n    }\n  },\n};\n\n// Role-based access control utilities\nexport const rbac = {\n  hasRole(user: AuthUser | null, roles: string[]): boolean {\n    if (!user) return false;\n    return roles.includes(user.role);\n  },\n\n  isAdmin(user: AuthUser | null): boolean {\n    return user?.role === \"ADMIN\";\n  },\n\n  canAccessUsers(user: AuthUser | null): boolean {\n    return this.hasRole(user, [\"ADMIN\"]);\n  },\n\n  canAccessReparaties(user: AuthUser | null): boolean {\n    return this.hasRole(user, [\"ADMIN\", \"TECHNICUS\"]);\n  },\n\n  canAccessCases(user: AuthUser | null): boolean {\n    return this.hasRole(user, [\"ADMIN\", \"SUPPORT\"]);\n  },\n\n  canAccessInbox(user: AuthUser | null): boolean {\n    return this.hasRole(user, [\"ADMIN\", \"SUPPORT\"]);\n  },\n\n  getRoleDisplayName(role: string): string {\n    const roleMap = {\n      ADMIN: \"Beheerder\",\n      SUPPORT: \"Support\",\n      TECHNICUS: \"Technicus\",\n    };\n    return roleMap[role as keyof typeof roleMap] || role;\n  },\n};","size_bytes":3220},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/hooks/use-theme.tsx":{"content":"import { useTheme as useThemeProvider } from \"@/providers/theme-provider\";\n\nexport const useTheme = useThemeProvider;\n","size_bytes":118},"client/src/pages/customer-detail.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { useRoute, Link } from \"wouter\";\nimport type { User as UserType } from \"@shared/schema\";\nimport { ArrowLeft, Mail, ShoppingCart, Wrench, User, Calendar, Phone, MapPin } from \"lucide-react\";\nimport { Card, CardHeader, CardContent, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { NotesPanel } from \"@/components/notes/NotesPanel\";\nimport type { Customer, Order, EmailThread, Repair } from \"@/lib/types\";\n\ninterface CustomerWithDetails extends Customer {\n  orders: Order[];\n  emailThreads: EmailThread[];\n  repairs: Repair[];\n}\n\nexport default function CustomerDetail() {\n  const [match, params] = useRoute(\"/customers/:id\");\n  const customerId = params?.id;\n\n  const { data: customer, isLoading: customerLoading } = useQuery<Customer>({\n    queryKey: [`/api/customers/${customerId}`],\n    enabled: !!customerId,\n  });\n\n  const { data: orders = [], isLoading: ordersLoading } = useQuery<Order[]>({\n    queryKey: [`/api/customers/${customerId}/orders`],\n    enabled: !!customerId,\n  });\n\n  const { data: emailThreads = [], isLoading: threadsLoading } = useQuery<EmailThread[]>({\n    queryKey: [`/api/customers/${customerId}/email-threads`],\n    enabled: !!customerId,\n  });\n\n  const { data: repairs = [], isLoading: repairsLoading } = useQuery<Repair[]>({\n    queryKey: [`/api/customers/${customerId}/repairs`],\n    enabled: !!customerId,\n  });\n\n  const { data: currentUser } = useQuery<UserType>({\n    queryKey: [\"/api/auth/session\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/session\");\n      if (!response.ok) throw new Error(\"Not authenticated\");\n      const data = await response.json();\n      return data.user;\n    },\n  });\n\n  if (!match) {\n    return <div>Customer not found</div>;\n  }\n\n  if (customerLoading) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"animate-pulse space-y-4\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/4\"></div>\n          <div className=\"h-4 bg-gray-200 rounded w-1/2\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!customer) {\n    return <div className=\"p-6\">Customer not found</div>;\n  }\n\n  const isLoading = ordersLoading || threadsLoading || repairsLoading;\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Header */}\n      <div className=\"border-b border-border\">\n        <div className=\"p-6\">\n          <div className=\"flex items-center gap-4 mb-4\">\n            <Button variant=\"ghost\" size=\"sm\" asChild data-testid=\"back-button\">\n              <Link href=\"/\">\n                <ArrowLeft className=\"h-4 w-4\" />\n              </Link>\n            </Button>\n            <div className=\"flex items-center gap-2\">\n              <User className=\"h-5 w-5 text-muted-foreground\" />\n              <h1 className=\"text-2xl font-semibold\" data-testid=\"customer-name\">\n                {customer.firstName} {customer.lastName}\n              </h1>\n            </div>\n          </div>\n\n          {/* Customer Info Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2\">\n                  <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                  <div>\n                    <p className=\"text-sm font-medium\">Email</p>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"customer-email\">{customer.email}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2\">\n                  <Phone className=\"h-4 w-4 text-muted-foreground\" />\n                  <div>\n                    <p className=\"text-sm font-medium\">Phone</p>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"customer-phone\">\n                      {customer.phone || \"Not provided\"}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2\">\n                  <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                  <div>\n                    <p className=\"text-sm font-medium\">Customer Since</p>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"customer-since\">\n                      {customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : \"Unknown\"}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-2\">\n                  <ShoppingCart className=\"h-4 w-4 text-muted-foreground\" />\n                  <div>\n                    <p className=\"text-sm font-medium\">Total Orders</p>\n                    <p className=\"text-sm text-muted-foreground\" data-testid=\"total-orders\">\n                      {orders.length}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </div>\n\n      {/* Content */}\n      <div className=\"p-6\">\n        <Tabs defaultValue=\"orders\" className=\"space-y-4\">\n          <TabsList>\n            <TabsTrigger value=\"orders\" data-testid=\"tab-orders\">\n              Orders ({orders.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"emails\" data-testid=\"tab-emails\">\n              Emails ({emailThreads.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"repairs\" data-testid=\"tab-repairs\">\n              Repairs ({repairs.length})\n            </TabsTrigger>\n            <TabsTrigger value=\"notes\" data-testid=\"tab-notes\">\n              Team Notes\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"orders\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <ShoppingCart className=\"h-5 w-5\" />\n                  Order History\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {isLoading ? (\n                  <div className=\"animate-pulse space-y-3\">\n                    {[1, 2, 3].map((i) => (\n                      <div key={i} className=\"h-16 bg-gray-200 rounded\"></div>\n                    ))}\n                  </div>\n                ) : orders.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {orders.map((order) => (\n                      <div\n                        key={order.id}\n                        className=\"flex items-center justify-between p-4 border border-border rounded-lg hover:bg-accent/50\"\n                        data-testid={`order-${order.id}`}\n                      >\n                        <div>\n                          <p className=\"font-medium\">Order #{order.orderNumber}</p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {order.createdAt ? new Date(order.createdAt).toLocaleDateString() : \"Unknown\"}\n                          </p>\n                        </div>\n                        <div className=\"text-right\">\n                          <p className=\"font-medium\">\n                            ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                          </p>\n                          <Badge variant={order.status === 'delivered' ? 'default' : 'secondary'}>\n                            {order.status}\n                          </Badge>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <p className=\"text-muted-foreground\">No orders found</p>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"emails\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Mail className=\"h-5 w-5\" />\n                  Email Communication\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {isLoading ? (\n                  <div className=\"animate-pulse space-y-3\">\n                    {[1, 2, 3].map((i) => (\n                      <div key={i} className=\"h-16 bg-gray-200 rounded\"></div>\n                    ))}\n                  </div>\n                ) : emailThreads.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {emailThreads.map((thread) => (\n                      <div\n                        key={thread.id}\n                        className=\"flex items-center justify-between p-4 border border-border rounded-lg hover:bg-accent/50\"\n                        data-testid={`email-thread-${thread.id}`}\n                      >\n                        <div>\n                          <p className=\"font-medium\">{thread.subject}</p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {thread.createdAt ? new Date(thread.createdAt).toLocaleDateString() : \"Unknown\"}\n                          </p>\n                        </div>\n                        <div>\n                          <Badge variant={thread.status === 'open' ? 'default' : 'secondary'}>\n                            {thread.status}\n                          </Badge>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <p className=\"text-muted-foreground\">No email threads found</p>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"repairs\" className=\"space-y-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Wrench className=\"h-5 w-5\" />\n                  Repair History\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {isLoading ? (\n                  <div className=\"animate-pulse space-y-3\">\n                    {[1, 2, 3].map((i) => (\n                      <div key={i} className=\"h-16 bg-gray-200 rounded\"></div>\n                    ))}\n                  </div>\n                ) : repairs.length > 0 ? (\n                  <div className=\"space-y-4\">\n                    {repairs.map((repair) => (\n                      <div\n                        key={repair.id}\n                        className=\"flex items-center justify-between p-4 border border-border rounded-lg hover:bg-accent/50\"\n                        data-testid={`repair-${repair.id}`}\n                      >\n                        <div>\n                          <p className=\"font-medium\">{repair.title}</p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {repair.createdAt ? new Date(repair.createdAt).toLocaleDateString() : \"Unknown\"}\n                          </p>\n                        </div>\n                        <div className=\"text-right\">\n                          <Badge variant={repair.status === 'closed' ? 'default' : 'secondary'}>\n                            {repair.status}\n                          </Badge>\n                          {repair.priority && (\n                            <p className=\"text-xs text-muted-foreground mt-1\">\n                              Priority: {repair.priority}\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <p className=\"text-muted-foreground\">No repairs found</p>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"notes\" className=\"space-y-4\">\n            {currentUser && (\n              <NotesPanel \n                entityType=\"customer\"\n                entityId={customerId!}\n                currentUser={currentUser}\n              />\n            )}\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}","size_bytes":12646},"server/objectStorage.ts":{"content":"import { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport {\n  ObjectAclPolicy,\n  ObjectPermission,\n  getObjectAclPolicy,\n  setObjectAclPolicy,\n} from \"./objectAcl\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\n// The object storage client is used to interact with the object storage service.\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\n// The object storage service is used to interact with the object storage service.\nexport class ObjectStorageService {\n  constructor() {}\n\n  // Gets the public object search paths.\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      throw new Error(\n        \"PUBLIC_OBJECT_SEARCH_PATHS not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PUBLIC_OBJECT_SEARCH_PATHS env var (comma-separated paths).\"\n      );\n    }\n    return paths;\n  }\n\n  // Gets the private object directory.\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  // Downloads an object to the response.\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600, forceDownload: boolean = false) {\n    try {\n      // Get file metadata\n      const [metadata] = await file.getMetadata();\n      // Get the ACL policy for the object.\n      const aclPolicy = await getObjectAclPolicy(file);\n      const isPublic = aclPolicy?.visibility === \"public\";\n      \n      const contentType = metadata.contentType || \"application/octet-stream\";\n      const filename = file.name.split('/').pop() || 'attachment';\n      \n      // Determine if content should be served inline or as attachment\n      const isPreviewable = contentType.startsWith('image/') || contentType.includes('pdf');\n      \n      // Set appropriate headers\n      const headers: Record<string, string> = {\n        \"Content-Type\": contentType,\n        \"Content-Length\": metadata.size?.toString() || \"\",\n        \"Cache-Control\": `${\n          isPublic ? \"public\" : \"private\"\n        }, max-age=${cacheTtlSec}`,\n        \"X-Content-Type-Options\": \"nosniff\",\n      };\n      \n      // Set Content-Disposition based on file type and forceDownload flag\n      if (forceDownload || !isPreviewable) {\n        headers[\"Content-Disposition\"] = `attachment; filename=\"${filename}\"`;\n        headers[\"X-Frame-Options\"] = \"DENY\";\n      } else {\n        headers[\"Content-Disposition\"] = `inline; filename=\"${filename}\"`;\n        // Allow framing for PDFs in preview\n        if (contentType.includes('pdf')) {\n          headers[\"X-Frame-Options\"] = \"SAMEORIGIN\";\n        }\n      }\n      \n      res.set(headers);\n\n      // Stream the file to the response\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err: any) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  // Save attachment to object storage and return the storage path\n  async saveAttachment(filename: string, data: Buffer, contentType?: string): Promise<string> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    const attachmentId = randomUUID();\n    const fullPath = `${privateObjectDir}/attachments/${attachmentId}/${filename}`;\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const file = bucket.file(objectName);\n\n    // Upload the file\n    await file.save(data, {\n      metadata: {\n        contentType: contentType || 'application/octet-stream',\n      },\n    });\n\n    // Set public ACL for attachments (they should be viewable)\n    const aclPolicy: ObjectAclPolicy = {\n      owner: 'system',\n      visibility: 'public',\n    };\n    await setObjectAclPolicy(file, aclPolicy);\n\n    return `/attachments/${attachmentId}/${filename}`;\n  }\n\n  // Gets the attachment file from the attachment path\n  async getAttachmentFile(attachmentPath: string): Promise<File> {\n    if (!attachmentPath.startsWith(\"/attachments/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const privateObjectDir = this.getPrivateObjectDir();\n    const fullPath = `${privateObjectDir}${attachmentPath}`;\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    \n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    \n    return objectFile;\n  }\n\n  // Delete an attachment file from object storage\n  async deleteAttachment(attachmentPath: string): Promise<void> {\n    try {\n      const file = await this.getAttachmentFile(attachmentPath);\n      await file.delete();\n      console.log(`Deleted attachment from object storage: ${attachmentPath}`);\n    } catch (error) {\n      if (error instanceof ObjectNotFoundError) {\n        // File already gone, not an error\n        console.log(`Attachment not found in object storage (may have been already deleted): ${attachmentPath}`);\n        return;\n      }\n      throw error;\n    }\n  }\n}\n\nfunction parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}","size_bytes":6845},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/repairs/repairs-table.tsx":{"content":"import { useState } from \"react\";\nimport type { Repair, User } from \"@shared/schema\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\nimport { MoreHorizontal, Eye, Edit, Trash2, MessageSquare, AlertTriangle } from \"lucide-react\";\nimport { format, isPast } from \"date-fns\";\nimport { nl } from \"date-fns/locale\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useAuth } from \"@/lib/auth\";\n\ninterface RepairsTableProps {\n  repairs: Repair[];\n  users: User[];\n  onRepairClick: (repair: Repair) => void;\n  onAddNote?: (repair: Repair) => void;\n}\n\nexport function RepairsTable({ repairs, users, onRepairClick, onAddNote }: RepairsTableProps) {\n  const { toast } = useToast();\n  const { user } = useAuth();\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      await apiRequest('DELETE', `/api/repairs/${id}`);\n    },\n    onMutate: async (deletedId) => {\n      // Cancel outgoing refetches\n      await queryClient.cancelQueries({ queryKey: ['/api/repairs'] });\n      \n      // Snapshot previous value\n      const previousRepairs = queryClient.getQueryData(['/api/repairs']);\n      \n      // Optimistically update cache\n      queryClient.setQueryData(['/api/repairs'], (old: Repair[] | undefined) => {\n        return old?.filter((repair) => repair.id !== deletedId) || [];\n      });\n      \n      return { previousRepairs };\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/repairs'] });\n      toast({\n        title: \"Reparatie verwijderd\",\n        description: \"De reparatie is succesvol verwijderd.\",\n      });\n    },\n    onError: (err, deletedId, context) => {\n      // Rollback on error\n      if (context?.previousRepairs) {\n        queryClient.setQueryData(['/api/repairs'], context.previousRepairs);\n      }\n      toast({\n        title: \"Fout\",\n        description: \"Kan reparatie niet verwijderen.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'new':\n        return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';\n      case 'diagnosing':\n        return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';\n      case 'waiting_parts':\n        return 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';\n      case 'repair_in_progress':\n        return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';\n      case 'quality_check':\n        return 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200';\n      case 'completed':\n        return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';\n      case 'returned':\n        return 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200';\n      case 'canceled':\n        return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';\n      default:\n        return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getStatusLabel = (status: string) => {\n    switch (status) {\n      case 'new': return 'Nieuw';\n      case 'diagnosing': return 'Diagnose';\n      case 'waiting_parts': return 'Wacht op onderdelen';\n      case 'repair_in_progress': return 'In reparatie';\n      case 'quality_check': return 'Kwaliteitscontrole';\n      case 'completed': return 'Voltooid';\n      case 'returned': return 'Geretourneerd';\n      case 'canceled': return 'Geannuleerd';\n      default: return status;\n    }\n  };\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case 'urgent': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';\n      case 'high': return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';\n      case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';\n      case 'low': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';\n      default: return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getPriorityLabel = (priority: string) => {\n    switch (priority) {\n      case 'urgent': return 'Urgent';\n      case 'high': return 'Hoog';\n      case 'medium': return 'Gemiddeld';\n      case 'low': return 'Laag';\n      default: return priority;\n    }\n  };\n\n  const getTechnicianName = (userId: string | null) => {\n    if (!userId) return 'Niet toegewezen';\n    const user = users.find(u => u.id === userId);\n    return user ? `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username : 'Onbekend';\n  };\n\n  const isOverdue = (repair: Repair) => {\n    if (!repair.slaDeadline) return false;\n    const isActive = !['completed', 'returned', 'canceled'].includes(repair.status);\n    return isActive && isPast(new Date(repair.slaDeadline));\n  };\n\n  const handleDelete = (e: React.MouseEvent, repairId: string) => {\n    e.stopPropagation();\n    if (confirm('Weet je zeker dat je deze reparatie wilt verwijderen?')) {\n      deleteMutation.mutate(repairId);\n    }\n  };\n\n  return (\n    <div className=\"rounded-md border\">\n      <Table>\n        <TableHeader>\n          <TableRow>\n            <TableHead>Reparatie ID</TableHead>\n            <TableHead>Product</TableHead>\n            <TableHead>Klant / Order</TableHead>\n            <TableHead>Probleem</TableHead>\n            <TableHead>Technicus</TableHead>\n            <TableHead>Status</TableHead>\n            <TableHead>Prioriteit</TableHead>\n            <TableHead>Ontvangen</TableHead>\n            <TableHead>Laatst bijgewerkt</TableHead>\n            <TableHead className=\"text-right\">Acties</TableHead>\n          </TableRow>\n        </TableHeader>\n        <TableBody>\n          {repairs.length === 0 ? (\n            <TableRow>\n              <TableCell colSpan={10} className=\"text-center text-muted-foreground\">\n                Geen reparaties gevonden\n              </TableCell>\n            </TableRow>\n          ) : (\n            repairs.map((repair) => (\n              <TableRow\n                key={repair.id}\n                className=\"cursor-pointer hover:bg-muted/50\"\n                onClick={() => onRepairClick(repair)}\n                data-testid={`row-repair-${repair.id}`}\n              >\n                <TableCell className=\"font-medium font-mono text-xs\" data-testid={`text-repair-id-${repair.id}`}>\n                  #{repair.id.slice(0, 8)}\n                </TableCell>\n                <TableCell>\n                  <div className=\"flex flex-col\">\n                    <span className=\"font-medium\">{repair.productName || repair.title}</span>\n                    {repair.productSku && (\n                      <span className=\"text-xs text-muted-foreground\">SKU: {repair.productSku}</span>\n                    )}\n                  </div>\n                </TableCell>\n                <TableCell>\n                  <div className=\"flex flex-col\">\n                    {repair.customerName ? (\n                      <span className=\"text-sm\">{repair.customerName}</span>\n                    ) : repair.customerEmail ? (\n                      <span className=\"text-sm\">{repair.customerEmail}</span>\n                    ) : (\n                      <span className=\"text-sm text-muted-foreground\">Geen klant</span>\n                    )}\n                    {repair.orderNumber && (\n                      <span className=\"text-xs text-muted-foreground\">{repair.orderNumber}</span>\n                    )}\n                  </div>\n                </TableCell>\n                <TableCell>\n                  <div className=\"max-w-xs truncate\">\n                    {repair.issueCategory && (\n                      <Badge variant=\"outline\" className=\"mb-1 mr-2\">{repair.issueCategory}</Badge>\n                    )}\n                    <span className=\"text-sm\">{repair.description || repair.title}</span>\n                  </div>\n                </TableCell>\n                <TableCell>{getTechnicianName(repair.assignedUserId)}</TableCell>\n                <TableCell>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge \n                      variant=\"secondary\" \n                      className={getStatusColor(repair.status)}\n                      data-testid={`badge-status-${repair.id}`}\n                    >\n                      {getStatusLabel(repair.status)}\n                    </Badge>\n                    {isOverdue(repair) && (\n                      <div className=\"flex items-center gap-1 text-destructive\" data-testid={`indicator-overdue-${repair.id}`}>\n                        <AlertTriangle className=\"h-4 w-4\" />\n                        <span className=\"text-xs font-medium\">Te laat</span>\n                      </div>\n                    )}\n                  </div>\n                </TableCell>\n                <TableCell>\n                  <Badge \n                    variant=\"secondary\" \n                    className={getPriorityColor(repair.priority || 'medium')}\n                  >\n                    {getPriorityLabel(repair.priority || 'medium')}\n                  </Badge>\n                </TableCell>\n                <TableCell>\n                  {repair.createdAt\n                    ? format(new Date(repair.createdAt), \"d MMM yyyy\", { locale: nl })\n                    : \"-\"}\n                </TableCell>\n                <TableCell>\n                  {repair.updatedAt\n                    ? format(new Date(repair.updatedAt), \"d MMM HH:mm\", { locale: nl })\n                    : \"-\"}\n                </TableCell>\n                <TableCell className=\"text-right\">\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n                      <Button variant=\"ghost\" size=\"sm\" data-testid={`button-actions-${repair.id}`}>\n                        <MoreHorizontal className=\"h-4 w-4\" />\n                      </Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem \n                        onClick={(e) => { e.stopPropagation(); onRepairClick(repair); }}\n                        data-testid={`menu-view-details-${repair.id}`}\n                      >\n                        <Eye className=\"mr-2 h-4 w-4\" />\n                        Details bekijken\n                      </DropdownMenuItem>\n                      <DropdownMenuItem \n                        onClick={(e) => { e.stopPropagation(); onRepairClick(repair); }}\n                        data-testid={`menu-update-status-${repair.id}`}\n                      >\n                        <Edit className=\"mr-2 h-4 w-4\" />\n                        Status bijwerken\n                      </DropdownMenuItem>\n                      {onAddNote && (\n                        <DropdownMenuItem \n                          onClick={(e) => { e.stopPropagation(); onAddNote(repair); }}\n                          data-testid={`menu-add-note-${repair.id}`}\n                        >\n                          <MessageSquare className=\"mr-2 h-4 w-4\" />\n                          Notitie toevoegen\n                        </DropdownMenuItem>\n                      )}\n                      {user?.role === 'ADMIN' && (\n                        <DropdownMenuItem \n                          onClick={(e) => handleDelete(e, repair.id)}\n                          className=\"text-destructive focus:text-destructive\"\n                          data-testid={`menu-delete-${repair.id}`}\n                        >\n                          <Trash2 className=\"mr-2 h-4 w-4\" />\n                          Verwijderen\n                        </DropdownMenuItem>\n                      )}\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </TableCell>\n              </TableRow>\n            ))\n          )}\n        </TableBody>\n      </Table>\n    </div>\n  );\n}\n","size_bytes":12182},"server/routes.ts":{"content":"import type { Express, Request, Response, NextFunction } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport bcrypt from \"bcryptjs\";\nimport { z } from \"zod\";\nimport { storage } from \"./storage\";\nimport { db } from \"./services/supabaseClient\";\nimport {\n  insertTodoSchema,\n  insertRepairSchema,\n  insertInternalNoteSchema,\n  insertPurchaseOrderSchema,\n  insertReturnSchema,\n  insertReturnItemSchema,\n  insertCaseSchema,\n  insertCaseItemSchema,\n  insertCaseLinkSchema,\n  insertCaseNoteSchema,\n  insertUserSchema,\n  insertAuditLogSchema,\n  purchaseOrderItems,\n  insertNoteSchema,\n  insertNoteTagSchema,\n  insertNoteMentionSchema,\n  insertNoteReactionSchema,\n  insertNoteAttachmentSchema,\n  insertNoteFollowupSchema,\n  insertNoteRevisionSchema,\n  insertNoteTemplateSchema,\n  insertNoteLinkSchema,\n} from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\nimport { syncEmails, sendEmail } from \"./services/emailService\";\nimport { shopifyClient } from \"./services/shopifyClient\";\nimport { OrderMatchingService } from \"./services/orderMatchingService\";\nimport { ObjectStorageService } from \"./objectStorage\";\nimport { importAllEmails } from \"./scripts/importAllEmails\";\nimport multer from \"multer\";\nimport Papa from \"papaparse\";\n\n// Extend Request type to include session\ninterface AuthenticatedRequest extends Request {\n  session: any;\n  user?: any;\n}\n\n// Authentication middleware\nconst requireAuth = async (req: any, res: any, next: any) => {\n  const userId = req.session?.userId;\n  if (!userId) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n\n  const user = await storage.getUser(userId);\n  if (!user) {\n    req.session.destroy(() => {});\n    return res.status(401).json({ error: \"User not found\" });\n  }\n\n  req.user = user;\n  next();\n};\n\n// Role-based authorization middleware\nconst requireRole = (roles: string[]) => {\n  return async (req: any, res: any, next: any) => {\n    if (!req.user) {\n      return res.status(401).json({ error: \"Authentication required\" });\n    }\n\n    if (!roles.includes(req.user.role)) {\n      // Log unauthorized access attempt\n      await storage.createAuditLog({\n        userId: req.user.id,\n        action: \"UNAUTHORIZED_ACCESS\",\n        resource: \"endpoint\",\n        resourceId: req.path,\n        details: {\n          requiredRoles: roles,\n          userRole: req.user.role,\n          method: req.method,\n          endpoint: req.path,\n        },\n        ipAddress: req.ip,\n        userAgent: req.get(\"User-Agent\"),\n        success: false,\n        errorMessage: \"Insufficient permissions\",\n      });\n\n      return res.status(403).json({ error: \"Insufficient permissions\" });\n    }\n\n    next();\n  };\n};\n\n// Audit logging helper\nconst auditLog = async (\n  req: any,\n  action: string,\n  resource: string,\n  resourceId?: string,\n  details?: any,\n) => {\n  if (req.user) {\n    await storage.createAuditLog({\n      userId: req.user.id,\n      action,\n      resource,\n      resourceId,\n      details,\n      ipAddress: req.ip,\n      userAgent: req.get(\"User-Agent\"),\n      success: true,\n    });\n  }\n};\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Initialize order matching service\n  const orderMatchingService = new OrderMatchingService(storage);\n\n  // Configure multer for file uploads (memory storage with limits)\n  const upload = multer({ \n    storage: multer.memoryStorage(),\n    limits: { \n      fileSize: 10 * 1024 * 1024, // 10MB max file size\n      files: 10 // max 10 files per request\n    }\n  });\n\n  // Authentication routes\n  app.post(\"/api/auth/signin\", async (req, res) => {\n    try {\n      const { email, password } = req.body;\n\n      if (!email || !password) {\n        return res\n          .status(400)\n          .json({ error: \"Email and password are required\" });\n      }\n\n      const user = await storage.getUserByEmail(email);\n      if (!user) {\n        // Log failed login attempt\n        await storage.createAuditLog({\n          action: \"LOGIN_FAILED\",\n          resource: \"auth\",\n          details: { email, reason: \"User not found\" },\n          ipAddress: req.ip,\n          userAgent: req.get(\"User-Agent\"),\n          success: false,\n          errorMessage: \"Invalid credentials\",\n        });\n        return res.status(401).json({ error: \"Invalid credentials\" });\n      }\n\n      const isValidPassword = await bcrypt.compare(password, user.password);\n      if (!isValidPassword) {\n        // Log failed login attempt\n        await storage.createAuditLog({\n          userId: user.id,\n          action: \"LOGIN_FAILED\",\n          resource: \"auth\",\n          details: { email, reason: \"Invalid password\" },\n          ipAddress: req.ip,\n          userAgent: req.get(\"User-Agent\"),\n          success: false,\n          errorMessage: \"Invalid credentials\",\n        });\n        return res.status(401).json({ error: \"Invalid credentials\" });\n      }\n\n      // Create session\n      (req as any).session.userId = user.id;\n\n      // Log successful login\n      await storage.createAuditLog({\n        userId: user.id,\n        action: \"LOGIN_SUCCESS\",\n        resource: \"auth\",\n        details: { email },\n        ipAddress: req.ip,\n        userAgent: req.get(\"User-Agent\"),\n        success: true,\n      });\n\n      const { password: _, ...userWithoutPassword } = user;\n      res.json({\n        user: {\n          id: user.id,\n          email: user.email,\n          role: user.role,\n          firstName: user.firstName,\n          lastName: user.lastName,\n        },\n      });\n    } catch (error) {\n      console.error(\"Sign in error:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n  app.post(\"/api/auth/signout\", requireAuth, async (req: any, res: any) => {\n    try {\n      // Log logout\n      await auditLog(req, \"LOGOUT\", \"auth\");\n\n      req.session.destroy((err: any) => {\n        if (err) {\n          console.error(\"Session destroy error:\", err);\n          return res.status(500).json({ error: \"Failed to sign out\" });\n        }\n        res.json({ message: \"Signed out successfully\" });\n      });\n    } catch (error) {\n      console.error(\"Sign out error:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n  app.get(\"/api/auth/session\", async (req: any, res: any) => {\n    try {\n      const userId = req.session?.userId;\n      if (!userId) {\n        return res.status(401).json({ error: \"No active session\" });\n      }\n\n      const user = await storage.getUser(userId);\n      if (!user) {\n        req.session.destroy(() => {});\n        return res.status(401).json({ error: \"User not found\" });\n      }\n\n      res.json({\n        user: {\n          id: user.id,\n          email: user.email,\n          role: user.role,\n          firstName: user.firstName,\n          lastName: user.lastName,\n        },\n      });\n    } catch (error) {\n      console.error(\"Session check error:\", error);\n      res.status(500).json({ error: \"Internal server error\" });\n    }\n  });\n\n  // User Management routes\n  // Get all users (all authenticated users can view user list for assignment/filtering)\n  app.get(\"/api/users\", requireAuth, async (req: any, res: any) => {\n    try {\n      const users = await storage.getUsers();\n      await auditLog(req, \"LIST\", \"users\");\n\n      // Remove passwords from response\n      const safeUsers = users.map((user) => {\n        const { password, ...userWithoutPassword } = user;\n        return userWithoutPassword;\n      });\n\n      res.json(safeUsers);\n    } catch (error) {\n      console.error(\"Error fetching users:\", error);\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  // User list for assignment dropdowns (accessible to all authenticated users)\n  app.get(\"/api/users/list\", requireAuth, async (req: any, res: any) => {\n    try {\n      const users = await storage.getUsers();\n\n      // Return only necessary fields for dropdowns\n      const userList = users.map((user) => ({\n        id: user.id,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        email: user.email,\n        role: user.role,\n      }));\n\n      res.json(userList);\n    } catch (error) {\n      console.error(\"Error fetching user list:\", error);\n      res.status(500).json({ error: \"Failed to fetch user list\" });\n    }\n  });\n\n  app.post(\n    \"/api/users\",\n    requireAuth,\n    requireRole([\"ADMIN\"]),\n    async (req: any, res: any) => {\n      try {\n        // Create schema for frontend data (without username)\n        const createUserSchema = z.object({\n          email: z.string().email(\"Please enter a valid email address\"),\n          password: z.string().min(6, \"Password must be at least 6 characters\"),\n          firstName: z.string().min(1, \"First name is required\"),\n          lastName: z.string().min(1, \"Last name is required\"),\n          role: z.enum([\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"]),\n        });\n\n        const userData = createUserSchema.parse(req.body);\n\n        // Hash password\n        const hashedPassword = await bcrypt.hash(userData.password, 10);\n\n        // Generate username from email\n        const username = userData.email.split(\"@\")[0];\n\n        const newUser = await storage.createUser({\n          ...userData,\n          password: hashedPassword,\n          username,\n        });\n\n        await auditLog(req, \"CREATE\", \"users\", newUser.id, {\n          email: newUser.email,\n          role: newUser.role,\n        });\n\n        const { password, ...userWithoutPassword } = newUser;\n        res.status(201).json(userWithoutPassword);\n      } catch (error: unknown) {\n        console.error(\"Error creating user:\", error);\n        if (error instanceof z.ZodError) {\n          res\n            .status(400)\n            .json({ error: \"Invalid user data\", details: error.errors });\n        } else if (\n          error &&\n          typeof error === \"object\" &&\n          \"code\" in error &&\n          error.code === \"23505\"\n        ) {\n          res.status(409).json({ error: \"Email or username already exists\" });\n        } else {\n          res.status(400).json({ error: \"Failed to create user\" });\n        }\n      }\n    },\n  );\n\n  app.patch(\n    \"/api/users/:id\",\n    requireAuth,\n    requireRole([\"ADMIN\"]),\n    async (req: any, res: any) => {\n      try {\n        const { id } = req.params;\n        const updateData = req.body;\n\n        // Validate that user exists\n        const existingUser = await storage.getUser(id);\n        if (!existingUser) {\n          return res.status(404).json({ error: \"User not found\" });\n        }\n\n        // Create update schema that excludes password and sensitive fields\n        const updateUserSchema = z.object({\n          email: z.string().email().optional(),\n          firstName: z.string().optional(),\n          lastName: z.string().optional(),\n          role: z.enum([\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"]).optional(),\n        });\n\n        // Validate update data\n        const validatedUpdateData = updateUserSchema.parse(updateData);\n\n        // Update user\n        const updatedUser = await storage.updateUser(id, validatedUpdateData);\n        await auditLog(req, \"UPDATE\", \"users\", id, validatedUpdateData);\n\n        // Return user without password\n        const { password, ...userWithoutPassword } = updatedUser;\n        res.json(userWithoutPassword);\n      } catch (error: unknown) {\n        console.error(\"Update user error:\", error);\n        if (error instanceof z.ZodError) {\n          res\n            .status(400)\n            .json({ error: \"Invalid update data\", details: error.errors });\n        } else if (\n          error &&\n          typeof error === \"object\" &&\n          \"code\" in error &&\n          error.code === \"23505\"\n        ) {\n          res.status(409).json({ error: \"Email already exists\" });\n        } else {\n          res.status(500).json({ error: \"Failed to update user\" });\n        }\n      }\n    },\n  );\n\n  app.delete(\n    \"/api/users/:id\",\n    requireAuth,\n    requireRole([\"ADMIN\"]),\n    async (req: any, res: any) => {\n      try {\n        const { id } = req.params;\n\n        // Validate that user exists and is not the current user\n        const existingUser = await storage.getUser(id);\n        if (!existingUser) {\n          return res.status(404).json({ error: \"User not found\" });\n        }\n\n        if (id === req.user.id) {\n          return res\n            .status(400)\n            .json({ error: \"Cannot delete your own account\" });\n        }\n\n        await storage.deleteUser(id);\n        await auditLog(req, \"DELETE\", \"users\", id, {\n          email: existingUser.email,\n        });\n\n        res.json({ message: \"User deleted successfully\" });\n      } catch (error) {\n        console.error(\"Delete user error:\", error);\n        res.status(500).json({ error: \"Failed to delete user\" });\n      }\n    },\n  );\n\n  // Dashboard stats\n  app.get(\"/api/dashboard/stats\", async (req, res) => {\n    try {\n      const stats = await storage.getDashboardStats();\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching dashboard stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch dashboard stats\" });\n    }\n  });\n\n  // Todos\n  app.get(\"/api/todos\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { userId, caseId } = req.query;\n\n      if (caseId) {\n        // Get todos linked to a specific case\n        const relatedItems = await storage.getCaseRelatedItems(\n          caseId as string,\n        );\n        let todos = relatedItems.todos;\n\n        // Apply role-based filtering even for case-linked todos\n        if (req.user.role === \"TECHNICUS\") {\n          // TECHNICUS only sees their own tasks\n          todos = todos.filter(\n            (todo: any) => todo.assignedUserId === req.user.id,\n          );\n        }\n        // ADMIN and SUPPORT can see all case-linked todos\n\n        res.json(todos);\n      } else {\n        // Role-based filtering\n        let todos: any[];\n\n        if (req.user.role === \"ADMIN\" || req.user.role === \"SUPPORT\") {\n          // ADMIN and SUPPORT see all tasks or filtered by userId if provided\n          todos = await storage.getTodos(userId as string);\n        } else if (req.user.role === \"TECHNICUS\") {\n          // TECHNICUS only sees their own tasks\n          todos = await storage.getTodos(req.user.id);\n        } else {\n          // Fallback: return empty array for unknown roles\n          todos = [];\n        }\n\n        res.json(todos);\n      }\n    } catch (error) {\n      console.error(\"Error fetching todos:\", error);\n      res.status(500).json({ message: \"Failed to fetch todos\" });\n    }\n  });\n\n  app.post(\"/api/todos\", requireAuth, async (req: any, res: any) => {\n    try {\n      const validatedData = insertTodoSchema.parse(req.body);\n\n      // Set createdBy from authenticated user\n      validatedData.createdBy = req.user.id;\n\n      // Convert dueDate string to Date object if provided\n      if (validatedData.dueDate && typeof validatedData.dueDate === \"string\") {\n        validatedData.dueDate = new Date(validatedData.dueDate);\n      }\n\n      const todo = await storage.createTodo(validatedData);\n\n      // Create activity\n      await storage.createActivity({\n        type: \"todo_created\",\n        description: `Created todo: ${todo.title}`,\n        userId: todo.assignedUserId,\n        metadata: { todoId: todo.id },\n      });\n\n      await auditLog(req, \"CREATE\", \"todos\", todo.id, {\n        title: todo.title,\n        category: todo.category,\n      });\n\n      res.status(201).json(todo);\n    } catch (error) {\n      console.error(\"Error creating todo:\", error);\n      res.status(400).json({ message: \"Failed to create todo\" });\n    }\n  });\n\n  app.patch(\"/api/todos/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n\n      // Create update schema to validate fields including category\n      const updateTodoSchema = z.object({\n        title: z.string().optional(),\n        description: z.string().optional(),\n        category: z\n          .enum([\"orders\", \"purchasing\", \"marketing\", \"admin\", \"other\"])\n          .optional(),\n        assignedUserId: z.string().optional(),\n        status: z.enum([\"todo\", \"in_progress\", \"done\"]).optional(),\n        priority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).optional(),\n        dueDate: z\n          .union([z.string().datetime(), z.date(), z.null()])\n          .optional(),\n        completedAt: z\n          .union([z.string().datetime(), z.date(), z.null()])\n          .optional(),\n        customerId: z.string().optional(),\n        orderId: z.string().optional(),\n        repairId: z.string().optional(),\n        emailThreadId: z.string().optional(),\n        caseId: z.string().optional(),\n      });\n\n      // Validate update data\n      const validatedData = updateTodoSchema.parse(req.body);\n\n      // Convert date strings to Date objects if provided\n      const updateData: any = { ...validatedData };\n      if (updateData.dueDate && typeof updateData.dueDate === \"string\") {\n        updateData.dueDate = new Date(updateData.dueDate);\n      }\n      if (\n        updateData.completedAt &&\n        typeof updateData.completedAt === \"string\"\n      ) {\n        updateData.completedAt = new Date(updateData.completedAt);\n      }\n\n      const todo = await storage.updateTodo(id, updateData);\n\n      if (req.body.status === \"done\") {\n        await storage.createActivity({\n          type: \"todo_completed\",\n          description: `Completed todo: ${todo.title}`,\n          userId: todo.assignedUserId,\n          metadata: { todoId: todo.id },\n        });\n      }\n\n      await auditLog(req, \"UPDATE\", \"todos\", id, validatedData);\n\n      res.json(todo);\n    } catch (error) {\n      console.error(\"Error updating todo:\", error);\n      res.status(400).json({ message: \"Failed to update todo\" });\n    }\n  });\n\n  app.delete(\"/api/todos/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteTodo(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting todo:\", error);\n      res.status(400).json({ message: \"Failed to delete todo\" });\n    }\n  });\n\n  // Repairs\n  app.get(\"/api/repairs\", requireAuth, async (req: any, res) => {\n    try {\n      const { caseId, status, technicianId, startDate, endDate, priority } =\n        req.query;\n\n      if (caseId) {\n        // Get repairs linked to a specific case\n        const relatedItems = await storage.getCaseRelatedItems(\n          caseId as string,\n        );\n\n        res.json(relatedItems.repairs);\n        return;\n      }\n\n      // Define filter schema for validation\n      const filterSchema = z.object({\n        status: z\n          .enum([\n            \"new\",\n            \"diagnosing\",\n            \"waiting_parts\",\n            \"repair_in_progress\",\n            \"quality_check\",\n            \"completed\",\n            \"returned\",\n            \"canceled\",\n          ])\n          .optional(),\n        technicianId: z.string().uuid().optional(),\n        priority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).optional(),\n        startDate: z.string().datetime().optional(),\n        endDate: z.string().datetime().optional(),\n      });\n\n      // Validate query parameters\n      const validationResult = filterSchema.safeParse({\n        status,\n        technicianId,\n        priority,\n        startDate,\n        endDate,\n      });\n\n      if (!validationResult.success) {\n        return res\n          .status(400)\n          .json({\n            message: \"Invalid filter parameters\",\n            errors: validationResult.error.errors,\n          });\n      }\n\n      const validatedFilters = validationResult.data;\n\n      // Build filters object\n      const filters: {\n        status?: string;\n        technicianId?: string;\n        priority?: string;\n        startDate?: Date;\n        endDate?: Date;\n      } = {};\n\n      if (validatedFilters.status) filters.status = validatedFilters.status;\n      if (validatedFilters.technicianId)\n        filters.technicianId = validatedFilters.technicianId;\n      if (validatedFilters.priority)\n        filters.priority = validatedFilters.priority;\n      if (validatedFilters.startDate)\n        filters.startDate = new Date(validatedFilters.startDate);\n      if (validatedFilters.endDate)\n        filters.endDate = new Date(validatedFilters.endDate);\n\n      const hasFilters = Object.keys(filters).length > 0;\n\n      if (hasFilters) {\n        const repairs = await storage.getRepairsWithFilters(filters);\n        res.json(repairs);\n      } else {\n        const repairs = await storage.getRepairs();\n        res.json(repairs);\n      }\n    } catch (error) {\n      console.error(\"Error fetching repairs:\", error);\n      res.status(500).json({ message: \"Failed to fetch repairs\" });\n    }\n  });\n\n  app.get(\"/api/repairs/:id\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const repair = await storage.getRepair(id);\n      if (!repair) {\n        return res.status(404).json({ message: \"Repair not found\" });\n      }\n\n      res.json(repair);\n    } catch (error) {\n      console.error(\"Error fetching repair:\", error);\n      res.status(500).json({ message: \"Failed to fetch repair\" });\n    }\n  });\n\n  app.post(\n    \"/api/repairs\",\n    requireAuth,\n    requireRole([\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"]),\n    async (req: any, res) => {\n      try {\n        // Handle date conversion before validation\n        const requestData = { ...req.body };\n        if (\n          requestData.slaDeadline &&\n          typeof requestData.slaDeadline === \"string\"\n        ) {\n          requestData.slaDeadline = new Date(requestData.slaDeadline);\n        }\n\n        const validatedData = insertRepairSchema.parse(requestData);\n        const repair = await storage.createRepair(validatedData);\n\n        await storage.createActivity({\n          type: \"repair_created\",\n          description: `Created repair: ${repair.title}`,\n          userId: req.user.id,\n          metadata: { repairId: repair.id },\n        });\n\n        await auditLog(req, \"CREATE\", \"repairs\", repair.id, validatedData);\n\n        res.status(201).json(repair);\n      } catch (error) {\n        console.error(\"Error creating repair:\", error);\n        res.status(400).json({ message: \"Failed to create repair\" });\n      }\n    },\n  );\n\n  app.patch(\"/api/repairs/:id\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n\n      // Get existing repair to check it exists\n      const existingRepair = await storage.getRepair(id);\n      if (!existingRepair) {\n        return res.status(404).json({ message: \"Repair not found\" });\n      }\n\n      const repair = await storage.updateRepair(id, req.body);\n\n      if (req.body.status) {\n        await storage.createActivity({\n          type: \"repair_status_updated\",\n          description: `Updated repair status to ${req.body.status}: ${repair.title}`,\n          userId: req.user.id,\n          metadata: { repairId: repair.id, status: req.body.status },\n        });\n      }\n\n      await auditLog(req, \"UPDATE\", \"repairs\", id, req.body);\n\n      res.json(repair);\n    } catch (error) {\n      console.error(\"Error updating repair:\", error);\n      res.status(400).json({ message: \"Failed to update repair\" });\n    }\n  });\n\n  app.delete(\"/api/repairs/:id\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n\n      // Get existing repair to check permissions\n      const existingRepair = await storage.getRepair(id);\n      if (!existingRepair) {\n        return res.status(404).json({ message: \"Repair not found\" });\n      }\n\n      // Only ADMIN and AGENT can delete repairs\n      if (![\"ADMIN\", \"AGENT\"].includes(req.user.role)) {\n        return res\n          .status(403)\n          .json({ message: \"Not authorized to delete repairs\" });\n      }\n\n      await storage.deleteRepair(id);\n\n      await storage.createActivity({\n        type: \"repair_deleted\",\n        description: `Deleted repair: ${existingRepair.title}`,\n        userId: req.user.id,\n        metadata: { repairId: id, title: existingRepair.title },\n      });\n\n      await auditLog(req, \"DELETE\", \"repairs\", id, { title: existingRepair.title });\n\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting repair:\", error);\n      res.status(400).json({ message: \"Failed to delete repair\" });\n    }\n  });\n\n  // Upload files (photos/attachments) to a repair\n  app.post(\n    \"/api/repairs/:id/upload\",\n    requireAuth,\n    upload.array(\"files\", 10),\n    async (req: any, res) => {\n      try {\n        const { id } = req.params;\n        const files = req.files as Express.Multer.File[];\n\n        if (!files || files.length === 0) {\n          return res.status(400).json({ message: \"No files provided\" });\n        }\n\n        const repair = await storage.getRepair(id);\n        if (!repair) {\n          return res.status(404).json({ message: \"Repair not found\" });\n        }\n\n        // TECHNICUS can upload to any repair (restriction removed)\n        // if (\n        //   req.user.role === \"TECHNICUS\" &&\n        //   repair.assignedUserId !== req.user.id\n        // ) {\n        //   return res\n        //     .status(403)\n        //     .json({ message: \"Not authorized to upload files to this repair\" });\n        // }\n\n        const objectStorage = new ObjectStorageService();\n        const photoUrls: string[] = [];\n        const attachmentUrls: string[] = [];\n\n        for (const file of files) {\n          // Determine if file is a photo or attachment based on mimetype\n          const isPhoto = file.mimetype.startsWith('image/');\n          const fileType = isPhoto ? 'photo' : 'attachment';\n          \n          // Create a safe filename\n          const timestamp = Date.now();\n          const safeOriginalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');\n          const filename = `repair-${id}-${fileType}-${timestamp}-${safeOriginalName}`;\n          \n          console.log(`Uploading repair file: ${filename} (${file.size} bytes, ${file.mimetype})`);\n          const url = await objectStorage.saveAttachment(\n            filename,\n            file.buffer,\n            file.mimetype,\n          );\n          console.log(`Uploaded to: ${url}`);\n          \n          if (isPhoto) {\n            photoUrls.push(url);\n          } else {\n            attachmentUrls.push(url);\n          }\n        }\n\n        // Update repair with new file URLs\n        const updates: any = {};\n        \n        if (photoUrls.length > 0) {\n          const currentPhotos = repair.photos || [];\n          updates.photos = [...currentPhotos, ...photoUrls];\n        }\n        \n        if (attachmentUrls.length > 0) {\n          const currentAttachments = repair.attachments || [];\n          updates.attachments = [...currentAttachments, ...attachmentUrls];\n        }\n\n        if (Object.keys(updates).length > 0) {\n          await storage.updateRepair(id, updates);\n        }\n\n        console.log(`Successfully uploaded ${photoUrls.length} photos and ${attachmentUrls.length} attachments to repair ${id}`);\n        res.json({ \n          photoUrls, \n          attachmentUrls,\n          total: photoUrls.length + attachmentUrls.length \n        });\n      } catch (error) {\n        console.error(\"Error uploading files to repair:\", error);\n        res.status(500).json({ message: \"Failed to upload files\" });\n      }\n    },\n  );\n\n  // Create sample repairs for testing\n  app.post(\"/api/repairs/create-samples\", async (req, res) => {\n    try {\n      const sampleRepairs = [\n        {\n          title: \"iPhone 12 Screen Replacement\",\n          description:\n            \"Customer dropped device, screen completely shattered. Screen replacement needed.\",\n          status: \"new\" as const,\n          priority: \"high\" as const,\n          estimatedCost: 15000, // ‚Ç¨150.00\n          partsNeeded: [\"iPhone 12 Screen\", \"Screen Adhesive\"],\n          slaDeadline: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000), // 2 days from now\n        },\n        {\n          title: \"MacBook Air M1 Battery Issue\",\n          description:\n            \"Battery not holding charge. Diagnostic required to determine replacement necessity.\",\n          status: \"in_progress\" as const,\n          priority: \"medium\" as const,\n          estimatedCost: 18000, // ‚Ç¨180.00\n          partsNeeded: [\"MacBook Air M1 Battery\"],\n          slaDeadline: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000), // 5 days from now\n        },\n        {\n          title: \"Samsung Galaxy S21 Water Damage\",\n          description:\n            \"Device exposed to water, not powering on. Full diagnostic and cleaning required.\",\n          status: \"waiting_customer\" as const,\n          priority: \"urgent\" as const,\n          estimatedCost: 25000, // ‚Ç¨250.00\n          partsNeeded: [\"Cleaning Kit\", \"Possibly Motherboard\"],\n          slaDeadline: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000), // 1 day from now\n        },\n        {\n          title: \"iPad Pro Charging Port Repair\",\n          description:\n            \"Charging port loose, device charges intermittently. Port replacement needed.\",\n          status: \"ready\" as const,\n          priority: \"medium\" as const,\n          estimatedCost: 8000, // ‚Ç¨80.00\n          partsNeeded: [\"iPad Pro Charging Port\"],\n          slaDeadline: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000), // 3 days from now\n        },\n        {\n          title: \"PS5 Controller Stick Drift\",\n          description:\n            \"Left analog stick drifting, affecting gaming experience. Stick module replacement.\",\n          status: \"closed\" as const,\n          priority: \"low\" as const,\n          estimatedCost: 3500, // ‚Ç¨35.00\n          actualCost: 3500,\n          partsNeeded: [\"PS5 Analog Stick Module\"],\n          completedAt: new Date(),\n        },\n      ];\n\n      let created = 0;\n      const results = [];\n\n      for (const repairData of sampleRepairs) {\n        try {\n          // Validate the data with the schema\n          const validatedData = insertRepairSchema.parse(repairData);\n          await storage.createRepair(validatedData);\n          created++;\n          results.push({ title: repairData.title, ok: true });\n        } catch (error) {\n          console.error(`Error creating repair \"${repairData.title}\":`, error);\n          results.push({\n            title: repairData.title,\n            ok: false,\n            error: error instanceof Error ? error.message : String(error),\n          });\n        }\n      }\n\n      res.json({\n        created,\n        results,\n        message: `Created ${created} sample repairs`,\n      });\n    } catch (error) {\n      console.error(\"Error creating sample repairs:\", error);\n      res.status(500).json({ message: \"Failed to create sample repairs\" });\n    }\n  });\n\n  // Orders\n  app.get(\"/api/orders\", async (req, res) => {\n    try {\n      const { caseId, page, limit, search } = req.query;\n\n      if (caseId) {\n        // Get orders linked to a specific case\n        const relatedItems = await storage.getCaseRelatedItems(\n          caseId as string,\n        );\n        res.json(relatedItems.orders);\n      } else if (page) {\n        // Get paginated orders with total count and optional search\n        const pageNum = parseInt(page as string) || 1;\n        const limitNum = parseInt(limit as string) || 20;\n        const searchQuery = search as string;\n        const result = await storage.getOrdersPaginated(\n          pageNum,\n          limitNum,\n          searchQuery,\n        );\n        res.json(result);\n      } else {\n        // Get all orders with optional limit for dropdowns (default 20 for UI performance)\n        const limitNum = req.query.limit\n          ? parseInt(req.query.limit as string)\n          : 20;\n        const orders = await storage.getOrders(limitNum);\n        res.json(orders);\n      }\n    } catch (error) {\n      console.error(\"Error fetching orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch orders\" });\n    }\n  });\n\n  // Get order statistics (must come before :id route)\n  app.get(\"/api/orders/stats\", async (req, res) => {\n    try {\n      const allOrders = await storage.getOrders(999999); // Get all orders for accurate stats\n\n      // Calculate total amount (sum of all order amounts)\n      const totalAmount = allOrders.reduce(\n        (sum, order) => sum + (order.totalAmount || 0),\n        0,\n      );\n\n      const stats = {\n        total: allOrders.length,\n        totalAmount: totalAmount, // Total monetary amount in cents\n        pending: allOrders.filter((o) => o.status === \"pending\").length,\n        processing: allOrders.filter((o) => o.status === \"processing\").length,\n        shipped: allOrders.filter((o) => o.status === \"shipped\").length,\n        delivered: allOrders.filter((o) => o.status === \"delivered\").length,\n      };\n      res.json(stats);\n    } catch (error) {\n      console.error(\"Error fetching order stats:\", error);\n      res.status(500).json({ message: \"Failed to fetch order stats\" });\n    }\n  });\n\n  app.get(\"/api/orders/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const order = await storage.getOrder(id);\n      if (!order) {\n        return res.status(404).json({ message: \"Order not found\" });\n      }\n      res.json(order);\n    } catch (error) {\n      console.error(\"Error fetching order:\", error);\n      res.status(500).json({ message: \"Failed to fetch order\" });\n    }\n  });\n\n  // Test Shopify connection\n  app.get(\"/api/shopify/test\", async (req, res) => {\n    try {\n      // Try to get shop info first (lighter request)\n      const response = await fetch(\n        `${\n          process.env.SHOPIFY_SHOP_DOMAIN\n            ? `https://${process.env.SHOPIFY_SHOP_DOMAIN.replace(\".myshopify.com\", \"\")}.myshopify.com`\n            : \"https://shambu-nl.myshopify.com\"\n        }/admin/api/2024-01/shop.json`,\n        {\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"X-Shopify-Access-Token\":\n              process.env.SHOPIFY_ACCESS_TOKEN ||\n              process.env.SHOPIFY_PASSWORD ||\n              \"\",\n          },\n        },\n      );\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        return res.status(response.status).json({\n          error: \"Shopify connection failed\",\n          status: response.status,\n          message: errorText,\n          credentials: {\n            hasToken: !!(\n              process.env.SHOPIFY_ACCESS_TOKEN || process.env.SHOPIFY_PASSWORD\n            ),\n            tokenLength: (\n              process.env.SHOPIFY_ACCESS_TOKEN ||\n              process.env.SHOPIFY_PASSWORD ||\n              \"\"\n            ).length,\n            shopDomain:\n              process.env.SHOPIFY_SHOP_DOMAIN || \"shambu-nl.myshopify.com\",\n          },\n        });\n      }\n\n      const shopInfo = await response.json();\n      res.json({\n        success: true,\n        shop: shopInfo.shop?.name || \"Connected\",\n        domain: shopInfo.shop?.myshopify_domain,\n        message: \"Shopify connection successful\",\n      });\n    } catch (error) {\n      console.error(\"Shopify test error:\", error);\n      res.status(500).json({\n        error: \"Shopify test failed\",\n        message: error instanceof Error ? error.message : String(error),\n      });\n    }\n  });\n\n  // Full sync endpoint for importing ALL data from Shopify\n  app.post(\"/api/shopify/sync-all\", async (req, res) => {\n    try {\n      console.log(\n        \"üöÄ Starting full Shopify sync - importing ALL customers and orders...\",\n      );\n\n      let customerStats = {\n        synced: 0,\n        created: 0,\n        updated: 0,\n        skipped: 0,\n        total: 0,\n      };\n      let orderStats = {\n        synced: 0,\n        created: 0,\n        updated: 0,\n        skipped: 0,\n        total: 0,\n      };\n      let errors: string[] = [];\n\n      // Step 1: Sync all customers\n      try {\n        console.log(\"üë• Step 1/2: Syncing all customers from Shopify...\");\n        const shopifyCustomers = await shopifyClient.getAllCustomers(\n          (processed) => {\n            console.log(\n              `üìä Customer sync progress: ${processed} customers processed`,\n            );\n          },\n        );\n\n        console.log(`Processing ${shopifyCustomers.length} customers...`);\n\n        for (const shopifyCustomer of shopifyCustomers) {\n          try {\n            if (!shopifyCustomer.email) {\n              customerStats.skipped++;\n              continue;\n            }\n\n            const existingCustomer = await storage.getCustomerByEmail(\n              shopifyCustomer.email,\n            );\n\n            if (!existingCustomer) {\n              await storage.createCustomer({\n                email: shopifyCustomer.email,\n                firstName: shopifyCustomer.first_name || null,\n                lastName: shopifyCustomer.last_name || null,\n                phone: shopifyCustomer.phone || null,\n                shopifyCustomerId: shopifyCustomer.id.toString(),\n              });\n              customerStats.created++;\n            } else if (\n              !existingCustomer.shopifyCustomerId ||\n              existingCustomer.shopifyCustomerId !==\n                shopifyCustomer.id.toString()\n            ) {\n              await storage.updateCustomer(existingCustomer.id, {\n                shopifyCustomerId: shopifyCustomer.id.toString(),\n                phone: shopifyCustomer.phone || existingCustomer.phone,\n                firstName:\n                  shopifyCustomer.first_name || existingCustomer.firstName,\n                lastName:\n                  shopifyCustomer.last_name || existingCustomer.lastName,\n              });\n              customerStats.updated++;\n            }\n            customerStats.synced++;\n          } catch (customerError) {\n            console.error(\n              `Error processing customer ${shopifyCustomer.id}:`,\n              customerError,\n            );\n            customerStats.skipped++;\n            errors.push(\n              `Customer ${shopifyCustomer.id}: ${customerError instanceof Error ? customerError.message : String(customerError)}`,\n            );\n          }\n        }\n\n        customerStats.total = shopifyCustomers.length;\n        console.log(\n          `‚úÖ Customer sync completed: ${customerStats.created} created, ${customerStats.updated} updated, ${customerStats.skipped} skipped from ${customerStats.total} customers`,\n        );\n      } catch (customerSyncError) {\n        console.error(\"Failed to sync customers:\", customerSyncError);\n        errors.push(\n          `Customer sync failed: ${customerSyncError instanceof Error ? customerSyncError.message : String(customerSyncError)}`,\n        );\n      }\n\n      // Step 2: Sync all orders\n      try {\n        console.log(\"üõí Step 2/2: Syncing all orders from Shopify...\");\n        const shopifyOrders = await shopifyClient.getAllOrders((processed) => {\n          console.log(`üìä Order sync progress: ${processed} orders processed`);\n        });\n\n        console.log(`Processing ${shopifyOrders.length} orders...`);\n\n        // Map Shopify financial status to our enum values\n        const mapShopifyStatus = (\n          financialStatus: string,\n          fulfillmentStatus: string | null,\n        ) => {\n          if (fulfillmentStatus === \"fulfilled\") return \"delivered\";\n          if (fulfillmentStatus === \"partial\") return \"shipped\";\n          if (financialStatus === \"paid\" || financialStatus === \"authorized\") {\n            return fulfillmentStatus === null ? \"processing\" : \"shipped\";\n          }\n          if (financialStatus === \"pending\") return \"pending\";\n          if (financialStatus === \"refunded\") return \"refunded\";\n          if (financialStatus === \"voided\") return \"cancelled\";\n          return \"pending\";\n        };\n\n        for (const shopifyOrder of shopifyOrders) {\n          try {\n            const existingOrder = await storage.getOrderByShopifyId(\n              shopifyOrder.id.toString(),\n            );\n\n            // Handle customer creation/updating first\n            let customer = null;\n            if (shopifyOrder.customer && shopifyOrder.customer.email) {\n              customer = await storage.getCustomerByEmail(\n                shopifyOrder.customer.email,\n              );\n              if (!customer) {\n                try {\n                  customer = await storage.createCustomer({\n                    email: shopifyOrder.customer.email,\n                    firstName: shopifyOrder.customer.first_name,\n                    lastName: shopifyOrder.customer.last_name,\n                    shopifyCustomerId: shopifyOrder.customer.id.toString(),\n                  });\n                } catch (customerError) {\n                  // If customer creation fails due to duplicate, try to get existing customer\n                  console.log(\n                    `Customer creation failed, attempting to get existing customer: ${shopifyOrder.customer.email}`,\n                  );\n                  customer = await storage.getCustomerByEmail(\n                    shopifyOrder.customer.email,\n                  );\n                }\n              } else if (\n                !customer.shopifyCustomerId ||\n                customer.shopifyCustomerId !==\n                  shopifyOrder.customer.id.toString()\n              ) {\n                // Update existing customer with Shopify ID and any missing data\n                try {\n                  await storage.updateCustomer(customer.id, {\n                    shopifyCustomerId: shopifyOrder.customer.id.toString(),\n                    firstName:\n                      shopifyOrder.customer.first_name || customer.firstName,\n                    lastName:\n                      shopifyOrder.customer.last_name || customer.lastName,\n                  });\n                } catch (updateError) {\n                  console.log(\n                    `Customer update failed: ${updateError instanceof Error ? updateError.message : updateError}`,\n                  );\n                }\n              }\n            }\n\n            if (!existingOrder) {\n              try {\n                await storage.createOrder({\n                  shopifyOrderId: shopifyOrder.id.toString(),\n                  orderNumber: shopifyOrder.name,\n                  customerId: customer?.id,\n                  customerEmail: shopifyOrder.email,\n                  totalAmount: Math.round(\n                    parseFloat(shopifyOrder.total_price) * 100,\n                  ),\n                  currency: shopifyOrder.currency,\n                  status: mapShopifyStatus(\n                    shopifyOrder.financial_status,\n                    shopifyOrder.fulfillment_status,\n                  ),\n                  fulfillmentStatus: shopifyOrder.fulfillment_status,\n                  paymentStatus: shopifyOrder.financial_status,\n                  orderData: shopifyOrder,\n                  orderDate: new Date(shopifyOrder.created_at),\n                });\n                orderStats.created++;\n              } catch (createError) {\n                console.error(\n                  `Failed to create order ${shopifyOrder.id}: ${createError instanceof Error ? createError.message : createError}`,\n                );\n                orderStats.skipped++;\n                errors.push(\n                  `Order ${shopifyOrder.id}: Failed to create - ${createError instanceof Error ? createError.message : String(createError)}`,\n                );\n                continue;\n              }\n            } else {\n              try {\n                await storage.updateOrder(existingOrder.id, {\n                  status: mapShopifyStatus(\n                    shopifyOrder.financial_status,\n                    shopifyOrder.fulfillment_status,\n                  ),\n                  fulfillmentStatus: shopifyOrder.fulfillment_status,\n                  paymentStatus: shopifyOrder.financial_status,\n                  orderData: shopifyOrder,\n                  totalAmount: Math.round(\n                    parseFloat(shopifyOrder.total_price) * 100,\n                  ),\n                });\n                orderStats.updated++;\n              } catch (updateError) {\n                console.error(\n                  `Failed to update order ${shopifyOrder.id}: ${updateError instanceof Error ? updateError.message : updateError}`,\n                );\n                orderStats.skipped++;\n                errors.push(\n                  `Order ${shopifyOrder.id}: Failed to update - ${updateError instanceof Error ? updateError.message : String(updateError)}`,\n                );\n                continue;\n              }\n            }\n            orderStats.synced++;\n          } catch (orderError) {\n            console.error(\n              `Error processing order ${shopifyOrder.id}:`,\n              orderError,\n            );\n            orderStats.skipped++;\n            errors.push(\n              `Order ${shopifyOrder.id}: ${orderError instanceof Error ? orderError.message : String(orderError)}`,\n            );\n          }\n        }\n\n        orderStats.total = shopifyOrders.length;\n        console.log(\n          `‚úÖ Order sync completed: ${orderStats.created} created, ${orderStats.updated} updated, ${orderStats.skipped} skipped from ${orderStats.total} orders`,\n        );\n      } catch (orderSyncError) {\n        console.error(\"Failed to sync orders:\", orderSyncError);\n        errors.push(\n          `Order sync failed: ${orderSyncError instanceof Error ? orderSyncError.message : String(orderSyncError)}`,\n        );\n      }\n\n      const totalTime = Date.now();\n      console.log(\n        `üéâ Full Shopify sync completed! Customer: ${customerStats.created + customerStats.updated} processed, Orders: ${orderStats.created + orderStats.updated} processed`,\n      );\n\n      res.json({\n        success: true,\n        customers: customerStats,\n        orders: orderStats,\n        errors: errors.length > 0 ? errors.slice(0, 10) : [], // Limit error messages\n        totalErrors: errors.length,\n        message: `Full sync completed: ${customerStats.total} customers and ${orderStats.total} orders processed from Shopify`,\n      });\n    } catch (error) {\n      console.error(\"Full Shopify sync failed:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Full sync failed\",\n        message: error instanceof Error ? error.message : String(error),\n      });\n    }\n  });\n\n  // Incremental sync endpoint - Uses date-based syncing to avoid gaps\n  app.post(\"/api/shopify/sync-incremental\", async (req, res) => {\n    try {\n      console.log(\"üîÑ Starting incremental Shopify sync (date-based)...\");\n\n      const LAST_SYNC_KEY = \"shopify_last_order_sync_timestamp\";\n      \n      // Get the last sync timestamp from system settings\n      const lastSyncStr = await storage.getSystemSetting(LAST_SYNC_KEY);\n      let lastSyncDate: Date;\n      \n      if (lastSyncStr) {\n        lastSyncDate = new Date(lastSyncStr);\n        console.log(`üìÖ Last sync was at: ${lastSyncDate.toISOString()}`);\n      } else {\n        // If no previous sync, default to 90 days ago to avoid overwhelming initial sync\n        lastSyncDate = new Date();\n        lastSyncDate.setDate(lastSyncDate.getDate() - 90);\n        console.log(`üìÖ No previous sync found, syncing from: ${lastSyncDate.toISOString()}`);\n      }\n\n      const syncStartTime = new Date(); // Record when this sync started\n      \n      let orderStats = {\n        synced: 0,\n        created: 0,\n        updated: 0,\n        skipped: 0,\n        total: 0,\n      };\n      let errors: string[] = [];\n\n      try {\n        console.log(\"üõí Fetching orders from Shopify...\");\n        const shopifyOrders = await shopifyClient.getOrdersSinceDate(\n          lastSyncDate,\n          (processed) => {\n            console.log(`üìä Order sync progress: ${processed} orders processed`);\n          }\n        );\n\n        console.log(`Processing ${shopifyOrders.length} orders...`);\n\n        // Map Shopify financial status to our enum values\n        const mapShopifyStatus = (\n          financialStatus: string,\n          fulfillmentStatus: string | null,\n        ) => {\n          if (fulfillmentStatus === \"fulfilled\") return \"delivered\";\n          if (fulfillmentStatus === \"partial\") return \"shipped\";\n          if (financialStatus === \"paid\" || financialStatus === \"authorized\") {\n            return fulfillmentStatus === null ? \"processing\" : \"shipped\";\n          }\n          if (financialStatus === \"pending\") return \"pending\";\n          if (financialStatus === \"refunded\") return \"refunded\";\n          if (financialStatus === \"voided\") return \"cancelled\";\n          return \"pending\";\n        };\n\n        for (const shopifyOrder of shopifyOrders) {\n          try {\n            const existingOrder = await storage.getOrderByShopifyId(\n              shopifyOrder.id.toString(),\n            );\n\n            // Handle customer creation/updating first\n            let customer = null;\n            if (shopifyOrder.customer && shopifyOrder.customer.email) {\n              customer = await storage.getCustomerByEmail(\n                shopifyOrder.customer.email,\n              );\n              if (!customer) {\n                try {\n                  customer = await storage.createCustomer({\n                    email: shopifyOrder.customer.email,\n                    firstName: shopifyOrder.customer.first_name,\n                    lastName: shopifyOrder.customer.last_name,\n                    shopifyCustomerId: shopifyOrder.customer.id.toString(),\n                  });\n                } catch (customerError) {\n                  console.log(\n                    `Customer creation failed, attempting to get existing customer: ${shopifyOrder.customer.email}`,\n                  );\n                  customer = await storage.getCustomerByEmail(\n                    shopifyOrder.customer.email,\n                  );\n                }\n              } else if (\n                !customer.shopifyCustomerId ||\n                customer.shopifyCustomerId !==\n                  shopifyOrder.customer.id.toString()\n              ) {\n                try {\n                  await storage.updateCustomer(customer.id, {\n                    shopifyCustomerId: shopifyOrder.customer.id.toString(),\n                    firstName:\n                      shopifyOrder.customer.first_name || customer.firstName,\n                    lastName:\n                      shopifyOrder.customer.last_name || customer.lastName,\n                  });\n                } catch (updateError) {\n                  console.log(\n                    `Customer update failed: ${updateError instanceof Error ? updateError.message : updateError}`,\n                  );\n                }\n              }\n            }\n\n            if (!existingOrder) {\n              try {\n                await storage.createOrder({\n                  shopifyOrderId: shopifyOrder.id.toString(),\n                  orderNumber: shopifyOrder.name,\n                  customerId: customer?.id,\n                  customerEmail: shopifyOrder.email,\n                  totalAmount: Math.round(\n                    parseFloat(shopifyOrder.total_price) * 100,\n                  ),\n                  currency: shopifyOrder.currency,\n                  status: mapShopifyStatus(\n                    shopifyOrder.financial_status,\n                    shopifyOrder.fulfillment_status,\n                  ),\n                  fulfillmentStatus: shopifyOrder.fulfillment_status,\n                  paymentStatus: shopifyOrder.financial_status,\n                  orderData: shopifyOrder,\n                  orderDate: new Date(shopifyOrder.created_at),\n                });\n                orderStats.created++;\n              } catch (createError) {\n                console.error(\n                  `Failed to create order ${shopifyOrder.id}: ${createError instanceof Error ? createError.message : createError}`,\n                );\n                orderStats.skipped++;\n                errors.push(\n                  `Order ${shopifyOrder.id}: Failed to create - ${createError instanceof Error ? createError.message : String(createError)}`,\n                );\n                continue;\n              }\n            } else {\n              try {\n                await storage.updateOrder(existingOrder.id, {\n                  status: mapShopifyStatus(\n                    shopifyOrder.financial_status,\n                    shopifyOrder.fulfillment_status,\n                  ),\n                  fulfillmentStatus: shopifyOrder.fulfillment_status,\n                  paymentStatus: shopifyOrder.financial_status,\n                  orderData: shopifyOrder,\n                  totalAmount: Math.round(\n                    parseFloat(shopifyOrder.total_price) * 100,\n                  ),\n                });\n                orderStats.updated++;\n              } catch (updateError) {\n                console.error(\n                  `Failed to update order ${shopifyOrder.id}: ${updateError instanceof Error ? updateError.message : updateError}`,\n                );\n                orderStats.skipped++;\n                errors.push(\n                  `Order ${shopifyOrder.id}: Failed to update - ${updateError instanceof Error ? updateError.message : String(updateError)}`,\n                );\n                continue;\n              }\n            }\n            orderStats.synced++;\n          } catch (orderError) {\n            console.error(\n              `Error processing order ${shopifyOrder.id}:`,\n              orderError,\n            );\n            orderStats.skipped++;\n            errors.push(\n              `Order ${shopifyOrder.id}: ${orderError instanceof Error ? orderError.message : String(orderError)}`,\n            );\n          }\n        }\n\n        orderStats.total = shopifyOrders.length;\n        \n        // Only update the last sync timestamp if the sync completed successfully\n        await storage.setSystemSetting(LAST_SYNC_KEY, syncStartTime.toISOString());\n        \n        console.log(\n          `‚úÖ Incremental order sync completed: ${orderStats.created} created, ${orderStats.updated} updated, ${orderStats.skipped} skipped from ${orderStats.total} orders`,\n        );\n        console.log(`üìÖ Updated last sync timestamp to: ${syncStartTime.toISOString()}`);\n      } catch (orderSyncError) {\n        console.error(\"Failed to sync orders:\", orderSyncError);\n        errors.push(\n          `Order sync failed: ${orderSyncError instanceof Error ? orderSyncError.message : String(orderSyncError)}`,\n        );\n        \n        // Don't update the timestamp if sync failed - this ensures we retry from the same point\n        return res.status(500).json({\n          success: false,\n          error: \"Incremental sync failed\",\n          message: orderSyncError instanceof Error ? orderSyncError.message : String(orderSyncError),\n          orders: orderStats,\n          errors: errors.length > 0 ? errors.slice(0, 10) : [],\n        });\n      }\n\n      console.log(\"üéâ Incremental Shopify sync completed!\");\n\n      res.json({\n        success: true,\n        orders: orderStats,\n        errors: errors.length > 0 ? errors.slice(0, 10) : [],\n        totalErrors: errors.length,\n        lastSyncTimestamp: syncStartTime.toISOString(),\n        message: `Incremental sync completed: ${orderStats.total} orders processed from Shopify since ${lastSyncDate.toISOString()}`,\n      });\n    } catch (error) {\n      console.error(\"Incremental Shopify sync failed:\", error);\n      res.status(500).json({\n        success: false,\n        error: \"Incremental sync failed\",\n        message: error instanceof Error ? error.message : String(error),\n      });\n    }\n  });\n\n  // Sync customers from Shopify - Enhanced with bulk import\n  app.post(\"/api/customers/sync\", async (req, res) => {\n    try {\n      const { fullSync } = req.query;\n      let shopifyCustomers;\n\n      if (fullSync === \"true\") {\n        console.log(\"üîÑ Starting full customer sync from Shopify...\");\n        shopifyCustomers = await shopifyClient.getAllCustomers((processed) => {\n          console.log(\n            `üìä Customer sync progress: ${processed} customers processed`,\n          );\n        });\n      } else {\n        console.log(\"üîÑ Starting incremental customer sync from Shopify...\");\n        shopifyCustomers = await shopifyClient.getCustomers({ limit: 250 });\n      }\n\n      let synced = 0;\n      let created = 0;\n      let updated = 0;\n      let skipped = 0;\n\n      console.log(`Processing ${shopifyCustomers.length} customers...`);\n\n      for (const shopifyCustomer of shopifyCustomers) {\n        if (!shopifyCustomer.email) {\n          skipped++;\n          continue; // Skip customers without email\n        }\n\n        const existingCustomer = await storage.getCustomerByEmail(\n          shopifyCustomer.email,\n        );\n\n        if (!existingCustomer) {\n          // Create new customer\n          await storage.createCustomer({\n            email: shopifyCustomer.email,\n            firstName: shopifyCustomer.first_name || null,\n            lastName: shopifyCustomer.last_name || null,\n            phone: shopifyCustomer.phone || null,\n            shopifyCustomerId: shopifyCustomer.id.toString(),\n          });\n          created++;\n        } else if (\n          !existingCustomer.shopifyCustomerId ||\n          existingCustomer.shopifyCustomerId !== shopifyCustomer.id.toString()\n        ) {\n          // Update existing customer with Shopify ID if missing\n          await storage.updateCustomer(existingCustomer.id, {\n            shopifyCustomerId: shopifyCustomer.id.toString(),\n            phone: shopifyCustomer.phone || existingCustomer.phone,\n            firstName: shopifyCustomer.first_name || existingCustomer.firstName,\n            lastName: shopifyCustomer.last_name || existingCustomer.lastName,\n          });\n          updated++;\n        }\n        synced++;\n      }\n\n      console.log(\n        `‚úÖ Customer sync completed: ${created} created, ${updated} updated, ${skipped} skipped from ${shopifyCustomers.length} Shopify customers`,\n      );\n\n      res.json({\n        synced,\n        created,\n        updated,\n        skipped,\n        total: shopifyCustomers.length,\n        message: `Customer sync completed: ${created} created, ${updated} updated, ${skipped} skipped from ${shopifyCustomers.length} Shopify customers`,\n      });\n    } catch (error) {\n      console.error(\"Error syncing customers from Shopify:\", error);\n      res\n        .status(500)\n        .json({\n          message: \"Failed to sync customers from Shopify\",\n          error: error instanceof Error ? error.message : String(error),\n        });\n    }\n  });\n\n  // Sync orders from Shopify - Enhanced with bulk import\n  app.post(\"/api/orders/sync\", async (req, res) => {\n    try {\n      const { fullSync } = req.query;\n      let shopifyOrders;\n\n      if (fullSync === \"true\") {\n        console.log(\"üîÑ Starting full order sync from Shopify...\");\n        shopifyOrders = await shopifyClient.getAllOrders((processed) => {\n          console.log(`üìä Order sync progress: ${processed} orders processed`);\n        });\n      } else {\n        console.log(\"üîÑ Starting incremental order sync from Shopify...\");\n        shopifyOrders = await shopifyClient.getOrders({ limit: 250 });\n      }\n\n      let synced = 0;\n      let created = 0;\n      let updated = 0;\n      let skipped = 0;\n\n      console.log(`Processing ${shopifyOrders.length} orders...`);\n\n      // Map Shopify financial status to our enum values\n      const mapShopifyStatus = (\n        financialStatus: string,\n        fulfillmentStatus: string | null,\n      ) => {\n        if (fulfillmentStatus === \"fulfilled\") return \"delivered\";\n        if (fulfillmentStatus === \"partial\") return \"shipped\";\n        if (financialStatus === \"paid\" || financialStatus === \"authorized\") {\n          return fulfillmentStatus === null ? \"processing\" : \"shipped\";\n        }\n        if (financialStatus === \"pending\") return \"pending\";\n        if (financialStatus === \"refunded\") return \"refunded\";\n        if (financialStatus === \"voided\") return \"cancelled\";\n        return \"pending\"; // default fallback\n      };\n\n      for (const shopifyOrder of shopifyOrders) {\n        try {\n          const existingOrder = await storage.getOrderByShopifyId(\n            shopifyOrder.id.toString(),\n          );\n\n          if (!existingOrder) {\n            // Create customer if doesn't exist\n            let customer = null;\n            if (shopifyOrder.customer && shopifyOrder.customer.email) {\n              customer = await storage.getCustomerByEmail(\n                shopifyOrder.customer.email,\n              );\n              if (!customer) {\n                customer = await storage.createCustomer({\n                  email: shopifyOrder.customer.email,\n                  firstName: shopifyOrder.customer.first_name,\n                  lastName: shopifyOrder.customer.last_name,\n                  shopifyCustomerId: shopifyOrder.customer.id.toString(),\n                });\n              }\n            }\n\n            // Create order\n            await storage.createOrder({\n              shopifyOrderId: shopifyOrder.id.toString(),\n              orderNumber: shopifyOrder.order_number,\n              customerId: customer?.id,\n              customerEmail: shopifyOrder.email,\n              totalAmount: Math.round(\n                parseFloat(shopifyOrder.total_price) * 100,\n              ),\n              currency: shopifyOrder.currency,\n              status: mapShopifyStatus(\n                shopifyOrder.financial_status,\n                shopifyOrder.fulfillment_status,\n              ),\n              fulfillmentStatus: shopifyOrder.fulfillment_status,\n              paymentStatus: shopifyOrder.financial_status,\n              orderData: shopifyOrder,\n            });\n            created++;\n          } else {\n            // Update existing order with latest data from Shopify\n            await storage.updateOrder(existingOrder.id, {\n              status: mapShopifyStatus(\n                shopifyOrder.financial_status,\n                shopifyOrder.fulfillment_status,\n              ),\n              fulfillmentStatus: shopifyOrder.fulfillment_status,\n              paymentStatus: shopifyOrder.financial_status,\n              orderData: shopifyOrder,\n              totalAmount: Math.round(\n                parseFloat(shopifyOrder.total_price) * 100,\n              ),\n            });\n            updated++;\n          }\n          synced++;\n        } catch (orderError) {\n          console.error(\n            `Error processing order ${shopifyOrder.id}:`,\n            orderError,\n          );\n          skipped++;\n        }\n      }\n\n      console.log(\n        `‚úÖ Order sync completed: ${created} created, ${updated} updated, ${skipped} skipped from ${shopifyOrders.length} Shopify orders`,\n      );\n\n      res.json({\n        synced,\n        created,\n        updated,\n        skipped,\n        total: shopifyOrders.length,\n        message: `Order sync completed: ${created} created, ${updated} updated, ${skipped} skipped from ${shopifyOrders.length} Shopify orders`,\n      });\n    } catch (error) {\n      console.error(\"Error syncing orders:\", error);\n      res\n        .status(500)\n        .json({\n          message: \"Failed to sync orders\",\n          error: error instanceof Error ? error.message : String(error),\n        });\n    }\n  });\n\n  // CSV Import endpoint for orders (ADMIN only)\n  app.post(\n    \"/api/orders/import-csv\",\n    requireAuth,\n    requireRole([\"ADMIN\"]),\n    upload.single(\"file\"),\n    async (req: any, res: any) => {\n      try {\n        if (!req.file) {\n          return res.status(400).json({ error: \"No file uploaded\" });\n        }\n\n        console.log(\"üìÇ Starting CSV import...\");\n        const csvContent = req.file.buffer.toString(\"utf-8\");\n\n        // Parse CSV\n        const parseResult = Papa.parse(csvContent, {\n          header: true,\n          skipEmptyLines: true,\n          transformHeader: (header: string) => header.trim(),\n        });\n\n        if (parseResult.errors.length > 0) {\n          console.error(\"CSV parsing errors:\", parseResult.errors);\n          return res.status(400).json({\n            error: \"CSV parsing failed\",\n            details: parseResult.errors.slice(0, 5),\n          });\n        }\n\n        const rows = parseResult.data as any[];\n        console.log(`üìä Parsed ${rows.length} rows from CSV`);\n\n        // Group rows by order number (Name column contains order number like #8546)\n        const orderGroups = new Map<string, any[]>();\n        for (const row of rows) {\n          const orderNumber = row[\"Name\"]?.toString().trim();\n          if (!orderNumber) continue;\n\n          if (!orderGroups.has(orderNumber)) {\n            orderGroups.set(orderNumber, []);\n          }\n          orderGroups.get(orderNumber)!.push(row);\n        }\n\n        console.log(`üì¶ Found ${orderGroups.size} unique orders`);\n\n        let stats = {\n          processed: 0,\n          created: 0,\n          updated: 0,\n          skipped: 0,\n          errors: [] as string[],\n        };\n\n        // Map CSV status to our enum\n        const mapCSVStatus = (\n          financialStatus: string,\n          fulfillmentStatus: string,\n        ):\n          | \"pending\"\n          | \"processing\"\n          | \"shipped\"\n          | \"delivered\"\n          | \"cancelled\"\n          | \"refunded\" => {\n          const financial = financialStatus?.toLowerCase() || \"\";\n          const fulfillment = fulfillmentStatus?.toLowerCase() || \"\";\n\n          if (fulfillment === \"fulfilled\") return \"delivered\";\n          if (fulfillment === \"partial\") return \"shipped\";\n          if (financial === \"paid\" || financial === \"authorized\") {\n            return fulfillment === \"unfulfilled\" || !fulfillment\n              ? \"processing\"\n              : \"shipped\";\n          }\n          if (financial === \"pending\") return \"pending\";\n          if (financial === \"refunded\" || financial === \"partially_refunded\")\n            return \"refunded\";\n          if (financial === \"voided\") return \"cancelled\";\n          return \"pending\";\n        };\n\n        // Process each order\n        for (const [orderNumber, orderRows] of Array.from(\n          orderGroups.entries(),\n        )) {\n          try {\n            // Use first row for order-level data\n            const firstRow = orderRows[0];\n            const email = firstRow[\"Email\"]?.toString().trim();\n\n            if (!email) {\n              stats.skipped++;\n              stats.errors.push(`Order ${orderNumber}: No email address`);\n              continue;\n            }\n\n            // Parse amounts (handle both formats: \"19.48\" and \"19,48\")\n            const parseAmount = (value: string) => {\n              if (!value) return 0;\n              const cleaned = value.toString().replace(\",\", \".\");\n              const parsed = parseFloat(cleaned);\n              return isNaN(parsed) ? 0 : Math.round(parsed * 100); // Convert to cents\n            };\n\n            const total = parseAmount(firstRow[\"Total\"] || \"0\");\n            const subtotal = parseAmount(firstRow[\"Subtotal\"] || \"0\");\n            const shipping = parseAmount(firstRow[\"Shipping\"] || \"0\");\n            const currency = firstRow[\"Currency\"]?.toString().trim() || \"EUR\";\n\n            const financialStatus =\n              firstRow[\"Financial Status\"]?.toString().trim() || \"\";\n            const fulfillmentStatus =\n              firstRow[\"Fulfillment Status\"]?.toString().trim() || \"\";\n            const createdAt = firstRow[\"Created at\"]?.toString().trim() || \"\";\n\n            // Extract customer info\n            const billingName =\n              firstRow[\"Billing Name\"]?.toString().trim() || \"\";\n            const nameParts = billingName.split(\" \");\n            const firstName = nameParts[0] || null;\n            const lastName = nameParts.slice(1).join(\" \") || null;\n            const phone = firstRow[\"Billing Phone\"]?.toString().trim() || null;\n\n            // Create or get customer\n            let customer = await storage.getCustomerByEmail(email);\n            if (!customer) {\n              customer = await storage.createCustomer({\n                email,\n                firstName,\n                lastName,\n                phone,\n              });\n            }\n\n            // Check if order already exists by order number\n            const existingOrder =\n              await storage.getOrderByOrderNumber(orderNumber);\n\n            // Collect line items from all rows for this order\n            const lineItems = orderRows\n              .filter((row: any) => row[\"Lineitem name\"])\n              .map((row: any) => ({\n                name: row[\"Lineitem name\"],\n                quantity: parseInt(row[\"Lineitem quantity\"] || \"1\"),\n                price: row[\"Lineitem price\"],\n                sku: row[\"Lineitem sku\"],\n              }));\n\n            const orderData = {\n              shopifyOrderId: orderNumber, // Use order number as Shopify ID for CSV imports\n              orderNumber: orderNumber.replace(\"#\", \"\"), // Remove # prefix\n              customerId: customer.id,\n              customerEmail: email,\n              totalAmount: total,\n              currency,\n              status: mapCSVStatus(financialStatus, fulfillmentStatus),\n              fulfillmentStatus: fulfillmentStatus || null,\n              paymentStatus: financialStatus || null,\n              orderData: {\n                csv_import: true,\n                billing_name: billingName,\n                subtotal,\n                shipping,\n                created_at: createdAt,\n                line_items: lineItems,\n                billing_address: {\n                  name: billingName,\n                  address1: firstRow[\"Billing Address1\"],\n                  city: firstRow[\"Billing City\"],\n                  zip: firstRow[\"Billing Zip\"],\n                  country: firstRow[\"Billing Country\"],\n                },\n                shipping_address: {\n                  name: firstRow[\"Shipping Name\"],\n                  address1: firstRow[\"Shipping Address1\"],\n                  city: firstRow[\"Shipping City\"],\n                  zip: firstRow[\"Shipping Zip\"],\n                  country: firstRow[\"Shipping Country\"],\n                },\n              },\n            };\n\n            if (!existingOrder) {\n              await storage.createOrder(orderData);\n              stats.created++;\n            } else {\n              await storage.updateOrder(existingOrder.id, orderData);\n              stats.updated++;\n            }\n\n            stats.processed++;\n          } catch (orderError) {\n            console.error(`Error processing order ${orderNumber}:`, orderError);\n            stats.skipped++;\n            stats.errors.push(\n              `Order ${orderNumber}: ${orderError instanceof Error ? orderError.message : String(orderError)}`,\n            );\n          }\n        }\n\n        console.log(\n          `‚úÖ CSV import completed: ${stats.created} created, ${stats.updated} updated, ${stats.skipped} skipped`,\n        );\n\n        res.json({\n          success: true,\n          processed: stats.processed,\n          created: stats.created,\n          updated: stats.updated,\n          skipped: stats.skipped,\n          errors: stats.errors.slice(0, 10), // Limit error messages\n          totalErrors: stats.errors.length,\n          message: `CSV import completed: ${stats.created} created, ${stats.updated} updated, ${stats.skipped} skipped from ${orderGroups.size} orders`,\n        });\n      } catch (error) {\n        console.error(\"CSV import failed:\", error);\n        res.status(500).json({\n          error: \"CSV import failed\",\n          message: error instanceof Error ? error.message : String(error),\n        });\n      }\n    },\n  );\n\n  // Create sample orders for testing (temporary until Shopify sync works)\n  app.post(\"/api/orders/create-samples\", async (req, res) => {\n    try {\n      const sampleOrders = [\n        {\n          shopifyOrderId: \"5506048598246\",\n          orderNumber: \"1001\",\n          customerEmail: \"john.doe@example.com\",\n          totalAmount: 15999, // ‚Ç¨159.99\n          currency: \"EUR\",\n          status: \"delivered\" as const,\n          fulfillmentStatus: \"shipped\",\n          paymentStatus: \"paid\",\n          orderData: {\n            id: 5506048598246,\n            created_at: \"2024-09-10T10:30:00Z\",\n            line_items: [\n              { title: \"iPhone 12 Pro - 128GB\", quantity: 1, price: \"159.99\" },\n            ],\n          },\n        },\n        {\n          shopifyOrderId: \"5506048598247\",\n          orderNumber: \"1002\",\n          customerEmail: \"marie.smith@example.com\",\n          totalAmount: 8999, // ‚Ç¨89.99\n          currency: \"EUR\",\n          status: \"pending\" as const,\n          fulfillmentStatus: \"pending\",\n          paymentStatus: \"pending\",\n          orderData: {\n            id: 5506048598247,\n            created_at: \"2024-09-10T14:15:00Z\",\n            line_items: [\n              {\n                title: \"Samsung Galaxy S21 - 64GB\",\n                quantity: 1,\n                price: \"89.99\",\n              },\n            ],\n          },\n        },\n        {\n          shopifyOrderId: \"5506048598248\",\n          orderNumber: \"1003\",\n          customerEmail: \"david.wilson@example.com\",\n          totalAmount: 25000, // ‚Ç¨250.00\n          currency: \"EUR\",\n          status: \"shipped\" as const,\n          fulfillmentStatus: \"delivered\",\n          paymentStatus: \"paid\",\n          orderData: {\n            id: 5506048598248,\n            created_at: \"2024-09-09T09:00:00Z\",\n            line_items: [\n              { title: \"MacBook Air M1 - 256GB\", quantity: 1, price: \"250.00\" },\n            ],\n          },\n        },\n      ];\n\n      let created = 0;\n      for (const orderData of sampleOrders) {\n        const existingOrder = await storage.getOrderByShopifyId(\n          orderData.shopifyOrderId,\n        );\n        if (!existingOrder) {\n          // Create customer if doesn't exist\n          let customer = await storage.getCustomerByEmail(\n            orderData.customerEmail,\n          );\n          if (!customer) {\n            const [firstName, lastName] = orderData.customerEmail\n              .split(\"@\")[0]\n              .split(\".\");\n            customer = await storage.createCustomer({\n              email: orderData.customerEmail,\n              firstName:\n                firstName?.charAt(0).toUpperCase() + firstName?.slice(1),\n              lastName: lastName?.charAt(0).toUpperCase() + lastName?.slice(1),\n              shopifyCustomerId: `customer_${orderData.shopifyOrderId}`,\n            });\n          }\n\n          await storage.createOrder({\n            ...orderData,\n            customerId: customer.id,\n          });\n          created++;\n        }\n      }\n\n      res.json({ created, message: `Created ${created} sample orders` });\n    } catch (error) {\n      console.error(\"Error creating sample orders:\", error);\n      res.status(500).json({ message: \"Failed to create sample orders\" });\n    }\n  });\n\n  // Email threads with filtering\n  app.get(\"/api/email-threads\", async (req, res) => {\n    try {\n      const { caseId, folder, starred, archived, isUnread, hasOrder, limit } =\n        req.query;\n\n      if (caseId) {\n        // Get email threads linked to a specific case\n        const relatedItems = await storage.getCaseRelatedItems(\n          caseId as string,\n        );\n        res.json(relatedItems.emails);\n      } else {\n        // Get email threads with database-level filtering\n        const threads = await storage.getEmailThreads({\n          limit: limit ? parseInt(limit as string) : undefined,\n          folder: folder as string,\n          starred:\n            starred === \"true\" ? true : starred === \"false\" ? false : undefined,\n          archived:\n            archived === \"true\"\n              ? true\n              : archived === \"false\"\n                ? false\n                : undefined,\n          isUnread:\n            isUnread === \"true\"\n              ? true\n              : isUnread === \"false\"\n                ? false\n                : undefined,\n          hasOrder:\n            hasOrder === \"true\"\n              ? true\n              : hasOrder === \"false\"\n                ? false\n                : undefined,\n        });\n\n        res.json(threads);\n      }\n    } catch (error) {\n      console.error(\"Error fetching email threads:\", error);\n      res.status(500).json({ message: \"Failed to fetch email threads\" });\n    }\n  });\n\n  // Match orders for existing email threads that don't have orders linked\n  app.post(\"/api/email-threads/match-orders\", async (req, res) => {\n    try {\n      console.log(`üîÑ POST /api/email-threads/match-orders endpoint called`);\n      console.log(`üîÑ Starting order matching for existing email threads...`);\n\n      // Get all threads that don't have orders linked\n      const threads = await storage.getEmailThreads();\n      const threadsWithoutOrders = threads.filter((thread) => !thread.orderId);\n\n      console.log(\n        `üìä Found ${threadsWithoutOrders.length} threads without orders to process`,\n      );\n\n      let matchedCount = 0;\n      let processedCount = 0;\n\n      for (const thread of threadsWithoutOrders) {\n        processedCount++;\n        console.log(\n          `üîç Processing thread ${processedCount}/${threadsWithoutOrders.length}: \"${thread.subject}\" from ${thread.customerEmail}`,\n        );\n\n        try {\n          // Try to match order using thread subject and customer email\n          const matchedOrder = await orderMatchingService.getOrderForAutoLink(\n            \"\", // no body content for existing threads\n            thread.customerEmail || \"\",\n            thread.subject || \"\",\n          );\n\n          if (matchedOrder) {\n            console.log(\n              `üéØ MATCHED: Order ${matchedOrder.orderNumber} (ID: ${matchedOrder.id}) for thread \"${thread.subject}\" from ${thread.customerEmail}`,\n            );\n\n            // Update the thread with the matched order\n            await storage.updateEmailThread(thread.id, {\n              orderId: matchedOrder.id,\n            });\n\n            matchedCount++;\n          } else {\n            console.log(\n              `üîç NO MATCH: No order found for thread \"${thread.subject}\" from ${thread.customerEmail}`,\n            );\n          }\n        } catch (matchingError) {\n          console.error(\n            `‚ùå Error matching order for thread ${thread.id}:`,\n            matchingError,\n          );\n        }\n      }\n\n      console.log(\n        `‚úÖ Order matching completed: ${matchedCount}/${processedCount} threads matched with orders`,\n      );\n\n      res.json({\n        processed: processedCount,\n        matched: matchedCount,\n        message: `Successfully processed ${processedCount} threads, matched ${matchedCount} with orders`,\n      });\n    } catch (error) {\n      console.error(\"‚ùå Error in match-orders endpoint:\", error);\n      res\n        .status(500)\n        .json({ message: \"Failed to match orders for existing threads\" });\n    }\n  });\n\n  app.get(\"/api/email-threads/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const thread = await storage.getEmailThread(id);\n      if (!thread) {\n        return res.status(404).json({ message: \"Email thread not found\" });\n      }\n\n      const messages = await storage.getEmailMessages(id);\n      res.json({ ...thread, messages });\n    } catch (error) {\n      console.error(\"Error fetching email thread:\", error);\n      res.status(500).json({ message: \"Failed to fetch email thread\" });\n    }\n  });\n\n  // Sync emails\n  app.post(\"/api/emails/sync\", async (req, res) => {\n    try {\n      console.log(`üöÄ Starting email sync...`);\n      const emails = await syncEmails();\n      console.log(`üì¨ Received ${emails.length} emails from IMAP provider`);\n\n      // Process and store emails\n      let processedCount = 0;\n      for (const email of emails) {\n        processedCount++;\n        console.log(\n          `üìß Processing email ${processedCount}/${emails.length}: ${email.messageId} (hasAttachment: ${email.hasAttachment})`,\n        );\n\n        // Check if extractedAttachments exists and log details\n        const extractedAttachments = (email as any).extractedAttachments;\n        console.log(\n          `üîç Attachments check - Email ${email.messageId}: extractedAttachments type=${typeof extractedAttachments}, isArray=${Array.isArray(extractedAttachments)}, length=${extractedAttachments?.length || \"undefined\"}`,\n        );\n        if (\n          extractedAttachments &&\n          Array.isArray(extractedAttachments) &&\n          extractedAttachments.length > 0\n        ) {\n          console.log(\n            `üìé Found ${extractedAttachments.length} attachments:`,\n            extractedAttachments,\n          );\n        }\n        // Check if message already exists (deduplication)\n        const existingMessage = await storage.getEmailMessage(email.messageId);\n        if (existingMessage) {\n          continue; // Skip if already processed\n        }\n\n        // Check if thread exists by threadId\n        const threadId = email.conversationId || email.messageId;\n        let thread = await storage.getEmailThreadByThreadId(threadId);\n\n        if (!thread) {\n          // Create new thread with automatic order matching\n          try {\n            // Try to automatically match orders for this email\n            const matchedOrder = await orderMatchingService.getOrderForAutoLink(\n              email.body || \"\",\n              email.from || \"\",\n              email.subject || \"\",\n            );\n\n            console.log(\n              matchedOrder\n                ? `üéØ NEW THREAD: Automatically matched order ${matchedOrder.orderNumber} (ID: ${matchedOrder.id}) for email from ${email.from}`\n                : `üîç NEW THREAD: No automatic order match found for email from ${email.from}`,\n            );\n\n            thread = await storage.createEmailThread({\n              threadId: threadId,\n              subject: email.subject,\n              customerEmail: email.from,\n              status: \"open\",\n              isUnread: !email.isRead,\n              lastActivity: new Date(email.receivedDateTime),\n              hasAttachment: email.hasAttachment,\n              orderId: matchedOrder?.id || null, // Automatically link order if found\n            });\n          } catch (error: any) {\n            // If duplicate thread ID, fetch the existing one\n            if (error.code === \"23505\") {\n              thread = await storage.getEmailThreadByThreadId(threadId);\n              if (!thread) {\n                throw error; // Re-throw if still can't find it\n              }\n            } else {\n              throw error;\n            }\n          }\n        } else if (!thread.orderId) {\n          // Thread exists but doesn't have an order linked - try to match one\n          try {\n            const matchedOrder = await orderMatchingService.getOrderForAutoLink(\n              email.body || \"\",\n              email.from || \"\",\n              email.subject || \"\",\n            );\n\n            if (matchedOrder) {\n              console.log(\n                `üéØ EXISTING THREAD: Matched order ${matchedOrder.orderNumber} (ID: ${matchedOrder.id}) for existing thread from ${email.from}`,\n              );\n\n              // Update the existing thread with the matched order\n              thread = await storage.updateEmailThread(thread.id, {\n                orderId: matchedOrder.id,\n              });\n            } else {\n              console.log(\n                `üîç EXISTING THREAD: No order match found for existing thread from ${email.from}`,\n              );\n            }\n          } catch (matchingError) {\n            console.error(\n              `‚ùå Error matching order for existing thread ${thread.id}:`,\n              matchingError,\n            );\n          }\n        } else {\n          console.log(\n            `‚úÖ EXISTING THREAD: Thread from ${email.from} already has order ${thread.orderId} linked`,\n          );\n        }\n\n        // Create message (only if not duplicate)\n        try {\n          const createdMessage = await storage.createEmailMessage({\n            messageId: email.messageId,\n            threadId: thread.id,\n            fromEmail: email.from,\n            toEmail: email.to,\n            subject: email.subject,\n            body: email.body,\n            isHtml: email.isHtml,\n            sentAt: new Date(email.receivedDateTime),\n          });\n\n          // Create attachment records if attachments were extracted\n          const extractedAttachments = (email as any).extractedAttachments;\n          console.log(\n            `üîç DEBUG: Email ${email.messageId} (hasAttachment: ${email.hasAttachment}) extractedAttachments:`,\n            extractedAttachments,\n          );\n          console.log(\n            `üîç DEBUG: Type check - extractedAttachments isArray: ${Array.isArray(extractedAttachments)}, length: ${extractedAttachments?.length || \"undefined\"}`,\n          );\n\n          if (\n            extractedAttachments &&\n            Array.isArray(extractedAttachments) &&\n            extractedAttachments.length > 0\n          ) {\n            console.log(\n              `üìé Processing ${extractedAttachments.length} attachments for email ${email.messageId}`,\n            );\n            for (let i = 0; i < extractedAttachments.length; i++) {\n              const attachmentUrl = extractedAttachments[i];\n              try {\n                // Extract filename from storage URL\n                const urlParts = attachmentUrl.split(\"/\");\n                const filename = urlParts[urlParts.length - 1];\n\n                console.log(\n                  `üìé Creating attachment record ${i + 1}/${extractedAttachments.length}: ${filename} -> ${attachmentUrl}`,\n                );\n\n                await storage.createEmailAttachment({\n                  messageId: createdMessage.id,\n                  filename: filename,\n                  storageUrl: attachmentUrl,\n                  contentType: \"application/octet-stream\", // Default, could be improved\n                  size: 0, // Could be improved to track actual size\n                  isInline: false,\n                });\n\n                console.log(`‚úÖ Created attachment record: ${filename}`);\n              } catch (attachmentError) {\n                console.error(\n                  `‚ùå Error creating attachment record for ${attachmentUrl}:`,\n                  attachmentError,\n                );\n              }\n            }\n          } else if (email.hasAttachment) {\n            console.log(\n              `‚ö†Ô∏è WARNING: Email ${email.messageId} has hasAttachment=true but extractedAttachments is empty or invalid`,\n            );\n          }\n        } catch (error: any) {\n          // Skip duplicates, log others\n          if (error.code !== \"23505\") {\n            console.error(\"Error creating email message:\", error);\n          }\n        }\n      }\n\n      res.json({ synced: emails.length });\n    } catch (error) {\n      console.error(\"Error syncing emails:\", error);\n      res.status(500).json({ message: \"Failed to sync emails\" });\n    }\n  });\n\n  // Import all emails from 2025-01-01 to now\n  app.post(\"/api/emails/import-all\", requireAuth, async (req, res) => {\n    try {\n      console.log(`üöÄ Starting full email import from 2025-01-01...`);\n      const result = await importAllEmails();\n      \n      if (result.success) {\n        // Auto-match orders for newly imported emails\n        console.log(`üîÑ Auto-matching orders for imported emails...`);\n        try {\n          const threads = await storage.getEmailThreads({});\n          const threadsWithoutOrders = threads.filter((thread) => !thread.orderId);\n          \n          let matchedCount = 0;\n          for (const thread of threadsWithoutOrders) {\n            const messages = await storage.getEmailMessages(thread.id);\n            if (messages.length > 0) {\n              const firstMessage = messages[0];\n              const matchedOrder = await orderMatchingService.getOrderForAutoLink(\n                firstMessage.body || \"\",\n                thread.customerEmail || \"\",\n                thread.subject || \"\",\n              );\n              \n              if (matchedOrder) {\n                await storage.updateEmailThread(thread.id, {\n                  orderId: matchedOrder.id,\n                });\n                matchedCount++;\n              }\n            }\n          }\n          \n          console.log(`‚úÖ Matched ${matchedCount} threads with orders`);\n        } catch (matchError) {\n          console.error(\"Error auto-matching orders:\", matchError);\n        }\n        \n        res.json({\n          success: true,\n          imported: result.imported,\n          message: `Successfully imported ${result.imported} emails from 2025-01-01 to now`,\n        });\n      } else {\n        res.status(500).json({\n          success: false,\n          message: \"Email import failed\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Error importing emails:\", error);\n      res.status(500).json({\n        success: false,\n        message: \"Failed to import emails\",\n        error: error instanceof Error ? error.message : String(error),\n      });\n    }\n  });\n\n  // Update email thread\n  app.patch(\"/api/email-threads/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const updateData = req.body;\n\n      const thread = await storage.updateEmailThread(id, updateData);\n\n      // Create activity for status changes\n      if (updateData.status) {\n        await storage.createActivity({\n          type: \"email_status_updated\",\n          description: `Email thread status changed to: ${updateData.status}`,\n          userId: \"default-user\", // TODO: Use actual user from session\n          metadata: { threadId: id, newStatus: updateData.status },\n        });\n      }\n\n      res.json(thread);\n    } catch (error) {\n      console.error(\"Error updating email thread:\", error);\n      res.status(500).json({ message: \"Failed to update email thread\" });\n    }\n  });\n\n  // Bulk actions for email threads\n  app.post(\"/api/email-threads/bulk/mark-read\", async (req, res) => {\n    try {\n      const { threadIds } = req.body;\n      if (!Array.isArray(threadIds) || threadIds.length === 0) {\n        return res.status(400).json({ message: \"threadIds array is required\" });\n      }\n\n      const updates = await Promise.all(\n        threadIds.map((id) =>\n          storage.updateEmailThread(id, { isUnread: false }),\n        ),\n      );\n\n      res.json({ updated: updates.length, threads: updates });\n    } catch (error) {\n      console.error(\"Error marking threads as read:\", error);\n      res.status(500).json({ message: \"Failed to mark threads as read\" });\n    }\n  });\n\n  app.post(\"/api/email-threads/bulk/mark-unread\", async (req, res) => {\n    try {\n      const { threadIds } = req.body;\n      if (!Array.isArray(threadIds) || threadIds.length === 0) {\n        return res.status(400).json({ message: \"threadIds array is required\" });\n      }\n\n      const updates = await Promise.all(\n        threadIds.map((id) =>\n          storage.updateEmailThread(id, { isUnread: true }),\n        ),\n      );\n\n      res.json({ updated: updates.length, threads: updates });\n    } catch (error) {\n      console.error(\"Error marking threads as unread:\", error);\n      res.status(500).json({ message: \"Failed to mark threads as unread\" });\n    }\n  });\n\n  app.post(\"/api/email-threads/bulk/star\", async (req, res) => {\n    try {\n      const { threadIds } = req.body;\n      if (!Array.isArray(threadIds) || threadIds.length === 0) {\n        return res.status(400).json({ message: \"threadIds array is required\" });\n      }\n\n      const updates = await Promise.all(\n        threadIds.map((id) => storage.updateEmailThread(id, { starred: true })),\n      );\n\n      res.json({ updated: updates.length, threads: updates });\n    } catch (error) {\n      console.error(\"Error starring threads:\", error);\n      res.status(500).json({ message: \"Failed to star threads\" });\n    }\n  });\n\n  app.post(\"/api/email-threads/bulk/unstar\", async (req, res) => {\n    try {\n      const { threadIds } = req.body;\n      if (!Array.isArray(threadIds) || threadIds.length === 0) {\n        return res.status(400).json({ message: \"threadIds array is required\" });\n      }\n\n      const updates = await Promise.all(\n        threadIds.map((id) =>\n          storage.updateEmailThread(id, { starred: false }),\n        ),\n      );\n\n      res.json({ updated: updates.length, threads: updates });\n    } catch (error) {\n      console.error(\"Error unstarring threads:\", error);\n      res.status(500).json({ message: \"Failed to unstar threads\" });\n    }\n  });\n\n  app.post(\"/api/email-threads/bulk/archive\", async (req, res) => {\n    try {\n      const { threadIds } = req.body;\n      if (!Array.isArray(threadIds) || threadIds.length === 0) {\n        return res.status(400).json({ message: \"threadIds array is required\" });\n      }\n\n      const updates = await Promise.all(\n        threadIds.map((id) =>\n          storage.updateEmailThread(id, { archived: true }),\n        ),\n      );\n\n      res.json({ updated: updates.length, threads: updates });\n    } catch (error) {\n      console.error(\"Error archiving threads:\", error);\n      res.status(500).json({ message: \"Failed to archive threads\" });\n    }\n  });\n\n  app.post(\"/api/email-threads/bulk/unarchive\", async (req, res) => {\n    try {\n      const { threadIds } = req.body;\n      if (!Array.isArray(threadIds) || threadIds.length === 0) {\n        return res.status(400).json({ message: \"threadIds array is required\" });\n      }\n\n      const updates = await Promise.all(\n        threadIds.map((id) =>\n          storage.updateEmailThread(id, { archived: false }),\n        ),\n      );\n\n      res.json({ updated: updates.length, threads: updates });\n    } catch (error) {\n      console.error(\"Error unarchiving threads:\", error);\n      res.status(500).json({ message: \"Failed to unarchive threads\" });\n    }\n  });\n\n  app.delete(\"/api/email-threads/bulk\", async (req, res) => {\n    try {\n      const { threadIds } = req.body;\n      if (!Array.isArray(threadIds) || threadIds.length === 0) {\n        return res.status(400).json({ message: \"threadIds array is required\" });\n      }\n\n      await Promise.all(threadIds.map((id) => storage.deleteEmailThread(id)));\n\n      res.json({\n        deleted: threadIds.length,\n        message: `Deleted ${threadIds.length} threads`,\n      });\n    } catch (error) {\n      console.error(\"Error deleting threads:\", error);\n      res.status(500).json({ message: \"Failed to delete threads\" });\n    }\n  });\n\n  // Send email\n  app.post(\"/api/emails/send\", async (req, res) => {\n    try {\n      const { to, subject, body } = req.body;\n\n      if (!to || !subject || !body) {\n        return res\n          .status(400)\n          .json({ message: \"Missing required fields: to, subject, body\" });\n      }\n\n      const result = await sendEmail(to, subject, body);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Error sending email:\", error);\n      res.status(500).json({ message: \"Failed to send email\" });\n    }\n  });\n\n  // Attachment endpoints - handles both email and repair attachments\n  app.get(\"/api/attachments/*\", async (req, res) => {\n    try {\n      // Extract the path after /api/attachments/\n      const pathAfterAttachments = req.path.replace(\"/api/attachments/\", \"\");\n      const forceDownload = req.query.download === '1';\n      console.log(\n        \"Attachment request path:\",\n        req.path,\n        \"extracted path:\",\n        pathAfterAttachments,\n        \"forceDownload:\",\n        forceDownload,\n      );\n\n      // Construct the storage path with /attachments/ prefix\n      const attachmentPath = `/attachments/${pathAfterAttachments}`;\n      console.log(\"Looking for attachment with storageUrl:\", attachmentPath);\n\n      // Try to find it as an email attachment first\n      const emailAttachment = await storage.getEmailAttachment(attachmentPath);\n      if (emailAttachment) {\n        console.log(\n          \"Found email attachment:\",\n          emailAttachment.filename,\n          \"contentType:\",\n          emailAttachment.contentType,\n        );\n        await storage.downloadAttachment(attachmentPath, res, forceDownload);\n        return;\n      }\n\n      // If not found as email attachment, serve directly from object storage\n      // This handles repair attachments and other files\n      console.log(\"Attempting to serve file directly from object storage\");\n      const objectStorageService = new ObjectStorageService();\n      try {\n        const file = await objectStorageService.getAttachmentFile(attachmentPath);\n        await objectStorageService.downloadObject(file, res, 3600, forceDownload);\n      } catch (storageError) {\n        console.log(\"File not found in object storage:\", attachmentPath);\n        return res.status(404).json({ error: \"Attachment not found\" });\n      }\n    } catch (error) {\n      console.error(\"Error downloading attachment:\", error);\n      res.status(500).json({ error: \"Failed to download attachment\" });\n    }\n  });\n\n  // Get attachments for an email message\n  app.get(\"/api/emails/:messageId/attachments\", async (req, res) => {\n    try {\n      const { messageId } = req.params;\n      const attachments = await storage.getEmailMessageAttachments(messageId);\n      res.json(attachments);\n    } catch (error) {\n      console.error(\"Error fetching attachments:\", error);\n      res.status(500).json({ error: \"Failed to fetch attachments\" });\n    }\n  });\n\n  // Activities\n  app.get(\"/api/activities\", async (req, res) => {\n    try {\n      const { purchaseOrderId } = req.query;\n      let activities = await storage.getActivities();\n      \n      // Filter by purchaseOrderId if provided\n      if (purchaseOrderId) {\n        activities = activities.filter((activity: any) => \n          activity.metadata?.purchaseOrderId === purchaseOrderId\n        );\n      }\n      \n      res.json(activities);\n    } catch (error) {\n      console.error(\"Error fetching activities:\", error);\n      res.status(500).json({ message: \"Failed to fetch activities\" });\n    }\n  });\n\n  app.post(\"/api/activities\", requireAuth, async (req: any, res) => {\n    try {\n      const activity = await storage.createActivity({\n        ...req.body,\n        userId: req.user.id,\n      });\n      res.status(201).json(activity);\n    } catch (error) {\n      console.error(\"Error creating activity:\", error);\n      res.status(400).json({ message: \"Failed to create activity\" });\n    }\n  });\n\n  app.patch(\"/api/activities/:id\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const activity = await storage.updateActivity(id, req.body);\n      res.json(activity);\n    } catch (error) {\n      console.error(\"Error updating activity:\", error);\n      res.status(400).json({ message: \"Failed to update activity\" });\n    }\n  });\n\n  app.delete(\"/api/activities/:id\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteActivity(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting activity:\", error);\n      res.status(400).json({ message: \"Failed to delete activity\" });\n    }\n  });\n\n  // Internal notes\n  app.get(\"/api/notes/:entityType/:entityId\", async (req, res) => {\n    try {\n      const { entityType, entityId } = req.params;\n      const notes = await storage.getInternalNotes(entityId, entityType);\n      res.json(notes);\n    } catch (error) {\n      console.error(\"Error fetching notes:\", error);\n      res.status(500).json({ message: \"Failed to fetch notes\" });\n    }\n  });\n\n  app.post(\"/api/notes\", requireAuth, async (req: any, res) => {\n    try {\n      const validatedData = insertInternalNoteSchema.parse(req.body);\n      // Override authorId with the authenticated user's ID\n      const note = await storage.createInternalNote({\n        ...validatedData,\n        authorId: req.user.id,\n      });\n      res.status(201).json(note);\n    } catch (error) {\n      console.error(\"Error creating note:\", error);\n      res.status(400).json({ message: \"Failed to create note\" });\n    }\n  });\n\n  app.delete(\"/api/notes/:noteId\", requireAuth, async (req: any, res) => {\n    try {\n      const { noteId } = req.params;\n      await storage.deleteInternalNote(noteId);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting note:\", error);\n      res.status(400).json({ message: \"Failed to delete note\" });\n    }\n  });\n\n  // Internal notes endpoint (alternate naming for frontend compatibility)\n  app.get(\"/api/internal-notes\", async (req, res) => {\n    try {\n      const { entityType, entityId, caseId } = req.query;\n\n      if (caseId) {\n        // Get notes linked to a specific case\n        const relatedItems = await storage.getCaseRelatedItems(\n          caseId as string,\n        );\n        res.json(relatedItems.notes);\n      } else if (entityType && entityId) {\n        // Get notes for a specific entity\n        const notes = await storage.getInternalNotes(\n          entityId as string,\n          entityType as any,\n        );\n        res.json(notes);\n      } else {\n        res\n          .status(400)\n          .json({ message: \"Either caseId or entityType+entityId required\" });\n      }\n    } catch (error) {\n      console.error(\"Error fetching internal notes:\", error);\n      res.status(500).json({ message: \"Failed to fetch internal notes\" });\n    }\n  });\n\n  // Suppliers\n  app.get(\"/api/suppliers\", requireAuth, async (req: any, res: any) => {\n    try {\n      const suppliers = await storage.getSuppliers();\n      res.json(suppliers);\n    } catch (error) {\n      console.error(\"Error fetching suppliers:\", error);\n      res.status(500).json({ message: \"Failed to fetch suppliers\" });\n    }\n  });\n\n  app.get(\"/api/suppliers/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const supplier = await storage.getSupplier(id);\n      if (!supplier) {\n        return res.status(404).json({ message: \"Supplier not found\" });\n      }\n      res.json(supplier);\n    } catch (error) {\n      console.error(\"Error fetching supplier:\", error);\n      res.status(500).json({ message: \"Failed to fetch supplier\" });\n    }\n  });\n\n  app.post(\"/api/suppliers\", requireAuth, async (req: any, res: any) => {\n    try {\n      const supplier = await storage.createSupplier(req.body);\n      await auditLog(req, \"CREATE\", \"suppliers\", supplier.id, {\n        name: supplier.name,\n      });\n      res.status(201).json(supplier);\n    } catch (error: any) {\n      console.error(\"Error creating supplier:\", error);\n      res\n        .status(400)\n        .json({ message: error.message || \"Failed to create supplier\" });\n    }\n  });\n\n  app.patch(\"/api/suppliers/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const supplier = await storage.updateSupplier(id, req.body);\n      await auditLog(req, \"UPDATE\", \"suppliers\", id, req.body);\n      res.json(supplier);\n    } catch (error: any) {\n      console.error(\"Error updating supplier:\", error);\n      res\n        .status(400)\n        .json({ message: error.message || \"Failed to update supplier\" });\n    }\n  });\n\n  app.delete(\"/api/suppliers/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteSupplier(id);\n      await auditLog(req, \"DELETE\", \"suppliers\", id);\n      res.json({ message: \"Supplier deleted successfully\" });\n    } catch (error: any) {\n      console.error(\"Error deleting supplier:\", error);\n      res\n        .status(400)\n        .json({ message: error.message || \"Failed to delete supplier\" });\n    }\n  });\n\n  app.post(\n    \"/api/suppliers/import-excel\",\n    requireAuth,\n    upload.single(\"file\"),\n    async (req: any, res: any) => {\n      try {\n        if (!req.file) {\n          return res.status(400).json({ message: \"No file uploaded\" });\n        }\n\n        const XLSX = await import(\"xlsx\");\n        const workbook = XLSX.read(req.file.buffer, { type: \"buffer\" });\n        const sheetName = workbook.SheetNames[0];\n        const worksheet = workbook.Sheets[sheetName];\n        const data = XLSX.utils.sheet_to_json(worksheet);\n\n        const suppliers = data.map((row: any) => ({\n          supplierCode: String(row[\"Relatiecode\"] || row[\"relatiecode\"] || \"\"),\n          name: String(row[\"Naam\"] || row[\"naam\"] || \"\"),\n          contactPerson: row[\"Contactpersoon\"] || row[\"contactpersoon\"] || null,\n          email: row[\"Email\"] || row[\"email\"] || null,\n          phone: row[\"Telefoon\"] ? String(row[\"Telefoon\"]) : null,\n          mobile: row[\"Mobiele telefoon\"] || row[\"mobiele telefoon\"] || null,\n          address: row[\"Adres\"] || row[\"adres\"] || null,\n          postalCode: row[\"Postcode\"] || row[\"postcode\"] || null,\n          city: row[\"Plaats\"] || row[\"plaats\"] || null,\n          website: row[\"Website url\"] || row[\"website url\"] || null,\n          kvkNumber: row[\"Kvk nummer\"] ? String(row[\"Kvk nummer\"]) : null,\n          vatNumber: row[\"Btw nummer\"] || row[\"btw nummer\"] || null,\n          iban: row[\"Iban\"] || row[\"iban\"] || row[\"IBAN\"] || null,\n          bic: row[\"Bic\"] || row[\"bic\"] || row[\"BIC\"] || null,\n          bankAccount: row[\"Bankrekeningnummer\"]\n            ? String(row[\"Bankrekeningnummer\"])\n            : null,\n          paymentTerms: row[\"Krediettermijn\"] || 0,\n          correspondenceAddress: row[\"Correspondentie adres\"] || null,\n          correspondencePostalCode:\n            row[\"Correspondentie adres postcode\"] || null,\n          correspondenceCity: row[\"Correspondentie adres plaats\"] || null,\n          correspondenceContact:\n            row[\"Correspondentie adres contactpersoon\"] || null,\n          notes: row[\"Memo\"] || row[\"memo\"] || null,\n          active: true,\n        }));\n\n        await storage.importSuppliers(suppliers);\n        await auditLog(req, \"IMPORT\", \"suppliers\", undefined, {\n          count: suppliers.length,\n        });\n\n        res.json({\n          message: `Successfully imported ${suppliers.length} suppliers`,\n        });\n      } catch (error: any) {\n        console.error(\"Error importing suppliers:\", error);\n        res\n          .status(500)\n          .json({ message: error.message || \"Failed to import suppliers\" });\n      }\n    },\n  );\n\n  // Purchase Orders\n  app.get(\"/api/purchase-orders\", async (req, res) => {\n    try {\n      const purchaseOrders = await storage.getPurchaseOrders();\n      res.json(purchaseOrders);\n    } catch (error) {\n      console.error(\"Error fetching purchase orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch purchase orders\" });\n    }\n  });\n\n  app.get(\"/api/purchase-orders/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const purchaseOrder = await storage.getPurchaseOrder(id);\n      if (!purchaseOrder) {\n        return res.status(404).json({ message: \"Purchase order not found\" });\n      }\n      res.json(purchaseOrder);\n    } catch (error) {\n      console.error(\"Error fetching purchase order:\", error);\n      res.status(500).json({ message: \"Failed to fetch purchase order\" });\n    }\n  });\n\n  app.post(\"/api/purchase-orders\", async (req, res) => {\n    try {\n      // Additional validation for photos array size\n      if (req.body.photos && Array.isArray(req.body.photos)) {\n        if (req.body.photos.length > 3) {\n          return res.status(400).json({ message: \"Maximum 3 images allowed\" });\n        }\n        // Basic validation for base64 image format\n        for (const photo of req.body.photos) {\n          if (typeof photo !== \"string\" || !photo.startsWith(\"data:image/\")) {\n            return res.status(400).json({ message: \"Invalid image format\" });\n          }\n          // Check approximate size (base64 is ~33% larger than original)\n          if (photo.length > 2800000) {\n            // ~2MB encoded size\n            return res\n              .status(400)\n              .json({ message: \"Image too large, maximum 2MB per image\" });\n          }\n        }\n      }\n\n      // Extract lineItems from request body before validation\n      const { lineItems, ...purchaseOrderFields } = req.body;\n\n      const validatedData = insertPurchaseOrderSchema.parse(purchaseOrderFields);\n\n      // Convert orderDate string to Date object for database if needed\n      const purchaseOrderData = {\n        ...validatedData,\n        orderDate:\n          typeof validatedData.orderDate === \"string\"\n            ? new Date(validatedData.orderDate)\n            : validatedData.orderDate,\n      };\n\n      // Use createPurchaseOrderWithItems (handles PO number generation, items, and activity)\n      const purchaseOrder = await storage.createPurchaseOrderWithItems(\n        purchaseOrderData as any,\n        lineItems || []\n      );\n\n      res.status(201).json(purchaseOrder);\n    } catch (error) {\n      console.error(\"Error creating purchase order:\", error);\n      const errorMessage = error instanceof Error ? error.message : \"Failed to create purchase order\";\n      res.status(400).json({ message: errorMessage });\n    }\n  });\n\n  app.patch(\"/api/purchase-orders/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { lineItems, ...updateFields } = req.body;\n\n      // Always validate with partial schema for data integrity\n      const updateData = insertPurchaseOrderSchema.partial().parse(updateFields);\n\n      // Convert orderDate string to Date object for database if present\n      const purchaseOrderUpdateData = updateData.orderDate\n        ? {\n            ...updateData,\n            orderDate:\n              typeof updateData.orderDate === \"string\"\n                ? new Date(updateData.orderDate)\n                : updateData.orderDate,\n          }\n        : updateData;\n\n      const purchaseOrder = await storage.updatePurchaseOrder(\n        id,\n        purchaseOrderUpdateData as any,\n      );\n\n      // Handle line items update atomically if provided\n      if (lineItems !== undefined) {\n        // Validate line items array\n        if (!Array.isArray(lineItems)) {\n          return res.status(400).json({ message: \"lineItems must be an array\" });\n        }\n\n        await db.transaction(async (tx) => {\n          // Delete all existing line items for this purchase order within transaction\n          await tx.delete(purchaseOrderItems).where(eq(purchaseOrderItems.purchaseOrderId, id));\n\n          // Create new line items within transaction\n          if (lineItems.length > 0) {\n            for (const item of lineItems) {\n              // Validate each item\n              if (!item.productName || item.quantity == null || item.unitPrice == null) {\n                throw new Error(\"Invalid line item: missing required fields\");\n              }\n\n              await tx.insert(purchaseOrderItems).values({\n                purchaseOrderId: id,\n                sku: item.sku || \"\",\n                productName: item.productName,\n                quantity: item.quantity,\n                unitPrice: Math.round(item.unitPrice * 100),\n                subtotal: Math.round(item.quantity * item.unitPrice * 100),\n              });\n            }\n          }\n        });\n      }\n\n      if (req.body.status) {\n        await storage.createActivity({\n          type: \"purchase_order_status_updated\",\n          description: `Updated purchase order status to ${req.body.status}: ${purchaseOrder.title}`,\n          userId: null, // TODO: Get from session\n          metadata: {\n            purchaseOrderId: purchaseOrder.id,\n            status: req.body.status,\n          },\n        });\n      }\n\n      res.json(purchaseOrder);\n    } catch (error) {\n      console.error(\"Error updating purchase order:\", error);\n      res.status(400).json({ message: \"Failed to update purchase order\" });\n    }\n  });\n\n  app.delete(\"/api/purchase-orders/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      \n      // Get purchase order details before deletion for audit log\n      const purchaseOrder = await storage.getPurchaseOrder(id);\n      if (!purchaseOrder) {\n        return res.status(404).json({ message: \"Purchase order not found\" });\n      }\n\n      await storage.deletePurchaseOrder(id);\n\n      await storage.createActivity({\n        type: \"purchase_order_deleted\",\n        description: `Deleted purchase order: ${purchaseOrder.title || purchaseOrder.poNumber}`,\n        userId: req.user.id,\n        metadata: { purchaseOrderId: id, poNumber: purchaseOrder.poNumber },\n      });\n\n      await auditLog(req, \"DELETE\", \"purchase_orders\", id, {\n        poNumber: purchaseOrder.poNumber,\n        title: purchaseOrder.title,\n      });\n\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting purchase order:\", error);\n      res.status(400).json({ message: \"Failed to delete purchase order\" });\n    }\n  });\n\n  // Upload files to a purchase order\n  app.post(\n    \"/api/purchase-orders/:id/upload\",\n    requireAuth,\n    upload.array(\"files\", 10),\n    async (req: any, res) => {\n      const uploadedPaths: string[] = [];\n      try {\n        const { id } = req.params;\n        const files = req.files as Express.Multer.File[];\n\n        if (!files || files.length === 0) {\n          return res.status(400).json({ message: \"No files provided\" });\n        }\n\n        const purchaseOrder = await storage.getPurchaseOrder(id);\n        if (!purchaseOrder) {\n          return res.status(404).json({ message: \"Purchase order not found\" });\n        }\n\n        // Check existing file count\n        const existingFiles = await storage.getPurchaseOrderFiles(id);\n        if (existingFiles.length + files.length > 20) {\n          return res.status(400).json({ message: \"Maximum 20 files per purchase order\" });\n        }\n\n        // Validate files\n        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB\n        const ALLOWED_TYPES = [\n          'application/pdf',\n          'image/jpeg',\n          'image/jpg',\n          'image/png',\n          'application/msword',\n          'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n          'application/vnd.ms-excel',\n          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'\n        ];\n\n        for (const file of files) {\n          if (file.size > MAX_FILE_SIZE) {\n            return res.status(400).json({ message: `File ${file.originalname} is too large (max 10MB)` });\n          }\n          if (!ALLOWED_TYPES.includes(file.mimetype)) {\n            return res.status(400).json({ message: `File type ${file.mimetype} not allowed` });\n          }\n        }\n\n        const objectStorage = new ObjectStorageService();\n        const uploadedFiles: any[] = [];\n\n        for (const file of files) {\n          try {\n            // Create a safe filename\n            const timestamp = Date.now();\n            const safeOriginalName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');\n            const filename = `purchase-order-${id}-${timestamp}-${safeOriginalName}`;\n            \n            console.log(`Uploading purchase order file: ${filename} (${file.size} bytes, ${file.mimetype})`);\n            const url = await objectStorage.saveAttachment(\n              filename,\n              file.buffer,\n              file.mimetype,\n            );\n            uploadedPaths.push(url);\n            console.log(`Uploaded to: ${url}`);\n            \n            // Create file record in database\n            const fileRecord = await storage.createPurchaseOrderFile({\n              purchaseOrderId: id,\n              fileName: file.originalname,\n              filePath: url,\n              fileType: file.mimetype,\n              fileSize: file.size,\n              uploadedBy: req.user.id,\n            });\n            \n            uploadedFiles.push({\n              id: fileRecord.id,\n              fileName: fileRecord.fileName,\n              fileSize: fileRecord.fileSize,\n              uploadedAt: fileRecord.uploadedAt,\n            });\n          } catch (fileError) {\n            // Rollback: delete already uploaded files\n            console.error(`Error uploading file ${file.originalname}, rolling back...`, fileError);\n            for (const path of uploadedPaths) {\n              try {\n                await objectStorage.deleteAttachment(path);\n              } catch (cleanupError) {\n                console.error(`Failed to cleanup file ${path}:`, cleanupError);\n              }\n            }\n            // Delete DB records\n            for (const uploaded of uploadedFiles) {\n              try {\n                await storage.deletePurchaseOrderFile(uploaded.id);\n              } catch (cleanupError) {\n                console.error(`Failed to cleanup DB record ${uploaded.id}:`, cleanupError);\n              }\n            }\n            throw fileError;\n          }\n        }\n\n        // Create activity log with file details\n        await storage.createActivity({\n          type: \"purchase_order_updated\",\n          description: `Uploaded ${uploadedFiles.length} file(s) to purchase order: ${purchaseOrder.title}`,\n          userId: req.user.id,\n          metadata: { \n            purchaseOrderId: id,\n            fileCount: uploadedFiles.length,\n            fileNames: uploadedFiles.map(f => f.fileName),\n          },\n        });\n\n        console.log(`Successfully uploaded ${uploadedFiles.length} files to purchase order ${id}`);\n        res.json({ \n          files: uploadedFiles,\n          total: uploadedFiles.length \n        });\n      } catch (error) {\n        console.error(\"Error uploading files to purchase order:\", error);\n        res.status(500).json({ \n          message: error instanceof Error ? error.message : \"Failed to upload files\",\n          uploaded: uploadedPaths.length,\n        });\n      }\n    },\n  );\n\n  // Get files for a purchase order\n  app.get(\"/api/purchase-orders/:id/files\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const files = await storage.getPurchaseOrderFiles(id);\n      res.json(files);\n    } catch (error) {\n      console.error(\"Error fetching purchase order files:\", error);\n      res.status(500).json({ message: \"Failed to fetch files\" });\n    }\n  });\n\n  // Download a purchase order file\n  app.get(\"/api/purchase-order-files/:id/download\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const file = await storage.getPurchaseOrderFile(id);\n      \n      if (!file) {\n        return res.status(404).json({ message: \"File not found\" });\n      }\n\n      const objectStorage = new ObjectStorageService();\n      const fileObj = await objectStorage.getAttachmentFile(file.filePath);\n      await objectStorage.downloadObject(fileObj, res, 3600, false);\n    } catch (error) {\n      console.error(\"Error downloading purchase order file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ message: \"Failed to download file\" });\n      }\n    }\n  });\n\n  // Delete a purchase order file\n  app.delete(\"/api/purchase-order-files/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      \n      // Get file details using storage interface\n      const file = await storage.getPurchaseOrderFile(id);\n      \n      if (!file) {\n        return res.status(404).json({ message: \"File not found\" });\n      }\n\n      // Authorization check: only file uploader or admin can delete (handle null uploadedBy)\n      const isUploader = file.uploadedBy === req.user.id;\n      const isAdmin = req.user.role === 'admin';\n      const noUploader = !file.uploadedBy; // Allow deletion if no uploader set\n      \n      if (!isUploader && !isAdmin && !noUploader) {\n        return res.status(403).json({ message: \"Not authorized to delete this file\" });\n      }\n\n      // Get purchase order for activity log\n      const purchaseOrder = await storage.getPurchaseOrder(file.purchaseOrderId);\n      \n      // Delete from object storage first - fail fast if this doesn't work\n      const objectStorage = new ObjectStorageService();\n      await objectStorage.deleteAttachment(file.filePath);\n      \n      // Only delete from database if object storage deletion succeeded\n      await storage.deletePurchaseOrderFile(id);\n\n      // Create activity log with detailed file info\n      await storage.createActivity({\n        type: \"purchase_order_updated\",\n        description: `Deleted file \"${file.fileName}\" from purchase order: ${purchaseOrder?.title || 'Unknown'}`,\n        userId: req.user.id,\n        metadata: { \n          purchaseOrderId: file.purchaseOrderId,\n          fileName: file.fileName,\n          fileSize: file.fileSize,\n          fileType: file.fileType,\n        },\n      });\n\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting purchase order file:\", error);\n      res.status(500).json({ message: \"Failed to delete file\" });\n    }\n  });\n\n  // Purchase Order Items\n  app.get(\n    \"/api/purchase-order-items/:purchaseOrderId\",\n    requireAuth,\n    async (req: any, res: any) => {\n      try {\n        const { purchaseOrderId } = req.params;\n        const items = await storage.getPurchaseOrderItems(purchaseOrderId);\n        res.json(items);\n      } catch (error) {\n        console.error(\"Error fetching purchase order items:\", error);\n        res\n          .status(500)\n          .json({ message: \"Failed to fetch purchase order items\" });\n      }\n    },\n  );\n\n  app.post(\n    \"/api/purchase-order-items\",\n    requireAuth,\n    async (req: any, res: any) => {\n      try {\n        const item = await storage.createPurchaseOrderItem(req.body);\n        res.status(201).json(item);\n      } catch (error: any) {\n        console.error(\"Error creating purchase order item:\", error);\n        res\n          .status(400)\n          .json({\n            message: error.message || \"Failed to create purchase order item\",\n          });\n      }\n    },\n  );\n\n  app.patch(\n    \"/api/purchase-order-items/:id\",\n    requireAuth,\n    async (req: any, res: any) => {\n      try {\n        const { id } = req.params;\n        const item = await storage.updatePurchaseOrderItem(id, req.body);\n        res.json(item);\n      } catch (error: any) {\n        console.error(\"Error updating purchase order item:\", error);\n        res\n          .status(400)\n          .json({\n            message: error.message || \"Failed to update purchase order item\",\n          });\n      }\n    },\n  );\n\n  app.delete(\n    \"/api/purchase-order-items/:id\",\n    requireAuth,\n    async (req: any, res: any) => {\n      try {\n        const { id } = req.params;\n        await storage.deletePurchaseOrderItem(id);\n        res.json({ message: \"Purchase order item deleted successfully\" });\n      } catch (error: any) {\n        console.error(\"Error deleting purchase order item:\", error);\n        res\n          .status(400)\n          .json({\n            message: error.message || \"Failed to delete purchase order item\",\n          });\n      }\n    },\n  );\n\n  // Returns\n  app.get(\"/api/returns\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { status, customerId, orderId, assignedUserId } = req.query;\n      const filters: any = {};\n      if (status) filters.status = status;\n      if (customerId) filters.customerId = customerId;\n      if (orderId) filters.orderId = orderId;\n      if (assignedUserId) filters.assignedUserId = assignedUserId;\n      \n      const returns = await storage.getReturns(filters);\n      res.json(returns);\n    } catch (error) {\n      console.error(\"Error fetching returns:\", error);\n      res.status(500).json({ message: \"Failed to fetch returns\" });\n    }\n  });\n\n  app.get(\"/api/returns/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const returnData = await storage.getReturn(id);\n      if (!returnData) {\n        return res.status(404).json({ message: \"Return not found\" });\n      }\n\n      // Fetch associated order with Shopify data\n      let order = null;\n      let customer = null;\n      let orderTracking = null;\n      \n      if (returnData.orderId) {\n        order = await storage.getOrder(returnData.orderId);\n        \n        // Extract tracking from Shopify order data\n        if (order?.orderData) {\n          const fulfillments = (order.orderData as any)?.fulfillments || [];\n          if (fulfillments.length > 0) {\n            const latestFulfillment = fulfillments[fulfillments.length - 1];\n            orderTracking = {\n              trackingNumber: latestFulfillment.tracking_number,\n              trackingUrl: latestFulfillment.tracking_url,\n              trackingCompany: latestFulfillment.tracking_company,\n            };\n          }\n        }\n      }\n      \n      // Fetch customer\n      if (returnData.customerId) {\n        customer = await storage.getCustomer(returnData.customerId);\n      } else if (order?.customerId) {\n        customer = await storage.getCustomer(order.customerId);\n      }\n\n      // Fetch return items\n      const items = await storage.getReturnItems(id);\n\n      // Calculate financial comparison\n      const refundAmount = returnData.refundAmount || 0;\n      const originalAmount = order?.totalAmount || 0;\n      const financialComparison = {\n        refundAmount,\n        originalAmount,\n        difference: originalAmount - refundAmount,\n      };\n\n      // Tracking information\n      const tracking = {\n        returnTracking: {\n          trackingNumber: returnData.trackingNumber,\n          expectedReturnDate: returnData.expectedReturnDate,\n        },\n        orderTracking,\n      };\n\n      // Get photos from object storage (already in return)\n      const photos = returnData.photos || [];\n\n      // Fetch internal notes\n      const notes = await storage.getInternalNotes('return', id);\n\n      // Get assigned user details\n      let assignedUser = null;\n      if (returnData.assignedUserId) {\n        assignedUser = await storage.getUser(returnData.assignedUserId);\n      }\n\n      // Return enriched data\n      res.json({\n        return: returnData,\n        order: order || null,\n        customer: customer || null,\n        returnItems: items,\n        financialComparison,\n        tracking,\n        photos,\n        notes,\n        assignedUser: assignedUser ? {\n          id: assignedUser.id,\n          fullName: `${assignedUser.firstName || ''} ${assignedUser.lastName || ''}`.trim() || assignedUser.username,\n          email: assignedUser.email,\n        } : null,\n      });\n    } catch (error) {\n      console.error(\"Error fetching return:\", error);\n      res.status(500).json({ message: \"Failed to fetch return\" });\n    }\n  });\n\n  app.post(\"/api/returns\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { items, ...returnFields } = req.body;\n      const validatedData = insertReturnSchema.parse(returnFields);\n      \n      // If items are provided, validate and create atomically\n      if (items && Array.isArray(items) && items.length > 0) {\n        // Validate items\n        const validatedItems = items.map((item: any) => insertReturnItemSchema.omit({ returnId: true }).parse(item));\n        \n        // If orderId is provided, validate items against order line items\n        if (validatedData.orderId) {\n          const order = await storage.getOrder(validatedData.orderId);\n          if (order && order.orderData) {\n            const lineItems = (order.orderData as any).line_items || [];\n            \n            // Validate each item exists in order and quantity is valid\n            for (const item of validatedItems) {\n              const lineItem = lineItems.find((li: any) => li.sku === item.sku || li.title === item.productName);\n              if (!lineItem) {\n                return res.status(400).json({\n                  message: `Item \"${item.productName}\" not found in order`,\n                });\n              }\n              if ((item.quantity || 0) > lineItem.quantity) {\n                return res.status(400).json({\n                  message: `Return quantity for \"${item.productName}\" exceeds ordered quantity`,\n                });\n              }\n            }\n          }\n        }\n        \n        // Create return with items atomically\n        const returnData = await storage.createReturnWithItems(validatedData as any, validatedItems);\n        \n        await auditLog(req, \"CREATE\", \"returns\", returnData.id, {\n          returnNumber: returnData.returnNumber,\n          status: returnData.status,\n          itemCount: items.length,\n        });\n        \n        res.status(201).json(returnData);\n      } else {\n        // Create return without items (legacy behavior)\n        const returnData = await storage.createReturn(validatedData as any);\n\n        await auditLog(req, \"CREATE\", \"returns\", returnData.id, {\n          returnNumber: returnData.returnNumber,\n          status: returnData.status,\n        });\n\n        res.status(201).json(returnData);\n      }\n    } catch (error: any) {\n      console.error(\"Error creating return:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to create return\",\n      });\n    }\n  });\n\n  app.patch(\"/api/returns/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const returnData = await storage.updateReturn(id, req.body);\n\n      // Create activity if status changed\n      if (req.body.status) {\n        await storage.createActivity({\n          type: \"return_status_changed\",\n          description: `Return ${returnData.returnNumber} status changed to ${req.body.status}`,\n          userId: req.user.id,\n          metadata: { returnId: id, newStatus: req.body.status },\n        });\n      }\n\n      await auditLog(req, \"UPDATE\", \"returns\", id, {\n        returnNumber: returnData.returnNumber,\n        changes: req.body,\n      });\n\n      res.json(returnData);\n    } catch (error: any) {\n      console.error(\"Error updating return:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to update return\",\n      });\n    }\n  });\n\n  app.delete(\"/api/returns/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const returnData = await storage.getReturn(id);\n      if (!returnData) {\n        return res.status(404).json({ message: \"Return not found\" });\n      }\n\n      await storage.deleteReturn(id);\n\n      await storage.createActivity({\n        type: \"return_deleted\",\n        description: `Deleted return ${returnData.returnNumber}`,\n        userId: req.user.id,\n        metadata: { returnId: id, returnNumber: returnData.returnNumber },\n      });\n\n      await auditLog(req, \"DELETE\", \"returns\", id, {\n        returnNumber: returnData.returnNumber,\n      });\n\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Error deleting return:\", error);\n      res.status(400).json({ message: \"Failed to delete return\" });\n    }\n  });\n\n  // Convert case to return\n  app.post(\"/api/returns/from-case/:caseId\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { caseId } = req.params;\n      const returnData = await storage.createReturnFromCase(caseId);\n\n      await auditLog(req, \"CREATE\", \"returns\", returnData.id, {\n        returnNumber: returnData.returnNumber,\n        source: \"case_conversion\",\n        caseId,\n      });\n\n      res.status(201).json(returnData);\n    } catch (error: any) {\n      console.error(\"Error creating return from case:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to create return from case\",\n      });\n    }\n  });\n\n  // Upload photo for return\n  const photoUpload = multer({\n    storage: multer.memoryStorage(),\n    limits: { fileSize: 10 * 1024 * 1024 }, // 10MB limit\n    fileFilter: (req, file, cb) => {\n      const allowedMimes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];\n      if (allowedMimes.includes(file.mimetype)) {\n        cb(null, true);\n      } else {\n        cb(new Error('Invalid file type. Only JPEG, PNG, GIF, and WebP images are allowed.'));\n      }\n    }\n  });\n\n  app.post(\"/api/returns/:id/photos\", requireAuth, photoUpload.single('photo'), async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      \n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      // Get the return\n      const returnData = await storage.getReturn(id);\n      if (!returnData) {\n        return res.status(404).json({ message: \"Return not found\" });\n      }\n\n      // Save the photo to object storage\n      const objectStorageService = new ObjectStorageService();\n      const photoPath = await objectStorageService.saveAttachment(\n        req.file.originalname,\n        req.file.buffer,\n        req.file.mimetype\n      );\n\n      // Update the return's photos array\n      const currentPhotos = returnData.photos || [];\n      const updatedPhotos = [...currentPhotos, photoPath];\n      \n      await storage.updateReturn(id, { photos: updatedPhotos });\n\n      await auditLog(req, \"UPDATE\", \"returns\", id, {\n        action: \"photo_uploaded\",\n        photoPath,\n      });\n\n      res.status(201).json({ photoPath, message: \"Photo uploaded successfully\" });\n    } catch (error: any) {\n      console.error(\"Error uploading photo:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to upload photo\",\n      });\n    }\n  });\n\n  // Delete photo from return\n  app.delete(\"/api/returns/:id/photos\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const { photoPath } = req.body;\n\n      if (!photoPath) {\n        return res.status(400).json({ message: \"Photo path is required\" });\n      }\n\n      const returnData = await storage.getReturn(id);\n      if (!returnData) {\n        return res.status(404).json({ message: \"Return not found\" });\n      }\n\n      // Remove the photo from the array\n      const currentPhotos = returnData.photos || [];\n      const updatedPhotos = currentPhotos.filter((p: string) => p !== photoPath);\n      \n      await storage.updateReturn(id, { photos: updatedPhotos });\n\n      await auditLog(req, \"UPDATE\", \"returns\", id, {\n        action: \"photo_deleted\",\n        photoPath,\n      });\n\n      res.json({ message: \"Photo deleted successfully\" });\n    } catch (error: any) {\n      console.error(\"Error deleting photo:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to delete photo\",\n      });\n    }\n  });\n\n  // Return Items\n  app.get(\"/api/return-items/:returnId\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { returnId } = req.params;\n      const items = await storage.getReturnItems(returnId);\n      res.json(items);\n    } catch (error) {\n      console.error(\"Error fetching return items:\", error);\n      res.status(500).json({ message: \"Failed to fetch return items\" });\n    }\n  });\n\n  app.post(\"/api/return-items\", requireAuth, async (req: any, res: any) => {\n    try {\n      const validatedData = insertReturnItemSchema.parse(req.body);\n      const item = await storage.createReturnItem(validatedData as any);\n      res.status(201).json(item);\n    } catch (error: any) {\n      console.error(\"Error creating return item:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to create return item\",\n      });\n    }\n  });\n\n  app.patch(\"/api/return-items/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const item = await storage.updateReturnItem(id, req.body);\n      res.json(item);\n    } catch (error: any) {\n      console.error(\"Error updating return item:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to update return item\",\n      });\n    }\n  });\n\n  app.delete(\"/api/return-items/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteReturnItem(id);\n      res.json({ message: \"Return item deleted successfully\" });\n    } catch (error: any) {\n      console.error(\"Error deleting return item:\", error);\n      res.status(400).json({\n        message: error.message || \"Failed to delete return item\",\n      });\n    }\n  });\n\n  // Search\n  app.get(\"/api/search\", async (req, res) => {\n    try {\n      const { q } = req.query;\n      if (!q || typeof q !== \"string\") {\n        return res.status(400).json({ message: \"Search query is required\" });\n      }\n\n      const results = await storage.globalSearch(q);\n      res.json(results);\n    } catch (error) {\n      console.error(\"Error performing search:\", error);\n      res.status(500).json({ message: \"Failed to perform search\" });\n    }\n  });\n\n  // Customers\n  app.get(\"/api/customers\", async (req, res) => {\n    try {\n      const customers = await storage.getCustomers();\n      res.json(customers);\n    } catch (error) {\n      console.error(\"Error fetching customers:\", error);\n      res.status(500).json({ message: \"Failed to fetch customers\" });\n    }\n  });\n\n  app.get(\"/api/customers/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const customer = await storage.getCustomer(id);\n      if (!customer) {\n        return res.status(404).json({ message: \"Customer not found\" });\n      }\n      res.json(customer);\n    } catch (error) {\n      console.error(\"Error fetching customer:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer\" });\n    }\n  });\n\n  app.get(\"/api/customers/:id/orders\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const orders = await storage.getCustomerOrders(id);\n      res.json(orders);\n    } catch (error) {\n      console.error(\"Error fetching customer orders:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer orders\" });\n    }\n  });\n\n  app.get(\"/api/customers/:id/email-threads\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const threads = await storage.getCustomerEmailThreads(id);\n      res.json(threads);\n    } catch (error) {\n      console.error(\"Error fetching customer email threads:\", error);\n      res\n        .status(500)\n        .json({ message: \"Failed to fetch customer email threads\" });\n    }\n  });\n\n  app.get(\"/api/customers/:id/repairs\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const repairs = await storage.getCustomerRepairs(id);\n      res.json(repairs);\n    } catch (error) {\n      console.error(\"Error fetching customer repairs:\", error);\n      res.status(500).json({ message: \"Failed to fetch customer repairs\" });\n    }\n  });\n\n  // Cases\n  app.get(\"/api/cases\", async (req, res) => {\n    try {\n      const { status, q, emailThreadId } = req.query;\n      const cases = await storage.getCases(\n        status as string,\n        q as string,\n        emailThreadId as string,\n      );\n      res.json(cases);\n    } catch (error) {\n      console.error(\"Error fetching cases:\", error);\n      res.status(500).json({ message: \"Failed to fetch cases\" });\n    }\n  });\n\n  app.post(\"/api/cases\", async (req, res) => {\n    try {\n      const { items, ...caseData } = req.body;\n      const validatedData = insertCaseSchema.parse(caseData);\n\n      // Validate items if provided\n      let validatedItems: any[] = [];\n      if (items && items.length > 0) {\n        // Create array schema for case items with required non-empty SKU\n        const caseItemArraySchema = z.array(\n          insertCaseItemSchema.omit({ caseId: true }).refine(\n            (item) => item.sku && item.sku.trim().length > 0,\n            { message: \"SKU is required and cannot be empty\" }\n          )\n        );\n        validatedItems = caseItemArraySchema.parse(items);\n\n        // If orderId is provided, validate that items belong to that order\n        if (validatedData.orderId) {\n          const order = await storage.getOrder(validatedData.orderId);\n          if (!order) {\n            return res.status(400).json({ message: \"Order not found\" });\n          }\n\n          // Safely extract SKUs from order line items in orderData\n          const orderData = order.orderData as any;\n          if (!orderData || !orderData.line_items) {\n            return res.status(400).json({ \n              message: \"Order does not have line items data. Cannot validate case items against this order.\" \n            });\n          }\n\n          const orderLineItems = orderData.line_items;\n          const orderSkus = new Set(orderLineItems.map((item: any) => item.sku).filter(Boolean));\n\n          // Validate that all case item SKUs exist in the order\n          const invalidItems = validatedItems.filter(item => !orderSkus.has(item.sku));\n          if (invalidItems.length > 0) {\n            return res.status(400).json({ \n              message: \"Some items do not belong to the specified order\",\n              invalidSkus: invalidItems.map(item => item.sku)\n            });\n          }\n        }\n      }\n\n      // Handle date conversions\n      if (\n        validatedData.slaDeadline &&\n        typeof validatedData.slaDeadline === \"string\"\n      ) {\n        validatedData.slaDeadline = new Date(validatedData.slaDeadline);\n      }\n      if (\n        validatedData.resolvedAt &&\n        typeof validatedData.resolvedAt === \"string\"\n      ) {\n        validatedData.resolvedAt = new Date(validatedData.resolvedAt);\n      }\n      if (\n        validatedData.closedAt &&\n        typeof validatedData.closedAt === \"string\"\n      ) {\n        validatedData.closedAt = new Date(validatedData.closedAt);\n      }\n\n      // Create case with or without items\n      const newCase = validatedItems.length > 0\n        ? await storage.createCaseWithItems(validatedData, validatedItems)\n        : await storage.createCase(validatedData);\n\n      // Create activity\n      await storage.createActivity({\n        type: \"case_created\",\n        description: `Created case: ${newCase.title}${validatedItems.length > 0 ? ` with ${validatedItems.length} item(s)` : ''}`,\n        userId: newCase.assignedUserId,\n        metadata: { caseId: newCase.id, caseNumber: newCase.caseNumber, itemCount: validatedItems.length },\n      });\n\n      res.status(201).json(newCase);\n    } catch (error) {\n      console.error(\"Error creating case:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ \n          message: \"Validation error\", \n          errors: error.errors \n        });\n      }\n      res.status(400).json({ message: \"Failed to create case\" });\n    }\n  });\n\n  app.get(\"/api/cases/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const caseItem = await storage.getCase(id);\n      if (!caseItem) {\n        return res.status(404).json({ message: \"Case not found\" });\n      }\n\n      // Fetch all related data in parallel\n      const [caseItems, caseLinks, caseEvents, caseNotes] = await Promise.all([\n        storage.getCaseItems(id),\n        storage.getCaseLinks(id),\n        storage.getCaseEvents(id),\n        storage.getCaseNotes(id)\n      ]);\n\n      // Return complete case data in one response\n      res.json({\n        ...caseItem,\n        items: caseItems,\n        links: caseLinks,\n        events: caseEvents,\n        notes: caseNotes,\n      });\n    } catch (error) {\n      console.error(\"Error fetching case:\", error);\n      res.status(500).json({ message: \"Failed to fetch case\" });\n    }\n  });\n\n  app.get(\"/api/cases/:id/items\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const items = await storage.getCaseItems(id);\n      res.json(items);\n    } catch (error) {\n      console.error(\"Error fetching case items:\", error);\n      res.status(500).json({ message: \"Failed to fetch case items\" });\n    }\n  });\n\n  app.patch(\"/api/cases/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      // Handle date conversions\n      const updateData = { ...req.body };\n      if (\n        updateData.slaDeadline &&\n        typeof updateData.slaDeadline === \"string\"\n      ) {\n        updateData.slaDeadline = new Date(updateData.slaDeadline);\n      }\n      if (updateData.resolvedAt && typeof updateData.resolvedAt === \"string\") {\n        updateData.resolvedAt = new Date(updateData.resolvedAt);\n      }\n      if (updateData.closedAt && typeof updateData.closedAt === \"string\") {\n        updateData.closedAt = new Date(updateData.closedAt);\n      }\n\n      const updatedCase = await storage.updateCase(id, updateData);\n\n      // Create activity for status change\n      if (req.body.status) {\n        await storage.createActivity({\n          type: \"case_status_updated\",\n          description: `Updated case status to ${req.body.status}: ${updatedCase.title}`,\n          userId: updatedCase.assignedUserId,\n          metadata: { caseId: updatedCase.id, status: req.body.status },\n        });\n      }\n\n      res.json(updatedCase);\n    } catch (error) {\n      console.error(\"Error updating case:\", error);\n      res.status(400).json({ message: \"Failed to update case\" });\n    }\n  });\n\n  app.post(\"/api/cases/:id/link\", async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { entityType, entityId } = req.body;\n\n      if (!entityType || !entityId) {\n        return res\n          .status(400)\n          .json({ message: \"entityType and entityId are required\" });\n      }\n\n      if (![\"email\", \"repair\", \"todo\", \"order\", \"note\"].includes(entityType)) {\n        return res.status(400).json({ message: \"Invalid entityType\" });\n      }\n\n      await storage.linkEntityToCase(id, entityType, entityId);\n\n      const caseItem = await storage.getCase(id);\n      await storage.createActivity({\n        type: \"case_entity_linked\",\n        description: `Linked ${entityType} to case: ${caseItem?.title}`,\n        userId: caseItem?.assignedUserId,\n        metadata: { caseId: id, entityType, entityId },\n      });\n\n      res.json({ message: \"Entity linked to case successfully\" });\n    } catch (error) {\n      console.error(\"Error linking entity to case:\", error);\n      res.status(400).json({ message: \"Failed to link entity to case\" });\n    }\n  });\n\n  app.post(\"/api/cases/:id/unlink\", async (req, res) => {\n    try {\n      const { entityType, entityId } = req.body;\n\n      if (!entityType || !entityId) {\n        return res\n          .status(400)\n          .json({ message: \"entityType and entityId are required\" });\n      }\n\n      if (![\"email\", \"repair\", \"todo\", \"order\", \"note\"].includes(entityType)) {\n        return res.status(400).json({ message: \"Invalid entityType\" });\n      }\n\n      await storage.unlinkEntityFromCase(entityType, entityId);\n\n      const { id } = req.params;\n      const caseItem = await storage.getCase(id);\n      await storage.createActivity({\n        type: \"case_entity_unlinked\",\n        description: `Unlinked ${entityType} from case: ${caseItem?.title}`,\n        userId: caseItem?.assignedUserId,\n        metadata: { caseId: id, entityType, entityId },\n      });\n\n      res.json({ message: \"Entity unlinked from case successfully\" });\n    } catch (error) {\n      console.error(\"Error unlinking entity from case:\", error);\n      res.status(400).json({ message: \"Failed to unlink entity from case\" });\n    }\n  });\n\n  // Archive a case\n  app.patch(\"/api/cases/:id/archive\", async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      const updatedCase = await storage.updateCase(id, {\n        archived: true,\n        archivedAt: new Date(),\n      });\n\n      if (!updatedCase) {\n        return res.status(404).json({ message: \"Case not found\" });\n      }\n\n      await storage.createActivity({\n        type: \"case_archived\",\n        description: `Archived case: ${updatedCase.title || updatedCase.caseNumber || \"Unknown\"}`,\n        userId: updatedCase.assignedUserId || null,\n        metadata: { caseId: updatedCase.id },\n      });\n\n      res.json(updatedCase);\n    } catch (error) {\n      console.error(\"Error archiving case:\", error);\n      res.status(400).json({ message: \"Failed to archive case\" });\n    }\n  });\n\n  // Unarchive a case\n  app.patch(\"/api/cases/:id/unarchive\", async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      const updatedCase = await storage.updateCase(id, {\n        archived: false,\n        archivedAt: null,\n      });\n\n      if (!updatedCase) {\n        return res.status(404).json({ message: \"Case not found\" });\n      }\n\n      await storage.createActivity({\n        type: \"case_unarchived\",\n        description: `Unarchived case: ${updatedCase.title || updatedCase.caseNumber || \"Unknown\"}`,\n        userId: updatedCase.assignedUserId || null,\n        metadata: { caseId: updatedCase.id },\n      });\n\n      res.json(updatedCase);\n    } catch (error) {\n      console.error(\"Error unarchiving case:\", error);\n      res.status(400).json({ message: \"Failed to unarchive case\" });\n    }\n  });\n\n  // Delete a case\n  app.delete(\"/api/cases/:id\", async (req, res) => {\n    try {\n      const { id } = req.params;\n\n      // Get case details before deletion for activity log\n      const caseItem = await storage.getCase(id);\n      if (!caseItem) {\n        return res.status(404).json({ message: \"Case not found\" });\n      }\n\n      await storage.deleteCase(id);\n\n      await storage.createActivity({\n        type: \"case_deleted\",\n        description: `Deleted case: ${caseItem.title}`,\n        userId: caseItem.assignedUserId,\n        metadata: { caseId: id, caseNumber: caseItem.caseNumber },\n      });\n\n      res.json({ message: \"Case deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting case:\", error);\n      res.status(400).json({ message: \"Failed to delete case\" });\n    }\n  });\n\n  app.post(\"/api/cases/from-email/:threadId\", async (req, res) => {\n    try {\n      const { threadId } = req.params;\n\n      const newCase = await storage.createCaseFromEmailThread(threadId);\n\n      await storage.createActivity({\n        type: \"case_created_from_email\",\n        description: `Created case from email thread: ${newCase.title}`,\n        userId: newCase.assignedUserId,\n        metadata: { caseId: newCase.id, threadId },\n      });\n\n      res.status(201).json(newCase);\n    } catch (error) {\n      console.error(\"Error creating case from email thread:\", error);\n      res\n        .status(400)\n        .json({\n          message:\n            error instanceof Error\n              ? error.message\n              : \"Failed to create case from email thread\",\n        });\n    }\n  });\n\n  // Case Links\n  app.get(\"/api/cases/:id/links\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const links = await storage.getCaseLinks(id);\n      res.json(links);\n    } catch (error) {\n      console.error(\"Error fetching case links:\", error);\n      res.status(500).json({ message: \"Failed to fetch case links\" });\n    }\n  });\n\n  app.post(\"/api/cases/:id/links\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertCaseLinkSchema.parse({\n        caseId: id,\n        linkType: req.body.linkType,\n        linkedId: req.body.linkedId,\n        createdBy: req.user.id,\n      });\n\n      const link = await storage.createCaseLink(validatedData);\n\n      await storage.createCaseEvent({\n        caseId: id,\n        eventType: \"link_added\",\n        message: `Linked ${validatedData.linkType} to case`,\n        metadata: {\n          linkType: validatedData.linkType,\n          linkedId: validatedData.linkedId,\n        },\n        createdBy: req.user.id,\n      });\n\n      res.status(201).json(link);\n    } catch (error) {\n      console.error(\"Error creating case link:\", error);\n      res\n        .status(400)\n        .json({\n          message:\n            error instanceof Error\n              ? error.message\n              : \"Failed to create case link\",\n        });\n    }\n  });\n\n  app.delete(\n    \"/api/cases/:id/links/:linkId\",\n    requireAuth,\n    async (req: any, res) => {\n      try {\n        const { id, linkId } = req.params;\n\n        await storage.deleteCaseLink(linkId);\n\n        await storage.createCaseEvent({\n          caseId: id,\n          eventType: \"link_removed\",\n          message: `Removed link from case`,\n          createdBy: req.user.id,\n        });\n\n        res.json({ message: \"Link removed successfully\" });\n      } catch (error) {\n        console.error(\"Error deleting case link:\", error);\n        res.status(400).json({ message: \"Failed to delete case link\" });\n      }\n    },\n  );\n\n  // Case Notes\n  app.get(\"/api/cases/:id/notes\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const notes = await storage.getCaseNotes(id);\n      res.json(notes);\n    } catch (error) {\n      console.error(\"Error fetching case notes:\", error);\n      res.status(500).json({ message: \"Failed to fetch case notes\" });\n    }\n  });\n\n  app.post(\"/api/cases/:id/notes\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const validatedData = insertCaseNoteSchema.parse({\n        caseId: id,\n        content: req.body.content,\n        createdBy: req.user.id,\n      });\n\n      const note = await storage.createCaseNote(validatedData);\n\n      await storage.createCaseEvent({\n        caseId: id,\n        eventType: \"note_added\",\n        message: `Added a note to case`,\n        createdBy: req.user.id,\n      });\n\n      res.status(201).json(note);\n    } catch (error) {\n      console.error(\"Error creating case note:\", error);\n      res\n        .status(400)\n        .json({\n          message:\n            error instanceof Error\n              ? error.message\n              : \"Failed to create case note\",\n        });\n    }\n  });\n\n  // Case Events (Timeline)\n  app.get(\"/api/cases/:id/events\", requireAuth, async (req: any, res) => {\n    try {\n      const { id } = req.params;\n      const events = await storage.getCaseEvents(id);\n      res.json(events);\n    } catch (error) {\n      console.error(\"Error fetching case events:\", error);\n      res.status(500).json({ message: \"Failed to fetch case events\" });\n    }\n  });\n\n  // ==========================================\n  // NOTES SYSTEM API ROUTES\n  // ==========================================\n\n  // Core Notes Routes\n  // GET /api/notes/:entityType/:entityId - Get all notes for an entity\n  app.get(\"/api/notes/:entityType/:entityId\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { entityType, entityId } = req.params;\n      const { visibility, tagIds, authorId } = req.query;\n\n      const filters: any = {};\n      if (visibility) filters.visibility = visibility;\n      if (authorId) filters.authorId = authorId;\n      if (tagIds) {\n        filters.tagIds = Array.isArray(tagIds) ? tagIds : [tagIds];\n      }\n\n      const notes = await storage.getNotes(entityType, entityId, filters);\n      res.json(notes);\n    } catch (error) {\n      console.error(\"Error fetching notes:\", error);\n      res.status(500).json({ error: \"Failed to fetch notes\" });\n    }\n  });\n\n  // POST /api/notes - Create a new note\n  app.post(\"/api/notes\", requireAuth, async (req: any, res: any) => {\n    try {\n      const validatedData = insertNoteSchema.parse({\n        ...req.body,\n        authorId: req.user.id,\n      });\n\n      const note = await storage.createNote(validatedData);\n\n      await auditLog(req, \"CREATE\", \"notes\", note.id, {\n        entityType: note.entityType,\n        entityId: note.entityId,\n      });\n\n      res.status(201).json(note);\n    } catch (error) {\n      console.error(\"Error creating note:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Invalid note data\", details: error.errors });\n      } else {\n        res.status(400).json({ error: \"Failed to create note\" });\n      }\n    }\n  });\n\n  // GET /api/notes/:id - Get a single note\n  app.get(\"/api/notes/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const note = await storage.getNote(id);\n\n      if (!note) {\n        return res.status(404).json({ error: \"Note not found\" });\n      }\n\n      res.json(note);\n    } catch (error) {\n      console.error(\"Error fetching note:\", error);\n      res.status(500).json({ error: \"Failed to fetch note\" });\n    }\n  });\n\n  // PATCH /api/notes/:id - Update a note (creates revision)\n  app.patch(\"/api/notes/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const existingNote = await storage.getNote(id);\n\n      if (!existingNote) {\n        return res.status(404).json({ error: \"Note not found\" });\n      }\n\n      // Create revision before updating\n      if (req.body.content && req.body.content !== existingNote.content) {\n        await storage.createNoteRevision({\n          noteId: id,\n          editorId: req.user.id,\n          previousContent: existingNote.content,\n          newContent: req.body.content,\n        });\n      }\n\n      const updatedNote = await storage.updateNote(id, {\n        ...req.body,\n        editedAt: new Date(),\n      });\n\n      await auditLog(req, \"UPDATE\", \"notes\", id, req.body);\n\n      res.json(updatedNote);\n    } catch (error) {\n      console.error(\"Error updating note:\", error);\n      res.status(400).json({ error: \"Failed to update note\" });\n    }\n  });\n\n  // DELETE /api/notes/:id - Soft delete a note\n  app.delete(\"/api/notes/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const { deleteReason } = req.body;\n\n      if (!deleteReason) {\n        return res.status(400).json({ error: \"Delete reason is required\" });\n      }\n\n      await storage.deleteNote(id, deleteReason, req.user.id);\n\n      await auditLog(req, \"DELETE\", \"notes\", id, { deleteReason });\n\n      res.json({ message: \"Note deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting note:\", error);\n      res.status(400).json({ error: \"Failed to delete note\" });\n    }\n  });\n\n  // POST /api/notes/:id/pin - Pin a note\n  app.post(\"/api/notes/:id/pin\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      await storage.pinNote(id);\n\n      await auditLog(req, \"PIN\", \"notes\", id);\n\n      res.json({ message: \"Note pinned successfully\" });\n    } catch (error) {\n      console.error(\"Error pinning note:\", error);\n      res.status(400).json({ error: \"Failed to pin note\" });\n    }\n  });\n\n  // DELETE /api/notes/:id/pin - Unpin a note\n  app.delete(\"/api/notes/:id/pin\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      await storage.unpinNote(id);\n\n      await auditLog(req, \"UNPIN\", \"notes\", id);\n\n      res.json({ message: \"Note unpinned successfully\" });\n    } catch (error) {\n      console.error(\"Error unpinning note:\", error);\n      res.status(400).json({ error: \"Failed to unpin note\" });\n    }\n  });\n\n  // GET /api/notes/search - Search notes across all entities\n  app.get(\"/api/notes/search\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { query, entityType, visibility } = req.query;\n\n      if (!query) {\n        return res.status(400).json({ error: \"Search query is required\" });\n      }\n\n      const filters: any = {};\n      if (entityType) filters.entityType = entityType;\n      if (visibility) filters.visibility = visibility;\n\n      const notes = await storage.searchNotes(query as string, filters);\n      res.json(notes);\n    } catch (error) {\n      console.error(\"Error searching notes:\", error);\n      res.status(500).json({ error: \"Failed to search notes\" });\n    }\n  });\n\n  // Note Tags Routes\n  // GET /api/note-tags - Get all tags\n  app.get(\"/api/note-tags\", requireAuth, async (req: any, res: any) => {\n    try {\n      const tags = await storage.getNoteTags();\n      res.json(tags);\n    } catch (error) {\n      console.error(\"Error fetching note tags:\", error);\n      res.status(500).json({ error: \"Failed to fetch note tags\" });\n    }\n  });\n\n  // POST /api/note-tags - Create a new tag\n  app.post(\"/api/note-tags\", requireAuth, async (req: any, res: any) => {\n    try {\n      const validatedData = insertNoteTagSchema.parse(req.body);\n      const tag = await storage.createNoteTag(validatedData);\n\n      await auditLog(req, \"CREATE\", \"note-tags\", tag.id, { name: tag.name });\n\n      res.status(201).json(tag);\n    } catch (error) {\n      console.error(\"Error creating note tag:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Invalid tag data\", details: error.errors });\n      } else {\n        res.status(400).json({ error: \"Failed to create note tag\" });\n      }\n    }\n  });\n\n  // POST /api/notes/:noteId/tags/:tagId - Assign tag to note\n  app.post(\"/api/notes/:noteId/tags/:tagId\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId, tagId } = req.params;\n      await storage.assignTagToNote(noteId, tagId);\n\n      await auditLog(req, \"ASSIGN_TAG\", \"notes\", noteId, { tagId });\n\n      res.status(201).json({ message: \"Tag assigned successfully\" });\n    } catch (error) {\n      console.error(\"Error assigning tag to note:\", error);\n      res.status(400).json({ error: \"Failed to assign tag to note\" });\n    }\n  });\n\n  // DELETE /api/notes/:noteId/tags/:tagId - Remove tag from note\n  app.delete(\"/api/notes/:noteId/tags/:tagId\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId, tagId } = req.params;\n      await storage.removeTagFromNote(noteId, tagId);\n\n      await auditLog(req, \"REMOVE_TAG\", \"notes\", noteId, { tagId });\n\n      res.json({ message: \"Tag removed successfully\" });\n    } catch (error) {\n      console.error(\"Error removing tag from note:\", error);\n      res.status(400).json({ error: \"Failed to remove tag from note\" });\n    }\n  });\n\n  // Note Mentions Routes\n  // POST /api/notes/:noteId/mentions - Create a mention\n  app.post(\"/api/notes/:noteId/mentions\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const validatedData = insertNoteMentionSchema.parse({\n        noteId,\n        ...req.body,\n      });\n\n      const mention = await storage.createNoteMention(validatedData);\n\n      await auditLog(req, \"CREATE\", \"note-mentions\", mention.id, {\n        noteId,\n        userId: mention.userId,\n      });\n\n      res.status(201).json(mention);\n    } catch (error) {\n      console.error(\"Error creating note mention:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Invalid mention data\", details: error.errors });\n      } else {\n        res.status(400).json({ error: \"Failed to create note mention\" });\n      }\n    }\n  });\n\n  // GET /api/notes/:noteId/mentions - Get note mentions\n  app.get(\"/api/notes/:noteId/mentions\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const mentions = await storage.getNoteMentions(noteId);\n      res.json(mentions);\n    } catch (error) {\n      console.error(\"Error fetching note mentions:\", error);\n      res.status(500).json({ error: \"Failed to fetch note mentions\" });\n    }\n  });\n\n  // PATCH /api/note-mentions/:id/read - Mark mention as read\n  app.patch(\"/api/note-mentions/:id/read\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      await storage.markMentionRead(id);\n\n      await auditLog(req, \"MARK_READ\", \"note-mentions\", id);\n\n      res.json({ message: \"Mention marked as read\" });\n    } catch (error) {\n      console.error(\"Error marking mention as read:\", error);\n      res.status(400).json({ error: \"Failed to mark mention as read\" });\n    }\n  });\n\n  // Note Reactions Routes\n  // POST /api/notes/:noteId/reactions - Add a reaction\n  app.post(\"/api/notes/:noteId/reactions\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const validatedData = insertNoteReactionSchema.parse({\n        noteId,\n        userId: req.user.id,\n        emoji: req.body.emoji,\n      });\n\n      const reaction = await storage.addReaction(validatedData);\n\n      await auditLog(req, \"CREATE\", \"note-reactions\", reaction.id, {\n        noteId,\n        emoji: reaction.emoji,\n      });\n\n      res.status(201).json(reaction);\n    } catch (error) {\n      console.error(\"Error adding note reaction:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Invalid reaction data\", details: error.errors });\n      } else {\n        res.status(400).json({ error: \"Failed to add note reaction\" });\n      }\n    }\n  });\n\n  // DELETE /api/notes/:noteId/reactions - Remove a reaction\n  app.delete(\"/api/notes/:noteId/reactions\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const { userId, emoji } = req.body;\n\n      if (!userId || !emoji) {\n        return res.status(400).json({ error: \"userId and emoji are required\" });\n      }\n\n      await storage.removeReaction(noteId, userId, emoji);\n\n      await auditLog(req, \"DELETE\", \"note-reactions\", noteId, { userId, emoji });\n\n      res.json({ message: \"Reaction removed successfully\" });\n    } catch (error) {\n      console.error(\"Error removing note reaction:\", error);\n      res.status(400).json({ error: \"Failed to remove note reaction\" });\n    }\n  });\n\n  // GET /api/notes/:noteId/reactions - Get note reactions\n  app.get(\"/api/notes/:noteId/reactions\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const reactions = await storage.getNoteReactions(noteId);\n      res.json(reactions);\n    } catch (error) {\n      console.error(\"Error fetching note reactions:\", error);\n      res.status(500).json({ error: \"Failed to fetch note reactions\" });\n    }\n  });\n\n  // Note Attachments Routes\n  // POST /api/notes/:noteId/attachments - Upload an attachment\n  app.post(\"/api/notes/:noteId/attachments\", requireAuth, upload.array('files', 10), async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const files = req.files as Express.Multer.File[];\n\n      if (!files || files.length === 0) {\n        return res.status(400).json({ error: \"No files uploaded\" });\n      }\n\n      const objectStorage = new ObjectStorageService();\n      const attachments = [];\n\n      for (const file of files) {\n        const storagePath = await objectStorage.saveAttachment(\n          file.originalname,\n          file.buffer,\n          file.mimetype\n        );\n\n        const attachment = await storage.createNoteAttachment({\n          noteId,\n          fileName: file.originalname,\n          filePath: storagePath,\n          mimeType: file.mimetype,\n          sizeBytes: file.size,\n          uploadedBy: req.user.id,\n        });\n\n        attachments.push(attachment);\n      }\n\n      await auditLog(req, \"UPLOAD\", \"note-attachments\", noteId, {\n        count: attachments.length,\n      });\n\n      res.status(201).json(attachments);\n    } catch (error) {\n      console.error(\"Error uploading note attachments:\", error);\n      res.status(400).json({ error: \"Failed to upload note attachments\" });\n    }\n  });\n\n  // GET /api/notes/:noteId/attachments - Get note attachments\n  app.get(\"/api/notes/:noteId/attachments\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const attachments = await storage.getNoteAttachments(noteId);\n      res.json(attachments);\n    } catch (error) {\n      console.error(\"Error fetching note attachments:\", error);\n      res.status(500).json({ error: \"Failed to fetch note attachments\" });\n    }\n  });\n\n  // DELETE /api/note-attachments/:id - Delete an attachment\n  app.delete(\"/api/note-attachments/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteNoteAttachment(id);\n\n      await auditLog(req, \"DELETE\", \"note-attachments\", id);\n\n      res.json({ message: \"Attachment deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting note attachment:\", error);\n      res.status(400).json({ error: \"Failed to delete note attachment\" });\n    }\n  });\n\n  // Note Follow-ups Routes\n  // POST /api/notes/:noteId/followups - Create a follow-up (also creates a Todo)\n  app.post(\"/api/notes/:noteId/followups\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const note = await storage.getNote(noteId);\n\n      if (!note) {\n        return res.status(404).json({ error: \"Note not found\" });\n      }\n\n      const validatedData = insertNoteFollowupSchema.parse({\n        noteId,\n        ...req.body,\n      });\n\n      // Convert dueAt to Date if it's a string\n      if (typeof validatedData.dueAt === 'string') {\n        validatedData.dueAt = new Date(validatedData.dueAt);\n      }\n\n      // Create the Todo first\n      const todo = await storage.createTodo({\n        title: req.body.todoTitle || `Follow-up: ${note.content.substring(0, 50)}...`,\n        description: req.body.todoDescription || note.content,\n        category: \"other\",\n        assignedUserId: validatedData.assigneeId,\n        createdBy: req.user.id,\n        status: \"todo\",\n        priority: \"medium\",\n        dueDate: validatedData.dueAt,\n      });\n\n      // Create the NoteFollowup with the Todo link\n      const followup = await storage.createNoteFollowup({\n        ...validatedData,\n        todoId: todo.id,\n      });\n\n      await auditLog(req, \"CREATE\", \"note-followups\", followup.id, {\n        noteId,\n        todoId: todo.id,\n      });\n\n      res.status(201).json({ followup, todo });\n    } catch (error) {\n      console.error(\"Error creating note followup:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Invalid followup data\", details: error.errors });\n      } else {\n        res.status(400).json({ error: \"Failed to create note followup\" });\n      }\n    }\n  });\n\n  // GET /api/notes/:noteId/followups - Get note follow-ups\n  app.get(\"/api/notes/:noteId/followups\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const followups = await storage.getNoteFollowups(noteId);\n      res.json(followups);\n    } catch (error) {\n      console.error(\"Error fetching note followups:\", error);\n      res.status(500).json({ error: \"Failed to fetch note followups\" });\n    }\n  });\n\n  // Note Revisions Routes\n  // GET /api/notes/:noteId/revisions - Get note edit history\n  app.get(\"/api/notes/:noteId/revisions\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const revisions = await storage.getNoteRevisions(noteId);\n      res.json(revisions);\n    } catch (error) {\n      console.error(\"Error fetching note revisions:\", error);\n      res.status(500).json({ error: \"Failed to fetch note revisions\" });\n    }\n  });\n\n  // Note Templates Routes\n  // GET /api/note-templates - Get all templates\n  app.get(\"/api/note-templates\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { entityType } = req.query;\n      const templates = await storage.getNoteTemplates(entityType as string);\n      res.json(templates);\n    } catch (error) {\n      console.error(\"Error fetching note templates:\", error);\n      res.status(500).json({ error: \"Failed to fetch note templates\" });\n    }\n  });\n\n  // POST /api/note-templates - Create a template\n  app.post(\"/api/note-templates\", requireAuth, async (req: any, res: any) => {\n    try {\n      const validatedData = insertNoteTemplateSchema.parse({\n        ...req.body,\n        createdBy: req.user.id,\n      });\n\n      const template = await storage.createNoteTemplate(validatedData);\n\n      await auditLog(req, \"CREATE\", \"note-templates\", template.id, {\n        name: template.name,\n      });\n\n      res.status(201).json(template);\n    } catch (error) {\n      console.error(\"Error creating note template:\", error);\n      if (error instanceof z.ZodError) {\n        res.status(400).json({ error: \"Invalid template data\", details: error.errors });\n      } else {\n        res.status(400).json({ error: \"Failed to create note template\" });\n      }\n    }\n  });\n\n  // PATCH /api/note-templates/:id - Update a template\n  app.patch(\"/api/note-templates/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      const template = await storage.updateNoteTemplate(id, req.body);\n\n      await auditLog(req, \"UPDATE\", \"note-templates\", id, req.body);\n\n      res.json(template);\n    } catch (error) {\n      console.error(\"Error updating note template:\", error);\n      res.status(400).json({ error: \"Failed to update note template\" });\n    }\n  });\n\n  // DELETE /api/note-templates/:id - Delete a template\n  app.delete(\"/api/note-templates/:id\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { id } = req.params;\n      await storage.deleteNoteTemplate(id);\n\n      await auditLog(req, \"DELETE\", \"note-templates\", id);\n\n      res.json({ message: \"Template deleted successfully\" });\n    } catch (error) {\n      console.error(\"Error deleting note template:\", error);\n      res.status(400).json({ error: \"Failed to delete note template\" });\n    }\n  });\n\n  // Note Links Routes\n  // GET /api/notes/:noteId/links - Get note smart links\n  app.get(\"/api/notes/:noteId/links\", requireAuth, async (req: any, res: any) => {\n    try {\n      const { noteId } = req.params;\n      const links = await storage.getNoteLinks(noteId);\n      res.json(links);\n    } catch (error) {\n      console.error(\"Error fetching note links:\", error);\n      res.status(500).json({ error: \"Failed to fetch note links\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":172954},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-semibold ring-offset-background transition-all duration-300 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#FF6600] focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 active:scale-[0.98]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-[#FF6600] text-white hover:bg-[#FF6600]/90 shadow-soft hover:shadow-orange\",\n        primary: \"bg-[#FF6600] text-white hover:bg-[#FF6600]/90 shadow-soft hover:shadow-orange\",\n        secondary: \"bg-secondary text-secondary-foreground hover:bg-secondary/80 shadow-soft\",\n        outline: \"border border-border bg-background hover:bg-accent hover:text-accent-foreground\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        danger: \"bg-destructive text-destructive-foreground hover:bg-destructive/90 shadow-soft\",\n        link: \"text-[#FF6600] underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-lg px-3 text-xs\",\n        lg: \"h-11 rounded-lg px-6 text-base\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":2009},"client/src/components/email/email-thread-skeleton.tsx":{"content":"import { Skeleton } from \"@/components/ui/skeleton\";\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\";\n\nexport function EmailThreadSkeleton() {\n  return (\n    <div className=\"h-full p-6 space-y-4\" data-testid=\"email-thread-skeleton\">\n      {/* Header */}\n      <div className=\"space-y-3\">\n        <Skeleton className=\"h-8 w-3/4\" />\n        <div className=\"flex gap-2\">\n          <Skeleton className=\"h-6 w-16\" />\n          <Skeleton className=\"h-6 w-20\" />\n        </div>\n        <Skeleton className=\"h-4 w-48\" />\n      </div>\n\n      {/* Messages */}\n      <div className=\"space-y-4\">\n        {Array.from({ length: 2 }).map((_, i) => (\n          <Card key={i} className=\"border border-border\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center gap-3\">\n                <Skeleton className=\"h-10 w-10 rounded-full\" />\n                <div className=\"flex-1 space-y-2\">\n                  <Skeleton className=\"h-4 w-32\" />\n                  <Skeleton className=\"h-3 w-24\" />\n                </div>\n                <Skeleton className=\"h-3 w-16\" />\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-2\">\n                <Skeleton className=\"h-4 w-full\" />\n                <Skeleton className=\"h-4 w-full\" />\n                <Skeleton className=\"h-4 w-3/4\" />\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    </div>\n  );\n}\n","size_bytes":1483},"client/src/components/todos/task-detail-modal.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  Edit,\n  Trash2,\n  Calendar,\n  User,\n  CheckCircle,\n  Clock,\n  AlertCircle,\n  FileText,\n  MessageSquare,\n  Activity,\n  Paperclip,\n  Package,\n  Wrench,\n  Mail,\n  UserCircle,\n  Folder,\n} from \"lucide-react\";\nimport { format, formatDistanceToNow } from \"date-fns\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Todo, User as UserType, Order, Case, Repair, Customer } from \"@/lib/types\";\nimport { TodoForm } from \"@/components/forms/todo-form\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\n\ninterface TaskDetailModalProps {\n  todo: Todo | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  onUpdate?: () => void;\n}\n\nexport function TaskDetailModal({ todo, open, onOpenChange, onUpdate }: TaskDetailModalProps) {\n  const [showEditForm, setShowEditForm] = useState(false);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const { toast } = useToast();\n\n  const { data: users } = useQuery<UserType[]>({\n    queryKey: [\"/api/users/list\"],\n    enabled: !!todo,\n  });\n\n  const { data: linkedOrder } = useQuery<Order>({\n    queryKey: [\"/api/orders\", todo?.orderId],\n    enabled: !!todo?.orderId,\n  });\n\n  const { data: linkedCase } = useQuery<Case>({\n    queryKey: [\"/api/cases\", todo?.caseId],\n    enabled: !!todo?.caseId,\n  });\n\n  const { data: linkedRepair } = useQuery<Repair>({\n    queryKey: [\"/api/repairs\", todo?.repairId],\n    enabled: !!todo?.repairId,\n  });\n\n  const { data: linkedCustomer } = useQuery<Customer>({\n    queryKey: [\"/api/customers\", todo?.customerId],\n    enabled: !!todo?.customerId,\n  });\n\n  const deleteTodoMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await fetch(`/api/todos/${id}`, { method: \"DELETE\" });\n      if (!response.ok) throw new Error(\"Failed to delete todo\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/todos\"] });\n      toast({\n        title: \"Task deleted\",\n        description: \"Task has been deleted successfully\",\n      });\n      onOpenChange(false);\n      onUpdate?.();\n    },\n    onError: () => {\n      toast({\n        title: \"Delete failed\",\n        description: \"Failed to delete task\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleDelete = () => {\n    if (todo) {\n      deleteTodoMutation.mutate(todo.id);\n    }\n  };\n\n  const getAssignedUser = () => {\n    if (!todo || !users) return null;\n    return users.find(u => u.id === todo.assignedUserId);\n  };\n\n  const getCreatedByUser = () => {\n    if (!todo || !users) return null;\n    return users.find(u => u.id === todo.createdBy);\n  };\n\n  const getPriorityVariant = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"destructive\";\n      case \"high\":\n        return \"destructive\";\n      case \"medium\":\n        return \"secondary\";\n      case \"low\":\n        return \"outline\";\n      default:\n        return \"secondary\";\n    }\n  };\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"done\":\n        return \"default\";\n      case \"in_progress\":\n        return \"secondary\";\n      case \"todo\":\n        return \"outline\";\n      default:\n        return \"outline\";\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \"done\":\n        return <CheckCircle className=\"h-4 w-4\" />;\n      case \"in_progress\":\n        return <Clock className=\"h-4 w-4\" />;\n      case \"todo\":\n        return <AlertCircle className=\"h-4 w-4\" />;\n      default:\n        return <AlertCircle className=\"h-4 w-4\" />;\n    }\n  };\n\n  const formatCategoryLabel = (category: string) => {\n    const labels: Record<string, string> = {\n      orders: \"Orders\",\n      purchasing: \"Purchasing\",\n      marketing: \"Marketing\",\n      admin: \"Admin\",\n      other: \"Other\",\n    };\n    return labels[category] || category;\n  };\n\n  // Generate simple activity timeline from todo data\n  const getActivityTimeline = () => {\n    if (!todo) return [];\n\n    const timeline = [];\n\n    // Task created\n    if (todo.createdAt) {\n      timeline.push({\n        icon: <FileText className=\"h-4 w-4\" />,\n        title: \"Task created\",\n        description: `Task was created${getCreatedByUser() ? ` by ${getCreatedByUser()?.firstName} ${getCreatedByUser()?.lastName}` : \"\"}`,\n        timestamp: todo.createdAt,\n      });\n    }\n\n    // Task completed\n    if (todo.completedAt) {\n      timeline.push({\n        icon: <CheckCircle className=\"h-4 w-4\" />,\n        title: \"Task completed\",\n        description: \"Task was marked as complete\",\n        timestamp: todo.completedAt,\n      });\n    }\n\n    // Sort by timestamp descending (most recent first)\n    return timeline.sort((a, b) => \n      new Date(b.timestamp as unknown as string).getTime() - new Date(a.timestamp as unknown as string).getTime()\n    );\n  };\n\n  if (showEditForm && todo) {\n    return (\n      <TodoForm\n        open={showEditForm}\n        onOpenChange={(open) => {\n          setShowEditForm(open);\n          if (!open) {\n            onUpdate?.();\n          }\n        }}\n        todo={todo}\n      />\n    );\n  }\n\n  return (\n    <>\n      <Dialog open={open} onOpenChange={onOpenChange}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"task-detail-modal\">\n          <DialogHeader>\n            <div className=\"flex items-start justify-between\">\n              <div className=\"flex-1\">\n                <DialogTitle className=\"text-2xl flex items-center gap-2\" data-testid=\"task-title\">\n                  {todo ? (\n                    <>\n                      {getStatusIcon(todo.status || 'todo')}\n                      {todo.title}\n                    </>\n                  ) : (\n                    \"Loading...\"\n                  )}\n                </DialogTitle>\n                {todo && (\n                  <DialogDescription className=\"mt-2\" data-testid=\"task-meta\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <Badge variant={getStatusVariant(todo.status || 'todo')} data-testid=\"task-status-badge\">\n                        {(todo.status || 'todo').replace('_', ' ').toUpperCase()}\n                      </Badge>\n                      <Badge variant={getPriorityVariant(todo.priority || 'medium')} data-testid=\"task-priority-badge\">\n                        {(todo.priority || 'medium').toUpperCase()}\n                      </Badge>\n                      {todo.category && (\n                        <Badge variant=\"outline\" data-testid=\"task-category-badge\">\n                          <Folder className=\"h-3 w-3 mr-1\" />\n                          {formatCategoryLabel(todo.category)}\n                        </Badge>\n                      )}\n                    </div>\n                  </DialogDescription>\n                )}\n              </div>\n              {todo && (\n                <div className=\"flex items-center gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setShowEditForm(true)}\n                    data-testid=\"edit-task-button\"\n                  >\n                    <Edit className=\"h-4 w-4 mr-2\" />\n                    Edit\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setShowDeleteDialog(true)}\n                    data-testid=\"delete-task-button\"\n                  >\n                    <Trash2 className=\"h-4 w-4 mr-2\" />\n                    Delete\n                  </Button>\n                </div>\n              )}\n            </div>\n          </DialogHeader>\n\n          {!todo ? (\n            <div className=\"flex items-center justify-center py-12\" data-testid=\"task-loading\">\n              <div className=\"text-center\">\n                <Clock className=\"h-12 w-12 mx-auto mb-4 text-muted-foreground animate-pulse\" />\n                <p className=\"text-muted-foreground\">Loading task details...</p>\n              </div>\n            </div>\n          ) : (\n            <Tabs defaultValue=\"details\" className=\"w-full mt-4\">\n              <TabsList className=\"grid w-full grid-cols-4\" data-testid=\"task-tabs\">\n                <TabsTrigger value=\"details\" data-testid=\"details-tab\">\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  Details\n                </TabsTrigger>\n                <TabsTrigger value=\"comments\" data-testid=\"comments-tab\">\n                  <MessageSquare className=\"h-4 w-4 mr-2\" />\n                  Comments\n                </TabsTrigger>\n                <TabsTrigger value=\"activity\" data-testid=\"activity-tab\">\n                  <Activity className=\"h-4 w-4 mr-2\" />\n                  Activity\n                </TabsTrigger>\n                <TabsTrigger value=\"attachments\" data-testid=\"attachments-tab\">\n                  <Paperclip className=\"h-4 w-4 mr-2\" />\n                  Attachments\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"details\" className=\"space-y-4 mt-4\" data-testid=\"details-content\">\n                <Card>\n                  <CardContent className=\"pt-6 space-y-6\">\n                    {/* Description */}\n                    <div>\n                      <label className=\"text-sm font-medium text-muted-foreground\">Description</label>\n                      <p className=\"mt-2 text-sm whitespace-pre-wrap\" data-testid=\"task-description\">\n                        {todo.description || \"No description provided\"}\n                      </p>\n                    </div>\n\n                    <Separator />\n\n                    {/* Task Info Grid */}\n                    <div className=\"grid grid-cols-2 gap-6\">\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n                          <User className=\"h-4 w-4\" />\n                          Assigned To\n                        </label>\n                        <p className=\"mt-2 text-sm\" data-testid=\"task-assigned-user\">\n                          {getAssignedUser() ? (\n                            `${getAssignedUser()?.firstName} ${getAssignedUser()?.lastName}`\n                          ) : (\n                            \"Unassigned\"\n                          )}\n                        </p>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n                          <UserCircle className=\"h-4 w-4\" />\n                          Created By\n                        </label>\n                        <p className=\"mt-2 text-sm\" data-testid=\"task-created-by\">\n                          {getCreatedByUser() ? (\n                            `${getCreatedByUser()?.firstName} ${getCreatedByUser()?.lastName}`\n                          ) : (\n                            \"Unknown\"\n                          )}\n                        </p>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n                          <Calendar className=\"h-4 w-4\" />\n                          Due Date\n                        </label>\n                        <p className=\"mt-2 text-sm\" data-testid=\"task-due-date\">\n                          {todo.dueDate ? (\n                            <>\n                              {format(new Date(todo.dueDate), \"PPP\")}\n                              <span className=\"text-muted-foreground ml-2\">\n                                ({formatDistanceToNow(new Date(todo.dueDate), { addSuffix: true })})\n                              </span>\n                            </>\n                          ) : (\n                            \"No due date\"\n                          )}\n                        </p>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n                          <CheckCircle className=\"h-4 w-4\" />\n                          Completion Date\n                        </label>\n                        <p className=\"mt-2 text-sm\" data-testid=\"task-completed-at\">\n                          {todo.completedAt ? (\n                            format(new Date(todo.completedAt), \"PPP 'at' p\")\n                          ) : (\n                            \"Not completed\"\n                          )}\n                        </p>\n                      </div>\n                    </div>\n\n                    {/* Linked Entities */}\n                    {(linkedOrder || linkedCase || linkedRepair || linkedCustomer) && (\n                      <>\n                        <Separator />\n                        <div>\n                          <label className=\"text-sm font-medium text-muted-foreground mb-3 block\">\n                            Linked Entities\n                          </label>\n                          <div className=\"space-y-2\">\n                            {linkedOrder && (\n                              <div className=\"flex items-center gap-2 p-3 border rounded-lg\" data-testid=\"linked-order\">\n                                <Package className=\"h-4 w-4 text-muted-foreground\" />\n                                <div className=\"flex-1\">\n                                  <p className=\"text-sm font-medium\">Order #{linkedOrder.orderNumber}</p>\n                                  <p className=\"text-xs text-muted-foreground\">{linkedOrder.customerEmail}</p>\n                                </div>\n                                <Badge variant=\"outline\">{linkedOrder.status}</Badge>\n                              </div>\n                            )}\n\n                            {linkedCase && (\n                              <div className=\"flex items-center gap-2 p-3 border rounded-lg\" data-testid=\"linked-case\">\n                                <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                                <div className=\"flex-1\">\n                                  <p className=\"text-sm font-medium\">{linkedCase.title}</p>\n                                  <p className=\"text-xs text-muted-foreground\">Case #{linkedCase.caseNumber}</p>\n                                </div>\n                                <Badge variant=\"outline\">{linkedCase.status}</Badge>\n                              </div>\n                            )}\n\n                            {linkedRepair && (\n                              <div className=\"flex items-center gap-2 p-3 border rounded-lg\" data-testid=\"linked-repair\">\n                                <Wrench className=\"h-4 w-4 text-muted-foreground\" />\n                                <div className=\"flex-1\">\n                                  <p className=\"text-sm font-medium\">{linkedRepair.title}</p>\n                                  <p className=\"text-xs text-muted-foreground\">Repair</p>\n                                </div>\n                                <Badge variant=\"outline\">{linkedRepair.status}</Badge>\n                              </div>\n                            )}\n\n                            {linkedCustomer && (\n                              <div className=\"flex items-center gap-2 p-3 border rounded-lg\" data-testid=\"linked-customer\">\n                                <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                                <div className=\"flex-1\">\n                                  <p className=\"text-sm font-medium\">\n                                    {linkedCustomer.firstName} {linkedCustomer.lastName}\n                                  </p>\n                                  <p className=\"text-xs text-muted-foreground\">{linkedCustomer.email}</p>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"comments\" className=\"mt-4\" data-testid=\"comments-content\">\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"text-center py-12\" data-testid=\"no-comments\">\n                      <MessageSquare className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground/50\" />\n                      <p className=\"text-sm text-muted-foreground\">Comments not yet available for tasks</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Task comments feature coming soon\n                      </p>\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"activity\" className=\"mt-4\" data-testid=\"activity-content\">\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    {getActivityTimeline().length > 0 ? (\n                      <div className=\"space-y-4\">\n                        {getActivityTimeline().map((event, index) => (\n                          <div key={index} className=\"flex items-start gap-4\" data-testid={`activity-item-${index}`}>\n                            <div className=\"mt-1 p-2 rounded-full bg-muted\">\n                              {event.icon}\n                            </div>\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm font-medium\">{event.title}</p>\n                              <p className=\"text-sm text-muted-foreground\">{event.description}</p>\n                              <p className=\"text-xs text-muted-foreground mt-1\">\n                                {formatDistanceToNow(new Date(event.timestamp as unknown as string), { addSuffix: true })}\n                              </p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"text-center py-12\" data-testid=\"no-activity\">\n                        <Activity className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground/50\" />\n                        <p className=\"text-sm text-muted-foreground\">No activity recorded yet</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"attachments\" className=\"mt-4\" data-testid=\"attachments-content\">\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"text-center py-12\" data-testid=\"no-attachments\">\n                      <Paperclip className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground/50\" />\n                      <p className=\"text-sm text-muted-foreground\">No attachments available</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Attachment support coming soon\n                      </p>\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n            </Tabs>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent data-testid=\"delete-confirmation-dialog\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This action cannot be undone. This will permanently delete the task\n              \"{todo?.title}\".\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"cancel-delete-button\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"confirm-delete-button\"\n            >\n              {deleteTodoMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </>\n  );\n}\n","size_bytes":21023},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/email/sanitized-email-content.tsx":{"content":"import DOMPurify from 'isomorphic-dompurify';\n// @ts-ignore - no types available\nimport { decode as decodeQuotedPrintable } from 'quoted-printable';\nimport { decode as decodeBase64 } from 'js-base64';\n\ninterface SanitizedEmailContentProps {\n  body: string;\n  isHtml: boolean;\n  encoding?: string;\n}\n\nexport function SanitizedEmailContent({ body, isHtml, encoding }: SanitizedEmailContentProps) {\n  if (!body) {\n    return (\n      <div className=\"text-muted-foreground italic\">\n        No content available\n      </div>\n    );\n  }\n\n  const decodeEmailBody = (rawData: string, transferEncoding?: string): string => {\n    let decoded = rawData;\n\n    // Step 1: Remove multipart boundaries and MIME headers first\n    // This prevents them from interfering with decoding\n    const lines = decoded.split('\\n');\n    const cleanedLines: string[] = [];\n    let skipUntilEmpty = false;\n    let inMimeHeaders = true;\n    \n    for (let i = 0; i < lines.length; i++) {\n      const line = lines[i];\n      const trimmedLine = line.trim();\n      \n      // Skip multipart boundaries\n      if (trimmedLine.startsWith('--') && trimmedLine.length > 10) {\n        skipUntilEmpty = true;\n        continue;\n      }\n      \n      // Skip MIME headers at the beginning\n      if (inMimeHeaders) {\n        if (trimmedLine === '') {\n          inMimeHeaders = false;\n          continue;\n        }\n        if (trimmedLine.match(/^[A-Za-z-]+:\\s*.+/)) {\n          continue;\n        }\n        inMimeHeaders = false;\n      }\n      \n      // Skip lines after boundary until we hit content\n      if (skipUntilEmpty) {\n        if (trimmedLine === '' || trimmedLine.match(/^[A-Za-z-]+:\\s*.+/)) {\n          continue;\n        }\n        skipUntilEmpty = false;\n      }\n      \n      // Skip standalone MIME headers anywhere in content\n      if (trimmedLine.match(/^(Content-Type|Content-Transfer-Encoding|Content-Disposition|Mime-Version|charset):/i)) {\n        continue;\n      }\n      \n      cleanedLines.push(line);\n    }\n    \n    decoded = cleanedLines.join('\\n').trim();\n\n    // Step 2: Base64 decode if needed\n    if (transferEncoding?.toLowerCase() === 'base64' || \n        (!decoded.includes('<') && !decoded.includes('=') && decoded.length > 100 && /^[A-Za-z0-9+/=\\s]+$/.test(decoded.substring(0, 200)))) {\n      try {\n        const cleanBase64 = decoded.replace(/\\s/g, '');\n        if (cleanBase64.length > 0) {\n          decoded = decodeBase64(cleanBase64);\n        }\n      } catch (e) {\n        console.error('Error decoding base64:', e);\n      }\n    }\n\n    // Step 3: Quoted-printable decode if detected\n    if (transferEncoding?.toLowerCase() === 'quoted-printable' ||\n        decoded.includes('=0A') || decoded.includes('=3D') || /=[0-9A-F]{2}/.test(decoded)) {\n      try {\n        decoded = decodeQuotedPrintable(decoded);\n      } catch (e) {\n        console.error('Error decoding quoted-printable:', e);\n      }\n    }\n\n    // Step 4: Remove any remaining MIME artifacts\n    decoded = decoded.replace(/--[a-zA-Z0-9_-]{10,}(--)?[\\r\\n]*/g, '');\n    decoded = decoded.replace(/^(Content-Type|Content-Transfer-Encoding|Content-Disposition|Mime-Version):[^\\n]*\\n?/gim, '');\n    decoded = decoded.replace(/charset=\"?[^\"\\n]*\"?/gi, '');\n    \n    // Step 5: Clean up excessive whitespace\n    decoded = decoded.replace(/\\n{3,}/g, '\\n\\n');\n    decoded = decoded.trim();\n\n    return decoded;\n  };\n\n  // Decode the email body with encoding hint\n  const decodedBody = decodeEmailBody(body, encoding);\n\n  // Check if this is HTML content\n  const isActuallyHtml = isHtml || \n    decodedBody.includes('<!DOCTYPE') || \n    decodedBody.includes('<html') || \n    decodedBody.includes('<body') ||\n    decodedBody.includes('<div') || \n    decodedBody.includes('<p>') ||\n    decodedBody.includes('<table');\n\n  // Render plain text emails\n  if (!isActuallyHtml) {\n    return (\n      <div className=\"whitespace-pre-wrap text-sm leading-relaxed text-foreground break-words\">\n        {decodedBody}\n      </div>\n    );\n  }\n\n  // Sanitize and render HTML emails\n  const sanitizeHtml = (html: string): string => {\n    const config = {\n      ALLOWED_TAGS: [\n        'p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',\n        'ul', 'ol', 'li', 'a', 'img', 'div', 'span', 'table', 'thead', 'tbody',\n        'tr', 'td', 'th', 'blockquote', 'code', 'pre', 'hr', 'b', 'i', 'font',\n        'center', 'small', 'big', 'sub', 'sup', 'strike', 's', 'del'\n      ],\n      ALLOWED_ATTR: [\n        'href', 'src', 'alt', 'title', 'target', 'rel', 'width', 'height',\n        'align', 'valign', 'bgcolor', 'color', 'size', 'face', 'border',\n        'cellpadding', 'cellspacing', 'style'\n      ],\n      ALLOWED_STYLES: {\n        '*': {\n          'color': [/^#[0-9a-fA-F]{3,6}$/, /^rgb\\(/, /^rgba\\(/],\n          'background-color': [/^#[0-9a-fA-F]{3,6}$/, /^rgb\\(/, /^rgba\\(/],\n          'font-size': [/^\\d+px$/, /^\\d+em$/, /^\\d+%$/],\n          'font-family': [/.*/],\n          'font-weight': [/^(normal|bold|\\d{3})$/],\n          'text-align': [/^(left|right|center|justify)$/],\n          'padding': [/^\\d+px$/],\n          'margin': [/^\\d+px$/],\n          'border': [/.*/],\n          'text-decoration': [/^(none|underline|line-through)$/]\n        }\n      },\n      ALLOW_DATA_ATTR: false,\n      ADD_ATTR: ['target'],\n      FORCE_BODY: true,\n    };\n\n    let cleanHtml = html;\n\n    // Remove style tags but keep inline styles for basic formatting\n    cleanHtml = cleanHtml.replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '');\n    \n    // Remove script tags\n    cleanHtml = cleanHtml.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '');\n    \n    // Convert common entities\n    cleanHtml = cleanHtml.replace(/&nbsp;/g, ' ');\n    \n    // Ensure all links open in new tab\n    cleanHtml = cleanHtml.replace(/<a\\s/gi, '<a target=\"_blank\" rel=\"noopener noreferrer\" ');\n\n    const sanitized = DOMPurify.sanitize(cleanHtml, config);\n    return sanitized;\n  };\n\n  const sanitized = sanitizeHtml(decodedBody);\n\n  if (!sanitized || sanitized.trim().length === 0) {\n    return (\n      <div className=\"text-muted-foreground italic text-sm\">\n        Email content could not be displayed\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"overflow-x-auto max-w-full\">\n      <style>{`\n        .email-content-wrapper table {\n          max-width: 100% !important;\n          width: auto !important;\n          table-layout: auto !important;\n        }\n        .email-content-wrapper td,\n        .email-content-wrapper th {\n          max-width: 300px !important;\n          word-wrap: break-word !important;\n          word-break: break-word !important;\n          overflow-wrap: anywhere !important;\n        }\n        .email-content-wrapper * {\n          max-width: 100% !important;\n        }\n      `}</style>\n      <div \n        className=\"email-content-wrapper prose prose-sm max-w-none dark:prose-invert\n          prose-p:my-2 prose-p:leading-relaxed\n          prose-headings:mt-4 prose-headings:mb-2 prose-headings:font-semibold\n          prose-ul:my-2 prose-ol:my-2 prose-ul:pl-4 prose-ol:pl-4\n          prose-li:my-1\n          prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline prose-a:break-words\n          prose-img:rounded-md prose-img:shadow-sm prose-img:max-w-full prose-img:h-auto\n          prose-blockquote:border-l-4 prose-blockquote:border-gray-300 dark:prose-blockquote:border-gray-600 prose-blockquote:pl-4 prose-blockquote:italic\n          prose-code:bg-gray-100 dark:prose-code:bg-gray-800 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:break-words prose-code:text-sm\n          prose-pre:bg-gray-100 dark:prose-pre:bg-gray-800 prose-pre:p-3 prose-pre:rounded-md prose-pre:overflow-x-auto\n          prose-hr:my-4 prose-hr:border-gray-300 dark:prose-hr:border-gray-600\n          prose-table:border-collapse prose-table:max-w-full prose-table:my-4 prose-table:table-auto\n          prose-td:border prose-td:border-gray-300 dark:prose-td:border-gray-600 prose-td:px-2 prose-td:py-1 prose-td:text-xs\n          prose-th:border prose-th:border-gray-300 dark:prose-th:border-gray-600 prose-th:px-2 prose-th:py-1 prose-th:bg-gray-100 dark:prose-th:bg-gray-800 prose-th:text-xs\n          text-foreground\n          break-words overflow-wrap-anywhere\n        \"\n        style={{ \n          wordBreak: 'break-word', \n          overflowWrap: 'anywhere',\n          maxWidth: '100%' \n        }}\n        dangerouslySetInnerHTML={{ __html: sanitized }}\n      />\n    </div>\n  );\n}\n","size_bytes":8447},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, timestamp, integer, boolean, jsonb, pgEnum } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Enums\nexport const userRoleEnum = pgEnum(\"user_role\", [\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"]);\nexport const priorityEnum = pgEnum(\"priority\", [\"low\", \"medium\", \"high\", \"urgent\"]);\nexport const repairStatusEnum = pgEnum(\"repair_status\", [\"new\", \"diagnosing\", \"waiting_parts\", \"repair_in_progress\", \"quality_check\", \"completed\", \"returned\", \"canceled\"]);\nexport const todoStatusEnum = pgEnum(\"todo_status\", [\"todo\", \"in_progress\", \"done\"]);\nexport const todoCategoryEnum = pgEnum(\"todo_category\", [\"orders\", \"purchasing\", \"marketing\", \"admin\", \"other\"]);\nexport const emailStatusEnum = pgEnum(\"email_status\", [\"open\", \"closed\"]);\nexport const emailFolderEnum = pgEnum(\"email_folder\", [\"inbox\", \"sent\"]);\nexport const orderStatusEnum = pgEnum(\"order_status\", [\"pending\", \"processing\", \"shipped\", \"delivered\", \"cancelled\", \"refunded\"]);\nexport const purchaseOrderStatusEnum = pgEnum(\"purchase_order_status\", [\"aangekocht\", \"ontvangen\", \"verwerkt\"]);\nexport const caseStatusEnum = pgEnum(\"case_status\", [\"new\", \"in_progress\", \"waiting_customer\", \"resolved\"]);\nexport const caseEventTypeEnum = pgEnum(\"case_event_type\", [\"created\", \"status_change\", \"note_added\", \"link_added\", \"link_removed\", \"sla_set\", \"assigned\", \"email_sent\", \"email_received\"]);\nexport const caseLinkTypeEnum = pgEnum(\"case_link_type\", [\"order\", \"email\", \"repair\", \"todo\", \"return\"]);\nexport const returnStatusEnum = pgEnum(\"return_status\", [\"nieuw_onderweg\", \"ontvangen_controle\", \"akkoord_terugbetaling\", \"vermiste_pakketten\", \"wachten_klant\", \"opnieuw_versturen\", \"klaar\", \"niet_ontvangen\"]);\nexport const returnReasonEnum = pgEnum(\"return_reason\", [\"wrong_item\", \"damaged\", \"defective\", \"size_issue\", \"changed_mind\", \"other\"]);\nexport const refundStatusEnum = pgEnum(\"refund_status\", [\"pending\", \"processing\", \"completed\", \"failed\"]);\nexport const refundMethodEnum = pgEnum(\"refund_method\", [\"original_payment\", \"store_credit\", \"exchange\"]);\n\n// Users table\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  email: text(\"email\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  role: userRoleEnum(\"role\").notNull().default(\"SUPPORT\"),\n  firstName: text(\"first_name\"),\n  lastName: text(\"last_name\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Customers table\nexport const customers = pgTable(\"customers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: text(\"email\").notNull().unique(),\n  firstName: text(\"first_name\"),\n  lastName: text(\"last_name\"),\n  phone: text(\"phone\"),\n  shopifyCustomerId: text(\"shopify_customer_id\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Orders table (synced from Shopify)\nexport const orders = pgTable(\"orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  shopifyOrderId: text(\"shopify_order_id\").notNull().unique(),\n  orderNumber: text(\"order_number\").notNull(),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  customerEmail: text(\"customer_email\"),\n  totalAmount: integer(\"total_amount\"), // in cents\n  currency: text(\"currency\").default(\"EUR\"),\n  status: orderStatusEnum(\"status\").notNull(),\n  fulfillmentStatus: text(\"fulfillment_status\"),\n  paymentStatus: text(\"payment_status\"),\n  orderData: jsonb(\"order_data\"), // raw Shopify order data\n  orderDate: timestamp(\"order_date\"), // Actual order date from Shopify\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Email threads table\nexport const emailThreads = pgTable(\"email_threads\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  threadId: text(\"thread_id\").notNull().unique(), // from email provider\n  subject: text(\"subject\"),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  customerEmail: text(\"customer_email\"),\n  assignedUserId: varchar(\"assigned_user_id\").references(() => users.id),\n  status: emailStatusEnum(\"status\").notNull().default(\"open\"),\n  priority: priorityEnum(\"priority\").default(\"medium\"),\n  hasAttachment: boolean(\"has_attachment\").default(false),\n  isUnread: boolean(\"is_unread\").default(true),\n  folder: emailFolderEnum(\"folder\").notNull().default(\"inbox\"),\n  starred: boolean(\"starred\").default(false),\n  archived: boolean(\"archived\").default(false),\n  lastActivity: timestamp(\"last_activity\").defaultNow(),\n  slaDeadline: timestamp(\"sla_deadline\"),\n  orderId: varchar(\"order_id\").references(() => orders.id),\n  caseId: varchar(\"case_id\").references(() => cases.id), // Link email threads to cases\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Email messages table\nexport const emailMessages = pgTable(\"email_messages\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  messageId: text(\"message_id\").notNull().unique(), // from email provider\n  threadId: varchar(\"thread_id\").references(() => emailThreads.id).notNull(),\n  fromEmail: text(\"from_email\").notNull(),\n  toEmail: text(\"to_email\").notNull(),\n  subject: text(\"subject\"),\n  body: text(\"body\"),\n  isHtml: boolean(\"is_html\").default(false),\n  isOutbound: boolean(\"is_outbound\").default(false),\n  folder: emailFolderEnum(\"folder\").notNull().default(\"inbox\"),\n  attachments: jsonb(\"attachments\"), // array of attachment metadata\n  rawData: jsonb(\"raw_data\"), // raw email data\n  sentAt: timestamp(\"sent_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Repairs table\nexport const repairs = pgTable(\"repairs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  productSku: text(\"product_sku\"),\n  productName: text(\"product_name\"),\n  issueCategory: text(\"issue_category\"),\n  customerName: text(\"customer_name\"), // Direct customer name for display\n  customerEmail: text(\"customer_email\"), // Direct customer email for display\n  orderNumber: text(\"order_number\"), // Direct order number for display\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  orderId: varchar(\"order_id\").references(() => orders.id),\n  emailThreadId: varchar(\"email_thread_id\").references(() => emailThreads.id),\n  assignedUserId: varchar(\"assigned_user_id\").references(() => users.id),\n  status: repairStatusEnum(\"status\").notNull().default(\"new\"),\n  priority: priorityEnum(\"priority\").default(\"medium\"),\n  estimatedCost: integer(\"estimated_cost\"), // in cents\n  actualCost: integer(\"actual_cost\"), // in cents\n  partsNeeded: text(\"parts_needed\").array(),\n  partsUsed: jsonb(\"parts_used\"), // array of {name, cost, quantity}\n  photos: text(\"photos\").array(), // URLs to stored photos\n  attachments: text(\"attachments\").array(), // URLs to other file attachments\n  timeline: jsonb(\"timeline\"), // array of status updates\n  slaDeadline: timestamp(\"sla_deadline\"),\n  completedAt: timestamp(\"completed_at\"),\n  returnedAt: timestamp(\"returned_at\"),\n  caseId: varchar(\"case_id\").references(() => cases.id), // Link repairs to cases\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Todos table\nexport const todos = pgTable(\"todos\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  category: todoCategoryEnum(\"category\").default(\"other\"),\n  assignedUserId: varchar(\"assigned_user_id\").references(() => users.id).notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id).notNull(),\n  status: todoStatusEnum(\"status\").notNull().default(\"todo\"),\n  priority: priorityEnum(\"priority\").default(\"medium\"),\n  dueDate: timestamp(\"due_date\"),\n  // Linkable to various entities\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  orderId: varchar(\"order_id\").references(() => orders.id),\n  repairId: varchar(\"repair_id\").references(() => repairs.id),\n  emailThreadId: varchar(\"email_thread_id\").references(() => emailThreads.id),\n  caseId: varchar(\"case_id\").references(() => cases.id), // Link todos to cases\n  returnId: varchar(\"return_id\").references(() => returns.id), // Link todos to returns\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Internal notes table\nexport const internalNotes = pgTable(\"internal_notes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  content: text(\"content\").notNull(),\n  authorId: varchar(\"author_id\").references(() => users.id).notNull(),\n  // Can be attached to various entities\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  orderId: varchar(\"order_id\").references(() => orders.id),\n  repairId: varchar(\"repair_id\").references(() => repairs.id),\n  emailThreadId: varchar(\"email_thread_id\").references(() => emailThreads.id),\n  caseId: varchar(\"case_id\").references(() => cases.id), // Link notes to cases\n  returnId: varchar(\"return_id\").references(() => returns.id), // Link notes to returns\n  mentions: text(\"mentions\").array(), // user IDs mentioned in the note\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Email attachments table\nexport const emailAttachments = pgTable(\"email_attachments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  messageId: varchar(\"message_id\").references(() => emailMessages.id).notNull(),\n  filename: text(\"filename\").notNull(),\n  contentType: text(\"content_type\"),\n  size: integer(\"size\"), // in bytes\n  storageUrl: text(\"storage_url\").notNull(), // path in object storage\n  contentId: text(\"content_id\"), // for inline attachments\n  isInline: boolean(\"is_inline\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Cases table - Central overarching object for customer requests\nexport const cases = pgTable(\"cases\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  description: text(\"description\"),\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  customerEmail: text(\"customer_email\"),\n  orderId: varchar(\"order_id\").references(() => orders.id), // Primary order link\n  assignedUserId: varchar(\"assigned_user_id\").references(() => users.id),\n  status: caseStatusEnum(\"status\").notNull().default(\"new\"),\n  priority: priorityEnum(\"priority\").default(\"medium\"),\n  caseNumber: text(\"case_number\").notNull().unique(), // Auto-generated case number\n  timeline: jsonb(\"timeline\"), // Chronological log of all activities\n  slaDeadline: timestamp(\"sla_deadline\"),\n  resolvedAt: timestamp(\"resolved_at\"),\n  closedAt: timestamp(\"closed_at\"),\n  archived: boolean(\"archived\").default(false), // Archive status\n  archivedAt: timestamp(\"archived_at\"), // When the case was archived\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Case Links table - Links cases to related entities\nexport const caseLinks = pgTable(\"case_links\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  caseId: varchar(\"case_id\").references(() => cases.id).notNull(),\n  linkType: caseLinkTypeEnum(\"link_type\").notNull(),\n  linkedId: varchar(\"linked_id\").notNull(), // ID of the linked entity (order, email, repair, or todo)\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Case Notes table - Internal notes for cases\nexport const caseNotes = pgTable(\"case_notes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  caseId: varchar(\"case_id\").references(() => cases.id).notNull(),\n  content: text(\"content\").notNull(),\n  createdBy: varchar(\"created_by\").references(() => users.id).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Case Events table - Timeline of all case activities\nexport const caseEvents = pgTable(\"case_events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  caseId: varchar(\"case_id\").references(() => cases.id).notNull(),\n  eventType: caseEventTypeEnum(\"event_type\").notNull(),\n  message: text(\"message\").notNull(), // Description of what happened\n  metadata: jsonb(\"metadata\"), // Additional context (e.g., old/new values for status changes)\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Case Items table - Specific items from linked order with notes\nexport const caseItems = pgTable(\"case_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  caseId: varchar(\"case_id\").references(() => cases.id, { onDelete: \"cascade\" }).notNull(),\n  \n  sku: text(\"sku\"),\n  productName: text(\"product_name\").notNull(),\n  quantity: integer(\"quantity\").notNull().default(1),\n  unitPrice: integer(\"unit_price\"), // in cents\n  imageUrl: text(\"image_url\"),\n  notes: text(\"notes\"), // User-entered notes like \"camera broken\", \"didn't arrive\"\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// System Settings table - for tracking system-wide configurations like last sync times\nexport const systemSettings = pgTable(\"system_settings\", {\n  key: text(\"key\").primaryKey(),\n  value: text(\"value\").notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Suppliers table\nexport const suppliers = pgTable(\"suppliers\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  supplierCode: text(\"supplier_code\").notNull().unique(), // Relatiecode\n  name: text(\"name\").notNull(), // Naam\n  contactPerson: text(\"contact_person\"), // Contactpersoon\n  email: text(\"email\"),\n  phone: text(\"phone\"), // Telefoon\n  mobile: text(\"mobile\"), // Mobiele telefoon\n  address: text(\"address\"), // Adres\n  postalCode: text(\"postal_code\"), // Postcode\n  city: text(\"city\"), // Plaats\n  website: text(\"website\"), // Website url\n  kvkNumber: text(\"kvk_number\"), // Kvk nummer\n  vatNumber: text(\"vat_number\"), // Btw nummer\n  iban: text(\"iban\"),\n  bic: text(\"bic\"),\n  bankAccount: text(\"bank_account\"), // Bankrekeningnummer\n  paymentTerms: integer(\"payment_terms\").default(0), // Krediettermijn in days\n  correspondenceAddress: text(\"correspondence_address\"), // Correspondentie adres\n  correspondencePostalCode: text(\"correspondence_postal_code\"),\n  correspondenceCity: text(\"correspondence_city\"),\n  correspondenceContact: text(\"correspondence_contact\"),\n  notes: text(\"notes\"), // Memo\n  active: boolean(\"active\").default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Purchase Orders table\nexport const purchaseOrders = pgTable(\"purchase_orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  poNumber: text(\"po_number\").notNull().unique(), // Auto-generated PO number\n  title: text(\"title\").notNull(),\n  supplierNumber: text(\"supplier_number\").notNull(), // Supplier's reference number\n  supplierId: varchar(\"supplier_id\").references(() => suppliers.id).notNull(),\n  orderDate: timestamp(\"order_date\").notNull(),\n  expectedDeliveryDate: timestamp(\"expected_delivery_date\"),\n  receivedDate: timestamp(\"received_date\"),\n  totalAmount: integer(\"total_amount\").notNull(), // in cents\n  currency: text(\"currency\").default(\"EUR\"),\n  status: purchaseOrderStatusEnum(\"status\").notNull().default(\"aangekocht\"),\n  isPaid: boolean(\"is_paid\").notNull().default(false), // Payment status\n  archived: boolean(\"archived\").notNull().default(false), // Archive status\n  createdBy: varchar(\"created_by\").references(() => users.id).notNull(),\n  assignedBuyer: varchar(\"assigned_buyer\").references(() => users.id),\n  receivedBy: varchar(\"received_by\").references(() => users.id),\n  caseId: varchar(\"case_id\").references(() => cases.id), // Optional link to case\n  orderId: varchar(\"order_id\").references(() => orders.id), // Optional link to order\n  notes: text(\"notes\"),\n  invoiceUrl: text(\"invoice_url\"), // URL to invoice file\n  deliveryNoteUrl: text(\"delivery_note_url\"), // URL to delivery note\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Purchase Order Items table\nexport const purchaseOrderItems = pgTable(\"purchase_order_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  purchaseOrderId: varchar(\"purchase_order_id\").references(() => purchaseOrders.id).notNull(),\n  sku: text(\"sku\"),\n  productName: text(\"product_name\").notNull(),\n  quantity: integer(\"quantity\").notNull(),\n  unitPrice: integer(\"unit_price\").notNull(), // in cents\n  subtotal: integer(\"subtotal\").notNull(), // in cents (quantity * unitPrice)\n  receivedQuantity: integer(\"received_quantity\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Purchase Order Files table\nexport const purchaseOrderFiles = pgTable(\"purchase_order_files\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  purchaseOrderId: varchar(\"purchase_order_id\").references(() => purchaseOrders.id, { onDelete: \"cascade\" }).notNull(),\n  fileName: text(\"file_name\").notNull(),\n  filePath: text(\"file_path\").notNull(), // Object storage path\n  fileType: text(\"file_type\").notNull(), // MIME type\n  fileSize: integer(\"file_size\").notNull(), // Size in bytes\n  uploadedBy: varchar(\"uploaded_by\").references(() => users.id),\n  uploadedAt: timestamp(\"uploaded_at\").defaultNow(),\n});\n\n// Returns table - Product returns management\nexport const returns = pgTable(\"returns\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  returnNumber: text(\"return_number\").notNull().unique(), // Auto-generated (e.g., RET-2025-001)\n  \n  // Relationships\n  customerId: varchar(\"customer_id\").references(() => customers.id),\n  orderId: varchar(\"order_id\").references(() => orders.id),\n  caseId: varchar(\"case_id\").references(() => cases.id),\n  assignedUserId: varchar(\"assigned_user_id\").references(() => users.id),\n  \n  // Return details\n  status: returnStatusEnum(\"status\").notNull().default(\"nieuw_onderweg\"),\n  returnReason: returnReasonEnum(\"return_reason\"),\n  otherReason: text(\"other_reason\"), // Custom reason when returnReason is \"other\"\n  trackingNumber: text(\"tracking_number\"),\n  \n  // Dates\n  requestedAt: timestamp(\"requested_at\").defaultNow(),\n  receivedAt: timestamp(\"received_at\"),\n  expectedReturnDate: timestamp(\"expected_return_date\"),\n  completedAt: timestamp(\"completed_at\"),\n  \n  // Financial (amounts in cents)\n  refundAmount: integer(\"refund_amount\"),\n  refundStatus: refundStatusEnum(\"refund_status\").default(\"pending\"),\n  refundMethod: refundMethodEnum(\"refund_method\"),\n  shopifyRefundId: text(\"shopify_refund_id\"),\n  \n  // Notes & evidence\n  customerNotes: text(\"customer_notes\"),\n  internalNotes: text(\"internal_notes\"),\n  conditionNotes: text(\"condition_notes\"), // Notes after inspection\n  photos: text(\"photos\").array(), // Array of object storage URLs\n  \n  // Metadata\n  priority: priorityEnum(\"priority\").default(\"medium\"),\n  tags: text(\"tags\").array(),\n  isArchived: boolean(\"is_archived\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Return Items table - Individual products in a return\nexport const returnItems = pgTable(\"return_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  returnId: varchar(\"return_id\").references(() => returns.id).notNull(),\n  \n  sku: text(\"sku\"),\n  productName: text(\"product_name\").notNull(),\n  quantity: integer(\"quantity\").notNull().default(1),\n  unitPrice: integer(\"unit_price\"), // in cents\n  condition: text(\"condition\"), // unopened, opened_unused, used, damaged\n  imageUrl: text(\"image_url\"), // from Shopify or object storage\n  \n  restockable: boolean(\"restockable\").default(false),\n  restockedAt: timestamp(\"restocked_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// ============================================\n// NOTES DOMAIN - Advanced Notes System\n// ============================================\n\nexport const noteVisibilityEnum = pgEnum(\"note_visibility\", [\"internal\", \"customer_visible\", \"system\"]);\nexport const noteEntityTypeEnum = pgEnum(\"note_entity_type\", [\"customer\", \"order\", \"repair\", \"emailThread\", \"case\", \"return\"]);\nexport const noteLinkTypeEnum = pgEnum(\"note_link_type\", [\"order\", \"tracking\", \"sku\", \"email\", \"url\"]);\nexport const followupStatusEnum = pgEnum(\"followup_status\", [\"pending\", \"in_progress\", \"completed\", \"cancelled\"]);\n\n// Main polymorphic Notes table\nexport const notes = pgTable(\"notes\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  \n  // Polymorphic entity linking\n  entityType: noteEntityTypeEnum(\"entity_type\").notNull(),\n  entityId: varchar(\"entity_id\").notNull(),\n  \n  // Note visibility (who can see it)\n  visibility: noteVisibilityEnum(\"visibility\").notNull().default(\"internal\"),\n  \n  // Content\n  content: text(\"content\").notNull(), // Rich text HTML\n  renderedHtml: text(\"rendered_html\"), // Sanitized HTML\n  plainText: text(\"plain_text\"), // For search\n  \n  // Threading (enforced max depth via application logic)\n  parentNoteId: varchar(\"parent_note_id\").references((): any => notes.id),\n  threadDepth: integer(\"thread_depth\").default(0).$type<number>(),\n  \n  // Author & timestamps\n  authorId: varchar(\"author_id\").references(() => users.id).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\"),\n  editedAt: timestamp(\"edited_at\"),\n  \n  // Pinning (max 3 enforced via application logic)\n  isPinned: boolean(\"is_pinned\").default(false),\n  pinnedAt: timestamp(\"pinned_at\"),\n  pinnedBy: varchar(\"pinned_by\").references(() => users.id),\n  \n  // Soft delete\n  deletedAt: timestamp(\"deleted_at\"),\n  deletedBy: varchar(\"deleted_by\").references(() => users.id),\n  deleteReason: text(\"delete_reason\"),\n  \n  // Status context\n  statusPromptId: varchar(\"status_prompt_id\"),\n  \n  // Source tracking\n  source: text(\"source\").default(\"manual\"), // manual, email, system\n});\n\n// Note Tags catalog\nexport const noteTags = pgTable(\"note_tags\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  color: text(\"color\"), // hex color for display\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Note-Tag assignments (many-to-many)\nexport const noteTagAssignments = pgTable(\"note_tag_assignments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  noteId: varchar(\"note_id\").references(() => notes.id, { onDelete: \"cascade\" }).notNull(),\n  tagId: varchar(\"tag_id\").references(() => noteTags.id, { onDelete: \"cascade\" }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Note Mentions\nexport const noteMentions = pgTable(\"note_mentions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  noteId: varchar(\"note_id\").references(() => notes.id, { onDelete: \"cascade\" }).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  notified: boolean(\"notified\").default(false),\n  notifiedAt: timestamp(\"notified_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Note Reactions\nexport const noteReactions = pgTable(\"note_reactions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  noteId: varchar(\"note_id\").references(() => notes.id, { onDelete: \"cascade\" }).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  emoji: text(\"emoji\").notNull(), // üëç üëÄ ‚úÖ\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Note Attachments\nexport const noteAttachments = pgTable(\"note_attachments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  noteId: varchar(\"note_id\").references(() => notes.id, { onDelete: \"cascade\" }).notNull(),\n  fileName: text(\"file_name\").notNull(),\n  filePath: text(\"file_path\").notNull(), // Object storage path\n  mimeType: text(\"mime_type\").notNull(),\n  sizeBytes: integer(\"size_bytes\").notNull(),\n  previewUrl: text(\"preview_url\"), // For images\n  uploadedBy: varchar(\"uploaded_by\").references(() => users.id),\n  uploadedAt: timestamp(\"uploaded_at\").defaultNow(),\n});\n\n// Note Follow-ups (integrates with Todos)\nexport const noteFollowups = pgTable(\"note_followups\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  noteId: varchar(\"note_id\").references(() => notes.id, { onDelete: \"cascade\" }).notNull(),\n  todoId: varchar(\"todo_id\").references(() => todos.id), // Optional link to unified tasks\n  dueAt: timestamp(\"due_at\").notNull(),\n  assigneeId: varchar(\"assignee_id\").references(() => users.id).notNull(),\n  status: followupStatusEnum(\"status\").default(\"pending\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Note Revisions (audit trail for edits)\nexport const noteRevisions = pgTable(\"note_revisions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  noteId: varchar(\"note_id\").references(() => notes.id, { onDelete: \"cascade\" }).notNull(),\n  editorId: varchar(\"editor_id\").references(() => users.id).notNull(),\n  previousContent: text(\"previous_content\").notNull(),\n  newContent: text(\"new_content\").notNull(),\n  delta: jsonb(\"delta\"), // Change diff\n  editedAt: timestamp(\"edited_at\").defaultNow(),\n});\n\n// Note Templates\nexport const noteTemplates = pgTable(\"note_templates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  content: text(\"content\").notNull(), // Template with {{variables}}\n  description: text(\"description\"),\n  scope: text(\"scope\").default(\"global\"), // global, status-specific, entityType\n  entityType: noteEntityTypeEnum(\"entity_type\"),\n  statusContext: text(\"status_context\"), // e.g., waiting_customer, missing_package\n  variables: text(\"variables\").array(), // e.g., [orderId, customerFirstName]\n  isActive: boolean(\"is_active\").default(true),\n  createdBy: varchar(\"created_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\n// Note Links (smart links to other entities)\nexport const noteLinks = pgTable(\"note_links\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  noteId: varchar(\"note_id\").references(() => notes.id, { onDelete: \"cascade\" }).notNull(),\n  linkType: noteLinkTypeEnum(\"link_type\").notNull(),\n  targetId: text(\"target_id\"), // Order ID, tracking number, SKU, etc.\n  displayText: text(\"display_text\"),\n  url: text(\"url\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Activity feed table\nexport const activities = pgTable(\"activities\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  type: text(\"type\").notNull(), // e.g., 'order_created', 'repair_completed', 'email_replied', 'purchase_order_created'\n  description: text(\"description\").notNull(),\n  userId: varchar(\"user_id\").references(() => users.id),\n  metadata: jsonb(\"metadata\"), // additional data about the activity\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Audit logs table - for RBAC audit trail\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").references(() => users.id),\n  action: text(\"action\").notNull(), // e.g., 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT'\n  resource: text(\"resource\").notNull(), // e.g., 'user', 'case', 'repair', 'email'\n  resourceId: text(\"resource_id\"), // ID of the affected resource\n  details: jsonb(\"details\"), // Additional context about the action\n  ipAddress: text(\"ip_address\"),\n  userAgent: text(\"user_agent\"),\n  success: boolean(\"success\").notNull().default(true),\n  errorMessage: text(\"error_message\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// Insert schemas\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertCustomerSchema = createInsertSchema(customers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertOrderSchema = createInsertSchema(orders).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertEmailThreadSchema = createInsertSchema(emailThreads).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertEmailMessageSchema = createInsertSchema(emailMessages).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertRepairSchema = createInsertSchema(repairs).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertTodoSchema = createInsertSchema(todos).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  dueDate: z.string().datetime().optional().or(z.date().optional()).or(z.null()),\n});\n\nexport const insertInternalNoteSchema = createInsertSchema(internalNotes).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertSupplierSchema = createInsertSchema(suppliers).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertPurchaseOrderSchema = createInsertSchema(purchaseOrders).omit({\n  id: true,\n  poNumber: true, // Auto-generated\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  orderDate: z.union([z.string(), z.date()]).transform(val => \n    typeof val === 'string' ? new Date(val) : val\n  ),\n  expectedDeliveryDate: z.union([z.string(), z.date()]).optional().transform(val => \n    val && typeof val === 'string' ? new Date(val) : val\n  ),\n  totalAmount: z.number().int().nonnegative(),\n  archived: z.boolean().optional(), // Allow archiving via updates\n});\n\nexport const insertPurchaseOrderItemSchema = createInsertSchema(purchaseOrderItems).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertPurchaseOrderFileSchema = createInsertSchema(purchaseOrderFiles).omit({\n  id: true,\n  uploadedAt: true,\n});\n\nexport const insertCaseSchema = createInsertSchema(cases).omit({\n  id: true,\n  caseNumber: true, // Auto-generated\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  slaDeadline: z.string().datetime().optional().or(z.date().optional()).or(z.null()),\n  resolvedAt: z.string().datetime().optional().or(z.date().optional()).or(z.null()),\n  closedAt: z.string().datetime().optional().or(z.date().optional()).or(z.null()),\n});\n\nexport const insertCaseLinkSchema = createInsertSchema(caseLinks).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertCaseNoteSchema = createInsertSchema(caseNotes).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertCaseEventSchema = createInsertSchema(caseEvents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertCaseItemSchema = createInsertSchema(caseItems).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertActivitySchema = createInsertSchema(activities).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertEmailAttachmentSchema = createInsertSchema(emailAttachments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertReturnSchema = createInsertSchema(returns).omit({\n  id: true,\n  returnNumber: true, // Auto-generated\n  createdAt: true,\n  updatedAt: true,\n}).extend({\n  requestedAt: z.union([z.string(), z.date()]).optional().transform(val => \n    val && typeof val === 'string' ? new Date(val) : val\n  ),\n  receivedAt: z.union([z.string(), z.date()]).optional().nullable().transform(val => \n    val && typeof val === 'string' ? new Date(val) : val\n  ),\n  expectedReturnDate: z.union([z.string(), z.date()]).optional().nullable().transform(val => \n    val && typeof val === 'string' ? new Date(val) : val\n  ),\n  completedAt: z.union([z.string(), z.date()]).optional().nullable().transform(val => \n    val && typeof val === 'string' ? new Date(val) : val\n  ),\n});\n\nexport const insertReturnItemSchema = createInsertSchema(returnItems).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\n// Notes Domain Insert Schemas\nexport const insertNoteSchema = createInsertSchema(notes).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  editedAt: true,\n  pinnedAt: true,\n  deletedAt: true,\n});\n\nexport const insertNoteTagSchema = createInsertSchema(noteTags).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNoteTagAssignmentSchema = createInsertSchema(noteTagAssignments).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNoteMentionSchema = createInsertSchema(noteMentions).omit({\n  id: true,\n  createdAt: true,\n  notifiedAt: true,\n});\n\nexport const insertNoteReactionSchema = createInsertSchema(noteReactions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertNoteAttachmentSchema = createInsertSchema(noteAttachments).omit({\n  id: true,\n  uploadedAt: true,\n});\n\nexport const insertNoteFollowupSchema = createInsertSchema(noteFollowups).omit({\n  id: true,\n  createdAt: true,\n  completedAt: true,\n}).extend({\n  dueAt: z.union([z.string(), z.date()]).transform(val => \n    typeof val === 'string' ? new Date(val) : val\n  ),\n});\n\nexport const insertNoteRevisionSchema = createInsertSchema(noteRevisions).omit({\n  id: true,\n  editedAt: true,\n});\n\nexport const insertNoteTemplateSchema = createInsertSchema(noteTemplates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertNoteLinkSchema = createInsertSchema(noteLinks).omit({\n  id: true,\n  createdAt: true,\n});\n\n// Types\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\nexport type Customer = typeof customers.$inferSelect;\nexport type InsertCustomer = z.infer<typeof insertCustomerSchema>;\n\nexport type Order = typeof orders.$inferSelect;\nexport type InsertOrder = z.infer<typeof insertOrderSchema>;\n\nexport type EmailThread = typeof emailThreads.$inferSelect;\nexport type InsertEmailThread = z.infer<typeof insertEmailThreadSchema>;\n\nexport type EmailMessage = typeof emailMessages.$inferSelect;\nexport type InsertEmailMessage = z.infer<typeof insertEmailMessageSchema>;\n\nexport type Repair = typeof repairs.$inferSelect;\nexport type InsertRepair = z.infer<typeof insertRepairSchema>;\n\nexport type Todo = typeof todos.$inferSelect;\nexport type InsertTodo = z.infer<typeof insertTodoSchema>;\n\nexport type InternalNote = typeof internalNotes.$inferSelect;\nexport type InsertInternalNote = z.infer<typeof insertInternalNoteSchema>;\n\nexport type PurchaseOrder = typeof purchaseOrders.$inferSelect;\nexport type InsertPurchaseOrder = z.infer<typeof insertPurchaseOrderSchema>;\n\nexport type Case = typeof cases.$inferSelect;\nexport type InsertCase = z.infer<typeof insertCaseSchema>;\n\nexport type CaseLink = typeof caseLinks.$inferSelect;\nexport type InsertCaseLink = z.infer<typeof insertCaseLinkSchema>;\n\nexport type CaseNote = typeof caseNotes.$inferSelect;\nexport type InsertCaseNote = z.infer<typeof insertCaseNoteSchema>;\n\nexport type CaseEvent = typeof caseEvents.$inferSelect;\nexport type InsertCaseEvent = z.infer<typeof insertCaseEventSchema>;\n\nexport type CaseItem = typeof caseItems.$inferSelect;\nexport type InsertCaseItem = z.infer<typeof insertCaseItemSchema>;\n\nexport type Activity = typeof activities.$inferSelect;\nexport type InsertActivity = z.infer<typeof insertActivitySchema>;\n\nexport type AuditLog = typeof auditLogs.$inferSelect;\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\n\nexport type EmailAttachment = typeof emailAttachments.$inferSelect;\nexport type InsertEmailAttachment = z.infer<typeof insertEmailAttachmentSchema>;\n\nexport type Supplier = typeof suppliers.$inferSelect;\nexport type InsertSupplier = z.infer<typeof insertSupplierSchema>;\n\nexport type PurchaseOrderItem = typeof purchaseOrderItems.$inferSelect;\nexport type InsertPurchaseOrderItem = z.infer<typeof insertPurchaseOrderItemSchema>;\n\nexport type PurchaseOrderFile = typeof purchaseOrderFiles.$inferSelect;\nexport type InsertPurchaseOrderFile = z.infer<typeof insertPurchaseOrderFileSchema>;\n\nexport type Return = typeof returns.$inferSelect;\nexport type InsertReturn = z.infer<typeof insertReturnSchema>;\n\nexport type ReturnItem = typeof returnItems.$inferSelect;\nexport type InsertReturnItem = z.infer<typeof insertReturnItemSchema>;\n\n// Notes Domain Types\nexport type Note = typeof notes.$inferSelect;\nexport type InsertNote = z.infer<typeof insertNoteSchema>;\n\nexport type NoteTag = typeof noteTags.$inferSelect;\nexport type InsertNoteTag = z.infer<typeof insertNoteTagSchema>;\n\nexport type NoteTagAssignment = typeof noteTagAssignments.$inferSelect;\nexport type InsertNoteTagAssignment = z.infer<typeof insertNoteTagAssignmentSchema>;\n\nexport type NoteMention = typeof noteMentions.$inferSelect;\nexport type InsertNoteMention = z.infer<typeof insertNoteMentionSchema>;\n\nexport type NoteReaction = typeof noteReactions.$inferSelect;\nexport type InsertNoteReaction = z.infer<typeof insertNoteReactionSchema>;\n\nexport type NoteAttachment = typeof noteAttachments.$inferSelect;\nexport type InsertNoteAttachment = z.infer<typeof insertNoteAttachmentSchema>;\n\nexport type NoteFollowup = typeof noteFollowups.$inferSelect;\nexport type InsertNoteFollowup = z.infer<typeof insertNoteFollowupSchema>;\n\nexport type NoteRevision = typeof noteRevisions.$inferSelect;\nexport type InsertNoteRevision = z.infer<typeof insertNoteRevisionSchema>;\n\nexport type NoteTemplate = typeof noteTemplates.$inferSelect;\nexport type InsertNoteTemplate = z.infer<typeof insertNoteTemplateSchema>;\n\nexport type NoteLink = typeof noteLinks.$inferSelect;\nexport type InsertNoteLink = z.infer<typeof insertNoteLinkSchema>;\n","size_bytes":38234},"client/src/components/forms/case-form.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { CalendarIcon } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { insertCaseSchema } from \"@shared/schema\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { InsertCase } from \"@shared/schema\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\n\ninterface CaseFormProps {\n  onSuccess?: () => void;\n  caseData?: any; // For editing existing cases\n}\n\ninterface CaseFormData {\n  title: string;\n  description: string;\n  priority: \"low\" | \"medium\" | \"high\" | \"urgent\";\n  customerEmail: string;\n  slaDeadline: Date | null;\n}\n\nexport function CaseForm({ onSuccess, caseData }: CaseFormProps) {\n  const [slaDeadline, setSlaDeadline] = useState<Date | null>(\n    caseData?.slaDeadline ? new Date(caseData.slaDeadline) : null\n  );\n  const { toast } = useToast();\n\n  const form = useForm<CaseFormData>({\n    resolver: zodResolver(insertCaseSchema.extend({\n      slaDeadline: insertCaseSchema.shape.slaDeadline,\n    })),\n    defaultValues: {\n      title: caseData?.title || \"\",\n      description: caseData?.description || \"\",\n      priority: caseData?.priority || \"medium\",\n      customerEmail: caseData?.customerEmail || \"\",\n      slaDeadline: caseData?.slaDeadline ? new Date(caseData.slaDeadline) : null,\n    },\n  });\n\n  const createCaseMutation = useMutation({\n    mutationFn: async (data: InsertCase) => {\n      const response = await fetch(\"/api/cases\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to create case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      toast({\n        title: \"Case created\",\n        description: \"New case has been created successfully\",\n      });\n      form.reset();\n      onSuccess?.();\n    },\n    onError: (error) => {\n      toast({\n        title: \"Create failed\",\n        description: \"Failed to create case. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const updateCaseMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertCase> }) => {\n      const response = await fetch(`/api/cases/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to update case\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      toast({\n        title: \"Case updated\",\n        description: \"Case has been updated successfully\",\n      });\n      onSuccess?.();\n    },\n    onError: () => {\n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update case. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const onSubmit = (data: CaseFormData) => {\n    const submitData: InsertCase = {\n      title: data.title,\n      description: data.description || null,\n      priority: data.priority,\n      customerEmail: data.customerEmail,\n      slaDeadline: data.slaDeadline ? data.slaDeadline.toISOString() : null,\n    };\n\n    if (caseData?.id) {\n      updateCaseMutation.mutate({ id: caseData.id, data: submitData });\n    } else {\n      createCaseMutation.mutate(submitData);\n    }\n  };\n\n  const isLoading = createCaseMutation.isPending || updateCaseMutation.isPending;\n\n  return (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\" data-testid=\"case-form\">\n        <FormField\n          control={form.control}\n          name=\"title\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Title</FormLabel>\n              <FormControl>\n                <Input \n                  placeholder=\"Case title\" \n                  {...field} \n                  data-testid=\"case-title-input\"\n                />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        <FormField\n          control={form.control}\n          name=\"description\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Description</FormLabel>\n              <FormControl>\n                <Textarea\n                  placeholder=\"Describe the case details...\"\n                  rows={4}\n                  {...field}\n                  data-testid=\"case-description-input\"\n                />\n              </FormControl>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        <div className=\"grid grid-cols-2 gap-4\">\n          <FormField\n            control={form.control}\n            name=\"priority\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Priority</FormLabel>\n                <Select onValueChange={field.onChange} value={field.value}>\n                  <FormControl>\n                    <SelectTrigger data-testid=\"case-priority-select\">\n                      <SelectValue placeholder=\"Select priority\" />\n                    </SelectTrigger>\n                  </FormControl>\n                  <SelectContent>\n                    <SelectItem value=\"low\">Low</SelectItem>\n                    <SelectItem value=\"medium\">Medium</SelectItem>\n                    <SelectItem value=\"high\">High</SelectItem>\n                    <SelectItem value=\"urgent\">Urgent</SelectItem>\n                  </SelectContent>\n                </Select>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n\n          <FormField\n            control={form.control}\n            name=\"customerEmail\"\n            render={({ field }) => (\n              <FormItem>\n                <FormLabel>Customer Email</FormLabel>\n                <FormControl>\n                  <Input\n                    type=\"email\"\n                    placeholder=\"customer@example.com\"\n                    {...field}\n                    data-testid=\"case-customer-email-input\"\n                  />\n                </FormControl>\n                <FormMessage />\n              </FormItem>\n            )}\n          />\n        </div>\n\n        <FormField\n          control={form.control}\n          name=\"slaDeadline\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>SLA Deadline (optional)</FormLabel>\n              <Popover>\n                <PopoverTrigger asChild>\n                  <FormControl>\n                    <Button\n                      variant=\"outline\"\n                      className=\"w-full pl-3 text-left font-normal\"\n                      data-testid=\"case-sla-deadline-trigger\"\n                    >\n                      {field.value ? (\n                        format(field.value, \"PPP\")\n                      ) : (\n                        <span>Pick a date</span>\n                      )}\n                      <CalendarIcon className=\"ml-auto h-4 w-4 opacity-50\" />\n                    </Button>\n                  </FormControl>\n                </PopoverTrigger>\n                <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                  <Calendar\n                    mode=\"single\"\n                    selected={field.value || undefined}\n                    onSelect={field.onChange}\n                    disabled={(date) =>\n                      date < new Date() || date < new Date(\"1900-01-01\")\n                    }\n                    initialFocus\n                  />\n                </PopoverContent>\n              </Popover>\n              <FormMessage />\n            </FormItem>\n          )}\n        />\n\n        <div className=\"flex justify-end space-x-2 pt-4\">\n          <Button\n            type=\"submit\"\n            disabled={isLoading}\n            data-testid=\"submit-case-button\"\n          >\n            {isLoading ? \"Saving...\" : caseData ? \"Update Case\" : \"Create Case\"}\n          </Button>\n        </div>\n      </form>\n    </Form>\n  );\n}","size_bytes":8727},"client/src/components/repairs/repair-analytics.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Wrench, Clock, Users, CheckCircle, AlertTriangle } from \"lucide-react\";\nimport type { Repair, User } from \"@shared/schema\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { isPast } from \"date-fns\";\n\ninterface RepairAnalyticsProps {\n  repairs: Repair[];\n  users: User[];\n}\n\nexport function RepairAnalytics({ repairs, users }: RepairAnalyticsProps) {\n  // Total repairs\n  const totalRepairs = repairs.length;\n\n  // Overdue repairs (active repairs past SLA deadline)\n  const overdueRepairs = repairs.filter(r => {\n    if (!r.slaDeadline) return false;\n    const isActive = !['completed', 'returned', 'canceled'].includes(r.status);\n    return isActive && isPast(new Date(r.slaDeadline));\n  });\n\n  // Average repair time (in days) for completed repairs only\n  const completedRepairs = repairs.filter(r => \n    (r.status === 'completed' || r.status === 'returned') && r.createdAt && r.updatedAt\n  );\n  const avgRepairTime = completedRepairs.length > 0\n    ? Math.round(\n        completedRepairs.reduce((acc, r) => {\n          const days = (new Date(r.updatedAt!).getTime() - new Date(r.createdAt!).getTime()) / (1000 * 60 * 60 * 24);\n          return acc + Math.max(0, days); // Ensure non-negative\n        }, 0) / completedRepairs.length\n      )\n    : 0;\n\n  // Repairs per technician\n  const repairsByTechnician = repairs.reduce((acc, repair) => {\n    if (repair.assignedUserId) {\n      acc[repair.assignedUserId] = (acc[repair.assignedUserId] || 0) + 1;\n    }\n    return acc;\n  }, {} as Record<string, number>);\n\n  const topTechnicians = Object.entries(repairsByTechnician)\n    .map(([userId, count]) => {\n      const user = users.find(u => u.id === userId);\n      return {\n        name: user ? `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username : 'Onbekend',\n        count,\n      };\n    })\n    .sort((a, b) => b.count - a.count)\n    .slice(0, 3);\n\n  // Pending vs completed\n  const pendingStatuses = ['new', 'diagnosing', 'waiting_parts', 'repair_in_progress', 'quality_check'];\n  const pendingCount = repairs.filter(r => pendingStatuses.includes(r.status)).length;\n  const completedCount = repairs.filter(r => r.status === 'completed' || r.status === 'returned').length;\n  const canceledCount = repairs.filter(r => r.status === 'canceled').length;\n\n  // Common issues\n  const issueCategories = repairs.reduce((acc, repair) => {\n    if (repair.issueCategory) {\n      acc[repair.issueCategory] = (acc[repair.issueCategory] || 0) + 1;\n    }\n    return acc;\n  }, {} as Record<string, number>);\n\n  const topIssues = Object.entries(issueCategories)\n    .map(([category, count]) => ({ category, count }))\n    .sort((a, b) => b.count - a.count)\n    .slice(0, 5);\n\n  const maxIssueCount = topIssues.length > 0 ? topIssues[0].count : 1;\n\n  // Urgent repairs\n  const urgentRepairsList = repairs.filter(r => \n    r.priority === 'urgent' && pendingStatuses.includes(r.status)\n  );\n  const urgentRepairs = urgentRepairsList.length;\n\n  return (\n    <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\" data-testid=\"repair-analytics\">\n      <Card data-testid=\"card-total-repairs\">\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Totaal Reparaties</CardTitle>\n          <Wrench className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\" data-testid=\"text-total-repairs\">{totalRepairs}</div>\n          <p className=\"text-xs text-muted-foreground\">\n            {pendingCount} in behandeling\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-avg-repair-time\">\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Gem. Reparatietijd</CardTitle>\n          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\" data-testid=\"text-avg-repair-time\">\n            {avgRepairTime} dagen\n          </div>\n          <p className=\"text-xs text-muted-foreground\">\n            Gebaseerd op {completedRepairs.length} voltooide reparaties\n          </p>\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-status-distribution\">\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Status Verdeling</CardTitle>\n          <CheckCircle className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm\">In behandeling</span>\n              <Badge variant=\"outline\" data-testid=\"badge-pending-count\">{pendingCount}</Badge>\n            </div>\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm\">Voltooid</span>\n              <Badge variant=\"outline\" className=\"bg-green-100 text-green-800\" data-testid=\"badge-completed-count\">\n                {completedCount}\n              </Badge>\n            </div>\n            {canceledCount > 0 && (\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-sm\">Geannuleerd</span>\n                <Badge variant=\"outline\" data-testid=\"badge-canceled-count\">{canceledCount}</Badge>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-overdue-repairs\">\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Te Laat</CardTitle>\n          <AlertTriangle className=\"h-4 w-4 text-destructive\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold text-destructive\" data-testid=\"text-overdue-count\">\n            {overdueRepairs.length}\n          </div>\n          {overdueRepairs.length > 0 ? (\n            <div className=\"mt-2 space-y-1\">\n              {overdueRepairs.slice(0, 3).map((repair) => (\n                <div key={repair.id} className=\"text-xs truncate\" data-testid={`overdue-repair-${repair.id}`}>\n                  #{repair.id.slice(0, 8)} - {repair.title}\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-xs text-muted-foreground mt-2\">Geen te late reparaties</p>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card data-testid=\"card-urgent-repairs\">\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">Urgent</CardTitle>\n          <AlertTriangle className=\"h-4 w-4 text-orange-500\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold text-orange-500\" data-testid=\"text-urgent-count\">\n            {urgentRepairs}\n          </div>\n          {urgentRepairsList.length > 0 ? (\n            <div className=\"mt-2 space-y-1\">\n              {urgentRepairsList.slice(0, 3).map((repair) => (\n                <div key={repair.id} className=\"text-xs truncate\" data-testid={`urgent-repair-${repair.id}`}>\n                  #{repair.id.slice(0, 8)} - {repair.title}\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-xs text-muted-foreground\">\n              Vereisen directe aandacht\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card className=\"md:col-span-2\" data-testid=\"card-top-technicians\">\n        <CardHeader>\n          <CardTitle className=\"text-base flex items-center gap-2\">\n            <Users className=\"h-4 w-4\" />\n            Top Technici\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {topTechnicians.length > 0 ? (\n            <div className=\"space-y-3\">\n              {topTechnicians.map((tech, index) => (\n                <div key={index} className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center\">\n                      <span className=\"text-sm font-medium\">{index + 1}</span>\n                    </div>\n                    <span className=\"text-sm font-medium\">{tech.name}</span>\n                  </div>\n                  <Badge variant=\"secondary\" data-testid={`badge-tech-count-${index}`}>\n                    {tech.count} reparaties\n                  </Badge>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">\n              Geen reparaties toegewezen aan technici\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card className=\"md:col-span-2\" data-testid=\"card-common-issues\">\n        <CardHeader>\n          <CardTitle className=\"text-base\">Meest Voorkomende Problemen</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {topIssues.length > 0 ? (\n            <div className=\"space-y-3\">\n              {topIssues.map((issue, index) => (\n                <div key={index} className=\"flex items-center justify-between\">\n                  <span className=\"text-sm\">{issue.category}</span>\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"w-32 bg-muted rounded-full h-2\">\n                      <div\n                        className=\"bg-primary rounded-full h-2\"\n                        style={{ width: `${Math.min(100, (issue.count / maxIssueCount) * 100)}%` }}\n                      />\n                    </div>\n                    <Badge variant=\"outline\" data-testid={`badge-issue-count-${index}`}>\n                      {issue.count}\n                    </Badge>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-sm text-muted-foreground text-center py-4\">\n              Geen probleemcategorie√´n geregistreerd\n            </p>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":10323},"client/src/pages/home.tsx":{"content":"import { useState } from \"react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { InboxStatusWidget } from \"@/components/widgets/inbox-status-widget\";\nimport { NewRepairsWidget } from \"@/components/widgets/new-repairs-widget\";\nimport { SlaAlertsWidget } from \"@/components/widgets/sla-alerts-widget\";\nimport { OrdersTodayWidget } from \"@/components/widgets/orders-today-widget\";\nimport { PersonalTodosWidget } from \"@/components/widgets/personal-todos-widget\";\nimport { TeamActivityWidget } from \"@/components/widgets/team-activity-widget\";\nimport { QuickActionsWidget } from \"@/components/widgets/quick-actions-widget\";\nimport { RecentOrdersWidget } from \"@/components/widgets/recent-orders-widget\";\nimport { RepairStatusWidget } from \"@/components/widgets/repair-status-widget\";\nimport { BusinessMetricsWidget } from \"@/components/widgets/business-metrics-widget\";\nimport { TodoForm } from \"@/components/forms/todo-form\";\nimport { RepairForm } from \"@/components/forms/repair-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Plus } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { User } from \"@shared/schema\";\n\nexport default function Home() {\n  const [openTodoDialog, setOpenTodoDialog] = useState(false);\n  const [openRepairDialog, setOpenRepairDialog] = useState(false);\n  \n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n  return (\n    <div className=\"min-h-screen bg-background\" data-testid=\"home-page\">\n      <Navigation />\n      \n      <main className=\"flex-1 space-y-6 p-8 pt-6\">\n        {/* Page Header */}\n        <div className=\"flex items-center justify-between\" data-testid=\"page-header\">\n          <div>\n            <h2 className=\"text-4xl font-bold tracking-tight bg-gradient-primary bg-clip-text text-transparent\">Welcome back, John</h2>\n            <p className=\"text-muted-foreground mt-1 text-lg\">Here's what's happening at DutchThrift today.</p>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <Button variant=\"outline\" data-testid=\"export-data-button\">\n              <Download className=\"mr-2 h-4 w-4\" />\n              Export Data\n            </Button>\n            <Button data-testid=\"quick-action-button\">\n              <Plus className=\"mr-2 h-4 w-4\" />\n              Quick Action\n            </Button>\n          </div>\n        </div>\n\n        {/* Stats Grid */}\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\" data-testid=\"stats-grid\">\n          <InboxStatusWidget />\n          <NewRepairsWidget />\n          <SlaAlertsWidget />\n          <OrdersTodayWidget />\n        </div>\n\n        {/* Main Content Grid */}\n        <div className=\"grid gap-4 lg:grid-cols-7\">\n          {/* Personal Todos - Takes 4 columns */}\n          <div className=\"col-span-4\">\n            <PersonalTodosWidget />\n          </div>\n          \n          {/* Team Activity - Takes 3 columns */}\n          <div className=\"col-span-3\">\n            <TeamActivityWidget />\n          </div>\n        </div>\n\n        {/* Quick Actions */}\n        <QuickActionsWidget \n          onOpenTodo={() => setOpenTodoDialog(true)}\n          onOpenRepair={() => setOpenRepairDialog(true)}\n        />\n\n        {/* Business Performance Metrics */}\n        <BusinessMetricsWidget />\n\n        {/* Recent Orders and Repairs */}\n        <div className=\"grid gap-4 lg:grid-cols-2\" data-testid=\"recent-content-grid\">\n          <RecentOrdersWidget />\n          <RepairStatusWidget />\n        </div>\n      </main>\n\n      {/* Dialog Components */}\n      <TodoForm \n        open={openTodoDialog} \n        onOpenChange={setOpenTodoDialog}\n      />\n      <RepairForm \n        open={openRepairDialog} \n        onOpenChange={setOpenRepairDialog}\n        users={users}\n      />\n    </div>\n  );\n}\n","size_bytes":3837},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/components/auth/protected-route.tsx":{"content":"import { useAuth } from \"@/lib/auth\";\nimport { LoginForm } from \"./login-form\";\nimport { ComponentType, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\n\ninterface ProtectedRouteProps {\n  component: ComponentType<any>;\n  roles?: string[];\n  [key: string]: any;\n}\n\nexport default function ProtectedRoute({ component: Component, roles = [], ...props }: ProtectedRouteProps) {\n  const { user, loading: isLoading } = useAuth();\n  const [, setLocation] = useLocation();\n\n  // Auto-redirect TECHNICUS users if they try to access unauthorized pages\n  useEffect(() => {\n    if (!isLoading && user && roles.length > 0 && !roles.includes(user.role)) {\n      if (user.role === \"TECHNICUS\") {\n        setLocation(\"/repairs\");\n      }\n    }\n  }, [user, roles, setLocation, isLoading]);\n\n  // Show loading spinner while checking authentication\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  // Show login form if not authenticated\n  if (!user) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-background\">\n        <div className=\"w-full max-w-md\">\n          <div className=\"text-center mb-8\">\n            <h1 className=\"text-3xl font-bold text-foreground\">DutchThrift Admin</h1>\n            <p className=\"text-muted-foreground mt-2\">Sign in to continue</p>\n          </div>\n          <LoginForm />\n        </div>\n      </div>\n    );\n  }\n\n  // Show access denied for non-TECHNICUS users without proper roles\n  if (roles.length > 0 && !roles.includes(user.role)) {\n    // TECHNICUS users get redirected above, so this only affects other unauthorized users\n    if (user.role !== \"TECHNICUS\") {\n      return (\n        <div className=\"min-h-screen flex items-center justify-center bg-background\">\n          <div className=\"text-center\">\n            <h2 className=\"text-2xl font-bold text-foreground mb-4\">Access Denied</h2>\n            <p className=\"text-muted-foreground mb-4\">\n              You don't have permission to access this page.\n            </p>\n            <p className=\"text-sm text-muted-foreground\">\n              Required roles: {roles.join(\", \")}\n            </p>\n          </div>\n        </div>\n      );\n    }\n    // For TECHNICUS, show loading while redirect happens\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  // Render the protected component\n  return <Component {...props} />;\n}","size_bytes":2665},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":2755},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/pages/settings.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Settings as SettingsIcon, Mail, Plug, Server, Save } from \"lucide-react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Form, FormControl, FormDescription, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nconst generalSettingsSchema = z.object({\n  companyName: z.string().min(1, \"Company name is required\"),\n  contactEmail: z.string().email(\"Please enter a valid email\"),\n  timeZone: z.string(),\n  language: z.string(),\n});\n\nconst emailSettingsSchema = z.object({\n  imapHost: z.string().min(1, \"IMAP host is required\"),\n  imapPort: z.string().min(1, \"IMAP port is required\"),\n  imapUser: z.string().email(\"Please enter a valid email\"),\n  smtpHost: z.string().min(1, \"SMTP host is required\"),\n  smtpPort: z.string().min(1, \"SMTP port is required\"),\n  syncFrequency: z.string(),\n});\n\nconst integrationSettingsSchema = z.object({\n  shopifyDomain: z.string().optional(),\n  shopifyAccessToken: z.string().optional(),\n  outlookClientId: z.string().optional(),\n  outlookTenantId: z.string().optional(),\n});\n\nconst systemSettingsSchema = z.object({\n  sessionTimeout: z.string(),\n  defaultPagination: z.string(),\n  enableNotifications: z.boolean(),\n  enableEmailSync: z.boolean(),\n});\n\ntype GeneralSettings = z.infer<typeof generalSettingsSchema>;\ntype EmailSettings = z.infer<typeof emailSettingsSchema>;\ntype IntegrationSettings = z.infer<typeof integrationSettingsSchema>;\ntype SystemSettings = z.infer<typeof systemSettingsSchema>;\n\nexport default function Settings() {\n  const [activeTab, setActiveTab] = useState(\"general\");\n  const { toast } = useToast();\n\n  const generalForm = useForm<GeneralSettings>({\n    resolver: zodResolver(generalSettingsSchema),\n    defaultValues: {\n      companyName: \"DutchThrift\",\n      contactEmail: \"info@dutchthrift.com\",\n      timeZone: \"Europe/Amsterdam\",\n      language: \"nl\",\n    },\n  });\n\n  const emailForm = useForm<EmailSettings>({\n    resolver: zodResolver(emailSettingsSchema),\n    defaultValues: {\n      imapHost: \"\",\n      imapPort: \"993\",\n      imapUser: \"\",\n      smtpHost: \"\",\n      smtpPort: \"587\",\n      syncFrequency: \"5\",\n    },\n  });\n\n  const integrationForm = useForm<IntegrationSettings>({\n    resolver: zodResolver(integrationSettingsSchema),\n    defaultValues: {\n      shopifyDomain: \"\",\n      shopifyAccessToken: \"\",\n      outlookClientId: \"\",\n      outlookTenantId: \"\",\n    },\n  });\n\n  const systemForm = useForm<SystemSettings>({\n    resolver: zodResolver(systemSettingsSchema),\n    defaultValues: {\n      sessionTimeout: \"3600\",\n      defaultPagination: \"25\",\n      enableNotifications: true,\n      enableEmailSync: true,\n    },\n  });\n\n  const onSaveGeneral = (data: GeneralSettings) => {\n    console.log(\"General settings:\", data);\n    toast({\n      title: \"Settings saved\",\n      description: \"General settings have been updated successfully.\",\n    });\n  };\n\n  const onSaveEmail = (data: EmailSettings) => {\n    console.log(\"Email settings:\", data);\n    toast({\n      title: \"Settings saved\",\n      description: \"Email settings have been updated successfully.\",\n    });\n  };\n\n  const onSaveIntegration = (data: IntegrationSettings) => {\n    console.log(\"Integration settings:\", data);\n    toast({\n      title: \"Settings saved\",\n      description: \"Integration settings have been updated successfully.\",\n    });\n  };\n\n  const onSaveSystem = (data: SystemSettings) => {\n    console.log(\"System settings:\", data);\n    toast({\n      title: \"Settings saved\",\n      description: \"System settings have been updated successfully.\",\n    });\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Navigation />\n      <main className=\"p-6\">\n        <div className=\"mb-6\">\n          <div className=\"flex items-center space-x-3\">\n            <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10\">\n              <SettingsIcon className=\"h-5 w-5 text-primary\" />\n            </div>\n            <div>\n              <h1 className=\"text-2xl font-semibold text-foreground\">Settings</h1>\n              <p className=\"text-sm text-muted-foreground\">Manage system configuration and preferences</p>\n            </div>\n          </div>\n        </div>\n\n        <div>\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-6\">\n          <TabsList className=\"grid w-full max-w-2xl grid-cols-4\">\n            <TabsTrigger value=\"general\" data-testid=\"tab-general\">\n              <SettingsIcon className=\"h-4 w-4 mr-2\" />\n              General\n            </TabsTrigger>\n            <TabsTrigger value=\"email\" data-testid=\"tab-email\">\n              <Mail className=\"h-4 w-4 mr-2\" />\n              Email\n            </TabsTrigger>\n            <TabsTrigger value=\"integration\" data-testid=\"tab-integration\">\n              <Plug className=\"h-4 w-4 mr-2\" />\n              Integration\n            </TabsTrigger>\n            <TabsTrigger value=\"system\" data-testid=\"tab-system\">\n              <Server className=\"h-4 w-4 mr-2\" />\n              System\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"general\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>General Settings</CardTitle>\n                <CardDescription>Configure basic company and application settings</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Form {...generalForm}>\n                  <form onSubmit={generalForm.handleSubmit(onSaveGeneral)} className=\"space-y-6\">\n                    <FormField\n                      control={generalForm.control}\n                      name=\"companyName\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Company Name</FormLabel>\n                          <FormControl>\n                            <Input {...field} placeholder=\"DutchThrift\" data-testid=\"input-company-name\" />\n                          </FormControl>\n                          <FormDescription>The name of your business or organization</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={generalForm.control}\n                      name=\"contactEmail\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Contact Email</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"email\" placeholder=\"info@dutchthrift.com\" data-testid=\"input-contact-email\" />\n                          </FormControl>\n                          <FormDescription>Main email address for customer support</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={generalForm.control}\n                      name=\"timeZone\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Time Zone</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-timezone\">\n                                <SelectValue placeholder=\"Select time zone\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"Europe/Amsterdam\">Europe/Amsterdam</SelectItem>\n                              <SelectItem value=\"Europe/London\">Europe/London</SelectItem>\n                              <SelectItem value=\"America/New_York\">America/New York</SelectItem>\n                              <SelectItem value=\"Asia/Tokyo\">Asia/Tokyo</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormDescription>Default time zone for the application</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={generalForm.control}\n                      name=\"language\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Language</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-language\">\n                                <SelectValue placeholder=\"Select language\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"nl\">Nederlands</SelectItem>\n                              <SelectItem value=\"en\">English</SelectItem>\n                              <SelectItem value=\"de\">Deutsch</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormDescription>Default language for the interface</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button type=\"submit\" data-testid=\"button-save-general\">\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Save General Settings\n                    </Button>\n                  </form>\n                </Form>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"email\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Email Settings</CardTitle>\n                <CardDescription>Configure IMAP and SMTP server settings for email synchronization</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Form {...emailForm}>\n                  <form onSubmit={emailForm.handleSubmit(onSaveEmail)} className=\"space-y-6\">\n                    <div className=\"space-y-4\">\n                      <h3 className=\"text-lg font-medium\">IMAP Configuration</h3>\n                      \n                      <FormField\n                        control={emailForm.control}\n                        name=\"imapHost\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>IMAP Host</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"imap.gmail.com\" data-testid=\"input-imap-host\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={emailForm.control}\n                        name=\"imapPort\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>IMAP Port</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"993\" data-testid=\"input-imap-port\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={emailForm.control}\n                        name=\"imapUser\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>IMAP Username</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"email\" placeholder=\"your-email@example.com\" data-testid=\"input-imap-user\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <div className=\"space-y-4\">\n                      <h3 className=\"text-lg font-medium\">SMTP Configuration</h3>\n                      \n                      <FormField\n                        control={emailForm.control}\n                        name=\"smtpHost\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>SMTP Host</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"smtp.gmail.com\" data-testid=\"input-smtp-host\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={emailForm.control}\n                        name=\"smtpPort\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>SMTP Port</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"587\" data-testid=\"input-smtp-port\" />\n                            </FormControl>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <FormField\n                      control={emailForm.control}\n                      name=\"syncFrequency\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Sync Frequency (minutes)</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"number\" placeholder=\"5\" data-testid=\"input-sync-frequency\" />\n                          </FormControl>\n                          <FormDescription>How often to check for new emails</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button type=\"submit\" data-testid=\"button-save-email\">\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Save Email Settings\n                    </Button>\n                  </form>\n                </Form>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"integration\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Integration Settings</CardTitle>\n                <CardDescription>Configure third-party integrations and API connections</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Form {...integrationForm}>\n                  <form onSubmit={integrationForm.handleSubmit(onSaveIntegration)} className=\"space-y-6\">\n                    <div className=\"space-y-4\">\n                      <h3 className=\"text-lg font-medium\">Shopify Integration</h3>\n                      \n                      <FormField\n                        control={integrationForm.control}\n                        name=\"shopifyDomain\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Shopify Domain</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"your-store.myshopify.com\" data-testid=\"input-shopify-domain\" />\n                            </FormControl>\n                            <FormDescription>Your Shopify store domain</FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={integrationForm.control}\n                        name=\"shopifyAccessToken\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Shopify Access Token</FormLabel>\n                            <FormControl>\n                              <Input {...field} type=\"password\" placeholder=\"shpat_...\" data-testid=\"input-shopify-token\" />\n                            </FormControl>\n                            <FormDescription>Admin API access token for Shopify</FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <div className=\"space-y-4\">\n                      <h3 className=\"text-lg font-medium\">Microsoft Outlook Integration</h3>\n                      \n                      <FormField\n                        control={integrationForm.control}\n                        name=\"outlookClientId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Client ID</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\" data-testid=\"input-outlook-client-id\" />\n                            </FormControl>\n                            <FormDescription>Microsoft Graph API client ID</FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n\n                      <FormField\n                        control={integrationForm.control}\n                        name=\"outlookTenantId\"\n                        render={({ field }) => (\n                          <FormItem>\n                            <FormLabel>Tenant ID</FormLabel>\n                            <FormControl>\n                              <Input {...field} placeholder=\"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\" data-testid=\"input-outlook-tenant-id\" />\n                            </FormControl>\n                            <FormDescription>Microsoft Azure tenant ID</FormDescription>\n                            <FormMessage />\n                          </FormItem>\n                        )}\n                      />\n                    </div>\n\n                    <Button type=\"submit\" data-testid=\"button-save-integration\">\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Save Integration Settings\n                    </Button>\n                  </form>\n                </Form>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"system\" className=\"space-y-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle>System Settings</CardTitle>\n                <CardDescription>Configure system-wide application settings and preferences</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <Form {...systemForm}>\n                  <form onSubmit={systemForm.handleSubmit(onSaveSystem)} className=\"space-y-6\">\n                    <FormField\n                      control={systemForm.control}\n                      name=\"sessionTimeout\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Session Timeout (seconds)</FormLabel>\n                          <FormControl>\n                            <Input {...field} type=\"number\" placeholder=\"3600\" data-testid=\"input-session-timeout\" />\n                          </FormControl>\n                          <FormDescription>How long before user sessions expire (default: 3600 = 1 hour)</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={systemForm.control}\n                      name=\"defaultPagination\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>Default Pagination</FormLabel>\n                          <Select onValueChange={field.onChange} defaultValue={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-pagination\">\n                                <SelectValue placeholder=\"Select page size\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              <SelectItem value=\"10\">10 items</SelectItem>\n                              <SelectItem value=\"25\">25 items</SelectItem>\n                              <SelectItem value=\"50\">50 items</SelectItem>\n                              <SelectItem value=\"100\">100 items</SelectItem>\n                            </SelectContent>\n                          </Select>\n                          <FormDescription>Default number of items per page</FormDescription>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={systemForm.control}\n                      name=\"enableNotifications\"\n                      render={({ field }) => (\n                        <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                          <div className=\"space-y-0.5\">\n                            <FormLabel className=\"text-base\">Enable Notifications</FormLabel>\n                            <FormDescription>\n                              Receive notifications for important events\n                            </FormDescription>\n                          </div>\n                          <FormControl>\n                            <Switch\n                              checked={field.value}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"switch-notifications\"\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={systemForm.control}\n                      name=\"enableEmailSync\"\n                      render={({ field }) => (\n                        <FormItem className=\"flex flex-row items-center justify-between rounded-lg border p-4\">\n                          <div className=\"space-y-0.5\">\n                            <FormLabel className=\"text-base\">Enable Email Sync</FormLabel>\n                            <FormDescription>\n                              Automatically synchronize emails from configured accounts\n                            </FormDescription>\n                          </div>\n                          <FormControl>\n                            <Switch\n                              checked={field.value}\n                              onCheckedChange={field.onChange}\n                              data-testid=\"switch-email-sync\"\n                            />\n                          </FormControl>\n                        </FormItem>\n                      )}\n                    />\n\n                    <Button type=\"submit\" data-testid=\"button-save-system\">\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Save System Settings\n                    </Button>\n                  </form>\n                </Form>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":24451},"client/src/components/forms/create-case-modal.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { insertCaseSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { Check, ChevronsUpDown, Package, Mail, Search } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ShopifyLineItem {\n  id: string;\n  title: string;\n  sku: string;\n  variantTitle?: string;\n  quantity: number;\n  price?: string;\n}\n\ninterface SelectedItemData {\n  quantity: number;\n  itemNotes: string;\n}\n\nconst createCaseFormSchema = insertCaseSchema.extend({\n  assignedUserId: z.string().optional().nullable(),\n  orderId: z.string().optional().nullable(),\n});\n\ntype CreateCaseFormValues = z.infer<typeof createCaseFormSchema>;\n\ninterface CreateCaseModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  emailThread?: any;\n}\n\nexport function CreateCaseModal({ open, onOpenChange, emailThread }: CreateCaseModalProps) {\n  const { toast } = useToast();\n  const [orderSearchOpen, setOrderSearchOpen] = useState(false);\n  const [orderSearchQuery, setOrderSearchQuery] = useState(\"\");\n  const [selectedItems, setSelectedItems] = useState<Map<string, SelectedItemData>>(new Map());\n\n  const { data: users } = useQuery<any[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: customers } = useQuery<any[]>({\n    queryKey: [\"/api/customers\"],\n  });\n\n  // Fetch orders with search query\n  const { data: ordersData } = useQuery<{ orders: any[], total: number }>({\n    queryKey: [\"/api/orders\", 1, 50, orderSearchQuery],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        page: \"1\",\n        limit: \"50\",\n      });\n      \n      if (orderSearchQuery) {\n        params.append(\"search\", orderSearchQuery);\n      }\n      \n      const response = await fetch(`/api/orders?${params}`);\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch orders\");\n      }\n      return response.json();\n    },\n  });\n\n  const form = useForm<CreateCaseFormValues>({\n    resolver: zodResolver(createCaseFormSchema),\n    defaultValues: {\n      title: emailThread?.subject || \"\",\n      description: emailThread ? `Case aangemaakt van email thread: ${emailThread.subject}` : \"\",\n      priority: \"medium\",\n      status: \"new\",\n      customerId: emailThread?.customerId || null,\n      customerEmail: emailThread?.customerEmail || null,\n      assignedUserId: null,\n      orderId: null,\n    },\n  });\n\n  // Reset form and selections when modal closes\n  useEffect(() => {\n    if (!open) {\n      setSelectedItems(new Map());\n      form.reset();\n    }\n  }, [open, form]);\n\n  // Close dropdown when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (!target.closest('[data-testid=\"order-search-input\"]') && \n          !target.closest('[data-testid=\"order-search-dropdown\"]')) {\n        setOrderSearchOpen(false);\n      }\n    };\n\n    if (orderSearchOpen) {\n      document.addEventListener('mousedown', handleClickOutside);\n      return () => document.removeEventListener('mousedown', handleClickOutside);\n    }\n  }, [orderSearchOpen]);\n\n  // Watch for selected order ID to fetch it separately\n  const selectedOrderId = form.watch(\"orderId\");\n\n  // Fetch specific order when one is selected\n  const { data: selectedOrderData } = useQuery<any>({\n    queryKey: [\"/api/orders\", selectedOrderId],\n    enabled: !!selectedOrderId,\n  });\n\n  // Combine selected order with search results to ensure it's always available\n  const orders = useMemo(() => {\n    const ordersList = ordersData?.orders || [];\n    \n    if (selectedOrderData && !ordersList.find((o: any) => o.id === selectedOrderData.id)) {\n      return [selectedOrderData, ...ordersList];\n    }\n    \n    return ordersList;\n  }, [ordersData, selectedOrderData]);\n\n  // Get selected order and customer info\n  const selectedOrder = orders?.find((o: any) => o.id === selectedOrderId);\n  const selectedCustomerId = form.watch(\"customerId\");\n  const selectedCustomer = customers?.find((c: any) => c.id === selectedCustomerId);\n\n  // Extract line items from selected order\n  const orderLineItems = useMemo(() => {\n    if (!selectedOrder || !selectedOrder.orderData) return [];\n    const lineItems = (selectedOrder.orderData as any).line_items || [];\n    return lineItems.map((item: any, index: number): ShopifyLineItem => ({\n      id: item.id?.toString() || item.sku || `${selectedOrder.id}-line-${index}`,\n      title: item.title || \"Unknown Product\",\n      sku: item.sku || \"\",\n      variantTitle: item.variant_title || \"\",\n      quantity: item.quantity || 1,\n      price: item.price || \"0\",\n    }));\n  }, [selectedOrder]);\n\n  // Handle order selection\n  const handleOrderSelect = (orderId: string) => {\n    const order = orders?.find((o: any) => o.id === orderId);\n    if (order) {\n      // If changing order, reset item selections\n      const currentOrderId = form.getValues(\"orderId\");\n      if (currentOrderId && currentOrderId !== orderId && selectedItems.size > 0) {\n        if (confirm(\"Bestelling wijzigen zal geselecteerde artikelen wissen. Doorgaan?\")) {\n          setSelectedItems(new Map());\n        } else {\n          return;\n        }\n      }\n      \n      form.setValue(\"orderId\", orderId);\n      form.setValue(\"customerId\", order.customerId || null);\n      form.setValue(\"customerEmail\", order.customerEmail || null);\n    }\n    setOrderSearchOpen(false);\n  };\n\n  const createCaseMutation = useMutation({\n    mutationFn: async (data: CreateCaseFormValues & { items?: any[] }) => {\n      const { items, ...caseFields } = data;\n      \n      const caseData = {\n        ...caseFields,\n        orderId: (caseFields.orderId && caseFields.orderId !== \"none\") ? caseFields.orderId : null,\n        assignedUserId: caseFields.assignedUserId || null,\n        items: items || [],\n      };\n      \n      const response = await apiRequest(\"POST\", \"/api/cases\", caseData);\n      const newCase = await response.json();\n      \n      return newCase;\n    },\n    onSuccess: async (newCase) => {\n      // Link email thread if provided\n      if (emailThread?.id) {\n        try {\n          await apiRequest(\"PATCH\", `/api/email-threads/${emailThread.id}`, { caseId: newCase.id });\n        } catch (error) {\n          console.error(\"Failed to link email thread to case:\", error);\n        }\n      }\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/email-threads\"] });\n      \n      toast({\n        title: \"Case aangemaakt\",\n        description: `Case \"${newCase.title}\" (${newCase.caseNumber}) is succesvol aangemaakt${selectedItems.size > 0 ? ` met ${selectedItems.size} artikel(en)` : ''}.`,\n      });\n      \n      onOpenChange(false);\n      form.reset();\n      setSelectedItems(new Map());\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Fout bij aanmaken case\",\n        description: error.message || \"Er is een fout opgetreden bij het aanmaken van de case.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFinalSubmit = (data: CreateCaseFormValues) => {\n    // Convert selectedItems map to array format\n    const items = Array.from(selectedItems.entries()).map(([itemId, itemData]) => {\n      const lineItem = orderLineItems.find((li: ShopifyLineItem) => li.id === itemId);\n      return {\n        sku: lineItem?.sku || \"\",\n        productName: lineItem?.title || \"\",\n        quantity: itemData.quantity,\n        itemNotes: itemData.itemNotes || \"\",\n      };\n    });\n\n    createCaseMutation.mutate({ ...data, items });\n  };\n\n  const onSubmit = (data: CreateCaseFormValues) => {\n    handleFinalSubmit(data);\n  };\n\n  const toggleItemSelection = (itemId: string, checked: boolean) => {\n    const newMap = new Map(selectedItems);\n    if (checked) {\n      newMap.set(itemId, {\n        quantity: 1,\n        itemNotes: \"\",\n      });\n    } else {\n      newMap.delete(itemId);\n    }\n    setSelectedItems(newMap);\n  };\n\n  const updateItemData = (itemId: string, field: keyof SelectedItemData, value: any) => {\n    const newMap = new Map(selectedItems);\n    const itemData = newMap.get(itemId);\n    if (itemData) {\n      newMap.set(itemId, { ...itemData, [field]: value });\n      setSelectedItems(newMap);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"create-case-dialog\">\n        <DialogHeader>\n          <DialogTitle data-testid=\"dialog-title\">\n            Nieuwe Case Aanmaken\n          </DialogTitle>\n          <DialogDescription>\n            Maak een nieuwe case aan om dit klantverzoek gestructureerd te beheren.\n          </DialogDescription>\n        </DialogHeader>\n        \n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            {/* Basic Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-sm font-medium\">Basis Informatie</h3>\n              \n              <FormField\n                control={form.control}\n                name=\"title\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Titel van de Case</FormLabel>\n                    <FormControl>\n                      <Input\n                        placeholder=\"Bijv. Reparatieverzoek iPhone\"\n                        {...field}\n                        data-testid=\"case-title-input\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"description\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Beschrijving</FormLabel>\n                    <FormControl>\n                      <Textarea\n                        placeholder=\"Beschrijf de case...\"\n                        {...field}\n                        value={field.value || \"\"}\n                        data-testid=\"case-description-input\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"priority\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Prioriteit</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value || \"medium\"}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"case-priority-select\">\n                            <SelectValue placeholder=\"Selecteer prioriteit\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"low\">Laag</SelectItem>\n                          <SelectItem value=\"medium\">Gemiddeld</SelectItem>\n                          <SelectItem value=\"high\">Hoog</SelectItem>\n                          <SelectItem value=\"urgent\">Urgent</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"assignedUserId\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Toewijzen aan</FormLabel>\n                      <Select onValueChange={field.onChange} value={field.value || undefined}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"case-assignee-select\">\n                            <SelectValue placeholder=\"Selecteer teamlid\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          {users?.map((user: any) => (\n                            <SelectItem key={user.id} value={user.id}>\n                              {`${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Order Selection */}\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"text-sm font-medium\">Bestelling Koppelen (Optioneel)</h3>\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  <Package className=\"h-3 w-3 mr-1\" />\n                  Optioneel\n                </Badge>\n              </div>\n\n              <FormField\n                control={form.control}\n                name=\"orderId\"\n                render={({ field }) => (\n                  <FormItem className=\"flex flex-col\">\n                    <FormLabel>Zoek Bestelling</FormLabel>\n                    <div className=\"relative\">\n                      <FormControl>\n                        <Input\n                          placeholder=\"Zoek op ordernummer, naam, email...\"\n                          value={orderSearchQuery}\n                          onChange={(e) => {\n                            setOrderSearchQuery(e.target.value);\n                            if (e.target.value.length > 0) {\n                              setOrderSearchOpen(true);\n                            }\n                          }}\n                          onFocus={() => {\n                            if (orderSearchQuery.length > 0) {\n                              setOrderSearchOpen(true);\n                            }\n                          }}\n                          data-testid=\"order-search-input\"\n                          className=\"pr-10\"\n                        />\n                      </FormControl>\n                      <Search className=\"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n                      \n                      {orderSearchOpen && (\n                        <div \n                          className=\"absolute z-[100] w-full mt-1 bg-popover border rounded-md shadow-md max-h-[300px] overflow-y-auto\"\n                          data-testid=\"order-search-dropdown\"\n                        >\n                          {orders.length === 0 ? (\n                            <div className=\"p-4 text-center text-sm text-muted-foreground\">\n                              Geen bestellingen gevonden.\n                            </div>\n                          ) : (\n                            <div className=\"p-1\">\n                              {orders.map((order: any) => (\n                                <div\n                                  key={order.id}\n                                  onClick={() => {\n                                    handleOrderSelect(order.id);\n                                    setOrderSearchOpen(false);\n                                  }}\n                                  className={cn(\n                                    \"relative flex cursor-pointer select-none items-center rounded-sm px-2 py-2 text-sm outline-none hover:bg-accent hover:text-accent-foreground\",\n                                    field.value === order.id && \"bg-accent\"\n                                  )}\n                                  data-testid={`order-option-${order.orderNumber}`}\n                                >\n                                  <Check\n                                    className={cn(\n                                      \"mr-2 h-4 w-4\",\n                                      field.value === order.id ? \"opacity-100\" : \"opacity-0\"\n                                    )}\n                                  />\n                                  <div className=\"flex flex-col flex-1\">\n                                    <span className=\"font-medium\">#{order.orderNumber}</span>\n                                    <span className=\"text-xs text-muted-foreground\">\n                                      {order.customerEmail} ‚Ä¢ ‚Ç¨{(order.totalAmount / 100).toFixed(2)}\n                                    </span>\n                                  </div>\n                                </div>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                    {selectedOrder && (\n                      <div className=\"text-sm text-muted-foreground mt-1\">\n                        Geselecteerd: #{selectedOrder.orderNumber} - ‚Ç¨{(selectedOrder.totalAmount / 100).toFixed(2)}\n                      </div>\n                    )}\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {selectedOrder && (\n                <div className=\"rounded-lg border bg-card p-4 space-y-3\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"space-y-1\">\n                      <p className=\"text-sm font-medium\">Bestelling #{selectedOrder.orderNumber}</p>\n                      <p className=\"text-xs text-muted-foreground\">\n                        {selectedOrder.customerEmail}\n                      </p>\n                    </div>\n                    <Badge variant=\"outline\">{selectedOrder.status}</Badge>\n                  </div>\n\n                  {selectedCustomer && (\n                    <div className=\"space-y-1 text-sm\">\n                      <p><strong>Klant:</strong> {selectedCustomer.firstName} {selectedCustomer.lastName}</p>\n                      {selectedCustomer.phone && (\n                        <p><strong>Telefoon:</strong> {selectedCustomer.phone}</p>\n                      )}\n                    </div>\n                  )}\n\n                  <div className=\"flex items-center gap-4 text-sm\">\n                    <span className=\"text-muted-foreground\">\n                      Totaal: <strong>‚Ç¨{(selectedOrder.totalAmount / 100).toFixed(2)}</strong>\n                    </span>\n                    <span className=\"text-muted-foreground\">\n                      Datum: {new Date(selectedOrder.orderDate).toLocaleDateString('nl-NL')}\n                    </span>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Item Selection */}\n            {selectedOrder && orderLineItems.length > 0 && (\n              <>\n                <Separator />\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <h3 className=\"text-sm font-medium\">Selecteer Artikelen (Optioneel)</h3>\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      {selectedItems.size} van {orderLineItems.length} geselecteerd\n                    </Badge>\n                  </div>\n\n                  <ScrollArea className=\"h-[300px] rounded-md border p-4\">\n                    <div className=\"space-y-4\">\n                      {orderLineItems.map((item: ShopifyLineItem) => (\n                        <div\n                          key={item.id}\n                          className=\"flex items-start space-x-3 rounded-lg border p-3\"\n                          data-testid={`item-${item.sku}`}\n                        >\n                          <Checkbox\n                            checked={selectedItems.has(item.id)}\n                            onCheckedChange={(checked) => toggleItemSelection(item.id, checked as boolean)}\n                            data-testid={`checkbox-item-${item.sku}`}\n                          />\n                          <div className=\"flex-1 space-y-2\">\n                            <div>\n                              <p className=\"font-medium text-sm\">{item.title}</p>\n                              {item.variantTitle && (\n                                <p className=\"text-xs text-muted-foreground\">{item.variantTitle}</p>\n                              )}\n                              <p className=\"text-xs text-muted-foreground\">SKU: {item.sku}</p>\n                            </div>\n\n                            {selectedItems.has(item.id) && (\n                              <div className=\"space-y-2 pt-2\">\n                                <div className=\"grid grid-cols-2 gap-2\">\n                                  <div>\n                                    <label className=\"text-xs font-medium\">Aantal</label>\n                                    <Input\n                                      type=\"number\"\n                                      min=\"1\"\n                                      max={item.quantity}\n                                      value={selectedItems.get(item.id)?.quantity || 1}\n                                      onChange={(e) =>\n                                        updateItemData(item.id, \"quantity\", parseInt(e.target.value) || 1)\n                                      }\n                                      className=\"h-8\"\n                                      data-testid={`quantity-input-${item.sku}`}\n                                    />\n                                  </div>\n                                </div>\n                                <div>\n                                  <label className=\"text-xs font-medium\">Notities</label>\n                                  <Textarea\n                                    placeholder=\"Bijv. camera werkt niet, scherm kapot...\"\n                                    value={selectedItems.get(item.id)?.itemNotes || \"\"}\n                                    onChange={(e) =>\n                                      updateItemData(item.id, \"itemNotes\", e.target.value)\n                                    }\n                                    className=\"min-h-[60px] text-sm\"\n                                    data-testid={`notes-input-${item.sku}`}\n                                  />\n                                </div>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </ScrollArea>\n                </div>\n              </>\n            )}\n\n            {/* Email Thread Info */}\n            {emailThread && (\n              <>\n                <Separator />\n                <div className=\"rounded-lg border bg-muted p-4 space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Mail className=\"h-4 w-4\" />\n                    <h4 className=\"font-medium text-sm\">Email Thread Gekoppeld</h4>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground\">\n                    <strong>Van:</strong> {emailThread.customerEmail}\n                  </p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    <strong>Onderwerp:</strong> {emailThread.subject}\n                  </p>\n                </div>\n              </>\n            )}\n\n            {/* Submit Buttons */}\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => onOpenChange(false)}\n                data-testid=\"cancel-button\"\n              >\n                Annuleren\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={createCaseMutation.isPending}\n                data-testid=\"submit-button\"\n              >\n                {createCaseMutation.isPending ? \"Aanmaken...\" : \"Case Aanmaken\"}\n              </Button>\n            </div>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":25284},"server/services/supabaseClient.ts":{"content":"import { drizzle } from \"drizzle-orm/postgres-js\";\nimport postgres from \"postgres\";\nimport * as schema from \"@shared/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL environment variable is required\");\n}\n\n// Create the connection\nconst connectionString = process.env.DATABASE_URL;\nconst client = postgres(connectionString);\n\n// Initialize Drizzle with the schema\nexport const db = drizzle(client, { schema });\n\nexport type Database = typeof db;\n","size_bytes":471},"client/src/pages/user-management.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { Plus, Edit, Trash2, Shield, User, Mail } from \"lucide-react\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport type { User as UserType } from \"@shared/schema\";\n\nconst userFormSchema = z.object({\n  email: z.string().email(\"Please enter a valid email address\"),\n  password: z.string().min(6, \"Password must be at least 6 characters\"),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  role: z.enum([\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"], {\n    required_error: \"Please select a role\",\n  }),\n});\n\nconst editUserFormSchema = z.object({\n  email: z.string().email(\"Please enter a valid email address\"),\n  firstName: z.string().min(1, \"First name is required\"),\n  lastName: z.string().min(1, \"Last name is required\"),\n  role: z.enum([\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"], {\n    required_error: \"Please select a role\",\n  }),\n});\n\ntype UserForm = z.infer<typeof userFormSchema>;\ntype EditUserForm = z.infer<typeof editUserFormSchema>;\n\nconst roleColors = {\n  ADMIN: \"destructive\",\n  SUPPORT: \"secondary\", \n  TECHNICUS: \"default\",\n} as const;\n\nconst roleLabels = {\n  ADMIN: \"Beheerder\",\n  SUPPORT: \"Support\", \n  TECHNICUS: \"Technicus\",\n} as const;\n\nexport default function UserManagement() {\n  const [createDialogOpen, setCreateDialogOpen] = useState(false);\n  const [editDialogOpen, setEditDialogOpen] = useState(false);\n  const [editingUser, setEditingUser] = useState<UserType | null>(null);\n  const { toast } = useToast();\n\n  // Fetch users\n  const { data: users = [], isLoading } = useQuery<UserType[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  // Create user mutation\n  const createUserMutation = useMutation({\n    mutationFn: (userData: UserForm) => apiRequest(\"POST\", \"/api/users\", userData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setCreateDialogOpen(false);\n      createForm.reset();\n      toast({\n        title: \"User created\",\n        description: \"New user account has been created successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to create user\",\n        description: error.message || \"An error occurred while creating the user.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update user mutation\n  const updateUserMutation = useMutation({\n    mutationFn: ({ id, ...userData }: EditUserForm & { id: string }) => apiRequest(\"PATCH\", `/api/users/${id}`, userData),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setEditDialogOpen(false);\n      setEditingUser(null);\n      editForm.reset();\n      toast({\n        title: \"User updated\",\n        description: \"User account has been updated successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to update user\",\n        description: error.message || \"An error occurred while updating the user.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Delete user mutation\n  const deleteUserMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/users/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({\n        title: \"User deleted\",\n        description: \"User account has been deleted successfully.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to delete user\",\n        description: error.message || \"An error occurred while deleting the user.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Form setup\n  const createForm = useForm<UserForm>({\n    resolver: zodResolver(userFormSchema),\n    defaultValues: {\n      email: \"\",\n      password: \"\",\n      firstName: \"\",\n      lastName: \"\",\n      role: \"SUPPORT\",\n    },\n  });\n\n  const editForm = useForm<EditUserForm>({\n    resolver: zodResolver(editUserFormSchema),\n    defaultValues: {\n      email: \"\",\n      firstName: \"\",\n      lastName: \"\",\n      role: \"SUPPORT\",\n    },\n  });\n\n  const handleEdit = (user: UserType) => {\n    setEditingUser(user);\n    editForm.reset({\n      email: user.email,\n      firstName: user.firstName || \"\",\n      lastName: user.lastName || \"\",\n      role: user.role,\n    });\n    setEditDialogOpen(true);\n  };\n\n  const handleDelete = (user: UserType) => {\n    if (confirm(`Are you sure you want to delete ${user.firstName} ${user.lastName}? This action cannot be undone.`)) {\n      deleteUserMutation.mutate(user.id);\n    }\n  };\n\n  const onCreateSubmit = (data: UserForm) => {\n    createUserMutation.mutate(data);\n  };\n\n  const onEditSubmit = (data: EditUserForm) => {\n    if (editingUser) {\n      updateUserMutation.mutate({ id: editingUser.id, ...data });\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Navigation />\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Navigation />\n      <main className=\"p-6\">\n        <div className=\"space-y-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold text-foreground\">User Management</h1>\n              <p className=\"text-muted-foreground\">Manage user accounts and permissions</p>\n            </div>\n            <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>\n          <DialogTrigger asChild>\n            <Button className=\"gap-2\" data-testid=\"button-create-user\">\n              <Plus className=\"h-4 w-4\" />\n              Create User\n            </Button>\n          </DialogTrigger>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Create New User</DialogTitle>\n              <DialogDescription>\n                Create a new user account with the specified role and permissions.\n              </DialogDescription>\n            </DialogHeader>\n            <Form {...createForm}>\n              <form onSubmit={createForm.handleSubmit(onCreateSubmit)} className=\"space-y-4\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={createForm.control}\n                    name=\"firstName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>First Name</FormLabel>\n                        <FormControl>\n                          <Input {...field} data-testid=\"input-first-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <FormField\n                    control={createForm.control}\n                    name=\"lastName\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Last Name</FormLabel>\n                        <FormControl>\n                          <Input {...field} data-testid=\"input-last-name\" />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n                <FormField\n                  control={createForm.control}\n                  name=\"email\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Email</FormLabel>\n                      <FormControl>\n                        <Input type=\"email\" {...field} data-testid=\"input-email\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={createForm.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Password</FormLabel>\n                      <FormControl>\n                        <Input type=\"password\" {...field} data-testid=\"input-password\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={createForm.control}\n                  name=\"role\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Role</FormLabel>\n                      <Select onValueChange={field.onChange} defaultValue={field.value}>\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-role\">\n                            <SelectValue placeholder=\"Select a role\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"ADMIN\">Beheerder (Full Access)</SelectItem>\n                          <SelectItem value=\"SUPPORT\">Support (Cases & Inbox)</SelectItem>\n                          <SelectItem value=\"TECHNICUS\">Technicus (Repairs Only)</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <div className=\"flex justify-end gap-3\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setCreateDialogOpen(false)}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={createUserMutation.isPending}\n                    data-testid=\"button-submit-create\"\n                  >\n                    {createUserMutation.isPending ? \"Creating...\" : \"Create User\"}\n                  </Button>\n                </div>\n              </form>\n            </Form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <User className=\"h-5 w-5\" />\n            Users ({users.length})\n          </CardTitle>\n          <CardDescription>\n            Manage user accounts, roles, and permissions\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {users.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <User className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <p className=\"text-muted-foreground\">No users found</p>\n            </div>\n          ) : (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Name</TableHead>\n                  <TableHead>Email</TableHead>\n                  <TableHead>Role</TableHead>\n                  <TableHead>Created</TableHead>\n                  <TableHead className=\"text-right\">Actions</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {users.map((user) => (\n                  <TableRow key={user.id} data-testid={`row-user-${user.id}`}>\n                    <TableCell>\n                      <div className=\"font-medium\">\n                        {user.firstName} {user.lastName}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <div className=\"flex items-center gap-2\">\n                        <Mail className=\"h-4 w-4 text-muted-foreground\" />\n                        {user.email}\n                      </div>\n                    </TableCell>\n                    <TableCell>\n                      <Badge variant={roleColors[user.role as keyof typeof roleColors]} className=\"gap-1\">\n                        <Shield className=\"h-3 w-3\" />\n                        {roleLabels[user.role as keyof typeof roleLabels]}\n                      </Badge>\n                    </TableCell>\n                    <TableCell className=\"text-muted-foreground\">\n                      {user.createdAt ? new Date(user.createdAt).toLocaleDateString() : \"N/A\"}\n                    </TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center gap-2 justify-end\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleEdit(user)}\n                          data-testid={`button-edit-${user.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleDelete(user)}\n                          className=\"text-destructive hover:text-destructive\"\n                          data-testid={`button-delete-${user.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Edit User Dialog */}\n      <Dialog open={editDialogOpen} onOpenChange={setEditDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Edit User</DialogTitle>\n            <DialogDescription>\n              Update user information and role permissions.\n            </DialogDescription>\n          </DialogHeader>\n          <Form {...editForm}>\n            <form onSubmit={editForm.handleSubmit(onEditSubmit)} className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <FormField\n                  control={editForm.control}\n                  name=\"firstName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>First Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"input-edit-first-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n                <FormField\n                  control={editForm.control}\n                  name=\"lastName\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Last Name</FormLabel>\n                      <FormControl>\n                        <Input {...field} data-testid=\"input-edit-last-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n              <FormField\n                control={editForm.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Email</FormLabel>\n                    <FormControl>\n                      <Input type=\"email\" {...field} data-testid=\"input-edit-email\" />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <FormField\n                control={editForm.control}\n                name=\"role\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Role</FormLabel>\n                    <Select onValueChange={field.onChange} value={field.value}>\n                      <FormControl>\n                        <SelectTrigger data-testid=\"select-edit-role\">\n                          <SelectValue placeholder=\"Select a role\" />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"ADMIN\">Beheerder (Full Access)</SelectItem>\n                        <SelectItem value=\"SUPPORT\">Support (Cases & Inbox)</SelectItem>\n                        <SelectItem value=\"TECHNICUS\">Technicus (Repairs Only)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n              <div className=\"flex justify-end gap-3\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setEditDialogOpen(false)}\n                  data-testid=\"button-edit-cancel\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={updateUserMutation.isPending}\n                  data-testid=\"button-submit-edit\"\n                >\n                  {updateUserMutation.isPending ? \"Updating...\" : \"Update User\"}\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </DialogContent>\n      </Dialog>\n        </div>\n      </main>\n    </div>\n  );\n}","size_bytes":18264},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1383},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"replit.md":{"content":"# DutchThrift Dashboard\n\n## Overview\n\nDutchThrift Dashboard is a comprehensive customer service and order management platform built with modern web technologies. The application serves as a centralized hub for managing customer communications, order processing, repair workflows, and team collaboration. It features a responsive React frontend with TypeScript, Express.js backend, and PostgreSQL database with Drizzle ORM.\n\nThe platform integrates with external services including Shopify for order management and Microsoft Graph API for email synchronization, providing a unified interface for customer service operations.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n- **Framework**: React with TypeScript using Vite as the build tool\n- **UI Components**: Radix UI primitives with Tailwind CSS for styling\n- **State Management**: TanStack Query for server state management\n- **Routing**: Wouter for client-side routing\n- **Styling**: Tailwind CSS with CSS variables for theming\n- **Component Library**: Custom component system built on Radix UI with shadcn/ui design patterns\n\n### Backend Architecture\n- **Runtime**: Node.js with Express.js framework\n- **Language**: TypeScript with ES modules\n- **API Design**: RESTful API with JSON communication\n- **Error Handling**: Centralized error handling middleware\n- **Request Logging**: Custom middleware for API request/response logging\n- **Scheduled Jobs**: Node-cron for automated background tasks (hourly Shopify sync)\n\n### Database Design\n- **Database**: PostgreSQL with Drizzle ORM\n- **Schema Management**: Type-safe schema definitions with validation using Zod\n- **Migrations**: Drizzle Kit for database migrations\n- **Connection**: Neon serverless PostgreSQL database\n\n### Key Data Models\n- **Users**: Role-based access control (admin, agent, repair_tech, viewer)\n- **Customers**: Customer information with Shopify integration\n- **Orders**: Synchronized with Shopify, includes status tracking\n- **Email Threads**: Email communication management with status tracking\n- **Repairs**: Repair workflow management with status progression\n- **Todos**: Task management with priority and assignment\n- **Activities**: Audit trail and team activity tracking\n- **Notes Domain**: Advanced notes system with threading, attachments, mentions, reactions, templates, and smart linking (see Notes System section below)\n\n### Authentication & Authorization\n- **Session Management**: Express sessions with PostgreSQL storage\n- **Role-Based Access Control**: Four user roles with different permission levels\n- **Security**: Password hashing and session-based authentication\n\n### User Interface Design\n- **Navigation**: Top navigation bar with global search and command palette\n- **Theme Support**: Light/dark theme switching with system preference detection\n- **Responsive Design**: Mobile-first approach with adaptive layouts\n- **Accessibility**: ARIA labels and keyboard navigation support\n\n### Email Management\n- **Integration**: Microsoft Graph API for Outlook email synchronization\n- **Thread Management**: Grouped email conversations with status tracking\n- **Compose & Reply**: Built-in email composition with rich text support\n- **Search**: Global search across email threads and messages\n\n### Order Management\n- **Shopify Integration**: Real-time synchronization of order data\n- **Automatic Sync**: Scheduled hourly sync running in background (every hour at :00)\n- **Manual Sync**: On-demand sync button for immediate synchronization\n- **Incremental Sync**: Only fetches new/updated orders since last sync for efficiency\n- **Status Tracking**: Order lifecycle management from pending to completion\n- **Customer Linking**: Automatic customer profile creation and linking\n\n### Repair Workflow\n- **Kanban Board**: Visual repair status management\n- **Priority System**: Four-level priority system (low, medium, high, urgent)\n- **SLA Tracking**: Deadline management with alert system\n- **Status Progression**: Six-stage repair workflow (new ‚Üí in_progress ‚Üí waiting_customer ‚Üí waiting_part ‚Üí ready ‚Üí closed)\n\n### Task Management\n- **Personal Todos**: User-specific task assignments\n- **Priority Management**: Task prioritization with deadline tracking\n- **Team Collaboration**: Task assignment and status updates\n\n### Notes System (Universal - Production Ready)\nThe platform features a comprehensive Shopify-quality Notes system for centralized communication, decisions, and evidence tracking across all entities (customers, orders, repairs, email threads, cases, returns). **Status: Fully implemented and deployed website-wide.**\n\n**Core Features:**\n- **Polymorphic Linking**: Notes can be attached to any entity type via entity_type and entity_id fields\n- **Visibility Control**: Three visibility levels (internal, customer_visible, system) with backend enforcement\n- **Threading**: Reply support with parent_note_id and thread_depth tracking (max depth 2)\n- **Rich Content**: TipTap rich text editor with HTML sanitization and plain text extraction for search\n\n**Collaboration Features:**\n- **Mentions**: @user autocomplete with live user search and notification tracking\n- **Reactions**: Emoji reactions (üëç üëÄ ‚úÖ) with unique constraint per user+emoji combination\n- **Pinning**: Up to 3 pinned notes per entity enforced via partial unique index\n- **Tags**: Color-coded tags with multi-select filtering and badge display\n\n**Content Management:**\n- **Attachments**: File upload with preview, drag-and-drop support, object storage integration\n- **Templates**: Template dropdown with variable substitution ({{orderNumber}}, {{customerName}}, {{today}})\n- **Smart Links**: Auto-detection of order IDs, tracking codes, SKUs (planned)\n- **Edit History**: Full revision tracking with delta visualization (planned)\n\n**Workflow Integration:**\n- **Follow-ups**: Dialog to convert notes to Todos with due dates and assignee selection\n- **Audit Trail**: Soft delete with required reason, preserves full history\n- **Status Integration**: Contextual templates based on entity status\n\n**Search & Filtering:**\n- **Multi-Dimensional Filters**: Search bar, author dropdown, tag multi-select, date range, visibility toggle\n- **Clear Filters**: Single-click to reset all active filters\n- **Real-time Results**: Client-side filtering with server-side support for visibility/author/tags\n- **Result Counts**: Shows \"X notes (filtered from Y)\" when filters active\n\n**UI Components (Production):**\n- **NotesPanel**: Main container with filters, composer, note list (pinned + unpinned + deleted sections)\n- **NoteComposer**: TipTap rich text editor with formatting toolbar, visibility toggle, tag selector, template dropdown\n- **NoteItem**: Note display with author avatar, timestamp, content, reactions, action menu (pin/edit/delete/reply/followup)\n- **NoteThread**: Threaded reply display with max depth 2 and visual indentation\n- **AttachmentUpload**: Drag-and-drop file upload with progress and preview\n- **MentionsAutocomplete**: @-triggered user search with keyboard navigation\n- **NoteEditDialog**: Edit note with revision history\n- **NoteFollowupDialog**: Create Todo from note with due date picker\n\n**Keyboard Shortcuts:**\n- Ctrl+Enter: Submit note\n- /: Focus composer (planned)\n- @: Trigger mentions autocomplete\n- Esc: Close dialogs\n\n**Accessibility:**\n- ARIA labels on all interactive elements\n- Keyboard navigation support\n- Role attributes for semantic structure\n- Screen reader friendly content\n\n**Performance Optimization:**\n- Composite indexes on (entity_type, entity_id, deleted_at, created_at) for listing\n- Partial indexes on parent_note_id (threading) and is_pinned (quick pin lookup)\n- Unique constraints prevent duplicate tags, mentions, and reactions\n- GIN index for full-text search on note content\n- TanStack Query caching with smart invalidation\n\n**Data Integrity:**\n- CASCADE DELETE on all child tables (tags, mentions, reactions, attachments, revisions, links, follow-ups)\n- NO ACTION on user references to preserve audit trail\n- Unique constraints on note_tag_assignments, note_mentions, and note_reactions\n\n**Integration Status:**\n- ‚úÖ Orders page (client/src/pages/orders.tsx)\n- ‚úÖ Returns list page (client/src/pages/returns.tsx)\n- ‚úÖ Return detail page (client/src/pages/return-detail.tsx)\n- ‚úÖ Case detail page (client/src/pages/case-detail.tsx)\n- ‚úÖ Case detail modal (client/src/components/cases/case-detail-modal.tsx)\n- ‚úÖ Customer detail page (client/src/pages/customer-detail.tsx)\n- ‚úÖ Task detail modal (client/src/components/todos/task-detail-modal.tsx)\n\n**Recent Updates (Nov 11, 2025):**\n- Fixed critical apiRequest parameter order bug (method, url, data)\n- Added null date handling for createdAt fields\n- Completed universal rollout across all entity types\n- Added comprehensive filters and template support\n- Implemented keyboard shortcuts and accessibility features\n\n## External Dependencies\n\n### Core Infrastructure\n- **Database**: Neon PostgreSQL serverless database\n- **File Storage**: Supabase for secure file storage and attachments\n\n### Third-Party Integrations\n- **Shopify API**: Order management and customer data synchronization\n- **Microsoft Graph API**: Email synchronization and management via Outlook\n- **IMAP Protocol**: Direct mailbox access for email synchronization\n\n### Development Tools\n- **Drizzle ORM**: Type-safe database interactions and migrations\n- **TanStack Query**: Server state management and caching\n- **Zod**: Runtime type validation and schema definition\n- **React Hook Form**: Form handling with validation\n- **Radix UI**: Accessible component primitives\n- **Tailwind CSS**: Utility-first CSS framework\n\n### Build & Deployment\n- **Vite**: Frontend build tool with hot module replacement\n- **ESBuild**: Backend bundling for production\n- **TypeScript**: Type safety across the entire application\n- **PostCSS**: CSS processing with Tailwind and Autoprefixer\n\n### Monitoring & Development\n- **Replit Integration**: Development environment with runtime error overlay\n- **Custom Logging**: Request/response logging with performance metrics\n- **Error Boundaries**: React error handling with user-friendly fallbacks","size_bytes":10207},"client/src/components/notes/internal-notes.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { RichTextEditor } from \"@/components/ui/rich-text-editor\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { MessageSquarePlus, Send, User, Clock, Trash2 } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { InternalNote, InsertInternalNote } from \"@/lib/types\";\n\n// InternalNote type is imported from types\n\ninterface InternalNotesProps {\n  entityType: 'customer' | 'order' | 'repair' | 'emailThread' | 'case' | 'return';\n  entityId: string;\n  entityTitle?: string;\n}\n\nexport function InternalNotes({ entityType, entityId, entityTitle }: InternalNotesProps) {\n  const [newNote, setNewNote] = useState(\"\");\n  const [isExpanded, setIsExpanded] = useState(false);\n  const [noteToDelete, setNoteToDelete] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const { data: notes, isLoading } = useQuery<InternalNote[]>({\n    queryKey: ['/api/notes', entityType, entityId],\n  });\n\n  const createNoteMutation = useMutation({\n    mutationFn: async (noteData: InsertInternalNote) => {\n      const response = await fetch(\"/api/notes\", {\n        method: \"POST\", \n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(noteData)\n      });\n      if (!response.ok) throw new Error('Failed to create note');\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/notes', entityType, entityId] });\n      setNewNote(\"\");\n      setIsExpanded(false);\n      toast({\n        title: \"Note added\",\n        description: \"Internal note has been saved successfully.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to save note. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const deleteNoteMutation = useMutation({\n    mutationFn: async (noteId: string) => {\n      const response = await fetch(`/api/notes/${noteId}`, {\n        method: \"DELETE\",\n      });\n      if (!response.ok) throw new Error('Failed to delete note');\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/notes', entityType, entityId] });\n      setNoteToDelete(null);\n      toast({\n        title: \"Note deleted\",\n        description: \"The note has been deleted successfully.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete note. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSubmitNote = () => {\n    const noteText = newNote.replace(/<[^>]*>/g, '').trim();\n    if (!noteText) return;\n\n    const noteData: InsertInternalNote = {\n      content: newNote,\n      authorId: \"\", // Will be set by the backend using the authenticated user\n      ...(entityType === 'customer' && { customerId: entityId }),\n      ...(entityType === 'order' && { orderId: entityId }),\n      ...(entityType === 'repair' && { repairId: entityId }),\n      ...(entityType === 'emailThread' && { emailThreadId: entityId }),\n      ...(entityType === 'case' && { caseId: entityId }),\n      ...(entityType === 'return' && { returnId: entityId }),\n    };\n\n    createNoteMutation.mutate(noteData);\n  };\n\n  const getEntityTypeDisplay = (type: string) => {\n    const displays = {\n      customer: \"Customer\",\n      order: \"Order\", \n      repair: \"Repair\",\n      emailThread: \"Email Thread\"\n    };\n    return displays[type as keyof typeof displays] || type;\n  };\n\n  const getAuthorInitials = (authorId: string) => {\n    // TODO: Fetch actual user data - for now using placeholder\n    return \"JD\";\n  };\n\n  return (\n    <Card className=\"w-full\" data-testid=\"internal-notes-card\">\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <MessageSquarePlus className=\"h-5 w-5 text-muted-foreground\" />\n            <CardTitle className=\"text-lg\">Internal Notes</CardTitle>\n            {notes && notes.length > 0 && (\n              <Badge variant=\"secondary\" className=\"ml-2\">\n                {notes.length}\n              </Badge>\n            )}\n          </div>\n          <Button \n            variant=\"outline\" \n            size=\"sm\"\n            onClick={() => {\n              console.log('Add Note clicked, isExpanded:', isExpanded);\n              setIsExpanded(!isExpanded);\n            }}\n            data-testid=\"add-note-button\"\n          >\n            <MessageSquarePlus className=\"h-4 w-4 mr-2\" />\n            {isExpanded ? 'Cancel' : 'Add Note'}\n          </Button>\n        </div>\n        {entityTitle && (\n          <CardDescription>\n            Notes for {getEntityTypeDisplay(entityType)}: {entityTitle}\n          </CardDescription>\n        )}\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {/* Add New Note Form */}\n        {isExpanded && (\n          <div className=\"space-y-3 p-4 border rounded-lg bg-muted/20\" data-testid=\"note-form\">\n            <RichTextEditor\n              content={newNote}\n              onChange={setNewNote}\n              placeholder=\"Add an internal note for your team...\"\n              className=\"min-h-[100px]\"\n            />\n            <div className=\"flex items-center gap-2\">\n              <Button\n                onClick={handleSubmitNote}\n                disabled={!newNote.replace(/<[^>]*>/g, '').trim() || createNoteMutation.isPending}\n                size=\"sm\"\n                data-testid=\"submit-note-button\"\n              >\n                <Send className=\"h-4 w-4 mr-2\" />\n                {createNoteMutation.isPending ? \"Saving...\" : \"Add Note\"}\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setIsExpanded(false);\n                  setNewNote(\"\");\n                }}\n                size=\"sm\"\n                data-testid=\"cancel-note-button\"\n              >\n                Cancel\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {/* Notes List */}\n        {isLoading ? (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Loading notes...\n          </div>\n        ) : notes && notes.length > 0 ? (\n          <div className=\"space-y-4\" data-testid=\"notes-list\">\n            {notes.map((note: InternalNote, index: number) => (\n              <div key={note.id}>\n                <div className=\"flex gap-3\">\n                  <Avatar className=\"h-8 w-8 flex-shrink-0\">\n                    <AvatarFallback className=\"text-xs bg-primary/10\">\n                      {getAuthorInitials(note.authorId)}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div className=\"flex-1 space-y-2\">\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                      <User className=\"h-3 w-3\" />\n                      <span>Team Member</span>\n                      <Clock className=\"h-3 w-3 ml-2\" />\n                      <span>{note.createdAt ? formatDistanceToNow(new Date(note.createdAt), { addSuffix: true }) : 'Unknown time'}</span>\n                    </div>\n                    <div \n                      className=\"prose prose-sm dark:prose-invert max-w-none text-sm leading-relaxed\"\n                      dangerouslySetInnerHTML={{ __html: note.content }}\n                    />\n                    {note.mentions && note.mentions.length > 0 && (\n                      <div className=\"flex gap-1\">\n                        {note.mentions.map((mentionId: string) => (\n                          <Badge key={mentionId} variant=\"outline\" className=\"text-xs\">\n                            @{mentionId.slice(0, 8)}\n                          </Badge>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setNoteToDelete(note.id)}\n                    data-testid={`delete-note-${note.id}`}\n                  >\n                    <Trash2 className=\"h-4 w-4 text-muted-foreground hover:text-destructive\" />\n                  </Button>\n                </div>\n                {index < notes.length - 1 && <Separator className=\"mt-4\" />}\n              </div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"no-notes-message\">\n            <MessageSquarePlus className=\"h-12 w-12 mx-auto mb-3 text-muted-foreground/50\" />\n            <p className=\"text-sm\">No internal notes yet</p>\n            <p className=\"text-xs mt-1\">Add the first note to share information with your team</p>\n          </div>\n        )}\n      </CardContent>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={!!noteToDelete} onOpenChange={() => setNoteToDelete(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Delete Note</AlertDialogTitle>\n            <AlertDialogDescription>\n              Are you sure you want to delete this note? This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"cancel-delete-note\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => noteToDelete && deleteNoteMutation.mutate(noteToDelete)}\n              disabled={deleteNoteMutation.isPending}\n              data-testid=\"confirm-delete-note\"\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              {deleteNoteMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </Card>\n  );\n}","size_bytes":10528},"client/src/components/widgets/sla-alerts-widget.tsx":{"content":"import { AlertTriangle } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { DashboardStats } from \"@/lib/types\";\n\nexport function SlaAlertsWidget() {\n  const { data: stats, isLoading } = useQuery<DashboardStats>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  if (isLoading) {\n    return (\n      <Card data-testid=\"sla-alerts-widget\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse\">\n            <div className=\"h-4 bg-muted rounded mb-2\"></div>\n            <div className=\"h-8 bg-muted rounded mb-1\"></div>\n            <div className=\"h-3 bg-muted rounded\"></div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"hover:shadow-card-hover border-destructive/20\" data-testid=\"sla-alerts-widget\">\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-semibold text-muted-foreground\">SLA Alerts</CardTitle>\n        <div className=\"h-10 w-10 rounded-full bg-destructive/10 flex items-center justify-center border-2 border-destructive/20\">\n          <AlertTriangle className=\"h-5 w-5 text-destructive\" />\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-2\">\n          <div className=\"text-3xl font-bold text-destructive\" data-testid=\"sla-alerts-count\">\n            {stats?.slaAlerts || 0}\n          </div>\n          <p className=\"text-sm font-medium text-muted-foreground\">Overdue items</p>\n          <div className=\"flex items-center text-sm\">\n            <span className=\"text-warning font-semibold\" data-testid=\"sla-due-today\">\n              {(stats?.slaAlerts || 0) * 3} due today\n            </span>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1885},"client/src/components/layout/admin-layout.tsx":{"content":"import { useState } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { useAuth } from \"@/lib/auth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { \n  DropdownMenu, \n  DropdownMenuContent, \n  DropdownMenuItem, \n  DropdownMenuLabel, \n  DropdownMenuSeparator, \n  DropdownMenuTrigger \n} from \"@/components/ui/dropdown-menu\";\nimport { \n  Home,\n  Users, \n  Inbox,\n  FileText,\n  Wrench,\n  Menu,\n  X,\n  LogOut,\n  Settings\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface AdminLayoutProps {\n  children: React.ReactNode;\n}\n\nexport default function AdminLayout({ children }: AdminLayoutProps) {\n  const { user, signOut } = useAuth();\n  const [location] = useLocation();\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n\n  if (!user) return null;\n\n  // Navigation items based on user role\n  const getNavigation = () => {\n    const baseNav = [\n      { name: \"Home\", href: \"/\", icon: Home, roles: [\"ADMIN\", \"SUPPORT\", \"TECHNICUS\"] },\n    ];\n\n    const roleBasedNav = [];\n\n    if ([\"ADMIN\"].includes(user.role)) {\n      roleBasedNav.push(\n        { name: \"Users\", href: \"/users\", icon: Users, roles: [\"ADMIN\"] }\n      );\n    }\n\n    if ([\"ADMIN\", \"TECHNICUS\"].includes(user.role)) {\n      roleBasedNav.push(\n        { name: \"Reparaties\", href: \"/repairs\", icon: Wrench, roles: [\"ADMIN\", \"TECHNICUS\"] }\n      );\n    }\n\n    if ([\"ADMIN\", \"SUPPORT\"].includes(user.role)) {\n      roleBasedNav.push(\n        { name: \"Cases\", href: \"/cases\", icon: FileText, roles: [\"ADMIN\", \"SUPPORT\"] },\n        { name: \"Inbox\", href: \"/inbox\", icon: Inbox, roles: [\"ADMIN\", \"SUPPORT\"] }\n      );\n    }\n\n    return [...baseNav, ...roleBasedNav];\n  };\n\n  const navigation = getNavigation();\n\n  const handleSignOut = async () => {\n    try {\n      await signOut();\n    } catch (error) {\n      console.error(\"Sign out error:\", error);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      {/* Mobile sidebar overlay */}\n      {sidebarOpen && (\n        <div \n          className=\"fixed inset-0 z-40 bg-black bg-opacity-25 lg:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        />\n      )}\n\n      {/* Sidebar */}\n      <div className={cn(\n        \"fixed inset-y-0 left-0 z-50 w-64 bg-card border-r transform transition-transform duration-200 ease-in-out lg:translate-x-0\",\n        sidebarOpen ? \"translate-x-0\" : \"-translate-x-full lg:translate-x-0\"\n      )}>\n        <div className=\"flex items-center justify-between p-6 border-b\">\n          <h1 className=\"text-xl font-bold text-foreground\">DutchThrift</h1>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={() => setSidebarOpen(false)}\n            className=\"lg:hidden\"\n            data-testid=\"button-close-sidebar\"\n          >\n            <X className=\"h-4 w-4\" />\n          </Button>\n        </div>\n\n        <nav className=\"mt-6 px-3\">\n          {navigation.map((item) => {\n            const isActive = location === item.href || \n              (item.href !== \"/\" && location.startsWith(item.href));\n            \n            return (\n              <Link key={item.name} href={item.href}>\n                <a className={cn(\n                  \"flex items-center px-3 py-2 text-sm font-medium rounded-md mb-1 transition-colors\",\n                  isActive \n                    ? \"bg-primary text-primary-foreground\" \n                    : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                )} data-testid={`link-nav-${item.name.toLowerCase()}`}>\n                  <item.icon className=\"mr-3 h-4 w-4\" />\n                  {item.name}\n                </a>\n              </Link>\n            );\n          })}\n        </nav>\n      </div>\n\n      {/* Main content */}\n      <div className=\"lg:pl-64\">\n        {/* Top header */}\n        <header className=\"sticky top-0 z-30 bg-background border-b px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex h-16 items-center justify-between\">\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setSidebarOpen(true)}\n              className=\"lg:hidden\"\n              data-testid=\"button-open-sidebar\"\n            >\n              <Menu className=\"h-5 w-5\" />\n            </Button>\n\n            <div className=\"flex items-center space-x-4\">\n              {/* User dropdown */}\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"ghost\" className=\"flex items-center space-x-2\" data-testid=\"button-user-menu\">\n                    <Avatar className=\"h-8 w-8\">\n                      <AvatarFallback>\n                        {user.firstName?.[0]}{user.lastName?.[0]}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"hidden md:block text-left\">\n                      <div className=\"text-sm font-medium\">{user.firstName} {user.lastName}</div>\n                      <div className=\"text-xs text-muted-foreground capitalize\">{user.role.toLowerCase()}</div>\n                    </div>\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\" className=\"w-56\">\n                  <DropdownMenuLabel data-testid=\"text-user-info\">\n                    <div>{user.firstName} {user.lastName}</div>\n                    <div className=\"text-xs text-muted-foreground font-normal\">{user.email}</div>\n                  </DropdownMenuLabel>\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem data-testid=\"button-settings\">\n                    <Settings className=\"mr-2 h-4 w-4\" />\n                    Settings\n                  </DropdownMenuItem>\n                  <DropdownMenuSeparator />\n                  <DropdownMenuItem onClick={handleSignOut} data-testid=\"button-signout\">\n                    <LogOut className=\"mr-2 h-4 w-4\" />\n                    Sign out\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          </div>\n        </header>\n\n        {/* Page content */}\n        <main className=\"p-4 sm:p-6 lg:p-8\">\n          {children}\n        </main>\n      </div>\n    </div>\n  );\n}","size_bytes":6265},"client/src/components/todos/kanban-view.tsx":{"content":"import { DragDropContext, Droppable, Draggable, DropResult } from \"@hello-pangea/dnd\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Calendar, User, AlertTriangle } from \"lucide-react\";\nimport type { Todo } from \"@/lib/types\";\n\ninterface KanbanViewProps {\n  todos: Todo[];\n  onUpdateStatus: (todoId: string, newStatus: \"todo\" | \"in_progress\" | \"done\") => void;\n  isLoading: boolean;\n  onTaskClick: (todo: Todo) => void;\n}\n\nexport function KanbanView({ todos, onUpdateStatus, isLoading, onTaskClick }: KanbanViewProps) {\n  const columns = [\n    {\n      id: \"todo\" as const,\n      title: \"To Do\",\n      color: \"bg-chart-4\",\n      todos: todos.filter((t) => t.status === \"todo\"),\n    },\n    {\n      id: \"in_progress\" as const,\n      title: \"In Progress\",\n      color: \"bg-primary\",\n      todos: todos.filter((t) => t.status === \"in_progress\"),\n    },\n    {\n      id: \"done\" as const,\n      title: \"Done\",\n      color: \"bg-chart-2\",\n      todos: todos.filter((t) => t.status === \"done\"),\n    },\n  ];\n\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"text-destructive\";\n      case \"high\":\n        return \"text-destructive\";\n      case \"medium\":\n        return \"text-chart-4\";\n      case \"low\":\n        return \"text-chart-2\";\n      default:\n        return \"text-muted-foreground\";\n    }\n  };\n\n  const getPriorityVariant = (priority: string) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"destructive\" as const;\n      case \"high\":\n        return \"destructive\" as const;\n      case \"medium\":\n        return \"secondary\" as const;\n      case \"low\":\n        return \"outline\" as const;\n      default:\n        return \"secondary\" as const;\n    }\n  };\n\n  const formatDueDate = (dueDate: string | Date | null) => {\n    if (!dueDate) return null;\n    const date = typeof dueDate === 'string' ? new Date(dueDate) : dueDate;\n    const now = new Date();\n    const diffInDays = Math.ceil((date.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n    \n    if (diffInDays < 0) return \"Overdue\";\n    if (diffInDays === 0) return \"Due today\";\n    if (diffInDays === 1) return \"Due tomorrow\";\n    return `Due in ${diffInDays} days`;\n  };\n\n  const isOverdue = (dueDate: string | Date | null) => {\n    if (!dueDate) return false;\n    const date = typeof dueDate === 'string' ? new Date(dueDate) : dueDate;\n    return date < new Date();\n  };\n\n  const handleDragEnd = (result: DropResult) => {\n    const { destination, source, draggableId } = result;\n\n    if (!destination) return;\n    if (destination.droppableId === source.droppableId && destination.index === source.index) return;\n\n    const newStatus = destination.droppableId as \"todo\" | \"in_progress\" | \"done\";\n    onUpdateStatus(draggableId, newStatus);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\" data-testid=\"kanban-loading\">\n        {[...Array(3)].map((_, i) => (\n          <Card key={i} className=\"h-96\">\n            <CardHeader>\n              <div className=\"h-4 bg-muted rounded animate-pulse\"></div>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {[...Array(3)].map((_, j) => (\n                <div key={j} className=\"h-24 bg-muted rounded animate-pulse\"></div>\n              ))}\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    );\n  }\n\n  return (\n    <DragDropContext onDragEnd={handleDragEnd}>\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\" data-testid=\"kanban-view\">\n        {columns.map((column) => (\n          <Card\n            key={column.id}\n            className=\"flex flex-col h-[calc(100vh-300px)]\"\n            data-testid={`kanban-column-${column.id}`}\n          >\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center space-x-2\">\n                  <div className={`w-3 h-3 rounded-full ${column.color}`}></div>\n                  <CardTitle className=\"text-sm font-medium\">{column.title}</CardTitle>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {column.todos.length}\n                  </Badge>\n                </div>\n              </div>\n            </CardHeader>\n\n            <Droppable droppableId={column.id}>\n              {(provided, snapshot) => (\n                <CardContent\n                  ref={provided.innerRef}\n                  {...provided.droppableProps}\n                  className={`flex-1 overflow-y-auto space-y-3 pb-3 ${\n                    snapshot.isDraggingOver ? \"bg-muted/50\" : \"\"\n                  }`}\n                >\n                  {column.todos.length === 0 ? (\n                    <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                      No tasks\n                    </div>\n                  ) : (\n                    column.todos.map((todo, index) => (\n                      <Draggable key={todo.id} draggableId={todo.id} index={index}>\n                        {(provided, snapshot) => (\n                          <Card\n                            ref={provided.innerRef}\n                            {...provided.draggableProps}\n                            {...provided.dragHandleProps}\n                            className={`cursor-pointer hover:shadow-md transition-all ${\n                              snapshot.isDragging ? \"shadow-lg\" : \"\"\n                            } ${\n                              isOverdue(todo.dueDate) && todo.status !== \"done\"\n                                ? \"border-destructive\"\n                                : \"\"\n                            }`}\n                            onClick={() => onTaskClick(todo)}\n                            data-testid={`kanban-todo-card-${todo.id}`}\n                          >\n                            <CardContent className=\"p-3\">\n                              <div className=\"space-y-2\">\n                                <div className=\"flex items-start justify-between\">\n                                  <h4\n                                    className={`text-sm font-medium flex-1 ${\n                                      todo.status === \"done\" ? \"line-through opacity-60\" : \"\"\n                                    }`}\n                                    data-testid={`kanban-todo-title-${todo.id}`}\n                                  >\n                                    {todo.title}\n                                  </h4>\n                                </div>\n\n                                {todo.description && (\n                                  <p\n                                    className=\"text-xs text-muted-foreground line-clamp-2\"\n                                    data-testid={`kanban-todo-description-${todo.id}`}\n                                  >\n                                    {todo.description}\n                                  </p>\n                                )}\n\n                                <div className=\"flex items-center justify-between\">\n                                  <Badge\n                                    variant={getPriorityVariant(todo.priority || \"medium\")}\n                                    className={getPriorityColor(todo.priority || \"medium\")}\n                                    data-testid={`kanban-todo-priority-${todo.id}`}\n                                  >\n                                    {(todo.priority || \"medium\").charAt(0).toUpperCase() +\n                                      (todo.priority || \"medium\").slice(1)}\n                                  </Badge>\n                                </div>\n\n                                {todo.dueDate && (\n                                  <div\n                                    className={`flex items-center space-x-1 text-xs ${\n                                      isOverdue(todo.dueDate) && todo.status !== \"done\"\n                                        ? \"text-destructive\"\n                                        : \"text-muted-foreground\"\n                                    }`}\n                                    data-testid={`kanban-todo-due-date-${todo.id}`}\n                                  >\n                                    <Calendar className=\"h-3 w-3\" />\n                                    <span>{formatDueDate(todo.dueDate)}</span>\n                                    {isOverdue(todo.dueDate) && todo.status !== \"done\" && (\n                                      <AlertTriangle className=\"h-3 w-3 ml-1\" />\n                                    )}\n                                  </div>\n                                )}\n\n                                {todo.assignedUserId && (\n                                  <div\n                                    className=\"flex items-center space-x-1\"\n                                    data-testid={`kanban-todo-assigned-${todo.id}`}\n                                  >\n                                    <Avatar className=\"h-4 w-4\">\n                                      <AvatarFallback className=\"text-xs\">\n                                        {todo.assignedUserId.substring(0, 2).toUpperCase()}\n                                      </AvatarFallback>\n                                    </Avatar>\n                                    <User className=\"h-3 w-3 text-muted-foreground\" />\n                                    <span className=\"text-xs text-muted-foreground\">Assigned</span>\n                                  </div>\n                                )}\n                              </div>\n                            </CardContent>\n                          </Card>\n                        )}\n                      </Draggable>\n                    ))\n                  )}\n                  {provided.placeholder}\n                </CardContent>\n              )}\n            </Droppable>\n          </Card>\n        ))}\n      </div>\n    </DragDropContext>\n  );\n}\n","size_bytes":10071},"client/src/components/email/email-compose.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { RichTextEditor } from \"@/components/ui/rich-text-editor\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { \n  Send, \n  Save\n} from \"lucide-react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface EmailComposeProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  to?: string;\n  subject?: string;\n}\n\nexport function EmailCompose({ open, onOpenChange, to = \"\", subject = \"\" }: EmailComposeProps) {\n  const [toEmail, setToEmail] = useState(to);\n  const [emailSubject, setEmailSubject] = useState(subject);\n  const [emailBody, setEmailBody] = useState(\"\");\n  const { toast } = useToast();\n\n  const sendEmailMutation = useMutation({\n    mutationFn: async (data: { to: string; subject: string; body: string }) => {\n      const response = await fetch(\"/api/emails/send\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!response.ok) throw new Error(\"Failed to send email\");\n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Email sent\",\n        description: \"Your email has been sent successfully\",\n      });\n      handleClose();\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to send email\",\n        description: \"There was an error sending your email\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSend = () => {\n    const bodyText = emailBody.replace(/<[^>]*>/g, '').trim();\n    \n    if (!toEmail.trim() || !emailSubject.trim() || !bodyText) {\n      toast({\n        title: \"Missing fields\",\n        description: \"Please fill in all required fields\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    sendEmailMutation.mutate({\n      to: toEmail,\n      subject: emailSubject,\n      body: emailBody,\n    });\n  };\n\n  const handleClose = () => {\n    setToEmail(\"\");\n    setEmailSubject(\"\");\n    setEmailBody(\"\");\n    onOpenChange(false);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[600px]\" data-testid=\"email-compose-dialog\">\n        <DialogHeader>\n          <DialogTitle>Compose Email</DialogTitle>\n          <DialogDescription>\n            Send a new email to a customer\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"to\">To *</Label>\n            <Input\n              id=\"to\"\n              type=\"email\"\n              placeholder=\"customer@example.com\"\n              value={toEmail}\n              onChange={(e) => setToEmail(e.target.value)}\n              data-testid=\"compose-to-input\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"subject\">Subject *</Label>\n            <Input\n              id=\"subject\"\n              placeholder=\"Email subject\"\n              value={emailSubject}\n              onChange={(e) => setEmailSubject(e.target.value)}\n              data-testid=\"compose-subject-input\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"body\">Message *</Label>\n            <RichTextEditor\n              content={emailBody}\n              onChange={setEmailBody}\n              placeholder=\"Type your message...\"\n              className=\"min-h-[200px]\"\n            />\n          </div>\n        </div>\n\n        <DialogFooter className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-2\">\n            <Button variant=\"outline\" size=\"sm\" data-testid=\"save-draft-button\">\n              <Save className=\"h-4 w-4 mr-1\" />\n              Save Draft\n            </Button>\n          </div>\n          \n          <div className=\"flex items-center space-x-2\">\n            <Button\n              variant=\"outline\"\n              onClick={handleClose}\n              data-testid=\"compose-cancel-button\"\n            >\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSend}\n              disabled={sendEmailMutation.isPending}\n              data-testid=\"compose-send-button\"\n            >\n              <Send className=\"h-4 w-4 mr-1\" />\n              {sendEmailMutation.isPending ? \"Sending...\" : \"Send Email\"}\n            </Button>\n          </div>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":4716},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/40 dark:bg-black/60 backdrop-blur-sm data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border p-6 duration-300 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-xl\",\n        \"bg-white border-border shadow-[0_8px_32px_rgba(0,0,0,0.08)]\",\n        \"dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-modal\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-md opacity-70 ring-offset-background transition-all hover:opacity-100 hover:bg-accent/50 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent/50 p-1\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 gap-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground leading-relaxed\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":4033},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23567},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/repairs/repair-detail-modal.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport type { Repair, User, Activity } from \"@shared/schema\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Wrench,\n  Package,\n  Image as ImageIcon,\n  Activity as ActivityIcon,\n  User as UserIcon,\n  Calendar,\n  Clock,\n  DollarSign,\n  Upload,\n  Download,\n  Trash2,\n  FileText,\n  AlertTriangle,\n  Edit,\n  Save,\n  X,\n  Maximize2,\n} from \"lucide-react\";\nimport { format, isPast } from \"date-fns\";\nimport { nl } from \"date-fns/locale\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { RepairStatusTimeline } from \"./repair-status-timeline\";\n\ninterface RepairDetailModalProps {\n  repair: Repair | null;\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  users: User[];\n}\n\nexport function RepairDetailModal({ repair, open, onOpenChange, users }: RepairDetailModalProps) {\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [selectedFiles, setSelectedFiles] = useState<FileList | null>(null);\n  const [note, setNote] = useState(\"\");\n  const [currentRepair, setCurrentRepair] = useState<Repair | null>(repair);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [isEditMode, setIsEditMode] = useState(false);\n  const [editForm, setEditForm] = useState<any>({});\n  const [editingNoteId, setEditingNoteId] = useState<string | null>(null);\n  const [editingNoteText, setEditingNoteText] = useState(\"\");\n  const [fullScreenImage, setFullScreenImage] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  // Update local state when repair prop changes\n  useEffect(() => {\n    setCurrentRepair(repair);\n    if (repair) {\n      setEditForm({\n        title: repair.title || \"\",\n        description: repair.description || \"\",\n        productSku: repair.productSku || \"\",\n        productName: repair.productName || \"\",\n        issueCategory: repair.issueCategory || \"\",\n        estimatedCost: repair.estimatedCost ? repair.estimatedCost / 100 : 0,\n        assignedUserId: repair.assignedUserId || \"none\",\n        priority: repair.priority || \"medium\",\n      });\n    }\n  }, [repair]);\n\n  const { data: allActivities = [] } = useQuery<Activity[]>({\n    queryKey: ['/api/activities'],\n    enabled: !!repair?.id,\n  });\n  \n  // Filter activities for this specific repair\n  const activities = allActivities.filter(activity => {\n    const metadata = activity.metadata as any;\n    return metadata?.entityType === 'repair' && metadata?.entityId === repair?.id;\n  });\n  \n  // Filter notes from activities\n  const notes = activities.filter(activity => activity.type === 'note_added');\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async (data: { status: string }) => {\n      if (!repair || !currentRepair) return;\n      const res = await apiRequest('PATCH', `/api/repairs/${currentRepair.id}`, data);\n      return await res.json();\n    },\n    onSuccess: (updatedRepair) => {\n      if (updatedRepair) {\n        setCurrentRepair(updatedRepair);\n      }\n      queryClient.invalidateQueries({ queryKey: ['/api/repairs'] });\n      toast({\n        title: \"Status bijgewerkt\",\n        description: \"De reparatiestatus is succesvol bijgewerkt.\",\n      });\n    },\n  });\n\n  const uploadFilesMutation = useMutation({\n    mutationFn: async (files: FileList) => {\n      if (!repair || !currentRepair) return;\n      const formData = new FormData();\n      Array.from(files).forEach((file) => {\n        formData.append('files', file);\n      });\n      // Use fetch directly for FormData\n      const res = await fetch(`/api/repairs/${currentRepair.id}/upload`, {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      });\n      if (!res.ok) throw new Error('Failed to upload files');\n      return await res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/repairs'] });\n      setSelectedFiles(null);\n      toast({\n        title: \"Bestanden ge√ºpload\",\n        description: \"De bestanden zijn succesvol toegevoegd.\",\n      });\n    },\n  });\n\n  const addNoteMutation = useMutation({\n    mutationFn: async (noteText: string) => {\n      if (!repair || !currentRepair) return;\n      const res = await apiRequest('POST', '/api/activities', {\n        type: 'note_added',\n        description: noteText,\n        metadata: { entityType: 'repair', entityId: currentRepair.id },\n      });\n      return await res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/activities'] });\n      setNote(\"\");\n      toast({\n        title: \"Notitie toegevoegd\",\n        description: \"De notitie is succesvol toegevoegd.\",\n      });\n    },\n  });\n\n  const updateNoteMutation = useMutation({\n    mutationFn: async ({ noteId, description }: { noteId: string; description: string }) => {\n      const res = await apiRequest('PATCH', `/api/activities/${noteId}`, { description });\n      return await res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/activities'] });\n      setEditingNoteId(null);\n      setEditingNoteText(\"\");\n      toast({\n        title: \"Notitie bijgewerkt\",\n        description: \"De notitie is succesvol bijgewerkt.\",\n      });\n    },\n  });\n\n  const deleteNoteMutation = useMutation({\n    mutationFn: async (noteId: string) => {\n      await apiRequest('DELETE', `/api/activities/${noteId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/activities'] });\n      toast({\n        title: \"Notitie verwijderd\",\n        description: \"De notitie is succesvol verwijderd.\",\n      });\n    },\n  });\n\n  const deleteRepairMutation = useMutation({\n    mutationFn: async () => {\n      if (!currentRepair) return;\n      await apiRequest('DELETE', `/api/repairs/${currentRepair.id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/repairs'] });\n      toast({\n        title: \"Reparatie verwijderd\",\n        description: \"De reparatie is succesvol verwijderd.\",\n      });\n      onOpenChange(false);\n    },\n    onError: () => {\n      toast({\n        title: \"Fout\",\n        description: \"Kon de reparatie niet verwijderen.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateRepairMutation = useMutation({\n    mutationFn: async (data: any) => {\n      if (!currentRepair) return;\n      const res = await apiRequest('PATCH', `/api/repairs/${currentRepair.id}`, data);\n      return await res.json();\n    },\n    onSuccess: (updatedRepair) => {\n      if (updatedRepair) {\n        setCurrentRepair(updatedRepair);\n      }\n      queryClient.invalidateQueries({ queryKey: ['/api/repairs'] });\n      setIsEditMode(false);\n      toast({\n        title: \"Reparatie bijgewerkt\",\n        description: \"De reparatiegegevens zijn succesvol bijgewerkt.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Fout\",\n        description: \"Kon de reparatie niet bijwerken.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteFileMutation = useMutation({\n    mutationFn: async ({ fileType, fileUrl }: { fileType: 'photos' | 'attachments'; fileUrl: string }) => {\n      if (!repair || !currentRepair) return;\n      \n      // Get current files array\n      const currentFiles = fileType === 'photos' ? (currentRepair.photos || []) : (currentRepair.attachments || []);\n      \n      // Filter out the file to delete\n      const updatedFiles = currentFiles.filter(f => f !== fileUrl);\n      \n      // Update repair\n      const res = await apiRequest('PATCH', `/api/repairs/${currentRepair.id}`, {\n        [fileType]: updatedFiles\n      });\n      return await res.json();\n    },\n    onSuccess: (updatedRepair) => {\n      if (updatedRepair) {\n        setCurrentRepair(updatedRepair);\n      }\n      queryClient.invalidateQueries({ queryKey: ['/api/repairs'] });\n      toast({\n        title: \"Bestand verwijderd\",\n        description: \"Het bestand is succesvol verwijderd.\",\n      });\n    },\n  });\n\n  const handleSaveEdit = () => {\n    const updateData = {\n      ...editForm,\n      estimatedCost: editForm.estimatedCost ? Math.round(editForm.estimatedCost * 100) : undefined,\n      assignedUserId: editForm.assignedUserId === \"none\" ? null : editForm.assignedUserId,\n    };\n    updateRepairMutation.mutate(updateData);\n  };\n\n  const handleCancelEdit = () => {\n    setIsEditMode(false);\n    if (repair) {\n      setEditForm({\n        title: repair.title || \"\",\n        description: repair.description || \"\",\n        productSku: repair.productSku || \"\",\n        productName: repair.productName || \"\",\n        issueCategory: repair.issueCategory || \"\",\n        estimatedCost: repair.estimatedCost ? repair.estimatedCost / 100 : 0,\n        assignedUserId: repair.assignedUserId || \"none\",\n        priority: repair.priority || \"medium\",\n      });\n    }\n  };\n\n  if (!currentRepair) return null;\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'new': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';\n      case 'diagnosing': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';\n      case 'waiting_parts': return 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';\n      case 'repair_in_progress': return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';\n      case 'quality_check': return 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200';\n      case 'completed': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';\n      case 'returned': return 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-200';\n      case 'canceled': return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';\n      default: return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getStatusLabel = (status: string) => {\n    switch (status) {\n      case 'new': return 'Nieuw';\n      case 'diagnosing': return 'Diagnose';\n      case 'waiting_parts': return 'Wacht op onderdelen';\n      case 'repair_in_progress': return 'In reparatie';\n      case 'quality_check': return 'Kwaliteitscontrole';\n      case 'completed': return 'Voltooid';\n      case 'returned': return 'Geretourneerd';\n      case 'canceled': return 'Geannuleerd';\n      default: return status;\n    }\n  };\n\n  const getTechnicianName = (userId: string | null) => {\n    if (!userId) return 'Niet toegewezen';\n    const user = users.find(u => u.id === userId);\n    return user ? `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username : 'Onbekend';\n  };\n\n  const handleFileUpload = () => {\n    if (selectedFiles) {\n      if (selectedFiles.length > 10) {\n        toast({\n          title: \"Te veel bestanden\",\n          description: \"Je kunt maximaal 10 bestanden tegelijk uploaden.\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      uploadFilesMutation.mutate(selectedFiles);\n    }\n  };\n\n  const handleDeleteFile = (fileType: 'photos' | 'attachments', fileUrl: string) => {\n    if (confirm('Weet je zeker dat je dit bestand wilt verwijderen?')) {\n      deleteFileMutation.mutate({ fileType, fileUrl });\n    }\n  };\n\n  const handleAddNote = () => {\n    if (note.trim()) {\n      addNoteMutation.mutate(note);\n    }\n  };\n\n  const partsUsed = Array.isArray(currentRepair.partsUsed) ? currentRepair.partsUsed : [];\n  // Filter out broken/old files (those with 'undefined' in path or ending with '-')\n  const attachments = Array.isArray(currentRepair.attachments) \n    ? currentRepair.attachments.filter(a => !a.includes('undefined') && !a.endsWith('-'))\n    : [];\n  const photos = Array.isArray(currentRepair.photos) \n    ? currentRepair.photos.filter(p => !p.includes('undefined') && !p.endsWith('-'))\n    : [];\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"w-full max-w-full sm:max-w-2xl md:max-w-3xl lg:max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <div className=\"space-y-3\">\n            {/* Title and Subtitle */}\n            <div>\n              <DialogTitle>Reparatie #{currentRepair.id.slice(0, 8)}</DialogTitle>\n              <p className=\"text-sm text-foreground mt-1\">{currentRepair.title}</p>\n            </div>\n            \n            {/* Status Badge and Warning */}\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <Badge variant=\"secondary\" className={getStatusColor(currentRepair.status)}>\n                {getStatusLabel(currentRepair.status)}\n              </Badge>\n              {currentRepair.slaDeadline && \n               !['completed', 'returned', 'canceled'].includes(currentRepair.status) && \n               isPast(new Date(currentRepair.slaDeadline)) && (\n                <div className=\"flex items-center gap-1 text-destructive\" data-testid=\"indicator-overdue\">\n                  <AlertTriangle className=\"h-4 w-4\" />\n                  <span className=\"text-xs font-medium\">Te laat</span>\n                </div>\n              )}\n            </div>\n\n            {/* Action Buttons */}\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              {isEditMode ? (\n                <>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleCancelEdit}\n                    data-testid=\"button-cancel-edit\"\n                  >\n                    <X className=\"h-4 w-4 sm:mr-2\" />\n                    <span className=\"hidden sm:inline\">Annuleren</span>\n                  </Button>\n                  <Button\n                    variant=\"default\"\n                    size=\"sm\"\n                    onClick={handleSaveEdit}\n                    disabled={updateRepairMutation.isPending}\n                    data-testid=\"button-save-edit\"\n                  >\n                    <Save className=\"h-4 w-4 sm:mr-2\" />\n                    <span className=\"hidden sm:inline\">{updateRepairMutation.isPending ? \"Opslaan...\" : \"Opslaan\"}</span>\n                  </Button>\n                </>\n              ) : (\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setIsEditMode(true)}\n                  data-testid=\"button-edit-repair\"\n                >\n                  <Edit className=\"h-4 w-4 sm:mr-2\" />\n                  <span className=\"hidden sm:inline\">Bewerken</span>\n                </Button>\n              )}\n              <Button\n                variant=\"destructive\"\n                size=\"sm\"\n                onClick={() => setShowDeleteDialog(true)}\n                data-testid=\"delete-repair-button\"\n              >\n                <Trash2 className=\"h-4 w-4 sm:mr-2\" />\n                <span className=\"hidden sm:inline\">Verwijderen</span>\n              </Button>\n            </div>\n          </div>\n        </DialogHeader>\n\n        <Tabs value={activeTab} onValueChange={setActiveTab}>\n          <TabsList className=\"grid w-full grid-cols-2 sm:grid-cols-4 h-auto\">\n            <TabsTrigger value=\"overview\" data-testid=\"tab-overview\" className=\"text-xs sm:text-sm\">\n              Overzicht\n            </TabsTrigger>\n            <TabsTrigger value=\"parts\" data-testid=\"tab-parts\" className=\"text-xs sm:text-sm\">\n              <span className=\"hidden sm:inline\">Onderdelen ({partsUsed.length})</span>\n              <span className=\"sm:hidden\">Delen ({partsUsed.length})</span>\n            </TabsTrigger>\n            <TabsTrigger value=\"files\" data-testid=\"tab-files\" className=\"text-xs sm:text-sm\">\n              <span className=\"hidden sm:inline\">Bestanden ({photos.length + attachments.length})</span>\n              <span className=\"sm:hidden\">Files ({photos.length + attachments.length})</span>\n            </TabsTrigger>\n            <TabsTrigger value=\"activity\" data-testid=\"tab-activity\" className=\"text-xs sm:text-sm\">\n              <span className=\"hidden sm:inline\">Activiteit ({activities.length})</span>\n              <span className=\"sm:hidden\">Log ({activities.length})</span>\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"overview\" className=\"space-y-4 min-h-[400px]\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <Wrench className=\"h-4 w-4\" />\n                  Reparatie Details\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {isEditMode ? (\n                  <>\n                    <div className=\"space-y-2\">\n                      <div className=\"text-sm font-medium\">Titel</div>\n                      <Input\n                        value={editForm.title || \"\"}\n                        onChange={(e) => setEditForm({ ...editForm, title: e.target.value })}\n                        data-testid=\"input-edit-title\"\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <div className=\"text-sm font-medium\">Product Naam</div>\n                        <Input\n                          value={editForm.productName || \"\"}\n                          onChange={(e) => setEditForm({ ...editForm, productName: e.target.value })}\n                          data-testid=\"input-edit-product-name\"\n                        />\n                      </div>\n                      <div className=\"space-y-2\">\n                        <div className=\"text-sm font-medium\">Product SKU</div>\n                        <Input\n                          value={editForm.productSku || \"\"}\n                          onChange={(e) => setEditForm({ ...editForm, productSku: e.target.value })}\n                          data-testid=\"input-edit-product-sku\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"text-sm font-medium\">Probleem Categorie</div>\n                      <Input\n                        value={editForm.issueCategory || \"\"}\n                        onChange={(e) => setEditForm({ ...editForm, issueCategory: e.target.value })}\n                        data-testid=\"input-edit-issue-category\"\n                      />\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <div className=\"text-sm font-medium\">Technicus</div>\n                        <Select\n                          value={editForm.assignedUserId || \"none\"}\n                          onValueChange={(value) => setEditForm({ ...editForm, assignedUserId: value })}\n                        >\n                          <SelectTrigger data-testid=\"select-edit-technician\">\n                            <SelectValue placeholder=\"Selecteer technicus\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"none\">Niet toegewezen</SelectItem>\n                            {users.filter(u => u.role === 'TECHNICUS' || u.role === 'ADMIN').map((tech) => (\n                              <SelectItem key={tech.id} value={tech.id}>\n                                {tech.firstName || ''} {tech.lastName || ''} ({tech.username})\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"space-y-2\">\n                        <div className=\"text-sm font-medium\">Prioriteit</div>\n                        <Select\n                          value={editForm.priority || \"medium\"}\n                          onValueChange={(value) => setEditForm({ ...editForm, priority: value })}\n                        >\n                          <SelectTrigger data-testid=\"select-edit-priority\">\n                            <SelectValue placeholder=\"Selecteer prioriteit\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"low\">Laag</SelectItem>\n                            <SelectItem value=\"medium\">Gemiddeld</SelectItem>\n                            <SelectItem value=\"high\">Hoog</SelectItem>\n                            <SelectItem value=\"urgent\">Urgent</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"text-sm font-medium\">Geschatte Kosten (‚Ç¨)</div>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={editForm.estimatedCost || 0}\n                        onChange={(e) => setEditForm({ ...editForm, estimatedCost: parseFloat(e.target.value) || 0 })}\n                        data-testid=\"input-edit-estimated-cost\"\n                      />\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"text-sm font-medium\">Beschrijving</div>\n                      <Textarea\n                        value={editForm.description || \"\"}\n                        onChange={(e) => setEditForm({ ...editForm, description: e.target.value })}\n                        rows={3}\n                        data-testid=\"input-edit-description\"\n                      />\n                    </div>\n                  </>\n                ) : (\n                  <>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <div className=\"text-sm font-medium\">Product</div>\n                        <div className=\"text-sm text-muted-foreground\">{currentRepair.productName || currentRepair.title}</div>\n                        {currentRepair.productSku && (\n                          <div className=\"text-xs text-muted-foreground\">SKU: {currentRepair.productSku}</div>\n                        )}\n                      </div>\n                      <div>\n                        <div className=\"text-sm font-medium\">Probleem Categorie</div>\n                        <div className=\"text-sm text-muted-foreground\">{currentRepair.issueCategory || '-'}</div>\n                      </div>\n                      <div>\n                        <div className=\"text-sm font-medium\">Technicus</div>\n                        <div className=\"text-sm text-muted-foreground\">{getTechnicianName(currentRepair.assignedUserId)}</div>\n                      </div>\n                      <div>\n                        <div className=\"text-sm font-medium\">Prioriteit</div>\n                        <div className=\"text-sm\">\n                          <Badge variant=\"outline\">\n                            {currentRepair.priority === 'urgent' ? 'Urgent' : \n                             currentRepair.priority === 'high' ? 'Hoog' : \n                             currentRepair.priority === 'medium' ? 'Gemiddeld' : 'Laag'}\n                          </Badge>\n                        </div>\n                      </div>\n                    </div>\n\n                    <div>\n                      <div className=\"text-sm font-medium\">Beschrijving</div>\n                      <div className=\"text-sm text-muted-foreground mt-1\">{currentRepair.description || '-'}</div>\n                    </div>\n                  </>\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <div className=\"text-sm font-medium flex items-center gap-1\">\n                      <Calendar className=\"h-3 w-3\" />\n                      Ontvangen op\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      {currentRepair.createdAt ? format(new Date(currentRepair.createdAt), \"d MMMM yyyy\", { locale: nl }) : '-'}\n                    </div>\n                  </div>\n                  <div>\n                    <div className=\"text-sm font-medium flex items-center gap-1\">\n                      <Clock className=\"h-3 w-3\" />\n                      Laatst bijgewerkt\n                    </div>\n                    <div className=\"text-sm text-muted-foreground\">\n                      {currentRepair.updatedAt ? format(new Date(currentRepair.updatedAt), \"d MMMM yyyy HH:mm\", { locale: nl }) : '-'}\n                    </div>\n                  </div>\n                </div>\n\n                <div>\n                  <div className=\"text-sm font-medium mb-3\">Status bijwerken</div>\n                  <div className=\"flex flex-wrap gap-1.5\">\n                    {[\n                      { value: 'new', label: 'Nieuw' },\n                      { value: 'diagnosing', label: 'Diagnose' },\n                      { value: 'waiting_parts', label: 'Wacht op onderdelen' },\n                      { value: 'repair_in_progress', label: 'In reparatie' },\n                      { value: 'quality_check', label: 'Kwaliteitscontrole' },\n                      { value: 'completed', label: 'Voltooid' },\n                      { value: 'returned', label: 'Geretourneerd' },\n                      { value: 'canceled', label: 'Geannuleerd' },\n                    ].map((status) => (\n                      <Button\n                        key={status.value}\n                        variant={currentRepair.status === status.value ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => updateStatusMutation.mutate({ status: status.value })}\n                        disabled={updateStatusMutation.isPending}\n                        className={`h-8 text-xs ${currentRepair.status === status.value ? \"\" : \"hover:bg-accent\"}`}\n                        data-testid={`button-status-${status.value}`}\n                      >\n                        {status.label}\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {(currentRepair.customerName || currentRepair.customerEmail || currentRepair.orderNumber) && (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <UserIcon className=\"h-4 w-4\" />\n                    Klant & Order Informatie\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    {(currentRepair.customerName || currentRepair.customerEmail) && (\n                      <div>\n                        <div className=\"text-sm font-medium\">Klant</div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          {currentRepair.customerName || currentRepair.customerEmail || 'Geen klant'}\n                        </div>\n                        {currentRepair.customerEmail && currentRepair.customerName && (\n                          <div className=\"text-xs text-muted-foreground\">{currentRepair.customerEmail}</div>\n                        )}\n                      </div>\n                    )}\n                    {currentRepair.orderNumber && (\n                      <div>\n                        <div className=\"text-sm font-medium\">Order Nummer</div>\n                        <div className=\"text-sm text-muted-foreground font-mono\">{currentRepair.orderNumber}</div>\n                      </div>\n                    )}\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <FileText className=\"h-4 w-4\" />\n                  Notities ({notes.length})\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {/* Existing notes list */}\n                {notes.length > 0 && (\n                  <div className=\"space-y-3 mb-4\">\n                    {notes.map((noteItem) => (\n                      <div key={noteItem.id} className=\"border rounded-lg p-3 bg-muted/50\">\n                        {editingNoteId === noteItem.id ? (\n                          <div className=\"space-y-2\">\n                            <Textarea\n                              value={editingNoteText}\n                              onChange={(e) => setEditingNoteText(e.target.value)}\n                              className=\"min-h-[80px]\"\n                              data-testid={`input-edit-note-${noteItem.id}`}\n                            />\n                            <div className=\"flex gap-2\">\n                              <Button\n                                size=\"sm\"\n                                onClick={() => {\n                                  if (editingNoteText.trim()) {\n                                    updateNoteMutation.mutate({ \n                                      noteId: noteItem.id, \n                                      description: editingNoteText \n                                    });\n                                  }\n                                }}\n                                disabled={!editingNoteText.trim() || updateNoteMutation.isPending}\n                                data-testid={`button-save-note-${noteItem.id}`}\n                              >\n                                <Save className=\"h-3 w-3 mr-1\" />\n                                Opslaan\n                              </Button>\n                              <Button\n                                size=\"sm\"\n                                variant=\"outline\"\n                                onClick={() => {\n                                  setEditingNoteId(null);\n                                  setEditingNoteText(\"\");\n                                }}\n                                data-testid={`button-cancel-note-${noteItem.id}`}\n                              >\n                                <X className=\"h-3 w-3 mr-1\" />\n                                Annuleren\n                              </Button>\n                            </div>\n                          </div>\n                        ) : (\n                          <>\n                            <div className=\"text-sm mb-2\">{noteItem.description}</div>\n                            <div className=\"flex items-center justify-between\">\n                              <div className=\"text-xs text-muted-foreground\">\n                                {noteItem.createdAt && format(new Date(noteItem.createdAt), \"d MMM yyyy HH:mm\", { locale: nl })}\n                              </div>\n                              <div className=\"flex gap-1\">\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  onClick={() => {\n                                    setEditingNoteId(noteItem.id);\n                                    setEditingNoteText(noteItem.description || \"\");\n                                  }}\n                                  data-testid={`button-edit-note-${noteItem.id}`}\n                                >\n                                  <Edit className=\"h-3 w-3\" />\n                                </Button>\n                                <Button\n                                  size=\"sm\"\n                                  variant=\"ghost\"\n                                  onClick={() => {\n                                    if (confirm(\"Weet je zeker dat je deze notitie wilt verwijderen?\")) {\n                                      deleteNoteMutation.mutate(noteItem.id);\n                                    }\n                                  }}\n                                  data-testid={`button-delete-note-${noteItem.id}`}\n                                >\n                                  <Trash2 className=\"h-3 w-3 text-destructive\" />\n                                </Button>\n                              </div>\n                            </div>\n                          </>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                )}\n\n                {/* Add new note form */}\n                <div className=\"space-y-2 pt-3 border-t\">\n                  <div className=\"text-sm font-medium\">Nieuwe notitie</div>\n                  <Textarea\n                    placeholder=\"Voeg een notitie toe over deze reparatie...\"\n                    value={note}\n                    onChange={(e) => setNote(e.target.value)}\n                    className=\"min-h-[100px]\"\n                    data-testid=\"input-note-overview\"\n                  />\n                  <Button\n                    onClick={handleAddNote}\n                    disabled={!note.trim() || addNoteMutation.isPending}\n                    data-testid=\"button-add-note-overview\"\n                  >\n                    {addNoteMutation.isPending ? 'Opslaan...' : 'Notitie toevoegen'}\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <ActivityIcon className=\"h-4 w-4\" />\n                  Reparatie Voortgang\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <RepairStatusTimeline currentStatus={currentRepair.status} />\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"parts\" className=\"space-y-4 min-h-[400px]\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <Package className=\"h-4 w-4\" />\n                  Gebruikte Onderdelen\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {partsUsed.length > 0 ? (\n                  <div className=\"space-y-2\">\n                    {partsUsed.map((part: any, index: number) => (\n                      <div key={index} className=\"flex justify-between items-center border-b pb-2\">\n                        <div>\n                          <div className=\"text-sm font-medium\">{part.name || part.partName || 'Onbekend onderdeel'}</div>\n                          {part.sku && <div className=\"text-xs text-muted-foreground\">SKU: {part.sku}</div>}\n                          {part.quantity && <div className=\"text-xs text-muted-foreground\">Aantal: {part.quantity}</div>}\n                        </div>\n                        {part.cost && (\n                          <div className=\"text-sm font-medium\">\n                            ‚Ç¨{(part.cost / 100).toFixed(2)}\n                          </div>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <Package className=\"h-12 w-12 mx-auto text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">Nog geen onderdelen toegevoegd</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {currentRepair.estimatedCost && (\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"text-base flex items-center gap-2\">\n                    <DollarSign className=\"h-4 w-4\" />\n                    Kosten\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex justify-between items-center\">\n                    <div className=\"text-sm font-medium\">Geschatte kosten</div>\n                    <div className=\"text-lg font-bold\">‚Ç¨{(currentRepair.estimatedCost / 100).toFixed(2)}</div>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </TabsContent>\n\n          <TabsContent value=\"files\" className=\"space-y-4 min-h-[400px]\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <ImageIcon className=\"h-4 w-4\" />\n                  Foto's\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {photos.length > 0 ? (\n                  <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-3\">\n                    {photos.map((photo, index) => {\n                      // Extract the path after /attachments/ to construct the API URL\n                      const photoPath = photo.startsWith('/attachments/') \n                        ? photo.substring('/attachments/'.length)\n                        : photo;\n                      const photoUrl = `/api/attachments/${photoPath}`;\n                      \n                      return (\n                        <div key={index} className=\"relative aspect-square rounded-lg overflow-hidden border group\">\n                          <img\n                            src={photoUrl}\n                            alt={`Foto ${index + 1}`}\n                            className=\"w-full h-full object-cover cursor-pointer\"\n                            onClick={() => setFullScreenImage(photoUrl)}\n                          />\n                          <div className=\"absolute top-1 right-1 sm:top-2 sm:right-2 flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity\">\n                            <Button\n                              variant=\"secondary\"\n                              size=\"sm\"\n                              className=\"h-7 w-7 sm:h-8 sm:w-8 p-0\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                setFullScreenImage(photoUrl);\n                              }}\n                              data-testid={`button-view-photo-${index}`}\n                            >\n                              <Maximize2 className=\"h-3 w-3 sm:h-4 sm:w-4\" />\n                            </Button>\n                            <Button\n                              variant=\"destructive\"\n                              size=\"sm\"\n                              className=\"h-7 w-7 sm:h-8 sm:w-8 p-0\"\n                              onClick={(e) => {\n                                e.stopPropagation();\n                                handleDeleteFile('photos', photo);\n                              }}\n                              data-testid={`button-delete-photo-${index}`}\n                            >\n                              <Trash2 className=\"h-3 w-3 sm:h-4 sm:w-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <ImageIcon className=\"h-12 w-12 mx-auto text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">Nog geen foto's toegevoegd</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <FileText className=\"h-4 w-4\" />\n                  Bijlagen\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"overflow-hidden\">\n                {attachments.length > 0 ? (\n                  <div className=\"space-y-2 w-full overflow-hidden\">\n                    {attachments.map((attachment, index) => {\n                      // Extract the path after /attachments/ to construct the API URL\n                      const attachmentPath = attachment.startsWith('/attachments/') \n                        ? attachment.substring('/attachments/'.length)\n                        : attachment;\n                      const downloadUrl = `/api/attachments/${attachmentPath}?download=1`;\n                      const filename = decodeURIComponent(attachment.split('/').pop() || 'download');\n                      \n                      // Create a shorter display name for mobile\n                      const getDisplayName = (name: string) => {\n                        if (name.length <= 30) return name;\n                        const parts = name.split('.');\n                        if (parts.length > 1) {\n                          const ext = parts.pop();\n                          const basename = parts.join('.');\n                          return basename.length > 20 \n                            ? `${basename.substring(0, 20)}...${ext}` \n                            : `${basename}.${ext}`;\n                        }\n                        return `${name.substring(0, 25)}...`;\n                      };\n                      \n                      return (\n                        <div key={index} className=\"flex flex-col sm:flex-row sm:items-center gap-2 border p-3 rounded w-full\">\n                          <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                            <FileText className=\"h-4 w-4 flex-shrink-0 text-muted-foreground\" />\n                            <span \n                              className=\"text-sm break-all sm:truncate block\" \n                              title={filename}\n                            >\n                              <span className=\"hidden sm:inline\">{filename}</span>\n                              <span className=\"sm:hidden\">{getDisplayName(filename)}</span>\n                            </span>\n                          </div>\n                          <div className=\"flex items-center gap-1 flex-shrink-0 self-end sm:self-center\">\n                            <a \n                              href={downloadUrl} \n                              download={filename}\n                              target=\"_blank\"\n                              rel=\"noopener noreferrer\"\n                            >\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                data-testid={`button-download-${index}`}\n                                className=\"h-8 px-2\"\n                              >\n                                <Download className=\"h-4 w-4\" />\n                                <span className=\"ml-1 text-xs hidden sm:inline\">Download</span>\n                              </Button>\n                            </a>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => handleDeleteFile('attachments', attachment)}\n                              data-testid={`button-delete-attachment-${index}`}\n                              className=\"h-8 px-2\"\n                            >\n                              <Trash2 className=\"h-4 w-4 text-destructive\" />\n                              <span className=\"ml-1 text-xs hidden sm:inline\">Delete</span>\n                            </Button>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <FileText className=\"h-12 w-12 mx-auto text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">Nog geen bijlagen toegevoegd</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">Nieuwe bestanden uploaden</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-3\">\n                <Input\n                  type=\"file\"\n                  multiple\n                  onChange={(e) => setSelectedFiles(e.target.files)}\n                  data-testid=\"input-file-upload\"\n                  className=\"cursor-pointer\"\n                />\n                <Button\n                  onClick={handleFileUpload}\n                  disabled={!selectedFiles || uploadFilesMutation.isPending}\n                  data-testid=\"button-upload-files\"\n                  className=\"w-full sm:w-auto\"\n                >\n                  <Upload className=\"h-4 w-4 mr-2\" />\n                  {uploadFilesMutation.isPending ? 'Uploaden...' : 'Upload bestanden'}\n                </Button>\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"activity\" className=\"space-y-4 min-h-[400px]\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base flex items-center gap-2\">\n                  <ActivityIcon className=\"h-4 w-4\" />\n                  Activiteitenlog\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                {activities.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {activities.map((activity) => (\n                      <div key={activity.id} className=\"border-l-2 border-muted pl-4 pb-2\">\n                        <div className=\"text-sm font-medium\">{activity.type}</div>\n                        <div className=\"text-sm text-muted-foreground\">{activity.description}</div>\n                        <div className=\"text-xs text-muted-foreground mt-1\">\n                          {activity.createdAt && format(new Date(activity.createdAt), \"d MMM yyyy HH:mm\", { locale: nl })}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <ActivityIcon className=\"h-12 w-12 mx-auto text-muted-foreground mb-2\" />\n                    <p className=\"text-sm text-muted-foreground\">Nog geen activiteiten</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">Notitie toevoegen</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-2\">\n                <Textarea\n                  placeholder=\"Voeg een notitie toe...\"\n                  value={note}\n                  onChange={(e) => setNote(e.target.value)}\n                  data-testid=\"input-note\"\n                />\n                <Button\n                  onClick={handleAddNote}\n                  disabled={!note.trim() || addNoteMutation.isPending}\n                  data-testid=\"button-add-note\"\n                >\n                  {addNoteMutation.isPending ? 'Opslaan...' : 'Notitie toevoegen'}\n                </Button>\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      </DialogContent>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Reparatie verwijderen?</AlertDialogTitle>\n            <AlertDialogDescription>\n              Weet je zeker dat je deze reparatie wilt verwijderen? Deze actie kan niet ongedaan gemaakt worden.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"cancel-delete-repair\">Annuleren</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deleteRepairMutation.mutate()}\n              disabled={deleteRepairMutation.isPending}\n              data-testid=\"confirm-delete-repair\"\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              {deleteRepairMutation.isPending ? \"Verwijderen...\" : \"Verwijderen\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Full-screen image viewer */}\n      <Dialog open={!!fullScreenImage} onOpenChange={() => setFullScreenImage(null)}>\n        <DialogContent className=\"max-w-[95vw] max-h-[95vh] p-0\">\n          <div className=\"relative w-full h-full flex items-center justify-center bg-black\">\n            {fullScreenImage && (\n              <img\n                src={fullScreenImage}\n                alt=\"Full screen view\"\n                className=\"max-w-full max-h-[95vh] object-contain\"\n                onClick={() => setFullScreenImage(null)}\n              />\n            )}\n            <Button\n              variant=\"secondary\"\n              size=\"icon\"\n              className=\"absolute top-4 right-4\"\n              onClick={() => setFullScreenImage(null)}\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </Dialog>\n  );\n}\n","size_bytes":49887},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"server/services/openaiClient.ts":{"content":"import OpenAI from \"openai\";\n\nconst client = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n\nexport async function askGPT(prompt: string) {\n  const response = await client.chat.completions.create({\n    model: \"gpt-4o-mini\",\n    messages: [\n      { role: \"system\", content: \"Je bent een grappige Pok√©mon-assistent.\" },\n      { role: \"user\", content: prompt },\n    ],\n  });\n\n  return response.choices[0].message.content;\n}\n","size_bytes":430},"README.md":{"content":"# dutchthrifthub edit file\n","size_bytes":27},"client/src/components/cases/case-detail-modal.tsx":{"content":"import { useState } from \"react\";\nimport type { User } from \"@shared/schema\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  Collapsible,\n  CollapsibleContent,\n  CollapsibleTrigger,\n} from \"@/components/ui/collapsible\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Edit,\n  Save,\n  X,\n  Mail,\n  Package,\n  Wrench,\n  CheckSquare,\n  User as UserIcon,\n  Clock,\n  Link as LinkIcon,\n  MessageSquare,\n  Activity as ActivityIcon,\n  MoreVertical,\n  Trash2,\n  ChevronDown,\n  ChevronRight,\n  Plus,\n  ExternalLink,\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport type { Case, CaseWithDetails, EmailThread, Order, Repair, Todo } from \"@/lib/types\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { NotesPanel } from \"@/components/notes/NotesPanel\";\nimport { EmailCompose } from \"@/components/email/email-compose\";\n\nconst CASE_STATUS_OPTIONS = [\n  { value: \"new\", label: \"Nieuw\" },\n  { value: \"in_progress\", label: \"In Behandeling\" },\n  { value: \"waiting_customer\", label: \"Wachtend op Klant\" },\n  { value: \"resolved\", label: \"Opgelost\" },\n];\n\nconst PRIORITY_OPTIONS = [\n  { value: \"low\", label: \"Low\" },\n  { value: \"medium\", label: \"Medium\" },\n  { value: \"high\", label: \"High\" },\n  { value: \"urgent\", label: \"Urgent\" },\n];\n\ninterface CaseDetailModalProps {\n  caseId: string;\n  initialData?: CaseWithDetails;\n  open: boolean;\n  onClose: () => void;\n}\n\nexport function CaseDetailModal({ caseId, initialData, open, onClose }: CaseDetailModalProps) {\n  const { toast } = useToast();\n  const [isEditing, setIsEditing] = useState(false);\n  const [editTitle, setEditTitle] = useState(\"\");\n  const [editDescription, setEditDescription] = useState(\"\");\n  const [showEmailDialog, setShowEmailDialog] = useState(false);\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const [linkSearchTerm, setLinkSearchTerm] = useState(\"\");\n  const [linkType, setLinkType] = useState<\"email\" | \"order\" | \"repair\" | \"todo\" | \"\">(\"\");\n  const [showLinkedEmails, setShowLinkedEmails] = useState(true);\n  const [showLinkedOrders, setShowLinkedOrders] = useState(true);\n  const [showLinkedRepairs, setShowLinkedRepairs] = useState(true);\n  const [showLinkedTodos, setShowLinkedTodos] = useState(true);\n\n  const { data: caseData, isLoading } = useQuery<CaseWithDetails>({\n    queryKey: [\"/api/cases\", caseId],\n    enabled: !!caseId && open,\n    initialData: initialData,\n    staleTime: 0, // Always refetch in background\n  });\n\n  // All data now comes from the main case endpoint\n  const caseItems = caseData?.items || [];\n  const caseLinksData = caseData?.links || [];\n  const caseEvents = caseData?.events || [];\n\n  // Fetch the directly linked order (from case.orderId)\n  const { data: linkedOrder } = useQuery<any>({\n    queryKey: [\"/api/orders\", caseData?.orderId],\n    enabled: !!caseData?.orderId && open,\n  });\n\n  // Extract linked entity IDs by type\n  const linkedEmailIds = caseLinksData.filter((link: any) => link.linkType === \"email\").map((link: any) => link.linkedId);\n  const linkedOrderIds = caseLinksData.filter((link: any) => link.linkType === \"order\").map((link: any) => link.linkedId);\n  const linkedRepairIds = caseLinksData.filter((link: any) => link.linkType === \"repair\").map((link: any) => link.linkedId);\n  const linkedTodoIds = caseLinksData.filter((link: any) => link.linkType === \"todo\").map((link: any) => link.linkedId);\n\n  // Only fetch these lists when user is actively trying to link items\n  const { data: allEmailsData = [] } = useQuery<EmailThread[]>({\n    queryKey: [\"/api/email-threads\"],\n    enabled: !!caseId && open && linkType === \"email\",\n  });\n\n  const { data: allOrdersData } = useQuery<any>({\n    queryKey: [\"/api/orders\", { page: 1, limit: 100 }],\n    queryFn: async () => {\n      const response = await fetch(\"/api/orders?page=1&limit=100\");\n      if (!response.ok) throw new Error(\"Failed to fetch orders\");\n      return response.json();\n    },\n    enabled: !!caseId && open && linkType === \"order\",\n  });\n\n  const { data: allRepairsData } = useQuery<Repair[]>({\n    queryKey: [\"/api/repairs\"],\n    enabled: !!caseId && open && linkType === \"repair\",\n  });\n\n  const { data: allTodosData } = useQuery<Todo[]>({\n    queryKey: [\"/api/todos\"],\n    enabled: !!caseId && open && linkType === \"todo\",\n  });\n\n  const { data: users = [] } = useQuery<any[]>({\n    queryKey: [\"/api/users/list\"],\n    enabled: open,\n  });\n\n  const { data: currentUser } = useQuery<User>({\n    queryKey: [\"/api/auth/session\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/session\");\n      if (!response.ok) throw new Error(\"Not authenticated\");\n      const data = await response.json();\n      return data.user;\n    },\n  });\n\n  // Filter to get only linked items\n  const relatedEmails = allEmailsData.filter((email: EmailThread) => linkedEmailIds.includes(email.id));\n  const relatedOrders = (allOrdersData?.orders || []).filter((order: Order) => linkedOrderIds.includes(order.id));\n  const relatedRepairs = (allRepairsData || []).filter((repair: Repair) => linkedRepairIds.includes(repair.id));\n  const relatedTodos = (allTodosData || []).filter((todo: Todo) => linkedTodoIds.includes(todo.id));\n\n  const updateCaseMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Case> }) => {\n      const response = await apiRequest(\"PATCH\", `/api/cases/${id}`, data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      toast({\n        title: \"Case updated\",\n        description: \"Case has been updated successfully\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Update failed\",\n        description: \"Failed to update case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const linkItemMutation = useMutation({\n    mutationFn: async ({ type, id }: { type: string; id: string }) => {\n      const response = await apiRequest(\"POST\", `/api/cases/${caseId}/links`, {\n        linkType: type,\n        linkedId: id,\n      });\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"links\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId] });\n      setLinkSearchTerm(\"\");\n      setLinkType(\"\");\n      toast({\n        title: \"Item linked\",\n        description: \"Item has been linked to the case\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Link failed\",\n        description: \"Failed to link item\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const unlinkItemMutation = useMutation({\n    mutationFn: async (linkId: string) => {\n      const response = await apiRequest(\"DELETE\", `/api/cases/${caseId}/links/${linkId}`, undefined);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId, \"links\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\", caseId] });\n      toast({\n        title: \"Item unlinked\",\n        description: \"Item has been unlinked from the case\",\n      });\n    },\n  });\n\n  const deleteCaseMutation = useMutation({\n    mutationFn: async () => {\n      const response = await apiRequest(\"DELETE\", `/api/cases/${caseId}`, undefined);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/cases\"] });\n      toast({\n        title: \"Case deleted\",\n        description: \"Case has been deleted successfully\",\n      });\n      onClose();\n    },\n    onError: () => {\n      toast({\n        title: \"Delete failed\",\n        description: \"Failed to delete case\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleStartEdit = () => {\n    setEditTitle(caseData?.title || \"\");\n    setEditDescription(caseData?.description || \"\");\n    setIsEditing(true);\n  };\n\n  const handleSaveEdit = () => {\n    updateCaseMutation.mutate({\n      id: caseId,\n      data: { title: editTitle, description: editDescription },\n    });\n    setIsEditing(false);\n  };\n\n  const handleCancelEdit = () => {\n    setIsEditing(false);\n    setEditTitle(\"\");\n    setEditDescription(\"\");\n  };\n\n  const formatDateTime = (date: Date | string | null) => {\n    if (!date) return 'Not available';\n    const dateObj = typeof date === 'string' ? new Date(date) : date;\n    return dateObj.toLocaleString();\n  };\n\n  const getStatusVariant = (status: string) => {\n    switch (status) {\n      case \"new\": return \"default\";\n      case \"in_progress\": return \"secondary\";\n      case \"waiting_customer\": return \"outline\";\n      case \"resolved\": return \"success\";\n      default: return \"default\";\n    }\n  };\n\n  const getPriorityVariant = (priority: string | null) => {\n    switch (priority) {\n      case \"urgent\": return \"destructive\";\n      case \"high\": return \"destructive\";\n      case \"medium\": return \"default\";\n      case \"low\": return \"secondary\";\n      default: return \"default\";\n    }\n  };\n\n  // Filter available items for linking\n  const getFilteredSearchResults = () => {\n    if (!linkSearchTerm.trim()) return [];\n    \n    const search = linkSearchTerm.toLowerCase();\n    const linkedIds = caseLinksData.map((link: any) => link.linkedId);\n    \n    let results: any[] = [];\n    \n    if (linkType === \"email\") {\n      results = allEmailsData.filter((email: any) => \n        !linkedIds.includes(email.id) &&\n        (email.subject?.toLowerCase().includes(search) || email.customerEmail?.toLowerCase().includes(search))\n      ).slice(0, 5);\n    } else if (linkType === \"order\") {\n      results = (allOrdersData?.orders || []).filter((order: any) =>\n        !linkedIds.includes(order.id) &&\n        (order.orderNumber?.toString().includes(search) ||\n         order.customerEmail?.toLowerCase().includes(search) ||\n         order.customerName?.toLowerCase().includes(search))\n      ).slice(0, 5);\n    } else if (linkType === \"repair\") {\n      results = (allRepairsData || []).filter((repair: any) =>\n        !linkedIds.includes(repair.id) &&\n        (repair.title?.toLowerCase().includes(search) || repair.description?.toLowerCase().includes(search))\n      ).slice(0, 5);\n    } else if (linkType === \"todo\") {\n      results = (allTodosData || []).filter((todo: any) =>\n        !linkedIds.includes(todo.id) &&\n        (todo.title?.toLowerCase().includes(search) || todo.description?.toLowerCase().includes(search))\n      ).slice(0, 5);\n    }\n    \n    return results;\n  };\n\n  const searchResults = getFilteredSearchResults();\n\n  if (isLoading || !caseData) {\n    return (\n      <Dialog open={open} onOpenChange={onClose}>\n        <DialogContent className=\"max-w-7xl max-h-[90vh] overflow-hidden\">\n          <DialogHeader>\n            <DialogTitle>Loading Case...</DialogTitle>\n          </DialogHeader>\n          <div className=\"animate-pulse space-y-4\">\n            <div className=\"h-8 bg-muted rounded\"></div>\n            <div className=\"h-64 bg-muted rounded\"></div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    );\n  }\n\n  const statusLabel = CASE_STATUS_OPTIONS.find(s => s.value === caseData.status)?.label || caseData.status;\n\n  return (\n    <>\n      <Dialog open={open} onOpenChange={onClose}>\n        <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col p-0\">\n          {/* Sticky Header */}\n          <div className=\"border-b bg-background p-4 sticky top-0 z-10\">\n            <div className=\"flex items-start justify-between\">\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <DialogTitle className=\"text-lg font-medium\">Case #{caseData.caseNumber}</DialogTitle>\n                  <Badge variant={getStatusVariant(caseData.status)} data-testid=\"case-status-badge\" className=\"text-xs h-5\">\n                    {statusLabel}\n                  </Badge>\n                  <Badge variant={getPriorityVariant(caseData.priority)} data-testid=\"case-priority-badge\" className=\"text-xs h-5\">\n                    {caseData.priority}\n                  </Badge>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Created {formatDateTime(caseData.createdAt)} ‚Ä¢ Customer: {caseData.customerEmail}\n                </p>\n              </div>\n              <div className=\"flex items-center gap-1.5\">\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\"\n                  onClick={() => setShowEmailDialog(true)}\n                  data-testid=\"send-email-button\"\n                  className=\"h-8 text-xs\"\n                >\n                  <Mail className=\"mr-1.5 h-3.5 w-3.5\" />\n                  Email\n                </Button>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\"\n                  onClick={() => setShowDeleteDialog(true)}\n                  data-testid=\"delete-case-button\"\n                  className=\"text-destructive hover:text-destructive h-8 text-xs\"\n                >\n                  <Trash2 className=\"mr-1.5 h-3.5 w-3.5\" />\n                  Delete\n                </Button>\n              </div>\n            </div>\n          </div>\n\n          {/* Two-column scrollable content */}\n          <div className=\"flex-1 overflow-y-auto\">\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-2.5 p-3\">\n              {/* Left Column: Case Details & Linked Items */}\n              <div className=\"space-y-2.5\">\n                {/* Case Info Card */}\n                <div className=\"border rounded-lg p-3\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <h3 className=\"text-sm font-medium\">Case Details</h3>\n                    {!isEditing && (\n                      <Button variant=\"ghost\" size=\"sm\" onClick={handleStartEdit} data-testid=\"edit-case-button\" className=\"h-6 text-xs\">\n                        <Edit className=\"h-3.5 w-3.5 mr-1\" />\n                        Edit\n                      </Button>\n                    )}\n                  </div>\n                  <div className=\"space-y-2.5\">\n                    {isEditing ? (\n                      <>\n                        <div>\n                          <label className=\"text-sm font-medium\">Title</label>\n                          <Input\n                            value={editTitle}\n                            onChange={(e) => setEditTitle(e.target.value)}\n                            className=\"mt-1\"\n                            data-testid=\"edit-title-input\"\n                          />\n                        </div>\n                        <div>\n                          <label className=\"text-sm font-medium\">Description</label>\n                          <Textarea\n                            value={editDescription}\n                            onChange={(e) => setEditDescription(e.target.value)}\n                            rows={4}\n                            className=\"mt-1\"\n                            data-testid=\"edit-description-input\"\n                          />\n                        </div>\n                        <div className=\"flex gap-2\">\n                          <Button onClick={handleSaveEdit} size=\"sm\" data-testid=\"save-edit-button\">\n                            <Save className=\"h-4 w-4 mr-2\" />\n                            Save\n                          </Button>\n                          <Button onClick={handleCancelEdit} variant=\"outline\" size=\"sm\" data-testid=\"cancel-edit-button\">\n                            <X className=\"h-4 w-4 mr-2\" />\n                            Cancel\n                          </Button>\n                        </div>\n                      </>\n                    ) : (\n                      <>\n                        <div>\n                          <label className=\"text-xs text-muted-foreground\">Title</label>\n                          <p className=\"text-sm mt-0.5\" data-testid=\"case-title\">{caseData.title}</p>\n                        </div>\n                        {caseData.description && (\n                          <div>\n                            <label className=\"text-xs text-muted-foreground\">Description</label>\n                            <p className=\"text-sm mt-0.5 whitespace-pre-wrap\" data-testid=\"case-description\">{caseData.description}</p>\n                          </div>\n                        )}\n                        <div className=\"grid grid-cols-2 gap-2.5\">\n                          <div>\n                            <label className=\"text-xs text-muted-foreground block mb-0.5\">Status</label>\n                            <Select\n                              value={caseData.status}\n                              onValueChange={(value) => updateCaseMutation.mutate({ id: caseId, data: { status: value as any } })}\n                            >\n                              <SelectTrigger className=\"h-8 text-sm\" data-testid=\"status-select\">\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {CASE_STATUS_OPTIONS.map((option) => (\n                                  <SelectItem key={option.value} value={option.value}>\n                                    {option.label}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n                          <div>\n                            <label className=\"text-xs text-muted-foreground block mb-0.5\">Priority</label>\n                            <Select\n                              value={caseData.priority || \"medium\"}\n                              onValueChange={(value) => updateCaseMutation.mutate({ id: caseId, data: { priority: value as any } })}\n                            >\n                              <SelectTrigger className=\"h-8 text-sm\" data-testid=\"priority-select\">\n                                <SelectValue />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {PRIORITY_OPTIONS.map((option) => (\n                                  <SelectItem key={option.value} value={option.value}>\n                                    {option.label}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n                        </div>\n                      </>\n                    )}\n                  </div>\n                </div>\n\n                {/* Order Information Card */}\n                {linkedOrder && (\n                  <div className=\"border rounded-lg p-3\">\n                    <h3 className=\"text-sm font-medium mb-2 flex items-center gap-1.5\">\n                      <Package className=\"h-3.5 w-3.5\" />\n                      Order Information\n                    </h3>\n                    <div className=\"space-y-2.5\">\n                      <div className=\"grid grid-cols-2 gap-2.5\">\n                        <div>\n                          <label className=\"text-xs text-muted-foreground block mb-0.5\">Order Number</label>\n                          <p className=\"text-sm\" data-testid=\"order-number\">#{linkedOrder.orderNumber}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-xs text-muted-foreground block mb-0.5\">Order Date</label>\n                          <p className=\"text-sm\" data-testid=\"order-date\">{formatDateTime(linkedOrder.orderDate)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-xs text-muted-foreground block mb-0.5\">Customer</label>\n                          <p className=\"text-sm\" data-testid=\"order-customer\">{linkedOrder.customerName || linkedOrder.customerEmail}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-xs text-muted-foreground block mb-0.5\">Total Amount</label>\n                          <p className=\"text-sm\" data-testid=\"order-total\">‚Ç¨{((linkedOrder.totalAmount || 0) / 100).toFixed(2)}</p>\n                        </div>\n                        <div>\n                          <label className=\"text-xs text-muted-foreground block mb-0.5\">Status</label>\n                          <Badge variant=\"secondary\" className=\"text-xs h-5\" data-testid=\"order-status\">{linkedOrder.status}</Badge>\n                        </div>\n                      </div>\n\n                      {/* Shipping Address */}\n                      {linkedOrder.orderData?.shipping_address && (\n                        <div className=\"pt-2 border-t\">\n                          <label className=\"text-xs text-muted-foreground block mb-0.5\">Shipping Address</label>\n                          <div className=\"text-xs\" data-testid=\"shipping-address\">\n                            <p>{linkedOrder.orderData.shipping_address.name}</p>\n                            <p>{linkedOrder.orderData.shipping_address.address1}</p>\n                            {linkedOrder.orderData.shipping_address.address2 && (\n                              <p>{linkedOrder.orderData.shipping_address.address2}</p>\n                            )}\n                            <p>\n                              {linkedOrder.orderData.shipping_address.zip} {linkedOrder.orderData.shipping_address.city}\n                            </p>\n                            <p>{linkedOrder.orderData.shipping_address.country}</p>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n\n                {/* Case Items Card */}\n                {caseItems.length > 0 && (\n                  <div className=\"border rounded-lg p-3\">\n                    <h3 className=\"text-sm font-medium mb-2 flex items-center gap-1.5\">\n                      <Package className=\"h-3.5 w-3.5\" />\n                      Case Items ({caseItems.length})\n                    </h3>\n                    <div className=\"space-y-1.5\">\n                      {caseItems.map((item: any, index: number) => (\n                        <div \n                          key={item.id || index} \n                          className=\"p-2 border rounded space-y-1\"\n                          data-testid={`case-item-${index}`}\n                        >\n                          <div className=\"flex items-start justify-between\">\n                            <div className=\"flex-1\">\n                              <p className=\"text-sm font-medium\" data-testid={`item-product-${index}`}>{item.productName}</p>\n                              <p className=\"text-xs text-muted-foreground\" data-testid={`item-sku-${index}`}>SKU: {item.sku}</p>\n                            </div>\n                            <Badge variant=\"outline\" className=\"text-xs h-5\" data-testid={`item-quantity-${index}`}>\n                              Qty: {item.quantity}\n                            </Badge>\n                          </div>\n                          {item.itemNotes && (\n                            <div className=\"pt-1 border-t\">\n                              <label className=\"text-xs text-muted-foreground\">Notes:</label>\n                              <p className=\"text-xs mt-0.5 whitespace-pre-wrap\" data-testid={`item-notes-${index}`}>\n                                {item.itemNotes}\n                              </p>\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {/* Linked Items Card */}\n                <div className=\"border rounded-lg p-3\">\n                  <h3 className=\"text-sm font-medium mb-2 flex items-center gap-1.5\">\n                    <LinkIcon className=\"h-3.5 w-3.5\" />\n                    Related Items ({relatedEmails.length + relatedOrders.length + relatedRepairs.length + relatedTodos.length})\n                  </h3>\n                  <div className=\"space-y-2.5\">\n                    {/* Quick Link Section */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm font-medium\">Link New Item</label>\n                      <div className=\"flex gap-2\">\n                        <Select value={linkType} onValueChange={(value: any) => {\n                          setLinkType(value);\n                          setLinkSearchTerm(\"\");\n                        }}>\n                          <SelectTrigger className=\"w-32\" data-testid=\"link-type-select\">\n                            <SelectValue placeholder=\"Type...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"email\">Email</SelectItem>\n                            <SelectItem value=\"order\">Order</SelectItem>\n                            <SelectItem value=\"repair\">Repair</SelectItem>\n                            <SelectItem value=\"todo\">Todo</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <div className=\"flex-1 relative\">\n                          <Input\n                            placeholder={\n                              linkType === \"order\" ? \"Search order number or customer...\" :\n                              linkType === \"email\" ? \"Search subject or email...\" :\n                              linkType === \"repair\" ? \"Search repair title...\" :\n                              linkType === \"todo\" ? \"Search todo title...\" :\n                              \"Select type first...\"\n                            }\n                            value={linkSearchTerm}\n                            onChange={(e) => setLinkSearchTerm(e.target.value)}\n                            disabled={!linkType}\n                            data-testid=\"link-search-input\"\n                          />\n                          {linkSearchTerm.trim() && searchResults.length > 0 && (\n                            <div className=\"absolute z-10 w-full mt-1 bg-background border rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                              {linkType === \"email\" && searchResults.map((email: any) => (\n                                <button\n                                  key={email.id}\n                                  onClick={() => linkItemMutation.mutate({ type: linkType, id: email.id })}\n                                  className=\"w-full p-3 text-left hover:bg-muted transition-colors border-b last:border-0\"\n                                  data-testid={`link-result-${email.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">{email.subject}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{email.customerEmail}</div>\n                                </button>\n                              ))}\n                              {linkType === \"order\" && searchResults.map((order: any) => (\n                                <button\n                                  key={order.id}\n                                  onClick={() => linkItemMutation.mutate({ type: linkType, id: order.id })}\n                                  className=\"w-full p-3 text-left hover:bg-muted transition-colors border-b last:border-0\"\n                                  data-testid={`link-result-${order.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">Order #{order.orderNumber}</div>\n                                  <div className=\"text-xs text-muted-foreground\">\n                                    {order.customerEmail || order.customerName} ‚Ä¢ ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                                  </div>\n                                </button>\n                              ))}\n                              {linkType === \"repair\" && searchResults.map((repair: any) => (\n                                <button\n                                  key={repair.id}\n                                  onClick={() => linkItemMutation.mutate({ type: linkType, id: repair.id })}\n                                  className=\"w-full p-3 text-left hover:bg-muted transition-colors border-b last:border-0\"\n                                  data-testid={`link-result-${repair.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">{repair.title}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{repair.description}</div>\n                                </button>\n                              ))}\n                              {linkType === \"todo\" && searchResults.map((todo: any) => (\n                                <button\n                                  key={todo.id}\n                                  onClick={() => linkItemMutation.mutate({ type: linkType, id: todo.id })}\n                                  className=\"w-full p-3 text-left hover:bg-muted transition-colors border-b last:border-0\"\n                                  data-testid={`link-result-${todo.id}`}\n                                >\n                                  <div className=\"font-medium text-sm\">{todo.title}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{todo.description}</div>\n                                </button>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Linked Emails */}\n                    {relatedEmails.length > 0 && (\n                      <Collapsible open={showLinkedEmails} onOpenChange={setShowLinkedEmails}>\n                        <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2 hover:bg-muted rounded-md\">\n                          <div className=\"flex items-center gap-2\">\n                            {showLinkedEmails ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\n                            <Mail className=\"h-4 w-4\" />\n                            <span className=\"font-medium\">Emails ({relatedEmails.length})</span>\n                          </div>\n                        </CollapsibleTrigger>\n                        <CollapsibleContent className=\"space-y-2 mt-2\">\n                          {relatedEmails.map((email) => {\n                            const link = caseLinksData.find((l: any) => l.linkedId === email.id && l.linkType === \"email\");\n                            return (\n                              <div key={email.id} className=\"flex items-center justify-between p-2 bg-muted/50 rounded-md\">\n                                <div className=\"flex-1 min-w-0\">\n                                  <div className=\"text-sm font-medium truncate\">{email.subject}</div>\n                                  <div className=\"text-xs text-muted-foreground\">{email.customerEmail}</div>\n                                </div>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => link && unlinkItemMutation.mutate(link.id)}\n                                  data-testid={`unlink-email-${email.id}`}\n                                >\n                                  <X className=\"h-3 w-3\" />\n                                </Button>\n                              </div>\n                            );\n                          })}\n                        </CollapsibleContent>\n                      </Collapsible>\n                    )}\n\n                    {/* Linked Orders */}\n                    {relatedOrders.length > 0 && (\n                      <Collapsible open={showLinkedOrders} onOpenChange={setShowLinkedOrders}>\n                        <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2 hover:bg-muted rounded-md\">\n                          <div className=\"flex items-center gap-2\">\n                            {showLinkedOrders ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\n                            <Package className=\"h-4 w-4\" />\n                            <span className=\"font-medium\">Orders ({relatedOrders.length})</span>\n                          </div>\n                        </CollapsibleTrigger>\n                        <CollapsibleContent className=\"space-y-2 mt-2\">\n                          {relatedOrders.map((order: Order) => {\n                            const link = caseLinksData.find((l: any) => l.linkedId === order.id && l.linkType === \"order\");\n                            return (\n                              <div key={order.id} className=\"flex items-center justify-between p-2 bg-muted/50 rounded-md\">\n                                <div className=\"flex-1 min-w-0\">\n                                  <div className=\"text-sm font-medium\">Order #{order.orderNumber}</div>\n                                  <div className=\"text-xs text-muted-foreground\">\n                                    {order.customerEmail} ‚Ä¢ ‚Ç¨{((order.totalAmount || 0) / 100).toFixed(2)}\n                                  </div>\n                                </div>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => link && unlinkItemMutation.mutate(link.id)}\n                                  data-testid={`unlink-order-${order.id}`}\n                                >\n                                  <X className=\"h-3 w-3\" />\n                                </Button>\n                              </div>\n                            );\n                          })}\n                        </CollapsibleContent>\n                      </Collapsible>\n                    )}\n\n                    {/* Linked Repairs */}\n                    {relatedRepairs.length > 0 && (\n                      <Collapsible open={showLinkedRepairs} onOpenChange={setShowLinkedRepairs}>\n                        <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2 hover:bg-muted rounded-md\">\n                          <div className=\"flex items-center gap-2\">\n                            {showLinkedRepairs ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\n                            <Wrench className=\"h-4 w-4\" />\n                            <span className=\"font-medium\">Repairs ({relatedRepairs.length})</span>\n                          </div>\n                        </CollapsibleTrigger>\n                        <CollapsibleContent className=\"space-y-2 mt-2\">\n                          {relatedRepairs.map((repair: Repair) => {\n                            const link = caseLinksData.find((l: any) => l.linkedId === repair.id && l.linkType === \"repair\");\n                            return (\n                              <div key={repair.id} className=\"flex items-center justify-between p-2 bg-muted/50 rounded-md\">\n                                <div className=\"flex-1 min-w-0\">\n                                  <div className=\"text-sm font-medium\">{repair.title}</div>\n                                  <div className=\"text-xs text-muted-foreground truncate\">{repair.description}</div>\n                                </div>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => link && unlinkItemMutation.mutate(link.id)}\n                                  data-testid={`unlink-repair-${repair.id}`}\n                                >\n                                  <X className=\"h-3 w-3\" />\n                                </Button>\n                              </div>\n                            );\n                          })}\n                        </CollapsibleContent>\n                      </Collapsible>\n                    )}\n\n                    {/* Linked Todos */}\n                    {relatedTodos.length > 0 && (\n                      <Collapsible open={showLinkedTodos} onOpenChange={setShowLinkedTodos}>\n                        <CollapsibleTrigger className=\"flex items-center justify-between w-full p-2 hover:bg-muted rounded-md\">\n                          <div className=\"flex items-center gap-2\">\n                            {showLinkedTodos ? <ChevronDown className=\"h-4 w-4\" /> : <ChevronRight className=\"h-4 w-4\" />}\n                            <CheckSquare className=\"h-4 w-4\" />\n                            <span className=\"font-medium\">Todos ({relatedTodos.length})</span>\n                          </div>\n                        </CollapsibleTrigger>\n                        <CollapsibleContent className=\"space-y-2 mt-2\">\n                          {relatedTodos.map((todo: Todo) => {\n                            const link = caseLinksData.find((l: any) => l.linkedId === todo.id && l.linkType === \"todo\");\n                            return (\n                              <div key={todo.id} className=\"flex items-center justify-between p-2 bg-muted/50 rounded-md\">\n                                <div className=\"flex-1 min-w-0\">\n                                  <div className=\"text-sm font-medium\">{todo.title}</div>\n                                  <div className=\"text-xs text-muted-foreground truncate\">{todo.description}</div>\n                                </div>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => link && unlinkItemMutation.mutate(link.id)}\n                                  data-testid={`unlink-todo-${todo.id}`}\n                                >\n                                  <X className=\"h-3 w-3\" />\n                                </Button>\n                              </div>\n                            );\n                          })}\n                        </CollapsibleContent>\n                      </Collapsible>\n                    )}\n\n                    {relatedEmails.length === 0 && relatedOrders.length === 0 && relatedRepairs.length === 0 && relatedTodos.length === 0 && (\n                      <p className=\"text-xs text-muted-foreground text-center py-3\">\n                        No linked items. Use the search above to link emails, orders, repairs, or todos.\n                      </p>\n                    )}\n                  </div>\n                </div>\n\n                {/* Activity Timeline */}\n                <div className=\"border rounded-lg p-3\">\n                  <h3 className=\"text-sm font-medium mb-2 flex items-center gap-1.5\">\n                    <ActivityIcon className=\"h-3.5 w-3.5\" />\n                    Activity Timeline\n                  </h3>\n                  <div className=\"space-y-2\">\n                    {caseEvents.length > 0 ? (\n                      caseEvents.map((event: any, index: number) => (\n                        <div key={event.id || index} className=\"flex gap-2\">\n                          <div className=\"flex flex-col items-center\">\n                            <div className=\"w-1.5 h-1.5 rounded-full bg-primary mt-1\" />\n                            {index < caseEvents.length - 1 && (\n                              <div className=\"w-0.5 flex-1 bg-border mt-1\" />\n                            )}\n                          </div>\n                          <div className=\"flex-1 pb-2\">\n                            <p className=\"text-xs font-medium\">{event.message}</p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {formatDateTime(event.createdAt)}\n                            </p>\n                          </div>\n                        </div>\n                      ))\n                    ) : (\n                      <p className=\"text-xs text-muted-foreground text-center py-3\">No activity yet</p>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Right Column: Notes */}\n              <div className=\"space-y-2.5\">\n                <div className=\"border rounded-lg p-3 h-full\">\n                  <h3 className=\"text-sm font-medium mb-2 flex items-center gap-1.5\">\n                    <MessageSquare className=\"h-3.5 w-3.5\" />\n                    Notes & Communication\n                  </h3>\n                  <div className=\"h-[600px]\">\n                    {currentUser && (\n                      <NotesPanel\n                        entityType=\"case\"\n                        entityId={caseId}\n                        currentUser={currentUser}\n                      />\n                    )}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Are you sure?</AlertDialogTitle>\n            <AlertDialogDescription>\n              This will permanently delete case #{caseData?.caseNumber}. This action cannot be undone.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"cancel-delete-button\">Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={() => deleteCaseMutation.mutate()}\n              disabled={deleteCaseMutation.isPending}\n              data-testid=\"confirm-delete-button\"\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n            >\n              {deleteCaseMutation.isPending ? \"Deleting...\" : \"Delete\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Send Email Dialog */}\n      <EmailCompose\n        open={showEmailDialog}\n        onOpenChange={setShowEmailDialog}\n        to={caseData?.customerEmail || \"\"}\n        subject={`Re: Case #${caseData?.caseNumber || caseId}`}\n      />\n    </>\n  );\n}\n","size_bytes":43343},"server/scheduledSync.ts":{"content":"import cron from 'node-cron';\nimport { log } from './vite';\n\nexport function startScheduledSync() {\n  // Run every hour at minute 0 (e.g., 1:00, 2:00, 3:00...)\n  cron.schedule('0 * * * *', async () => {\n    try {\n      log('üîÑ [Auto-Sync] Starting scheduled Shopify sync...');\n      \n      // Call the incremental sync endpoint\n      const response = await fetch('http://localhost:5000/api/shopify/sync-incremental', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(`Sync failed with status: ${response.status}`);\n      }\n\n      const result = await response.json();\n      \n      log(`‚úÖ [Auto-Sync] Completed! Synced: ${result.stats?.synced || 0} orders, Created: ${result.stats?.created || 0}, Updated: ${result.stats?.updated || 0}`);\n      \n      if (result.errors && result.errors.length > 0) {\n        log(`‚ö†Ô∏è [Auto-Sync] Encountered ${result.errors.length} errors during sync`);\n      }\n    } catch (error) {\n      log(`‚ùå [Auto-Sync] Failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  });\n\n  log('‚è∞ Scheduled Shopify sync enabled - will run every hour');\n}\n","size_bytes":1217},"DESIGN_REFINEMENTS.md":{"content":"# DutchThrift Hub Design System Refinements\n\n**Final Implementation Guide - November 2025**\n\n---\n\n## üìã Overview\n\nThis document outlines the final design system refinements applied to DutchThrift Hub, focusing on visual consistency, readability, and mobile responsiveness. The design maintains the warm, modern aesthetic with orange (#FF6600) as a confident brand accent.\n\n---\n\n## üé® Complete Color System\n\n### Exact Brand Colors\n\n```css\n/* PRIMARY ORANGE */\n--primary: #FF6600          /* HSL: 24 100% 50% */\n\n/* BACKGROUNDS */\n--bg-light: #F8F8F8         /* HSL: 0 0% 97.25% */\n--bg-dark: #0E0E0E          /* HSL: 0 0% 5.5% */\n\n/* TEXT COLORS */\n--text-light-mode: #1C1C1C  /* HSL: 0 0% 11% */\n--text-dark-mode: #EDEDED   /* HSL: 0 0% 93% */\n--text-secondary: #B3B3B3   /* HSL: 0 0% 70% */\n```\n\n### Complete Light Mode Palette\n\n```css\n:root {\n  /* Foundation */\n  --background: hsl(0 0% 97.25%);       /* #F8F8F8 */\n  --foreground: hsl(0 0% 11%);          /* #1C1C1C */\n  --card: hsl(0 0% 100%);               /* Pure white */\n  \n  /* Primary Orange */\n  --primary: 24 100% 50%;               /* #FF6600 */\n  \n  /* Neutrals - Clean Grays */\n  --secondary: hsl(0 0% 94%);\n  --muted: hsl(0 0% 96%);\n  --muted-foreground: hsl(0 0% 45%);\n  \n  /* Borders */\n  --border: hsl(0 0% 89%);\n  \n  /* Focus Ring */\n  --ring: 24 100% 50%;                  /* Orange */\n}\n```\n\n### Complete Dark Mode Palette\n\n```css\n.dark {\n  /* Foundation */\n  --background: hsl(0 0% 5.5%);         /* #0E0E0E */\n  --foreground: hsl(0 0% 93%);          /* #EDEDED */\n  --card: hsl(0 0% 10%);\n  \n  /* Primary Orange (Brighter) */\n  --primary: 24 100% 55%;\n  \n  /* Neutrals */\n  --secondary: hsl(0 0% 14%);\n  --muted: hsl(0 0% 14%);\n  --muted-foreground: hsl(0 0% 60%);\n  \n  /* Borders */\n  --border: hsl(0 0% 18%);\n  \n  /* Sidebar - HIGH CONTRAST */\n  --sidebar-bg: hsla(0 0% 8% / 0.55);    /* Translucent with blur */\n  --sidebar-foreground: hsl(0 0% 80%);   /* Light gray for readability */\n}\n```\n\n### Status Colors (No Blue/Purple)\n\n```css\n/* Light Mode */\n--destructive: hsl(0 84% 60%);    /* Red */\n--success: hsl(142 71% 45%);      /* Green */\n--warning: hsl(38 92% 50%);       /* Amber */\n\n/* Dark Mode */\n--destructive: hsl(0 84% 65%);    /* Brighter red */\n--success: hsl(142 71% 50%);      /* Brighter green */\n--warning: hsl(38 92% 55%);       /* Brighter amber */\n```\n\n---\n\n## üß© Unified Component System\n\n### 1. Button Variants\n\n```tsx\n// PRIMARY - Orange background\n<Button variant=\"primary\">\n  Create Order\n</Button>\n\n// SECONDARY - Neutral gray\n<Button variant=\"secondary\">\n  Cancel\n</Button>\n\n// OUTLINE - Border only\n<Button variant=\"outline\">\n  Filter\n</Button>\n\n// GHOST - No background\n<Button variant=\"ghost\">\n  More Options\n</Button>\n\n// DANGER - Red for destructive actions\n<Button variant=\"danger\">\n  Delete Item\n</Button>\n\n// LINK - Text link style\n<Button variant=\"link\">\n  Learn More\n</Button>\n```\n\n**Styling Details:**\n- Height: `h-10` (default), `h-9` (sm), `h-11` (lg)\n- Border radius: `rounded-lg` (12px)\n- Font weight: `font-semibold`\n- Orange shadow on primary hover\n- Active state: `scale-[0.98]`\n- Orange focus ring: `focus:ring-[#FF6600]`\n\n### 2. PageHeader Component\n\n```tsx\nimport { PageHeader } from \"@/components/shared/page-header\";\nimport { Button } from \"@/components/ui/button\";\nimport { Plus } from \"lucide-react\";\n\n<PageHeader\n  title=\"Orders\"\n  subtitle=\"Manage and track customer orders\"\n  breadcrumbs={[\n    { label: \"Home\", href: \"/\" },\n    { label: \"Orders\" }\n  ]}\n  actions={\n    <>\n      <Button variant=\"outline\">Export</Button>\n      <Button variant=\"primary\">\n        <Plus className=\"h-4 w-4 mr-2\" />\n        New Order\n      </Button>\n    </>\n  }\n/>\n```\n\n**Features:**\n- Consistent spacing and alignment\n- Responsive: stacks on mobile\n- Optional breadcrumbs\n- Flexible actions slot\n- Typography hierarchy\n\n### 3. Form Components\n\n#### Input\n\n```tsx\n<Input\n  placeholder=\"Search orders...\"\n  className=\"w-full\"\n/>\n```\n\n**Styling:**\n- Height: `h-10`\n- Border radius: `rounded-lg`\n- Orange focus ring\n- Border color changes to orange on focus\n\n#### Select\n\n```tsx\n<Select>\n  <SelectTrigger>\n    <SelectValue placeholder=\"Select status\" />\n  </SelectTrigger>\n  <SelectContent>\n    <SelectItem value=\"pending\">Pending</SelectItem>\n    <SelectItem value=\"completed\">Completed</SelectItem>\n  </SelectContent>\n</Select>\n```\n\n**Styling:**\n- Matches input height and styling\n- Orange checkmark for selected items\n- Smooth animations\n\n#### Textarea\n\n```tsx\n<Textarea\n  placeholder=\"Enter description...\"\n  className=\"min-h-[120px]\"\n/>\n```\n\n**Styling:**\n- Same as Input but with vertical resize\n- Min height: `80px`\n- Auto-grows with content\n\n---\n\n## üì± Mobile Optimization\n\n### Navigation Drawer\n\n**Desktop:**\n- Top navigation bar with inline menu items\n- Active item: orange background (#FF6600), white text\n- Inactive: gray text, hover shows gray background\n\n**Mobile (< 1024px):**\n- Hamburger menu button (top-left)\n- Slide-in drawer from left\n- Glass effect with backdrop blur (14px)\n- Full-height overlay with blur\n- Close on outside click or X button\n\n#### Mobile Menu Structure\n\n```tsx\n/* Header */\n- Logo + Close button\n\n/* Navigation Items */\n- Active: Orange bg + white text + shadow\n- Inactive: Gray text (dark:text-gray-300)\n- Hover: Light accent background\n\n/* Admin Section */\n- Separated with border\n- User Management\n- Settings\n\n/* Theme Selector */\n- Light / Dark / System buttons\n- Visual indicator for active theme\n\n/* Logout */\n- Red text\n- Bottom of drawer\n```\n\n**Contrast Fix:**\n```css\n/* Dark Mode Sidebar - HIGH CONTRAST */\n.sidebar-glass {\n  background: rgba(20, 20, 20, 0.55);\n  backdrop-filter: blur(14px);\n}\n\n/* Text Colors */\n- Inactive items: text-gray-700 dark:text-gray-300\n- Active items: text-white (on orange bg)\n- Hover: text-foreground\n```\n\n### Modal Behavior\n\n**Desktop:**\n- Centered modal with glassmorphism\n- Overlay: `bg-black/60` with `backdrop-blur-sm`\n- Max width: `max-w-lg`\n\n**Mobile:**\n- Full-screen or bottom drawer approach\n- Smooth slide-in animation\n- Easy to dismiss with overlay tap\n\n---\n\n## üé® Shadow System\n\n```css\n.shadow-soft {\n  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08),\n              0 1px 2px rgba(0, 0, 0, 0.06);\n}\n\n.shadow-card {\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08),\n              0 1px 3px rgba(0, 0, 0, 0.06);\n}\n\n.shadow-card-hover {\n  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12),\n              0 3px 6px rgba(0, 0, 0, 0.08);\n}\n\n.shadow-modal {\n  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.18),\n              0 12px 24px rgba(0, 0, 0, 0.12);\n}\n\n.shadow-orange {\n  box-shadow: 0 8px 24px rgba(255, 102, 0, 0.25);\n}\n\n.dark .shadow-orange {\n  box-shadow: 0 8px 24px rgba(255, 102, 0, 0.35);\n}\n```\n\n---\n\n## üå´Ô∏è Glassmorphism\n\n```css\n.glass {\n  background: rgba(255, 255, 255, 0.7);\n  backdrop-filter: blur(14px);\n  border: 1px solid rgba(255, 255, 255, 0.2);\n}\n\n.dark .glass {\n  background: rgba(20, 20, 20, 0.55);\n  backdrop-filter: blur(14px);\n  border: 1px solid rgba(255, 255, 255, 0.08);\n}\n\n.glass-strong {\n  background: rgba(255, 255, 255, 0.85);\n  backdrop-filter: blur(20px);\n}\n\n.dark .glass-strong {\n  background: rgba(20, 20, 20, 0.75);\n  backdrop-filter: blur(20px);\n}\n\n.sidebar-glass {\n  background: var(--sidebar-bg);\n  backdrop-filter: blur(14px);\n}\n```\n\n**Usage:**\n- Modal overlays\n- Mobile drawer\n- Popovers\n- Floating panels\n\n---\n\n## ‚ú® Animation System\n\n```css\n.animate-fade-in {\n  animation: fadeIn 0.2s ease-out;\n}\n\n.animate-slide-in {\n  animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n}\n\n.animate-scale-in {\n  animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);\n}\n```\n\n**Transitions:**\n- Button interactions: `300ms`\n- Input focus: `200ms`\n- Modal open/close: `200-300ms`\n- Drawer slide: `300ms cubic-bezier`\n\n---\n\n## üìê Spacing & Layout\n\n### Page Width Standard\n\n**All pages use the container layout for consistency:**\n\n```tsx\n<main className=\"container mx-auto px-4 py-6\">\n```\n\n**Benefits:**\n- **Max-width**: Content doesn't stretch too wide on large screens\n- **Centered**: Automatic left/right margins center the content\n- **Responsive**: Adapts to different screen sizes\n- **Compact**: Creates comfortable reading width (not edge-to-edge)\n\n**Pages using this standard:**\n- ‚úÖ Dashboard\n- ‚úÖ Orders\n- ‚úÖ Purchase Orders\n- ‚úÖ Repairs\n- ‚úÖ Cases\n- ‚úÖ Case Detail\n- ‚úÖ Todos\n- ‚úÖ All other pages\n\n### Consistent Spacing Scale\n\n```css\n/* Tailwind spacing (multiplied by 0.25rem = 4px) */\ngap-1: 4px\ngap-2: 8px\ngap-3: 12px\ngap-4: 16px\ngap-6: 24px\n\n/* Common Patterns */\nCard padding: p-6 (24px)\nButton padding: px-4 py-2 (16px √ó 8px)\nInput padding: px-3 py-2 (12px √ó 8px)\nPage margins: mb-6 (24px)\n```\n\n### Responsive Breakpoints\n\n```css\nsm:  640px   /* Tablets */\nmd:  768px   /* Small laptops */\nlg:  1024px  /* Desktops - Desktop nav shows here */\nxl:  1280px  /* Large desktops */\n```\n\n### Typography Scale\n\n```css\nh1: text-3xl md:text-4xl lg:text-5xl (30-48px)\nh2: text-2xl md:text-3xl lg:text-4xl (24-36px)\nh3: text-xl md:text-2xl (20-24px)\nh4: text-lg md:text-xl (18-20px)\n\nbody: text-sm (14px)\nsmall: text-xs (12px)\n```\n\n---\n\n## üß™ Contrast & Accessibility\n\n### WCAG AA Compliance\n\n| Element | Contrast Ratio | Pass |\n|---------|---------------|------|\n| Primary on White | 4.5:1 | ‚úÖ |\n| Foreground on Background | 12:1 | ‚úÖ‚úÖ |\n| Muted Text | 4.8:1 | ‚úÖ |\n| Success on White | 4.2:1 | ‚úÖ |\n\n### Dark Mode Improvements\n\n**Problem:** Sidebar text was hard to read due to low contrast\n\n**Solution:**\n- Changed sidebar text from `text-sidebar-foreground` to `text-gray-700 dark:text-gray-300`\n- Active items: `text-white` on orange background\n- Increased opacity of glass background\n- Better blur separation from content behind\n\n**Before:**\n```css\ncolor: hsl(var(--sidebar-foreground)); /* Too dark in dark mode */\n```\n\n**After:**\n```css\n/* Light mode */\ncolor: rgb(55 65 81);  /* gray-700 */\n\n/* Dark mode */\ncolor: rgb(209 213 219);  /* gray-300 - much more readable */\n```\n\n---\n\n## üìã Component Checklist\n\n### ‚úÖ Completed Components\n\n- [x] Button (all variants: primary, secondary, outline, ghost, danger, link)\n- [x] Input (orange focus ring, consistent styling)\n- [x] Select (matches input, orange check indicator)\n- [x] Textarea (consistent with other form elements)\n- [x] PageHeader (unified header across all pages)\n- [x] Navigation (desktop + mobile drawer with glassmorphism)\n- [x] Card (soft shadows, hover effects)\n- [x] Dialog (glassmorphism, mobile-optimized)\n- [x] Sheet/Drawer (sidebar glass effect, mobile slide-in)\n- [x] Badge (rounded, semi-transparent backgrounds)\n- [x] Popover (glass effect, proper shadows)\n\n### üé® Color Consistency\n\n- [x] Removed all blue/purple tones\n- [x] Orange (#FF6600) as primary only\n- [x] Neutral grays throughout\n- [x] Consistent status colors (red, green, amber only)\n- [x] Sidebar contrast fixed for dark mode\n\n### üì± Mobile Responsiveness\n\n- [x] Navigation drawer with glassmorphism\n- [x] Mobile overlay with blur\n- [x] Close on outside click\n- [x] Theme selector in mobile menu\n- [x] Full-height drawer layout\n- [x] Smooth slide animations\n- [x] Touch-optimized button sizes\n\n---\n\n## üöÄ Quick Reference\n\n### Using Orange Effectively\n\n```tsx\n// ‚úÖ DO - Primary actions\n<Button variant=\"primary\">Save</Button>\n\n// ‚úÖ DO - Active states\nclassName={isActive && \"bg-[#FF6600] text-white\"}\n\n// ‚úÖ DO - Focus rings\nclassName=\"focus:ring-[#FF6600]\"\n\n// ‚ùå DON'T - Background areas\nclassName=\"bg-[#FF6600] p-12\"  /* Too much orange */\n\n// ‚ùå DON'T - Body text\nclassName=\"text-[#FF6600]\"  /* Use for links only */\n```\n\n### Common Patterns\n\n```tsx\n// Page Layout (STANDARD - Use on all pages)\n<div className=\"min-h-screen bg-background\">\n  <Navigation />\n  <main className=\"container mx-auto px-4 py-6\">\n    <PageHeader\n      title=\"Page Title\"\n      subtitle=\"Description\"\n      actions={<Button>Action</Button>}\n    />\n    {/* Content */}\n  </main>\n</div>\n\n// IMPORTANT: Always use `container mx-auto px-4 py-6` for consistent page width\n// This creates a centered layout with max-width and proper spacing\n// ‚ùå DON'T use: className=\"flex-1 p-6\" (full-width, inconsistent)\n\n// Form Input\n<div className=\"space-y-2\">\n  <label className=\"text-sm font-medium\">Label</label>\n  <Input placeholder=\"Enter value\" />\n  <p className=\"text-xs text-muted-foreground\">Helper text</p>\n</div>\n\n// Card with Hover\n<Card className=\"card-interactive\">\n  <CardHeader>\n    <CardTitle>Title</CardTitle>\n  </CardHeader>\n  <CardContent>Content</CardContent>\n</Card>\n```\n\n---\n\n## üìö Implementation Notes\n\n### 1. Color Variables Usage\n\nAlways use HSL format for primary color:\n```css\n/* Correct */\n--primary: 24 100% 50%;\nbackground: hsl(var(--primary));\n\n/* For direct use */\nbg-[#FF6600]\n```\n\n### 2. Focus States\n\nAll interactive elements must have orange focus ring:\n```tsx\nclassName=\"focus:ring-2 focus:ring-[#FF6600]\"\n```\n\n### 3. Dark Mode Text\n\nUse utility classes for better contrast:\n```tsx\n// Instead of css variables\nclassName=\"text-gray-700 dark:text-gray-300\"\n\n// For active states\nclassName=\"text-white\"  /* On orange background */\n```\n\n### 4. Mobile-First Approach\n\n```tsx\n// Stack on mobile, row on desktop\nclassName=\"flex flex-col md:flex-row gap-4\"\n\n// Hide on mobile, show on desktop\nclassName=\"hidden lg:flex\"\n\n// Show only on mobile\nclassName=\"lg:hidden\"\n```\n\n---\n\n## üéØ Design Principles Summary\n\n1. **Orange as Accent Only** - Used for primary actions, active states, focus rings\n2. **Warm Neutrals** - Soft whites in light mode, deep grays in dark mode\n3. **High Contrast** - All text meets WCAG AA standards\n4. **Consistent Spacing** - 8px grid system throughout\n5. **Mobile-First** - All components responsive and touch-optimized\n6. **Glassmorphism** - Subtle blur effects on overlays\n7. **Smooth Animations** - 200-300ms transitions everywhere\n8. **No Blue/Purple** - Only orange, grays, red, green, amber\n\n---\n\n**Last Updated:** November 6, 2025  \n**Design System Version:** 2.0  \n**Status:** Production Ready ‚úÖ\n","size_bytes":13934},"COMPONENT_USAGE_EXAMPLES.md":{"content":"# Component Usage Examples\n\n**DutchThrift Hub Design System - Practical Implementation Guide**\n\n---\n\n## üìã Table of Contents\n\n1. [Page Structure](#page-structure)\n2. [Forms & Inputs](#forms--inputs)\n3. [Navigation Patterns](#navigation-patterns)\n4. [Modal & Dialog Usage](#modal--dialog-usage)\n5. [Card Layouts](#card-layouts)\n6. [Mobile-Responsive Patterns](#mobile-responsive-patterns)\n\n---\n\n## üèóÔ∏è Page Structure\n\n### Basic Page Layout\n\n```tsx\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { PageHeader } from \"@/components/shared/page-header\";\nimport { Button } from \"@/components/ui/button\";\nimport { Plus, Filter, Download } from \"lucide-react\";\n\nexport default function OrdersPage() {\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Navigation />\n      \n      <main className=\"container mx-auto p-4 md:p-6 lg:p-8\">\n        <PageHeader\n          title=\"Orders\"\n          subtitle=\"Manage and track all customer orders\"\n          breadcrumbs={[\n            { label: \"Home\", href: \"/\" },\n            { label: \"Orders\" }\n          ]}\n          actions={\n            <>\n              <Button variant=\"outline\">\n                <Filter className=\"h-4 w-4 mr-2\" />\n                Filter\n              </Button>\n              <Button variant=\"outline\">\n                <Download className=\"h-4 w-4 mr-2\" />\n                Export\n              </Button>\n              <Button variant=\"primary\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                New Order\n              </Button>\n            </>\n          }\n        />\n        \n        {/* Page Content */}\n        <div className=\"space-y-6\">\n          {/* Your content here */}\n        </div>\n      </main>\n    </div>\n  );\n}\n```\n\n---\n\n## üìù Forms & Inputs\n\n### Complete Form Example\n\n```tsx\nimport { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport function OrderForm() {\n  const { register, handleSubmit } = useForm();\n\n  const onSubmit = (data) => {\n    console.log(data);\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Create New Order</CardTitle>\n        <CardDescription>\n          Fill in the details below to create a new order\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-4\">\n          {/* Text Input */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"customer\">Customer Name</Label>\n            <Input\n              id=\"customer\"\n              placeholder=\"Enter customer name\"\n              {...register(\"customer\")}\n            />\n          </div>\n\n          {/* Select Dropdown */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"status\">Order Status</Label>\n            <Select>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select status\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"pending\">Pending</SelectItem>\n                <SelectItem value=\"processing\">Processing</SelectItem>\n                <SelectItem value=\"completed\">Completed</SelectItem>\n                <SelectItem value=\"cancelled\">Cancelled</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Textarea */}\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Order Notes</Label>\n            <Textarea\n              id=\"notes\"\n              placeholder=\"Enter any additional notes...\"\n              className=\"min-h-[100px]\"\n              {...register(\"notes\")}\n            />\n          </div>\n\n          {/* Multiple Inputs in Row */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"quantity\">Quantity</Label>\n              <Input\n                id=\"quantity\"\n                type=\"number\"\n                placeholder=\"0\"\n                {...register(\"quantity\")}\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"price\">Price</Label>\n              <Input\n                id=\"price\"\n                type=\"number\"\n                placeholder=\"0.00\"\n                {...register(\"price\")}\n              />\n            </div>\n          </div>\n\n          {/* Form Actions */}\n          <div className=\"flex flex-col sm:flex-row gap-2 pt-4\">\n            <Button type=\"button\" variant=\"outline\" className=\"sm:order-1\">\n              Cancel\n            </Button>\n            <Button type=\"submit\" variant=\"primary\" className=\"sm:order-2\">\n              Create Order\n            </Button>\n          </div>\n        </form>\n      </CardContent>\n    </Card>\n  );\n}\n```\n\n### Inline Filter Bar\n\n```tsx\nimport { Search, Filter } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\n\nexport function FilterBar() {\n  return (\n    <div className=\"flex flex-col md:flex-row gap-3 p-4 bg-card rounded-lg border border-border\">\n      {/* Search */}\n      <div className=\"flex-1\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            placeholder=\"Search orders...\"\n            className=\"pl-9\"\n          />\n        </div>\n      </div>\n\n      {/* Status Filter */}\n      <Select>\n        <SelectTrigger className=\"w-full md:w-[180px]\">\n          <SelectValue placeholder=\"Status\" />\n        </SelectTrigger>\n        <SelectContent>\n          <SelectItem value=\"all\">All Statuses</SelectItem>\n          <SelectItem value=\"pending\">Pending</SelectItem>\n          <SelectItem value=\"completed\">Completed</SelectItem>\n        </SelectContent>\n      </Select>\n\n      {/* Date Filter */}\n      <Select>\n        <SelectTrigger className=\"w-full md:w-[180px]\">\n          <SelectValue placeholder=\"Date Range\" />\n        </SelectTrigger>\n        <SelectContent>\n          <SelectItem value=\"today\">Today</SelectItem>\n          <SelectItem value=\"week\">This Week</SelectItem>\n          <SelectItem value=\"month\">This Month</SelectItem>\n        </SelectContent>\n      </Select>\n\n      {/* Filter Button */}\n      <Button variant=\"outline\">\n        <Filter className=\"h-4 w-4 mr-2\" />\n        More Filters\n      </Button>\n    </div>\n  );\n}\n```\n\n---\n\n## üß≠ Navigation Patterns\n\n### Active State Detection\n\n```tsx\nimport { Link, useLocation } from \"wouter\";\nimport { Home, ShoppingCart, Wrench } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nconst menuItems = [\n  { href: \"/\", label: \"Dashboard\", icon: Home },\n  { href: \"/orders\", label: \"Orders\", icon: ShoppingCart },\n  { href: \"/repairs\", label: \"Repairs\", icon: Wrench },\n];\n\nexport function SidebarNav() {\n  const [location] = useLocation();\n\n  return (\n    <nav className=\"space-y-1\">\n      {menuItems.map((item) => {\n        const isActive = location === item.href;\n        return (\n          <Link\n            key={item.href}\n            href={item.href}\n            className={cn(\n              \"flex items-center space-x-3 px-3 py-2 rounded-lg transition-all\",\n              isActive\n                ? \"bg-[#FF6600] text-white shadow-orange\"\n                : \"text-gray-700 dark:text-gray-300 hover:bg-accent\"\n            )}\n          >\n            <item.icon className=\"h-5 w-5\" />\n            <span className=\"font-medium\">{item.label}</span>\n          </Link>\n        );\n      })}\n    </nav>\n  );\n}\n```\n\n---\n\n## üí¨ Modal & Dialog Usage\n\n### Confirmation Dialog\n\n```tsx\nimport { useState } from \"react\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Trash2 } from \"lucide-react\";\n\nexport function DeleteConfirmation() {\n  const [open, setOpen] = useState(false);\n\n  const handleDelete = () => {\n    // Perform delete action\n    setOpen(false);\n  };\n\n  return (\n    <>\n      <Button variant=\"danger\" onClick={() => setOpen(true)}>\n        <Trash2 className=\"h-4 w-4 mr-2\" />\n        Delete Order\n      </Button>\n\n      <Dialog open={open} onOpenChange={setOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Are you sure?</DialogTitle>\n            <DialogDescription>\n              This action cannot be undone. This will permanently delete the order\n              and remove all associated data.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setOpen(false)}>\n              Cancel\n            </Button>\n            <Button variant=\"danger\" onClick={handleDelete}>\n              Delete Order\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n```\n\n### Form Modal\n\n```tsx\nimport { useState } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\n\nexport function NewOrderModal() {\n  const [open, setOpen] = useState(false);\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogContent className=\"sm:max-w-[500px]\">\n        <DialogHeader>\n          <DialogTitle>Create New Order</DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"customer\">Customer Name</Label>\n            <Input id=\"customer\" placeholder=\"John Doe\" />\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"product\">Product</Label>\n            <Input id=\"product\" placeholder=\"Product name\" />\n          </div>\n          \n          <div className=\"space-y-2\">\n            <Label htmlFor=\"notes\">Notes</Label>\n            <Textarea id=\"notes\" placeholder=\"Additional notes...\" />\n          </div>\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={() => setOpen(false)}>\n            Cancel\n          </Button>\n          <Button variant=\"primary\">\n            Create Order\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n```\n\n---\n\n## üìä Card Layouts\n\n### Stats Grid\n\n```tsx\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { TrendingUp, TrendingDown, DollarSign, ShoppingCart, Users } from \"lucide-react\";\n\nexport function StatsGrid() {\n  const stats = [\n    {\n      title: \"Total Revenue\",\n      value: \"$45,231\",\n      change: \"+20.1%\",\n      trend: \"up\",\n      icon: DollarSign,\n    },\n    {\n      title: \"Orders\",\n      value: \"2,350\",\n      change: \"+12.5%\",\n      trend: \"up\",\n      icon: ShoppingCart,\n    },\n    {\n      title: \"Customers\",\n      value: \"1,254\",\n      change: \"-2.3%\",\n      trend: \"down\",\n      icon: Users,\n    },\n  ];\n\n  return (\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n      {stats.map((stat) => (\n        <Card key={stat.title} className=\"card-interactive\">\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n              {stat.title}\n            </CardTitle>\n            <stat.icon className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{stat.value}</div>\n            <div className=\"flex items-center text-xs mt-1\">\n              {stat.trend === \"up\" ? (\n                <TrendingUp className=\"h-3 w-3 text-success mr-1\" />\n              ) : (\n                <TrendingDown className=\"h-3 w-3 text-destructive mr-1\" />\n              )}\n              <span className={stat.trend === \"up\" ? \"text-success\" : \"text-destructive\"}>\n                {stat.change}\n              </span>\n              <span className=\"text-muted-foreground ml-1\">from last month</span>\n            </div>\n          </CardContent>\n        </Card>\n      ))}\n    </div>\n  );\n}\n```\n\n### List Card with Actions\n\n```tsx\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { MoreVertical, Eye, Edit, Trash } from \"lucide-react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\n\nexport function OrdersList() {\n  const orders = [\n    { id: \"1\", customer: \"John Doe\", amount: \"$250.00\", status: \"completed\" },\n    { id: \"2\", customer: \"Jane Smith\", amount: \"$180.00\", status: \"pending\" },\n    { id: \"3\", customer: \"Bob Johnson\", amount: \"$420.00\", status: \"processing\" },\n  ];\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Recent Orders</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-2\">\n          {orders.map((order) => (\n            <div\n              key={order.id}\n              className=\"flex items-center justify-between p-3 rounded-lg hover:bg-accent transition-colors\"\n            >\n              <div className=\"flex-1\">\n                <p className=\"font-medium\">{order.customer}</p>\n                <p className=\"text-sm text-muted-foreground\">{order.amount}</p>\n              </div>\n              \n              <Badge\n                variant={\n                  order.status === \"completed\" ? \"success\" :\n                  order.status === \"pending\" ? \"warning\" : \"default\"\n                }\n              >\n                {order.status}\n              </Badge>\n\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"ghost\" size=\"icon\" className=\"ml-2\">\n                    <MoreVertical className=\"h-4 w-4\" />\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                  <DropdownMenuItem>\n                    <Eye className=\"h-4 w-4 mr-2\" />\n                    View\n                  </DropdownMenuItem>\n                  <DropdownMenuItem>\n                    <Edit className=\"h-4 w-4 mr-2\" />\n                    Edit\n                  </DropdownMenuItem>\n                  <DropdownMenuItem className=\"text-destructive\">\n                    <Trash className=\"h-4 w-4 mr-2\" />\n                    Delete\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n```\n\n---\n\n## üì± Mobile-Responsive Patterns\n\n### Responsive Table\n\n```tsx\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\n\nexport function ResponsiveOrdersTable() {\n  const orders = [\n    { id: \"ORD-001\", customer: \"John Doe\", amount: \"$250.00\", status: \"completed\" },\n    { id: \"ORD-002\", customer: \"Jane Smith\", amount: \"$180.00\", status: \"pending\" },\n  ];\n\n  return (\n    <>\n      {/* Desktop Table */}\n      <div className=\"hidden md:block\">\n        <Card>\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead>\n                <tr className=\"border-b border-border\">\n                  <th className=\"px-6 py-3 text-left text-sm font-semibold\">Order ID</th>\n                  <th className=\"px-6 py-3 text-left text-sm font-semibold\">Customer</th>\n                  <th className=\"px-6 py-3 text-left text-sm font-semibold\">Amount</th>\n                  <th className=\"px-6 py-3 text-left text-sm font-semibold\">Status</th>\n                  <th className=\"px-6 py-3 text-right text-sm font-semibold\">Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                {orders.map((order) => (\n                  <tr key={order.id} className=\"border-b border-border hover:bg-accent transition-colors\">\n                    <td className=\"px-6 py-4 text-sm font-medium\">{order.id}</td>\n                    <td className=\"px-6 py-4 text-sm\">{order.customer}</td>\n                    <td className=\"px-6 py-4 text-sm\">{order.amount}</td>\n                    <td className=\"px-6 py-4\">\n                      <Badge variant={order.status === \"completed\" ? \"success\" : \"warning\"}>\n                        {order.status}\n                      </Badge>\n                    </td>\n                    <td className=\"px-6 py-4 text-right\">\n                      <Button variant=\"ghost\" size=\"sm\">View</Button>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        </Card>\n      </div>\n\n      {/* Mobile Cards */}\n      <div className=\"md:hidden space-y-3\">\n        {orders.map((order) => (\n          <Card key={order.id} className=\"p-4\">\n            <div className=\"flex justify-between items-start mb-3\">\n              <div>\n                <p className=\"font-semibold\">{order.id}</p>\n                <p className=\"text-sm text-muted-foreground\">{order.customer}</p>\n              </div>\n              <Badge variant={order.status === \"completed\" ? \"success\" : \"warning\"}>\n                {order.status}\n              </Badge>\n            </div>\n            <div className=\"flex justify-between items-center\">\n              <p className=\"text-lg font-bold\">{order.amount}</p>\n              <Button variant=\"outline\" size=\"sm\">View Details</Button>\n            </div>\n          </Card>\n        ))}\n      </div>\n    </>\n  );\n}\n```\n\n### Responsive Grid\n\n```tsx\nexport function ResponsiveGrid() {\n  return (\n    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n      {/* Grid items */}\n    </div>\n  );\n}\n```\n\n### Mobile Bottom Sheet\n\n```tsx\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from \"@/components/ui/sheet\";\nimport { Button } from \"@/components/ui/button\";\nimport { Filter } from \"lucide-react\";\n\nexport function MobileFilterSheet() {\n  return (\n    <Sheet>\n      <SheetTrigger asChild>\n        <Button variant=\"outline\" className=\"md:hidden\">\n          <Filter className=\"h-4 w-4 mr-2\" />\n          Filters\n        </Button>\n      </SheetTrigger>\n      <SheetContent side=\"bottom\" className=\"h-[80vh]\">\n        <SheetHeader>\n          <SheetTitle>Filter Options</SheetTitle>\n        </SheetHeader>\n        <div className=\"py-4 space-y-4\">\n          {/* Filter options */}\n        </div>\n      </SheetContent>\n    </Sheet>\n  );\n}\n```\n\n---\n\n## ‚úÖ Best Practices Checklist\n\n- [ ] Use `PageHeader` for consistent page titles\n- [ ] Orange (#FF6600) only for primary actions and active states\n- [ ] All inputs have orange focus ring\n- [ ] Buttons use correct variants (primary, secondary, outline, ghost, danger)\n- [ ] Forms stack vertically on mobile\n- [ ] Tables switch to cards on mobile\n- [ ] Dialogs are full-screen or bottom sheet on small screens\n- [ ] All interactive elements have `data-testid` attributes\n- [ ] Text meets WCAG AA contrast standards\n- [ ] Animations are smooth (200-300ms)\n- [ ] Spacing follows 8px grid\n\n---\n\n**Need Help?** Check `DESIGN_REFINEMENTS.md` for full design system documentation.\n","size_bytes":19866},"MOBILE_RESPONSIVENESS.md":{"content":"# Mobile Responsiveness Fix - Page Headers\n\n**Implementation Guide for DutchThrift Hub - November 2025**\n\n---\n\n## üìã Problem\n\nPage headers on mobile devices had buttons overflowing off-screen due to horizontal layout that didn't adapt to narrow screens. The headers used `flex items-center justify-between` which kept content in a single row regardless of screen width.\n\n### Before Fix\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Orders       [Export ‚îÇ ‚Üê Buttons cut off\n‚îÇ View and...  [Import ‚îÇ\n‚îÇ              [Sync S ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n---\n\n## ‚úÖ Solution\n\nChanged all page headers to use responsive flexbox layout that:\n1. **Stacks vertically on mobile** (< 640px) - title/subtitle on top, buttons below\n2. **Horizontal on desktop** (‚â• 640px) - title on left, buttons on right\n3. **Buttons wrap** if they don't fit in one row\n\n### After Fix\n\n**Mobile Layout (<640px):**\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Orders             ‚îÇ ‚Üê Title\n‚îÇ View and manage... ‚îÇ ‚Üê Subtitle\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ [Export] [Import]  ‚îÇ ‚Üê Buttons wrap\n‚îÇ [Sync Shopify]     ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n**Desktop Layout (‚â•640px):**\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ Orders              [Export] [Import]‚îÇ\n‚îÇ View and manage     [Sync Shopify]   ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n---\n\n## üîß Implementation\n\n### Pattern Used\n\n```tsx\n{/* OLD - Not Responsive */}\n<div className=\"flex items-center justify-between\">\n  <div>\n    <h1>Title</h1>\n    <p>Subtitle</p>\n  </div>\n  <div className=\"flex items-center space-x-2\">\n    {/* Buttons */}\n  </div>\n</div>\n\n{/* NEW - Responsive */}\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n  <div>\n    <h1>Title</h1>\n    <p>Subtitle</p>\n  </div>\n  <div className=\"flex items-center gap-2 flex-wrap\">\n    {/* Buttons */}\n  </div>\n</div>\n```\n\n### Key Changes\n\n1. **Main container**: `flex-col sm:flex-row sm:items-center sm:justify-between gap-4`\n   - `flex-col`: Stack vertically by default (mobile)\n   - `sm:flex-row`: Horizontal layout on small screens and up (‚â•640px)\n   - `sm:items-center`: Center items vertically on desktop\n   - `sm:justify-between`: Space between title and actions on desktop\n   - `gap-4`: Consistent spacing in both directions\n\n2. **Button container**: `flex items-center gap-2 flex-wrap`\n   - `flex-wrap`: Allows buttons to wrap to next line if needed\n   - `gap-2`: Consistent spacing between buttons\n   - Removed `space-x-2` (doesn't work well with wrapping)\n\n3. **Optional single button**: `sm:flex-shrink-0`\n   - Prevents button from shrinking on desktop\n\n---\n\n## üìÑ Updated Pages\n\nAll major pages have been updated with the responsive header pattern:\n\n### ‚úÖ Orders Page\n**Location**: `client/src/pages/orders.tsx`  \n**Buttons**: Export CSV, Import CSV, Sync Shopify\n\n```tsx\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n  <div>\n    <h1 className=\"text-3xl font-bold tracking-tight text-orders\">Orders</h1>\n    <p className=\"text-foreground/80\">View and manage customer orders from Shopify</p>\n  </div>\n  <div className=\"flex items-center gap-2 flex-wrap\">\n    <Button variant=\"outline\">Export CSV</Button>\n    <Button variant=\"outline\">Import CSV</Button>\n    <Button>Sync Shopify</Button>\n  </div>\n</div>\n```\n\n---\n\n### ‚úÖ Repairs Page\n**Location**: `client/src/pages/repairs.tsx`  \n**Buttons**: Nieuwe Reparatie (New Repair)\n\n```tsx\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n  <div>\n    <h1 className=\"text-3xl font-bold tracking-tight text-repairs\">Reparaties</h1>\n    <p className=\"text-foreground/80\">Beheer reparatieverzoeken en volg de voortgang</p>\n  </div>\n  <Button className=\"sm:flex-shrink-0\">\n    <Plus className=\"mr-2 h-4 w-4\" />\n    Nieuwe Reparatie\n  </Button>\n</div>\n```\n\n---\n\n### ‚úÖ Cases Page\n**Location**: `client/src/pages/cases.tsx`  \n**Buttons**: New Case\n\n```tsx\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n  <div>\n    <h1 className=\"text-3xl font-bold tracking-tight text-cases\">Cases</h1>\n    <p className=\"text-foreground/80\">Manage customer cases and track progress</p>\n  </div>\n  <Dialog open={showNewCase} onOpenChange={setShowNewCase}>\n    <DialogTrigger asChild>\n      <Button className=\"sm:flex-shrink-0\">\n        <Plus className=\"mr-2 h-4 w-4\" />\n        New Case\n      </Button>\n    </DialogTrigger>\n  </Dialog>\n</div>\n```\n\n---\n\n### ‚úÖ Todos Page\n**Location**: `client/src/pages/todos.tsx`  \n**Buttons**: Toggle View Mode, New Todo\n\n```tsx\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n  <div>\n    <h1 className=\"text-3xl font-bold tracking-tight\">To-do's</h1>\n    <p className=\"text-muted-foreground\">Manage personal and team tasks</p>\n  </div>\n  <div className=\"flex items-center gap-2 flex-wrap\">\n    <Button variant=\"outline\">Toggle View</Button>\n    <Button>New Todo</Button>\n  </div>\n</div>\n```\n\n---\n\n### ‚úÖ Dashboard Page\n**Location**: `client/src/pages/dashboard.tsx`  \n**Buttons**: Filters, Last 30 days, Export Report\n\n```tsx\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n  <div>\n    <h1 className=\"text-3xl font-bold tracking-tight\">Dashboard</h1>\n    <p className=\"text-muted-foreground\">Analytics and team performance insights</p>\n  </div>\n  <div className=\"flex items-center gap-2 flex-wrap\">\n    <Button variant=\"outline\">Filters</Button>\n    <Button variant=\"outline\">Last 30 days</Button>\n    <Button>Export Report</Button>\n  </div>\n</div>\n```\n\n---\n\n### ‚úÖ Purchase Orders Page\n**Location**: `client/src/pages/purchase-orders.tsx`  \n**Buttons**: Supplier Import, Nieuwe Order\n\n```tsx\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n  <div>\n    <h1 className=\"text-3xl font-bold flex items-center gap-2\">\n      <Package2 className=\"h-8 w-8\" />\n      Inkoop Orders\n    </h1>\n    <p className=\"text-sm text-muted-foreground mt-1\">\n      Beheer inkoop orders en leveranciers\n    </p>\n  </div>\n  <div className=\"flex gap-2 flex-wrap\">\n    <SupplierImportDialog />\n    <Button>Nieuwe Order</Button>\n  </div>\n</div>\n```\n\n---\n\n### ‚úÖ PageHeader Component\n**Location**: `client/src/components/shared/page-header.tsx`\n\nThe shared PageHeader component was also updated to include `flex-wrap` on the actions container:\n\n```tsx\n<div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n  <div>\n    <h1 className=\"text-3xl md:text-4xl font-semibold tracking-tight\">\n      {title}\n    </h1>\n    {subtitle && <p className=\"mt-1 text-sm text-muted-foreground\">{subtitle}</p>}\n  </div>\n  \n  {actions && (\n    <div className=\"flex items-center gap-2 flex-wrap flex-shrink-0\">\n      {actions}\n    </div>\n  )}\n</div>\n```\n\n---\n\n## üéØ Tailwind Breakpoints\n\nThe responsive design uses Tailwind's default breakpoint system:\n\n| Breakpoint | Width | Layout |\n|------------|-------|--------|\n| default    | < 640px | **Vertical stack** - Title on top, buttons below |\n| `sm:`      | ‚â• 640px | **Horizontal** - Title left, buttons right |\n| `md:`      | ‚â• 768px | (Optional) Larger text sizes |\n| `lg:`      | ‚â• 1024px | (Optional) More spacing |\n\n---\n\n## üì± Mobile-First Approach\n\nThe implementation follows a **mobile-first** methodology:\n\n1. **Base styles** (no prefix) = Mobile layout\n   - `flex-col` - Stack vertically\n   - `gap-4` - Spacing for both directions\n\n2. **Desktop styles** (`sm:` prefix) = Tablet/Desktop layout\n   - `sm:flex-row` - Horizontal layout\n   - `sm:items-center` - Vertical alignment\n   - `sm:justify-between` - Space between\n\n3. **Graceful enhancement**\n   - Mobile users get a clean vertical layout\n   - Desktop users get an optimized horizontal layout\n   - No JavaScript needed - pure CSS\n\n---\n\n## ‚úÖ Testing Checklist\n\n### Mobile (< 640px)\n- [x] Title and subtitle display on top\n- [x] Buttons display below title\n- [x] Buttons wrap to next line if needed\n- [x] All buttons are fully visible\n- [x] No horizontal overflow\n- [x] Touch targets are adequate (buttons not too small)\n\n### Tablet/Desktop (‚â• 640px)\n- [x] Title on left side\n- [x] Buttons on right side\n- [x] Horizontal alignment looks good\n- [x] Buttons wrap if many in a row\n- [x] Spacing is consistent\n\n### All Breakpoints\n- [x] Text is readable\n- [x] Layout doesn't break\n- [x] Buttons are clickable\n- [x] No content overflow\n\n---\n\n## üé® Design Consistency\n\n### Spacing\n- **Container gap**: `gap-4` (1rem / 16px) between title and buttons\n- **Button gap**: `gap-2` (0.5rem / 8px) between individual buttons\n- **Vertical rhythm**: Consistent spacing maintained in both layouts\n\n### Typography\n- **Title**: `text-3xl font-bold` - Large, prominent\n- **Subtitle**: `text-foreground/80` or `text-muted-foreground` - Subtle, secondary\n\n### Colors\n- **Title colors**: Page-specific (e.g., `text-orders`, `text-repairs`, `text-cases`)\n- **Subtitle**: Muted for hierarchy\n- **Buttons**: Primary (orange), Outline, or Variant styles\n\n---\n\n## üîÑ Future Maintenance\n\nWhen creating new pages with headers:\n\n1. **Copy the pattern** from any existing page\n2. **Use the PageHeader component** if possible for consistency\n3. **Test on mobile** before considering it complete\n4. **Check button overflow** if adding many action buttons\n\n### Example New Page\n\n```tsx\nexport default function NewPage() {\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        {/* Responsive Header */}\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6\">\n          <div>\n            <h1 className=\"text-3xl font-bold tracking-tight\">Page Title</h1>\n            <p className=\"text-muted-foreground\">Page description</p>\n          </div>\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <Button variant=\"outline\">Action 1</Button>\n            <Button>Primary Action</Button>\n          </div>\n        </div>\n        \n        {/* Page Content */}\n      </main>\n    </div>\n  );\n}\n```\n\n---\n\n## üìä Before & After\n\n### Mobile View - Before\n‚ùå Buttons cut off  \n‚ùå Horizontal scroll  \n‚ùå Poor UX on small screens  \n‚ùå Content inaccessible  \n\n### Mobile View - After\n‚úÖ All content visible  \n‚úÖ No horizontal scroll  \n‚úÖ Clean vertical layout  \n‚úÖ Easy to tap buttons  \n‚úÖ Professional appearance  \n\n### Desktop View\n‚úÖ Maintained original horizontal layout  \n‚úÖ Efficient use of space  \n‚úÖ Visual hierarchy preserved  \n‚úÖ No regressions  \n\n---\n\n## üöÄ Key Takeaways\n\n1. **Always test on mobile** - Don't assume layouts will work on small screens\n2. **Use flex-col sm:flex-row** - This pattern works for most responsive header scenarios\n3. **Add flex-wrap** - Prevents button overflow when multiple actions exist\n4. **Use gap instead of space-x** - Works better with flex-wrap\n5. **Mobile-first approach** - Start with mobile layout, enhance for desktop\n\n---\n\n**Result**: All page headers now work perfectly on mobile devices with no content overflow. Buttons are fully visible and accessible on all screen sizes.\n","size_bytes":11509},"MODAL_REFINEMENTS.md":{"content":"# Modal, Popup & Drawer Refinements\n\n**Implementation Guide for DutchThrift Hub - November 2025**\n\n---\n\n## üìã Overview\n\nAll modals, dialogs, sheets (drawers), popovers, and alert dialogs now have refined backgrounds that differ between light and dark modes:\n\n- **Light Mode**: Solid white background with subtle elevation\n- **Dark Mode**: Glassmorphism effect with blur and transparency\n\nThis creates a clean, professional look in light mode while maintaining the elegant glass effect in dark mode.\n\n---\n\n## üé® Visual Description\n\n### Light Mode\n- **Background**: Pure white (`#FFFFFF`)\n- **Border**: Subtle gray border (`border-border`)\n- **Shadow**: Soft elevation shadow `0 8px 32px rgba(0,0,0,0.08)`\n- **Effect**: Solid, crisp, no transparency or blur\n- **Contrast**: Full contrast for text and form elements\n- **Overlay**: Semi-transparent dark overlay `bg-black/40`\n\n### Dark Mode\n- **Background**: Translucent dark `rgba(30,30,30,0.9)`\n- **Border**: Subtle glow `border-border/50`\n- **Blur**: Backdrop blur of 12px for glassmorphism\n- **Shadow**: Deep shadow for elevation\n- **Effect**: Glass-like with content visible behind\n- **Overlay**: Darker overlay `bg-black/60`\n\n---\n\n## üîß Updated Components\n\n### 1. Dialog (Modal)\n\n**Light Mode:**\n```css\nbackground: #FFFFFF;\nborder: 1px solid hsl(var(--border));\nbox-shadow: 0 8px 32px rgba(0,0,0,0.08);\n```\n\n**Dark Mode:**\n```css\nbackground: rgba(30,30,30,0.9);\nbackdrop-filter: blur(12px);\nborder: 1px solid hsl(var(--border) / 0.5);\nbox-shadow: /* deeper shadow */\n```\n\n**Implementation:**\n```tsx\n// client/src/components/ui/dialog.tsx\nclassName={cn(\n  \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border p-6 duration-300 sm:rounded-xl\",\n  \"bg-white border-border shadow-[0_8px_32px_rgba(0,0,0,0.08)]\",\n  \"dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-modal\",\n  className\n)}\n```\n\n---\n\n### 2. Sheet (Drawer)\n\nSheets slide in from the side (mobile menu, filters, etc.) with the same background logic.\n\n**Light Mode**: Solid white panel  \n**Dark Mode**: Translucent glass panel\n\n**Implementation:**\n```tsx\n// client/src/components/ui/sheet.tsx\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 border p-6 transition ease-in-out bg-white border-border shadow-[0_8px_32px_rgba(0,0,0,0.08)] dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-2xl\",\n  {\n    variants: {\n      side: {\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r...\",\n        right: \"inset-y-0 right-0 h-full w-3/4 border-l...\",\n        // ... other sides\n      },\n    },\n  }\n)\n```\n\n---\n\n### 3. Popover (Dropdowns)\n\nSmall popovers for menus, tooltips, and dropdowns.\n\n**Light Mode:**\n```css\nbackground: #FFFFFF;\nbox-shadow: 0 4px 16px rgba(0,0,0,0.08);\n```\n\n**Dark Mode:**\n```css\nbackground: rgba(30,30,30,0.9);\nbackdrop-filter: blur(12px);\n```\n\n**Implementation:**\n```tsx\n// client/src/components/ui/popover.tsx\nclassName={cn(\n  \"z-50 w-72 rounded-lg border p-4 outline-none\",\n  \"bg-white border-border shadow-[0_4px_16px_rgba(0,0,0,0.08)]\",\n  \"dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-lg\",\n  className\n)}\n```\n\n---\n\n### 4. Alert Dialog (Confirmation)\n\nCritical action confirmations (delete, etc.).\n\n**Same treatment as regular Dialog:**\n- Solid white in light mode\n- Glassmorphism in dark mode\n\n**Implementation:**\n```tsx\n// client/src/components/ui/alert-dialog.tsx\nclassName={cn(\n  \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border p-6 duration-200 sm:rounded-lg\",\n  \"bg-white border-border shadow-[0_8px_32px_rgba(0,0,0,0.08)]\",\n  \"dark:bg-[rgba(30,30,30,0.9)] dark:backdrop-blur-xl dark:border-border/50 dark:shadow-lg\",\n  className\n)}\n```\n\n---\n\n## üì± Mobile Behavior\n\n### Full-Screen Modals\nOn mobile (<640px), dialogs can become full-screen:\n\n```tsx\n<DialogContent className=\"sm:max-w-lg max-w-full h-screen sm:h-auto sm:rounded-xl rounded-none\">\n  {/* Content */}\n</DialogContent>\n```\n\n**Styling remains the same:**\n- Light mode: Solid white background\n- Dark mode: Glassmorphism effect\n\n### Bottom Drawer (Sheet)\nMobile sheets slide from bottom:\n\n```tsx\n<Sheet>\n  <SheetContent side=\"bottom\" className=\"h-[80vh]\">\n    {/* Content */}\n  </SheetContent>\n</Sheet>\n```\n\n---\n\n## üéØ Usage Examples\n\n### Standard Dialog\n```tsx\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from \"@/components/ui/dialog\";\n\nexport function ExampleModal() {\n  return (\n    <Dialog>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Create New Order</DialogTitle>\n          <DialogDescription>\n            Fill in the details below\n          </DialogDescription>\n        </DialogHeader>\n        {/* Form content */}\n      </DialogContent>\n    </Dialog>\n  );\n}\n```\n\n**Light Mode Result:**\n- Clean white modal with subtle shadow\n- Full contrast for all text and inputs\n- Professional, crisp appearance\n\n**Dark Mode Result:**\n- Elegant glass effect\n- Content slightly visible behind\n- Maintains readability with high contrast text\n\n---\n\n### Mobile Sheet (Drawer)\n```tsx\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\";\n\nexport function MobileFilterSheet() {\n  return (\n    <Sheet>\n      <SheetContent side=\"bottom\" className=\"h-[80vh]\">\n        <SheetHeader>\n          <SheetTitle>Filter Options</SheetTitle>\n        </SheetHeader>\n        {/* Filter controls */}\n      </SheetContent>\n    </Sheet>\n  );\n}\n```\n\n**Light Mode Result:**\n- Solid white panel sliding from bottom\n- Clear separation from main content\n- Clean, uncluttered appearance\n\n**Dark Mode Result:**\n- Translucent dark panel\n- Blurred background visible\n- Elegant, modern feel\n\n---\n\n### Dropdown Popover\n```tsx\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\n\nexport function UserMenu() {\n  return (\n    <Popover>\n      <PopoverTrigger>Menu</PopoverTrigger>\n      <PopoverContent>\n        {/* Menu items */}\n      </PopoverContent>\n    </Popover>\n  );\n}\n```\n\n**Light Mode Result:**\n- Crisp white dropdown\n- Subtle shadow for depth\n- Clear menu hierarchy\n\n**Dark Mode Result:**\n- Glass-like dropdown\n- Blurred background\n- Elegant transparency\n\n---\n\n## üîç Tailwind Configuration\n\nThe implementation uses Tailwind's `dark:` variant extensively:\n\n```tsx\n// Light mode classes\n\"bg-white\"\n\"border-border\"\n\"shadow-[0_8px_32px_rgba(0,0,0,0.08)]\"\n\n// Dark mode classes (applied automatically when dark mode is active)\n\"dark:bg-[rgba(30,30,30,0.9)]\"\n\"dark:backdrop-blur-xl\"\n\"dark:border-border/50\"\n\"dark:shadow-modal\"\n```\n\n**How it works:**\n1. Default classes apply in light mode\n2. Classes prefixed with `dark:` apply when HTML has `class=\"dark\"`\n3. Theme switching handled by `useTheme` hook\n4. No JavaScript conditionals needed in components\n\n---\n\n## ‚úÖ Checklist\n\n### Updated Components\n- [x] Dialog - solid white (light) / glass (dark)\n- [x] Sheet - solid white (light) / glass (dark)\n- [x] Popover - solid white (light) / glass (dark)\n- [x] AlertDialog - solid white (light) / glass (dark)\n\n### Visual Verification\n- [x] Light mode: no transparency, solid white\n- [x] Dark mode: glassmorphism with blur\n- [x] Overlays: lighter in light mode, darker in dark mode\n- [x] Borders: consistent in both modes\n- [x] Shadows: appropriate depth for each mode\n- [x] Mobile: same logic on small screens\n\n### Accessibility\n- [x] Full text contrast in both modes\n- [x] Form inputs readable in both modes\n- [x] Borders visible in both modes\n- [x] Focus states work correctly\n\n---\n\n## üé® Design Rationale\n\n### Why Solid White in Light Mode?\n1. **Clarity**: No visual noise from background showing through\n2. **Professionalism**: Clean, crisp appearance\n3. **Readability**: Maximum contrast for text and forms\n4. **Focus**: User attention on modal content only\n\n### Why Keep Glassmorphism in Dark Mode?\n1. **Elegance**: Modern, premium feel\n2. **Context**: User can see what's behind the modal\n3. **Depth**: Creates visual hierarchy\n4. **Consistency**: Matches the overall dark mode aesthetic\n\n---\n\n## üìä Before & After\n\n### Light Mode - Before\n‚ùå Semi-transparent gray background  \n‚ùå Messy with content showing through  \n‚ùå Low contrast, hard to focus  \n\n### Light Mode - After\n‚úÖ Solid white background  \n‚úÖ Clean, uncluttered appearance  \n‚úÖ High contrast, easy to read  \n‚úÖ Professional look  \n\n### Dark Mode - Before & After\n‚úÖ Glassmorphism kept as-is  \n‚úÖ Elegant blur effect maintained  \n‚úÖ Perfect as it was  \n\n---\n\n## üöÄ Key Takeaways\n\n1. **Conditional Styling**: Use Tailwind's `dark:` variant for theme-specific styling\n2. **No Transparency in Light**: Solid backgrounds prevent visual clutter\n3. **Glass Effect in Dark**: Maintains the premium, modern aesthetic\n4. **Consistent Approach**: All modal-like components follow the same pattern\n5. **Mobile-Friendly**: Same logic applies to full-screen and bottom drawer variants\n\n---\n\n**Result**: Clean, professional modals in light mode with elegant glassmorphism preserved in dark mode.\n","size_bytes":9095},"client/src/components/shared/page-header.tsx":{"content":"import { ReactNode } from \"react\";\nimport { ChevronRight } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\n\ninterface Breadcrumb {\n  label: string;\n  href?: string;\n}\n\ninterface PageHeaderProps {\n  title: string;\n  subtitle?: string;\n  breadcrumbs?: Breadcrumb[];\n  actions?: ReactNode;\n  className?: string;\n}\n\nexport function PageHeader({ title, subtitle, breadcrumbs, actions, className }: PageHeaderProps) {\n  return (\n    <div className={cn(\"mb-6\", className)} data-testid=\"page-header\">\n      {/* Breadcrumbs */}\n      {breadcrumbs && breadcrumbs.length > 0 && (\n        <nav className=\"flex items-center space-x-1 text-sm text-muted-foreground mb-2\" data-testid=\"breadcrumbs\">\n          {breadcrumbs.map((crumb, index) => (\n            <div key={index} className=\"flex items-center\">\n              {index > 0 && <ChevronRight className=\"h-4 w-4 mx-1\" />}\n              {crumb.href ? (\n                <Link href={crumb.href} className=\"hover:text-foreground transition-colors\">\n                  {crumb.label}\n                </Link>\n              ) : (\n                <span className=\"text-foreground font-medium\">{crumb.label}</span>\n              )}\n            </div>\n          ))}\n        </nav>\n      )}\n\n      {/* Title and Actions Row */}\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n        <div>\n          <h1 className=\"text-3xl md:text-4xl font-semibold tracking-tight text-foreground\" data-testid=\"page-title\">\n            {title}\n          </h1>\n          {subtitle && (\n            <p className=\"mt-1 text-sm text-muted-foreground\" data-testid=\"page-subtitle\">\n              {subtitle}\n            </p>\n          )}\n        </div>\n        \n        {actions && (\n          <div className=\"flex items-center gap-2 flex-wrap flex-shrink-0\" data-testid=\"page-actions\">\n            {actions}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":1953},"DESIGN_SYSTEM.md":{"content":"# DutchThrift Hub Design System\n\n**Modern, Elegant SaaS Design inspired by Linear, Framer, Notion & Vercel**\n\n---\n\n## üé® Design Philosophy\n\nOur design system centers around **orange (#FF6600)** as a confident, energetic brand accent‚Äînot a dominant color. The interface balances warmth with professionalism, creating a refined, high-end experience that feels both modern and approachable.\n\n### Core Principles\n\n- **Orange as Accent**: Used strategically for CTAs, links, icons, and hover states\n- **Warm Neutrals**: Light mode uses soft warm whites and beiges; dark mode uses deep, sophisticated grays\n- **Glassmorphism**: Subtle blur effects on modals, popovers, and overlays\n- **Smooth Motion**: Fade, scale, and slide animations create a polished, intentional feel\n- **Depth & Light**: Layered shadows and hover states convey hierarchy and interactivity\n\n---\n\n## üåà Color Palette\n\n### Light Mode\n\n#### Foundation\n```css\nBackground:     hsl(30 20% 98%)    /* Soft warm white with beige undertone */\nForeground:     hsl(24 8% 12%)     /* Deep warm charcoal */\nCard:           hsl(0 0% 100%)     /* Pure white cards */\nBorder:         hsl(24 12% 90%)    /* Warm light gray */\n```\n\n#### Primary (Brand Orange)\n```css\nPrimary:        hsl(24 100% 50%)   /* #FF6600 - Your vibrant orange */\nPrimary Hover:  hsl(24 100% 45%)   /* Darker on hover */\n```\n\n#### Secondary & Muted\n```css\nSecondary:      hsl(24 15% 94%)    /* Warm off-white */\nMuted:          hsl(24 10% 96%)    /* Very light warm gray */\nMuted Fg:       hsl(24 6% 45%)     /* Medium gray text */\n```\n\n#### Status Colors\n```css\nDestructive:    hsl(0 72% 51%)     /* Confident red */\nSuccess:        hsl(142 71% 45%)   /* Fresh green */\nWarning:        hsl(38 92% 50%)    /* Warm amber */\nInfo:           hsl(199 89% 48%)   /* Clear blue */\n```\n\n### Dark Mode\n\n#### Foundation\n```css\nBackground:     hsl(0 0% 6%)       /* Deep neutral gray (not blue-black) */\nForeground:     hsl(0 0% 96%)      /* Off-white text */\nCard:           hsl(0 0% 10%)      /* Elevated dark card */\nBorder:         hsl(0 0% 18%)      /* Subtle border */\n```\n\n#### Primary (Brand Orange)\n```css\nPrimary:        hsl(24 100% 55%)   /* Slightly brighter for dark mode */\nPrimary Hover:  hsl(24 100% 60%)   /* Even brighter on hover */\n```\n\n#### Secondary & Muted\n```css\nSecondary:      hsl(0 0% 14%)      /* Elevated surface */\nMuted:          hsl(0 0% 14%)      /* Same as secondary */\nMuted Fg:       hsl(0 0% 60%)      /* Medium-light gray text */\n```\n\n#### Status Colors (Brighter for Contrast)\n```css\nDestructive:    hsl(0 72% 60%)     /* Vibrant red */\nSuccess:        hsl(142 71% 50%)   /* Bright green */\nWarning:        hsl(38 92% 55%)    /* Warm amber */\nInfo:           hsl(199 89% 55%)   /* Bright blue */\n```\n\n---\n\n## üéØ Color Usage Guidelines\n\n### When to Use Orange\n\n‚úÖ **DO Use Orange For:**\n- Primary action buttons (Submit, Save, Create)\n- Active navigation items\n- Important links and CTAs\n- Icon accents on hover\n- Focus rings and active states\n- Progress indicators\n- Important badges\n\n‚ùå **DON'T Use Orange For:**\n- Large background areas\n- Body text\n- Disabled states\n- Decorative elements only\n- Every interactive element\n\n### Contrast & Accessibility\n\nAll color combinations meet **WCAG AA** standards:\n- Primary on white: 4.5:1 ratio ‚úì\n- Foreground on background: 12:1 ratio ‚úì\n- Muted text on background: 4.8:1 ratio ‚úì\n\n---\n\n## üß© Component Patterns\n\n### Buttons\n\n```tsx\n// Primary Orange Button (default)\n<Button>Save Changes</Button>\n\n// Outline Button (subtle)\n<Button variant=\"outline\">Cancel</Button>\n\n// Ghost Button (minimal)\n<Button variant=\"ghost\">Learn More</Button>\n\n// Destructive Button\n<Button variant=\"destructive\">Delete</Button>\n```\n\n**Visual Behavior:**\n- Hover: Slight scale (1.02x) + shadow glow\n- Active: Scale down (0.98x)\n- Duration: 300ms smooth transition\n\n### Cards\n\n```tsx\n<Card className=\"card-interactive\">\n  <CardHeader>\n    <CardTitle>Dashboard Stats</CardTitle>\n    <CardDescription>Your performance this week</CardDescription>\n  </CardHeader>\n  <CardContent>\n    {/* Content */}\n  </CardContent>\n</Card>\n```\n\n**Visual Behavior:**\n- Default: Soft shadow (shadow-card)\n- Hover: Elevated shadow + subtle translate-y(-1px)\n- Border: Subtle warm gray, highlights orange on hover\n\n### Modals & Dialogs (Glassmorphism)\n\n```tsx\n<Dialog>\n  <DialogContent>\n    <DialogHeader>\n      <DialogTitle>Create New Order</DialogTitle>\n      <DialogDescription>\n        Enter order details below\n      </DialogDescription>\n    </DialogHeader>\n    {/* Form content */}\n  </DialogContent>\n</Dialog>\n```\n\n**Visual Effects:**\n- Background: Semi-transparent with backdrop-blur (20px)\n- Overlay: Black/60 with subtle blur\n- Animation: Fade + scale + slide (300ms)\n- Shadow: Deep layered shadow (shadow-modal)\n\n### Inputs\n\n```tsx\n<Input \n  placeholder=\"Search orders...\" \n  className=\"input-focus-ring\"\n/>\n```\n\n**Visual Behavior:**\n- Default: Subtle border\n- Focus: Orange ring (2px at 20% opacity) + orange border\n- Transition: 200ms smooth\n\n### Badges\n\n```tsx\n<Badge variant=\"success\">Active</Badge>\n<Badge variant=\"warning\">Pending</Badge>\n<Badge variant=\"destructive\">Failed</Badge>\n<Badge>Orange Default</Badge>\n```\n\n**Design:** Rounded, semi-transparent backgrounds with matching border\n\n---\n\n## ‚ú® Animation System\n\n### Predefined Animations\n\n```css\n.animate-fade-in          /* Fade opacity 0 ‚Üí 1 (300ms) */\n.animate-fade-in-up       /* Fade + slide up 10px (400ms) */\n.animate-fade-in-down     /* Fade + slide down 10px (400ms) */\n.animate-scale-in         /* Fade + scale 0.95 ‚Üí 1 (300ms cubic-bezier) */\n.animate-slide-in-right   /* Fade + slide from left (300ms) */\n```\n\n### Usage Example\n\n```tsx\n<div className=\"animate-fade-in-up\">\n  <h1>Welcome to DutchThrift Hub</h1>\n</div>\n```\n\n### Transition Utilities\n\n```css\n.transition-smooth   /* 300ms cubic-bezier(0.4, 0, 0.2, 1) */\n.transition-bounce   /* 400ms cubic-bezier(0.68, -0.55, 0.265, 1.55) */\n```\n\n---\n\n## üå´Ô∏è Glassmorphism Effects\n\n### Available Classes\n\n```css\n.glass               /* Standard glass: bg + 20px blur + border */\n.glass-subtle        /* Light glass: bg + 12px blur (no border) */\n.glass-strong        /* Heavy glass: bg + 40px blur + border */\n.card-glass          /* Card with glass effect */\n```\n\n### Usage Example\n\n```tsx\n<div className=\"glass rounded-xl p-6\">\n  <h2>Floating Panel</h2>\n  <p>Content with glassmorphism effect</p>\n</div>\n```\n\n**When to Use:**\n- Overlays (modals, popovers, sheets)\n- Floating action panels\n- Sidebar backgrounds\n- Notification toasts\n\n---\n\n## üé≠ Shadow System\n\n### Shadow Scale\n\n```css\nshadow-sm       /* Subtle shadow for small elements */\nshadow-md       /* Default card shadow */\nshadow-lg       /* Elevated cards on hover */\nshadow-xl       /* Popovers and dropdowns */\nshadow-2xl      /* Modals and sheets */\nshadow-primary  /* Orange glow for primary elements */\n```\n\n### Component-Specific\n\n```css\n.shadow-card         /* Default card shadow */\n.shadow-card-hover   /* Card on hover */\n.shadow-modal        /* Dialog/modal shadow */\n.shadow-primary      /* Orange glow effect */\n```\n\n---\n\n## üìê Typography\n\n### Font Family\n```css\n--font-sans: 'Inter', ui-sans-serif, system-ui...\n```\n\n**Inter** is used throughout for its modern, readable, and professional aesthetic.\n\n### Heading Scale\n\n```tsx\n<h1 className=\"text-4xl md:text-5xl font-semibold tracking-tight\">\n  Main Title\n</h1>\n\n<h2 className=\"text-3xl md:text-4xl font-semibold tracking-tight\">\n  Section Title\n</h2>\n\n<h3 className=\"text-2xl md:text-3xl font-semibold tracking-tight\">\n  Subsection\n</h3>\n```\n\n### Body Text\n- Default: 14px (0.875rem)\n- Tracking: -0.011em (subtle tightening)\n- Line height: 1.5 (comfortable reading)\n\n---\n\n## üè∑Ô∏è Section-Specific Colors\n\nFor module differentiation, we use color-coded sections:\n\n```css\n/* Inbox - Blue */\n--inbox-primary: 199 89% 48%\nbg-gradient-inbox    /* Blue gradient */\ntext-inbox           /* Blue text */\n\n/* Orders - Purple */\n--orders-primary: 261 51% 51%\nbg-gradient-orders   /* Purple gradient */\ntext-orders          /* Purple text */\n\n/* Repairs - Orange (aligns with brand) */\n--repairs-primary: 24 100% 50%\nbg-gradient-repairs  /* Orange gradient */\ntext-repairs         /* Orange text */\n\n/* Cases - Green */\n--cases-primary: 142 71% 45%\nbg-gradient-cases    /* Green gradient */\ntext-cases           /* Green text */\n```\n\n**Usage:**\n```tsx\n<div className=\"bg-repairs rounded-lg p-4\">\n  <h3 className=\"text-repairs\">Repair Status</h3>\n</div>\n```\n\n---\n\n## üì± Responsive Behavior\n\n### Breakpoints (Tailwind Default)\n```\nsm:  640px   (tablets)\nmd:  768px   (small laptops)\nlg:  1024px  (desktops)\nxl:  1280px  (large desktops)\n```\n\n### Mobile-First Approach\n```tsx\n<h1 className=\"text-3xl md:text-5xl\">\n  Responsive Heading\n</h1>\n\n<Button className=\"w-full md:w-auto\">\n  Full-width on mobile, auto on desktop\n</Button>\n```\n\n---\n\n## üß∞ Utility Classes\n\n### Hover Effects\n\n```css\n.hover-glow          /* Adds shadow-primary on hover */\n.card-interactive    /* Card with hover animation */\n.table-row-hover     /* Table row hover state */\n```\n\n### Gradients\n\n```css\n.bg-gradient-primary   /* Orange ‚Üí warm orange */\n.btn-gradient          /* Gradient button with glow */\n```\n\n### Custom Scrollbars\n\n```css\n.scrollbar-thin   /* Slim scrollbar with orange tint */\n.scrollbar-hide   /* Completely hidden scrollbar */\n```\n\n---\n\n## üé® Example Usage in Real Components\n\n### Dashboard KPI Card\n\n```tsx\n<Card className=\"card-interactive\">\n  <CardHeader className=\"pb-2\">\n    <CardTitle className=\"text-sm font-medium text-muted-foreground\">\n      Total Revenue\n    </CardTitle>\n  </CardHeader>\n  <CardContent>\n    <div className=\"text-3xl font-bold\">$45,231</div>\n    <p className=\"text-xs text-success\">\n      +20.1% from last month\n    </p>\n  </CardContent>\n</Card>\n```\n\n### Action Button with Icon\n\n```tsx\n<Button className=\"gap-2\">\n  <Plus className=\"h-4 w-4\" />\n  Create Order\n</Button>\n```\n\n### Status Badge\n\n```tsx\n<Badge variant=\"success\">\n  <CheckCircle className=\"h-3 w-3 mr-1\" />\n  Completed\n</Badge>\n```\n\n### Glassmorphic Panel\n\n```tsx\n<div className=\"glass-strong rounded-xl p-6 animate-scale-in\">\n  <h3 className=\"font-semibold text-lg mb-2\">Quick Actions</h3>\n  <div className=\"space-y-2\">\n    <Button variant=\"outline\" className=\"w-full\">\n      New Invoice\n    </Button>\n    <Button variant=\"outline\" className=\"w-full\">\n      New Customer\n    </Button>\n  </div>\n</div>\n```\n\n---\n\n## üöÄ Design Rationale\n\n### Why Orange?\n- **Energy & Warmth**: Orange conveys approachability and dynamism\n- **Differentiation**: Stands out from typical blue/teal SaaS products\n- **Brand Identity**: Memorable and confident\n\n### Why Warm Neutrals in Light Mode?\n- **Eye Comfort**: Softer than stark white, reduces eye strain\n- **Premium Feel**: Warm tones feel more handcrafted and high-end\n- **Brand Cohesion**: Complements orange accent naturally\n\n### Why Deep Grays in Dark Mode?\n- **Not Pure Black**: Reduces harsh contrast, easier on eyes\n- **No Cold Blues**: Maintains warmth even in dark mode\n- **Depth & Hierarchy**: Subtle gray variations create visual layers\n\n### Why Glassmorphism?\n- **Modern Aesthetic**: Aligns with Linear/Notion/Framer trends\n- **Visual Hierarchy**: Clearly separates modal content from background\n- **Depth Perception**: Blur creates sense of floating layers\n\n### Why Smooth Animations?\n- **Polish & Quality**: Motion design signals attention to detail\n- **User Feedback**: Confirms interactions (button presses, modal opens)\n- **Reduced Jarring**: Gradual transitions feel more natural\n\n---\n\n## üéì Best Practices\n\n### DO ‚úÖ\n- Use orange for primary CTAs and important actions\n- Maintain consistent spacing (8px grid system)\n- Apply glassmorphism to overlays and modals\n- Use hover states on all interactive elements\n- Leverage shadow system for depth\n- Keep animations subtle and purposeful\n\n### DON'T ‚ùå\n- Overuse orange‚Äîit should accent, not dominate\n- Mix warm and cool grays (stick to neutral grays in dark mode)\n- Skip hover/focus states on interactive elements\n- Use pure black (#000000) in dark mode\n- Add animations without purpose\n- Ignore accessibility contrast ratios\n\n---\n\n## üìä Color Contrast Reference\n\n| Combination                | Ratio  | WCAG AA | WCAG AAA |\n|---------------------------|--------|---------|----------|\n| Primary on White          | 4.5:1  | ‚úÖ      | ‚ùå       |\n| Primary on Background     | 4.8:1  | ‚úÖ      | ‚ùå       |\n| Foreground on Background  | 12:1   | ‚úÖ      | ‚úÖ       |\n| Muted on Background       | 4.8:1  | ‚úÖ      | ‚ùå       |\n| Success on White          | 4.2:1  | ‚úÖ      | ‚ùå       |\n| Destructive on White      | 4.9:1  | ‚úÖ      | ‚ùå       |\n\n---\n\n## üîß Customization\n\n### Adjusting Brand Color\n\nTo change the primary orange, update these variables in `index.css`:\n\n```css\n:root {\n  --primary: hsl(24 100% 50%);        /* Your new color in HSL */\n  --primary-hover: hsl(24 100% 45%);  /* Slightly darker */\n}\n\n.dark {\n  --primary: hsl(24 100% 55%);        /* Brighter for dark mode */\n  --primary-hover: hsl(24 100% 60%);\n}\n```\n\n### Adding New Colors\n\n```css\n:root {\n  --custom-color: hsl(180 50% 50%);\n}\n\n.dark {\n  --custom-color: hsl(180 50% 60%);\n}\n```\n\nThen extend in `tailwind.config.ts`:\n\n```ts\ncolors: {\n  custom: \"var(--custom-color)\",\n}\n```\n\n---\n\n## üìö Further Reading\n\n- [Linear Design System](https://linear.app/method)\n- [Radix UI Documentation](https://radix-ui.com)\n- [Tailwind CSS](https://tailwindcss.com)\n- [Inter Font Family](https://rsms.me/inter/)\n- [WCAG Contrast Guidelines](https://webaim.org/resources/contrastchecker/)\n\n---\n\n**Created:** November 2025  \n**Design System Version:** 1.0  \n**Framework:** React + Tailwind CSS + shadcn/ui\n","size_bytes":13709},"server/scripts/importAllEmails.ts":{"content":"import { ImapFlow } from 'imapflow';\nimport { storage } from '../storage';\nimport { ObjectStorageService } from '../objectStorage';\n\ninterface EmailAttachment {\n  uid: number;\n  seq: number;\n  partId: string;\n  filename: string;\n  contentType: string;\n  contentId?: string;\n  isInline: boolean;\n  size: number;\n}\n\ninterface ParsedEmail {\n  messageId: string;\n  from: string;\n  to: string[];\n  cc: string[];\n  subject: string;\n  date: Date;\n  bodyText: string;\n  bodyHtml: string;\n  attachments: EmailAttachment[];\n  inReplyTo?: string;\n  references: string[];\n  isRead: boolean;\n}\n\nexport async function importAllEmails() {\n  console.log('Starting email import from 2025-01-01...');\n  \n  const imapConfig = {\n    host: (process.env.IMAP_HOST || '').trim(),\n    port: parseInt(process.env.IMAP_PORT || '993'),\n    secure: true,\n    auth: {\n      user: (process.env.IMAP_USER || '').trim(),\n      pass: (process.env.IMAP_PASS || '').trim()\n    }\n  };\n\n  const client = new ImapFlow(imapConfig);\n  \n  client.on('error', (err) => {\n    console.error('IMAP client error:', err);\n  });\n\n  try {\n    console.log('Connecting to IMAP server...');\n    await client.connect();\n    \n    const lock = await client.getMailboxLock('INBOX');\n    \n    try {\n      // Search for all emails since January 1, 2025\n      const searchDate = new Date('2025-01-01');\n      console.log(`Searching for emails since ${searchDate.toISOString()}...`);\n      \n      const searchResult = await client.search({ since: searchDate });\n      const uids = Array.isArray(searchResult) ? searchResult : [];\n      \n      console.log(`Found ${uids.length} emails to import`);\n      \n      if (uids.length === 0) {\n        console.log('No emails found');\n        return { success: true, imported: 0 };\n      }\n\n      const emails: ParsedEmail[] = [];\n      const attachmentQueue: EmailAttachment[] = [];\n      let failedCount = 0;\n      \n      // Fetch emails in batches of 50\n      const batchSize = 50;\n      for (let i = 0; i < uids.length; i += batchSize) {\n        const batchUids = uids.slice(i, i + batchSize);\n        const batchNum = Math.floor(i / batchSize) + 1;\n        const totalBatches = Math.ceil(uids.length / batchSize);\n        const progress = Math.round((i / uids.length) * 100);\n        console.log(`\\nüì¶ Processing batch ${batchNum}/${totalBatches} (${progress}% complete, ${batchUids.length} emails in batch)`);\n        \n        for await (const message of client.fetch(batchUids, {\n          envelope: true,\n          flags: true,\n          bodyStructure: true,\n          uid: true,\n          source: false\n        })) {\n          try {\n            const envelope = message.envelope;\n            if (!envelope) continue;\n            \n            // Extract basic info\n            const messageId = envelope.messageId || `generated-${message.uid}@dutchthrift.com`;\n            const from = envelope.from?.[0]?.address || 'unknown@unknown.com';\n            const to = envelope.to?.map(addr => addr.address || '') || [];\n            const cc = envelope.cc?.map(addr => addr.address || '') || [];\n            const subject = envelope.subject || '(No Subject)';\n            const date = envelope.date || new Date();\n            const isRead = message.flags?.has('\\\\Seen') || false;\n            \n            // Extract threading info\n            const inReplyTo = envelope.inReplyTo;\n            const references: string[] = [];\n\n            // Find text parts in body structure\n            let bodyText = '';\n            let bodyHtml = '';\n            \n            const findTextParts = (part: any, partId = '1'): Array<{ partId: string; type: string; encoding: string }> => {\n              const parts: Array<{ partId: string; type: string; encoding: string }> = [];\n              \n              if (part.type === 'text/plain' || part.type === 'text/html') {\n                parts.push({\n                  partId,\n                  type: part.type,\n                  encoding: part.encoding || '7bit'\n                });\n              }\n              \n              if (part.childNodes && Array.isArray(part.childNodes)) {\n                part.childNodes.forEach((child: any, index: number) => {\n                  const childPartId = partId ? `${partId}.${index + 1}` : `${index + 1}`;\n                  parts.push(...findTextParts(child, childPartId));\n                });\n              }\n              \n              return parts;\n            };\n\n            const textParts = findTextParts(message.bodyStructure);\n            const htmlPart = textParts.find(p => p.type === 'text/html');\n            const plainPart = textParts.find(p => p.type === 'text/plain');\n            \n            // Download body content with timeout and retry logic\n            const downloadBodyPart = async (partId: string, encoding: string, maxRetries = 3): Promise<string> => {\n              for (let attempt = 1; attempt <= maxRetries; attempt++) {\n                try {\n                  const timeoutMs = 60000; // 60 second timeout for bulk import\n                  const timeoutPromise = new Promise<never>((_, reject) => {\n                    setTimeout(() => reject(new Error(`Download timeout after ${timeoutMs}ms`)), timeoutMs);\n                  });\n                  \n                  const downloadPromise = async () => {\n                    const { content: stream } = await client.download(message.uid, partId);\n                    const chunks: Buffer[] = [];\n                    for await (const chunk of stream) {\n                      chunks.push(chunk);\n                    }\n                    return Buffer.concat(chunks);\n                  };\n                  \n                  const contentBuffer = await Promise.race([downloadPromise(), timeoutPromise]);\n                  return decodeContent(contentBuffer, encoding);\n                } catch (error) {\n                  if (attempt === maxRetries) {\n                    console.error(`Failed to download part ${partId} for UID ${message.uid} after ${maxRetries} attempts:`, error);\n                    return '';\n                  }\n                  console.log(`Retry ${attempt}/${maxRetries} for part ${partId} UID ${message.uid}...`);\n                  await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second before retry\n                }\n              }\n              return '';\n            };\n\n            if (htmlPart) {\n              bodyHtml = await downloadBodyPart(htmlPart.partId, htmlPart.encoding);\n              if (!bodyHtml) failedCount++;\n            }\n            if (plainPart) {\n              bodyText = await downloadBodyPart(plainPart.partId, plainPart.encoding);\n              if (!bodyText && !bodyHtml) failedCount++;\n            }\n\n            // Find attachments\n            const findAttachments = (part: any, partId = '1'): EmailAttachment[] => {\n              const attachments: EmailAttachment[] = [];\n              \n              if (part.disposition === 'attachment' || part.disposition === 'inline') {\n                const filename = part.dispositionParameters?.filename || part.parameters?.name || 'unnamed';\n                const contentType = part.type || 'application/octet-stream';\n                const contentId = part.id;\n                const size = part.size || 0;\n                \n                attachments.push({\n                  uid: message.uid,\n                  seq: message.seq,\n                  partId,\n                  filename,\n                  contentType,\n                  contentId,\n                  isInline: part.disposition === 'inline',\n                  size\n                });\n              }\n              \n              if (part.childNodes && Array.isArray(part.childNodes)) {\n                part.childNodes.forEach((child: any, index: number) => {\n                  const childPartId = partId ? `${partId}.${index + 1}` : `${index + 1}`;\n                  attachments.push(...findAttachments(child, childPartId));\n                });\n              }\n              \n              return attachments;\n            };\n\n            const messageAttachments = findAttachments(message.bodyStructure);\n            attachmentQueue.push(...messageAttachments);\n\n            // Only add email if we got at least some body content\n            if (bodyHtml || bodyText) {\n              emails.push({\n                messageId,\n                from,\n                to,\n                cc,\n                subject,\n                date,\n                bodyText,\n                bodyHtml,\n                attachments: messageAttachments,\n                inReplyTo,\n                references,\n                isRead\n              });\n            } else {\n              console.warn(`‚ö†Ô∏è  Skipping email UID ${message.uid} - no body content downloaded`);\n              failedCount++;\n            }\n            \n            if (emails.length % 100 === 0) {\n              console.log(`‚úÖ Parsed ${emails.length}/${uids.length} emails (${failedCount} failed)...`);\n            }\n          } catch (error) {\n            console.error(`‚ùå Error parsing email UID ${message.uid}:`, error);\n            failedCount++;\n          }\n        }\n      }\n\n      console.log(`\\nüìä Import Summary:`);\n      console.log(`   ‚úÖ Successfully parsed: ${emails.length} emails`);\n      console.log(`   ‚ùå Failed to download: ${failedCount} emails`);\n      console.log(`   üìé Attachments found: ${attachmentQueue.length} (metadata only, not downloading)`);\n      console.log(`   üìà Success rate: ${Math.round((emails.length / uids.length) * 100)}%\\n`);\n\n      // Import into database (attachments will be downloaded on-demand when viewing emails)\n      console.log('üíæ Importing emails into database...');\n      const importStats = await importEmailsToDatabase(emails);\n      \n      console.log(`\\nüéâ Import complete!`);\n      console.log(`   üìß Total emails imported: ${importStats.importedMessages}`);\n      console.log(`   üßµ Conversation threads created: ${importStats.importedThreads}`);\n      console.log(`   ‚ùå Failed downloads: ${failedCount}`);\n      \n      return { \n        success: true, \n        imported: importStats.importedMessages,\n        threads: importStats.importedThreads,\n        failed: failedCount\n      };\n      \n    } finally {\n      lock.release();\n    }\n  } catch (error) {\n    console.error('Error during email import:', error);\n    throw error;\n  } finally {\n    await client.logout();\n  }\n}\n\nfunction decodeContent(buffer: Buffer, encoding: string): string {\n  try {\n    switch (encoding?.toLowerCase()) {\n      case 'base64':\n        return Buffer.from(buffer.toString(), 'base64').toString('utf-8');\n      case 'quoted-printable':\n        return buffer.toString('utf-8').replace(/=\\r?\\n/g, '').replace(/=([0-9A-F]{2})/g, (_, hex) => \n          String.fromCharCode(parseInt(hex, 16))\n        );\n      case '7bit':\n      case '8bit':\n      case 'binary':\n      default:\n        return buffer.toString('utf-8');\n    }\n  } catch (error) {\n    console.error('Error decoding content:', error);\n    return buffer.toString('utf-8');\n  }\n}\n\nasync function importEmailsToDatabase(emails: ParsedEmail[]) {\n  // Group emails into threads\n  const threadMap = new Map<string, ParsedEmail[]>();\n  \n  for (const email of emails) {\n    // Try to find thread based on references, in-reply-to, or subject\n    let threadKey: string | null = null;\n    \n    if (email.inReplyTo) {\n      threadKey = email.inReplyTo;\n    } else if (email.references && email.references.length > 0) {\n      threadKey = email.references[0];\n    } else {\n      // Create thread key from normalized subject\n      const normalizedSubject = email.subject\n        .replace(/^(re:|fwd?:|aw:)\\s*/i, '')\n        .trim()\n        .toLowerCase();\n      threadKey = `subject:${normalizedSubject}`;\n    }\n    \n    if (!threadMap.has(threadKey)) {\n      threadMap.set(threadKey, []);\n    }\n    threadMap.get(threadKey)!.push(email);\n  }\n\n  console.log(`Grouped ${emails.length} emails into ${threadMap.size} threads`);\n\n  // Import each thread\n  let importedThreads = 0;\n  let importedMessages = 0;\n  \n  for (const [threadKey, threadEmails] of Array.from(threadMap.entries())) {\n    try {\n      // Sort by date\n      threadEmails.sort((a: ParsedEmail, b: ParsedEmail) => a.date.getTime() - b.date.getTime());\n      \n      const firstEmail = threadEmails[0];\n      const lastEmail = threadEmails[threadEmails.length - 1];\n      \n      // Determine participants\n      const allParticipants = new Set<string>();\n      threadEmails.forEach((email: ParsedEmail) => {\n        allParticipants.add(email.from);\n        email.to.forEach((addr: string) => allParticipants.add(addr));\n        email.cc.forEach((addr: string) => allParticipants.add(addr));\n      });\n      \n      // Determine status\n      const hasUnread = threadEmails.some((e: ParsedEmail) => !e.isRead);\n      const status = hasUnread ? 'open' : 'closed';\n      \n      // Check if thread already exists\n      const existingThreads = await storage.getEmailThreads({});\n      const existingThread = existingThreads.find(t => \n        t.subject === firstEmail.subject && \n        t.lastActivity && \n        Math.abs(new Date(t.lastActivity).getTime() - lastEmail.date.getTime()) < 60000\n      );\n      \n      let threadId: string;\n      \n      if (existingThread) {\n        threadId = existingThread.id;\n        console.log(`Thread already exists: ${firstEmail.subject}`);\n      } else {\n        // Create thread\n        const thread = await storage.createEmailThread({\n          threadId: threadKey,\n          subject: firstEmail.subject,\n          customerEmail: firstEmail.from,\n          status,\n          lastActivity: lastEmail.date,\n          hasAttachment: threadEmails.some((e: ParsedEmail) => e.attachments.length > 0),\n          customerId: null,\n          assignedUserId: null,\n          priority: 'medium',\n          isUnread: hasUnread,\n          folder: 'inbox',\n          starred: false,\n          archived: false\n        });\n        \n        threadId = thread.id;\n        importedThreads++;\n      }\n      \n      // Import messages\n      for (const email of threadEmails) {\n        // Check if message already exists\n        const existingMessages = await storage.getEmailMessages(threadId);\n        const messageExists = existingMessages.some(m => m.messageId === email.messageId);\n        \n        if (messageExists) {\n          console.log(`Message already exists: ${email.messageId}`);\n          continue;\n        }\n        \n        // Store attachment metadata (files will be downloaded on-demand when viewing)\n        const messageAttachments = email.attachments.map((att: EmailAttachment) => ({\n          filename: att.filename,\n          contentType: att.contentType,\n          size: att.size,\n          contentId: att.contentId,\n          // Store IMAP location for future on-demand download\n          uid: att.uid,\n          partId: att.partId\n        }));\n        \n        await storage.createEmailMessage({\n          threadId,\n          messageId: email.messageId,\n          fromEmail: email.from,\n          toEmail: email.to.join(', '),\n          subject: email.subject,\n          body: email.bodyHtml || email.bodyText,\n          isHtml: !!email.bodyHtml,\n          isOutbound: false,\n          attachments: messageAttachments,\n          sentAt: email.date\n        });\n        \n        importedMessages++;\n      }\n      \n      if (importedThreads % 50 === 0 && importedThreads > 0) {\n        console.log(`üíæ Progress: ${importedThreads} threads, ${importedMessages} messages imported...`);\n      }\n    } catch (error) {\n      console.error(`Error importing thread:`, error);\n    }\n  }\n  \n  console.log(`Database import complete: ${importedThreads} threads, ${importedMessages} messages`);\n  \n  return {\n    importedThreads,\n    importedMessages\n  };\n}\n","size_bytes":15844},"scripts/run-migration.ts":{"content":"import { promises as fs } from 'fs';\nimport postgres from 'postgres';\n\nconst DATABASE_URL = process.env.DATABASE_URL;\n\nif (!DATABASE_URL) {\n  console.error('DATABASE_URL is not set');\n  process.exit(1);\n}\n\nasync function runMigration() {\n  const sql = postgres(DATABASE_URL);\n  \n  try {\n    console.log('Reading migration file...');\n    const migrationSQL = await fs.readFile('migrations/0001_add_returns_tables.sql', 'utf-8');\n    \n    console.log('Running migration...');\n    await sql.unsafe(migrationSQL);\n    \n    console.log('‚úÖ Migration completed successfully!');\n  } catch (error) {\n    console.error('‚ùå Migration failed:', error);\n    throw error;\n  } finally {\n    await sql.end();\n  }\n}\n\nrunMigration().catch((error) => {\n  console.error(error);\n  process.exit(1);\n});\n","size_bytes":784},"client/src/pages/returns.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport type { User, Return, ReturnItem } from \"@shared/schema\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { queryClient } from \"@/lib/queryClient\";\nimport { Package, Plus, Filter, Search, Calendar, ExternalLink, Truck, Image as ImageIcon, FileText, Archive, ChevronLeft, ChevronRight } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { format } from \"date-fns\";\nimport { CreateReturnModal } from \"@/components/forms/create-return-modal\";\nimport { NotesPanel } from \"@/components/notes/NotesPanel\";\nimport { ReturnsKanban } from \"@/components/returns/returns-kanban\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype EnrichedReturnData = {\n  return: Return;\n  order: any;\n  customer: any;\n  returnItems: ReturnItem[];\n  financialComparison: {\n    refundAmount: number;\n    originalAmount: number;\n    difference: number;\n  };\n  tracking: {\n    returnTracking: {\n      trackingNumber: string | null;\n      expectedReturnDate: string | null;\n    };\n    orderTracking: {\n      trackingNumber: string;\n      trackingUrl: string;\n      trackingCompany: string;\n    } | null;\n  };\n  photos: string[];\n  notes: any[];\n  assignedUser: {\n    id: string;\n    fullName: string;\n    email: string;\n  } | null;\n};\n\nconst STATUS_TABS = [\n  { value: \"all\", label: \"Alle\" },\n  { value: \"nieuw_onderweg\", label: \"Nieuw / Onderweg\" },\n  { value: \"ontvangen_controle\", label: \"Ontvangen (controle)\" },\n  { value: \"akkoord_terugbetaling\", label: \"Akkoord / Terugbetaling\" },\n  { value: \"vermiste_pakketten\", label: \"Vermiste Pakketten\" },\n  { value: \"wachten_klant\", label: \"Wachten op Klant\" },\n  { value: \"opnieuw_versturen\", label: \"Opnieuw Versturen\" },\n  { value: \"klaar\", label: \"Klaar\" },\n  { value: \"niet_ontvangen\", label: \"Niet Ontvangen\" },\n];\n\nconst STATUS_COLORS: Record<string, string> = {\n  nieuw_onderweg: \"bg-chart-4/10 text-chart-4 border-chart-4/20\",\n  ontvangen_controle: \"bg-primary/10 text-primary border-primary/20\",\n  akkoord_terugbetaling: \"bg-chart-2/10 text-chart-2 border-chart-2/20\",\n  vermiste_pakketten: \"bg-destructive/10 text-destructive border-destructive/20\",\n  wachten_klant: \"bg-chart-1/10 text-chart-1 border-chart-1/20\",\n  opnieuw_versturen: \"bg-chart-3/10 text-chart-3 border-chart-3/20\",\n  klaar: \"bg-muted text-muted-foreground border-muted\",\n  niet_ontvangen: \"bg-muted text-muted-foreground border-muted\",\n};\n\nconst PRIORITY_COLORS: Record<string, string> = {\n  low: \"bg-chart-4/10 text-chart-4 border-chart-4/20\",\n  medium: \"bg-chart-1/10 text-chart-1 border-chart-1/20\",\n  high: \"bg-primary/10 text-primary border-primary/20\",\n  urgent: \"bg-destructive/10 text-destructive border-destructive/20\",\n};\n\nexport default function Returns() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [priorityFilter, setPriorityFilter] = useState(\"all\");\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showReturnDetails, setShowReturnDetails] = useState(false);\n  const [selectedReturn, setSelectedReturn] = useState<Return | null>(null);\n  const [isEditing, setIsEditing] = useState(false);\n  const [showArchived, setShowArchived] = useState(false);\n  const [currentPage, setCurrentPage] = useState(1);\n  const itemsPerPage = 20;\n  \n  const [location, setLocation] = useLocation();\n  const { toast } = useToast();\n\n  // Fetch all returns (filtering done client-side)\n  const { data: allReturns = [], isLoading } = useQuery<Return[]>({\n    queryKey: [\"/api/returns\"],\n  });\n\n  // Fetch enriched return details when a return is selected\n  const { data: enrichedReturnData, isLoading: isLoadingDetails } = useQuery<EnrichedReturnData>({\n    queryKey: [\"/api/returns\", selectedReturn?.id],\n    enabled: !!selectedReturn?.id && showReturnDetails,\n    initialData: selectedReturn ? { return: selectedReturn } as EnrichedReturnData : undefined,\n    staleTime: 0, // Always refetch in background\n  });\n\n  const { data: currentUser } = useQuery<User>({\n    queryKey: [\"/api/auth/session\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/session\");\n      if (!response.ok) throw new Error(\"Not authenticated\");\n      const data = await response.json();\n      return data.user;\n    },\n  });\n\n  // Check for returnId in URL and fetch/open return details\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const returnId = params.get('returnId');\n    \n    if (returnId) {\n      const existingReturn = allReturns.find(r => r.id === returnId);\n      if (existingReturn) {\n        setSelectedReturn(existingReturn);\n        setShowReturnDetails(true);\n        setLocation('/returns');\n      } else {\n        fetch(`/api/returns/${returnId}`)\n          .then(response => {\n            if (!response.ok) throw new Error('Return not found');\n            return response.json();\n          })\n          .then(returnData => {\n            setSelectedReturn(returnData.return);\n            setShowReturnDetails(true);\n            setLocation('/returns');\n          })\n          .catch(error => {\n            console.error('Failed to fetch return:', error);\n            toast({\n              title: \"Retour niet gevonden\",\n              description: \"De gevraagde retour kon niet worden gevonden.\",\n              variant: \"destructive\",\n            });\n            setLocation('/returns');\n          });\n      }\n    }\n  }, [location, allReturns, setLocation, toast]);\n\n  // Filter by archived status\n  const returns = allReturns.filter(ret => \n    showArchived ? ret.isArchived === true : ret.isArchived !== true\n  );\n\n  // Filter returns by search query and priority\n  const filteredReturns = returns.filter((ret) => {\n    const matchesSearch =\n      !searchQuery ||\n      ret.returnNumber.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      ret.trackingNumber?.toLowerCase().includes(searchQuery.toLowerCase());\n\n    const matchesPriority = priorityFilter === \"all\" || ret.priority === priorityFilter;\n\n    return matchesSearch && matchesPriority;\n  });\n\n  // Pagination for archived view\n  const totalPages = Math.ceil(filteredReturns.length / itemsPerPage);\n  const paginatedReturns = showArchived \n    ? filteredReturns.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage)\n    : filteredReturns;\n\n  // Count returns by status\n  const statusCounts = returns.reduce(\n    (acc, ret) => {\n      acc[ret.status] = (acc[ret.status] || 0) + 1;\n      return acc;\n    },\n    {} as Record<string, number>\n  );\n\n  const formatCurrency = (cents: number | null) => {\n    if (!cents) return \"-\";\n    return `‚Ç¨${(cents / 100).toFixed(2)}`;\n  };\n\n  const getStatusLabel = (status: string) => {\n    const tab = STATUS_TABS.find((t) => t.value === status);\n    return tab?.label || status;\n  };\n\n  const handleViewDetails = (returnItem: Return) => {\n    setSelectedReturn(returnItem);\n    setShowReturnDetails(true);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Navigation />\n      \n      <main className=\"container mx-auto px-4 py-6\">\n        {/* Header Card */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-primary/10\">\n                  <Package className=\"h-5 w-5 text-primary\" />\n                </div>\n                <div>\n                  <h1 className=\"text-2xl font-semibold\">Retouren</h1>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Beheer alle productretouren\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Button \n                  variant={showArchived ? \"outline\" : \"ghost\"}\n                  onClick={() => {\n                    setShowArchived(!showArchived);\n                    setCurrentPage(1);\n                  }}\n                  data-testid=\"button-toggle-archived\"\n                >\n                  <Archive className=\"h-4 w-4 mr-2\" />\n                  {showArchived ? \"Toon Actief\" : \"Toon Archief\"}\n                </Button>\n                <Button \n                  onClick={() => setShowCreateModal(true)}\n                  data-testid=\"button-create-return\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Nieuw Retour\n                </Button>\n              </div>\n            </div>\n\n            {/* Stats Bar */}\n            <div className=\"flex items-center gap-6 p-4 bg-muted/50 rounded-lg\">\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm text-muted-foreground\">Totaal:</span>\n                <span className=\"text-sm font-semibold\">\n                  {returns.length}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm text-muted-foreground\">Nieuw:</span>\n                <span className=\"text-sm font-semibold text-primary\">\n                  {statusCounts.nieuw_onderweg || 0}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm text-muted-foreground\">Wachten op klant:</span>\n                <span className=\"text-sm font-semibold text-chart-1\">\n                  {statusCounts.wachten_klant || 0}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm text-muted-foreground\">Klaar:</span>\n                <span className=\"text-sm font-semibold\">\n                  {statusCounts.klaar || 0}\n                </span>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Filters Card */}\n        <Card className=\"mb-6\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"relative flex-1 max-w-md\">\n                <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n                <Input\n                  placeholder=\"Zoek op retournummer of tracking...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-9\"\n                  data-testid=\"input-search-returns\"\n                />\n              </div>\n              <Select value={priorityFilter} onValueChange={setPriorityFilter}>\n                <SelectTrigger className=\"w-[180px]\" data-testid=\"select-priority-filter\">\n                  <Filter className=\"h-4 w-4 mr-2\" />\n                  <SelectValue placeholder=\"Prioriteit\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">Alle prioriteiten</SelectItem>\n                  <SelectItem value=\"low\">Laag</SelectItem>\n                  <SelectItem value=\"medium\">Normaal</SelectItem>\n                  <SelectItem value=\"high\">Hoog</SelectItem>\n                  <SelectItem value=\"urgent\">Urgent</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Content */}\n        {isLoading ? (\n          <div className=\"space-y-3\">\n            {[...Array(5)].map((_, i) => (\n              <Skeleton key={i} className=\"h-32 w-full\" />\n            ))}\n          </div>\n        ) : filteredReturns.length === 0 ? (\n          <Card>\n            <CardContent className=\"flex flex-col items-center justify-center py-12\">\n              <Package className=\"h-12 w-12 text-muted-foreground mb-3\" />\n              <h3 className=\"text-lg font-medium mb-1\">\n                {showArchived ? \"Geen gearchiveerde retouren\" : \"Geen retouren gevonden\"}\n              </h3>\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                {searchQuery || priorityFilter !== \"all\"\n                  ? \"Probeer een andere zoekopdracht of filter\"\n                  : showArchived \n                    ? \"Er zijn nog geen gearchiveerde retouren\"\n                    : \"Er zijn nog geen retouren in dit overzicht\"}\n              </p>\n            </CardContent>\n          </Card>\n        ) : showArchived ? (\n          <>\n            {/* Archived List View */}\n            <div className=\"space-y-3\">\n              {paginatedReturns.map((returnItem) => (\n                <Card \n                  key={returnItem.id} \n                  className=\"cursor-pointer hover:shadow-md transition-shadow\"\n                  onClick={() => handleViewDetails(returnItem)}\n                  data-testid={`archived-return-card-${returnItem.id}`}\n                >\n                  <CardContent className=\"p-4\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <h3 className=\"font-semibold font-mono\">{returnItem.returnNumber}</h3>\n                          <Badge variant=\"outline\" className={STATUS_COLORS[returnItem.status] || \"\"}>\n                            {getStatusLabel(returnItem.status)}\n                          </Badge>\n                          <Badge variant=\"outline\" className={PRIORITY_COLORS[returnItem.priority || 'medium'] || \"\"}>\n                            {returnItem.priority === \"low\" ? \"Laag\" : \n                             returnItem.priority === \"high\" ? \"Hoog\" : \n                             returnItem.priority === \"urgent\" ? \"Urgent\" : \"Normaal\"}\n                          </Badge>\n                        </div>\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\n                          <div>\n                            <span className=\"text-muted-foreground\">Aangevraagd:</span>\n                            <p className=\"font-medium\">\n                              {returnItem.requestedAt ? format(new Date(returnItem.requestedAt), \"dd MMM yyyy\") : \"-\"}\n                            </p>\n                          </div>\n                          {returnItem.trackingNumber && (\n                            <div>\n                              <span className=\"text-muted-foreground\">Tracking:</span>\n                              <p className=\"font-medium font-mono\">{returnItem.trackingNumber}</p>\n                            </div>\n                          )}\n                          {returnItem.refundAmount && (\n                            <div>\n                              <span className=\"text-muted-foreground\">Terugbetaling:</span>\n                              <p className=\"font-medium\">‚Ç¨{(returnItem.refundAmount / 100).toFixed(2)}</p>\n                            </div>\n                          )}\n                          {returnItem.returnReason && (\n                            <div>\n                              <span className=\"text-muted-foreground\">Reden:</span>\n                              <p className=\"font-medium\">\n                                {returnItem.returnReason === \"defect\" ? \"Defect\" :\n                                 returnItem.returnReason === \"wrong_item\" ? \"Verkeerd artikel\" :\n                                 returnItem.returnReason === \"not_as_described\" ? \"Niet zoals beschreven\" :\n                                 returnItem.returnReason === \"no_longer_needed\" ? \"Niet meer nodig\" :\n                                 returnItem.returnReason === \"other\" ? returnItem.otherReason || \"Anders\" :\n                                 returnItem.returnReason}\n                              </p>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n\n            {/* Pagination */}\n            {totalPages > 1 && (\n              <Card className=\"mt-6\">\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Pagina {currentPage} van {totalPages} ({filteredReturns.length} resultaten)\n                    </p>\n                    <div className=\"flex items-center gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\n                        disabled={currentPage === 1}\n                        data-testid=\"button-prev-page\"\n                      >\n                        <ChevronLeft className=\"h-4 w-4 mr-1\" />\n                        Vorige\n                      </Button>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\n                        disabled={currentPage === totalPages}\n                        data-testid=\"button-next-page\"\n                      >\n                        Volgende\n                        <ChevronRight className=\"h-4 w-4 ml-1\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </>\n        ) : (\n          <ReturnsKanban \n            returns={filteredReturns} \n            isLoading={isLoading}\n            onViewReturn={handleViewDetails}\n            onEditReturn={(returnItem) => {\n              setSelectedReturn(returnItem);\n              setIsEditing(true);\n            }}\n            onDeleteReturn={(returnItem) => {\n              if (confirm(`Weet je zeker dat je retour ${returnItem.returnNumber} wilt verwijderen?`)) {\n                toast({\n                  title: \"Functie niet beschikbaar\",\n                  description: \"Verwijderen van retouren is nog niet ge√Ømplementeerd.\",\n                  variant: \"destructive\",\n                });\n              }\n            }}\n            onArchiveReturn={async (returnItem) => {\n              try {\n                const response = await fetch(`/api/returns/${returnItem.id}`, {\n                  method: \"PATCH\",\n                  headers: { \"Content-Type\": \"application/json\" },\n                  body: JSON.stringify({ isArchived: true }),\n                  credentials: \"include\",\n                });\n\n                if (!response.ok) throw new Error(\"Failed to archive return\");\n\n                await queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n                \n                toast({\n                  title: \"Gearchiveerd\",\n                  description: `Retour ${returnItem.returnNumber} is gearchiveerd.`,\n                });\n              } catch (error) {\n                toast({\n                  title: \"Fout\",\n                  description: \"Er is een fout opgetreden bij het archiveren.\",\n                  variant: \"destructive\",\n                });\n              }\n            }}\n          />\n        )}\n      </main>\n\n      <CreateReturnModal \n        open={showCreateModal} \n        onOpenChange={setShowCreateModal}\n        onReturnCreated={async (returnId) => {\n          // Refetch returns to get the newly created one\n          await queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n          \n          // Wait a bit for the query to update, then find and open the return\n          setTimeout(() => {\n            const newReturn = allReturns.find(r => r.id === returnId);\n            if (newReturn) {\n              setSelectedReturn(newReturn);\n              setShowReturnDetails(true);\n            }\n          }, 100);\n        }}\n      />\n\n      <CreateReturnModal \n        open={isEditing} \n        onOpenChange={setIsEditing}\n        editReturn={selectedReturn}\n        onReturnCreated={async () => {\n          await queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n          setShowReturnDetails(false);\n        }}\n      />\n\n      {/* Return Details Dialog */}\n      <Dialog open={showReturnDetails} onOpenChange={setShowReturnDetails}>\n        <DialogContent className=\"max-w-5xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader className=\"pb-3\">\n            <div className=\"flex items-start justify-between\">\n              <div>\n                <DialogTitle className=\"text-lg font-medium\">Retour Details {selectedReturn?.returnNumber}</DialogTitle>\n                <DialogDescription className=\"text-xs text-muted-foreground mt-0.5\">\n                  Volledige retourinformatie en order details\n                </DialogDescription>\n              </div>\n              <Button\n                size=\"sm\"\n                variant=\"ghost\"\n                onClick={() => setIsEditing(true)}\n                data-testid=\"button-edit-return\"\n                className=\"h-8\"\n              >\n                <ExternalLink className=\"h-3.5 w-3.5 mr-1.5\" />\n                <span className=\"text-xs\">Bewerken</span>\n              </Button>\n            </div>\n          </DialogHeader>\n          \n          {isLoadingDetails ? (\n            <div className=\"space-y-4\">\n              <Skeleton className=\"h-32 w-full\" />\n              <Skeleton className=\"h-32 w-full\" />\n              <Skeleton className=\"h-48 w-full\" />\n            </div>\n          ) : enrichedReturnData && (\n            <div className=\"space-y-2.5\">\n              {/* Return Overview & Customer Info */}\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2.5\">\n                {/* Return Information */}\n                <div className=\"border rounded-lg p-3\">\n                  <h3 className=\"text-sm font-medium mb-2\">Retour Informatie</h3>\n                  <div className=\"space-y-1.5\">\n                    <div className=\"flex justify-between items-start gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">Retournummer:</span>\n                      <span className=\"text-sm\">{enrichedReturnData.return.returnNumber}</span>\n                    </div>\n                    <div className=\"flex justify-between items-center gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">Status:</span>\n                      <Badge variant=\"outline\" className={`text-xs h-5 ${STATUS_COLORS[enrichedReturnData.return.status] || \"\"}`}>\n                        {getStatusLabel(enrichedReturnData.return.status)}\n                      </Badge>\n                    </div>\n                    <div className=\"flex justify-between items-center gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">Prioriteit:</span>\n                      <Badge variant=\"outline\" className={`text-xs h-5 ${PRIORITY_COLORS[enrichedReturnData.return.priority || 'medium'] || \"\"}`}>\n                        {enrichedReturnData.return.priority === \"low\" ? \"Laag\" : \n                         enrichedReturnData.return.priority === \"high\" ? \"Hoog\" : \n                         enrichedReturnData.return.priority === \"urgent\" ? \"Urgent\" : \"Normaal\"}\n                      </Badge>\n                    </div>\n                    <div className=\"flex justify-between items-start gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">Reden:</span>\n                      <span className=\"text-sm text-right max-w-[180px]\">\n                        {enrichedReturnData.return.returnReason === \"defect\" ? \"Defect\" :\n                         enrichedReturnData.return.returnReason === \"wrong_item\" ? \"Verkeerd artikel\" :\n                         enrichedReturnData.return.returnReason === \"not_as_described\" ? \"Niet zoals beschreven\" :\n                         enrichedReturnData.return.returnReason === \"no_longer_needed\" ? \"Niet meer nodig\" :\n                         enrichedReturnData.return.returnReason === \"other\" ? enrichedReturnData.return.otherReason || \"Anders\" :\n                         enrichedReturnData.return.returnReason || \"-\"}\n                      </span>\n                    </div>\n                    <Separator className=\"my-1.5\" />\n                    <div className=\"flex justify-between items-start gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">Aangevraagd:</span>\n                      <span className=\"text-sm\">\n                        {format(new Date(enrichedReturnData.return.requestedAt), \"dd MMM yyyy HH:mm\")}\n                      </span>\n                    </div>\n                    {enrichedReturnData.return.receivedAt && (\n                      <div className=\"flex justify-between items-start gap-2\">\n                        <span className=\"text-xs text-muted-foreground\">Ontvangen:</span>\n                        <span className=\"text-sm\">\n                          {format(new Date(enrichedReturnData.return.receivedAt), \"dd MMM yyyy HH:mm\")}\n                        </span>\n                      </div>\n                    )}\n                    {enrichedReturnData.assignedUser && (\n                      <div className=\"flex justify-between items-start gap-2\">\n                        <span className=\"text-xs text-muted-foreground\">Toegewezen aan:</span>\n                        <span className=\"text-sm\">{enrichedReturnData.assignedUser.fullName}</span>\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                {/* Customer Information */}\n                <div className=\"border rounded-lg p-3\">\n                  <h3 className=\"text-sm font-medium mb-2\">Klantinformatie</h3>\n                  <div className=\"space-y-1.5\">\n                    {enrichedReturnData.customer ? (\n                      <>\n                        <div className=\"flex justify-between items-start gap-2\">\n                          <span className=\"text-xs text-muted-foreground\">Naam:</span>\n                          <span className=\"text-sm\">\n                            {enrichedReturnData.customer.firstName} {enrichedReturnData.customer.lastName}\n                          </span>\n                        </div>\n                        <div className=\"flex justify-between items-start gap-2\">\n                          <span className=\"text-xs text-muted-foreground\">Email:</span>\n                          <span className=\"text-sm\">{enrichedReturnData.customer.email}</span>\n                        </div>\n                        {enrichedReturnData.customer.phone && (\n                          <div className=\"flex justify-between items-start gap-2\">\n                            <span className=\"text-xs text-muted-foreground\">Telefoon:</span>\n                            <span className=\"text-sm\">{enrichedReturnData.customer.phone}</span>\n                          </div>\n                        )}\n                      </>\n                    ) : enrichedReturnData.order?.orderData?.customer ? (\n                      <>\n                        <div className=\"flex justify-between items-start gap-2\">\n                          <span className=\"text-xs text-muted-foreground\">Naam:</span>\n                          <span className=\"text-sm\">\n                            {enrichedReturnData.order.orderData.customer.first_name} {enrichedReturnData.order.orderData.customer.last_name}\n                          </span>\n                        </div>\n                        <div className=\"flex justify-between items-start gap-2\">\n                          <span className=\"text-xs text-muted-foreground\">Email:</span>\n                          <span className=\"text-sm\">{enrichedReturnData.order.orderData.customer.email}</span>\n                        </div>\n                        {enrichedReturnData.order.orderData.customer.phone && (\n                          <div className=\"flex justify-between items-start gap-2\">\n                            <span className=\"text-xs text-muted-foreground\">Telefoon:</span>\n                            <span className=\"text-sm\">{enrichedReturnData.order.orderData.customer.phone}</span>\n                          </div>\n                        )}\n                      </>\n                    ) : (\n                      <div className=\"text-xs text-muted-foreground\">Geen klantinformatie beschikbaar</div>\n                    )}\n                    {enrichedReturnData.return.customerNotes && (\n                      <>\n                        <Separator className=\"my-1.5\" />\n                        <div>\n                          <span className=\"text-xs text-muted-foreground block mb-0.5\">Klant notities:</span>\n                          <p className=\"text-xs\">{enrichedReturnData.return.customerNotes}</p>\n                        </div>\n                      </>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Order Information from Shopify */}\n              {enrichedReturnData.order && (\n                <div className=\"border rounded-lg p-3\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <h3 className=\"text-sm font-medium\">Originele Order Informatie</h3>\n                    <Button\n                      variant=\"link\"\n                      size=\"sm\"\n                      onClick={() => window.open(`/orders?orderId=${enrichedReturnData.order.id}`, '_blank')}\n                      data-testid=\"button-view-order\"\n                      className=\"h-6 text-xs p-0\"\n                    >\n                      <ExternalLink className=\"h-3 w-3 mr-1\" />\n                      Bekijk Order\n                    </Button>\n                  </div>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\n                    <div>\n                      <span className=\"text-xs text-muted-foreground block mb-0.5\">Ordernummer</span>\n                      <p className=\"text-sm\">#{enrichedReturnData.order.orderNumber}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs text-muted-foreground block mb-0.5\">Orderdatum</span>\n                      <p className=\"text-sm\">\n                        {enrichedReturnData.order.orderDate ? \n                          format(new Date(enrichedReturnData.order.orderDate), \"dd MMM yyyy\") : \n                          \"-\"}\n                      </p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs text-muted-foreground block mb-0.5\">Status</span>\n                      <p className=\"text-sm capitalize\">{enrichedReturnData.order.status}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs text-muted-foreground block mb-0.5\">Totaal bedrag</span>\n                      <p className=\"text-sm\">\n                        {formatCurrency(enrichedReturnData.order.totalAmount)}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Return Items */}\n              {enrichedReturnData.returnItems && enrichedReturnData.returnItems.length > 0 && (\n                <div className=\"border rounded-lg p-3\">\n                  <h3 className=\"text-sm font-medium mb-2\">Geretourneerde Artikelen</h3>\n                  <div className=\"space-y-1.5\">\n                    {enrichedReturnData.returnItems.map((item) => (\n                      <div key={item.id} className=\"flex items-center justify-between p-2 border rounded hover:bg-muted/30 transition-colors\" data-testid={`return-item-${item.id}`}>\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"text-sm font-medium truncate\">{item.productName}</div>\n                          <div className=\"flex items-center gap-2 flex-wrap\">\n                            {item.sku && (\n                              <span className=\"text-xs text-muted-foreground\">SKU: {item.sku}</span>\n                            )}\n                            <span className=\"text-xs text-muted-foreground\">Aantal: {item.quantity}</span>\n                            {item.condition && (\n                              <Badge variant=\"outline\" className=\"text-xs h-4 px-1.5\">\n                                {item.condition === \"unopened\" ? \"Ongeopend\" :\n                                 item.condition === \"opened_unused\" ? \"Geopend\" :\n                                 item.condition === \"used\" ? \"Gebruikt\" :\n                                 item.condition === \"damaged\" ? \"Beschadigd\" :\n                                 item.condition}\n                              </Badge>\n                            )}\n                            {item.restockable && (\n                              <Badge variant=\"outline\" className=\"text-xs h-4 px-1.5 bg-chart-2/10 text-chart-2 border-chart-2/20\">\n                                Herstelbaar\n                              </Badge>\n                            )}\n                          </div>\n                        </div>\n                        {item.unitPrice && (\n                          <div className=\"text-right ml-3\">\n                            <div className=\"text-sm font-medium\">{formatCurrency(item.unitPrice)}</div>\n                            <div className=\"text-xs text-muted-foreground\">\n                              Totaal: {formatCurrency(item.unitPrice * item.quantity)}\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Tracking Information */}\n              {enrichedReturnData.tracking && (\n                <div className=\"border rounded-lg p-3\">\n                  <h3 className=\"text-sm font-medium mb-2\">Tracking Informatie</h3>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2.5\">\n                    {/* Return Tracking */}\n                    <div className=\"p-2.5 bg-muted/30 rounded border\">\n                      <div className=\"flex items-center gap-1.5 mb-1.5\">\n                        <Package className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                        <span className=\"text-xs font-medium\">Retour Tracking</span>\n                      </div>\n                      {enrichedReturnData.tracking.returnTracking?.trackingNumber ? (\n                        <>\n                          <p className=\"font-mono text-xs\">{enrichedReturnData.tracking.returnTracking.trackingNumber}</p>\n                          {enrichedReturnData.tracking.returnTracking.expectedReturnDate && (\n                            <p className=\"text-xs text-muted-foreground mt-0.5\">\n                              Verwacht: {format(new Date(enrichedReturnData.tracking.returnTracking.expectedReturnDate), \"dd MMM yyyy\")}\n                            </p>\n                          )}\n                        </>\n                      ) : (\n                        <p className=\"text-xs text-muted-foreground\">Geen tracking beschikbaar</p>\n                      )}\n                    </div>\n\n                    {/* Order Tracking */}\n                    <div className=\"p-2.5 bg-muted/30 rounded border\">\n                      <div className=\"flex items-center gap-1.5 mb-1.5\">\n                        <Truck className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                        <span className=\"text-xs font-medium\">Originele Order Tracking</span>\n                      </div>\n                      {enrichedReturnData.tracking.orderTracking ? (\n                        <>\n                          <p className=\"font-mono text-xs\">{enrichedReturnData.tracking.orderTracking.trackingNumber}</p>\n                          {enrichedReturnData.tracking.orderTracking.trackingCompany && (\n                            <p className=\"text-xs text-muted-foreground\">{enrichedReturnData.tracking.orderTracking.trackingCompany}</p>\n                          )}\n                          {enrichedReturnData.tracking.orderTracking.trackingUrl && (\n                            <Button\n                              variant=\"link\"\n                              size=\"sm\"\n                              className=\"p-0 h-auto mt-0.5 text-xs\"\n                              onClick={() => window.open(enrichedReturnData.tracking.orderTracking!.trackingUrl, '_blank')}\n                              data-testid=\"button-track-shipment\"\n                            >\n                              <ExternalLink className=\"h-3 w-3 mr-0.5\" />\n                              Track verzending\n                            </Button>\n                          )}\n                        </>\n                      ) : (\n                        <p className=\"text-xs text-muted-foreground\">Geen tracking beschikbaar</p>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Photos & Evidence */}\n              {enrichedReturnData.photos && enrichedReturnData.photos.length > 0 && (\n                <div className=\"border rounded-lg p-3\">\n                  <h3 className=\"text-sm font-medium mb-2 flex items-center gap-1.5\">\n                    <ImageIcon className=\"h-3.5 w-3.5\" />\n                    Foto's & Bewijs\n                  </h3>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\n                    {enrichedReturnData.photos.map((photo, index) => (\n                      <div key={index} className=\"relative aspect-square rounded overflow-hidden border\">\n                        <img \n                          src={photo} \n                          alt={`Return photo ${index + 1}`}\n                          className=\"w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity\"\n                          onClick={() => window.open(photo, '_blank')}\n                          data-testid={`return-photo-${index}`}\n                        />\n                      </div>\n                    ))}\n                  </div>\n                  {enrichedReturnData.return.conditionNotes && (\n                    <div className=\"mt-2.5 p-2.5 bg-muted/30 rounded border\">\n                      <div className=\"flex items-center gap-1.5 mb-1\">\n                        <FileText className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                        <span className=\"text-xs font-medium\">Conditie Notities</span>\n                      </div>\n                      <p className=\"text-xs\">{enrichedReturnData.return.conditionNotes}</p>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Internal Notes */}\n              <div className=\"border rounded-lg p-3\">\n                <h3 className=\"text-sm font-medium mb-2\">Interne Notities</h3>\n                {currentUser && (\n                  <NotesPanel \n                    entityType=\"return\" \n                    entityId={enrichedReturnData.return.id}\n                    currentUser={currentUser}\n                  />\n                )}\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":39900},"client/src/components/forms/create-return-modal.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { insertReturnSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { Check, ChevronsUpDown, Package, ChevronLeft, ChevronRight, Search } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nconst createReturnFormSchema = insertReturnSchema.extend({\n  customerId: z.string().min(1, \"Klant is verplicht\"),\n  orderId: z.string().optional().nullable(),\n  returnReason: z.enum([\"wrong_item\", \"damaged\", \"defective\", \"size_issue\", \"changed_mind\", \"other\"]),\n  otherReason: z.string().optional().nullable(),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]).default(\"medium\"),\n  trackingNumber: z.string().optional().nullable(),\n  internalNotes: z.string().optional().nullable(),\n}).refine((data) => {\n  if (data.returnReason === \"other\" && !data.otherReason) {\n    return false;\n  }\n  return true;\n}, {\n  message: \"Specificeer de reden wanneer 'Anders' is geselecteerd\",\n  path: [\"otherReason\"],\n});\n\ntype CreateReturnFormValues = z.infer<typeof createReturnFormSchema>;\n\ninterface CreateReturnModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  customerId?: string;\n  orderId?: string;\n  onReturnCreated?: (returnId: string) => void;\n  editReturn?: any;\n}\n\ninterface SelectedItemData {\n  quantity: number;\n  condition: string;\n  notes?: string;\n}\n\nexport function CreateReturnModal({ open, onOpenChange, customerId, orderId, onReturnCreated, editReturn }: CreateReturnModalProps) {\n  const { toast } = useToast();\n  const [, setLocation] = useLocation();\n  const [orderSearchOpen, setOrderSearchOpen] = useState(false);\n  const [orderSearchQuery, setOrderSearchQuery] = useState(\"\");\n  const [selectedItems, setSelectedItems] = useState<Map<string, SelectedItemData>>(new Map());\n\n  const { data: customers } = useQuery<any[]>({\n    queryKey: [\"/api/customers\"],\n  });\n\n  // Fetch specific order when orderId is preset\n  const { data: presetOrder } = useQuery<any>({\n    queryKey: [\"/api/orders\", orderId],\n    enabled: !!orderId,\n  });\n\n  // Fetch orders with search query (or recent orders if no search)\n  const { data: ordersData } = useQuery<{ orders: any[], total: number }>({\n    queryKey: [\"/api/orders\", \"paginated\", orderSearchQuery],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        page: \"1\",\n        limit: \"50\",\n      });\n      \n      if (orderSearchQuery) {\n        params.append(\"search\", orderSearchQuery);\n      }\n      \n      const response = await fetch(`/api/orders?${params.toString()}`);\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch orders\");\n      }\n      return response.json();\n    },\n  });\n\n  // Combine preset order with search results\n  const orders = useMemo(() => {\n    const ordersList = ordersData?.orders || [];\n    \n    if (presetOrder && !ordersList.find(o => o.id === presetOrder.id)) {\n      return [presetOrder, ...ordersList];\n    }\n    \n    return ordersList;\n  }, [ordersData, presetOrder]);\n\n  const form = useForm<CreateReturnFormValues>({\n    resolver: zodResolver(createReturnFormSchema),\n    defaultValues: editReturn ? {\n      customerId: editReturn.customerId || \"\",\n      orderId: editReturn.orderId || null,\n      returnReason: editReturn.returnReason || \"other\" as const,\n      otherReason: editReturn.otherReason || null,\n      priority: editReturn.priority || \"medium\" as const,\n      status: editReturn.status || \"nieuw_onderweg\" as const,\n      trackingNumber: editReturn.trackingNumber || null,\n      internalNotes: editReturn.internalNotes || null,\n      customerNotes: editReturn.customerNotes || null,\n      conditionNotes: editReturn.conditionNotes || null,\n      refundAmount: editReturn.refundAmount || null,\n      refundStatus: editReturn.refundStatus || \"pending\" as const,\n      refundMethod: editReturn.refundMethod || null,\n      shopifyRefundId: editReturn.shopifyRefundId || null,\n      photos: editReturn.photos || null,\n      assignedUserId: editReturn.assignedUserId || null,\n      caseId: editReturn.caseId || null,\n      requestedAt: undefined,\n      receivedAt: editReturn.receivedAt || null,\n      expectedReturnDate: editReturn.expectedReturnDate || null,\n      completedAt: editReturn.completedAt || null,\n    } : {\n      customerId: customerId || \"\",\n      orderId: orderId || null,\n      returnReason: \"other\" as const,\n      otherReason: null,\n      priority: \"medium\" as const,\n      status: \"nieuw_onderweg\" as const,\n      trackingNumber: null,\n      internalNotes: null,\n      customerNotes: null,\n      conditionNotes: null,\n      refundAmount: null,\n      refundStatus: \"pending\" as const,\n      refundMethod: null,\n      shopifyRefundId: null,\n      photos: null,\n      assignedUserId: null,\n      caseId: null,\n      requestedAt: undefined,\n      receivedAt: null,\n      expectedReturnDate: null,\n      completedAt: null,\n    },\n  });\n\n  // Populate customerId when modal opens with preset orderId\n  useEffect(() => {\n    if (open && presetOrder && presetOrder.customerId) {\n      form.setValue(\"customerId\", presetOrder.customerId);\n      form.setValue(\"orderId\", presetOrder.id);\n    }\n  }, [open, presetOrder, form]);\n\n  // Reset form and selections when modal closes\n  useEffect(() => {\n    if (!open) {\n      setSelectedItems(new Map());\n      form.reset();\n    }\n  }, [open, form]);\n\n  // Close dropdown when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      if (!target.closest('[data-testid=\"order-search-input\"]') && \n          !target.closest('[data-testid=\"order-search-dropdown\"]')) {\n        setOrderSearchOpen(false);\n      }\n    };\n\n    if (orderSearchOpen) {\n      document.addEventListener('mousedown', handleClickOutside);\n      return () => document.removeEventListener('mousedown', handleClickOutside);\n    }\n  }, [orderSearchOpen]);\n\n  // Watch for return reason to show/hide other reason field\n  const returnReason = form.watch(\"returnReason\");\n\n  // Get selected order and customer info\n  const selectedOrderId = form.watch(\"orderId\");\n  const selectedOrder = orders?.find(o => o.id === selectedOrderId);\n  const selectedCustomer = customers?.find(c => c.id === selectedOrder?.customerId);\n\n  // Extract line items from selected order\n  const orderLineItems = useMemo(() => {\n    if (!selectedOrder || !selectedOrder.orderData) return [];\n    const lineItems = (selectedOrder.orderData as any).line_items || [];\n    return lineItems.map((item: any, index: number) => ({\n      id: item.id?.toString() || item.sku || `${selectedOrder.id}-line-${index}`,\n      title: item.title || \"Unknown Product\",\n      sku: item.sku || \"\",\n      variantTitle: item.variant_title || \"\",\n      quantity: item.quantity || 1,\n      price: item.price || \"0\",\n    }));\n  }, [selectedOrder]);\n\n  // Handle order selection\n  const handleOrderSelect = (orderId: string) => {\n    const order = orders?.find(o => o.id === orderId);\n    if (order) {\n      // If changing order, reset item selections\n      const currentOrderId = form.getValues(\"orderId\");\n      if (currentOrderId && currentOrderId !== orderId && selectedItems.size > 0) {\n        if (confirm(\"Bestelling wijzigen zal geselecteerde artikelen wissen. Doorgaan?\")) {\n          setSelectedItems(new Map());\n        } else {\n          return;\n        }\n      }\n      \n      form.setValue(\"orderId\", orderId);\n      form.setValue(\"customerId\", order.customerId || \"\");\n    }\n    setOrderSearchOpen(false);\n  };\n\n  const createReturnMutation = useMutation({\n    mutationFn: async (data: CreateReturnFormValues & { items?: any[] }) => {\n      const { items, ...returnFields } = data;\n      \n      const returnData = {\n        ...returnFields,\n        orderId: (returnFields.orderId && returnFields.orderId !== \"none\") ? returnFields.orderId : null,\n        otherReason: returnFields.returnReason === \"other\" ? returnFields.otherReason : null,\n        trackingNumber: returnFields.trackingNumber || null,\n        internalNotes: returnFields.internalNotes || null,\n        items: items || [],\n      };\n      \n      if (editReturn) {\n        const response = await apiRequest(\"PATCH\", `/api/returns/${editReturn.id}`, returnData);\n        const updatedReturn = await response.json();\n        return updatedReturn;\n      } else {\n        const response = await apiRequest(\"POST\", \"/api/returns\", returnData);\n        const newReturn = await response.json();\n        return newReturn;\n      }\n    },\n    onSuccess: async (returnData) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n      \n      toast({\n        title: editReturn ? \"Retour bijgewerkt\" : \"Retour aangemaakt\",\n        description: editReturn \n          ? `Retour \"${returnData.returnNumber}\" is succesvol bijgewerkt.`\n          : `Retour \"${returnData.returnNumber}\" is succesvol aangemaakt${selectedItems.size > 0 ? ` met ${selectedItems.size} artikel(en)` : ''}.`,\n      });\n      \n      onOpenChange(false);\n      form.reset();\n      setSelectedItems(new Map());\n      \n      // Instead of navigating, call the callback or open modal\n      if (onReturnCreated) {\n        onReturnCreated(returnData.id);\n      }\n    },\n    onError: (error: any) => {\n      toast({\n        title: editReturn ? \"Fout bij bijwerken retour\" : \"Fout bij aanmaken retour\",\n        description: error.message || `Er is een fout opgetreden bij het ${editReturn ? 'bijwerken' : 'aanmaken'} van de retour.`,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n\n  const handleFinalSubmit = (data: CreateReturnFormValues) => {\n    // Convert selectedItems map to array format\n    const items = Array.from(selectedItems.entries()).map(([itemId, itemData]) => {\n      const lineItem = orderLineItems.find(li => li.id === itemId);\n      return {\n        sku: lineItem?.sku || \"\",\n        productName: lineItem?.title || \"\",\n        quantity: itemData.quantity,\n        unitPrice: lineItem?.price ? Math.round(parseFloat(lineItem.price) * 100) : 0,\n        condition: itemData.condition,\n        imageUrl: null,\n        restockable: itemData.condition === \"unopened\",\n      };\n    });\n\n    createReturnMutation.mutate({ ...data, items });\n  };\n\n  const onSubmit = (data: CreateReturnFormValues) => {\n    // Always submit with current item selection (empty array if no items selected)\n    handleFinalSubmit(data);\n  };\n\n  const toggleItemSelection = (itemId: string) => {\n    const newMap = new Map(selectedItems);\n    if (newMap.has(itemId)) {\n      newMap.delete(itemId);\n    } else {\n      const lineItem = orderLineItems.find(li => li.id === itemId);\n      newMap.set(itemId, {\n        quantity: 1,\n        condition: \"unopened\",\n      });\n    }\n    setSelectedItems(newMap);\n  };\n\n  const updateItemData = (itemId: string, field: keyof SelectedItemData, value: any) => {\n    const newMap = new Map(selectedItems);\n    const itemData = newMap.get(itemId);\n    if (itemData) {\n      newMap.set(itemId, { ...itemData, [field]: value });\n      setSelectedItems(newMap);\n    }\n  };\n\n  const selectAllItems = () => {\n    const newMap = new Map<string, SelectedItemData>();\n    orderLineItems.forEach(item => {\n      newMap.set(item.id, {\n        quantity: 1,\n        condition: \"unopened\",\n      });\n    });\n    setSelectedItems(newMap);\n  };\n\n  const deselectAllItems = () => {\n    setSelectedItems(new Map());\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-[900px] max-h-[90vh] overflow-hidden flex flex-col p-0\" data-testid=\"create-return-modal\">\n        <DialogHeader className=\"px-6 pt-4 pb-3 flex-shrink-0\">\n          <DialogTitle className=\"text-lg\">{editReturn ? 'Retour Bewerken' : 'Nieuwe Retour Aanmaken'}</DialogTitle>\n          <DialogDescription className=\"text-sm\">\n            {editReturn ? 'Wijzig de retourinformatie' : 'Selecteer een bestelling en vul de retourinformatie in'}\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"flex-1 overflow-y-auto px-6 pb-4\">\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n              {/* Section 1: Order & Return Details */}\n              <div className=\"space-y-3\">\n                <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide\">Bestelling & Details</h3>\n                \n                <FormField\n                  control={form.control}\n                  name=\"orderId\"\n                  render={({ field }) => (\n                    <FormItem className=\"flex flex-col\">\n                      <FormLabel>Bestelling *</FormLabel>\n                      <div className=\"relative\">\n                        <FormControl>\n                          <Input\n                            placeholder=\"Zoek op bestelnummer of email...\"\n                            value={orderSearchQuery}\n                            onChange={(e) => {\n                              setOrderSearchQuery(e.target.value);\n                              if (e.target.value.length > 0) {\n                                setOrderSearchOpen(true);\n                              }\n                            }}\n                            onFocus={() => {\n                              if (orderSearchQuery.length > 0) {\n                                setOrderSearchOpen(true);\n                              }\n                            }}\n                            data-testid=\"order-search-input\"\n                            className=\"pr-10\"\n                          />\n                        </FormControl>\n                        <Search className=\"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground pointer-events-none\" />\n                        \n                        {orderSearchOpen && (\n                          <div \n                            className=\"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-md max-h-[300px] overflow-y-auto\"\n                            data-testid=\"order-search-dropdown\"\n                          >\n                            {orders.length === 0 ? (\n                              <div className=\"p-4 text-center text-sm text-muted-foreground\">\n                                Geen bestellingen gevonden.\n                              </div>\n                            ) : (\n                              <div className=\"p-1\">\n                                {orders.map((order) => (\n                                  <div\n                                    key={order.id}\n                                    onClick={() => {\n                                      handleOrderSelect(order.id);\n                                      setOrderSearchOpen(false);\n                                    }}\n                                    className={cn(\n                                      \"relative flex cursor-pointer select-none items-center rounded-sm px-2 py-2 text-sm outline-none hover:bg-accent hover:text-accent-foreground\",\n                                      field.value === order.id && \"bg-accent\"\n                                    )}\n                                    data-testid={`order-option-${order.id}`}\n                                  >\n                                    <Check\n                                      className={cn(\n                                        \"mr-2 h-4 w-4\",\n                                        field.value === order.id ? \"opacity-100\" : \"opacity-0\"\n                                      )}\n                                    />\n                                    <div className=\"flex-1\">\n                                      <div className=\"flex items-center gap-2\">\n                                        <Package className=\"h-4 w-4 text-muted-foreground\" />\n                                        <span className=\"font-mono font-medium\">\n                                          {order.orderNumber}\n                                        </span>\n                                        <Badge variant=\"outline\" className=\"ml-auto\">\n                                          ‚Ç¨{(order.totalAmount / 100).toFixed(2)}\n                                        </Badge>\n                                      </div>\n                                      <div className=\"text-sm text-muted-foreground\">\n                                        {order.customerEmail}\n                                      </div>\n                                    </div>\n                                  </div>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        )}\n                      </div>\n                      {selectedOrder && (\n                        <div className=\"text-sm text-muted-foreground mt-1\">\n                          Geselecteerd: {selectedOrder.orderNumber} - ‚Ç¨{(selectedOrder.totalAmount / 100).toFixed(2)}\n                        </div>\n                      )}\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                {selectedOrder && selectedCustomer && (\n                  <div className=\"p-2 bg-muted/50 rounded-md\">\n                    <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                      <div>\n                        <span className=\"text-muted-foreground\">Naam:</span>{\" \"}\n                        <span className=\"font-medium\">\n                          {selectedCustomer.firstName} {selectedCustomer.lastName}\n                        </span>\n                      </div>\n                      <div>\n                        <span className=\"text-muted-foreground\">Email:</span>{\" \"}\n                        <span className=\"font-medium\">{selectedCustomer.email}</span>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"returnReason\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Reden *</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"return-reason-select\">\n                              <SelectValue placeholder=\"Selecteer reden\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"wrong_item\">Verkeerd artikel</SelectItem>\n                            <SelectItem value=\"damaged\">Beschadigd</SelectItem>\n                            <SelectItem value=\"defective\">Defect</SelectItem>\n                            <SelectItem value=\"size_issue\">Maat probleem</SelectItem>\n                            <SelectItem value=\"changed_mind\">Bedacht</SelectItem>\n                            <SelectItem value=\"other\">Anders</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"priority\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Prioriteit</FormLabel>\n                        <Select onValueChange={field.onChange} value={field.value}>\n                          <FormControl>\n                            <SelectTrigger data-testid=\"return-priority-select\">\n                              <SelectValue placeholder=\"Selecteer prioriteit\" />\n                            </SelectTrigger>\n                          </FormControl>\n                          <SelectContent>\n                            <SelectItem value=\"low\">Laag</SelectItem>\n                            <SelectItem value=\"medium\">Normaal</SelectItem>\n                            <SelectItem value=\"high\">Hoog</SelectItem>\n                            <SelectItem value=\"urgent\">Urgent</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                </div>\n\n                {returnReason === \"other\" && (\n                  <FormField\n                    control={form.control}\n                    name=\"otherReason\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>Specificeer reden *</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"Bijv. Verkeerde kleur besteld\"\n                            {...field}\n                            value={field.value || \"\"}\n                            data-testid=\"return-other-reason-input\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <FormField\n                    control={form.control}\n                    name=\"trackingNumber\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel className=\"text-sm\">Track & Trace</FormLabel>\n                        <FormControl>\n                          <Input\n                            placeholder=\"Bijv. 3SABCD1234567890\"\n                            {...field}\n                            value={field.value || \"\"}\n                            data-testid=\"return-tracking-input\"\n                            className=\"h-9\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n                  <div></div>\n                </div>\n\n                <FormField\n                  control={form.control}\n                  name=\"internalNotes\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel className=\"text-sm\">Interne Notities</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Interne notities over deze retour...\"\n                          className=\"resize-none h-16\"\n                          {...field}\n                          value={field.value || \"\"}\n                          data-testid=\"return-notes-input\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n              </div>\n\n              {/* Separator */}\n              <Separator className=\"my-3\" />\n\n              {/* Section 2: Item Selection */}\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\n                    Artikelen {!selectedOrderId && <span className=\"text-xs normal-case font-normal ml-2\">(selecteer eerst bestelling)</span>}\n                  </h3>\n                  {selectedOrderId && orderLineItems.length > 0 && (\n                    <Badge variant=\"outline\">\n                      {selectedItems.size} van {orderLineItems.length} geselecteerd\n                    </Badge>\n                  )}\n                </div>\n\n                {!selectedOrderId ? (\n                  <div className=\"border rounded-md p-4 text-center text-muted-foreground bg-muted/30\">\n                    <Package className=\"h-8 w-8 mx-auto mb-2 opacity-30\" />\n                    <p className=\"text-sm\">Selecteer een bestelling</p>\n                  </div>\n                ) : orderLineItems.length === 0 ? (\n                  <div className=\"border rounded-md p-4 text-center text-muted-foreground text-sm\">\n                    <p>Geen artikelen gevonden</p>\n                  </div>\n                ) : (\n                  <>\n                    <div className=\"flex gap-2\">\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={selectAllItems}\n                        disabled={!selectedOrderId}\n                        data-testid=\"button-select-all\"\n                        className=\"h-8 text-xs\"\n                      >\n                        Alles Selecteren\n                      </Button>\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={deselectAllItems}\n                        disabled={!selectedOrderId || selectedItems.size === 0}\n                        data-testid=\"button-deselect-all\"\n                        className=\"h-8 text-xs\"\n                      >\n                        Alles Deselecteren\n                      </Button>\n                    </div>\n\n                    <div className=\"space-y-2 max-h-[200px] overflow-y-auto pr-2\">\n                      {orderLineItems.map((lineItem) => {\n                        const isSelected = selectedItems.has(lineItem.id);\n                        const itemData = selectedItems.get(lineItem.id);\n\n                        return (\n                          <div\n                            key={lineItem.id}\n                            className={cn(\n                              \"border rounded-md p-2 space-y-2 transition-colors\",\n                              isSelected ? \"border-primary bg-primary/5\" : \"border-border\"\n                            )}\n                          >\n                            <div className=\"flex items-start gap-2\">\n                              <Checkbox\n                                checked={isSelected}\n                                onCheckedChange={() => toggleItemSelection(lineItem.id)}\n                                data-testid={`checkbox-item-${lineItem.id}`}\n                                className=\"mt-1\"\n                              />\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"font-medium text-sm truncate\">{lineItem.title}</div>\n                                {lineItem.variantTitle && (\n                                  <div className=\"text-xs text-muted-foreground\">{lineItem.variantTitle}</div>\n                                )}\n                                <div className=\"text-xs text-muted-foreground\">\n                                  SKU: {lineItem.sku || \"N/A\"} ‚Ä¢ {lineItem.quantity}x ‚Ä¢ ‚Ç¨{parseFloat(lineItem.price).toFixed(2)}\n                                </div>\n                              </div>\n                            </div>\n\n                            {isSelected && itemData && (\n                              <div className=\"grid grid-cols-2 gap-2 pl-6\">\n                                <div>\n                                  <label className=\"text-xs font-medium\">Aantal</label>\n                                  <Input\n                                    type=\"number\"\n                                    min={1}\n                                    max={lineItem.quantity}\n                                    value={itemData.quantity}\n                                    onChange={(e) => updateItemData(lineItem.id, \"quantity\", parseInt(e.target.value) || 1)}\n                                    className=\"mt-1 h-8\"\n                                    data-testid={`input-quantity-${lineItem.id}`}\n                                  />\n                                </div>\n                                <div>\n                                  <label className=\"text-xs font-medium\">Conditie</label>\n                                  <Select\n                                    value={itemData.condition}\n                                    onValueChange={(value) => updateItemData(lineItem.id, \"condition\", value)}\n                                  >\n                                    <SelectTrigger className=\"mt-1 h-8\" data-testid={`select-condition-${lineItem.id}`}>\n                                      <SelectValue />\n                                    </SelectTrigger>\n                                    <SelectContent>\n                                      <SelectItem value=\"unopened\">Ongeopend</SelectItem>\n                                      <SelectItem value=\"opened_unused\">Geopend</SelectItem>\n                                      <SelectItem value=\"used\">Gebruikt</SelectItem>\n                                      <SelectItem value=\"damaged\">Beschadigd</SelectItem>\n                                    </SelectContent>\n                                  </Select>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n                        );\n                      })}\n                    </div>\n                  </>\n                )}\n              </div>\n\n              {/* Footer Actions */}\n              <div className=\"flex justify-between gap-3 pt-3\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => onOpenChange(false)}\n                  disabled={createReturnMutation.isPending}\n                  data-testid=\"button-cancel-return\"\n                >\n                  Annuleren\n                </Button>\n                <div className=\"flex gap-2\">\n                  {selectedOrderId && orderLineItems.length > 0 && selectedItems.size === 0 && (\n                    <Button\n                      type=\"submit\"\n                      variant=\"outline\"\n                      disabled={createReturnMutation.isPending}\n                      data-testid=\"button-skip-items\"\n                    >\n                      Zonder Artikelen\n                    </Button>\n                  )}\n                  <Button\n                    type=\"submit\"\n                    disabled={createReturnMutation.isPending || (!editReturn && !selectedOrderId)}\n                    data-testid=\"button-create-return\"\n                  >\n                    {createReturnMutation.isPending \n                      ? (editReturn ? \"Bijwerken...\" : \"Aanmaken...\") \n                      : editReturn\n                        ? \"Retour Bijwerken\"\n                        : selectedItems.size > 0 \n                          ? `Retour Aanmaken (${selectedItems.size} ${selectedItems.size === 1 ? 'artikel' : 'artikelen'})`\n                          : \"Retour Aanmaken\"}\n                  </Button>\n                </div>\n              </div>\n            </form>\n          </Form>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":32379},"client/src/pages/return-detail.tsx":{"content":"import { useState } from \"react\";\nimport { useParams, useLocation } from \"wouter\";\nimport { Navigation } from \"@/components/layout/navigation\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { \n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { \n  ArrowLeft, \n  Package,\n  User,\n  Calendar,\n  Clock,\n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  Camera,\n  MessageSquare,\n  Activity,\n  DollarSign,\n  Mail,\n  ShoppingCart,\n  Image,\n  Trash2,\n  Upload\n} from \"lucide-react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { format } from \"date-fns\";\n\ninterface ReturnItem {\n  id: string;\n  returnId: string;\n  productName: string;\n  sku: string | null;\n  quantity: number;\n  reason: string;\n  condition: string | null;\n  refundAmount: number | null;\n  notes: string | null;\n}\n\ninterface Return {\n  id: string;\n  returnNumber: string;\n  customerId: string;\n  orderId: string | null;\n  caseId: string | null;\n  status: string;\n  reason: string;\n  priority: string;\n  assignedUserId: string | null;\n  trackingNumber: string | null;\n  receivedDate: string | null;\n  completedDate: string | null;\n  refundAmount: number | null;\n  refundMethod: string | null;\n  refundStatus: string | null;\n  photoUrls: string[] | null;\n  internalNotes: string | null;\n  createdAt: string;\n  updatedAt: string;\n  customerName?: string;\n  customerEmail?: string;\n  assignedUserName?: string;\n  orderNumber?: string;\n  returnItems?: ReturnItem[];\n}\n\nconst STATUS_OPTIONS = [\n  { value: \"nieuw_onderweg\", label: \"Nieuw/Onderweg\" },\n  { value: \"ontvangen_controle\", label: \"Ontvangen - Controle Nodig\" },\n  { value: \"akkoord_terugbetaling\", label: \"Akkoord - Terugbetaling\" },\n  { value: \"vermiste_pakketten\", label: \"Vermiste Pakketten\" },\n  { value: \"wachten_klant\", label: \"Wachten op Klant\" },\n  { value: \"opnieuw_versturen\", label: \"Opnieuw Versturen\" },\n  { value: \"klaar\", label: \"Klaar\" },\n  { value: \"niet_ontvangen\", label: \"Niet Ontvangen\" },\n];\n\nconst PRIORITY_OPTIONS = [\n  { value: \"low\", label: \"Low\" },\n  { value: \"medium\", label: \"Medium\" },\n  { value: \"high\", label: \"High\" },\n  { value: \"urgent\", label: \"Urgent\" },\n];\n\nconst REFUND_STATUS_OPTIONS = [\n  { value: \"pending\", label: \"Pending\" },\n  { value: \"processing\", label: \"Processing\" },\n  { value: \"completed\", label: \"Completed\" },\n  { value: \"failed\", label: \"Failed\" },\n];\n\nfunction getStatusColor(status: string) {\n  switch (status) {\n    case \"nieuw_onderweg\":\n      return \"bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800\";\n    case \"ontvangen_controle\":\n      return \"bg-orange-100 dark:bg-orange-950 text-orange-700 dark:text-orange-400 border-orange-200 dark:border-orange-800\";\n    case \"akkoord_terugbetaling\":\n    case \"klaar\":\n      return \"bg-green-100 dark:bg-green-950 text-green-700 dark:text-green-400 border-green-200 dark:border-green-800\";\n    case \"vermiste_pakketten\":\n      return \"bg-red-100 dark:bg-red-950 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800\";\n    case \"wachten_klant\":\n      return \"bg-yellow-100 dark:bg-yellow-950 text-yellow-700 dark:text-yellow-400 border-yellow-200 dark:border-yellow-800\";\n    case \"opnieuw_versturen\":\n      return \"bg-purple-100 dark:bg-purple-950 text-purple-700 dark:text-purple-400 border-purple-200 dark:border-purple-800\";\n    default:\n      return \"bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-700\";\n  }\n}\n\nfunction getPriorityColor(priority: string) {\n  switch (priority) {\n    case \"urgent\":\n      return \"bg-red-100 dark:bg-red-950 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800\";\n    case \"high\":\n      return \"bg-orange-100 dark:bg-orange-950 text-orange-700 dark:text-orange-400 border-orange-200 dark:border-orange-800\";\n    case \"medium\":\n      return \"bg-blue-100 dark:bg-blue-950 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800\";\n    default:\n      return \"bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-700\";\n  }\n}\n\nexport default function ReturnDetail() {\n  const params = useParams();\n  const returnId = params.id;\n  const [, setLocation] = useLocation();\n  const [showAssignDialog, setShowAssignDialog] = useState(false);\n  const [selectedUserId, setSelectedUserId] = useState(\"\");\n  const [isUploadingPhoto, setIsUploadingPhoto] = useState(false);\n  const { toast } = useToast();\n\n  const { data: returnData, isLoading } = useQuery<Return>({\n    queryKey: [\"/api/returns\", returnId],\n    enabled: !!returnId,\n  });\n\n  const { data: users } = useQuery<any[]>({\n    queryKey: [\"/api/users/list\"],\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ status }: { status: string }) => {\n      return apiRequest(\"PATCH\", `/api/returns/${returnId}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\", returnId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n      toast({ title: \"Status updated successfully\" });\n    },\n    onError: () => {\n      toast({ \n        title: \"Failed to update status\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const updatePriorityMutation = useMutation({\n    mutationFn: async ({ priority }: { priority: string }) => {\n      return apiRequest(\"PATCH\", `/api/returns/${returnId}`, { priority });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\", returnId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n      toast({ title: \"Priority updated successfully\" });\n    },\n    onError: () => {\n      toast({ \n        title: \"Failed to update priority\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const assignUserMutation = useMutation({\n    mutationFn: async ({ userId }: { userId: string | null }) => {\n      return apiRequest(\"PATCH\", `/api/returns/${returnId}`, { assignedUserId: userId });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\", returnId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n      toast({ title: \"User assigned successfully\" });\n      setShowAssignDialog(false);\n      setSelectedUserId(\"\");\n    },\n    onError: () => {\n      toast({ \n        title: \"Failed to assign user\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  const handlePhotoUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    setIsUploadingPhoto(true);\n    try {\n      const formData = new FormData();\n      formData.append('photo', file);\n\n      const response = await fetch(`/api/returns/${returnId}/photos`, {\n        method: 'POST',\n        body: formData,\n      });\n\n      if (!response.ok) throw new Error('Upload failed');\n\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\", returnId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n      toast({ title: \"Photo uploaded successfully\" });\n    } catch (error) {\n      toast({ \n        title: \"Failed to upload photo\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsUploadingPhoto(false);\n      event.target.value = '';\n    }\n  };\n\n  const deletePhotoMutation = useMutation({\n    mutationFn: async (photoPath: string) => {\n      return apiRequest(\"DELETE\", `/api/returns/${returnId}/photos`, { photoPath });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\", returnId] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n      toast({ title: \"Photo deleted successfully\" });\n    },\n    onError: () => {\n      toast({ \n        title: \"Failed to delete photo\",\n        variant: \"destructive\"\n      });\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex flex-col h-screen bg-background\">\n        <Navigation />\n        <div className=\"flex-1 flex items-center justify-center\">\n          <div className=\"text-muted-foreground\">Loading...</div>\n        </div>\n      </div>\n    );\n  }\n\n  if (!returnData) {\n    return (\n      <div className=\"flex flex-col h-screen bg-background\">\n        <Navigation />\n        <div className=\"flex-1 flex items-center justify-center\">\n          <div className=\"text-center\">\n            <p className=\"text-muted-foreground\">Return not found</p>\n            <Button\n              onClick={() => setLocation(\"/returns\")}\n              variant=\"outline\"\n              className=\"mt-4\"\n              data-testid=\"button-back-to-returns\"\n            >\n              Back to Returns\n            </Button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  const statusLabel = STATUS_OPTIONS.find(s => s.value === returnData.status)?.label || returnData.status;\n  const priorityLabel = PRIORITY_OPTIONS.find(p => p.value === returnData.priority)?.label || returnData.priority;\n\n  return (\n    <div className=\"flex flex-col h-screen bg-background\">\n      <Navigation />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        <div className=\"container mx-auto p-6 max-w-7xl\">\n          <Button\n            variant=\"ghost\"\n            onClick={() => setLocation(\"/returns\")}\n            className=\"mb-4\"\n            data-testid=\"button-back\"\n          >\n            <ArrowLeft className=\"h-4 w-4 mr-2\" />\n            Back to Returns\n          </Button>\n\n          <div className=\"space-y-6\">\n            <div className=\"flex items-start justify-between\">\n              <div>\n                <h1 className=\"text-3xl font-bold text-foreground\" data-testid=\"text-return-number\">\n                  {returnData.returnNumber}\n                </h1>\n                <p className=\"text-muted-foreground mt-1\">\n                  {returnData.createdAt ? (\n                    <>Created {format(new Date(returnData.createdAt), \"PPP\")}</>\n                  ) : (\n                    \"No creation date\"\n                  )}\n                </p>\n              </div>\n              <div className=\"flex gap-2\">\n                <Badge className={getPriorityColor(returnData.priority)} data-testid={`badge-priority-${returnData.priority}`}>\n                  {priorityLabel}\n                </Badge>\n                <Badge className={getStatusColor(returnData.status)} data-testid={`badge-status-${returnData.status}`}>\n                  {statusLabel}\n                </Badge>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n              <Card>\n                <CardHeader className=\"bg-card-header border-b border-border\">\n                  <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                    <User className=\"h-4 w-4\" />\n                    Customer\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"pt-4\">\n                  <div className=\"space-y-2\">\n                    <div>\n                      <p className=\"text-sm font-medium\" data-testid=\"text-customer-name\">\n                        {returnData.customerName || \"Unknown\"}\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\" data-testid=\"text-customer-email\">\n                        {returnData.customerEmail || \"No email\"}\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"bg-card-header border-b border-border\">\n                  <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                    <ShoppingCart className=\"h-4 w-4\" />\n                    Order\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"pt-4\">\n                  {returnData.orderId ? (\n                    <div>\n                      <p className=\"text-sm font-medium\" data-testid=\"text-order-number\">\n                        {returnData.orderNumber || returnData.orderId}\n                      </p>\n                      <Button\n                        variant=\"link\"\n                        size=\"sm\"\n                        className=\"p-0 h-auto\"\n                        onClick={() => setLocation(`/orders`)}\n                        data-testid=\"link-view-order\"\n                      >\n                        View Order\n                      </Button>\n                    </div>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">No order linked</p>\n                  )}\n                </CardContent>\n              </Card>\n\n              <Card>\n                <CardHeader className=\"bg-card-header border-b border-border\">\n                  <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                    <User className=\"h-4 w-4\" />\n                    Assigned To\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className=\"pt-4\">\n                  {returnData.assignedUserId ? (\n                    <div className=\"flex items-center justify-between\">\n                      <p className=\"text-sm font-medium\" data-testid=\"text-assigned-user\">\n                        {returnData.assignedUserName || \"Unknown\"}\n                      </p>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => {\n                          setShowAssignDialog(true);\n                          setSelectedUserId(returnData.assignedUserId || \"\");\n                        }}\n                        data-testid=\"button-change-assignee\"\n                      >\n                        Change\n                      </Button>\n                    </div>\n                  ) : (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setShowAssignDialog(true)}\n                      data-testid=\"button-assign-user\"\n                    >\n                      Assign User\n                    </Button>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n\n            <Tabs defaultValue=\"overview\" className=\"w-full\">\n              <TabsList>\n                <TabsTrigger value=\"overview\" data-testid=\"tab-overview\">Overview</TabsTrigger>\n                <TabsTrigger value=\"items\" data-testid=\"tab-items\">Items</TabsTrigger>\n                <TabsTrigger value=\"photos\" data-testid=\"tab-photos\">Photos</TabsTrigger>\n                <TabsTrigger value=\"timeline\" data-testid=\"tab-timeline\">Timeline</TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"overview\" className=\"space-y-6 mt-6\">\n                <Card>\n                  <CardHeader className=\"bg-card-header border-b border-border\">\n                    <CardTitle>Return Details</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"pt-6 space-y-6\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground\">Status</label>\n                        <Select\n                          value={returnData.status}\n                          onValueChange={(value) => updateStatusMutation.mutate({ status: value })}\n                        >\n                          <SelectTrigger className=\"mt-1\" data-testid=\"select-status\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {STATUS_OPTIONS.map((option) => (\n                              <SelectItem key={option.value} value={option.value}>\n                                {option.label}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground\">Priority</label>\n                        <Select\n                          value={returnData.priority}\n                          onValueChange={(value) => updatePriorityMutation.mutate({ priority: value })}\n                        >\n                          <SelectTrigger className=\"mt-1\" data-testid=\"select-priority\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {PRIORITY_OPTIONS.map((option) => (\n                              <SelectItem key={option.value} value={option.value}>\n                                {option.label}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground\">Reason</label>\n                        <p className=\"mt-1 text-sm\" data-testid=\"text-reason\">{returnData.reason}</p>\n                      </div>\n\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground\">Tracking Number</label>\n                        <p className=\"mt-1 text-sm\" data-testid=\"text-tracking-number\">\n                          {returnData.trackingNumber || \"N/A\"}\n                        </p>\n                      </div>\n\n                      {returnData.receivedDate && (\n                        <div>\n                          <label className=\"text-sm font-medium text-muted-foreground\">Received Date</label>\n                          <p className=\"mt-1 text-sm\" data-testid=\"text-received-date\">\n                            {format(new Date(returnData.receivedDate), \"PPP\")}\n                          </p>\n                        </div>\n                      )}\n\n                      {returnData.completedDate && (\n                        <div>\n                          <label className=\"text-sm font-medium text-muted-foreground\">Completed Date</label>\n                          <p className=\"mt-1 text-sm\" data-testid=\"text-completed-date\">\n                            {format(new Date(returnData.completedDate), \"PPP\")}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n\n                    {returnData.internalNotes && (\n                      <div>\n                        <label className=\"text-sm font-medium text-muted-foreground\">Internal Notes</label>\n                        <p className=\"mt-1 text-sm whitespace-pre-wrap\" data-testid=\"text-internal-notes\">\n                          {returnData.internalNotes}\n                        </p>\n                      </div>\n                    )}\n\n                    {returnData.refundAmount != null && (\n                      <div className=\"border-t border-border pt-6\">\n                        <h3 className=\"text-lg font-semibold mb-4\">Refund Information</h3>\n                        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                          <div>\n                            <label className=\"text-sm font-medium text-muted-foreground\">Refund Amount</label>\n                            <p className=\"mt-1 text-lg font-medium\" data-testid=\"text-refund-amount\">\n                              ‚Ç¨{returnData.refundAmount.toFixed(2)}\n                            </p>\n                          </div>\n                          {returnData.refundMethod && (\n                            <div>\n                              <label className=\"text-sm font-medium text-muted-foreground\">Refund Method</label>\n                              <p className=\"mt-1 text-sm\" data-testid=\"text-refund-method\">\n                                {returnData.refundMethod}\n                              </p>\n                            </div>\n                          )}\n                          {returnData.refundStatus && (\n                            <div>\n                              <label className=\"text-sm font-medium text-muted-foreground\">Refund Status</label>\n                              <p className=\"mt-1 text-sm\" data-testid=\"text-refund-status\">\n                                {returnData.refundStatus}\n                              </p>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"items\" className=\"mt-6\">\n                <Card>\n                  <CardHeader className=\"bg-card-header border-b border-border\">\n                    <CardTitle>Return Items</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"pt-6\">\n                    {returnData.returnItems && returnData.returnItems.length > 0 ? (\n                      <div className=\"space-y-4\">\n                        {returnData.returnItems.map((item) => (\n                          <div\n                            key={item.id}\n                            className=\"border border-border rounded-lg p-4\"\n                            data-testid={`item-${item.id}`}\n                          >\n                            <div className=\"flex justify-between items-start\">\n                              <div className=\"flex-1\">\n                                <h4 className=\"font-medium\" data-testid={`text-item-name-${item.id}`}>\n                                  {item.productName}\n                                </h4>\n                                {item.sku && (\n                                  <p className=\"text-sm text-muted-foreground mt-1\" data-testid={`text-item-sku-${item.id}`}>\n                                    SKU: {item.sku}\n                                  </p>\n                                )}\n                                <div className=\"flex gap-4 mt-2\">\n                                  <div>\n                                    <span className=\"text-sm font-medium\">Quantity:</span>{\" \"}\n                                    <span className=\"text-sm\" data-testid={`text-item-quantity-${item.id}`}>{item.quantity}</span>\n                                  </div>\n                                  <div>\n                                    <span className=\"text-sm font-medium\">Reason:</span>{\" \"}\n                                    <span className=\"text-sm\" data-testid={`text-item-reason-${item.id}`}>{item.reason}</span>\n                                  </div>\n                                </div>\n                                {item.condition && (\n                                  <p className=\"text-sm mt-2\">\n                                    <span className=\"font-medium\">Condition:</span>{\" \"}\n                                    <span data-testid={`text-item-condition-${item.id}`}>{item.condition}</span>\n                                  </p>\n                                )}\n                                {item.notes && (\n                                  <p className=\"text-sm mt-2\">\n                                    <span className=\"font-medium\">Notes:</span>{\" \"}\n                                    <span data-testid={`text-item-notes-${item.id}`}>{item.notes}</span>\n                                  </p>\n                                )}\n                              </div>\n                              {item.refundAmount != null && (\n                                <div className=\"text-right\">\n                                  <p className=\"text-lg font-medium\" data-testid={`text-item-refund-${item.id}`}>\n                                    ‚Ç¨{item.refundAmount.toFixed(2)}\n                                  </p>\n                                </div>\n                              )}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <p className=\"text-muted-foreground text-center py-8\">No items found</p>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"photos\" className=\"mt-6\">\n                <Card>\n                  <CardHeader className=\"bg-card-header border-b border-border\">\n                    <div className=\"flex items-center justify-between\">\n                      <CardTitle className=\"flex items-center gap-2\">\n                        <Camera className=\"h-5 w-5\" />\n                        Return Photos\n                      </CardTitle>\n                      <div>\n                        <input\n                          type=\"file\"\n                          id=\"photo-upload\"\n                          accept=\"image/*\"\n                          className=\"hidden\"\n                          onChange={handlePhotoUpload}\n                          disabled={isUploadingPhoto}\n                        />\n                        <Button\n                          onClick={() => document.getElementById('photo-upload')?.click()}\n                          disabled={isUploadingPhoto}\n                          size=\"sm\"\n                          data-testid=\"button-upload-photo\"\n                        >\n                          <Upload className=\"mr-2 h-4 w-4\" />\n                          {isUploadingPhoto ? \"Uploading...\" : \"Upload Photo\"}\n                        </Button>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"pt-6\">\n                    {!returnData.photoUrls || returnData.photoUrls.length === 0 ? (\n                      <div className=\"text-center py-12\">\n                        <Image className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n                        <p className=\"text-muted-foreground\">No photos uploaded yet</p>\n                        <p className=\"text-sm text-muted-foreground mt-2\">\n                          Upload photos to document the condition of returned items\n                        </p>\n                      </div>\n                    ) : (\n                      <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                        {returnData.photoUrls.map((photoPath, index) => (\n                          <div key={index} className=\"relative group\">\n                            <img\n                              src={`/api/attachments${photoPath}`}\n                              alt={`Return photo ${index + 1}`}\n                              className=\"w-full h-48 object-cover rounded-lg border border-border\"\n                              data-testid={`image-photo-${index}`}\n                            />\n                            <Button\n                              variant=\"danger\"\n                              size=\"sm\"\n                              className=\"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity\"\n                              onClick={() => deletePhotoMutation.mutate(photoPath)}\n                              disabled={deletePhotoMutation.isPending}\n                              data-testid={`button-delete-photo-${index}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"timeline\" className=\"mt-6\">\n                <Card>\n                  <CardHeader className=\"bg-card-header border-b border-border\">\n                    <CardTitle>Timeline</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"space-y-4\">\n                      {returnData.createdAt && (\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex flex-col items-center\">\n                            <div className=\"w-2 h-2 rounded-full bg-primary\" />\n                            <div className=\"w-0.5 h-full bg-border\" />\n                          </div>\n                          <div className=\"flex-1 pb-8\">\n                            <p className=\"text-sm font-medium\">Return Created</p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {format(new Date(returnData.createdAt), \"PPP 'at' p\")}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n                      {returnData.receivedDate && (\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex flex-col items-center\">\n                            <div className=\"w-2 h-2 rounded-full bg-primary\" />\n                            <div className=\"w-0.5 h-full bg-border\" />\n                          </div>\n                          <div className=\"flex-1 pb-8\">\n                            <p className=\"text-sm font-medium\">Package Received</p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {format(new Date(returnData.receivedDate), \"PPP 'at' p\")}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n                      {returnData.completedDate && (\n                        <div className=\"flex gap-4\">\n                          <div className=\"flex flex-col items-center\">\n                            <div className=\"w-2 h-2 rounded-full bg-green-500\" />\n                          </div>\n                          <div className=\"flex-1\">\n                            <p className=\"text-sm font-medium\">Return Completed</p>\n                            <p className=\"text-xs text-muted-foreground\">\n                              {format(new Date(returnData.completedDate), \"PPP 'at' p\")}\n                            </p>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              </TabsContent>\n            </Tabs>\n          </div>\n        </div>\n      </main>\n\n      {showAssignDialog && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <Card className=\"w-full max-w-md m-4\">\n            <CardHeader className=\"bg-card-header border-b border-border\">\n              <CardTitle>Assign User</CardTitle>\n            </CardHeader>\n            <CardContent className=\"pt-6 space-y-4\">\n              <div>\n                <label className=\"text-sm font-medium\">Select User</label>\n                <Select value={selectedUserId} onValueChange={setSelectedUserId}>\n                  <SelectTrigger className=\"mt-1\" data-testid=\"select-assign-user\">\n                    <SelectValue placeholder=\"Select a user...\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {users?.map((user) => (\n                      <SelectItem key={user.id} value={user.id}>\n                        {user.username} ({user.fullName})\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"flex gap-2 justify-end\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    setShowAssignDialog(false);\n                    setSelectedUserId(\"\");\n                  }}\n                  data-testid=\"button-cancel-assign\"\n                >\n                  Cancel\n                </Button>\n                <Button\n                  onClick={() => assignUserMutation.mutate({ userId: selectedUserId })}\n                  disabled={!selectedUserId || assignUserMutation.isPending}\n                  data-testid=\"button-confirm-assign\"\n                >\n                  {assignUserMutation.isPending ? \"Assigning...\" : \"Assign\"}\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":32987},"client/src/components/purchase-orders/purchase-order-context-menu.tsx":{"content":"import { ReactNode, MouseEvent } from \"react\";\nimport { Archive, Eye, Trash2, ListChecks } from \"lucide-react\";\nimport {\n  ContextMenu,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuSeparator,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuTrigger,\n} from \"@/components/ui/context-menu\";\n\ninterface PurchaseOrderContextMenuProps {\n  children: ReactNode;\n  purchaseOrderId: string;\n  currentStatus: string;\n  isArchived?: boolean;\n  onOpen: (purchaseOrderId: string) => void;\n  onArchive: (purchaseOrderId: string) => void;\n  onUnarchive: (purchaseOrderId: string) => void;\n  onDelete: (purchaseOrderId: string) => void;\n  onStatusChange: (purchaseOrderId: string, newStatus: string) => void;\n}\n\nexport function PurchaseOrderContextMenu({ \n  children, \n  purchaseOrderId,\n  currentStatus,\n  isArchived = false,\n  onOpen, \n  onArchive, \n  onUnarchive,\n  onDelete,\n  onStatusChange\n}: PurchaseOrderContextMenuProps) {\n  const handleOpen = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    onOpen(purchaseOrderId);\n  };\n\n  const handleArchive = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (isArchived) {\n      onUnarchive(purchaseOrderId);\n    } else {\n      onArchive(purchaseOrderId);\n    }\n  };\n\n  const handleDelete = (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    onDelete(purchaseOrderId);\n  };\n\n  const handleStatusChange = (newStatus: string) => (e: MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    onStatusChange(purchaseOrderId, newStatus);\n  };\n\n  return (\n    <ContextMenu>\n      <ContextMenuTrigger asChild>{children}</ContextMenuTrigger>\n      <ContextMenuContent className=\"w-56\" data-testid={`context-menu-${purchaseOrderId}`}>\n        <ContextMenuItem onClick={handleOpen} data-testid={`context-menu-open-${purchaseOrderId}`}>\n          <Eye className=\"mr-2 h-4 w-4\" />\n          Open\n        </ContextMenuItem>\n        \n        <ContextMenuSeparator />\n        \n        <ContextMenuSub>\n          <ContextMenuSubTrigger data-testid={`context-menu-status-${purchaseOrderId}`}>\n            <ListChecks className=\"mr-2 h-4 w-4\" />\n            Wijzig Status\n          </ContextMenuSubTrigger>\n          <ContextMenuSubContent>\n            <ContextMenuItem \n              onClick={handleStatusChange(\"aangekocht\")}\n              disabled={currentStatus === \"aangekocht\"}\n              data-testid={`context-menu-status-aangekocht-${purchaseOrderId}`}\n            >\n              Aangekocht\n            </ContextMenuItem>\n            <ContextMenuItem \n              onClick={handleStatusChange(\"ontvangen\")}\n              disabled={currentStatus === \"ontvangen\"}\n              data-testid={`context-menu-status-ontvangen-${purchaseOrderId}`}\n            >\n              Ontvangen\n            </ContextMenuItem>\n            <ContextMenuItem \n              onClick={handleStatusChange(\"verwerkt\")}\n              disabled={currentStatus === \"verwerkt\"}\n              data-testid={`context-menu-status-verwerkt-${purchaseOrderId}`}\n            >\n              Verwerkt\n            </ContextMenuItem>\n          </ContextMenuSubContent>\n        </ContextMenuSub>\n        \n        <ContextMenuSeparator />\n        \n        <ContextMenuItem onClick={handleArchive} data-testid={`context-menu-archive-${purchaseOrderId}`}>\n          <Archive className=\"mr-2 h-4 w-4\" />\n          {isArchived ? \"Unarchive\" : \"Archive\"}\n        </ContextMenuItem>\n        \n        <ContextMenuSeparator />\n        \n        <ContextMenuItem \n          onClick={handleDelete} \n          className=\"text-destructive focus:text-destructive\"\n          data-testid={`context-menu-delete-${purchaseOrderId}`}\n        >\n          <Trash2 className=\"mr-2 h-4 w-4\" />\n          Delete\n        </ContextMenuItem>\n      </ContextMenuContent>\n    </ContextMenu>\n  );\n}\n","size_bytes":3884},"client/src/components/ui/info-banner.tsx":{"content":"import { ReactNode } from \"react\";\nimport { AlertCircle, Info, AlertTriangle, CheckCircle } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\nexport type BannerVariant = \"info\" | \"warning\" | \"error\" | \"success\" | \"brand\";\n\ninterface InfoBannerProps {\n  variant?: BannerVariant;\n  title?: string;\n  children: ReactNode;\n  className?: string;\n}\n\nconst variantStyles: Record<BannerVariant, { container: string; icon: ReactNode }> = {\n  info: {\n    container: \"bg-blue-50 dark:bg-blue-950 text-blue-900 dark:text-blue-100 border-blue-200 dark:border-blue-800\",\n    icon: <Info className=\"h-4 w-4 text-blue-600 dark:text-blue-400\" />,\n  },\n  warning: {\n    container: \"bg-yellow-50 dark:bg-yellow-950 text-yellow-900 dark:text-yellow-100 border-yellow-200 dark:border-yellow-800\",\n    icon: <AlertTriangle className=\"h-4 w-4 text-yellow-600 dark:text-yellow-400\" />,\n  },\n  error: {\n    container: \"bg-red-50 dark:bg-red-950 text-red-900 dark:text-red-100 border-red-200 dark:border-red-800\",\n    icon: <AlertCircle className=\"h-4 w-4 text-red-600 dark:text-red-400\" />,\n  },\n  success: {\n    container: \"bg-green-50 dark:bg-green-950 text-green-900 dark:text-green-100 border-green-200 dark:border-green-800\",\n    icon: <CheckCircle className=\"h-4 w-4 text-green-600 dark:text-green-400\" />,\n  },\n  brand: {\n    container: \"bg-[var(--brand-orange-100)] text-[var(--brand-orange-700)] border border-[var(--brand-orange-600)]\",\n    icon: <Info className=\"h-4 w-4\" style={{ color: \"var(--brand-orange-600)\" }} />,\n  },\n};\n\nexport function InfoBanner({ variant = \"info\", title, children, className }: InfoBannerProps) {\n  const styles = variantStyles[variant];\n\n  return (\n    <div\n      className={cn(\"rounded-lg border p-4\", styles.container, className)}\n      data-testid={`info-banner-${variant}`}\n    >\n      <div className=\"flex gap-3\">\n        <div className=\"flex-shrink-0 mt-0.5\">{styles.icon}</div>\n        <div className=\"flex-1\">\n          {title && (\n            <h3 className=\"text-sm font-semibold mb-1\" data-testid=\"banner-title\">\n              {title}\n            </h3>\n          )}\n          <div className=\"text-sm\" data-testid=\"banner-content\">\n            {children}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":2249},"client/src/components/notes/NoteComposer.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useEditor, EditorContent } from \"@tiptap/react\";\nimport StarterKit from \"@tiptap/starter-kit\";\nimport Underline from \"@tiptap/extension-underline\";\nimport Link from \"@tiptap/extension-link\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Send, Bold, Italic, UnderlineIcon, List, ListOrdered, Link as LinkIcon, X, FileText } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { format } from \"date-fns\";\n\ninterface NoteTemplate {\n  id: string;\n  name: string;\n  content: string;\n  description?: string | null;\n}\n\ninterface NoteComposerProps {\n  onSubmit: (note: { content: string; plainText: string; tagIds: string[] }) => void;\n  isPending?: boolean;\n  placeholder?: string;\n  availableTags?: Array<{ id: string; name: string; color: string | null }>;\n  className?: string;\n  contextData?: {\n    orderNumber?: string;\n    customerName?: string;\n    [key: string]: any;\n  };\n}\n\nexport function NoteComposer({ onSubmit, isPending, placeholder = \"Add a note...\", availableTags = [], className, contextData = {} }: NoteComposerProps) {\n  const [selectedTags, setSelectedTags] = useState<string[]>([]);\n\n  const { data: templates = [] } = useQuery<NoteTemplate[]>({\n    queryKey: [\"/api/note-templates\"],\n  });\n\n  const editor = useEditor({\n    extensions: [\n      StarterKit,\n      Underline,\n      Link.configure({\n        openOnClick: false,\n        HTMLAttributes: {\n          class: \"text-blue-600 dark:text-blue-400 underline cursor-pointer\",\n        },\n      }),\n    ],\n    content: \"\",\n    editorProps: {\n      attributes: {\n        class: \"prose dark:prose-invert max-w-none focus:outline-none min-h-[80px] px-3 py-2 text-sm\",\n      },\n    },\n  });\n\n  const handleSubmit = () => {\n    if (!editor) return;\n\n    const content = editor.getHTML();\n    const plainText = editor.getText();\n\n    if (!plainText.trim()) return;\n\n    onSubmit({\n      content,\n      plainText,\n      tagIds: selectedTags,\n    });\n\n    editor.commands.clearContent();\n    setSelectedTags([]);\n  };\n\n  // Keyboard shortcuts\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if ((e.ctrlKey || e.metaKey) && e.key === \"Enter\") {\n      e.preventDefault();\n      handleSubmit();\n    }\n  };\n\n  const toggleTag = (tagId: string) => {\n    setSelectedTags((prev) =>\n      prev.includes(tagId) ? prev.filter((id) => id !== tagId) : [...prev, tagId]\n    );\n  };\n\n  const substituteVariables = (content: string): string => {\n    let substituted = content;\n    \n    if (contextData.orderNumber) {\n      substituted = substituted.replace(/\\{\\{orderNumber\\}\\}/g, contextData.orderNumber);\n    }\n    \n    if (contextData.customerName) {\n      substituted = substituted.replace(/\\{\\{customerName\\}\\}/g, contextData.customerName);\n    }\n    \n    substituted = substituted.replace(/\\{\\{today\\}\\}/g, format(new Date(), \"MMMM d, yyyy\"));\n    \n    return substituted;\n  };\n\n  const handleTemplateSelect = (templateId: string) => {\n    const template = templates.find((t) => t.id === templateId);\n    if (template && editor) {\n      const content = substituteVariables(template.content);\n      editor.commands.setContent(content);\n      editor.commands.focus();\n    }\n  };\n\n  const selectedTagObjects = availableTags.filter((tag) => selectedTags.includes(tag.id));\n\n  return (\n    <div \n      className={cn(\"border rounded-lg bg-card\", className)} \n      data-testid=\"note-composer\"\n      onKeyDown={handleKeyDown}\n      role=\"form\"\n      aria-label=\"Note composer\"\n    >\n      <div className=\"border-b p-2 flex items-center gap-2 bg-muted/50\" role=\"toolbar\" aria-label=\"Formatting toolbar\">\n        <button\n          type=\"button\"\n          onClick={() => editor?.chain().focus().toggleBold().run()}\n          className={cn(\n            \"p-1.5 rounded hover:bg-accent\",\n            editor?.isActive(\"bold\") && \"bg-accent\"\n          )}\n          data-testid=\"note-composer-bold\"\n        >\n          <Bold className=\"h-4 w-4\" />\n        </button>\n        <button\n          type=\"button\"\n          onClick={() => editor?.chain().focus().toggleItalic().run()}\n          className={cn(\n            \"p-1.5 rounded hover:bg-accent\",\n            editor?.isActive(\"italic\") && \"bg-accent\"\n          )}\n          data-testid=\"note-composer-italic\"\n        >\n          <Italic className=\"h-4 w-4\" />\n        </button>\n        <button\n          type=\"button\"\n          onClick={() => editor?.chain().focus().toggleUnderline().run()}\n          className={cn(\n            \"p-1.5 rounded hover:bg-accent\",\n            editor?.isActive(\"underline\") && \"bg-accent\"\n          )}\n          data-testid=\"note-composer-underline\"\n        >\n          <UnderlineIcon className=\"h-4 w-4\" />\n        </button>\n        <div className=\"w-px h-4 bg-border\" />\n        <button\n          type=\"button\"\n          onClick={() => editor?.chain().focus().toggleBulletList().run()}\n          className={cn(\n            \"p-1.5 rounded hover:bg-accent\",\n            editor?.isActive(\"bulletList\") && \"bg-accent\"\n          )}\n          data-testid=\"note-composer-bullet-list\"\n        >\n          <List className=\"h-4 w-4\" />\n        </button>\n        <button\n          type=\"button\"\n          onClick={() => editor?.chain().focus().toggleOrderedList().run()}\n          className={cn(\n            \"p-1.5 rounded hover:bg-accent\",\n            editor?.isActive(\"orderedList\") && \"bg-accent\"\n          )}\n          data-testid=\"note-composer-ordered-list\"\n        >\n          <ListOrdered className=\"h-4 w-4\" />\n        </button>\n        <button\n          type=\"button\"\n          onClick={() => {\n            const url = window.prompt(\"Enter URL:\");\n            if (url) {\n              editor?.chain().focus().setLink({ href: url }).run();\n            }\n          }}\n          className={cn(\n            \"p-1.5 rounded hover:bg-accent\",\n            editor?.isActive(\"link\") && \"bg-accent\"\n          )}\n          data-testid=\"note-composer-link\"\n        >\n          <LinkIcon className=\"h-4 w-4\" />\n        </button>\n        {templates.length > 0 && (\n          <>\n            <div className=\"w-px h-4 bg-border\" />\n            <Select value=\"\" onValueChange={handleTemplateSelect}>\n              <SelectTrigger className=\"w-auto h-auto p-1.5 border-0 hover:bg-accent\" data-testid=\"note-composer-template\">\n                <FileText className=\"h-4 w-4\" />\n              </SelectTrigger>\n              <SelectContent>\n                {templates.map((template) => (\n                  <SelectItem key={template.id} value={template.id}>\n                    <div className=\"flex flex-col\">\n                      <span className=\"font-medium\">{template.name}</span>\n                      {template.description && (\n                        <span className=\"text-xs text-muted-foreground\">{template.description}</span>\n                      )}\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </>\n        )}\n      </div>\n\n      <EditorContent editor={editor} />\n\n      <div className=\"border-t p-3 bg-muted/50 flex items-center justify-between gap-3\">\n        <div className=\"flex items-center gap-2 flex-1 flex-wrap\">\n          {selectedTagObjects.map((tag) => {\n            const tagColor = tag.color || \"#64748b\";\n            return (\n              <Badge\n                key={tag.id}\n                variant=\"secondary\"\n                className=\"gap-1\"\n                style={{ backgroundColor: tagColor + \"20\", color: tagColor, borderColor: tagColor }}\n                data-testid={`note-composer-tag-${tag.id}`}\n              >\n                {tag.name}\n                <button\n                  type=\"button\"\n                  onClick={() => toggleTag(tag.id)}\n                  className=\"hover:bg-black/10 rounded-full p-0.5\"\n                >\n                  <X className=\"h-3 w-3\" />\n                </button>\n              </Badge>\n            );\n          })}\n\n          {availableTags.length > 0 && selectedTags.length < availableTags.length && (\n            <Select value=\"\" onValueChange={toggleTag}>\n              <SelectTrigger className=\"w-[100px] h-8\" data-testid=\"note-composer-add-tag\">\n                <SelectValue placeholder=\"Add tag...\" />\n              </SelectTrigger>\n              <SelectContent>\n                {availableTags\n                  .filter((tag) => !selectedTags.includes(tag.id))\n                  .map((tag) => (\n                    <SelectItem key={tag.id} value={tag.id}>\n                      <div className=\"flex items-center gap-2\">\n                        <div\n                          className=\"w-3 h-3 rounded-full\"\n                          style={{ backgroundColor: tag.color || \"#64748b\" }}\n                        />\n                        {tag.name}\n                      </div>\n                    </SelectItem>\n                  ))}\n              </SelectContent>\n            </Select>\n          )}\n        </div>\n\n        <Button\n          size=\"sm\"\n          onClick={handleSubmit}\n          disabled={isPending || !editor?.getText().trim()}\n          data-testid=\"note-composer-submit\"\n          aria-label=\"Submit note (Ctrl+Enter)\"\n        >\n          <Send className=\"h-4 w-4\" />\n        </Button>\n      </div>\n    </div>\n  );\n}\n","size_bytes":9476},"client/src/components/ui/status-chip.tsx":{"content":"import { cn } from \"@/lib/utils\";\n\nexport type StatusVariant =\n  | \"return_in_progress\"\n  | \"paid\"\n  | \"fulfilled\"\n  | \"received_control\"\n  | \"approved_refund\"\n  | \"missing_package\"\n  | \"waiting_customer\"\n  | \"reship\"\n  | \"closed_not_received\"\n  | \"default\";\n\ninterface StatusChipProps {\n  variant: StatusVariant;\n  label: string;\n  className?: string;\n}\n\nconst variantStyles: Record<StatusVariant, string> = {\n  return_in_progress: \"bg-[var(--brand-orange-100)] text-[var(--brand-orange-700)] border-[var(--brand-orange-600)]\",\n  paid: \"bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-300 dark:border-slate-600\",\n  fulfilled: \"bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-300 dark:border-slate-600\",\n  received_control: \"bg-orange-50 dark:bg-orange-950 text-orange-700 dark:text-orange-300 border-orange-200 dark:border-orange-800\",\n  approved_refund: \"bg-green-50 dark:bg-green-950 text-green-700 dark:text-green-300 border-green-200 dark:border-green-800\",\n  missing_package: \"bg-red-50 dark:bg-red-950 text-red-700 dark:text-red-300 border-red-200 dark:border-red-800\",\n  waiting_customer: \"bg-yellow-50 dark:bg-yellow-950 text-yellow-700 dark:text-yellow-300 border-yellow-200 dark:border-yellow-800\",\n  reship: \"bg-purple-50 dark:bg-purple-950 text-purple-700 dark:text-purple-300 border-purple-200 dark:border-purple-800\",\n  closed_not_received: \"bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 border-slate-200 dark:border-slate-700\",\n  default: \"bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-300 dark:border-slate-600\",\n};\n\nexport function StatusChip({ variant, label, className }: StatusChipProps) {\n  return (\n    <span\n      className={cn(\n        \"inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium border\",\n        variantStyles[variant],\n        className\n      )}\n      data-testid={`status-chip-${variant}`}\n    >\n      {label}\n    </span>\n  );\n}\n","size_bytes":2001},"client/src/components/notes/NoteItem.tsx":{"content":"import { useState } from \"react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Pin, MoreVertical, Reply, Edit, Trash, AlertCircle } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { Note, NoteTag, User } from \"@shared/schema\";\n\ninterface NoteItemProps {\n  note: Note & { author?: User; tags?: NoteTag[] };\n  currentUserId: string;\n  onReply?: (noteId: string) => void;\n  onEdit?: (noteId: string) => void;\n  onDelete?: (noteId: string) => void;\n  onPin?: (noteId: string) => void;\n  onUnpin?: (noteId: string) => void;\n  onReact?: (noteId: string, emoji: string) => void;\n  className?: string;\n}\n\nexport function NoteItem({\n  note,\n  currentUserId,\n  onReply,\n  onEdit,\n  onDelete,\n  onPin,\n  onUnpin,\n  onReact,\n  className,\n}: NoteItemProps) {\n  const [isExpanded, setIsExpanded] = useState(true);\n\n  const isAuthor = note.authorId === currentUserId;\n  const isPinned = note.isPinned;\n\n  const authorInitials = note.author\n    ? `${note.author.username[0]}${note.author.email[0]}`.toUpperCase()\n    : \"?\";\n\n  return (\n    <div\n      className={cn(\n        \"border rounded-lg bg-card\",\n        isPinned && \"border-[var(--brand-orange-600)] shadow-sm\",\n        note.deletedAt && \"opacity-50\",\n        className\n      )}\n      data-testid={`note-item-${note.id}`}\n    >\n      <div className=\"p-4\">\n        <div className=\"flex items-start gap-3\">\n          <Avatar className=\"h-8 w-8\">\n            <AvatarFallback className=\"text-xs bg-muted\">\n              {authorInitials}\n            </AvatarFallback>\n          </Avatar>\n\n          <div className=\"flex-1 min-w-0\">\n            <div className=\"flex items-center gap-2 mb-1\">\n              <span className=\"text-sm font-medium\" data-testid=\"note-author\">\n                {note.author?.username || \"Unknown\"}\n              </span>\n              <span className=\"text-xs text-muted-foreground\" data-testid=\"note-timestamp\">\n                {note.createdAt ? formatDistanceToNow(new Date(note.createdAt), { addSuffix: true }) : \"Recently\"}\n              </span>\n              {note.editedAt && (\n                <span className=\"text-xs text-muted-foreground\">(edited)</span>\n              )}\n              {isPinned && (\n                <Pin className=\"h-3 w-3 text-[var(--brand-orange-600)]\" data-testid=\"note-pinned-icon\" />\n              )}\n            </div>\n\n            {note.tags && note.tags.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {note.tags.map((tag) => (\n                  <Badge\n                    key={tag.id}\n                    variant=\"outline\"\n                    className=\"text-xs h-5\"\n                    style={tag.color ? { backgroundColor: tag.color + \"20\", borderColor: tag.color, color: tag.color } : undefined}\n                    data-testid={`note-tag-${tag.id}`}\n                  >\n                    {tag.name}\n                  </Badge>\n                ))}\n              </div>\n            )}\n\n            <div\n              className={cn(\n                \"prose prose-sm dark:prose-invert max-w-none\",\n                !isExpanded && \"line-clamp-3\"\n              )}\n              dangerouslySetInnerHTML={{ __html: note.renderedHtml || note.content }}\n              data-testid=\"note-content\"\n            />\n\n            {note.plainText && note.plainText.length > 200 && (\n              <button\n                onClick={() => setIsExpanded(!isExpanded)}\n                className=\"text-xs text-blue-600 dark:text-blue-400 mt-1 hover:underline\"\n                data-testid=\"note-expand-toggle\"\n              >\n                {isExpanded ? \"Show less\" : \"Show more\"}\n              </button>\n            )}\n\n            {note.deletedAt && (\n              <div className=\"mt-2 flex items-center gap-2 text-sm text-red-600 dark:text-red-400\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <span>Deleted by {note.deletedBy}</span>\n                {note.deleteReason && <span>‚Ä¢ {note.deleteReason}</span>}\n              </div>\n            )}\n          </div>\n\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"ghost\" size=\"sm\" className=\"h-8 w-8 p-0\" data-testid=\"note-menu\">\n                <MoreVertical className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              {onReply && (\n                <DropdownMenuItem onClick={() => onReply(note.id)} data-testid=\"note-menu-reply\">\n                  <Reply className=\"h-4 w-4 mr-2\" />\n                  Reply\n                </DropdownMenuItem>\n              )}\n              {isAuthor && onEdit && !note.deletedAt && (\n                <DropdownMenuItem onClick={() => onEdit(note.id)} data-testid=\"note-menu-edit\">\n                  <Edit className=\"h-4 w-4 mr-2\" />\n                  Edit\n                </DropdownMenuItem>\n              )}\n              {!note.deletedAt && (\n                <>\n                  {isPinned ? (\n                    <DropdownMenuItem onClick={() => onUnpin?.(note.id)} data-testid=\"note-menu-unpin\">\n                      <Pin className=\"h-4 w-4 mr-2\" />\n                      Unpin\n                    </DropdownMenuItem>\n                  ) : (\n                    <DropdownMenuItem onClick={() => onPin?.(note.id)} data-testid=\"note-menu-pin\">\n                      <Pin className=\"h-4 w-4 mr-2\" />\n                      Pin\n                    </DropdownMenuItem>\n                  )}\n                </>\n              )}\n              {isAuthor && onDelete && !note.deletedAt && (\n                <DropdownMenuItem onClick={() => onDelete(note.id)} className=\"text-red-600 dark:text-red-400\" data-testid=\"note-menu-delete\">\n                  <Trash className=\"h-4 w-4 mr-2\" />\n                  Delete\n                </DropdownMenuItem>\n              )}\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n\n        {onReact && !note.deletedAt && (\n          <div className=\"flex items-center gap-2 mt-3 pt-3 border-t\">\n            <button\n              onClick={() => onReact(note.id, \"üëç\")}\n              className=\"text-sm hover:bg-accent px-2 py-1 rounded\"\n              data-testid=\"note-react-thumbsup\"\n            >\n              üëç\n            </button>\n            <button\n              onClick={() => onReact(note.id, \"üëÄ\")}\n              className=\"text-sm hover:bg-accent px-2 py-1 rounded\"\n              data-testid=\"note-react-eyes\"\n            >\n              üëÄ\n            </button>\n            <button\n              onClick={() => onReact(note.id, \"‚úÖ\")}\n              className=\"text-sm hover:bg-accent px-2 py-1 rounded\"\n              data-testid=\"note-react-check\"\n            >\n              ‚úÖ\n            </button>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":7122},"client/src/components/ui/item-row.tsx":{"content":"import { ReactNode } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ItemRowProps {\n  image?: string;\n  imageAlt?: string;\n  imageFallback?: ReactNode;\n  title: string;\n  subtitle?: string;\n  meta?: ReactNode;\n  actions?: ReactNode;\n  className?: string;\n}\n\nexport function ItemRow({\n  image,\n  imageAlt,\n  imageFallback,\n  title,\n  subtitle,\n  meta,\n  actions,\n  className,\n}: ItemRowProps) {\n  return (\n    <div className={cn(\"flex items-center gap-3 py-3\", className)} data-testid=\"item-row\">\n      {(image || imageFallback) && (\n        <div className=\"flex-shrink-0\" data-testid=\"item-row-image\">\n          {image ? (\n            <img\n              src={image}\n              alt={imageAlt || title}\n              className=\"h-12 w-12 rounded-md border object-cover\"\n            />\n          ) : (\n            <div className=\"h-12 w-12 rounded-md border bg-muted flex items-center justify-center\">\n              {imageFallback}\n            </div>\n          )}\n        </div>\n      )}\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-start justify-between gap-2\">\n          <div className=\"min-w-0\">\n            <p className=\"text-sm font-medium truncate\" data-testid=\"item-row-title\">\n              {title}\n            </p>\n            {subtitle && (\n              <p className=\"text-sm text-muted-foreground truncate\" data-testid=\"item-row-subtitle\">\n                {subtitle}\n              </p>\n            )}\n          </div>\n          {meta && (\n            <div className=\"flex-shrink-0 text-right\" data-testid=\"item-row-meta\">\n              {meta}\n            </div>\n          )}\n        </div>\n      </div>\n      {actions && (\n        <div className=\"flex-shrink-0\" data-testid=\"item-row-actions\">\n          {actions}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":1808},"client/src/components/ui/key-value.tsx":{"content":"import { ReactNode } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface KeyValueProps {\n  label: string;\n  value: ReactNode;\n  valueClassName?: string;\n  className?: string;\n  vertical?: boolean;\n}\n\nexport function KeyValue({ label, value, valueClassName, className, vertical = false }: KeyValueProps) {\n  if (vertical) {\n    return (\n      <div className={cn(\"space-y-1\", className)} data-testid=\"key-value-vertical\">\n        <dt className=\"text-sm text-muted-foreground\" data-testid=\"key-value-label\">\n          {label}\n        </dt>\n        <dd className={cn(\"text-sm font-medium\", valueClassName)} data-testid=\"key-value-value\">\n          {value}\n        </dd>\n      </div>\n    );\n  }\n\n  return (\n    <div className={cn(\"flex items-center justify-between py-2\", className)} data-testid=\"key-value\">\n      <dt className=\"text-sm text-muted-foreground\" data-testid=\"key-value-label\">\n        {label}\n      </dt>\n      <dd className={cn(\"text-sm font-medium\", valueClassName)} data-testid=\"key-value-value\">\n        {value}\n      </dd>\n    </div>\n  );\n}\n","size_bytes":1063},"client/src/components/ui/page-header.tsx":{"content":"import { ReactNode } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface PageHeaderProps {\n  title: string;\n  subtitle?: string;\n  badge?: ReactNode;\n  actions?: ReactNode;\n  className?: string;\n}\n\nexport function PageHeader({ title, subtitle, badge, actions, className }: PageHeaderProps) {\n  return (\n    <div className={cn(\"border-b bg-card\", className)}>\n      <div className=\"px-6 py-4\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <h1 className=\"text-2xl font-semibold tracking-tight\" data-testid=\"page-header-title\">\n              {title}\n            </h1>\n            {badge && <div data-testid=\"page-header-badge\">{badge}</div>}\n          </div>\n          {actions && (\n            <div className=\"flex items-center gap-2\" data-testid=\"page-header-actions\">\n              {actions}\n            </div>\n          )}\n        </div>\n        {subtitle && (\n          <p className=\"mt-1 text-sm text-muted-foreground\" data-testid=\"page-header-subtitle\">\n            {subtitle}\n          </p>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":1124},"client/src/components/notes/AttachmentUpload.tsx":{"content":"import { useState, useRef, DragEvent } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Upload, X, File, Image as ImageIcon, Loader2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface AttachmentUploadProps {\n  onUpload: (files: File[]) => Promise<void>;\n  isPending?: boolean;\n  maxFiles?: number;\n  maxSizeMB?: number;\n  acceptedTypes?: string[];\n  className?: string;\n}\n\nexport function AttachmentUpload({\n  onUpload,\n  isPending,\n  maxFiles = 5,\n  maxSizeMB = 10,\n  acceptedTypes = [\"image/*\", \"application/pdf\", \".doc\", \".docx\", \".xls\", \".xlsx\"],\n  className,\n}: AttachmentUploadProps) {\n  const [isDragging, setIsDragging] = useState(false);\n  const [selectedFiles, setSelectedFiles] = useState<File[]>([]);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const handleDragEnter = (e: DragEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (e: DragEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n  };\n\n  const handleDragOver = (e: DragEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n  };\n\n  const handleDrop = (e: DragEvent<HTMLDivElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n\n    const files = Array.from(e.dataTransfer.files);\n    handleFiles(files);\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files) {\n      const files = Array.from(e.target.files);\n      handleFiles(files);\n    }\n  };\n\n  const handleFiles = (files: File[]) => {\n    const validFiles = files.filter((file) => {\n      if (file.size > maxSizeMB * 1024 * 1024) {\n        return false;\n      }\n      return true;\n    });\n\n    setSelectedFiles((prev) => {\n      const newFiles = [...prev, ...validFiles].slice(0, maxFiles);\n      return newFiles;\n    });\n  };\n\n  const removeFile = (index: number) => {\n    setSelectedFiles((prev) => prev.filter((_, i) => i !== index));\n  };\n\n  const handleUpload = async () => {\n    if (selectedFiles.length === 0) return;\n    await onUpload(selectedFiles);\n    setSelectedFiles([]);\n  };\n\n  const getFileIcon = (file: File) => {\n    if (file.type.startsWith(\"image/\")) {\n      return <ImageIcon className=\"h-4 w-4\" />;\n    }\n    return <File className=\"h-4 w-4\" />;\n  };\n\n  return (\n    <div className={cn(\"space-y-3\", className)} data-testid=\"attachment-upload\">\n      <div\n        onDragEnter={handleDragEnter}\n        onDragLeave={handleDragLeave}\n        onDragOver={handleDragOver}\n        onDrop={handleDrop}\n        className={cn(\n          \"border-2 border-dashed rounded-lg p-6 text-center transition-colors\",\n          isDragging\n            ? \"border-[var(--brand-orange-600)] bg-[var(--brand-orange-100)]\"\n            : \"border-muted-foreground/25 hover:border-muted-foreground/50\"\n        )}\n        data-testid=\"drop-zone\"\n      >\n        <input\n          ref={fileInputRef}\n          type=\"file\"\n          multiple\n          accept={acceptedTypes.join(\",\")}\n          onChange={handleFileSelect}\n          className=\"hidden\"\n          data-testid=\"file-input\"\n        />\n\n        <Upload className=\"h-8 w-8 mx-auto mb-2 text-muted-foreground\" />\n        <p className=\"text-sm text-muted-foreground mb-2\">\n          Drag and drop files here, or{\" \"}\n          <button\n            type=\"button\"\n            onClick={() => fileInputRef.current?.click()}\n            className=\"text-[var(--brand-orange-600)] hover:underline font-medium\"\n            data-testid=\"browse-button\"\n          >\n            browse\n          </button>\n        </p>\n        <p className=\"text-xs text-muted-foreground\">\n          Max {maxFiles} files, {maxSizeMB}MB each\n        </p>\n      </div>\n\n      {selectedFiles.length > 0 && (\n        <div className=\"space-y-2\">\n          <p className=\"text-sm font-medium\">Selected files ({selectedFiles.length})</p>\n          <div className=\"space-y-1\">\n            {selectedFiles.map((file, index) => (\n              <div\n                key={index}\n                className=\"flex items-center justify-between p-2 bg-muted rounded-lg\"\n                data-testid={`selected-file-${index}`}\n              >\n                <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                  {getFileIcon(file)}\n                  <span className=\"text-sm truncate\">{file.name}</span>\n                  <span className=\"text-xs text-muted-foreground flex-shrink-0\">\n                    {(file.size / 1024).toFixed(1)} KB\n                  </span>\n                </div>\n                <button\n                  onClick={() => removeFile(index)}\n                  className=\"p-1 hover:bg-background rounded\"\n                  data-testid={`remove-file-${index}`}\n                >\n                  <X className=\"h-4 w-4\" />\n                </button>\n              </div>\n            ))}\n          </div>\n\n          <Button\n            onClick={handleUpload}\n            disabled={isPending || selectedFiles.length === 0}\n            className=\"w-full\"\n            data-testid=\"upload-button\"\n          >\n            {isPending ? (\n              <>\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                Uploading...\n              </>\n            ) : (\n              <>\n                <Upload className=\"h-4 w-4 mr-2\" />\n                Upload {selectedFiles.length} {selectedFiles.length === 1 ? \"file\" : \"files\"}\n              </>\n            )}\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":5596},"client/src/components/notes/AttachmentList.tsx":{"content":"import { File, Image as ImageIcon, Download, X } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport type { NoteAttachment } from \"@shared/schema\";\n\ninterface AttachmentListProps {\n  attachments: NoteAttachment[];\n  onDelete?: (attachmentId: string) => void;\n  canDelete?: boolean;\n}\n\nexport function AttachmentList({ attachments, onDelete, canDelete }: AttachmentListProps) {\n  if (attachments.length === 0) return null;\n\n  const getFileIcon = (mimeType: string | null) => {\n    if (mimeType?.startsWith(\"image/\")) {\n      return <ImageIcon className=\"h-4 w-4\" />;\n    }\n    return <File className=\"h-4 w-4\" />;\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes < 1024) return `${bytes} B`;\n    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n\n  const handleDownload = (attachment: NoteAttachment) => {\n    if (attachment.filePath) {\n      window.open(attachment.filePath, \"_blank\");\n    }\n  };\n\n  return (\n    <div className=\"mt-3 space-y-2\" data-testid=\"attachment-list\">\n      <p className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">\n        Attachments ({attachments.length})\n      </p>\n      <div className=\"grid gap-2\">\n        {attachments.map((attachment) => (\n          <div\n            key={attachment.id}\n            className=\"flex items-center gap-2 p-2 bg-muted rounded-lg group\"\n            data-testid={`attachment-${attachment.id}`}\n          >\n            {getFileIcon(attachment.mimeType)}\n            \n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm truncate\">{attachment.fileName}</p>\n              <p className=\"text-xs text-muted-foreground\">\n                {formatFileSize(attachment.sizeBytes)}\n              </p>\n            </div>\n\n            <div className=\"flex items-center gap-1\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"h-8 w-8 p-0\"\n                onClick={() => handleDownload(attachment)}\n                data-testid={`download-${attachment.id}`}\n              >\n                <Download className=\"h-4 w-4\" />\n              </Button>\n\n              {canDelete && onDelete && (\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-8 w-8 p-0 opacity-0 group-hover:opacity-100 transition-opacity\"\n                  onClick={() => onDelete(attachment.id)}\n                  data-testid={`delete-${attachment.id}`}\n                >\n                  <X className=\"h-4 w-4\" />\n                </Button>\n              )}\n            </div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n","size_bytes":2743},"client/src/components/notes/NotesPanel.tsx":{"content":"import { useState, useMemo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { NoteComposer } from \"./NoteComposer\";\nimport { NoteItem } from \"./NoteItem\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, Filter, Search, X } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { cn } from \"@/lib/utils\";\nimport type { Note, NoteTag, User } from \"@shared/schema\";\n\ninterface NotesPanelProps {\n  entityType: string;\n  entityId: string;\n  currentUser: User;\n  className?: string;\n}\n\nexport function NotesPanel({ entityType, entityId, currentUser, className }: NotesPanelProps) {\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [authorFilter, setAuthorFilter] = useState<string | undefined>(undefined);\n  const [selectedTagFilters, setSelectedTagFilters] = useState<string[]>([]);\n  const [dateFrom, setDateFrom] = useState(\"\");\n  const [dateTo, setDateTo] = useState(\"\");\n\n  const { data: notes = [], isLoading } = useQuery<(Note & { author?: User; tags?: NoteTag[] })[]>({\n    queryKey: [\"/api/notes\", entityType, entityId, authorFilter, selectedTagFilters],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (authorFilter) params.set(\"authorId\", authorFilter);\n      if (selectedTagFilters.length > 0) {\n        selectedTagFilters.forEach(tagId => params.append(\"tagIds\", tagId));\n      }\n      \n      const url = `/api/notes/${entityType}/${entityId}${params.toString() ? `?${params}` : \"\"}`;\n      const response = await fetch(url);\n      if (!response.ok) throw new Error(\"Failed to fetch notes\");\n      return response.json();\n    },\n  });\n\n  const { data: availableTags = [] } = useQuery<NoteTag[]>({\n    queryKey: [\"/api/note-tags\"],\n  });\n\n  const { data: allUsers = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users/list\"],\n  });\n\n  const uniqueAuthors = useMemo(() => {\n    const authorMap = new Map<string, User>();\n    notes.forEach(note => {\n      if (note.author && !authorMap.has(note.author.id)) {\n        authorMap.set(note.author.id, note.author);\n      }\n    });\n    return Array.from(authorMap.values());\n  }, [notes]);\n\n  const filteredNotes = useMemo(() => {\n    let filtered = [...notes];\n\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      filtered = filtered.filter(note =>\n        note.plainText?.toLowerCase().includes(query) ||\n        note.content?.toLowerCase().includes(query)\n      );\n    }\n\n    if (dateFrom) {\n      const fromDate = new Date(dateFrom);\n      fromDate.setHours(0, 0, 0, 0);\n      filtered = filtered.filter(note => {\n        if (!note.createdAt) return false;\n        const noteDate = new Date(note.createdAt);\n        return noteDate >= fromDate;\n      });\n    }\n\n    if (dateTo) {\n      const toDate = new Date(dateTo);\n      toDate.setHours(23, 59, 59, 999);\n      filtered = filtered.filter(note => {\n        if (!note.createdAt) return false;\n        const noteDate = new Date(note.createdAt);\n        return noteDate <= toDate;\n      });\n    }\n\n    return filtered;\n  }, [notes, searchQuery, dateFrom, dateTo]);\n\n  const toggleTagFilter = (tagId: string) => {\n    setSelectedTagFilters(prev =>\n      prev.includes(tagId) ? prev.filter(id => id !== tagId) : [...prev, tagId]\n    );\n  };\n\n  const clearAllFilters = () => {\n    setSearchQuery(\"\");\n    setAuthorFilter(undefined);\n    setSelectedTagFilters([]);\n    setDateFrom(\"\");\n    setDateTo(\"\");\n  };\n\n  const hasActiveFilters = searchQuery || authorFilter || selectedTagFilters.length > 0 || dateFrom || dateTo;\n\n  const createNoteMutation = useMutation({\n    mutationFn: async (noteData: { content: string; plainText: string; tagIds: string[] }) => {\n      const response = await apiRequest(\"POST\", \"/api/notes\", {\n        entityType,\n        entityId,\n        content: noteData.content,\n        plainText: noteData.plainText,\n        visibility: \"internal\",\n        authorId: currentUser.id,\n      });\n      const newNote = await response.json();\n      \n      if (noteData.tagIds.length > 0) {\n        await Promise.all(\n          noteData.tagIds.map((tagId) =>\n            apiRequest(\"POST\", `/api/notes/${newNote.id}/tags/${tagId}`)\n          )\n        );\n      }\n      \n      return newNote;\n    },\n    onSuccess: async (newNote) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notes\", entityType, entityId] });\n      toast({\n        title: \"Note added\",\n        description: \"Your note has been added successfully.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to add note. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const pinNoteMutation = useMutation({\n    mutationFn: async (noteId: string) => {\n      return apiRequest(\"POST\", `/api/notes/${noteId}/pin`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notes\", entityType, entityId] });\n      toast({ title: \"Note pinned\" });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: error.message || \"Failed to pin note\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const unpinNoteMutation = useMutation({\n    mutationFn: async (noteId: string) => {\n      return apiRequest(\"DELETE\", `/api/notes/${noteId}/pin`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notes\", entityType, entityId] });\n      toast({ title: \"Note unpinned\" });\n    },\n  });\n\n  const deleteNoteMutation = useMutation({\n    mutationFn: async (noteId: string) => {\n      const reason = window.prompt(\"Why are you deleting this note?\");\n      if (!reason) throw new Error(\"Delete reason is required\");\n      \n      return apiRequest(\"DELETE\", `/api/notes/${noteId}`, { deleteReason: reason });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notes\", entityType, entityId] });\n      toast({ title: \"Note deleted\" });\n    },\n    onError: (error: any) => {\n      if (error.message !== \"Delete reason is required\") {\n        toast({\n          title: \"Error\",\n          description: \"Failed to delete note\",\n          variant: \"destructive\",\n        });\n      }\n    },\n  });\n\n  const reactToNoteMutation = useMutation({\n    mutationFn: async ({ noteId, emoji }: { noteId: string; emoji: string }) => {\n      return apiRequest(\"POST\", `/api/notes/${noteId}/reactions`, {\n        userId: currentUser.id,\n        emoji,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/notes\", entityType, entityId] });\n    },\n  });\n\n  const pinnedNotes = filteredNotes.filter((note) => note.isPinned && !note.deletedAt);\n  const unpinnedNotes = filteredNotes.filter((note) => !note.isPinned && !note.deletedAt);\n  const deletedNotes = filteredNotes.filter((note) => note.deletedAt);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-8\">\n        <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className={cn(\"space-y-4\", className)} data-testid=\"notes-panel\">\n      <NoteComposer\n        onSubmit={(noteData) => createNoteMutation.mutate(noteData)}\n        isPending={createNoteMutation.isPending}\n        availableTags={availableTags}\n      />\n\n      <div className=\"space-y-3\">\n        <div className=\"relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n          <Input\n            type=\"text\"\n            placeholder=\"Search notes...\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n            className=\"pl-9\"\n            data-testid=\"notes-search-input\"\n          />\n        </div>\n\n        <div className=\"flex flex-col sm:flex-row gap-2 flex-wrap items-start sm:items-center\">\n          {uniqueAuthors.length > 0 && (\n            <Select value={authorFilter || \"all\"} onValueChange={(val) => setAuthorFilter(val === \"all\" ? undefined : val)}>\n              <SelectTrigger className=\"w-[150px] h-9\" data-testid=\"filter-author\">\n                <SelectValue placeholder=\"All authors\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All authors</SelectItem>\n                {uniqueAuthors.map((author) => (\n                  <SelectItem key={author.id} value={author.id}>\n                    {author.firstName} {author.lastName}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          )}\n\n          {availableTags.length > 0 && (\n            <Select value=\"\" onValueChange={toggleTagFilter}>\n              <SelectTrigger className=\"w-[120px] h-9\" data-testid=\"filter-tags\">\n                <SelectValue placeholder=\"Filter by tag\" />\n              </SelectTrigger>\n              <SelectContent>\n                {availableTags.map((tag) => (\n                  <SelectItem key={tag.id} value={tag.id}>\n                    <div className=\"flex items-center gap-2\">\n                      <div\n                        className=\"w-3 h-3 rounded-full\"\n                        style={{ backgroundColor: tag.color || \"#64748b\" }}\n                      />\n                      {tag.name}\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          )}\n\n          <div className=\"flex items-center gap-2\">\n            <Input\n              type=\"date\"\n              value={dateFrom}\n              onChange={(e) => setDateFrom(e.target.value)}\n              placeholder=\"From\"\n              className=\"w-[140px] h-9\"\n              data-testid=\"filter-date-from\"\n            />\n            <Input\n              type=\"date\"\n              value={dateTo}\n              onChange={(e) => setDateTo(e.target.value)}\n              placeholder=\"To\"\n              className=\"w-[140px] h-9\"\n              data-testid=\"filter-date-to\"\n            />\n          </div>\n\n          {hasActiveFilters && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={clearAllFilters}\n              data-testid=\"filter-clear-all\"\n            >\n              <X className=\"h-4 w-4 mr-1\" />\n              Clear filters\n            </Button>\n          )}\n        </div>\n\n        {selectedTagFilters.length > 0 && (\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <span className=\"text-xs text-muted-foreground\">Active tag filters:</span>\n            {selectedTagFilters.map((tagId) => {\n              const tag = availableTags.find((t) => t.id === tagId);\n              if (!tag) return null;\n              const tagColor = tag.color || \"#64748b\";\n              return (\n                <Badge\n                  key={tagId}\n                  variant=\"secondary\"\n                  className=\"gap-1\"\n                  style={{ backgroundColor: tagColor + \"20\", color: tagColor, borderColor: tagColor }}\n                  data-testid={`filter-tag-badge-${tagId}`}\n                >\n                  {tag.name}\n                  <button\n                    type=\"button\"\n                    onClick={() => toggleTagFilter(tagId)}\n                    className=\"hover:bg-black/10 rounded-full p-0.5\"\n                  >\n                    <X className=\"h-3 w-3\" />\n                  </button>\n                </Badge>\n              );\n            })}\n          </div>\n        )}\n\n        <div className=\"flex items-center justify-between\">\n          <h3 className=\"text-sm font-medium text-muted-foreground\" data-testid=\"notes-count\">\n            {filteredNotes.length} {filteredNotes.length === 1 ? \"note\" : \"notes\"}\n            {hasActiveFilters && notes.length !== filteredNotes.length && (\n              <span className=\"text-xs ml-1\">(filtered from {notes.length})</span>\n            )}\n          </h3>\n        </div>\n      </div>\n\n      <div className=\"space-y-3\">\n        {pinnedNotes.length > 0 && (\n          <div className=\"space-y-2\">\n            <h4 className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">\n              Pinned\n            </h4>\n            {pinnedNotes.map((note) => (\n              <NoteItem\n                key={note.id}\n                note={note}\n                currentUserId={currentUser.id}\n                onPin={(noteId) => pinNoteMutation.mutate(noteId)}\n                onUnpin={(noteId) => unpinNoteMutation.mutate(noteId)}\n                onDelete={(noteId) => deleteNoteMutation.mutate(noteId)}\n                onReact={(noteId, emoji) => reactToNoteMutation.mutate({ noteId, emoji })}\n              />\n            ))}\n          </div>\n        )}\n\n        {unpinnedNotes.length > 0 && (\n          <div className=\"space-y-2\">\n            {pinnedNotes.length > 0 && (\n              <h4 className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">\n                All Notes\n              </h4>\n            )}\n            {unpinnedNotes.map((note) => (\n              <NoteItem\n                key={note.id}\n                note={note}\n                currentUserId={currentUser.id}\n                onPin={(noteId) => pinNoteMutation.mutate(noteId)}\n                onUnpin={(noteId) => unpinNoteMutation.mutate(noteId)}\n                onDelete={(noteId) => deleteNoteMutation.mutate(noteId)}\n                onReact={(noteId, emoji) => reactToNoteMutation.mutate({ noteId, emoji })}\n              />\n            ))}\n          </div>\n        )}\n\n        {deletedNotes.length > 0 && (\n          <div className=\"space-y-2\">\n            <h4 className=\"text-xs font-medium text-red-600 dark:text-red-400 uppercase tracking-wide\">\n              Deleted ({deletedNotes.length})\n            </h4>\n            {deletedNotes.map((note) => (\n              <NoteItem\n                key={note.id}\n                note={note}\n                currentUserId={currentUser.id}\n              />\n            ))}\n          </div>\n        )}\n\n        {notes.length === 0 && (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <p>No notes yet. Add one above to get started.</p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":14546},"client/src/components/notes/NoteThread.tsx":{"content":"import { useState } from \"react\";\nimport { NoteItem } from \"./NoteItem\";\nimport { NoteComposer } from \"./NoteComposer\";\nimport { Button } from \"@/components/ui/button\";\nimport { ChevronDown, ChevronRight } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { Note, NoteTag, User } from \"@shared/schema\";\n\ninterface NoteThreadProps {\n  note: Note & { author?: User; tags?: NoteTag[]; replies?: (Note & { author?: User; tags?: NoteTag[] })[] };\n  currentUserId: string;\n  onReply: (parentId: string, noteData: { content: string; plainText: string; tagIds: string[] }) => void;\n  onEdit?: (noteId: string) => void;\n  onDelete?: (noteId: string) => void;\n  onPin?: (noteId: string) => void;\n  onUnpin?: (noteId: string) => void;\n  onReact?: (noteId: string, emoji: string) => void;\n  availableTags?: NoteTag[];\n  isPending?: boolean;\n  depth?: number;\n  className?: string;\n}\n\nexport function NoteThread({\n  note,\n  currentUserId,\n  onReply,\n  onEdit,\n  onDelete,\n  onPin,\n  onUnpin,\n  onReact,\n  availableTags = [],\n  isPending,\n  depth = 0,\n  className,\n}: NoteThreadProps) {\n  const [showReplyComposer, setShowReplyComposer] = useState(false);\n  const [isExpanded, setIsExpanded] = useState(true);\n\n  const hasReplies = note.replies && note.replies.length > 0;\n  const canReply = depth < 2; // Max depth of 2\n\n  const handleReply = (noteData: { content: string; plainText: string; tagIds: string[] }) => {\n    onReply(note.id, noteData);\n    setShowReplyComposer(false);\n  };\n\n  return (\n    <div className={cn(\"\", className)} data-testid={`note-thread-${note.id}`}>\n      <div className={cn(depth > 0 && \"ml-8 pl-4 border-l-2 border-muted\")}>\n        <NoteItem\n          note={note}\n          currentUserId={currentUserId}\n          onReply={canReply ? () => setShowReplyComposer(!showReplyComposer) : undefined}\n          onEdit={onEdit}\n          onDelete={onDelete}\n          onPin={depth === 0 ? onPin : undefined}\n          onUnpin={depth === 0 ? onUnpin : undefined}\n          onReact={onReact}\n        />\n\n        {showReplyComposer && canReply && (\n          <div className=\"mt-3 mb-3\">\n            <NoteComposer\n              onSubmit={handleReply}\n              isPending={isPending}\n              placeholder=\"Write a reply...\"\n              availableTags={availableTags}\n            />\n          </div>\n        )}\n\n        {hasReplies && (\n          <div className=\"mt-3\">\n            <button\n              onClick={() => setIsExpanded(!isExpanded)}\n              className=\"flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground mb-2\"\n              data-testid={`toggle-replies-${note.id}`}\n            >\n              {isExpanded ? (\n                <ChevronDown className=\"h-4 w-4\" />\n              ) : (\n                <ChevronRight className=\"h-4 w-4\" />\n              )}\n              {note.replies?.length || 0} {note.replies?.length === 1 ? \"reply\" : \"replies\"}\n            </button>\n\n            {isExpanded && note.replies && (\n              <div className=\"space-y-3\">\n                {note.replies.map((reply) => (\n                  <NoteThread\n                    key={reply.id}\n                    note={reply}\n                    currentUserId={currentUserId}\n                    onReply={onReply}\n                    onEdit={onEdit}\n                    onDelete={onDelete}\n                    onReact={onReact}\n                    availableTags={availableTags}\n                    isPending={isPending}\n                    depth={depth + 1}\n                  />\n                ))}\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","size_bytes":3643},"client/src/components/notes/NoteFollowupDialog.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Loader2 } from \"lucide-react\";\nimport type { Note, User } from \"@shared/schema\";\n\nconst followupSchema = z.object({\n  todoTitle: z.string().min(1, \"Title is required\"),\n  todoDescription: z.string().optional(),\n  dueDate: z.string().optional(),\n  assignedTo: z.string().optional(),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"urgent\"]),\n});\n\ntype FollowupFormData = z.infer<typeof followupSchema>;\n\ninterface NoteFollowupDialogProps {\n  note: Note;\n  users: User[];\n  open: boolean;\n  onClose: () => void;\n  onCreate: (followupData: FollowupFormData) => Promise<void>;\n  isPending?: boolean;\n}\n\nexport function NoteFollowupDialog({\n  note,\n  users,\n  open,\n  onClose,\n  onCreate,\n  isPending,\n}: NoteFollowupDialogProps) {\n  const form = useForm<FollowupFormData>({\n    resolver: zodResolver(followupSchema),\n    defaultValues: {\n      todoTitle: \"\",\n      todoDescription: \"\",\n      dueDate: \"\",\n      assignedTo: \"\",\n      priority: \"medium\",\n    },\n  });\n\n  const handleSubmit = async (data: FollowupFormData) => {\n    await onCreate(data);\n    form.reset();\n    onClose();\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-lg\" data-testid=\"followup-dialog\">\n        <DialogHeader>\n          <DialogTitle>Create Follow-up Task</DialogTitle>\n          <DialogDescription>\n            Convert this note into a task to track follow-up actions.\n          </DialogDescription>\n        </DialogHeader>\n\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-4\">\n            <FormField\n              control={form.control}\n              name=\"todoTitle\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Task Title</FormLabel>\n                  <FormControl>\n                    <Input\n                      placeholder=\"What needs to be done?\"\n                      {...field}\n                      data-testid=\"followup-title\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <FormField\n              control={form.control}\n              name=\"todoDescription\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Description</FormLabel>\n                  <FormControl>\n                    <Textarea\n                      placeholder=\"Add details...\"\n                      rows={3}\n                      {...field}\n                      data-testid=\"followup-description\"\n                    />\n                  </FormControl>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <FormField\n                control={form.control}\n                name=\"dueDate\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Due Date</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"date\"\n                        {...field}\n                        data-testid=\"followup-due-date\"\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"priority\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Priority</FormLabel>\n                    <Select\n                      value={field.value}\n                      onValueChange={field.onChange}\n                    >\n                      <FormControl>\n                        <SelectTrigger data-testid=\"followup-priority\">\n                          <SelectValue />\n                        </SelectTrigger>\n                      </FormControl>\n                      <SelectContent>\n                        <SelectItem value=\"low\">Low</SelectItem>\n                        <SelectItem value=\"medium\">Medium</SelectItem>\n                        <SelectItem value=\"high\">High</SelectItem>\n                        <SelectItem value=\"urgent\">Urgent</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </div>\n\n            <FormField\n              control={form.control}\n              name=\"assignedTo\"\n              render={({ field }) => (\n                <FormItem>\n                  <FormLabel>Assign To</FormLabel>\n                  <Select\n                    value={field.value}\n                    onValueChange={field.onChange}\n                  >\n                    <FormControl>\n                      <SelectTrigger data-testid=\"followup-assign\">\n                        <SelectValue placeholder=\"Select a user...\" />\n                      </SelectTrigger>\n                    </FormControl>\n                    <SelectContent>\n                      {users.map((user) => (\n                        <SelectItem key={user.id} value={user.id}>\n                          {user.username} ({user.email})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <FormMessage />\n                </FormItem>\n              )}\n            />\n\n            <DialogFooter>\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={onClose}\n                disabled={isPending}\n              >\n                Cancel\n              </Button>\n              <Button type=\"submit\" disabled={isPending} data-testid=\"create-followup\">\n                {isPending ? (\n                  <>\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                    Creating...\n                  </>\n                ) : (\n                  \"Create Task\"\n                )}\n              </Button>\n            </DialogFooter>\n          </form>\n        </Form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":6850},"client/src/components/notes/MentionsAutocomplete.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { cn } from \"@/lib/utils\";\nimport type { User } from \"@shared/schema\";\n\ninterface MentionsAutocompleteProps {\n  users: User[];\n  searchQuery: string;\n  onSelect: (user: User) => void;\n  position: { top: number; left: number };\n  className?: string;\n}\n\nexport function MentionsAutocomplete({\n  users,\n  searchQuery,\n  onSelect,\n  position,\n  className,\n}: MentionsAutocompleteProps) {\n  const [selectedIndex, setSelectedIndex] = useState(0);\n  const containerRef = useRef<HTMLDivElement>(null);\n\n  const filteredUsers = users.filter((user) =>\n    user.username.toLowerCase().includes(searchQuery.toLowerCase()) ||\n    user.email.toLowerCase().includes(searchQuery.toLowerCase())\n  ).slice(0, 5);\n\n  useEffect(() => {\n    setSelectedIndex(0);\n  }, [searchQuery]);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (filteredUsers.length === 0) return;\n\n      if (e.key === \"ArrowDown\") {\n        e.preventDefault();\n        setSelectedIndex((prev) => (prev + 1) % filteredUsers.length);\n      } else if (e.key === \"ArrowUp\") {\n        e.preventDefault();\n        setSelectedIndex((prev) => (prev - 1 + filteredUsers.length) % filteredUsers.length);\n      } else if (e.key === \"Enter\") {\n        e.preventDefault();\n        onSelect(filteredUsers[selectedIndex]);\n      }\n    };\n\n    document.addEventListener(\"keydown\", handleKeyDown);\n    return () => document.removeEventListener(\"keydown\", handleKeyDown);\n  }, [filteredUsers, selectedIndex, onSelect]);\n\n  if (filteredUsers.length === 0) return null;\n\n  return (\n    <div\n      ref={containerRef}\n      className={cn(\n        \"absolute z-50 w-64 bg-popover border rounded-lg shadow-lg overflow-hidden\",\n        className\n      )}\n      style={{ top: position.top, left: position.left }}\n      data-testid=\"mentions-autocomplete\"\n    >\n      <div className=\"py-1\">\n        {filteredUsers.map((user, index) => (\n          <button\n            key={user.id}\n            onClick={() => onSelect(user)}\n            className={cn(\n              \"w-full px-3 py-2 flex items-center gap-2 hover:bg-accent transition-colors text-left\",\n              index === selectedIndex && \"bg-accent\"\n            )}\n            data-testid={`mention-user-${user.id}`}\n          >\n            <Avatar className=\"h-6 w-6\">\n              <AvatarFallback className=\"text-xs\">\n                {user.username[0].toUpperCase()}\n              </AvatarFallback>\n            </Avatar>\n            <div className=\"flex-1 min-w-0\">\n              <p className=\"text-sm font-medium truncate\">{user.username}</p>\n              <p className=\"text-xs text-muted-foreground truncate\">{user.email}</p>\n            </div>\n          </button>\n        ))}\n      </div>\n    </div>\n  );\n}\n","size_bytes":2849},"client/src/pages/ReturnDetail.tsx":{"content":"import { useParams } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { PageHeader } from \"@/components/ui/page-header\";\nimport { StatusChip } from \"@/components/ui/status-chip\";\nimport { InfoBanner } from \"@/components/ui/info-banner\";\nimport { KeyValue } from \"@/components/ui/key-value\";\nimport { NotesPanel } from \"@/components/notes/NotesPanel\";\nimport { Loader2, Package, DollarSign, User } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { Return, User as UserType } from \"@shared/schema\";\n\nexport default function ReturnDetail() {\n  const { id } = useParams<{ id: string }>();\n\n  const { data: returnData, isLoading: isLoadingReturn } = useQuery<Return>({\n    queryKey: [\"/api/returns\", id],\n    queryFn: async () => {\n      const response = await fetch(`/api/returns/${id}`);\n      if (!response.ok) throw new Error(\"Failed to fetch return\");\n      return response.json();\n    },\n  });\n\n  const { data: currentUser } = useQuery<UserType>({\n    queryKey: [\"/api/auth/session\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/session\");\n      if (!response.ok) throw new Error(\"Not authenticated\");\n      const data = await response.json();\n      return data.user;\n    },\n  });\n\n  if (isLoadingReturn) {\n    return (\n      <div className=\"flex items-center justify-center h-96\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!returnData) {\n    return (\n      <div className=\"p-6\">\n        <InfoBanner variant=\"error\">\n          Return not found\n        </InfoBanner>\n      </div>\n    );\n  }\n\n  const statusMap: Record<string, { variant: any; label: string }> = {\n    pending: { variant: \"return_in_progress\", label: \"Return in Progress\" },\n    received: { variant: \"received_control\", label: \"Received\" },\n    approved: { variant: \"approved_refund\", label: \"Approved\" },\n    rejected: { variant: \"closed_not_received\", label: \"Rejected\" },\n    refunded: { variant: \"paid\", label: \"Refunded\" },\n  };\n\n  const statusInfo = statusMap[returnData.status] || { variant: \"default\", label: returnData.status };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <PageHeader\n        title={`Return #${returnData.returnNumber}`}\n        subtitle={returnData.createdAt ? `Created ${formatDistanceToNow(new Date(returnData.createdAt), { addSuffix: true })}` : \"\"}\n        badge={<StatusChip variant={statusInfo.variant} label={statusInfo.label} />}\n      />\n\n      <div className=\"container mx-auto p-6\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n          {/* Left Column - 2/3 width */}\n          <div className=\"lg:col-span-2 space-y-6\">\n            {/* Return Status Banner */}\n            <InfoBanner variant=\"brand\" title=\"Return in Progress\">\n              This return is currently being processed. The customer will be notified once it's complete.\n            </InfoBanner>\n\n            {/* Return Details Card */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Package className=\"h-5 w-5\" />\n                  Return Details\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-2\">\n                <KeyValue label=\"Return Number\" value={returnData.returnNumber} />\n                <KeyValue label=\"Order ID\" value={returnData.orderId || \"N/A\"} />\n                <KeyValue label=\"Status\" value={<StatusChip variant={statusInfo.variant} label={statusInfo.label} />} />\n                <KeyValue label=\"Reason\" value={returnData.returnReason || returnData.otherReason || \"Not specified\"} />\n                {returnData.trackingNumber && (\n                  <KeyValue label=\"Tracking Number\" value={returnData.trackingNumber} />\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Payment Card */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <DollarSign className=\"h-5 w-5\" />\n                  Payment & Balance\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-2\">\n                <KeyValue label=\"Refund Amount\" value={returnData.refundAmount ? `‚Ç¨${(returnData.refundAmount / 100).toFixed(2)}` : \"‚Ç¨0.00\"} valueClassName=\"text-green-600 dark:text-green-400 font-semibold\" />\n                <KeyValue label=\"Refund Status\" value={returnData.refundStatus || \"Pending\"} />\n                {returnData.completedAt && (\n                  <KeyValue label=\"Completed\" value={formatDistanceToNow(new Date(returnData.completedAt), { addSuffix: true })} />\n                )}\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Right Column - 1/3 width */}\n          <div className=\"space-y-6\">\n            {/* Customer Info Card */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <User className=\"h-5 w-5\" />\n                  Customer\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <KeyValue vertical label=\"Customer ID\" value={returnData.customerId || \"Not provided\"} />\n              </CardContent>\n            </Card>\n\n            {/* Universal Notes Panel */}\n            {currentUser && (\n              <Card>\n                <CardHeader>\n                  <CardTitle>Notes & Timeline</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <NotesPanel\n                    entityType=\"return\"\n                    entityId={id!}\n                    currentUser={currentUser}\n                  />\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":5992},"client/src/components/notes/NoteEditDialog.tsx":{"content":"import { useState } from \"react\";\nimport { useEditor, EditorContent } from \"@tiptap/react\";\nimport StarterKit from \"@tiptap/starter-kit\";\nimport Underline from \"@tiptap/extension-underline\";\nimport Link from \"@tiptap/extension-link\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Bold, Italic, UnderlineIcon, List, ListOrdered, Link as LinkIcon, Loader2 } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport type { Note } from \"@shared/schema\";\n\ninterface NoteEditDialogProps {\n  note: Note;\n  open: boolean;\n  onClose: () => void;\n  onSave: (updates: { content: string; plainText: string }) => Promise<void>;\n  isPending?: boolean;\n}\n\nexport function NoteEditDialog({ note, open, onClose, onSave, isPending }: NoteEditDialogProps) {\n\n  const editor = useEditor({\n    extensions: [\n      StarterKit,\n      Underline,\n      Link.configure({\n        openOnClick: false,\n        HTMLAttributes: {\n          class: \"text-blue-600 dark:text-blue-400 underline cursor-pointer\",\n        },\n      }),\n    ],\n    content: note.content,\n    editorProps: {\n      attributes: {\n        class: \"prose dark:prose-invert max-w-none focus:outline-none min-h-[120px] px-3 py-2 text-sm border rounded-md\",\n      },\n    },\n  });\n\n  const handleSave = async () => {\n    if (!editor) return;\n\n    const content = editor.getHTML();\n    const plainText = editor.getText();\n\n    await onSave({\n      content,\n      plainText,\n    });\n\n    onClose();\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl\" data-testid=\"note-edit-dialog\">\n        <DialogHeader>\n          <DialogTitle>Edit Note</DialogTitle>\n          <DialogDescription>\n            Make changes to your note. A revision will be saved automatically.\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          <div className=\"border-b p-2 flex items-center gap-2 bg-muted/50 rounded-t-md\">\n            <button\n              type=\"button\"\n              onClick={() => editor?.chain().focus().toggleBold().run()}\n              className={cn(\n                \"p-1.5 rounded hover:bg-accent\",\n                editor?.isActive(\"bold\") && \"bg-accent\"\n              )}\n              data-testid=\"edit-bold\"\n            >\n              <Bold className=\"h-4 w-4\" />\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => editor?.chain().focus().toggleItalic().run()}\n              className={cn(\n                \"p-1.5 rounded hover:bg-accent\",\n                editor?.isActive(\"italic\") && \"bg-accent\"\n              )}\n              data-testid=\"edit-italic\"\n            >\n              <Italic className=\"h-4 w-4\" />\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => editor?.chain().focus().toggleUnderline().run()}\n              className={cn(\n                \"p-1.5 rounded hover:bg-accent\",\n                editor?.isActive(\"underline\") && \"bg-accent\"\n              )}\n              data-testid=\"edit-underline\"\n            >\n              <UnderlineIcon className=\"h-4 w-4\" />\n            </button>\n            <div className=\"w-px h-4 bg-border\" />\n            <button\n              type=\"button\"\n              onClick={() => editor?.chain().focus().toggleBulletList().run()}\n              className={cn(\n                \"p-1.5 rounded hover:bg-accent\",\n                editor?.isActive(\"bulletList\") && \"bg-accent\"\n              )}\n              data-testid=\"edit-bullet-list\"\n            >\n              <List className=\"h-4 w-4\" />\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => editor?.chain().focus().toggleOrderedList().run()}\n              className={cn(\n                \"p-1.5 rounded hover:bg-accent\",\n                editor?.isActive(\"orderedList\") && \"bg-accent\"\n              )}\n              data-testid=\"edit-ordered-list\"\n            >\n              <ListOrdered className=\"h-4 w-4\" />\n            </button>\n            <button\n              type=\"button\"\n              onClick={() => {\n                const url = window.prompt(\"Enter URL:\");\n                if (url) {\n                  editor?.chain().focus().setLink({ href: url }).run();\n                }\n              }}\n              className={cn(\n                \"p-1.5 rounded hover:bg-accent\",\n                editor?.isActive(\"link\") && \"bg-accent\"\n              )}\n              data-testid=\"edit-link\"\n            >\n              <LinkIcon className=\"h-4 w-4\" />\n            </button>\n          </div>\n\n          <EditorContent editor={editor} />\n        </div>\n\n        <DialogFooter>\n          <Button variant=\"outline\" onClick={onClose} disabled={isPending}>\n            Cancel\n          </Button>\n          <Button onClick={handleSave} disabled={isPending} data-testid=\"save-edit\">\n            {isPending ? (\n              <>\n                <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                Saving...\n              </>\n            ) : (\n              \"Save Changes\"\n            )}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":5309},"client/src/components/returns/returns-kanban.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  Clock,\n  AlertTriangle,\n  Package,\n  Calendar,\n  MoreHorizontal,\n  ArrowRight,\n  ExternalLink,\n  Edit,\n  Archive,\n  Trash2\n} from \"lucide-react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  ContextMenu,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuTrigger,\n  ContextMenuSeparator,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n} from \"@/components/ui/context-menu\";\nimport { format } from \"date-fns\";\nimport { nl } from \"date-fns/locale\";\nimport { DragDropContext, Droppable, Draggable, type DropResult } from \"@hello-pangea/dnd\";\nimport type { Return } from \"@shared/schema\";\n\ninterface ReturnsKanbanProps {\n  returns: Return[];\n  isLoading: boolean;\n  onViewReturn: (returnItem: Return) => void;\n  onEditReturn?: (returnItem: Return) => void;\n  onDeleteReturn?: (returnItem: Return) => void;\n  onArchiveReturn?: (returnItem: Return) => void;\n}\n\nconst STATUS_COLUMNS = [\n  {\n    id: 'nieuw_onderweg',\n    title: 'Nieuw / Onderweg',\n    color: 'bg-chart-4',\n    statuses: ['nieuw_onderweg']\n  },\n  {\n    id: 'ontvangen_controle',\n    title: 'Ontvangen',\n    color: 'bg-primary',\n    statuses: ['ontvangen_controle']\n  },\n  {\n    id: 'akkoord_terugbetaling',\n    title: 'Akkoord',\n    color: 'bg-chart-2',\n    statuses: ['akkoord_terugbetaling']\n  },\n  {\n    id: 'vermiste_pakketten',\n    title: 'Vermist',\n    color: 'bg-destructive',\n    statuses: ['vermiste_pakketten']\n  },\n  {\n    id: 'wachten_klant',\n    title: 'Wacht Klant',\n    color: 'bg-chart-1',\n    statuses: ['wachten_klant']\n  },\n  {\n    id: 'opnieuw_versturen',\n    title: 'Opnieuw',\n    color: 'bg-chart-3',\n    statuses: ['opnieuw_versturen']\n  },\n  {\n    id: 'klaar',\n    title: 'Klaar',\n    color: 'bg-muted-foreground',\n    statuses: ['klaar']\n  },\n  {\n    id: 'niet_ontvangen',\n    title: 'Niet Ontvangen',\n    color: 'bg-muted',\n    statuses: ['niet_ontvangen']\n  },\n];\n\nexport function ReturnsKanban({ returns, isLoading, onViewReturn, onEditReturn, onDeleteReturn, onArchiveReturn }: ReturnsKanbanProps) {\n  const { toast } = useToast();\n\n  const updateReturnMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Return> }) => {\n      const response = await apiRequest(\"PATCH\", `/api/returns/${id}`, data);\n      return response.json();\n    },\n    onMutate: async ({ id, data }) => {\n      // Cancel any outgoing refetches\n      await queryClient.cancelQueries({ queryKey: [\"/api/returns\"] });\n\n      // Snapshot the previous value\n      const previousReturns = queryClient.getQueryData<Return[]>([\"/api/returns\"]);\n\n      // Optimistically update to the new value\n      if (previousReturns) {\n        queryClient.setQueryData<Return[]>(\n          [\"/api/returns\"],\n          previousReturns.map(r => r.id === id ? { ...r, ...data } : r)\n        );\n      }\n\n      // Return context with previous data for rollback\n      return { previousReturns };\n    },\n    onError: (_error, _variables, context) => {\n      // Rollback to previous data on error\n      if (context?.previousReturns) {\n        queryClient.setQueryData([\"/api/returns\"], context.previousReturns);\n      }\n      toast({\n        title: \"Fout\",\n        description: \"Status kon niet worden bijgewerkt\",\n        variant: \"destructive\",\n      });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Retour bijgewerkt\",\n        description: \"Status is succesvol gewijzigd\",\n      });\n    },\n    onSettled: () => {\n      // Always refetch after error or success\n      queryClient.invalidateQueries({ queryKey: [\"/api/returns\"] });\n    }\n  });\n\n  const columns = STATUS_COLUMNS.map(column => ({\n    ...column,\n    returns: returns.filter(r => column.statuses.includes(r.status))\n  }));\n\n  const getPriorityColor = (priority: string | null) => {\n    switch (priority) {\n      case \"urgent\":\n        return \"border-l-4 border-l-destructive\";\n      case \"high\":\n        return \"border-l-4 border-l-chart-1\";\n      case \"medium\":\n        return \"border-l-4 border-l-chart-4\";\n      case \"low\":\n        return \"border-l-4 border-l-chart-2\";\n      default:\n        return \"\";\n    }\n  };\n\n  const getPriorityBadge = (priority: string | null) => {\n    if (!priority) return null;\n    \n    const variants: Record<string, { label: string; className: string }> = {\n      urgent: { label: \"Urgent\", className: \"bg-destructive/10 text-destructive border-destructive/20\" },\n      high: { label: \"Hoog\", className: \"bg-chart-1/10 text-chart-1 border-chart-1/20\" },\n      medium: { label: \"Medium\", className: \"bg-chart-4/10 text-chart-4 border-chart-4/20\" },\n      low: { label: \"Laag\", className: \"bg-chart-2/10 text-chart-2 border-chart-2/20\" },\n    };\n\n    const variant = variants[priority];\n    if (!variant) return null;\n\n    return (\n      <Badge variant=\"outline\" className={`text-[10px] px-1 py-0 h-4 ${variant.className}`}>\n        {variant.label}\n      </Badge>\n    );\n  };\n\n  const getReasonLabel = (reason: string | null) => {\n    const reasons: Record<string, string> = {\n      wrong_item: \"Verkeerd\",\n      damaged: \"Beschadigd\",\n      defective: \"Defect\",\n      size_issue: \"Maat\",\n      changed_mind: \"Bedacht\",\n      other: \"Anders\"\n    };\n    return reason ? reasons[reason] || reason : null;\n  };\n\n  const handleStatusChange = (returnItem: Return, newStatus: string) => {\n    updateReturnMutation.mutate({\n      id: returnItem.id,\n      data: { status: newStatus as any }\n    });\n  };\n\n  const handleViewReturn = (returnItem: Return) => {\n    onViewReturn(returnItem);\n  };\n\n  const handleDragEnd = (result: DropResult) => {\n    const { destination, source, draggableId } = result;\n\n    // No destination or dropped in same position\n    if (!destination || (destination.droppableId === source.droppableId && destination.index === source.index)) {\n      return;\n    }\n\n    // Find the return item being dragged\n    const returnItem = returns.find(r => r.id === draggableId);\n    if (!returnItem) return;\n\n    // Get the new status from the destination column\n    const destinationColumn = STATUS_COLUMNS.find(col => col.id === destination.droppableId);\n    if (!destinationColumn || !destinationColumn.statuses[0]) return;\n\n    const newStatus = destinationColumn.statuses[0];\n\n    // Update the return's status\n    updateReturnMutation.mutate({\n      id: returnItem.id,\n      data: { status: newStatus as any }\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3\" data-testid=\"kanban-loading\">\n        {[...Array(8)].map((_, i) => (\n          <Card key={i} className=\"h-96\">\n            <CardHeader>\n              <div className=\"h-4 bg-muted rounded animate-pulse\"></div>\n            </CardHeader>\n            <CardContent className=\"space-y-3\">\n              {[...Array(2)].map((_, j) => (\n                <div key={j} className=\"h-24 bg-muted rounded animate-pulse\"></div>\n              ))}\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n    );\n  }\n\n  return (\n    <DragDropContext onDragEnd={handleDragEnd}>\n      <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3\" data-testid=\"returns-kanban\">\n        {columns.map((column) => (\n          <Card key={column.id} className=\"flex flex-col h-[calc(100vh-240px)]\" data-testid={`kanban-column-${column.id}`}>\n            <CardHeader className=\"pb-2 px-3 pt-3 flex-shrink-0\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center space-x-2\">\n                  <div className={`w-2 h-2 rounded-full ${column.color}`}></div>\n                  <CardTitle className=\"text-xs font-medium\">{column.title}</CardTitle>\n                </div>\n                <Badge variant=\"secondary\" className=\"text-[10px] px-1.5 py-0 h-4\">\n                  {column.returns.length}\n                </Badge>\n              </div>\n            </CardHeader>\n            \n            <Droppable droppableId={column.id}>\n              {(provided, snapshot) => (\n                <ScrollArea className=\"flex-1 px-3 pb-3\">\n                  <div\n                    ref={provided.innerRef}\n                    {...provided.droppableProps}\n                    className={`space-y-2 min-h-[100px] ${snapshot.isDraggingOver ? 'bg-primary/5 rounded-md' : ''}`}\n                  >\n                    {column.returns.length === 0 ? (\n                      <div className=\"text-center py-8 text-muted-foreground text-xs\">\n                        Geen retours\n                      </div>\n                    ) : (\n                      column.returns.map((returnItem, index) => (\n                        <Draggable key={returnItem.id} draggableId={returnItem.id} index={index}>\n                          {(provided, snapshot) => (\n                            <ContextMenu>\n                              <ContextMenuTrigger>\n                                <Card\n                                  ref={provided.innerRef}\n                                  {...provided.draggableProps}\n                                  {...provided.dragHandleProps}\n                                  className={`cursor-pointer hover:shadow-md transition-all ${\n                                    snapshot.isDragging ? 'shadow-lg rotate-2' : 'bg-card'\n                                  } ${getPriorityColor(returnItem.priority)}`}\n                                  onClick={() => handleViewReturn(returnItem)}\n                                  data-testid={`return-card-${returnItem.id}`}\n                                >\n                                  <CardContent className=\"p-2.5\">\n                      <div className=\"flex items-start justify-between mb-1.5\">\n                        <h4 className=\"text-xs font-medium truncate flex-1 mr-1 font-mono\">\n                          {returnItem.returnNumber}\n                        </h4>\n                        <DropdownMenu>\n                          <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n                            <Button variant=\"ghost\" size=\"icon\" className=\"h-5 w-5 -mr-1\" data-testid={`return-actions-${returnItem.id}`}>\n                              <MoreHorizontal className=\"h-3 w-3\" />\n                            </Button>\n                          </DropdownMenuTrigger>\n                          <DropdownMenuContent align=\"end\">\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleViewReturn(returnItem);\n                            }}>\n                              <ExternalLink className=\"h-3 w-3 mr-2\" />\n                              Bekijk Details\n                            </DropdownMenuItem>\n                            <DropdownMenuSeparator />\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'nieuw_onderweg');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Nieuw / Onderweg\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'ontvangen_controle');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Ontvangen\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'akkoord_terugbetaling');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Akkoord\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'vermiste_pakketten');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Vermist\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'wachten_klant');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Wacht Klant\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'opnieuw_versturen');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Opnieuw Versturen\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'klaar');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Klaar\n                            </DropdownMenuItem>\n                            <DropdownMenuItem onClick={(e) => {\n                              e.stopPropagation();\n                              handleStatusChange(returnItem, 'niet_ontvangen');\n                            }}>\n                              <ArrowRight className=\"h-3 w-3 mr-2\" />\n                              Niet Ontvangen\n                            </DropdownMenuItem>\n                          </DropdownMenuContent>\n                        </DropdownMenu>\n                      </div>\n                      \n                      <div className=\"space-y-1.5\">\n                        {returnItem.returnReason && (\n                          <div className=\"flex items-center gap-1\">\n                            <Package className=\"h-3 w-3 text-muted-foreground flex-shrink-0\" />\n                            <span className=\"text-[10px] text-muted-foreground truncate\">\n                              {getReasonLabel(returnItem.returnReason)}\n                            </span>\n                          </div>\n                        )}\n\n                        {returnItem.trackingNumber && (\n                          <div className=\"flex items-center gap-1\">\n                            <Package className=\"h-3 w-3 text-muted-foreground flex-shrink-0\" />\n                            <span className=\"text-[10px] text-muted-foreground font-mono truncate\">\n                              {returnItem.trackingNumber}\n                            </span>\n                          </div>\n                        )}\n\n                        {returnItem.expectedReturnDate && (\n                          <div className=\"flex items-center gap-1\">\n                            <Calendar className=\"h-3 w-3 text-muted-foreground flex-shrink-0\" />\n                            <span className=\"text-[10px] text-muted-foreground\">\n                              {format(new Date(returnItem.expectedReturnDate), \"d MMM\", { locale: nl })}\n                            </span>\n                          </div>\n                        )}\n\n                        {returnItem.refundAmount && (\n                          <div className=\"flex items-center gap-1 pt-0.5\">\n                            <span className=\"text-[11px] font-semibold text-primary\">\n                              ‚Ç¨{(returnItem.refundAmount / 100).toFixed(2)}\n                            </span>\n                          </div>\n                        )}\n\n                        <div className=\"flex items-center gap-1 pt-0.5\">\n                          {getPriorityBadge(returnItem.priority)}\n                        </div>\n                      </div>\n                              </CardContent>\n                            </Card>\n                              </ContextMenuTrigger>\n                              <ContextMenuContent>\n                                <ContextMenuItem onClick={() => handleViewReturn(returnItem)}>\n                                  <ExternalLink className=\"h-4 w-4 mr-2\" />\n                                  Bekijk Details\n                                </ContextMenuItem>\n                                <ContextMenuItem onClick={() => onEditReturn?.(returnItem)}>\n                                  <Edit className=\"h-4 w-4 mr-2\" />\n                                  Bewerken\n                                </ContextMenuItem>\n                                <ContextMenuSeparator />\n                                <ContextMenuSub>\n                                  <ContextMenuSubTrigger>\n                                    <ArrowRight className=\"h-4 w-4 mr-2\" />\n                                    Wijzig Status\n                                  </ContextMenuSubTrigger>\n                                  <ContextMenuSubContent>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'nieuw_onderweg')}>\n                                      Nieuw / Onderweg\n                                    </ContextMenuItem>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'ontvangen_controle')}>\n                                      Ontvangen\n                                    </ContextMenuItem>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'akkoord_terugbetaling')}>\n                                      Akkoord\n                                    </ContextMenuItem>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'vermiste_pakketten')}>\n                                      Vermist\n                                    </ContextMenuItem>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'wachten_klant')}>\n                                      Wacht Klant\n                                    </ContextMenuItem>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'opnieuw_versturen')}>\n                                      Opnieuw Versturen\n                                    </ContextMenuItem>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'klaar')}>\n                                      Klaar\n                                    </ContextMenuItem>\n                                    <ContextMenuItem onClick={() => handleStatusChange(returnItem, 'niet_ontvangen')}>\n                                      Niet Ontvangen\n                                    </ContextMenuItem>\n                                  </ContextMenuSubContent>\n                                </ContextMenuSub>\n                                <ContextMenuSeparator />\n                                <ContextMenuItem onClick={() => onArchiveReturn?.(returnItem)}>\n                                  <Archive className=\"h-4 w-4 mr-2\" />\n                                  Archiveren\n                                </ContextMenuItem>\n                                <ContextMenuItem className=\"text-destructive\" onClick={() => onDeleteReturn?.(returnItem)}>\n                                  <Trash2 className=\"h-4 w-4 mr-2\" />\n                                  Verwijderen\n                                </ContextMenuItem>\n                              </ContextMenuContent>\n                            </ContextMenu>\n                          )}\n                        </Draggable>\n                      ))\n                    )}\n                    {provided.placeholder}\n                  </div>\n                </ScrollArea>\n              )}\n            </Droppable>\n          </Card>\n        ))}\n      </div>\n    </DragDropContext>\n  );\n}\n","size_bytes":20698}},"version":2}